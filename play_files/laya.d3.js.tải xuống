!function(window,document,Laya){Laya.un,Laya.uns;var __static=Laya.static,__class=Laya.class,__getset=Laya.getset,__newvec=Laya.__newvec,BaseTexture=laya.webgl.resource.BaseTexture,Browser=laya.utils.Browser,Buffer=laya.webgl.utils.Buffer,BufferStateBase=laya.webgl.BufferStateBase,Byte=laya.utils.Byte,ClassUtils=laya.utils.ClassUtils,CommandEncoder=laya.layagl.CommandEncoder,Component=laya.components.Component,Config=Laya.Config,EventDispatcher=(laya.resource.Context,laya.events.Event,laya.events.EventDispatcher),Handler=laya.utils.Handler,LayaGL=(laya.webgl.utils.InlcudeFile,laya.layagl.LayaGL),LayaGLRunner=laya.layagl.LayaGLRunner,Loader=laya.net.Loader,LoaderManager=laya.net.LoaderManager,MathUtil=laya.maths.MathUtil,Node=laya.display.Node,Point=laya.maths.Point,Render=laya.renders.Render,Resource=(laya.webgl.resource.RenderTexture2D,laya.resource.Resource),RunDriver=laya.utils.RunDriver,ShaderCompile=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile),ShaderNode=laya.webgl.utils.ShaderNode,Sprite=laya.display.Sprite,Stat=(laya.display.SpriteConst,laya.utils.Stat),Submit=laya.webgl.submit.Submit,SubmitKey=laya.webgl.submit.SubmitKey,Texture2D=laya.webgl.resource.Texture2D,URL=(laya.utils.Timer,laya.net.URL),WebGL=laya.webgl.WebGL,WebGLContext=laya.webgl.WebGLContext,WebGLContext2D=laya.webgl.canvas.WebGLContext2D;Laya.interface("laya.d3.core.IClone"),Laya.interface("laya.d3.graphics.IVertex");var RenderQueue=function(){function RenderQueue(isTransparent){void 0===isTransparent&&(isTransparent=!1),this.isTransparent=isTransparent,this.elements=[]}__class(RenderQueue,"laya.d3.core.render.RenderQueue");var __proto=RenderQueue.prototype;return __proto._compare=function(left,right){var renderQueue=left.material.renderQueue-right.material.renderQueue;return 0===renderQueue?(this.isTransparent?right.render._distanceForSort-left.render._distanceForSort:left.render._distanceForSort-right.render._distanceForSort)+left.render.sortingFudge-right.render.sortingFudge:renderQueue},__proto._partitionRenderObject=function(left,right){for(var pivot=this.elements[Math.floor((right+left)/2)];left<=right;){for(;this._compare(this.elements[left],pivot)<0;)left++;for(;this._compare(this.elements[right],pivot)>0;)right--;if(left<right){var temp=this.elements[left];this.elements[left]=this.elements[right],this.elements[right]=temp,left++,right--}else if(left===right){left++;break}}return left},__proto._quickSort=function(left,right){if(this.elements.length>1){var index=this._partitionRenderObject(left,right),leftIndex=index-1;left<leftIndex&&this._quickSort(left,leftIndex),index<right&&this._quickSort(index,right)}},__proto._render=function(context,isTarget,customShader,replacementTag){for(var lastStateRenderState,lastStateRender,loopCount=Stat.loopCount,scene=context.scene,camera=context.camera,i=0,n=this.elements.length;i<n;i++){var element=this.elements[i],transform=element._transform,render=element.render,geometry=element._geometry,material=element.material;if(context.renderElement=element,loopCount!==render._updateLoopCount?(render._renderUpdate(context,transform),render._renderUpdateWithCamera(context,transform),render._updateLoopCount=loopCount,render._updateCamera=camera):camera!==render._updateCamera&&(render._renderUpdateWithCamera(context,transform),render._updateCamera=camera),geometry._prepareRender(context)){var passes,subShader=material._shader.getSubShaderAt(0),renderStates=material._renderStates;if(customShader)if(replacementTag){var oriTag=subShader.getFlag(replacementTag);if(!oriTag)continue;for(var customSubShaders=customShader._subShaders,k=0,p=customSubShaders.length;k<p;k++){var customSubShader=customSubShaders[k];if(oriTag===customSubShader.getFlag(replacementTag)){passes=customSubShader._passes;break}}if(!passes)continue}else passes=customShader.getSubShaderAt(0)._passes;else passes=subShader._passes;for(var j=0,m=passes.length;j<m;j++){var shaderPass=context.shader=passes[j].withCompile(scene._defineDatas.value&~material._disablePublicDefineDatas.value,render._defineDatas.value,material._defineDatas.value),switchShader=shaderPass.bind(),switchShaderLoop=loopCount!==shaderPass._uploadLoopCount,uploadScene=shaderPass._uploadScene!==scene||switchShaderLoop;(uploadScene||switchShader)&&(shaderPass.uploadUniforms(shaderPass._sceneUniformParamsMap,scene._shaderValues,uploadScene),shaderPass._uploadScene=scene);var switchCamera=shaderPass._uploadCamera!==camera,uploadSprite3D=switchCamera||shaderPass._uploadRender!==render||switchShaderLoop;(uploadSprite3D||switchShader)&&(shaderPass.uploadUniforms(shaderPass._spriteUniformParamsMap,render._shaderValues,uploadSprite3D),shaderPass._uploadRender=render);var uploadCamera=switchCamera||switchShaderLoop;(uploadCamera||switchShader)&&(shaderPass.uploadUniforms(shaderPass._cameraUniformParamsMap,camera._shaderValues,uploadCamera),shaderPass._uploadCamera=camera);var uploadMaterial=shaderPass._uploadMaterial!==material||switchShaderLoop;(uploadMaterial||switchShader)&&(shaderPass.uploadUniforms(shaderPass._materialUniformParamsMap,material._shaderValues,uploadMaterial),shaderPass._uploadMaterial=material);var renderState=renderStates[j];lastStateRenderState!==renderState?(renderState._setRenderStateBlendDepth(),renderState._setRenderStateFrontFace(isTarget,transform),lastStateRenderState=renderState,lastStateRender=render):lastStateRender!==render&&(renderState._setRenderStateFrontFace(isTarget,transform),lastStateRender=render),customShader&&WebGLContext.setBlend(LayaGL.instance,!1),geometry._render(context),shaderPass._uploadLoopCount=loopCount}}}},__proto.clear=function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1},RenderQueue}(),VertexDeclaration=function(){function VertexDeclaration(vertexStride,vertexElements){this._id=0,this._vertexStride=0,this._vertexElementsDic=null,this._shaderValues=null,this._defineDatas=null,this.vertexElements=null,this._id=++VertexDeclaration._uniqueIDCounter,this._defineDatas=new DefineDatas,this._vertexElementsDic={},this._vertexStride=vertexStride,this.vertexElements=vertexElements;var count=vertexElements.length;this._shaderValues=new ShaderData(null);for(var j=0;j<count;j++){var vertexElement=vertexElements[j],name=vertexElement.elementUsage;this._vertexElementsDic[name]=vertexElement;var value=new Int32Array(5),elmentInfo=VertexElementFormat.getElementInfos(vertexElement.elementFormat);value[0]=elmentInfo[0],value[1]=elmentInfo[1],value[2]=elmentInfo[2],value[3]=this._vertexStride,value[4]=vertexElement.offset,this._shaderValues.setAttribute(name,value)}}__class(VertexDeclaration,"laya.d3.graphics.VertexDeclaration");var __proto=VertexDeclaration.prototype;return __proto.getVertexElementByUsage=function(usage){return this._vertexElementsDic[usage]},__proto.unBinding=function(){},__getset(0,__proto,"id",function(){return this._id}),__getset(0,__proto,"vertexStride",function(){return this._vertexStride}),VertexDeclaration._uniqueIDCounter=1,VertexDeclaration}(),RenderElement=function(){function RenderElement(){}__class(RenderElement,"laya.d3.core.render.RenderElement");var __proto=RenderElement.prototype;return __proto.setTransform=function(transform){this._transform=transform},__proto.setGeometry=function(geometry){this._geometry=geometry},__proto.addToOpaqueRenderQueue=function(context,queue){queue.elements.push(this)},__proto.addToTransparentRenderQueue=function(context,queue){queue.elements.push(this),queue.lastTransparentBatched=!1,queue.lastTransparentRenderElement=this},__proto.destroy=function(){this._transform=null,this._geometry=null,this.material=null,this.render=null},RenderElement}(),OctreeNode=function(){function OctreeNode(scene,depth){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._depth=0,this._boundingSphere=new BoundSphere(new Vector3,0),this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3],this._boundingBoxCenter=new Vector3,this._children=__newvec(8),this._objects=[],this._scene=scene,this._depth=depth}__class(OctreeNode,"laya.d3.core.scene.OctreeNode");var __proto=OctreeNode.prototype;return __proto.initRoot=function(center,treeSize){var min=new Vector3,max=new Vector3;Vector3.scale(treeSize,-.5,min),Vector3.scale(treeSize,.5,max),Vector3.add(min,center,min),Vector3.add(max,center,max),this.exactBox=new BoundBox(min,max),this.relaxBox=new BoundBox(min,max)},__proto.addTreeNode=function(render){1===CollisionUtils.boxContainsBox(this._relaxBox,render.boundingBox)?this.addNodeDown(render,0):this.addObject(render)},__proto.addChild=function(index){var child=this._children[index];if(null==child){child=new OctreeNode(this._scene,this._depth+1),this._children[index]=child,child._parent=this,Vector3.subtract(this._exactBox.max,this._exactBox.min,OctreeNode._tempSize),Vector3.multiply(OctreeNode._tempSize,OctreeNode._octreeSplit[index],OctreeNode._tempCenter),Vector3.add(this._exactBox.min,OctreeNode._tempCenter,OctreeNode._tempCenter),Vector3.scale(OctreeNode._tempSize,.25,OctreeNode._tempSize);var min=new Vector3,max=new Vector3;Vector3.subtract(OctreeNode._tempCenter,OctreeNode._tempSize,min),Vector3.add(OctreeNode._tempCenter,OctreeNode._tempSize,max),child.exactBox=new BoundBox(min,max),Vector3.scale(OctreeNode._tempSize,OctreeNode.relax,OctreeNode._tempSize);var relaxMin=new Vector3,relaxMax=new Vector3;Vector3.subtract(OctreeNode._tempCenter,OctreeNode._tempSize,relaxMin),Vector3.add(OctreeNode._tempCenter,OctreeNode._tempSize,relaxMax),child.relaxBox=new BoundBox(relaxMin,relaxMax)}return child},__proto.addObject=function(object){object._treeNode=this,this._objects.push(object)},__proto.removeObject=function(object){if(object._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var index=this._objects.indexOf(object);return-1!==index&&(this._objects.splice(index,1),!0)},__proto.clearObject=function(){this._objects.length=0},__proto.addNodeUp=function(render,depth){this._parent&&1!==CollisionUtils.boxContainsBox(this._exactBox,render.boundingBox)?this._parent.addNodeUp(render,depth-1):this.addNodeDown(render,depth)},__proto.addNodeDown=function(render,depth){if(depth<this._scene.treeLevel){var childIndex=this.inChildIndex(render.boundingBoxCenter),child=this.addChild(childIndex);1===CollisionUtils.boxContainsBox(child._relaxBox,render.boundingBox)?child.addNodeDown(render,++depth):this.addObject(render)}else this.addObject(render)},__proto.inChildIndex=function(objectCenter){return 4*(objectCenter.z<this._boundingBoxCenter.z?0:1)+2*(objectCenter.y<this._boundingBoxCenter.y?0:1)+(objectCenter.x<this._boundingBoxCenter.x?0:1)},__proto.updateObject=function(render){1===CollisionUtils.boxContainsBox(this._relaxBox,render.boundingBox)?(this.removeObject(render),render._treeNode=null,this.addNodeDown(render,this._depth)):this._parent&&(this.removeObject(render),render._treeNode=null,this._parent.addNodeUp(render,this._depth-1))},__proto.cullingObjects=function(context,boundFrustum,camera,cameraPos,testVisible){var n,i=0,j=0,m=0;for(i=0,n=this._objects.length;i<n;i++){var render=this._objects[i];if(this._scene.isLayerVisible(render._owner.layer,camera)&&render._enable){if(testVisible&&0===boundFrustum.containsBoundBox(render.boundingBox))continue;render._distanceForSort=Vector3.distance(render.boundingSphere.center,cameraPos);var elements=render._renderElements;for(j=0,m=elements.length;j<m;j++){var element=elements[j],renderQueue=this._scene._getRenderQueue(element.material.renderQueue);renderQueue.isTransparent?element.addToTransparentRenderQueue(context,renderQueue):element.addToOpaqueRenderQueue(context,renderQueue)}}}for(i=0;i<8;i++){var child=this._children[i],testVisibleChild=testVisible;if(testVisible){var type=boundFrustum.containsBoundBox(child._relaxBox);if(0===type)continue;testVisibleChild=2===type}child.cullingObjects(context,boundFrustum,camera,cameraPos,testVisibleChild)}},__proto.buildAllChild=function(depth){if(depth<this._scene.treeLevel)for(var i=0;i<8;i++){this.addChild(i).buildAllChild(depth+1)}},__proto._renderBoudingBox=function(line){},__getset(0,__proto,"exactBox",function(){return this._exactBox},function(value){this._exactBox=value,Vector3.add(value.min,value.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),__getset(0,__proto,"relaxBox",function(){return this._relaxBox},function(value){this._relaxBox=value,value.getCorners(this._corners),BoundSphere.createfromPoints(this._corners,this._boundingSphere)}),OctreeNode.CHILDNUM=8,OctreeNode.debugMode=!1,OctreeNode.relax=1.15,__static(OctreeNode,["_tempVector0",function(){return this._tempVector0=new Vector3},"_tempSize",function(){return this._tempSize=new Vector3},"_tempCenter",function(){return this._tempCenter=new Vector3},"_octreeSplit",function(){return this._octreeSplit=[new Vector3(.25,.25,.25),new Vector3(.75,.25,.25),new Vector3(.25,.75,.25),new Vector3(.75,.75,.25),new Vector3(.25,.25,.75),new Vector3(.75,.25,.75),new Vector3(.25,.75,.75),new Vector3(.75,.75,.75)]}]),OctreeNode}(),BoundSphere=function(){function BoundSphere(center,radius){this.center=null,this.radius=NaN,this.center=center,this.radius=radius}__class(BoundSphere,"laya.d3.math.BoundSphere");var __proto=BoundSphere.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.toDefault=function(){this.center.toDefault(),this.radius=0},__proto.intersectsRayDistance=function(ray){return CollisionUtils.intersectsRayAndSphereRD(ray,this)},__proto.intersectsRayPoint=function(ray,outPoint){return CollisionUtils.intersectsRayAndSphereRP(ray,this,outPoint)},__proto.cloneTo=function(destObject){var dest=destObject;this.center.cloneTo(dest.center),dest.radius=this.radius},__proto.clone=function(){var dest=new this.constructor(new Vector3,new Vector3);return this.cloneTo(dest),dest},BoundSphere.createFromSubPoints=function(points,start,count,out){if(null==points)throw new Error("points");if(start<0||start>=points.length)throw new Error("start"+start+"Must be in the range [0, "+(points.length-1)+"]");if(count<0||start+count>points.length)throw new Error("count"+count+"Must be in the range <= "+points.length+"}");var upperEnd=start+count,center=BoundSphere._tempVector3;center.elements[0]=0,center.elements[1]=0,center.elements[2]=0;for(var i=start;i<upperEnd;++i)Vector3.add(points[i],center,center);var outCenter=out.center;Vector3.scale(center,1/count,outCenter);var radius=0;for(i=start;i<upperEnd;++i){var distance=Vector3.distanceSquared(outCenter,points[i]);distance>radius&&(radius=distance)}out.radius=Math.sqrt(radius)},BoundSphere.createfromPoints=function(points,out){if(null==points)throw new Error("points");BoundSphere.createFromSubPoints(points,0,points.length,out)},__static(BoundSphere,["_tempVector3",function(){return this._tempVector3=new Vector3}]),BoundSphere}(),MeshReader=function(){function MeshReader(){}return __class(MeshReader,"laya.d3.loaders.MeshReader"),MeshReader.read=function(data,mesh,subMeshes){var readData=new Byte(data);readData.pos=0;var version=readData.readUTFString();switch(version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":LoadModelV04.parse(readData,version,mesh,subMeshes);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":LoadModelV05.parse(readData,version,mesh,subMeshes);break;default:throw new Error("MeshReader: unknown mesh version.")}mesh._setSubMeshes(subMeshes)},MeshReader}(),AnimationEvent=function(){function AnimationEvent(){this.time=NaN,this.eventName=null,this.params=null}return __class(AnimationEvent,"laya.d3.animation.AnimationEvent"),AnimationEvent}(),BaseShape=function(){function BaseShape(){this.enable=!1,this.randomDirection=!1}__class(BaseShape,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var __proto=BaseShape.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._getShapeBoundBox=function(boundBox){throw new Error("BaseShape: must override it.")},__proto._getSpeedBoundBox=function(boundBox){throw new Error("BaseShape: must override it.")},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){throw new Error("BaseShape: must override it.")},__proto._calculateProceduralBounds=function(boundBox,emitterPosScale,minMaxBounds){this._getShapeBoundBox(boundBox);var min=boundBox.min,max=boundBox.max;Vector3.multiply(min,emitterPosScale,min),Vector3.multiply(max,emitterPosScale,max);var speedBounds=new BoundBox(new Vector3,new Vector3);this.randomDirection?(speedBounds.min=new Vector3(-1,-1,-1),speedBounds.max=new Vector3(1,1,1)):this._getSpeedBoundBox(speedBounds);var maxSpeedBound=new BoundBox(new Vector3,new Vector3),maxSpeedMin=maxSpeedBound.min,maxSpeedMax=maxSpeedBound.max;Vector3.scale(speedBounds.min,minMaxBounds.y,maxSpeedMin),Vector3.scale(speedBounds.max,minMaxBounds.y,maxSpeedMax),Vector3.add(boundBox.min,maxSpeedMin,maxSpeedMin),Vector3.add(boundBox.max,maxSpeedMax,maxSpeedMax),Vector3.min(boundBox.min,maxSpeedMin,boundBox.min),Vector3.max(boundBox.max,maxSpeedMin,boundBox.max);var minSpeedBound=new BoundBox(new Vector3,new Vector3),minSpeedMin=minSpeedBound.min,minSpeedMax=minSpeedBound.max;Vector3.scale(speedBounds.min,minMaxBounds.x,minSpeedMin),Vector3.scale(speedBounds.max,minMaxBounds.x,minSpeedMax),Vector3.min(minSpeedBound.min,minSpeedMax,maxSpeedMin),Vector3.max(minSpeedBound.min,minSpeedMax,maxSpeedMax),Vector3.min(boundBox.min,maxSpeedMin,boundBox.min),Vector3.max(boundBox.max,maxSpeedMin,boundBox.max)},__proto.cloneTo=function(destObject){destObject.enable=this.enable},__proto.clone=function(){var destShape=new this.constructor;return this.cloneTo(destShape),destShape},BaseShape}(),ShurikenParticleData=function(){function ShurikenParticleData(){}return __class(ShurikenParticleData,"laya.d3.core.particleShuriKen.ShurikenParticleData"),ShurikenParticleData._getStartLifetimeFromGradient=function(startLifeTimeGradient,emissionTime){for(var i=1,n=startLifeTimeGradient.gradientCount;i<n;i++){var key=startLifeTimeGradient.getKeyByIndex(i);if(key>=emissionTime){var lastKey=startLifeTimeGradient.getKeyByIndex(i-1),age=(emissionTime-lastKey)/(key-lastKey);return MathUtil.lerp(startLifeTimeGradient.getValueByIndex(i-1),startLifeTimeGradient.getValueByIndex(i),age)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},ShurikenParticleData._randomInvertRoationArray=function(rotatonE,outE,randomizeRotationDirection,rand,randomSeeds){var randDic=NaN;rand?(rand.seed=randomSeeds[6],randDic=rand.getFloat(),randomSeeds[6]=rand.seed):randDic=Math.random(),randDic<randomizeRotationDirection?(outE[0]=-rotatonE[0],outE[1]=-rotatonE[1],outE[2]=-rotatonE[2]):(outE[0]=rotatonE[0],outE[1]=rotatonE[1],outE[2]=rotatonE[2])},ShurikenParticleData._randomInvertRoation=function(rotaton,randomizeRotationDirection,rand,randomSeeds){var randDic=NaN;return rand?(rand.seed=randomSeeds[6],randDic=rand.getFloat(),randomSeeds[6]=rand.seed):randDic=Math.random(),randDic<randomizeRotationDirection&&(rotaton=-rotaton),rotaton},ShurikenParticleData.create=function(particleSystem,particleRender,transform){var autoRandomSeed=particleSystem.autoRandomSeed,rand=particleSystem._rand,randomSeeds=particleSystem._randomSeeds;switch(particleSystem.startColorType){case 0:var constantStartColorE=particleSystem.startColorConstant.elements;ShurikenParticleData.startColor[0]=constantStartColorE[0],ShurikenParticleData.startColor[1]=constantStartColorE[1],ShurikenParticleData.startColor[2]=constantStartColorE[2],ShurikenParticleData.startColor[3]=constantStartColorE[3];break;case 2:autoRandomSeed?MathUtil.lerpVector4(particleSystem.startColorConstantMin.elements,particleSystem.startColorConstantMax.elements,Math.random(),ShurikenParticleData.startColor):(rand.seed=randomSeeds[3],MathUtil.lerpVector4(particleSystem.startColorConstantMin.elements,particleSystem.startColorConstantMax.elements,rand.getFloat(),ShurikenParticleData.startColor),randomSeeds[3]=rand.seed)}var colorOverLifetime=particleSystem.colorOverLifetime;if(colorOverLifetime&&colorOverLifetime.enbale){var color=colorOverLifetime.color;switch(color.type){case 0:ShurikenParticleData.startColor[0]=ShurikenParticleData.startColor[0]*color.constant.x,ShurikenParticleData.startColor[1]=ShurikenParticleData.startColor[1]*color.constant.y,ShurikenParticleData.startColor[2]=ShurikenParticleData.startColor[2]*color.constant.z,ShurikenParticleData.startColor[3]=ShurikenParticleData.startColor[3]*color.constant.w;break;case 2:var colorRandom=NaN;autoRandomSeed?colorRandom=Math.random():(rand.seed=randomSeeds[10],colorRandom=rand.getFloat(),randomSeeds[10]=rand.seed);var minConstantColor=color.constantMin,maxConstantColor=color.constantMax;ShurikenParticleData.startColor[0]=ShurikenParticleData.startColor[0]*MathUtil.lerp(minConstantColor.x,maxConstantColor.x,colorRandom),ShurikenParticleData.startColor[1]=ShurikenParticleData.startColor[1]*MathUtil.lerp(minConstantColor.y,maxConstantColor.y,colorRandom),ShurikenParticleData.startColor[2]=ShurikenParticleData.startColor[2]*MathUtil.lerp(minConstantColor.z,maxConstantColor.z,colorRandom),ShurikenParticleData.startColor[3]=ShurikenParticleData.startColor[3]*MathUtil.lerp(minConstantColor.w,maxConstantColor.w,colorRandom)}}var particleSize=ShurikenParticleData.startSize;switch(particleSystem.startSizeType){case 0:if(particleSystem.threeDStartSize){var startSizeConstantSeparate=particleSystem.startSizeConstantSeparate;particleSize[0]=startSizeConstantSeparate.x,particleSize[1]=startSizeConstantSeparate.y,particleSize[2]=startSizeConstantSeparate.z}else particleSize[0]=particleSize[1]=particleSize[2]=particleSystem.startSizeConstant;break;case 2:if(particleSystem.threeDStartSize){var startSizeConstantMinSeparate=particleSystem.startSizeConstantMinSeparate,startSizeConstantMaxSeparate=particleSystem.startSizeConstantMaxSeparate;autoRandomSeed?(particleSize[0]=MathUtil.lerp(startSizeConstantMinSeparate.x,startSizeConstantMaxSeparate.x,Math.random()),particleSize[1]=MathUtil.lerp(startSizeConstantMinSeparate.y,startSizeConstantMaxSeparate.y,Math.random()),particleSize[2]=MathUtil.lerp(startSizeConstantMinSeparate.z,startSizeConstantMaxSeparate.z,Math.random())):(rand.seed=randomSeeds[4],particleSize[0]=MathUtil.lerp(startSizeConstantMinSeparate.x,startSizeConstantMaxSeparate.x,rand.getFloat()),particleSize[1]=MathUtil.lerp(startSizeConstantMinSeparate.y,startSizeConstantMaxSeparate.y,rand.getFloat()),particleSize[2]=MathUtil.lerp(startSizeConstantMinSeparate.z,startSizeConstantMaxSeparate.z,rand.getFloat()),randomSeeds[4]=rand.seed)}else autoRandomSeed?particleSize[0]=particleSize[1]=particleSize[2]=MathUtil.lerp(particleSystem.startSizeConstantMin,particleSystem.startSizeConstantMax,Math.random()):(rand.seed=randomSeeds[4],particleSize[0]=particleSize[1]=particleSize[2]=MathUtil.lerp(particleSystem.startSizeConstantMin,particleSystem.startSizeConstantMax,rand.getFloat()),randomSeeds[4]=rand.seed)}var sizeOverLifetime=particleSystem.sizeOverLifetime;if(sizeOverLifetime&&sizeOverLifetime.enbale&&1===sizeOverLifetime.size.type){var size=sizeOverLifetime.size;if(size.separateAxes)autoRandomSeed?(particleSize[0]=particleSize[0]*MathUtil.lerp(size.constantMinSeparate.x,size.constantMaxSeparate.x,Math.random()),particleSize[1]=particleSize[1]*MathUtil.lerp(size.constantMinSeparate.y,size.constantMaxSeparate.y,Math.random()),particleSize[2]=particleSize[2]*MathUtil.lerp(size.constantMinSeparate.z,size.constantMaxSeparate.z,Math.random())):(rand.seed=randomSeeds[11],particleSize[0]=particleSize[0]*MathUtil.lerp(size.constantMinSeparate.x,size.constantMaxSeparate.x,rand.getFloat()),particleSize[1]=particleSize[1]*MathUtil.lerp(size.constantMinSeparate.y,size.constantMaxSeparate.y,rand.getFloat()),particleSize[2]=particleSize[2]*MathUtil.lerp(size.constantMinSeparate.z,size.constantMaxSeparate.z,rand.getFloat()),randomSeeds[11]=rand.seed);else{var randomSize=NaN;autoRandomSeed?randomSize=MathUtil.lerp(size.constantMin,size.constantMax,Math.random()):(rand.seed=randomSeeds[11],randomSize=MathUtil.lerp(size.constantMin,size.constantMax,rand.getFloat()),randomSeeds[11]=rand.seed),particleSize[0]=particleSize[0]*randomSize,particleSize[1]=particleSize[1]*randomSize,particleSize[2]=particleSize[2]*randomSize}}var renderMode=particleRender.renderMode;if(1!==renderMode)switch(particleSystem.startRotationType){case 0:if(particleSystem.threeDStartRotation){var startRotationConstantSeparate=particleSystem.startRotationConstantSeparate,randomRotationE=ShurikenParticleData._tempVector30.elements;ShurikenParticleData._randomInvertRoationArray(startRotationConstantSeparate.elements,randomRotationE,particleSystem.randomizeRotationDirection,autoRandomSeed?null:rand,randomSeeds),ShurikenParticleData.startRotation[0]=randomRotationE[0],ShurikenParticleData.startRotation[1]=randomRotationE[1],ShurikenParticleData.startRotation[2]=4!==renderMode?-randomRotationE[2]:randomRotationE[2]}else ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(particleSystem.startRotationConstant,particleSystem.randomizeRotationDirection,autoRandomSeed?null:rand,randomSeeds),ShurikenParticleData.startRotation[1]=0,ShurikenParticleData.startRotation[2]=0;break;case 2:if(particleSystem.threeDStartRotation){var startRotationConstantMinSeparate=particleSystem.startRotationConstantMinSeparate,startRotationConstantMaxSeparate=particleSystem.startRotationConstantMaxSeparate,lerpRoationE=ShurikenParticleData._tempVector30.elements;autoRandomSeed?(lerpRoationE[0]=MathUtil.lerp(startRotationConstantMinSeparate.x,startRotationConstantMaxSeparate.x,Math.random()),lerpRoationE[1]=MathUtil.lerp(startRotationConstantMinSeparate.y,startRotationConstantMaxSeparate.y,Math.random()),lerpRoationE[2]=MathUtil.lerp(startRotationConstantMinSeparate.z,startRotationConstantMaxSeparate.z,Math.random())):(rand.seed=randomSeeds[5],lerpRoationE[0]=MathUtil.lerp(startRotationConstantMinSeparate.x,startRotationConstantMaxSeparate.x,rand.getFloat()),lerpRoationE[1]=MathUtil.lerp(startRotationConstantMinSeparate.y,startRotationConstantMaxSeparate.y,rand.getFloat()),lerpRoationE[2]=MathUtil.lerp(startRotationConstantMinSeparate.z,startRotationConstantMaxSeparate.z,rand.getFloat()),randomSeeds[5]=rand.seed),ShurikenParticleData._randomInvertRoationArray(lerpRoationE,lerpRoationE,particleSystem.randomizeRotationDirection,autoRandomSeed?null:rand,randomSeeds),ShurikenParticleData.startRotation[0]=lerpRoationE[0],ShurikenParticleData.startRotation[1]=lerpRoationE[1],ShurikenParticleData.startRotation[2]=4!==renderMode?-lerpRoationE[2]:lerpRoationE[2]}else autoRandomSeed?ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(MathUtil.lerp(particleSystem.startRotationConstantMin,particleSystem.startRotationConstantMax,Math.random()),particleSystem.randomizeRotationDirection,autoRandomSeed?null:rand,randomSeeds):(rand.seed=randomSeeds[5],ShurikenParticleData.startRotation[0]=ShurikenParticleData._randomInvertRoation(MathUtil.lerp(particleSystem.startRotationConstantMin,particleSystem.startRotationConstantMax,rand.getFloat()),particleSystem.randomizeRotationDirection,autoRandomSeed?null:rand,randomSeeds),randomSeeds[5]=rand.seed)}switch(particleSystem.startLifetimeType){case 0:ShurikenParticleData.startLifeTime=particleSystem.startLifetimeConstant;break;case 1:ShurikenParticleData.startLifeTime=ShurikenParticleData._getStartLifetimeFromGradient(particleSystem.startLifeTimeGradient,particleSystem.emissionTime);break;case 2:autoRandomSeed?ShurikenParticleData.startLifeTime=MathUtil.lerp(particleSystem.startLifetimeConstantMin,particleSystem.startLifetimeConstantMax,Math.random()):(rand.seed=randomSeeds[7],ShurikenParticleData.startLifeTime=MathUtil.lerp(particleSystem.startLifetimeConstantMin,particleSystem.startLifetimeConstantMax,rand.getFloat()),randomSeeds[7]=rand.seed);break;case 3:var emissionTime=particleSystem.emissionTime;autoRandomSeed?ShurikenParticleData.startLifeTime=MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(particleSystem.startLifeTimeGradientMin,emissionTime),ShurikenParticleData._getStartLifetimeFromGradient(particleSystem.startLifeTimeGradientMax,emissionTime),Math.random()):(rand.seed=randomSeeds[7],ShurikenParticleData.startLifeTime=MathUtil.lerp(ShurikenParticleData._getStartLifetimeFromGradient(particleSystem.startLifeTimeGradientMin,emissionTime),ShurikenParticleData._getStartLifetimeFromGradient(particleSystem.startLifeTimeGradientMax,emissionTime),rand.getFloat()),randomSeeds[7]=rand.seed)}switch(particleSystem.startSpeedType){case 0:ShurikenParticleData.startSpeed=particleSystem.startSpeedConstant;break;case 2:autoRandomSeed?ShurikenParticleData.startSpeed=MathUtil.lerp(particleSystem.startSpeedConstantMin,particleSystem.startSpeedConstantMax,Math.random()):(rand.seed=randomSeeds[8],ShurikenParticleData.startSpeed=MathUtil.lerp(particleSystem.startSpeedConstantMin,particleSystem.startSpeedConstantMax,rand.getFloat()),randomSeeds[8]=rand.seed)}var textureSheetAnimation=particleSystem.textureSheetAnimation;if(textureSheetAnimation&&textureSheetAnimation.enable){var title=textureSheetAnimation.tiles,titleX=title.x,titleY=title.y,subU=1/titleX,subV=1/titleY,startFrameCount=0,startFrame=textureSheetAnimation.startFrame;switch(startFrame.type){case 0:startFrameCount=startFrame.constant;break;case 1:autoRandomSeed?startFrameCount=MathUtil.lerp(startFrame.constantMin,startFrame.constantMax,Math.random()):(rand.seed=randomSeeds[14],startFrameCount=MathUtil.lerp(startFrame.constantMin,startFrame.constantMax,rand.getFloat()),randomSeeds[14]=rand.seed)}var frame=textureSheetAnimation.frame;switch(frame.type){case 0:startFrameCount+=frame.constant;break;case 2:autoRandomSeed?startFrameCount+=MathUtil.lerp(frame.constantMin,frame.constantMax,Math.random()):(rand.seed=randomSeeds[15],startFrameCount+=MathUtil.lerp(frame.constantMin,frame.constantMax,rand.getFloat()),randomSeeds[15]=rand.seed)}var startRow=0;switch(textureSheetAnimation.type){case 0:startRow=Math.floor(startFrameCount/titleX);break;case 1:textureSheetAnimation.randomRow?autoRandomSeed?startRow=Math.floor(Math.random()*titleY):(rand.seed=randomSeeds[13],startRow=Math.floor(rand.getFloat()*titleY),randomSeeds[13]=rand.seed):startRow=textureSheetAnimation.rowIndex}var startCol=Math.floor(startFrameCount%titleX);ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=subU,ShurikenParticleData.startUVInfo[1]=subV,ShurikenParticleData.startUVInfo[2]=startCol*subU,ShurikenParticleData.startUVInfo[3]=startRow*subV}else ShurikenParticleData.startUVInfo=ShurikenParticleData.startUVInfo,ShurikenParticleData.startUVInfo[0]=1,ShurikenParticleData.startUVInfo[1]=1,ShurikenParticleData.startUVInfo[2]=0,ShurikenParticleData.startUVInfo[3]=0;switch(particleSystem.simulationSpace){case 0:var positionE=transform.position.elements;ShurikenParticleData.simulationWorldPostion[0]=positionE[0],ShurikenParticleData.simulationWorldPostion[1]=positionE[1],ShurikenParticleData.simulationWorldPostion[2]=positionE[2];var rotationE=transform.rotation.elements;ShurikenParticleData.simulationWorldRotation[0]=rotationE[0],ShurikenParticleData.simulationWorldRotation[1]=rotationE[1],ShurikenParticleData.simulationWorldRotation[2]=rotationE[2],ShurikenParticleData.simulationWorldRotation[3]=rotationE[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},ShurikenParticleData.startLifeTime=NaN,ShurikenParticleData.startSpeed=NaN,__static(ShurikenParticleData,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),ShurikenParticleData}(),ColliderShape=function(){function ColliderShape(){this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this.needsCustomCollisionCallback=!1,this._scale=new Vector3(1,1,1),this._centerMatrix=new Matrix4x4,this._localOffset=new Vector3(0,0,0),this._localRotation=new Quaternion(0,0,0,1)}__class(ColliderShape,"laya.d3.physics.shape.ColliderShape");var __proto=ColliderShape.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._setScale=function(value){if(this._compoundParent)this.updateLocalTransformations();else{var valueE=value.elements;ColliderShape._nativeScale.setValue(valueE[0],valueE[1],valueE[2]),this._nativeShape.setLocalScaling(ColliderShape._nativeScale)}},__proto._addReference=function(){this._referenceCount++},__proto._removeReference=function(){this._referenceCount--},__proto.updateLocalTransformations=function(){if(this._compoundParent){var offset=ColliderShape._tempVector30;Vector3.multiply(this.localOffset,this._scale,offset),ColliderShape._createAffineTransformation(offset.elements,this.localRotation.elements,this._centerMatrix.elements)}else ColliderShape._createAffineTransformation(this.localOffset.elements,this.localRotation.elements,this._centerMatrix.elements)},__proto.cloneTo=function(destObject){var destColliderShape=destObject;this._localOffset.cloneTo(destColliderShape.localOffset),this._localRotation.cloneTo(destColliderShape.localRotation),destColliderShape.localOffset=destColliderShape.localOffset,destColliderShape.localRotation=destColliderShape.localRotation},__proto.clone=function(){return null},__proto.destroy=function(){this._nativeShape&&(Laya3D._physics3D.destroy(this._nativeShape),this._nativeShape=null)},__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"localOffset",function(){return this._localOffset},function(value){this._localOffset=value,this._compoundParent&&this._compoundParent._updateChildTransform(this)}),__getset(0,__proto,"localRotation",function(){return this._localRotation},function(value){this._localRotation=value,this._compoundParent&&this._compoundParent._updateChildTransform(this)}),ColliderShape._creatShape=function(shapeData){var colliderShape;switch(shapeData.type){case"BoxColliderShape":var sizeData=shapeData.size;colliderShape=sizeData?new BoxColliderShape(sizeData[0],sizeData[1],sizeData[2]):new BoxColliderShape;break;case"SphereColliderShape":colliderShape=new SphereColliderShape(shapeData.radius);break;case"CapsuleColliderShape":colliderShape=new CapsuleColliderShape(shapeData.radius,shapeData.height,shapeData.orientation);break;case"MeshColliderShape":var meshCollider=new MeshColliderShape;shapeData.mesh&&(meshCollider.mesh=Loader.getRes(shapeData.mesh)),colliderShape=meshCollider;break;case"ConeColliderShape":colliderShape=new ConeColliderShape(shapeData.radius,shapeData.height,shapeData.orientation);break;case"CylinderColliderShape":colliderShape=new CylinderColliderShape(shapeData.radius,shapeData.height,shapeData.orientation);break;default:throw"unknown shape type."}if(shapeData.center){var localOffset=colliderShape.localOffset;localOffset.fromArray(shapeData.center),colliderShape.localOffset=localOffset}return colliderShape},ColliderShape._createAffineTransformation=function(trans,rot,outE){var x=rot[0],y=rot[1],z=rot[2],w=rot[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;outE[0]=1-(yy+zz),outE[1]=xy+wz,outE[2]=xz-wy,outE[3]=0,outE[4]=xy-wz,outE[5]=1-(xx+zz),outE[6]=yz+wx,outE[7]=0,outE[8]=xz+wy,outE[9]=yz-wx,outE[10]=1-(xx+yy),outE[11]=0,outE[12]=trans[0],outE[13]=trans[1],outE[14]=trans[2],outE[15]=1},ColliderShape.SHAPEORIENTATION_UPX=0,ColliderShape.SHAPEORIENTATION_UPY=1,ColliderShape.SHAPEORIENTATION_UPZ=2,ColliderShape.SHAPETYPES_BOX=0,ColliderShape.SHAPETYPES_SPHERE=1,ColliderShape.SHAPETYPES_CYLINDER=2,ColliderShape.SHAPETYPES_CAPSULE=3,ColliderShape.SHAPETYPES_CONVEXHULL=4,ColliderShape.SHAPETYPES_COMPOUND=5,ColliderShape.SHAPETYPES_STATICPLANE=6,ColliderShape.SHAPETYPES_CONE=7,__static(ColliderShape,["_tempVector30",function(){return this._tempVector30=new Vector3},"_nativeScale",function(){return this._nativeScale=new Laya3D._physics3D.btVector3(1,1,1)},"_nativeVector30",function(){return this._nativeVector30=new Laya3D._physics3D.btVector3(0,0,0)},"_nativQuaternion0",function(){return this._nativQuaternion0=new Laya3D._physics3D.btQuaternion(0,0,0,1)},"_nativeTransform0",function(){return this._nativeTransform0=new Laya3D._physics3D.btTransform}]),ColliderShape}(),TextureGenerator=function(){function TextureGenerator(){}return __class(TextureGenerator,"laya.d3.resource.TextureGenerator"),TextureGenerator.lightAttenTexture=function(x,y,maxX,maxY,index,data){var sqrRange=x/maxX,atten=1/(1+25*sqrRange);sqrRange>=.64&&(sqrRange>1?atten=0:atten*=1-(sqrRange-.64)/.36),data[index]=Math.floor(255*atten+.5)},TextureGenerator.haloTexture=function(x,y,maxX,maxY,index,data){var xFac=(x-(maxX>>=1))/maxX,yFac=(y-(maxY>>=1))/maxY,sqrRange=xFac*xFac+yFac*yFac;sqrRange>1&&(sqrRange=1),data[index]=Math.floor(255*(1-sqrRange)+.5)},TextureGenerator._generateTexture2D=function(texture,textureWidth,textureHeight,func){var index=0,size=0;switch(texture.format){case 0:size=3;break;case 1:size=4;break;case 2:size=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format."}for(var data=new Uint8Array(textureWidth*textureHeight*size),y=0;y<textureHeight;y++)for(var x=0;x<textureWidth;x++)func(x,y,textureWidth,textureHeight,index,data),index+=size;texture.setPixels(data)},TextureGenerator}(),FrustumCulling=function(){function FrustumCulling(){}return __class(FrustumCulling,"laya.d3.graphics.FrustumCulling"),FrustumCulling.__init__=function(){Render.isConchApp&&(FrustumCulling._cullingBufferLength=0,FrustumCulling._cullingBuffer=new Float32Array(4096))},FrustumCulling.renderObjectCulling=function(camera,scene,context,renderList){var i=0,n=0,j=0,m=0,opaqueQueue=scene._opaqueQueue,transparentQueue=scene._transparentQueue;opaqueQueue.clear(),transparentQueue.clear();var staticBatchManagers=StaticBatchManager._managers;for(i=0,n=staticBatchManagers.length;i<n;i++)staticBatchManagers[i]._clear();var dynamicBatchManagers=DynamicBatchManager._managers;for(i=0,n=dynamicBatchManagers.length;i<n;i++)dynamicBatchManagers[i]._clear();var validCount=renderList.length,renders=renderList.elements,boundFrustum=camera.boundFrustum;Stat.spriteCount+=validCount;var camPos=context.camera._transform.position;if(scene.treeRoot)scene.treeRoot.cullingObjects(context,boundFrustum,camera,camPos,!0);else for(i=0;i<validCount;i++){var render=renders[i];if(scene.isLayerVisible(render._owner._layer,camera)&&render._enable&&render._needRender(boundFrustum)){render._visible=!0,render._distanceForSort=Vector3.distance(render.boundingSphere.center,camPos);var elements=render._renderElements;for(j=0,m=elements.length;j<m;j++){var element=elements[j],renderQueue=scene._getRenderQueue(element.material.renderQueue);renderQueue.isTransparent?element.addToTransparentRenderQueue(context,renderQueue):element.addToOpaqueRenderQueue(context,renderQueue)}}else render._visible=!1}var count=opaqueQueue.elements.length;count>0&&opaqueQueue._quickSort(0,count-1),(count=transparentQueue.elements.length)>0&&transparentQueue._quickSort(0,count-1)},FrustumCulling.renderObjectCullingNative=function(camera,scene,context,renderList){var i=0,n=0,j=0,m=0,opaqueQueue=scene._opaqueQueue,transparentQueue=scene._transparentQueue;opaqueQueue.clear(),transparentQueue.clear();var staticBatchManagers=StaticBatchManager._managers;for(i=0,n=staticBatchManagers.length;i<n;i++)staticBatchManagers[i]._clear();var dynamicBatchManagers=DynamicBatchManager._managers;for(i=0,n=dynamicBatchManagers.length;i<n;i++)dynamicBatchManagers[i]._clear();var validCount=renderList.length,renders=renderList.elements;for(i=0;i<validCount;i++)renders[i].boundingSphere;camera.boundFrustum;FrustumCulling.cullingNative(camera._boundFrustumBuffer,FrustumCulling._cullingBuffer,scene._cullingBufferIndices,validCount,scene._cullingBufferResult),Stat.spriteCount+=validCount;var camPos=context.camera._transform.position;for(i=0;i<validCount;i++){var render=renders[i];if(scene.isLayerVisible(render._owner._layer,camera)&&render._enable&&scene._cullingBufferResult[i]){render._visible=!0,render._distanceForSort=Vector3.distance(render.boundingSphere.center,camPos);var elements=render._renderElements;for(j=0,m=elements.length;j<m;j++){var element=elements[j],renderQueue=scene._getRenderQueue(element.material.renderQueue);renderQueue.isTransparent?element.addToTransparentRenderQueue(context,renderQueue):element.addToOpaqueRenderQueue(context,renderQueue)}}else render._visible=!1}var count=opaqueQueue.elements.length;count>0&&opaqueQueue._quickSort(0,count-1),(count=transparentQueue.elements.length)>0&&transparentQueue._quickSort(0,count-1)},FrustumCulling.cullingNative=function(boundFrustumBuffer,cullingBuffer,cullingBufferIndices,cullingCount,cullingBufferResult){return LayaGL.instance.culling(boundFrustumBuffer,cullingBuffer,cullingBufferIndices,cullingCount,cullingBufferResult)},FrustumCulling._cullingBufferLength=0,FrustumCulling._cullingBuffer=null,FrustumCulling}(),MeshRenderStaticBatchOwner=function(){function MeshRenderStaticBatchOwner(owner){this._owner=owner,this._batches=[],this._cacheBatchOwner=[]}return __class(MeshRenderStaticBatchOwner,"laya.d3.graphics.MeshRenderStaticBatchOwner"),MeshRenderStaticBatchOwner.prototype._getBatchRender=function(context,lightMapIndex,receiveShadow){var lightRenders=this._cacheBatchOwner[lightMapIndex];lightRenders||(lightRenders=this._cacheBatchOwner[lightMapIndex]=__newvec(2,null));var render=lightRenders[receiveShadow?1:0];return render||((render=new MeshRenderer(null)).lightmapIndex=lightMapIndex,render.receiveShadow=receiveShadow,lightRenders[receiveShadow?1:0]=render,render._defineDatas.add(MeshSprite3D.SHADERDEFINE_UV1)),render},MeshRenderStaticBatchOwner}(),GeometryElement=function(){function GeometryElement(){this._destroyed=!1}__class(GeometryElement,"laya.d3.core.GeometryElement");var __proto=GeometryElement.prototype;return Laya.imps(__proto,{"laya.resource.IDestroy":!0}),__proto._getType=function(){throw"GeometryElement:must override it."},__proto._prepareRender=function(state){return!0},__proto._render=function(state){throw"GeometryElement:must override it."},__proto.destroy=function(){this._destroyed||(this._destroyed=!0)},__getset(0,__proto,"destroyed",function(){return this._destroyed}),GeometryElement._typeCounter=0,GeometryElement}(),Keyframe=function(){function Keyframe(){this.time=NaN}__class(Keyframe,"laya.d3.core.Keyframe");var __proto=Keyframe.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){destObject.time=this.time},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},Keyframe}(),AnimatorState=function(){function AnimatorState(){this.speed=1,this.clipStart=0,this.clipEnd=1,this._nodeOwners=[]}__class(AnimatorState,"laya.d3.component.AnimatorState");var __proto=AnimatorState.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._resetFrameIndices=function(){for(var i=0,n=this._currentFrameIndices.length;i<n;i++)this._currentFrameIndices[i]=-1},__proto.addScript=function(type){var script=new type;return this._scripts=this._scripts||[],this._scripts.push(script),script},__proto.getScript=function(type){if(this._scripts)for(var i=0,n=this._scripts.length;i<n;i++){var script=this._scripts[i];if(Laya.__typeof(script,type))return script}return null},__proto.getScripts=function(type){var coms;if(this._scripts)for(var i=0,n=this._scripts.length;i<n;i++){var script=this._scripts[i];Laya.__typeof(script,type)&&(coms=coms||[]).push(script)}return coms},__proto.cloneTo=function(destObject){var dest=destObject;dest.name=this.name,dest.cycleOffset=this.cycleOffset,dest.speed=this.speed,dest.clipStart=this.clipStart,dest.clipEnd=this.clipEnd,dest.clip=this._clip},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__getset(0,__proto,"clip",function(){return this._clip},function(value){this._clip=value,this._currentFrameIndices=new Int16Array(value._nodes.count),this._resetFrameIndices()}),AnimatorState}(),SkyRenderer=function(){function SkyRenderer(){this._material=null,this._mesh=SkyBox.instance}__class(SkyRenderer,"laya.d3.resource.models.SkyRenderer");var __proto=SkyRenderer.prototype;return __proto._isAvailable=function(){return this._material&&this._mesh},__proto._render=function(state){if(this._material&&this._mesh){var gl=LayaGL.instance,scene=state.scene,camera=state.camera;WebGLContext.setCullFace(gl,!1),WebGLContext.setDepthFunc(gl,515),WebGLContext.setDepthMask(gl,!1);var shader=state.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(0,0,this._material._defineDatas.value),switchShader=shader.bind(),switchShaderLoop=Stat.loopCount!==shader._uploadLoopCount,uploadScene=shader._uploadScene!==scene||switchShaderLoop;(uploadScene||switchShader)&&(shader.uploadUniforms(shader._sceneUniformParamsMap,scene._shaderValues,uploadScene),shader._uploadScene=scene);var uploadCamera=shader._uploadCamera!==camera||switchShaderLoop;(uploadCamera||switchShader)&&(shader.uploadUniforms(shader._cameraUniformParamsMap,camera._shaderValues,uploadCamera),shader._uploadCamera=camera);var uploadMaterial=shader._uploadMaterial!==this._material||switchShaderLoop;(uploadMaterial||switchShader)&&(shader.uploadUniforms(shader._materialUniformParamsMap,this._material._shaderValues,uploadMaterial),shader._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(state),WebGLContext.setDepthFunc(gl,513),WebGLContext.setDepthMask(gl,!0)}},__proto.destroy=function(){this._material&&(this._material._removeReference(),this._material=null)},__getset(0,__proto,"material",function(){return this._material},function(value){this._material!==value&&(this._material&&this._material._removeReference(),value&&value._addReference(),this._material=value)}),__getset(0,__proto,"mesh",function(){return this._mesh},function(value){this._mesh!==value&&(this._mesh=value)}),SkyRenderer}(),BoundBox=(function(){function PrimitiveMesh(){}__class(PrimitiveMesh,"laya.d3.resource.models.PrimitiveMesh"),PrimitiveMesh._createMesh=function(vertexDeclaration,vertices,indices){var mesh=new Mesh,subMesh=new SubMesh(mesh),vertexBuffer=new VertexBuffer3D(4*vertices.length,35044,!0);vertexBuffer.vertexDeclaration=vertexDeclaration,vertexBuffer.setData(vertices),mesh._vertexBuffers.push(vertexBuffer),mesh._vertexCount+=vertexBuffer.vertexCount;var indexBuffer=new IndexBuffer3D("ushort",indices.length,35044,!0);indexBuffer.setData(indices),mesh._indexBuffer=indexBuffer;var bufferState=subMesh._bufferState;bufferState.bind(),bufferState.applyVertexBuffer(vertexBuffer),bufferState.applyIndexBuffer(indexBuffer),bufferState.unBind(),subMesh._vertexBuffer=vertexBuffer,subMesh._indexBuffer=indexBuffer,subMesh._indexStart=0,subMesh._indexCount=indexBuffer.indexCount;var subIndexBufferStart=subMesh._subIndexBufferStart,subIndexBufferCount=subMesh._subIndexBufferCount,boneIndicesList=subMesh._boneIndicesList;subIndexBufferStart.length=1,subIndexBufferCount.length=1,boneIndicesList.length=1,subIndexBufferStart[0]=0,subIndexBufferCount[0]=indexBuffer.indexCount;var subMeshes=[];subMeshes.push(subMesh),mesh._setSubMeshes(subMeshes);var memorySize=vertexBuffer._byteLength+indexBuffer._byteLength;return mesh._setCPUMemory(memorySize),mesh._setGPUMemory(memorySize),mesh},PrimitiveMesh.createBox=function(long,height,width){void 0===long&&(long=1),void 0===height&&(height=1),void 0===width&&(width=1);var vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),halfLong=long/2,halfHeight=height/2,halfWidth=width/2,vertices=new Float32Array([-halfLong,halfHeight,-halfWidth,0,1,0,0,0,halfLong,halfHeight,-halfWidth,0,1,0,1,0,halfLong,halfHeight,halfWidth,0,1,0,1,1,-halfLong,halfHeight,halfWidth,0,1,0,0,1,-halfLong,-halfHeight,-halfWidth,0,-1,0,0,1,halfLong,-halfHeight,-halfWidth,0,-1,0,1,1,halfLong,-halfHeight,halfWidth,0,-1,0,1,0,-halfLong,-halfHeight,halfWidth,0,-1,0,0,0,-halfLong,halfHeight,-halfWidth,-1,0,0,0,0,-halfLong,halfHeight,halfWidth,-1,0,0,1,0,-halfLong,-halfHeight,halfWidth,-1,0,0,1,1,-halfLong,-halfHeight,-halfWidth,-1,0,0,0,1,halfLong,halfHeight,-halfWidth,1,0,0,1,0,halfLong,halfHeight,halfWidth,1,0,0,0,0,halfLong,-halfHeight,halfWidth,1,0,0,0,1,halfLong,-halfHeight,-halfWidth,1,0,0,1,1,-halfLong,halfHeight,halfWidth,0,0,1,0,0,halfLong,halfHeight,halfWidth,0,0,1,1,0,halfLong,-halfHeight,halfWidth,0,0,1,1,1,-halfLong,-halfHeight,halfWidth,0,0,1,0,1,-halfLong,halfHeight,-halfWidth,0,0,-1,1,0,halfLong,halfHeight,-halfWidth,0,0,-1,0,0,halfLong,-halfHeight,-halfWidth,0,0,-1,0,1,-halfLong,-halfHeight,-halfWidth,0,0,-1,1,1]),indices=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createCapsule=function(radius,height,stacks,slices){void 0===radius&&(radius=.5),void 0===height&&(height=2),void 0===stacks&&(stacks=16),void 0===slices&&(slices=32);var vertexCount=(stacks+1)*(slices+1)*2+2*(slices+1),indexCount=3*stacks*(slices+1)*2*2+2*slices*3,vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(vertexCount*vertexFloatStride),indices=new Uint16Array(indexCount),stackAngle=Math.PI/2/stacks,sliceAngle=2*Math.PI/slices,hcHeight=height/2-radius,posX=0,posY=0,posZ=0,vc=0,ic=0,verticeCount=0,stack=0,slice=0;for(stack=0;stack<=stacks;stack++)for(slice=0;slice<=slices;slice++)posX=radius*Math.cos(stack*stackAngle)*Math.cos(slice*sliceAngle+Math.PI),posY=radius*Math.sin(stack*stackAngle),posZ=radius*Math.cos(stack*stackAngle)*Math.sin(slice*sliceAngle+Math.PI),vertices[vc++]=posX,vertices[vc++]=posY+hcHeight,vertices[vc++]=posZ,vertices[vc++]=posX,vertices[vc++]=posY,vertices[vc++]=posZ,vertices[vc++]=1-slice/slices,vertices[vc++]=(1-stack/stacks)*(Math.PI*radius/2/(height+Math.PI*radius)),stack<stacks&&(indices[ic++]=stack*(slices+1)+slice+(slices+1),indices[ic++]=stack*(slices+1)+slice,indices[ic++]=stack*(slices+1)+slice+1,indices[ic++]=stack*(slices+1)+slice+slices,indices[ic++]=stack*(slices+1)+slice,indices[ic++]=stack*(slices+1)+slice+(slices+1));for(verticeCount+=(stacks+1)*(slices+1),stack=0;stack<=stacks;stack++)for(slice=0;slice<=slices;slice++)posX=radius*Math.cos(stack*stackAngle)*Math.cos(slice*sliceAngle+Math.PI),posY=radius*Math.sin(-stack*stackAngle),posZ=radius*Math.cos(stack*stackAngle)*Math.sin(slice*sliceAngle+Math.PI),vertices[vc++]=posX,vertices[vc++]=posY-hcHeight,vertices[vc++]=posZ,vertices[vc++]=posX,vertices[vc++]=posY,vertices[vc++]=posZ,vertices[vc++]=1-slice/slices,vertices[vc++]=(stack/stacks*(Math.PI*radius/2)+(height+Math.PI*radius/2))/(height+Math.PI*radius),stack<stacks&&(indices[ic++]=verticeCount+stack*(slices+1)+slice,indices[ic++]=verticeCount+stack*(slices+1)+slice+(slices+1),indices[ic++]=verticeCount+stack*(slices+1)+slice+1,indices[ic++]=verticeCount+stack*(slices+1)+slice,indices[ic++]=verticeCount+stack*(slices+1)+slice+slices,indices[ic++]=verticeCount+stack*(slices+1)+slice+(slices+1));for(verticeCount+=(stacks+1)*(slices+1),slice=0;slice<=slices;slice++)posX=radius*Math.cos(slice*sliceAngle+Math.PI),posY=hcHeight,posZ=radius*Math.sin(slice*sliceAngle+Math.PI),vertices[vc++]=posX,vertices[vc+8*(slices+1)-1]=posX,vertices[vc++]=posY,vertices[vc+8*(slices+1)-1]=-posY,vertices[vc++]=posZ,vertices[vc+8*(slices+1)-1]=posZ,vertices[vc++]=posX,vertices[vc+8*(slices+1)-1]=posX,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=0,vertices[vc++]=posZ,vertices[vc+8*(slices+1)-1]=posZ,vertices[vc++]=1-1*slice/slices,vertices[vc+8*(slices+1)-1]=1-1*slice/slices,vertices[vc++]=Math.PI*radius/2/(height+Math.PI*radius),vertices[vc+8*(slices+1)-1]=(Math.PI*radius/2+height)/(height+Math.PI*radius);for(slice=0;slice<slices;slice++)indices[ic++]=slice+verticeCount+(slices+1),indices[ic++]=slice+verticeCount+1,indices[ic++]=slice+verticeCount,indices[ic++]=slice+verticeCount+(slices+1),indices[ic++]=slice+verticeCount+(slices+1)+1,indices[ic++]=slice+verticeCount+1;return verticeCount+=2*(slices+1),PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createCone=function(radius,height,slices){void 0===radius&&(radius=.5),void 0===height&&(height=1),void 0===slices&&(slices=32);for(var vertexCount=slices+1+1+2*(slices+1),indexCount=6*slices+3*slices,vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(vertexCount*vertexFloatStride),indices=new Uint16Array(indexCount),sliceAngle=2*Math.PI/slices,halfHeight=height/2,curAngle=0,verticeCount=0,posX=0,posY=0,posZ=0,normal=new Vector3,downV3=new Vector3(0,-1,0),upPoint=new Vector3(0,halfHeight,0),downPoint=new Vector3,v3=new Vector3,q4=new Quaternion,rotateAxis=new Vector3,rotateRadius=NaN,vc=0,ic=0,rv=0;rv<=slices;rv++)curAngle=rv*sliceAngle,posX=Math.cos(curAngle+Math.PI)*radius,posY=halfHeight,posZ=Math.sin(curAngle+Math.PI)*radius,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=posX,vertices[vc++]=posY,vertices[vc+8*(slices+1)-1]=-posY,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=posZ,normal.x=posX,normal.y=0,normal.z=posZ,downPoint.x=posX,downPoint.y=-posY,downPoint.z=posZ,Vector3.subtract(downPoint,upPoint,v3),Vector3.normalize(v3,v3),rotateRadius=Math.acos(Vector3.dot(downV3,v3)),Vector3.cross(downV3,v3,rotateAxis),Vector3.normalize(rotateAxis,rotateAxis),Quaternion.createFromAxisAngle(rotateAxis,rotateRadius,q4),Vector3.normalize(normal,normal),Vector3.transformQuat(normal,q4,normal),Vector3.normalize(normal,normal),vertices[vc++]=normal.x,vertices[vc+8*(slices+1)-1]=normal.x,vertices[vc++]=normal.y,vertices[vc+8*(slices+1)-1]=normal.y,vertices[vc++]=normal.z,vertices[vc+8*(slices+1)-1]=normal.z,vertices[vc++]=1-1*rv/slices,vertices[vc+8*(slices+1)-1]=1-1*rv/slices,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=1;vc+=8*(slices+1);for(var ri=0;ri<slices;ri++)indices[ic++]=ri+verticeCount+(slices+1),indices[ic++]=ri+verticeCount+1,indices[ic++]=ri+verticeCount,indices[ic++]=ri+verticeCount+(slices+1),indices[ic++]=ri+verticeCount+(slices+1)+1,indices[ic++]=ri+verticeCount+1;verticeCount+=2*(slices+1);for(var bv=0;bv<=slices;bv++)0===bv&&(vertices[vc++]=0,vertices[vc++]=-halfHeight,vertices[vc++]=0,vertices[vc++]=0,vertices[vc++]=-1,vertices[vc++]=0,vertices[vc++]=.5,vertices[vc++]=.5),curAngle=bv*sliceAngle,posX=Math.cos(curAngle+Math.PI)*radius,posY=-halfHeight,posZ=Math.sin(curAngle+Math.PI)*radius,vertices[vc++]=posX,vertices[vc++]=posY,vertices[vc++]=posZ,vertices[vc++]=0,vertices[vc++]=-1,vertices[vc++]=0,vertices[vc++]=.5+.5*Math.cos(curAngle),vertices[vc++]=.5+.5*Math.sin(curAngle);for(var bi=0;bi<slices;bi++)indices[ic++]=0+verticeCount,indices[ic++]=bi+2+verticeCount,indices[ic++]=bi+1+verticeCount;return verticeCount+=slices+1+1,PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createCylinder=function(radius,height,slices){void 0===radius&&(radius=.5),void 0===height&&(height=2),void 0===slices&&(slices=32);for(var vertexCount=slices+1+1+2*(slices+1)+(slices+1+1),indexCount=3*slices+6*slices+3*slices,vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(vertexCount*vertexFloatStride),indices=new Uint16Array(indexCount),sliceAngle=2*Math.PI/slices,halfHeight=height/2,curAngle=0,verticeCount=0,posX=0,posY=0,posZ=0,vc=0,ic=0,tv=0;tv<=slices;tv++)0===tv&&(vertices[vc++]=0,vertices[vc++]=halfHeight,vertices[vc++]=0,vertices[vc++]=0,vertices[vc++]=1,vertices[vc++]=0,vertices[vc++]=.5,vertices[vc++]=.5),curAngle=tv*sliceAngle,posX=Math.cos(curAngle)*radius,posY=halfHeight,posZ=Math.sin(curAngle)*radius,vertices[vc++]=posX,vertices[vc++]=posY,vertices[vc++]=posZ,vertices[vc++]=0,vertices[vc++]=1,vertices[vc++]=0,vertices[vc++]=.5+.5*Math.cos(curAngle),vertices[vc++]=.5+.5*Math.sin(curAngle);for(var ti=0;ti<slices;ti++)indices[ic++]=0,indices[ic++]=ti+1,indices[ic++]=ti+2;verticeCount+=slices+1+1;for(var rv=0;rv<=slices;rv++)curAngle=rv*sliceAngle,posX=Math.cos(curAngle+Math.PI)*radius,posY=halfHeight,posZ=Math.sin(curAngle+Math.PI)*radius,vertices[vc++]=posX,vertices[vc+8*(slices+1)-1]=posX,vertices[vc++]=posY,vertices[vc+8*(slices+1)-1]=-posY,vertices[vc++]=posZ,vertices[vc+8*(slices+1)-1]=posZ,vertices[vc++]=posX,vertices[vc+8*(slices+1)-1]=posX,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=0,vertices[vc++]=posZ,vertices[vc+8*(slices+1)-1]=posZ,vertices[vc++]=1-1*rv/slices,vertices[vc+8*(slices+1)-1]=1-1*rv/slices,vertices[vc++]=0,vertices[vc+8*(slices+1)-1]=1;vc+=8*(slices+1);for(var ri=0;ri<slices;ri++)indices[ic++]=ri+verticeCount+(slices+1),indices[ic++]=ri+verticeCount+1,indices[ic++]=ri+verticeCount,indices[ic++]=ri+verticeCount+(slices+1),indices[ic++]=ri+verticeCount+(slices+1)+1,indices[ic++]=ri+verticeCount+1;verticeCount+=2*(slices+1);for(var bv=0;bv<=slices;bv++)0===bv&&(vertices[vc++]=0,vertices[vc++]=-halfHeight,vertices[vc++]=0,vertices[vc++]=0,vertices[vc++]=-1,vertices[vc++]=0,vertices[vc++]=.5,vertices[vc++]=.5),curAngle=bv*sliceAngle,posX=Math.cos(curAngle+Math.PI)*radius,posY=-halfHeight,posZ=Math.sin(curAngle+Math.PI)*radius,vertices[vc++]=posX,vertices[vc++]=posY,vertices[vc++]=posZ,vertices[vc++]=0,vertices[vc++]=-1,vertices[vc++]=0,vertices[vc++]=.5+.5*Math.cos(curAngle),vertices[vc++]=.5+.5*Math.sin(curAngle);for(var bi=0;bi<slices;bi++)indices[ic++]=0+verticeCount,indices[ic++]=bi+2+verticeCount,indices[ic++]=bi+1+verticeCount;return verticeCount+=slices+1+1,PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createPlane=function(long,width,stacks,slices){void 0===long&&(long=10),void 0===width&&(width=10),void 0===stacks&&(stacks=10),void 0===slices&&(slices=10);for(var vertexCount=(stacks+1)*(slices+1),indices=new Uint16Array(stacks*slices*2*3),vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(vertexCount*vertexFloatStride),halfLong=long/2,halfWidth=width/2,stacksLong=long/stacks,slicesWidth=width/slices,verticeCount=0,i=0;i<=slices;i++)for(var j=0;j<=stacks;j++)vertices[verticeCount++]=j*stacksLong-halfLong,vertices[verticeCount++]=0,vertices[verticeCount++]=i*slicesWidth-halfWidth,vertices[verticeCount++]=0,vertices[verticeCount++]=1,vertices[verticeCount++]=0,vertices[verticeCount++]=1*j/stacks,vertices[verticeCount++]=1*i/slices;var indiceIndex=0;for(i=0;i<slices;i++)for(j=0;j<stacks;j++)indices[indiceIndex++]=(i+1)*(stacks+1)+j,indices[indiceIndex++]=i*(stacks+1)+j,indices[indiceIndex++]=(i+1)*(stacks+1)+j+1,indices[indiceIndex++]=i*(stacks+1)+j,indices[indiceIndex++]=i*(stacks+1)+j+1,indices[indiceIndex++]=(i+1)*(stacks+1)+j+1;return PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createQuad=function(long,width){void 0===long&&(long=1),void 0===width&&(width=1);var vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),halfLong=(vertexDeclaration.vertexStride,long/2),halfWidth=width/2,vertices=new Float32Array([-halfLong,halfWidth,0,0,0,1,0,0,halfLong,halfWidth,0,0,0,1,1,0,-halfLong,-halfWidth,0,0,0,1,0,1,halfLong,-halfWidth,0,0,0,1,1,1]),indices=new Uint16Array([0,1,2,3,2,1]);return PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)},PrimitiveMesh.createSphere=function(radius,stacks,slices){void 0===radius&&(radius=.5),void 0===stacks&&(stacks=32),void 0===slices&&(slices=32);var vertexCount=(stacks+1)*(slices+1),indexCount=3*stacks*(slices+1)*2,indices=new Uint16Array(indexCount),vertexDeclaration=VertexMesh.getVertexDeclaration("POSITION,NORMAL,UV"),vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(vertexCount*vertexFloatStride),stackAngle=Math.PI/stacks,sliceAngle=2*Math.PI/slices,vertexIndex=0;vertexCount=0,indexCount=0;for(var stack=0;stack<stacks+1;stack++)for(var r=Math.sin(stack*stackAngle),y=Math.cos(stack*stackAngle),slice=0;slice<slices+1;slice++){var x=r*Math.sin(slice*sliceAngle+1*Math.PI/2),z=r*Math.cos(slice*sliceAngle+1*Math.PI/2);vertices[vertexCount+0]=x*radius,vertices[vertexCount+1]=y*radius,vertices[vertexCount+2]=z*radius,vertices[vertexCount+3]=x,vertices[vertexCount+4]=y,vertices[vertexCount+5]=z,vertices[vertexCount+6]=slice/slices,vertices[vertexCount+7]=stack/stacks,vertexCount+=vertexFloatStride,stack!=stacks-1&&(indices[indexCount++]=vertexIndex+(slices+1),indices[indexCount++]=vertexIndex,indices[indexCount++]=vertexIndex+1,indices[indexCount++]=vertexIndex+slices,indices[indexCount++]=vertexIndex,indices[indexCount++]=vertexIndex+(slices+1),vertexIndex++)}return PrimitiveMesh._createMesh(vertexDeclaration,vertices,indices)}}(),function(){function BoundBox(min,max){this.min=null,this.max=null,this.min=min,this.max=max}__class(BoundBox,"laya.d3.math.BoundBox");var __proto=BoundBox.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.getCorners=function(corners){corners.length=8;var mine=this.min.elements,maxe=this.max.elements,minX=mine[0],minY=mine[1],minZ=mine[2],maxX=maxe[0],maxY=maxe[1],maxZ=maxe[2];corners[0]=new Vector3(minX,maxY,maxZ),corners[1]=new Vector3(maxX,maxY,maxZ),corners[2]=new Vector3(maxX,minY,maxZ),corners[3]=new Vector3(minX,minY,maxZ),corners[4]=new Vector3(minX,maxY,minZ),corners[5]=new Vector3(maxX,maxY,minZ),corners[6]=new Vector3(maxX,minY,minZ),corners[7]=new Vector3(minX,minY,minZ)},__proto.toDefault=function(){this.min.toDefault(),this.max.toDefault()},__proto.cloneTo=function(destObject){var dest=destObject;this.min.cloneTo(dest.min),this.max.cloneTo(dest.max)},__proto.clone=function(){var dest=new this.constructor(new Vector3,new Vector3);return this.cloneTo(dest),dest},BoundBox.createfromPoints=function(points,out){if(null==points)throw new Error("points");var min=out.min,max=out.max,minE=min.elements;minE[0]=Number.MAX_VALUE,minE[1]=Number.MAX_VALUE,minE[2]=Number.MAX_VALUE;var maxE=max.elements;maxE[0]=-Number.MAX_VALUE,maxE[1]=-Number.MAX_VALUE,maxE[2]=-Number.MAX_VALUE;for(var i=0,n=points.length;i<n;++i)Vector3.min(min,points[i],min),Vector3.max(max,points[i],max)},BoundBox.merge=function(box1,box2,out){Vector3.min(box1.min,box2.min,out.min),Vector3.max(box1.max,box2.max,out.max)},BoundBox}()),ShaderVariable=function(){function ShaderVariable(){this.textureID=-1}return __class(ShaderVariable,"laya.d3.shader.ShaderVariable"),ShaderVariable}(),GradientAngularVelocity=(function(){function TextMesh(){this._vertices=null,this._vertexBuffer=null,this._text=null,this._fontSize=0,this._color=null}__class(TextMesh,"laya.d3.text.TextMesh");var __proto=TextMesh.prototype;__proto._createVertexBuffer=function(charCount){},__proto._resizeVertexBuffer=function(charCount){},__proto._addChar=function(){},__getset(0,__proto,"text",function(){return this._text},function(value){this._text=value}),__getset(0,__proto,"fontSize",function(){return this._fontSize},function(value){this._fontSize=value}),__getset(0,__proto,"color",function(){return this._color},function(value){this._color=value}),TextMesh._indexBuffer=null}(),function(){function GradientAngularVelocity(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}__class(GradientAngularVelocity,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var __proto=GradientAngularVelocity.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destGradientAngularVelocity=destObject;destGradientAngularVelocity._type=this._type,destGradientAngularVelocity._separateAxes=this._separateAxes,destGradientAngularVelocity._constant=this._constant,this._constantSeparate.cloneTo(destGradientAngularVelocity._constantSeparate),this._gradient.cloneTo(destGradientAngularVelocity._gradient),this._gradientX.cloneTo(destGradientAngularVelocity._gradientX),this._gradientY.cloneTo(destGradientAngularVelocity._gradientY),this._gradientZ.cloneTo(destGradientAngularVelocity._gradientZ),destGradientAngularVelocity._constantMin=this._constantMin,destGradientAngularVelocity._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(destGradientAngularVelocity._constantMinSeparate),this._constantMaxSeparate.cloneTo(destGradientAngularVelocity._constantMaxSeparate),this._gradientMin.cloneTo(destGradientAngularVelocity._gradientMin),this._gradientMax.cloneTo(destGradientAngularVelocity._gradientMax),this._gradientXMin.cloneTo(destGradientAngularVelocity._gradientXMin),this._gradientXMax.cloneTo(destGradientAngularVelocity._gradientXMax),this._gradientYMin.cloneTo(destGradientAngularVelocity._gradientYMin),this._gradientYMax.cloneTo(destGradientAngularVelocity._gradientYMax),this._gradientZMin.cloneTo(destGradientAngularVelocity._gradientZMin),this._gradientZMax.cloneTo(destGradientAngularVelocity._gradientZMax)},__proto.clone=function(){var destGradientAngularVelocity=new this.constructor;return this.cloneTo(destGradientAngularVelocity),destGradientAngularVelocity},__getset(0,__proto,"gradientZ",function(){return this._gradientZ}),__getset(0,__proto,"constant",function(){return this._constant}),__getset(0,__proto,"gradient",function(){return this._gradient}),__getset(0,__proto,"separateAxes",function(){return this._separateAxes}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"constantSeparate",function(){return this._constantSeparate}),__getset(0,__proto,"gradientX",function(){return this._gradientX}),__getset(0,__proto,"gradientY",function(){return this._gradientY}),__getset(0,__proto,"gradientW",function(){return this._gradientW}),__getset(0,__proto,"gradientMin",function(){return this._gradientMin}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"gradientMax",function(){return this._gradientMax}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),__getset(0,__proto,"gradientWMin",function(){return this._gradientWMin}),__getset(0,__proto,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,__proto,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,__proto,"gradientXMin",function(){return this._gradientXMin}),__getset(0,__proto,"gradientXMax",function(){return this._gradientXMax}),__getset(0,__proto,"gradientWMax",function(){return this._gradientWMax}),__getset(0,__proto,"gradientYMin",function(){return this._gradientYMin}),__getset(0,__proto,"gradientYMax",function(){return this._gradientYMax}),__getset(0,__proto,"gradientZMin",function(){return this._gradientZMin}),__getset(0,__proto,"gradientZMax",function(){return this._gradientZMax}),GradientAngularVelocity.createByConstant=function(constant){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=0,gradientAngularVelocity._separateAxes=!1,gradientAngularVelocity._constant=constant,gradientAngularVelocity},GradientAngularVelocity.createByConstantSeparate=function(separateConstant){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=0,gradientAngularVelocity._separateAxes=!0,gradientAngularVelocity._constantSeparate=separateConstant,gradientAngularVelocity},GradientAngularVelocity.createByGradient=function(gradient){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=1,gradientAngularVelocity._separateAxes=!1,gradientAngularVelocity._gradient=gradient,gradientAngularVelocity},GradientAngularVelocity.createByGradientSeparate=function(gradientX,gradientY,gradientZ){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=1,gradientAngularVelocity._separateAxes=!0,gradientAngularVelocity._gradientX=gradientX,gradientAngularVelocity._gradientY=gradientY,gradientAngularVelocity._gradientZ=gradientZ,gradientAngularVelocity},GradientAngularVelocity.createByRandomTwoConstant=function(constantMin,constantMax){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=2,gradientAngularVelocity._separateAxes=!1,gradientAngularVelocity._constantMin=constantMin,gradientAngularVelocity._constantMax=constantMax,gradientAngularVelocity},GradientAngularVelocity.createByRandomTwoConstantSeparate=function(separateConstantMin,separateConstantMax){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=2,gradientAngularVelocity._separateAxes=!0,gradientAngularVelocity._constantMinSeparate=separateConstantMin,gradientAngularVelocity._constantMaxSeparate=separateConstantMax,gradientAngularVelocity},GradientAngularVelocity.createByRandomTwoGradient=function(gradientMin,gradientMax){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=3,gradientAngularVelocity._separateAxes=!1,gradientAngularVelocity._gradientMin=gradientMin,gradientAngularVelocity._gradientMax=gradientMax,gradientAngularVelocity},GradientAngularVelocity.createByRandomTwoGradientSeparate=function(gradientXMin,gradientXMax,gradientYMin,gradientYMax,gradientZMin,gradientZMax,gradientWMin,gradientWMax){var gradientAngularVelocity=new GradientAngularVelocity;return gradientAngularVelocity._type=3,gradientAngularVelocity._separateAxes=!0,gradientAngularVelocity._gradientXMin=gradientXMin,gradientAngularVelocity._gradientXMax=gradientXMax,gradientAngularVelocity._gradientYMin=gradientYMin,gradientAngularVelocity._gradientYMax=gradientYMax,gradientAngularVelocity._gradientZMin=gradientZMin,gradientAngularVelocity._gradientZMax=gradientZMax,gradientAngularVelocity._gradientWMin=gradientWMin,gradientAngularVelocity._gradientWMax=gradientWMax,gradientAngularVelocity},GradientAngularVelocity}()),DynamicBatchManager=function(){function DynamicBatchManager(){this._batchRenderElementPool=[]}__class(DynamicBatchManager,"laya.d3.graphics.DynamicBatchManager");var __proto=DynamicBatchManager.prototype;return __proto._clear=function(){this._batchRenderElementPoolIndex=0},__proto._getBatchRenderElementFromPool=function(){throw"StaticBatch:must override this function."},__proto.dispose=function(){},DynamicBatchManager._registerManager=function(manager){DynamicBatchManager._managers.push(manager)},DynamicBatchManager._managers=[],DynamicBatchManager}(),HeightMap=function(){function HeightMap(width,height,minHeight,maxHeight){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=width,this._h=height,this._minHeight=minHeight,this._maxHeight=maxHeight}__class(HeightMap,"laya.d3.core.HeightMap");var __proto=HeightMap.prototype;return __proto._inBounds=function(row,col){return row>=0&&row<this._h&&col>=0&&col<this._w},__proto.getHeight=function(row,col){return this._inBounds(row,col)?this._datas[row][col]:NaN},__getset(0,__proto,"width",function(){return this._w}),__getset(0,__proto,"height",function(){return this._h}),__getset(0,__proto,"maxHeight",function(){return this._maxHeight}),__getset(0,__proto,"minHeight",function(){return this._minHeight}),HeightMap.creatFromMesh=function(mesh,width,height,outCellSize){for(var vertices=[],indexs=[],submesheCount=mesh.subMeshCount,i=0;i<submesheCount;i++){for(var subMesh=mesh._getSubMesh(i),vertexBuffer=subMesh._vertexBuffer,verts=vertexBuffer.getData(),subMeshVertices=[],j=0;j<verts.length;j+=vertexBuffer.vertexDeclaration.vertexStride/4){var position=new Vector3(verts[j+0],verts[j+1],verts[j+2]);subMeshVertices.push(position)}vertices.push(subMeshVertices);var ib=subMesh._indexBuffer;indexs.push(ib.getData())}var boundingBox=mesh.boundingBox,minX=boundingBox.min.x,minZ=boundingBox.min.z,maxX=boundingBox.max.x,maxZ=boundingBox.max.z,minY=boundingBox.min.y,maxY=boundingBox.max.y,widthSize=maxX-minX,heightSize=maxZ-minZ,cellWidth=outCellSize.elements[0]=widthSize/(width-1),cellHeight=outCellSize.elements[1]=heightSize/(height-1),heightMap=new HeightMap(width,height,minY,maxY),ray=HeightMap._tempRay,rayDirE=ray.direction.elements;rayDirE[0]=0,rayDirE[1]=-1,rayDirE[2]=0;var rayY=maxY+.1;ray.origin.elements[1]=rayY;for(var h=0;h<height;h++){var posZ=minZ+h*cellHeight;heightMap._datas[h]=[];for(var w=0;w<width;w++){var posX=minX+w*cellWidth,rayOriE=ray.origin.elements;rayOriE[0]=posX,rayOriE[2]=posZ;var closestIntersection=HeightMap._getPosition(ray,vertices,indexs);heightMap._datas[h][w]=closestIntersection===Number.MAX_VALUE?NaN:rayY-closestIntersection}}return heightMap},HeightMap.createFromImage=function(texture,minHeight,maxHeight){for(var textureWidth=texture.width,textureHeight=texture.height,heightMap=new HeightMap(textureWidth,textureHeight,minHeight,maxHeight),compressionRatio=(maxHeight-minHeight)/254,pixelsInfo=texture.getPixels(),index=0,h=0;h<textureHeight;h++)for(var colDatas=heightMap._datas[h]=[],w=0;w<textureWidth;w++){var r=pixelsInfo[index++],g=pixelsInfo[index++],b=pixelsInfo[index++],a=pixelsInfo[index++];colDatas[w]=255==r&&255==g&&255==b&&255==a?NaN:(r+g+b)/3*compressionRatio+minHeight}return heightMap},HeightMap._getPosition=function(ray,vertices,indexs){for(var closestIntersection=Number.MAX_VALUE,i=0;i<vertices.length;i++)for(var subMeshVertices=vertices[i],subMeshIndexes=indexs[i],j=0;j<subMeshIndexes.length;j+=3){var vertex1=subMeshVertices[subMeshIndexes[j+0]],vertex2=subMeshVertices[subMeshIndexes[j+1]],vertex3=subMeshVertices[subMeshIndexes[j+2]],intersection=Picker.rayIntersectsTriangle(ray,vertex1,vertex2,vertex3);!isNaN(intersection)&&intersection<closestIntersection&&(closestIntersection=intersection)}return closestIntersection},__static(HeightMap,["_tempRay",function(){return this._tempRay=new Ray(new Vector3,new Vector3)}]),HeightMap}(),BaseVector=function(){function BaseVector(){this.elements=null}return __class(BaseVector,"laya.d3.math.BaseVector"),BaseVector}(),DefineDatas=function(){function DefineDatas(){this.value=0}__class(DefineDatas,"laya.d3.shader.DefineDatas");var __proto=DefineDatas.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.add=function(define){this.value|=define},__proto.remove=function(define){this.value&=~define},__proto.has=function(define){return(this.value&define)>0},__proto.cloneTo=function(destObject){destObject.value=this.value},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},DefineDatas}(),PixelLineVertex=function(){function PixelLineVertex(){}__class(PixelLineVertex,"laya.d3.core.pixelLine.PixelLineVertex");var __proto=PixelLineVertex.prototype;return __getset(0,__proto,"vertexDeclaration",function(){return PixelLineVertex._vertexDeclaration}),__getset(1,PixelLineVertex,"vertexDeclaration",function(){return PixelLineVertex._vertexDeclaration}),__static(PixelLineVertex,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(28,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector4",1)])}]),PixelLineVertex}(),SizeOverLifetime=function(){function SizeOverLifetime(size){this._size=null,this.enbale=!1,this._size=size}__class(SizeOverLifetime,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var __proto=SizeOverLifetime.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destSizeOverLifetime=destObject;this._size.cloneTo(destSizeOverLifetime._size),destSizeOverLifetime.enbale=this.enbale},__proto.clone=function(){var destSize;switch(this._size.type){case 0:destSize=this._size.separateAxes?GradientSize.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):GradientSize.createByGradient(this._size.gradient.clone());break;case 1:destSize=this._size.separateAxes?GradientSize.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):GradientSize.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:destSize=this._size.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):GradientSize.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var destSizeOverLifetime=new this.constructor(destSize);return destSizeOverLifetime.enbale=this.enbale,destSizeOverLifetime},__getset(0,__proto,"size",function(){return this._size}),SizeOverLifetime}(),Picker=function(){function Picker(){}return __class(Picker,"laya.d3.utils.Picker"),Picker.calculateCursorRay=function(point,viewPort,projectionMatrix,viewMatrix,world,out){var x=point.elements[0],y=point.elements[1],nearSource=Picker._tempVector30,nerSourceE=nearSource.elements;nerSourceE[0]=x,nerSourceE[1]=y,nerSourceE[2]=viewPort.minDepth;var farSource=Picker._tempVector31,farSourceE=farSource.elements;farSourceE[0]=x,farSourceE[1]=y,farSourceE[2]=viewPort.maxDepth;var nearPoint=out.origin,farPoint=Picker._tempVector32;viewPort.unprojectFromWVP(nearSource,projectionMatrix,viewMatrix,world,nearPoint),viewPort.unprojectFromWVP(farSource,projectionMatrix,viewMatrix,world,farPoint);var outDire=out.direction.elements;outDire[0]=farPoint.x-nearPoint.x,outDire[1]=farPoint.y-nearPoint.y,outDire[2]=farPoint.z-nearPoint.z,Vector3.normalize(out.direction,out.direction)},Picker.rayIntersectsTriangle=function(ray,vertex1,vertex2,vertex3){var edge1=Picker._tempVector30,edge2=Picker._tempVector31;Vector3.subtract(vertex2,vertex1,edge1),Vector3.subtract(vertex3,vertex1,edge2);var determinant,directionCrossEdge2=Picker._tempVector32;if(Vector3.cross(ray.direction,edge2,directionCrossEdge2),(determinant=Vector3.dot(edge1,directionCrossEdge2))>-Number.MIN_VALUE&&determinant<Number.MIN_VALUE)return Number.NaN;var triangleU,inverseDeterminant=1/determinant,distanceVector=Picker._tempVector33;if(Vector3.subtract(ray.origin,vertex1,distanceVector),triangleU=Vector3.dot(distanceVector,directionCrossEdge2),(triangleU*=inverseDeterminant)<0||triangleU>1)return Number.NaN;var triangleV,rayDistance,distanceCrossEdge1=Picker._tempVector34;return Vector3.cross(distanceVector,edge1,distanceCrossEdge1),triangleV=Vector3.dot(ray.direction,distanceCrossEdge1),(triangleV*=inverseDeterminant)<0||triangleU+triangleV>1?Number.NaN:(rayDistance=Vector3.dot(edge2,distanceCrossEdge1),(rayDistance*=inverseDeterminant)<0?Number.NaN:rayDistance)},__static(Picker,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3}]),Picker}(),PhysicsSettings=function(){function PhysicsSettings(){this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60}return __class(PhysicsSettings,"laya.d3.physics.PhysicsSettings"),PhysicsSettings}(),SubShader=(function(){function OrientedBoundBox(extents,transformation){this.extents=null,this.transformation=null,this.extents=extents,this.transformation=transformation}__class(OrientedBoundBox,"laya.d3.math.OrientedBoundBox");var __proto=OrientedBoundBox.prototype;__proto.getCorners=function(corners){var xve=OrientedBoundBox._tempV30.elements,yve=OrientedBoundBox._tempV31.elements,zve=OrientedBoundBox._tempV32.elements,extentsE=this.extents.elements;xve[0]=extentsE[0],xve[1]=xve[2]=0,yve[1]=extentsE[1],yve[0]=yve[2]=0,zve[2]=extentsE[2],zve[0]=zve[1]=0,Vector3.TransformNormal(OrientedBoundBox._tempV30,this.transformation,OrientedBoundBox._tempV30),Vector3.TransformNormal(OrientedBoundBox._tempV31,this.transformation,OrientedBoundBox._tempV31),Vector3.TransformNormal(OrientedBoundBox._tempV32,this.transformation,OrientedBoundBox._tempV32);var center=OrientedBoundBox._tempV33;this.transformation.getTranslationVector(center),corners.length=8,Vector3.add(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[0]),Vector3.add(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[1]),Vector3.subtract(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[2]),Vector3.subtract(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[3]),Vector3.add(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[4]),Vector3.add(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[5]),Vector3.subtract(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[6]),Vector3.subtract(center,OrientedBoundBox._tempV30,OrientedBoundBox._tempV34),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV31,OrientedBoundBox._tempV34),Vector3.add(OrientedBoundBox._tempV34,OrientedBoundBox._tempV32,corners[7])},__proto.transform=function(mat){Matrix4x4.multiply(this.transformation,mat,this.transformation)},__proto.scale=function(scaling){Vector3.multiply(this.extents,scaling,this.extents)},__proto.translate=function(translation){this.transformation.getTranslationVector(OrientedBoundBox._tempV30),Vector3.add(OrientedBoundBox._tempV30,translation,OrientedBoundBox._tempV31),this.transformation.setTranslationVector(OrientedBoundBox._tempV31)},__proto.Size=function(out){Vector3.scale(this.extents,2,out)},__proto.getSize=function(out){var extentsE=this.extents.elements;OrientedBoundBox._tempV30.x=extentsE[0],OrientedBoundBox._tempV31.y=extentsE[1],OrientedBoundBox._tempV32.z=extentsE[2],Vector3.TransformNormal(OrientedBoundBox._tempV30,this.transformation,OrientedBoundBox._tempV30),Vector3.TransformNormal(OrientedBoundBox._tempV31,this.transformation,OrientedBoundBox._tempV31),Vector3.TransformNormal(OrientedBoundBox._tempV31,this.transformation,OrientedBoundBox._tempV32);var oe=out.elements;oe[0]=Vector3.scalarLength(OrientedBoundBox._tempV30),oe[1]=Vector3.scalarLength(OrientedBoundBox._tempV31),oe[2]=Vector3.scalarLength(OrientedBoundBox._tempV32)},__proto.getSizeSquared=function(out){var extentsE=this.extents.elements;OrientedBoundBox._tempV30.x=extentsE[0],OrientedBoundBox._tempV31.y=extentsE[1],OrientedBoundBox._tempV32.z=extentsE[2],Vector3.TransformNormal(OrientedBoundBox._tempV30,this.transformation,OrientedBoundBox._tempV30),Vector3.TransformNormal(OrientedBoundBox._tempV31,this.transformation,OrientedBoundBox._tempV31),Vector3.TransformNormal(OrientedBoundBox._tempV31,this.transformation,OrientedBoundBox._tempV32);var oe=out.elements;oe[0]=Vector3.scalarLengthSquared(OrientedBoundBox._tempV30),oe[1]=Vector3.scalarLengthSquared(OrientedBoundBox._tempV31),oe[2]=Vector3.scalarLengthSquared(OrientedBoundBox._tempV32)},__proto.getCenter=function(center){this.transformation.getTranslationVector(center)},__proto.containsPoint=function(point){var extentsE=this.extents.elements,extentsEX=extentsE[0],extentsEY=extentsE[1],extentsEZ=extentsE[2];this.transformation.invert(OrientedBoundBox._tempM0),Vector3.transformCoordinate(point,OrientedBoundBox._tempM0,OrientedBoundBox._tempV30);var _tempV30e=OrientedBoundBox._tempV30.elements,_tempV30ex=Math.abs(_tempV30e[0]),_tempV30ey=Math.abs(_tempV30e[1]),_tempV30ez=Math.abs(_tempV30e[2]);return MathUtils3D.nearEqual(_tempV30ex,extentsEX)&&MathUtils3D.nearEqual(_tempV30ey,extentsEY)&&MathUtils3D.nearEqual(_tempV30ez,extentsEZ)?2:_tempV30ex<extentsEX&&_tempV30ey<extentsEY&&_tempV30ez<extentsEZ?1:0},__proto.containsPoints=function(points){var extentse=this.extents.elements,extentsex=extentse[0],extentsey=extentse[1],extentsez=extentse[2];this.transformation.invert(OrientedBoundBox._tempM0);for(var containsAll=!0,containsAny=!1,i=0;i<points.length;i++){Vector3.transformCoordinate(points[i],OrientedBoundBox._tempM0,OrientedBoundBox._tempV30);var _tempV30e=OrientedBoundBox._tempV30.elements,_tempV30ex=Math.abs(_tempV30e[0]),_tempV30ey=Math.abs(_tempV30e[1]),_tempV30ez=Math.abs(_tempV30e[2]);MathUtils3D.nearEqual(_tempV30ex,extentsex)&&MathUtils3D.nearEqual(_tempV30ey,extentsey)&&MathUtils3D.nearEqual(_tempV30ez,extentsez)&&(containsAny=!0),_tempV30ex<extentsex&&_tempV30ey<extentsey&&_tempV30ez<extentsez?containsAny=!0:containsAll=!1}return containsAll?1:containsAny?2:0},__proto.containsSphere=function(sphere,ignoreScale){void 0===ignoreScale&&(ignoreScale=!1);var extentsE=this.extents.elements,extentsEX=extentsE[0],extentsEY=extentsE[1],extentsEZ=extentsE[2],sphereR=sphere.radius;this.transformation.invert(OrientedBoundBox._tempM0),Vector3.transformCoordinate(sphere.center,OrientedBoundBox._tempM0,OrientedBoundBox._tempV30);var locRadius=NaN;if(ignoreScale?locRadius=sphereR:(Vector3.scale(Vector3.UnitX,sphereR,OrientedBoundBox._tempV31),Vector3.TransformNormal(OrientedBoundBox._tempV31,OrientedBoundBox._tempM0,OrientedBoundBox._tempV31),locRadius=Vector3.scalarLength(OrientedBoundBox._tempV31)),Vector3.scale(this.extents,-1,OrientedBoundBox._tempV32),Vector3.Clamp(OrientedBoundBox._tempV30,OrientedBoundBox._tempV32,this.extents,OrientedBoundBox._tempV33),Vector3.distanceSquared(OrientedBoundBox._tempV30,OrientedBoundBox._tempV33)>locRadius*locRadius)return 0;var tempV30e=OrientedBoundBox._tempV30.elements,tempV30ex=tempV30e[0],tempV30ey=tempV30e[1],tempV30ez=tempV30e[2],tempV32e=OrientedBoundBox._tempV32.elements,tempV32ex=tempV32e[0],tempV32ey=tempV32e[1],tempV32ez=tempV32e[2];return tempV32ex+locRadius<=tempV30ex&&tempV30ex<=extentsEX-locRadius&&extentsEX-tempV32ex>locRadius&&tempV32ey+locRadius<=tempV30ey&&tempV30ey<=extentsEY-locRadius&&extentsEY-tempV32ey>locRadius&&tempV32ez+locRadius<=tempV30ez&&tempV30ez<=extentsEZ-locRadius&&extentsEZ-tempV32ez>locRadius?1:2},__proto.containsOrientedBoundBox=function(obb){var i=0,k=0;obb.getCorners(OrientedBoundBox._corners);var cornersCheck=this.containsPoints(OrientedBoundBox._corners);if(0!=cornersCheck)return cornersCheck;var sizeAe=this.extents.elements;obb.extents.cloneTo(OrientedBoundBox._tempV35);var sizeBe=OrientedBoundBox._tempV35.elements;OrientedBoundBox._getRows(this.transformation,OrientedBoundBox._rows1),OrientedBoundBox._getRows(obb.transformation,OrientedBoundBox._rows2);var extentA=NaN,extentB=NaN,dotNumber=NaN;for(i=0;i<4;i++)for(k=0;k<4;k++)3==i||3==k?(OrientedBoundBox._tempM0.setElementByRowColumn(i,k,0),OrientedBoundBox._tempM1.setElementByRowColumn(i,k,0)):(dotNumber=Vector3.dot(OrientedBoundBox._rows1[i],OrientedBoundBox._rows2[k]),OrientedBoundBox._tempM0.setElementByRowColumn(i,k,dotNumber),OrientedBoundBox._tempM1.setElementByRowColumn(i,k,Math.abs(dotNumber)));obb.getCenter(OrientedBoundBox._tempV34),this.getCenter(OrientedBoundBox._tempV36),Vector3.subtract(OrientedBoundBox._tempV34,OrientedBoundBox._tempV36,OrientedBoundBox._tempV30);var vsepAe=OrientedBoundBox._tempV31.elements;vsepAe[0]=Vector3.dot(OrientedBoundBox._tempV30,OrientedBoundBox._rows1[0]),vsepAe[1]=Vector3.dot(OrientedBoundBox._tempV30,OrientedBoundBox._rows1[1]),vsepAe[2]=Vector3.dot(OrientedBoundBox._tempV30,OrientedBoundBox._rows1[2]);var _tempV32e=OrientedBoundBox._tempV32.elements,_tempV33e=OrientedBoundBox._tempV33.elements;for(i=0;i<3;i++)if(_tempV32e[0]=OrientedBoundBox._tempM1.getElementByRowColumn(i,0),_tempV32e[1]=OrientedBoundBox._tempM1.getElementByRowColumn(i,1),_tempV32e[2]=OrientedBoundBox._tempM1.getElementByRowColumn(i,2),extentA=sizeAe[i],extentB=Vector3.dot(OrientedBoundBox._tempV35,OrientedBoundBox._tempV32),Math.abs(vsepAe[i])>extentA+extentB)return 0;for(k=0;k<3;k++)if(_tempV32e[0]=OrientedBoundBox._tempM1.getElementByRowColumn(0,k),_tempV32e[1]=OrientedBoundBox._tempM1.getElementByRowColumn(1,k),_tempV32e[2]=OrientedBoundBox._tempM1.getElementByRowColumn(2,k),_tempV33e[0]=OrientedBoundBox._tempM0.getElementByRowColumn(0,k),_tempV33e[1]=OrientedBoundBox._tempM0.getElementByRowColumn(1,k),_tempV33e[2]=OrientedBoundBox._tempM0.getElementByRowColumn(2,k),extentA=Vector3.dot(this.extents,OrientedBoundBox._tempV32),extentB=sizeBe[k],Math.abs(Vector3.dot(OrientedBoundBox._tempV31,OrientedBoundBox._tempV33))>extentA+extentB)return 0;for(i=0;i<3;i++)for(k=0;k<3;k++){var i1=(i+1)%3,i2=(i+2)%3,k1=(k+1)%3,k2=(k+2)%3;if(extentA=sizeAe[i1]*OrientedBoundBox._tempM1.getElementByRowColumn(i2,k)+sizeAe[i2]*OrientedBoundBox._tempM1.getElementByRowColumn(i1,k),extentB=sizeBe[k1]*OrientedBoundBox._tempM1.getElementByRowColumn(i,k2)+sizeBe[k2]*OrientedBoundBox._tempM1.getElementByRowColumn(i,k1),Math.abs(vsepAe[i2]*OrientedBoundBox._tempM0.getElementByRowColumn(i1,k)-vsepAe[i1]*OrientedBoundBox._tempM0.getElementByRowColumn(i2,k))>extentA+extentB)return 0}return 2},__proto.containsLine=function(point1,point2){OrientedBoundBox._corners[0]=point1,OrientedBoundBox._corners[1]=point2;var cornersCheck=this.containsPoints(OrientedBoundBox._corners);if(0!=cornersCheck)return cornersCheck;var extentsE=this.extents.elements,extentsX=extentsE[0],extentsY=extentsE[1],extentsZ=extentsE[2];this.transformation.invert(OrientedBoundBox._tempM0),Vector3.transformCoordinate(point1,OrientedBoundBox._tempM0,OrientedBoundBox._tempV30),Vector3.transformCoordinate(point2,OrientedBoundBox._tempM0,OrientedBoundBox._tempV31),Vector3.add(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV32),Vector3.scale(OrientedBoundBox._tempV32,.5,OrientedBoundBox._tempV32),Vector3.subtract(OrientedBoundBox._tempV30,OrientedBoundBox._tempV32,OrientedBoundBox._tempV33);var _tempV33e=OrientedBoundBox._tempV33.elements,_tempV33X=_tempV33e[0],_tempV33Y=_tempV33e[1],_tempV33Z=_tempV33e[2],_tempV34e=OrientedBoundBox._tempV34.elements,_tempV34X=_tempV34e[0]=Math.abs(_tempV33e[0]),_tempV34Y=_tempV34e[1]=Math.abs(_tempV33e[1]),_tempV34Z=_tempV34e[2]=Math.abs(_tempV33e[2]),_tempV32e=OrientedBoundBox._tempV32.elements,_tempV32X=_tempV32e[0],_tempV32Y=_tempV32e[1],_tempV32Z=_tempV32e[2];return Math.abs(_tempV32X)>extentsX+_tempV34X?0:Math.abs(_tempV32Y)>extentsY+_tempV34Y?0:Math.abs(_tempV32Z)>extentsZ+_tempV34Z?0:Math.abs(_tempV32Y*_tempV33Z-_tempV32Z*_tempV33Y)>extentsY*_tempV34Z+extentsZ*_tempV34Y?0:Math.abs(_tempV32X*_tempV33Z-_tempV32Z*_tempV33X)>extentsX*_tempV34Z+extentsZ*_tempV34X?0:Math.abs(_tempV32X*_tempV33Y-_tempV32Y*_tempV33X)>extentsX*_tempV34Y+extentsY*_tempV34X?0:2},__proto.containsBoundBox=function(box){var i=0,k=0,min=box.min,max=box.max;box.getCorners(OrientedBoundBox._corners);var cornersCheck=this.containsPoints(OrientedBoundBox._corners);if(0!=cornersCheck)return cornersCheck;Vector3.subtract(max,min,OrientedBoundBox._tempV30),Vector3.scale(OrientedBoundBox._tempV30,.5,OrientedBoundBox._tempV30),Vector3.add(min,OrientedBoundBox._tempV30,OrientedBoundBox._tempV30),Vector3.subtract(max,OrientedBoundBox._tempV30,OrientedBoundBox._tempV31);var sizeAe=this.extents.elements,sizeBe=OrientedBoundBox._tempV31.elements;OrientedBoundBox._getRows(this.transformation,OrientedBoundBox._rows1),this.transformation.invert(OrientedBoundBox._tempM0);var extentA=NaN,extentB=NaN;for(i=0;i<3;i++)for(k=0;k<3;k++)OrientedBoundBox._tempM1.setElementByRowColumn(i,k,Math.abs(OrientedBoundBox._tempM0.getElementByRowColumn(i,k)));this.getCenter(OrientedBoundBox._tempV35),Vector3.subtract(OrientedBoundBox._tempV30,OrientedBoundBox._tempV35,OrientedBoundBox._tempV32);var vsepAe=OrientedBoundBox._tempV31.elements;vsepAe[0]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[0]),vsepAe[1]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[1]),vsepAe[2]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[2]);var _tempV33e=OrientedBoundBox._tempV33.elements,_tempV34e=OrientedBoundBox._tempV34.elements;for(i=0;i<3;i++)if(_tempV33e[0]=OrientedBoundBox._tempM1.getElementByRowColumn(i,0),_tempV33e[1]=OrientedBoundBox._tempM1.getElementByRowColumn(i,1),_tempV33e[2]=OrientedBoundBox._tempM1.getElementByRowColumn(i,2),extentA=sizeAe[i],extentB=Vector3.dot(OrientedBoundBox._tempV31,OrientedBoundBox._tempV33),Math.abs(vsepAe[i])>extentA+extentB)return 0;for(k=0;k<3;k++)if(_tempV33e[0]=OrientedBoundBox._tempM1.getElementByRowColumn(0,k),_tempV33e[1]=OrientedBoundBox._tempM1.getElementByRowColumn(1,k),_tempV33e[2]=OrientedBoundBox._tempM1.getElementByRowColumn(2,k),_tempV34e[0]=OrientedBoundBox._tempM0.getElementByRowColumn(0,k),_tempV34e[1]=OrientedBoundBox._tempM0.getElementByRowColumn(1,k),_tempV34e[2]=OrientedBoundBox._tempM0.getElementByRowColumn(2,k),extentA=Vector3.dot(this.extents,OrientedBoundBox._tempV33),extentB=sizeBe[k],Math.abs(Vector3.dot(OrientedBoundBox._tempV31,OrientedBoundBox._tempV34))>extentA+extentB)return 0;for(i=0;i<3;i++)for(k=0;k<3;k++){var i1=(i+1)%3,i2=(i+2)%3,k1=(k+1)%3,k2=(k+2)%3;if(extentA=sizeAe[i1]*OrientedBoundBox._tempM1.getElementByRowColumn(i2,k)+sizeAe[i2]*OrientedBoundBox._tempM1.getElementByRowColumn(i1,k),extentB=sizeBe[k1]*OrientedBoundBox._tempM1.getElementByRowColumn(i,k2)+sizeBe[k2]*OrientedBoundBox._tempM1.getElementByRowColumn(i,k1),Math.abs(vsepAe[i2]*OrientedBoundBox._tempM0.getElementByRowColumn(i1,k)-vsepAe[i1]*OrientedBoundBox._tempM0.getElementByRowColumn(i2,k))>extentA+extentB)return 0}return 2},__proto.intersectsRay=function(ray,out){Vector3.scale(this.extents,-1,OrientedBoundBox._tempV30),this.transformation.invert(OrientedBoundBox._tempM0),Vector3.TransformNormal(ray.direction,OrientedBoundBox._tempM0,OrientedBoundBox._ray.direction),Vector3.transformCoordinate(ray.origin,OrientedBoundBox._tempM0,OrientedBoundBox._ray.origin),OrientedBoundBox._boxBound1.min=OrientedBoundBox._tempV30,OrientedBoundBox._boxBound1.max=this.extents;var intersects=CollisionUtils.intersectsRayAndBoxRP(OrientedBoundBox._ray,OrientedBoundBox._boxBound1,out);return-1!==intersects&&Vector3.transformCoordinate(out,this.transformation,out),intersects},__proto._getLocalCorners=function(corners){corners.length=8;var extentsE=this.extents.elements;OrientedBoundBox._tempV30.x=extentsE[0],OrientedBoundBox._tempV31.y=extentsE[1],OrientedBoundBox._tempV32.z=extentsE[2],Vector3.add(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV33),Vector3.add(OrientedBoundBox._tempV33,OrientedBoundBox._tempV32,corners[0]),Vector3.add(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV33),Vector3.subtract(OrientedBoundBox._tempV33,OrientedBoundBox._tempV32,corners[1]),Vector3.subtract(OrientedBoundBox._tempV31,OrientedBoundBox._tempV30,OrientedBoundBox._tempV33),Vector3.subtract(OrientedBoundBox._tempV33,OrientedBoundBox._tempV30,corners[2]),Vector3.subtract(OrientedBoundBox._tempV31,OrientedBoundBox._tempV30,OrientedBoundBox._tempV33),Vector3.add(OrientedBoundBox._tempV33,OrientedBoundBox._tempV32,corners[3]),Vector3.subtract(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV33),Vector3.add(OrientedBoundBox._tempV33,OrientedBoundBox._tempV32,corners[4]),Vector3.subtract(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV33),Vector3.subtract(OrientedBoundBox._tempV33,OrientedBoundBox._tempV32,corners[5]),Vector3.scale(corners[0],-1,corners[6]),Vector3.subtract(OrientedBoundBox._tempV32,OrientedBoundBox._tempV30,OrientedBoundBox._tempV33),Vector3.subtract(OrientedBoundBox._tempV33,OrientedBoundBox._tempV31,corners[7])},__proto.equals=function(obb){return this.extents==obb.extents&&this.transformation==obb.transformation},__proto.cloneTo=function(destObject){var dest=destObject;this.extents.cloneTo(dest.extents),this.transformation.cloneTo(dest.transformation)},OrientedBoundBox.createByBoundBox=function(box,out){var min=box.min,max=box.max;Vector3.subtract(max,min,OrientedBoundBox._tempV30),Vector3.scale(OrientedBoundBox._tempV30,.5,OrientedBoundBox._tempV30),Vector3.add(min,OrientedBoundBox._tempV30,OrientedBoundBox._tempV31),Vector3.subtract(max,OrientedBoundBox._tempV31,OrientedBoundBox._tempV32),Matrix4x4.translation(OrientedBoundBox._tempV31,OrientedBoundBox._tempM0);var extents=OrientedBoundBox._tempV32.clone(),transformation=OrientedBoundBox._tempM0.clone();out.extents=extents,out.transformation=transformation},OrientedBoundBox.createByMinAndMaxVertex=function(min,max){return Vector3.subtract(max,min,OrientedBoundBox._tempV30),Vector3.scale(OrientedBoundBox._tempV30,.5,OrientedBoundBox._tempV30),Vector3.add(min,OrientedBoundBox._tempV30,OrientedBoundBox._tempV31),Vector3.subtract(max,OrientedBoundBox._tempV31,OrientedBoundBox._tempV32),Matrix4x4.translation(OrientedBoundBox._tempV31,OrientedBoundBox._tempM0),new OrientedBoundBox(OrientedBoundBox._tempV32,OrientedBoundBox._tempM0)},OrientedBoundBox._getRows=function(mat,out){out.length=3;var mate=mat.elements,row0e=out[0].elements;row0e[0]=mate[0],row0e[1]=mate[1],row0e[2]=mate[2];var row1e=out[1].elements;row1e[0]=mate[4],row1e[1]=mate[5],row1e[2]=mate[6];var row2e=out[2].elements;row2e[0]=mate[8],row2e[1]=mate[9],row2e[2]=mate[10]},OrientedBoundBox.getObbtoObbMatrix4x4=function(a,b,noMatrixScaleApplied,out){var at=a.transformation,bt=b.transformation;if(noMatrixScaleApplied){OrientedBoundBox._getRows(at,OrientedBoundBox._rows1),OrientedBoundBox._getRows(bt,OrientedBoundBox._rows2);for(var i=0;i<3;i++)for(var k=0;k<3;k++)out.setElementByRowColumn(i,k,Vector3.dot(OrientedBoundBox._rows2[i],OrientedBoundBox._rows1[k]));b.getCenter(OrientedBoundBox._tempV30),a.getCenter(OrientedBoundBox._tempV31),Vector3.subtract(OrientedBoundBox._tempV30,OrientedBoundBox._tempV31,OrientedBoundBox._tempV32);var AtoBMe=out.elements;AtoBMe[12]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[0]),AtoBMe[13]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[1]),AtoBMe[14]=Vector3.dot(OrientedBoundBox._tempV32,OrientedBoundBox._rows1[2]),AtoBMe[15]=1}else at.invert(OrientedBoundBox._tempM0),Matrix4x4.multiply(bt,OrientedBoundBox._tempM0,out)},OrientedBoundBox.merge=function(a,b,noMatrixScaleApplied){var ae=a.extents,at=a.transformation;OrientedBoundBox.getObbtoObbMatrix4x4(a,b,noMatrixScaleApplied,OrientedBoundBox._tempM0),b._getLocalCorners(OrientedBoundBox._corners),Vector3.transformCoordinate(OrientedBoundBox._corners[0],OrientedBoundBox._tempM0,OrientedBoundBox._corners[0]),Vector3.transformCoordinate(OrientedBoundBox._corners[1],OrientedBoundBox._tempM0,OrientedBoundBox._corners[1]),Vector3.transformCoordinate(OrientedBoundBox._corners[2],OrientedBoundBox._tempM0,OrientedBoundBox._corners[2]),Vector3.transformCoordinate(OrientedBoundBox._corners[3],OrientedBoundBox._tempM0,OrientedBoundBox._corners[3]),Vector3.transformCoordinate(OrientedBoundBox._corners[4],OrientedBoundBox._tempM0,OrientedBoundBox._corners[4]),Vector3.transformCoordinate(OrientedBoundBox._corners[5],OrientedBoundBox._tempM0,OrientedBoundBox._corners[5]),Vector3.transformCoordinate(OrientedBoundBox._corners[6],OrientedBoundBox._tempM0,OrientedBoundBox._corners[6]),Vector3.transformCoordinate(OrientedBoundBox._corners[7],OrientedBoundBox._tempM0,OrientedBoundBox._corners[7]),Vector3.scale(ae,-1,OrientedBoundBox._boxBound1.min),ae.cloneTo(OrientedBoundBox._boxBound1.max),BoundBox.createfromPoints(OrientedBoundBox._corners,OrientedBoundBox._boxBound2),BoundBox.merge(OrientedBoundBox._boxBound2,OrientedBoundBox._boxBound1,OrientedBoundBox._boxBound3);var box3Min=OrientedBoundBox._boxBound3.min,box3Max=OrientedBoundBox._boxBound3.max;Vector3.subtract(box3Max,box3Min,OrientedBoundBox._tempV30),Vector3.scale(OrientedBoundBox._tempV30,.5,OrientedBoundBox._tempV30),Vector3.add(box3Min,OrientedBoundBox._tempV30,OrientedBoundBox._tempV32),Vector3.subtract(box3Max,OrientedBoundBox._tempV32,ae),Vector3.transformCoordinate(OrientedBoundBox._tempV32,at,OrientedBoundBox._tempV33)},__static(OrientedBoundBox,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempM0",function(){return this._tempM0=new Matrix4x4},"_tempM1",function(){return this._tempM1=new Matrix4x4},"_corners",function(){return this._corners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_rows1",function(){return this._rows1=[new Vector3,new Vector3,new Vector3]},"_rows2",function(){return this._rows2=[new Vector3,new Vector3,new Vector3]},"_ray",function(){return this._ray=new Ray(new Vector3,new Vector3)},"_boxBound1",function(){return this._boxBound1=new BoundBox(new Vector3,new Vector3)},"_boxBound2",function(){return this._boxBound2=new BoundBox(new Vector3,new Vector3)},"_boxBound3",function(){return this._boxBound3=new BoundBox(new Vector3,new Vector3)}])}(),function(){function SubShader(attributeMap,uniformMap,spriteDefines,materialDefines){this._attributeMap=null,this._uniformMap=null,this._publicDefines=null,this._publicDefinesMap=null,this._spriteDefines=null,this._spriteDefinesMap=null,this._materialDefines=null,this._materialDefinesMap=null,this._owner=null,this._flags={},this._passes=[],this._publicDefines=[],this._publicDefinesMap={},this._spriteDefines=[],this._spriteDefinesMap={},this._materialDefines=[],this._materialDefinesMap={},this._addDefines(this._publicDefines,this._publicDefinesMap,Shader3D._globleDefines),spriteDefines&&this._addDefines(this._spriteDefines,this._spriteDefinesMap,spriteDefines.defines),materialDefines&&this._addDefines(this._materialDefines,this._materialDefinesMap,materialDefines.defines),this._attributeMap=attributeMap,this._uniformMap=uniformMap}__class(SubShader,"laya.d3.shader.SubShader");var __proto=SubShader.prototype;return __proto._addDefines=function(defines,definesMap,supportDefines){for(var k in supportDefines){var name=supportDefines[k],i=parseInt(k);defines[i]=name,definesMap[name]=i}},__proto.getMaterialDefineByName=function(name){return this._materialDefinesMap[name]},__proto.setFlag=function(key,value){value?this._flags[key]=value:delete this._flags[key]},__proto.getFlag=function(key){return this._flags[key]},__proto.addShaderPass=function(vs,ps){this._passes.push(new ShaderPass(this,vs,ps))},SubShader}()),Physics3DUtils=function(){function Physics3DUtils(){}return __class(Physics3DUtils,"laya.d3.utils.Physics3DUtils"),Physics3DUtils.setColliderCollision=function(collider1,collider2,collsion){},Physics3DUtils.getIColliderCollision=function(collider1,collider2){return!1},Physics3DUtils.COLLISIONFILTERGROUP_DEFAULTFILTER=1,Physics3DUtils.COLLISIONFILTERGROUP_STATICFILTER=2,Physics3DUtils.COLLISIONFILTERGROUP_KINEMATICFILTER=4,Physics3DUtils.COLLISIONFILTERGROUP_DEBRISFILTER=8,Physics3DUtils.COLLISIONFILTERGROUP_SENSORTRIGGER=16,Physics3DUtils.COLLISIONFILTERGROUP_CHARACTERFILTER=32,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,Physics3DUtils.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER=-1,__static(Physics3DUtils,["gravity",function(){return this.gravity=new Vector3(0,-9.81,0)}]),Physics3DUtils}(),Input3D=function(){function Input3D(){this._scene=null,this._eventList=[],this._multiTouchEnabled=!0,this._mouseTouch=new MouseTouch,this._touchPool=[],this._touches=new SimpleSingletonList}__class(Input3D,"laya.d3.Input3D");var __proto=Input3D.prototype;return __proto.__init__=function(canvas,scene){this._scene=scene;var list=this._eventList;canvas.oncontextmenu=function(e){return!1},canvas.addEventListener("mousedown",function(e){e.preventDefault(),list.push(e)}),canvas.addEventListener("mouseup",function(e){e.preventDefault(),list.push(e)},!0),canvas.addEventListener("mousemove",function(e){e.preventDefault(),list.push(e)},!0),canvas.addEventListener("touchstart",function(e){e.preventDefault(),list.push(e)}),canvas.addEventListener("touchend",function(e){e.preventDefault(),list.push(e)},!0),canvas.addEventListener("touchmove",function(e){e.preventDefault(),list.push(e)},!0),canvas.addEventListener("touchcancel",function(e){list.push(e)},!0)},__proto.touchCount=function(){return this._touches.length},__proto._getTouch=function(touchID){var touch=this._touchPool[touchID];return touch||(touch=new Touch,this._touchPool[touchID]=touch,touch._identifier=touchID),touch},__proto._mouseTouchDown=function(){var touch=this._mouseTouch,sprite=touch.sprite;if(touch._pressedSprite=sprite,touch._pressedLoopCount=Stat.loopCount,sprite){var scripts=sprite._scripts;if(scripts)for(var i=0,n=scripts.length;i<n;i++)scripts[i].onMouseDown()}},__proto._mouseTouchUp=function(){var i=0,n=0,touch=this._mouseTouch,lastPressedSprite=touch._pressedSprite;touch._pressedSprite=null,touch._pressedLoopCount=-1;var sprite=touch.sprite;if(sprite&&sprite===lastPressedSprite){var scripts=sprite._scripts;if(scripts)for(i=0,n=scripts.length;i<n;i++)scripts[i].onMouseClick()}if(lastPressedSprite){var lastScripts=lastPressedSprite._scripts;if(lastScripts)for(i=0,n=lastScripts.length;i<n;i++)lastScripts[i].onMouseUp()}},__proto._mouseTouchRayCast=function(cameras){var touchHitResult=Input3D._tempHitResult0,touchPos=Input3D._tempVector20,touchRay=Input3D._tempRay0;touchHitResult.succeeded=!1;var x=this._mouseTouch.mousePositionX,y=this._mouseTouch.mousePositionY,touchPosE=touchPos.elements;touchPosE[0]=x,touchPosE[1]=y;for(var i=cameras.length-1;i>=0;i--){var camera=cameras[i],viewport=camera.viewport;if(touchPos.x>=viewport.x&&touchPos.y>=viewport.y&&touchPos.x<=viewport.width&&touchPos.y<=viewport.height)if(camera.viewportPointToRay(touchPos,touchRay),this._scene._physicsSimulation.rayCast(touchRay,touchHitResult)||0===camera.clearFlag||1===camera.clearFlag)break}var touch=this._mouseTouch,lastSprite=touch.sprite;if(touchHitResult.succeeded){var touchSprite=touchHitResult.collider.owner;touch.sprite=touchSprite;var scripts=touchSprite._scripts;if(lastSprite!==touchSprite&&scripts)for(var j=0,m=scripts.length;j<m;j++)scripts[j].onMouseEnter()}else touch.sprite=null;if(lastSprite&&lastSprite!==touchSprite){var outScripts=lastSprite._scripts;if(outScripts)for(j=0,m=outScripts.length;j<m;j++)outScripts[j].onMouseOut()}},__proto._changeTouches=function(changedTouches,flag){for(var offsetX=0,offsetY=0,lastCount=this._touches.length,j=0,m=changedTouches.length;j<m;j++){var nativeTouch=changedTouches[j],identifier=nativeTouch.identifier;if(this._multiTouchEnabled||0===identifier){var touch=this._getTouch(identifier),posE=touch._position.elements,mousePoint=Input3D._tempPoint;mousePoint.setTo(nativeTouch.pageX,nativeTouch.pageY),Laya.stage._canvasTransform.invertTransformPoint(mousePoint);var posX=mousePoint.x,posY=mousePoint.y;switch(flag){case 0:this._touches.add(touch),offsetX+=posX,offsetY+=posY;break;case 1:this._touches.remove(touch),offsetX-=posX,offsetY-=posY;break;case 2:offsetX=posX-posE[0],offsetY=posY-posE[1]}posE[0]=posX,posE[1]=posY}}var touchCount=this._touches.length;0===touchCount?(this._mouseTouch.mousePositionX=0,this._mouseTouch.mousePositionY=0):(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*lastCount+offsetX)/touchCount,this._mouseTouch.mousePositionY=(this._mouseTouch.mousePositionY*lastCount+offsetY)/touchCount)},__proto._update=function(){var n,i=0,j=0,m=0;n=this._eventList.length;var cameras=this._scene._cameraPool;if(n>0){for(i=0;i<n;i++){var e=this._eventList[i];switch(e.type){case"mousedown":this._mouseTouchDown();break;case"mouseup":this._mouseTouchUp();break;case"mousemove":var mousePoint=Input3D._tempPoint;mousePoint.setTo(e.pageX,e.pageY),Laya.stage._canvasTransform.invertTransformPoint(mousePoint),this._mouseTouch.mousePositionX=mousePoint.x,this._mouseTouch.mousePositionY=mousePoint.y,this._mouseTouchRayCast(cameras);break;case"touchstart":var lastLength=this._touches.length;this._changeTouches(e.changedTouches,0),this._mouseTouchRayCast(cameras),0===lastLength&&this._mouseTouchDown();break;case"touchend":case"touchcancel":this._changeTouches(e.changedTouches,1),0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(e.changedTouches,2),this._mouseTouchRayCast(cameras);break;default:throw"Input3D:unkonwn event type."}}this._eventList.length=0}var mouseTouch=this._mouseTouch,pressedSprite=mouseTouch._pressedSprite;if(pressedSprite&&Stat.loopCount>mouseTouch._pressedLoopCount){var pressedScripts=pressedSprite._scripts;if(pressedScripts)for(j=0,m=pressedScripts.length;j<m;j++)pressedScripts[j].onMouseDrag()}var touchSprite=mouseTouch.sprite;if(touchSprite){var scripts=touchSprite._scripts;if(scripts)for(j=0,m=scripts.length;j<m;j++)scripts[j].onMouseOver()}},__proto.getTouch=function(index){return index<this._touches.length?this._touches.elements[index]:null},__getset(0,__proto,"multiTouchEnabled",function(){return this._multiTouchEnabled},function(value){this._multiTouchEnabled=value}),__static(Input3D,["_tempPoint",function(){return this._tempPoint=new Point},"_tempVector20",function(){return this._tempVector20=new Vector2},"_tempRay0",function(){return this._tempRay0=new Ray(new Vector3,new Vector3)},"_tempHitResult0",function(){return this._tempHitResult0=new HitResult}]),Input3D}(),Gradient=function(){function Gradient(maxColorRGBKeyCount,maxColorAlphaKeyCount){this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=maxColorRGBKeyCount,this._maxColorAlphaKeysCount=maxColorAlphaKeyCount,this._rgbElements=new Float32Array(4*maxColorRGBKeyCount),this._alphaElements=new Float32Array(2*maxColorAlphaKeyCount)}__class(Gradient,"laya.d3.core.Gradient");var __proto=Gradient.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.addColorRGB=function(key,value){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var offset=4*this._colorRGBKeysCount;this._rgbElements[offset]=key,this._rgbElements[offset+1]=value.r,this._rgbElements[offset+2]=value.g,this._rgbElements[offset+3]=value.b,this._colorRGBKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount)},__proto.addColorAlpha=function(key,value){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var offset=2*this._colorAlphaKeysCount;this._alphaElements[offset]=key,this._alphaElements[offset+1]=value,this._colorAlphaKeysCount++}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount)},__proto.updateColorRGB=function(index,key,value){if(index<this._colorRGBKeysCount){var offset=4*index;this._rgbElements[offset]=key,this._rgbElements[offset+1]=value.r,this._rgbElements[offset+2]=value.g,this._rgbElements[offset+3]=value.b}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount)},__proto.updateColorAlpha=function(index,key,value){if(index<this._colorAlphaKeysCount){var offset=2*index;this._alphaElements[offset]=key,this._alphaElements[offset+1]=value}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount)},__proto.cloneTo=function(destObject){var destGradientDataColor=destObject,i=0,n=0;destGradientDataColor._colorAlphaKeysCount=this._colorAlphaKeysCount;var destAlphaElements=destGradientDataColor._alphaElements;for(destAlphaElements.length=this._alphaElements.length,i=0,n=this._alphaElements.length;i<n;i++)destAlphaElements[i]=this._alphaElements[i];destGradientDataColor._colorRGBKeysCount=this._colorRGBKeysCount;var destRGBElements=destGradientDataColor._rgbElements;for(destRGBElements.length=this._rgbElements.length,i=0,n=this._rgbElements.length;i<n;i++)destRGBElements[i]=this._rgbElements[i]},__proto.clone=function(){var destGradientDataColor=new Gradient(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(destGradientDataColor),destGradientDataColor},__getset(0,__proto,"colorRGBKeysCount",function(){return this._colorRGBKeysCount/4}),__getset(0,__proto,"mode",function(){return this._mode},function(value){this._mode=value}),__getset(0,__proto,"colorAlphaKeysCount",function(){return this._colorAlphaKeysCount/2}),__getset(0,__proto,"maxColorRGBKeysCount",function(){return this._maxColorRGBKeysCount}),__getset(0,__proto,"maxColorAlphaKeysCount",function(){return this._maxColorAlphaKeysCount}),Gradient}(),SkyMesh=function(){function SkyMesh(){this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null}return __class(SkyMesh,"laya.d3.resource.models.SkyMesh"),SkyMesh.prototype._render=function(state){},SkyMesh}(),Collision=function(){function Collision(){this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[]}return __class(Collision,"laya.d3.physics.Collision"),Collision.prototype._setUpdateFrame=function(farme){this._lastUpdateFrame=this._updateFrame,this._updateFrame=farme},Collision}(),KeyframeNodeOwner=function(){function KeyframeNodeOwner(){this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.crossFixedValue=null}return __class(KeyframeNodeOwner,"laya.d3.component.KeyframeNodeOwner"),KeyframeNodeOwner.prototype.saveCrossFixedValue=function(){var pro=this.propertyOwner;if(pro)switch(this.type){case 0:for(var proPat=this.property,m=proPat.length-1,j=0;j<m&&(pro=pro[proPat[j]]);j++);this.crossFixedValue=pro[proPat[m]];break;case 1:var locPosE=pro.localPosition.elements;this.crossFixedValue||(this.crossFixedValue=new Float32Array(3)),this.crossFixedValue[0]=locPosE[0],this.crossFixedValue[1]=locPosE[1],this.crossFixedValue[2]=locPosE[2];break;case 2:var locRotE=pro.localRotation.elements;this.crossFixedValue||(this.crossFixedValue=new Float32Array(4)),this.crossFixedValue[0]=locRotE[0],this.crossFixedValue[1]=locRotE[1],this.crossFixedValue[2]=locRotE[2],this.crossFixedValue[3]=locRotE[3];break;case 3:var locScaE=pro.localScale.elements;this.crossFixedValue||(this.crossFixedValue=new Float32Array(3)),this.crossFixedValue[0]=locScaE[0],this.crossFixedValue[1]=locScaE[1],this.crossFixedValue[2]=locScaE[2];break;case 4:var locEulE=pro.localRotationEuler.elements;this.crossFixedValue||(this.crossFixedValue=new Float32Array(3)),this.crossFixedValue[0]=locEulE[0],this.crossFixedValue[1]=locEulE[1],this.crossFixedValue[2]=locEulE[2];break;default:throw"Animator:unknown type."}},KeyframeNodeOwner}(),HitResult=(function(){function SceneManager(){}__class(SceneManager,"laya.d3.core.scene.SceneManager")}(),function(){function HitResult(){this.succeeded=!1,this.collider=null,this.hitFraction=0,this.point=new Vector3,this.normal=new Vector3}return __class(HitResult,"laya.d3.physics.HitResult"),HitResult}()),GradientDataInt=function(){function GradientDataInt(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(GradientDataInt,"laya.d3.core.particleShuriKen.module.GradientDataInt");var __proto=GradientDataInt.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.add=function(key,value){this._currentLength<8?(6===this._currentLength&&1!==key&&(key=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=key,this._elements[this._currentLength++]=value):console.log("Warning:data count must lessEqual than 4")},__proto.cloneTo=function(destObject){var destGradientDataInt=destObject;destGradientDataInt._currentLength=this._currentLength;var destElements=destGradientDataInt._elements;destElements.length=this._elements.length;for(var i=0,n=this._elements.length;i<n;i++)destElements[i]=this._elements[i]},__proto.clone=function(){var destGradientDataInt=new this.constructor;return this.cloneTo(destGradientDataInt),destGradientDataInt},__getset(0,__proto,"gradientCount",function(){return this._currentLength/2}),GradientDataInt}(),VertexElement=function(){function VertexElement(offset,elementFormat,elementUsage){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=offset,this.elementFormat=elementFormat,this.elementUsage=elementUsage}return __class(VertexElement,"laya.d3.graphics.VertexElement"),VertexElement}(),AnimatorControllerLayer=function(){function AnimatorControllerLayer(name){this._statesMap={},this.playOnWake=!0,this._playType=-1,this._crossMark=0,this._crossDuration=-1,this._crossNodesOwnersIndicesMap={},this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._defaultState=null,this._currentPlayState=null,this._states=[],this._playStateInfo=new AnimatorPlayState,this._crossPlayStateInfo=new AnimatorPlayState,this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.name=name,this.defaultWeight=1,this.blendingMode=laya.d3.component.AnimatorControllerLayer.BLENDINGMODE_OVERRIDE}__class(AnimatorControllerLayer,"laya.d3.component.AnimatorControllerLayer");var __proto=AnimatorControllerLayer.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.getAnimatorState=function(name){var state=this._statesMap[name];return state||null},__proto.destroy=function(){this._statesMap=null,this._states=null,this._playStateInfo=null,this._crossPlayStateInfo=null},__proto.cloneTo=function(destObject){var dest=destObject;dest.name=this.name,dest.blendingMode=this.blendingMode,dest.defaultWeight=this.defaultWeight,dest.playOnWake=this.playOnWake},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},AnimatorControllerLayer.BLENDINGMODE_OVERRIDE=0,AnimatorControllerLayer.BLENDINGMODE_ADDTIVE=1,AnimatorControllerLayer}(),GradientDataNumber=function(){function GradientDataNumber(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}__class(GradientDataNumber,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var __proto=GradientDataNumber.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.add=function(key,value){this._currentLength<8?(6===this._currentLength&&1!==key&&(key=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=key,this._elements[this._currentLength++]=value):console.log("GradientDataNumber warning:data count must lessEqual than 4")},__proto.getKeyByIndex=function(index){return this._elements[2*index]},__proto.getValueByIndex=function(index){return this._elements[2*index+1]},__proto.getAverageValue=function(){for(var i=0,n=this._currentLength-2;i<n;i+=2){this._elements[i+1];this._elements[i+3],this._elements[i+2]-this._elements[i]}return 0},__proto.cloneTo=function(destObject){var destGradientDataNumber=destObject;destGradientDataNumber._currentLength=this._currentLength;var destElements=destGradientDataNumber._elements;destElements.length=this._elements.length;for(var i=0,n=this._elements.length;i<n;i++)destElements[i]=this._elements[i]},__proto.clone=function(){var destGradientDataNumber=new this.constructor;return this.cloneTo(destGradientDataNumber),destGradientDataNumber},__getset(0,__proto,"gradientCount",function(){return this._currentLength/2}),GradientDataNumber}(),Emission=function(){function Emission(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}__class(Emission,"laya.d3.core.particleShuriKen.module.Emission");var __proto=Emission.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),__proto.destroy=function(){this._bursts=null,this._destroyed=!0},__proto.getBurstsCount=function(){return this._bursts.length},__proto.getBurstByIndex=function(index){return this._bursts[index]},__proto.addBurst=function(burst){var burstsCount=this._bursts.length;if(burstsCount>0)for(var i=0;i<burstsCount;i++)this._bursts[i].time>burst.time&&this._bursts.splice(i,0,burst);this._bursts.push(burst)},__proto.removeBurst=function(burst){var index=this._bursts.indexOf(burst);-1!==index&&this._bursts.splice(index,1)},__proto.removeBurstByIndex=function(index){this._bursts.splice(index,1)},__proto.clearBurst=function(){this._bursts.length=0},__proto.cloneTo=function(destObject){var destEmission=destObject,destBursts=destEmission._bursts;destBursts.length=this._bursts.length;for(var i=0,n=this._bursts.length;i<n;i++){var destBurst=destBursts[i];destBurst?this._bursts[i].cloneTo(destBurst):destBursts[i]=this._bursts[i].clone()}destEmission._emissionRate=this._emissionRate,destEmission.enbale=this.enbale},__proto.clone=function(){var destEmission=new this.constructor;return this.cloneTo(destEmission),destEmission},__getset(0,__proto,"destroyed",function(){return this._destroyed}),__getset(0,__proto,"emissionRate",function(){return this._emissionRate},function(value){if(value<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=value}),Emission}(),Config3D=function(){function Config3D(){this._defaultPhysicsMemory=16,this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0}__class(Config3D,"Config3D");var __proto=Config3D.prototype;return __getset(0,__proto,"defaultPhysicsMemory",function(){return this._defaultPhysicsMemory},function(value){if(value<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=value}),__static(Config3D,["_defaultConfig",function(){return this._defaultConfig=new Config3D}]),Config3D}(),ContactPoint=function(){function ContactPoint(){this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new Vector3,this.positionOnA=new Vector3,this.positionOnB=new Vector3,this._id=++this._idCounter}return __class(ContactPoint,"laya.d3.physics.ContactPoint"),ContactPoint}(),Quaternion=(function(){function AnimatorStateScript(){}__class(AnimatorStateScript,"laya.d3.animation.AnimatorStateScript");var __proto=AnimatorStateScript.prototype;__proto.onStateEnter=function(){},__proto.onStateUpdate=function(){},__proto.onStateExit=function(){}}(),function(){function Quaternion(x,y,z,w,nativeElements){var v;void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),void 0===w&&(w=1),(v=nativeElements||new Float32Array(4))[0]=x,v[1]=y,v[2]=z,v[3]=w,this.elements=v}__class(Quaternion,"laya.d3.math.Quaternion");var __proto=Quaternion.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.scaling=function(scaling,out){var e=out.elements,f=this.elements;e[0]=f[0]*scaling,e[1]=f[1]*scaling,e[2]=f[2]*scaling,e[3]=f[3]*scaling},__proto.normalize=function(out){Quaternion._normalizeArray(this.elements,out.elements)},__proto.length=function(){var f=this.elements,x=f[0],y=f[1],z=f[2],w=f[3];return Math.sqrt(x*x+y*y+z*z+w*w)},__proto.rotateX=function(rad,out){var e=out.elements,f=this.elements;rad*=.5;var ax=f[0],ay=f[1],az=f[2],aw=f[3],bx=Math.sin(rad),bw=Math.cos(rad);e[0]=ax*bw+aw*bx,e[1]=ay*bw+az*bx,e[2]=az*bw-ay*bx,e[3]=aw*bw-ax*bx},__proto.rotateY=function(rad,out){var e=out.elements,f=this.elements;rad*=.5;var ax=f[0],ay=f[1],az=f[2],aw=f[3],by=Math.sin(rad),bw=Math.cos(rad);e[0]=ax*bw-az*by,e[1]=ay*bw+aw*by,e[2]=az*bw+ax*by,e[3]=aw*bw-ay*by},__proto.rotateZ=function(rad,out){var e=out.elements,f=this.elements;rad*=.5;var ax=f[0],ay=f[1],az=f[2],aw=f[3],bz=Math.sin(rad),bw=Math.cos(rad);e[0]=ax*bw+ay*bz,e[1]=ay*bw-ax*bz,e[2]=az*bw+aw*bz,e[3]=aw*bw-az*bz},__proto.getYawPitchRoll=function(out){Vector3.transformQuat(Vector3.ForwardRH,this,Quaternion.TEMPVector31),Vector3.transformQuat(Vector3.Up,this,Quaternion.TEMPVector32);var upe=Quaternion.TEMPVector32.elements;Quaternion.angleTo(Vector3.ZERO,Quaternion.TEMPVector31,Quaternion.TEMPVector33);var anglee=Quaternion.TEMPVector33.elements;anglee[0]==Math.PI/2?(anglee[1]=Quaternion.arcTanAngle(upe[2],upe[0]),anglee[2]=0):anglee[0]==-Math.PI/2?(anglee[1]=Quaternion.arcTanAngle(-upe[2],-upe[0]),anglee[2]=0):(Matrix4x4.createRotationY(-anglee[1],Quaternion.TEMPMatrix0),Matrix4x4.createRotationX(-anglee[0],Quaternion.TEMPMatrix1),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix0,Quaternion.TEMPVector32),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix1,Quaternion.TEMPVector32),anglee[2]=Quaternion.arcTanAngle(upe[1],-upe[0])),anglee[1]<=-Math.PI&&(anglee[1]=Math.PI),anglee[2]<=-Math.PI&&(anglee[2]=Math.PI),anglee[1]>=Math.PI&&anglee[2]>=Math.PI&&(anglee[1]=0,anglee[2]=0,anglee[0]=Math.PI-anglee[0]);var oe=out.elements;oe[0]=anglee[1],oe[1]=anglee[0],oe[2]=anglee[2]},__proto.invert=function(out){var e=out.elements,f=this.elements,a0=f[0],a1=f[1],a2=f[2],a3=f[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;e[0]=-a0*invDot,e[1]=-a1*invDot,e[2]=-a2*invDot,e[3]=a3*invDot},__proto.identity=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=1},__proto.fromArray=function(array,offset){void 0===offset&&(offset=0),this.elements[0]=array[offset+0],this.elements[1]=array[offset+1],this.elements[2]=array[offset+2],this.elements[3]=array[offset+3]},__proto.cloneTo=function(destObject){var i,s,d;if((s=this.elements)!==(d=destObject.elements))for(i=0;i<4;++i)d[i]=s[i]},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__proto.equals=function(b){var ae=this.elements,be=b.elements;return MathUtils3D.nearEqual(ae[0],be[0])&&MathUtils3D.nearEqual(ae[1],be[1])&&MathUtils3D.nearEqual(ae[2],be[2])&&MathUtils3D.nearEqual(ae[3],be[3])},__proto.lengthSquared=function(){var x=this.elements[0],y=this.elements[1],z=this.elements[2],w=this.elements[3];return x*x+y*y+z*z+w*w},__getset(0,__proto,"x",function(){return this.elements[0]}),__getset(0,__proto,"y",function(){return this.elements[1]}),__getset(0,__proto,"z",function(){return this.elements[2]}),__getset(0,__proto,"w",function(){return this.elements[3]}),Quaternion._dotArray=function(l,r){return l[0]*r[0]+l[1]*r[1]+l[2]*r[2]+l[3]*r[3]},Quaternion._normalizeArray=function(f,o){var x=f[0],y=f[1],z=f[2],w=f[3],len=x*x+y*y+z*z+w*w;len>0&&(len=1/Math.sqrt(len),o[0]=x*len,o[1]=y*len,o[2]=z*len,o[3]=w*len)},Quaternion._lerpArray=function(l,r,amount,o){var inverse=1-amount;Quaternion._dotArray(l,r)>=0?(o[0]=inverse*l[0]+amount*r[0],o[1]=inverse*l[1]+amount*r[1],o[2]=inverse*l[2]+amount*r[2],o[3]=inverse*l[3]+amount*r[3]):(o[0]=inverse*l[0]-amount*r[0],o[1]=inverse*l[1]-amount*r[1],o[2]=inverse*l[2]-amount*r[2],o[3]=inverse*l[3]-amount*r[3]),Quaternion._normalizeArray(o,o)},Quaternion.createFromYawPitchRoll=function(yaw,pitch,roll,out){var halfRoll=.5*roll,halfPitch=.5*pitch,halfYaw=.5*yaw,sinRoll=Math.sin(halfRoll),cosRoll=Math.cos(halfRoll),sinPitch=Math.sin(halfPitch),cosPitch=Math.cos(halfPitch),sinYaw=Math.sin(halfYaw),cosYaw=Math.cos(halfYaw),oe=out.elements;oe[0]=cosYaw*sinPitch*cosRoll+sinYaw*cosPitch*sinRoll,oe[1]=sinYaw*cosPitch*cosRoll-cosYaw*sinPitch*sinRoll,oe[2]=cosYaw*cosPitch*sinRoll-sinYaw*sinPitch*cosRoll,oe[3]=cosYaw*cosPitch*cosRoll+sinYaw*sinPitch*sinRoll},Quaternion.multiply=function(left,right,out){var le=left.elements,re=right.elements,oe=out.elements,lx=le[0],ly=le[1],lz=le[2],lw=le[3],rx=re[0],ry=re[1],rz=re[2],rw=re[3],a=ly*rz-lz*ry,b=lz*rx-lx*rz,c=lx*ry-ly*rx,d=lx*rx+ly*ry+lz*rz;oe[0]=lx*rw+rx*lw+a,oe[1]=ly*rw+ry*lw+b,oe[2]=lz*rw+rz*lw+c,oe[3]=lw*rw-d},Quaternion.arcTanAngle=function(x,y){return 0==x?1==y?Math.PI/2:-Math.PI/2:x>0?Math.atan(y/x):x<0?y>0?Math.atan(y/x)+Math.PI:Math.atan(y/x)-Math.PI:0},Quaternion.angleTo=function(from,location,angle){Vector3.subtract(location,from,Quaternion.TEMPVector30),Vector3.normalize(Quaternion.TEMPVector30,Quaternion.TEMPVector30),angle.elements[0]=Math.asin(Quaternion.TEMPVector30.y),angle.elements[1]=Quaternion.arcTanAngle(-Quaternion.TEMPVector30.z,-Quaternion.TEMPVector30.x)},Quaternion.createFromAxisAngle=function(axis,rad,out){var e=out.elements,f=axis.elements;rad*=.5;var s=Math.sin(rad);e[0]=s*f[0],e[1]=s*f[1],e[2]=s*f[2],e[3]=Math.cos(rad)},Quaternion.createFromMatrix3x3=function(sou,out){var fRoot,e=out.elements,f=sou.elements,fTrace=f[0]+f[4]+f[8];if(fTrace>0)fRoot=Math.sqrt(fTrace+1),e[3]=.5*fRoot,fRoot=.5/fRoot,e[0]=(f[5]-f[7])*fRoot,e[1]=(f[6]-f[2])*fRoot,e[2]=(f[1]-f[3])*fRoot;else{var i=0;f[4]>f[0]&&(i=1),f[8]>f[3*i+i]&&(i=2);var j=(i+1)%3,k=(i+2)%3;fRoot=Math.sqrt(f[3*i+i]-f[3*j+j]-f[3*k+k]+1),e[i]=.5*fRoot,fRoot=.5/fRoot,e[3]=(f[3*j+k]-f[3*k+j])*fRoot,e[j]=(f[3*j+i]+f[3*i+j])*fRoot,e[k]=(f[3*k+i]+f[3*i+k])*fRoot}},Quaternion.createFromMatrix4x4=function(mat,out){var sqrt,half,me=mat.elements,oe=out.elements,scale=me[0]+me[5]+me[10];scale>0?(sqrt=Math.sqrt(scale+1),oe[3]=.5*sqrt,sqrt=.5/sqrt,oe[0]=(me[6]-me[9])*sqrt,oe[1]=(me[8]-me[2])*sqrt,oe[2]=(me[1]-me[4])*sqrt):me[0]>=me[5]&&me[0]>=me[10]?(half=.5/(sqrt=Math.sqrt(1+me[0]-me[5]-me[10])),oe[0]=.5*sqrt,oe[1]=(me[1]+me[4])*half,oe[2]=(me[2]+me[8])*half,oe[3]=(me[6]-me[9])*half):me[5]>me[10]?(half=.5/(sqrt=Math.sqrt(1+me[5]-me[0]-me[10])),oe[0]=(me[4]+me[1])*half,oe[1]=.5*sqrt,oe[2]=(me[9]+me[6])*half,oe[3]=(me[8]-me[2])*half):(half=.5/(sqrt=Math.sqrt(1+me[10]-me[0]-me[5])),oe[0]=(me[8]+me[2])*half,oe[1]=(me[9]+me[6])*half,oe[2]=.5*sqrt,oe[3]=(me[1]-me[4])*half)},Quaternion.slerp=function(left,right,t,out){var omega,cosom,sinom,scale0,scale1,a=left.elements,b=right.elements,oe=out.elements,ax=a[0],ay=a[1],az=a[2],aw=a[3],bx=b[0],by=b[1],bz=b[2],bw=b[3];return(cosom=ax*bx+ay*by+az*bz+aw*bw)<0&&(cosom=-cosom,bx=-bx,by=-by,bz=-bz,bw=-bw),1-cosom>1e-6?(omega=Math.acos(cosom),sinom=Math.sin(omega),scale0=Math.sin((1-t)*omega)/sinom,scale1=Math.sin(t*omega)/sinom):(scale0=1-t,scale1=t),oe[0]=scale0*ax+scale1*bx,oe[1]=scale0*ay+scale1*by,oe[2]=scale0*az+scale1*bz,oe[3]=scale0*aw+scale1*bw,oe},Quaternion.lerp=function(left,right,amount,out){Quaternion._lerpArray(left.elements,right.elements,amount,out.elements)},Quaternion.add=function(left,right,out){var e=out.elements,f=left.elements,g=right.elements;e[0]=f[0]+g[0],e[1]=f[1]+g[1],e[2]=f[2]+g[2],e[3]=f[3]+g[3]},Quaternion.dot=function(left,right){return Quaternion._dotArray(left.elements,right.elements)},Quaternion.rotationLookAt=function(forward,up,out){Quaternion.lookAt(Vector3.ZERO,forward,up,out)},Quaternion.lookAt=function(eye,target,up,out){Matrix3x3.lookAt(eye,target,up,Quaternion._tempMatrix3x3),Quaternion.rotationMatrix(Quaternion._tempMatrix3x3,out)},Quaternion.invert=function(value,out){var vE=value.elements,oE=out.elements,lengthSq=value.lengthSquared();MathUtils3D.isZero(lengthSq)||(lengthSq=1/lengthSq,oE[0]=-vE[0]*lengthSq,oE[1]=-vE[1]*lengthSq,oE[2]=-vE[2]*lengthSq,oE[3]=vE[3]*lengthSq)},Quaternion.rotationMatrix=function(matrix3x3,out){var me=matrix3x3.elements,m11=me[0],m12=me[1],m13=me[2],m21=me[3],m22=me[4],m23=me[5],m31=me[6],m32=me[7],m33=me[8],oe=out.elements,sqrt=NaN,half=NaN,scale=m11+m22+m33;scale>0?(sqrt=Math.sqrt(scale+1),oe[3]=.5*sqrt,sqrt=.5/sqrt,oe[0]=(m23-m32)*sqrt,oe[1]=(m31-m13)*sqrt,oe[2]=(m12-m21)*sqrt):m11>=m22&&m11>=m33?(half=.5/(sqrt=Math.sqrt(1+m11-m22-m33)),oe[0]=.5*sqrt,oe[1]=(m12+m21)*half,oe[2]=(m13+m31)*half,oe[3]=(m23-m32)*half):m22>m33?(half=.5/(sqrt=Math.sqrt(1+m22-m11-m33)),oe[0]=(m21+m12)*half,oe[1]=.5*sqrt,oe[2]=(m32+m23)*half,oe[3]=(m31-m13)*half):(half=.5/(sqrt=Math.sqrt(1+m33-m11-m22)),oe[0]=(m31+m13)*half,oe[1]=(m32+m23)*half,oe[2]=.5*sqrt,oe[3]=(m12-m21)*half)},Quaternion.DEFAULT=new Quaternion,__static(Quaternion,["TEMPVector30",function(){return this.TEMPVector30=new Vector3},"TEMPVector31",function(){return this.TEMPVector31=new Vector3},"TEMPVector32",function(){return this.TEMPVector32=new Vector3},"TEMPVector33",function(){return this.TEMPVector33=new Vector3},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Matrix4x4},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Matrix4x4},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new Matrix3x3},"NAN",function(){return this.NAN=new Quaternion(NaN,NaN,NaN,NaN)}]),Quaternion}()),Plane=(function(){function Size(width,height){this._width=0,this._height=0,this._width=width,this._height=height}__class(Size,"laya.d3.utils.Size");var __proto=Size.prototype;__getset(0,__proto,"width",function(){return-1===this._width?RenderContext3D.clientWidth:this._width}),__getset(0,__proto,"height",function(){return-1===this._height?RenderContext3D.clientHeight:this._height}),__getset(1,Size,"fullScreen",function(){return new Size(-1,-1)})}(),function(){function Plane(normal,d){this.normal=null,this.distance=NaN,void 0===d&&(d=0),this.normal=normal,this.distance=d}return __class(Plane,"laya.d3.math.Plane"),Plane.prototype.normalize=function(){var normalE=this.normal.elements,normalEX=normalE[0],normalEY=normalE[1],normalEZ=normalE[2],magnitude=1/Math.sqrt(normalEX*normalEX+normalEY*normalEY+normalEZ*normalEZ);normalE[0]=normalEX*magnitude,normalE[1]=normalEY*magnitude,normalE[2]=normalEZ*magnitude,this.distance*=magnitude},Plane.createPlaneBy3P=function(point1,point2,point3){var point1e=point1.elements,point2e=point2.elements,point3e=point3.elements,x1=point2e[0]-point1e[0],y1=point2e[1]-point1e[1],z1=point2e[2]-point1e[2],x2=point3e[0]-point1e[0],y2=point3e[1]-point1e[1],z2=point3e[2]-point1e[2],yz=y1*z2-z1*y2,xz=z1*x2-x1*z2,xy=x1*y2-y1*x2,invPyth=1/Math.sqrt(yz*yz+xz*xz+xy*xy),x=yz*invPyth,y=xz*invPyth,z=xy*invPyth,TEMPVec3e=Plane._TEMPVec3.elements;TEMPVec3e[0]=x,TEMPVec3e[1]=y,TEMPVec3e[2]=z;var d=-(x*point1e[0]+y*point1e[1]+z*point1e[2]);return new Plane(Plane._TEMPVec3,d)},Plane.PlaneIntersectionType_Back=0,Plane.PlaneIntersectionType_Front=1,Plane.PlaneIntersectionType_Intersecting=2,__static(Plane,["_TEMPVec3",function(){return this._TEMPVec3=new Vector3}]),Plane}()),Ray=(function(){function HeightfieldColliderShape(){}__class(HeightfieldColliderShape,"laya.d3.physics.shape.HeightfieldColliderShape")}(),function(){function Ray(origin,direction){this.origin=null,this.direction=null,this.origin=origin,this.direction=direction}return __class(Ray,"laya.d3.math.Ray"),Ray}()),VertexShuriKenParticle=function(){function VertexShuriKenParticle(){}return __class(VertexShuriKenParticle,"laya.d3.graphics.Vertex.VertexShuriKenParticle"),VertexShuriKenParticle.PARTICLE_CORNERTEXTURECOORDINATE0=0,VertexShuriKenParticle.PARTICLE_POSITION0=1,VertexShuriKenParticle.PARTICLE_COLOR0=2,VertexShuriKenParticle.PARTICLE_TEXTURECOORDINATE0=3,VertexShuriKenParticle.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,VertexShuriKenParticle.PARTICLE_DIRECTIONTIME=5,VertexShuriKenParticle.PARTICLE_STARTCOLOR0=6,VertexShuriKenParticle.PARTICLE_ENDCOLOR0=7,VertexShuriKenParticle.PARTICLE_STARTSIZE=8,VertexShuriKenParticle.PARTICLE_STARTROTATION=9,VertexShuriKenParticle.PARTICLE_STARTSPEED=10,VertexShuriKenParticle.PARTICLE_RANDOM0=11,VertexShuriKenParticle.PARTICLE_RANDOM1=12,VertexShuriKenParticle.PARTICLE_SIMULATIONWORLDPOSTION=13,VertexShuriKenParticle.PARTICLE_SIMULATIONWORLDROTATION=14,VertexShuriKenParticle}(),CollisionUtils=function(){function CollisionUtils(){}return __class(CollisionUtils,"laya.d3.math.CollisionUtils"),CollisionUtils.distancePlaneToPoint=function(plane,point){return Vector3.dot(plane.normal,point)-plane.distance},CollisionUtils.distanceBoxToPoint=function(box,point){var boxMine=box.min.elements,boxMineX=boxMine[0],boxMineY=boxMine[1],boxMineZ=boxMine[2],boxMaxe=box.max.elements,boxMaxeX=boxMaxe[0],boxMaxeY=boxMaxe[1],boxMaxeZ=boxMaxe[2],pointe=point.elements,pointeX=pointe[0],pointeY=pointe[1],pointeZ=pointe[2],distance=0;return pointeX<boxMineX&&(distance+=(boxMineX-pointeX)*(boxMineX-pointeX)),pointeX>boxMaxeX&&(distance+=(boxMaxeX-pointeX)*(boxMaxeX-pointeX)),pointeY<boxMineY&&(distance+=(boxMineY-pointeY)*(boxMineY-pointeY)),pointeY>boxMaxeY&&(distance+=(boxMaxeY-pointeY)*(boxMaxeY-pointeY)),pointeZ<boxMineZ&&(distance+=(boxMineZ-pointeZ)*(boxMineZ-pointeZ)),pointeZ>boxMaxeZ&&(distance+=(boxMaxeZ-pointeZ)*(boxMaxeZ-pointeZ)),Math.sqrt(distance)},CollisionUtils.distanceBoxToBox=function(box1,box2){var box1Mine=box1.min.elements,box1MineX=box1Mine[0],box1MineY=box1Mine[1],box1MineZ=box1Mine[2],box1Maxe=box1.max.elements,box1MaxeX=box1Maxe[0],box1MaxeY=box1Maxe[1],box1MaxeZ=box1Maxe[2],box2Mine=box2.min.elements,box2MineX=box2Mine[0],box2MineY=box2Mine[1],box2MineZ=box2Mine[2],box2Maxe=box2.max.elements,box2MaxeX=box2Maxe[0],box2MaxeY=box2Maxe[1],box2MaxeZ=box2Maxe[2],distance=0,delta=NaN;return box1MineX>box2MaxeX?distance+=(delta=box1MineX-box2MaxeX)*delta:box2MineX>box1MaxeX&&(distance+=(delta=box2MineX-box1MaxeX)*delta),box1MineY>box2MaxeY?distance+=(delta=box1MineY-box2MaxeY)*delta:box2MineY>box1MaxeY&&(distance+=(delta=box2MineY-box1MaxeY)*delta),box1MineZ>box2MaxeZ?distance+=(delta=box1MineZ-box2MaxeZ)*delta:box2MineZ>box1MaxeZ&&(distance+=(delta=box2MineZ-box1MaxeZ)*delta),Math.sqrt(distance)},CollisionUtils.distanceSphereToPoint=function(sphere,point){var distance=Math.sqrt(Vector3.distanceSquared(sphere.center,point));return distance-=sphere.radius,Math.max(distance,0)},CollisionUtils.distanceSphereToSphere=function(sphere1,sphere2){var distance=Math.sqrt(Vector3.distanceSquared(sphere1.center,sphere2.center));return distance-=sphere1.radius+sphere2.radius,Math.max(distance,0)},CollisionUtils.intersectsRayAndTriangleRD=function(ray,vertex1,vertex2,vertex3,out){var rayOe=ray.origin.elements,rayOeX=rayOe[0],rayOeY=rayOe[1],rayOeZ=rayOe[2],rayDe=ray.direction.elements,rayDeX=rayDe[0],rayDeY=rayDe[1],rayDeZ=rayDe[2],v1e=vertex1.elements,v1eX=v1e[0],v1eY=v1e[1],v1eZ=v1e[2],v2e=vertex2.elements,v2eX=v2e[0],v2eY=v2e[1],v2eZ=v2e[2],v3e=vertex3.elements,v3eX=v3e[0],v3eY=v3e[1],v3eZ=v3e[2],_tempV30e=CollisionUtils._tempV30.elements,_tempV30eX=_tempV30e[0],_tempV30eY=_tempV30e[1],_tempV30eZ=_tempV30e[2];_tempV30eX=v2eX-v1eX,_tempV30eY=v2eY-v1eY,_tempV30eZ=v2eZ-v1eZ;var _tempV31e=CollisionUtils._tempV31.elements,_tempV31eX=_tempV31e[0],_tempV31eY=_tempV31e[1],_tempV31eZ=_tempV31e[2];_tempV31eX=v3eX-v1eX,_tempV31eY=v3eY-v1eY,_tempV31eZ=v3eZ-v1eZ;var _tempV32e=CollisionUtils._tempV32.elements,_tempV32eX=_tempV32e[0],_tempV32eY=_tempV32e[1],_tempV32eZ=_tempV32e[2],determinant=_tempV30eX*(_tempV32eX=rayDeY*_tempV31eZ-rayDeZ*_tempV31eY)+_tempV30eY*(_tempV32eY=rayDeZ*_tempV31eX-rayDeX*_tempV31eZ)+_tempV30eZ*(_tempV32eZ=rayDeX*_tempV31eY-rayDeY*_tempV31eX);if(MathUtils3D.isZero(determinant))return 0,!1;var inversedeterminant=1/determinant,_tempV33e=CollisionUtils._tempV33.elements,_tempV33eX=_tempV33e[0],_tempV33eY=_tempV33e[1],_tempV33eZ=_tempV33e[2],triangleU=(_tempV33eX=rayOeX-v1eX)*_tempV32eX+(_tempV33eY=rayOeY-v1eY)*_tempV32eY+(_tempV33eZ=rayOeZ-v1eZ)*_tempV32eZ;if((triangleU*=inversedeterminant)<0||triangleU>1)return 0,!1;var _tempV34e=CollisionUtils._tempV34.elements,_tempV34eX=_tempV34e[0],_tempV34eY=_tempV34e[1],_tempV34eZ=_tempV34e[2],triangleV=rayDeX*(_tempV34eX=_tempV33eY*_tempV30eZ-_tempV33eZ*_tempV30eY)+rayDeY*(_tempV34eY=_tempV33eZ*_tempV30eX-_tempV33eX*_tempV30eZ)+rayDeZ*(_tempV34eZ=_tempV33eX*_tempV30eY-_tempV33eY*_tempV30eX);if((triangleV*=inversedeterminant)<0||triangleU+triangleV>1)return 0,!1;var raydistance=_tempV31eX*_tempV34eX+_tempV31eY*_tempV34eY+_tempV31eZ*_tempV34eZ;return(raydistance*=inversedeterminant)<0?(0,!1):(raydistance,!0)},CollisionUtils.intersectsRayAndTriangleRP=function(ray,vertex1,vertex2,vertex3,out){return CollisionUtils.intersectsRayAndTriangleRD(ray,vertex1,vertex2,vertex3,NaN)?(Vector3.scale(ray.direction,NaN,CollisionUtils._tempV30),Vector3.add(ray.origin,CollisionUtils._tempV30,out),!0):(out=Vector3.ZERO,!1)},CollisionUtils.intersectsRayAndPoint=function(ray,point){Vector3.subtract(ray.origin,point,CollisionUtils._tempV30);var b=Vector3.dot(CollisionUtils._tempV30,ray.direction),c=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-MathUtils3D.zeroTolerance;return!(c>0&&b>0)&&!(b*b-c<0)},CollisionUtils.intersectsRayAndRay=function(ray1,ray2,out){var ray1o=ray1.origin,ray1oe=ray1o.elements,ray1oeX=ray1oe[0],ray1oeY=ray1oe[1],ray1oeZ=ray1oe[2],ray1d=ray1.direction,ray1de=ray1d.elements,ray1deX=ray1de[0],ray1deY=ray1de[1],ray1deZ=ray1de[2],ray2o=ray2.origin,ray2oe=ray2o.elements,ray2oeX=ray2oe[0],ray2oeY=ray2oe[1],ray2oeZ=ray2oe[2],ray2d=ray2.direction,ray2de=ray2d.elements,ray2deX=ray2de[0],ray2deY=ray2de[1],ray2deZ=ray2de[2];Vector3.cross(ray1d,ray2d,CollisionUtils._tempV30);var tempV3e=CollisionUtils._tempV30.elements,denominator=Vector3.scalarLength(CollisionUtils._tempV30);if(MathUtils3D.isZero(denominator)&&MathUtils3D.nearEqual(ray2oeX,ray1oeX)&&MathUtils3D.nearEqual(ray2oeY,ray1oeY)&&MathUtils3D.nearEqual(ray2oeZ,ray1oeZ))return Vector3.ZERO,!0;denominator*=denominator;var m11=ray2oeX-ray1oeX,m12=ray2oeY-ray1oeY,m13=ray2oeZ-ray1oeZ,m21=ray2deX,m22=ray2deY,m23=ray2deZ,m31=tempV3e[0],m32=tempV3e[1],m33=tempV3e[2],s=(m11*m22*m33+m12*m23*m31+m13*m21*m32-m11*m23*m32-m12*m21*m33-m13*m22*m31)/denominator;m22=ray1deY,m23=ray1deZ,m21=ray1deX;Vector3.scale(ray1d,s,CollisionUtils._tempV30),Vector3.scale(ray2d,s,CollisionUtils._tempV31),Vector3.add(ray1o,CollisionUtils._tempV30,CollisionUtils._tempV32),Vector3.add(ray2o,CollisionUtils._tempV31,CollisionUtils._tempV33);var point1e=CollisionUtils._tempV32.elements,point2e=CollisionUtils._tempV33.elements;return MathUtils3D.nearEqual(point2e[0],point1e[0])&&MathUtils3D.nearEqual(point2e[1],point1e[1])&&MathUtils3D.nearEqual(point2e[2],point1e[2])?(CollisionUtils._tempV32,!0):(Vector3.ZERO,!1)},CollisionUtils.intersectsPlaneAndTriangle=function(plane,vertex1,vertex2,vertex3){var test1=CollisionUtils.intersectsPlaneAndPoint(plane,vertex1),test2=CollisionUtils.intersectsPlaneAndPoint(plane,vertex2),test3=CollisionUtils.intersectsPlaneAndPoint(plane,vertex3);return test1==Plane.PlaneIntersectionType_Front&&test2==Plane.PlaneIntersectionType_Front&&test3==Plane.PlaneIntersectionType_Front?Plane.PlaneIntersectionType_Front:test1==Plane.PlaneIntersectionType_Back&&test2==Plane.PlaneIntersectionType_Back&&test3==Plane.PlaneIntersectionType_Back?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},CollisionUtils.intersectsRayAndPlaneRD=function(ray,plane,out){var planeNor=plane.normal,direction=Vector3.dot(planeNor,ray.direction);if(MathUtils3D.isZero(direction))return 0,!1;var position=Vector3.dot(planeNor,ray.origin);return!((-plane.distance-position)/direction<0)||(0,!1)},CollisionUtils.intersectsRayAndPlaneRP=function(ray,plane,out){return CollisionUtils.intersectsRayAndPlaneRD(ray,plane,NaN)?(Vector3.scale(ray.direction,NaN,CollisionUtils._tempV30),Vector3.add(ray.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31,!0):(Vector3.ZERO,!1)},CollisionUtils.intersectsRayAndBoxRD=function(ray,box){var rayoe=ray.origin.elements,rayoeX=rayoe[0],rayoeY=rayoe[1],rayoeZ=rayoe[2],rayde=ray.direction.elements,raydeX=rayde[0],raydeY=rayde[1],raydeZ=rayde[2],boxMine=box.min.elements,boxMineX=boxMine[0],boxMineY=boxMine[1],boxMineZ=boxMine[2],boxMaxe=box.max.elements,boxMaxeX=boxMaxe[0],boxMaxeY=boxMaxe[1],boxMaxeZ=boxMaxe[2],out=0,tmax=MathUtils3D.MaxValue;if(MathUtils3D.isZero(raydeX)){if(rayoeX<boxMineX||rayoeX>boxMaxeX)return-1}else{var inverse=1/raydeX,t1=(boxMineX-rayoeX)*inverse,t2=(boxMaxeX-rayoeX)*inverse;if(t1>t2){var temp=t1;t1=t2,t2=temp}if((out=Math.max(t1,out))>(tmax=Math.min(t2,tmax)))return-1}if(MathUtils3D.isZero(raydeY)){if(rayoeY<boxMineY||rayoeY>boxMaxeY)return-1}else{var inverse1=1/raydeY,t3=(boxMineY-rayoeY)*inverse1,t4=(boxMaxeY-rayoeY)*inverse1;if(t3>t4){var temp1=t3;t3=t4,t4=temp1}if((out=Math.max(t3,out))>(tmax=Math.min(t4,tmax)))return-1}if(MathUtils3D.isZero(raydeZ)){if(rayoeZ<boxMineZ||rayoeZ>boxMaxeZ)return-1}else{var inverse2=1/raydeZ,t5=(boxMineZ-rayoeZ)*inverse2,t6=(boxMaxeZ-rayoeZ)*inverse2;if(t5>t6){var temp2=t5;t5=t6,t6=temp2}if((out=Math.max(t5,out))>(tmax=Math.min(t6,tmax)))return-1}return out},CollisionUtils.intersectsRayAndBoxRP=function(ray,box,out){var distance=CollisionUtils.intersectsRayAndBoxRD(ray,box);return-1===distance?(Vector3.ZERO.cloneTo(out),distance):(Vector3.scale(ray.direction,distance,CollisionUtils._tempV30),Vector3.add(ray.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(out),distance)},CollisionUtils.intersectsRayAndSphereRD=function(ray,sphere){var sphereR=sphere.radius;Vector3.subtract(ray.origin,sphere.center,CollisionUtils._tempV30);var b=Vector3.dot(CollisionUtils._tempV30,ray.direction),c=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV30)-sphereR*sphereR;if(c>0&&b>0)return-1;var discriminant=b*b-c;if(discriminant<0)return-1;var distance=-b-Math.sqrt(discriminant);return distance<0&&(distance=0),distance},CollisionUtils.intersectsRayAndSphereRP=function(ray,sphere,out){var distance=CollisionUtils.intersectsRayAndSphereRD(ray,sphere);return-1===distance?(Vector3.ZERO.cloneTo(out),distance):(Vector3.scale(ray.direction,distance,CollisionUtils._tempV30),Vector3.add(ray.origin,CollisionUtils._tempV30,CollisionUtils._tempV31),CollisionUtils._tempV31.cloneTo(out),distance)},CollisionUtils.intersectsSphereAndTriangle=function(sphere,vertex1,vertex2,vertex3){var sphereC=sphere.center,sphereR=sphere.radius;return CollisionUtils.closestPointPointTriangle(sphereC,vertex1,vertex2,vertex3,CollisionUtils._tempV30),Vector3.subtract(CollisionUtils._tempV30,sphereC,CollisionUtils._tempV31),Vector3.dot(CollisionUtils._tempV31,CollisionUtils._tempV31)<=sphereR*sphereR},CollisionUtils.intersectsPlaneAndPoint=function(plane,point){var distance=Vector3.dot(plane.normal,point)+plane.distance;return distance>0?Plane.PlaneIntersectionType_Front:distance<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},CollisionUtils.intersectsPlaneAndPlane=function(plane1,plane2){Vector3.cross(plane1.normal,plane2.normal,CollisionUtils._tempV30);var denominator=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV30);return!MathUtils3D.isZero(denominator)},CollisionUtils.intersectsPlaneAndPlaneRL=function(plane1,plane2,line){var plane1nor=plane1.normal,plane2nor=plane2.normal;Vector3.cross(plane1nor,plane2nor,CollisionUtils._tempV34);var denominator=Vector3.dot(CollisionUtils._tempV34,CollisionUtils._tempV34);return!MathUtils3D.isZero(denominator)&&(Vector3.scale(plane2nor,plane1.distance,CollisionUtils._tempV30),Vector3.scale(plane1nor,plane2.distance,CollisionUtils._tempV31),Vector3.subtract(CollisionUtils._tempV30,CollisionUtils._tempV31,CollisionUtils._tempV32),Vector3.cross(CollisionUtils._tempV32,CollisionUtils._tempV34,CollisionUtils._tempV33),Vector3.normalize(CollisionUtils._tempV34,CollisionUtils._tempV34),new Ray(CollisionUtils._tempV33,CollisionUtils._tempV34),!0)},CollisionUtils.intersectsPlaneAndBox=function(plane,box){var planeD=plane.distance,planeNor=plane.normal,planeNore=planeNor.elements,planeNoreX=planeNore[0],planeNoreY=planeNore[1],planeNoreZ=planeNore[2],boxMine=box.min.elements,boxMineX=boxMine[0],boxMineY=boxMine[1],boxMineZ=boxMine[2],boxMaxe=box.max.elements,boxMaxeX=boxMaxe[0],boxMaxeY=boxMaxe[1],boxMaxeZ=boxMaxe[2];CollisionUtils._tempV30.elements[0]=planeNoreX>0?boxMineX:boxMaxeX,CollisionUtils._tempV30.elements[1]=planeNoreY>0?boxMineY:boxMaxeY,CollisionUtils._tempV30.elements[2]=planeNoreZ>0?boxMineZ:boxMaxeZ,CollisionUtils._tempV31.elements[0]=planeNoreX>0?boxMaxeX:boxMineX,CollisionUtils._tempV31.elements[1]=planeNoreY>0?boxMaxeY:boxMineY,CollisionUtils._tempV31.elements[2]=planeNoreZ>0?boxMaxeZ:boxMineZ;var distance=Vector3.dot(planeNor,CollisionUtils._tempV30);return distance+planeD>0?Plane.PlaneIntersectionType_Front:(distance=Vector3.dot(planeNor,CollisionUtils._tempV31))+planeD<0?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},CollisionUtils.intersectsPlaneAndSphere=function(plane,sphere){var sphereR=sphere.radius,distance=Vector3.dot(plane.normal,sphere.center)+plane.distance;return distance>sphereR?Plane.PlaneIntersectionType_Front:distance<-sphereR?Plane.PlaneIntersectionType_Back:Plane.PlaneIntersectionType_Intersecting},CollisionUtils.intersectsBoxAndBox=function(box1,box2){var box1Mine=box1.min.elements,box1Maxe=box1.max.elements,box2Mine=box2.min.elements,box2Maxe=box2.max.elements;return!(box1Mine[0]>box2Maxe[0]||box2Mine[0]>box1Maxe[0])&&(!(box1Mine[1]>box2Maxe[1]||box2Mine[1]>box1Maxe[1])&&!(box1Mine[2]>box2Maxe[2]||box2Mine[2]>box1Maxe[2]))},CollisionUtils.intersectsBoxAndSphere=function(box,sphere){var sphereC=sphere.center,sphereR=sphere.radius;return Vector3.Clamp(sphereC,box.min,box.max,CollisionUtils._tempV30),Vector3.distanceSquared(sphereC,CollisionUtils._tempV30)<=sphereR*sphereR},CollisionUtils.intersectsSphereAndSphere=function(sphere1,sphere2){var radiisum=sphere1.radius+sphere2.radius;return Vector3.distanceSquared(sphere1.center,sphere2.center)<=radiisum*radiisum},CollisionUtils.boxContainsPoint=function(box,point){var boxMine=box.min.elements,boxMaxe=box.max.elements,pointe=point.elements;return boxMine[0]<=pointe[0]&&boxMaxe[0]>=pointe[0]&&boxMine[1]<=pointe[1]&&boxMaxe[1]>=pointe[1]&&boxMine[2]<=pointe[2]&&boxMaxe[2]>=pointe[2]?1:0},CollisionUtils.boxContainsBox=function(box1,box2){var box1Mine=box1.min.elements,box1MineX=box1Mine[0],box1MineY=box1Mine[1],box1MineZ=box1Mine[2],box1Maxe=box1.max.elements,box1MaxeX=box1Maxe[0],box1MaxeY=box1Maxe[1],box1MaxeZ=box1Maxe[2],box2Mine=box2.min.elements,box2MineX=box2Mine[0],box2MineY=box2Mine[1],box2MineZ=box2Mine[2],box2Maxe=box2.max.elements,box2MaxeX=box2Maxe[0],box2MaxeY=box2Maxe[1],box2MaxeZ=box2Maxe[2];return box1MaxeX<box2MineX||box1MineX>box2MaxeX?0:box1MaxeY<box2MineY||box1MineY>box2MaxeY?0:box1MaxeZ<box2MineZ||box1MineZ>box2MaxeZ?0:box1MineX<=box2MineX&&box2MaxeX<=box2MaxeX&&box1MineY<=box2MineY&&box2MaxeY<=box1MaxeY&&box1MineZ<=box2MineZ&&box2MaxeZ<=box1MaxeZ?1:2},CollisionUtils.boxContainsSphere=function(box,sphere){var boxMin=box.min,boxMine=boxMin.elements,boxMineX=boxMine[0],boxMineY=boxMine[1],boxMineZ=boxMine[2],boxMax=box.max,boxMaxe=boxMax.elements,boxMaxeX=boxMaxe[0],boxMaxeY=boxMaxe[1],boxMaxeZ=boxMaxe[2],sphereC=sphere.center,sphereCe=sphereC.elements,sphereCeX=sphereCe[0],sphereCeY=sphereCe[1],sphereCeZ=sphereCe[2],sphereR=sphere.radius;return Vector3.Clamp(sphereC,boxMin,boxMax,CollisionUtils._tempV30),Vector3.distanceSquared(sphereC,CollisionUtils._tempV30)>sphereR*sphereR?0:boxMineX+sphereR<=sphereCeX&&sphereCeX<=boxMaxeX-sphereR&&boxMaxeX-boxMineX>sphereR&&boxMineY+sphereR<=sphereCeY&&sphereCeY<=boxMaxeY-sphereR&&boxMaxeY-boxMineY>sphereR&&boxMineZ+sphereR<=sphereCeZ&&sphereCeZ<=boxMaxeZ-sphereR&&boxMaxeZ-boxMineZ>sphereR?1:2},CollisionUtils.sphereContainsPoint=function(sphere,point){return Vector3.distanceSquared(point,sphere.center)<=sphere.radius*sphere.radius?1:0},CollisionUtils.sphereContainsTriangle=function(sphere,vertex1,vertex2,vertex3){var test1=CollisionUtils.sphereContainsPoint(sphere,vertex1),test2=CollisionUtils.sphereContainsPoint(sphere,vertex2),test3=CollisionUtils.sphereContainsPoint(sphere,vertex3);return 1==test1&&1==test2&&1==test3?1:CollisionUtils.intersectsSphereAndTriangle(sphere,vertex1,vertex2,vertex3)?2:0},CollisionUtils.sphereContainsBox=function(sphere,box){var sphereCe=sphere.center.elements,sphereCeX=sphereCe[0],sphereCeY=sphereCe[1],sphereCeZ=sphereCe[2],sphereR=sphere.radius,boxMine=box.min.elements,boxMineX=boxMine[0],boxMineY=boxMine[1],boxMineZ=boxMine[2],boxMaxe=box.max.elements,boxMaxeX=boxMaxe[0],boxMaxeY=boxMaxe[1],boxMaxeZ=boxMaxe[2],_tempV30e=CollisionUtils._tempV30.elements;_tempV30e[0],_tempV30e[1],_tempV30e[2];if(!CollisionUtils.intersectsBoxAndSphere(box,sphere))return 0;var radiusSquared=sphereR*sphereR;return sphereCeX-boxMineX,sphereCeY-boxMaxeY,sphereCeZ-boxMaxeZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMaxeX,sphereCeY-boxMaxeY,sphereCeZ-boxMaxeZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMaxeX,sphereCeY-boxMineY,sphereCeZ-boxMaxeZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMineX,sphereCeY-boxMineY,sphereCeZ-boxMaxeZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMineX,sphereCeY-boxMaxeY,sphereCeZ-boxMineZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMaxeX,sphereCeY-boxMaxeY,sphereCeZ-boxMineZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMaxeX,sphereCeY-boxMineY,sphereCeZ-boxMineZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:(sphereCeX-boxMineX,sphereCeY-boxMineY,sphereCeZ-boxMineZ,Vector3.scalarLengthSquared(CollisionUtils._tempV30)>radiusSquared?2:1)))))))},CollisionUtils.sphereContainsSphere=function(sphere1,sphere2){var sphere1R=sphere1.radius,sphere2R=sphere2.radius,distance=Vector3.distance(sphere1.center,sphere2.center);return sphere1R+sphere2R<distance?0:sphere1R-sphere2R<distance?2:1},CollisionUtils.closestPointPointTriangle=function(point,vertex1,vertex2,vertex3,out){Vector3.subtract(vertex2,vertex1,CollisionUtils._tempV30),Vector3.subtract(vertex3,vertex1,CollisionUtils._tempV31),Vector3.subtract(point,vertex1,CollisionUtils._tempV32),Vector3.subtract(point,vertex2,CollisionUtils._tempV33),Vector3.subtract(point,vertex3,CollisionUtils._tempV34);var d1=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV32),d2=Vector3.dot(CollisionUtils._tempV31,CollisionUtils._tempV32),d3=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV33),d4=Vector3.dot(CollisionUtils._tempV31,CollisionUtils._tempV33),d5=Vector3.dot(CollisionUtils._tempV30,CollisionUtils._tempV34),d6=Vector3.dot(CollisionUtils._tempV31,CollisionUtils._tempV34);if(d1<=0&&d2<=0)vertex1.cloneTo(out);else if(d3>=0&&d4<=d3)vertex2.cloneTo(out);else{var vc=d1*d4-d3*d2;if(vc<=0&&d1>=0&&d3<=0){var v=d1/(d1-d3);return Vector3.scale(CollisionUtils._tempV30,v,out),void Vector3.add(vertex1,out,out)}if(d6>=0&&d5<=d6)vertex3.cloneTo(out);else{var vb=d5*d2-d1*d6;if(vb<=0&&d2>=0&&d6<=0){var w=d2/(d2-d6);return Vector3.scale(CollisionUtils._tempV31,w,out),void Vector3.add(vertex1,out,out)}var va=d3*d6-d5*d4;if(va<=0&&d4-d3>=0&&d5-d6>=0){var w3=(d4-d3)/(d4-d3+(d5-d6));return Vector3.subtract(vertex3,vertex2,out),Vector3.scale(out,w3,out),void Vector3.add(vertex2,out,out)}var denom=1/(va+vb+vc),v2=vb*denom,w2=vc*denom;Vector3.scale(CollisionUtils._tempV30,v2,CollisionUtils._tempV35),Vector3.scale(CollisionUtils._tempV31,w2,CollisionUtils._tempV36),Vector3.add(CollisionUtils._tempV35,CollisionUtils._tempV36,out),Vector3.add(vertex1,out,out)}}},CollisionUtils.closestPointPlanePoint=function(plane,point,out){var planeN=plane.normal,t=Vector3.dot(planeN,point)-plane.distance;Vector3.scale(planeN,t,CollisionUtils._tempV30),Vector3.subtract(point,CollisionUtils._tempV30,out)},CollisionUtils.closestPointBoxPoint=function(box,point,out){Vector3.max(point,box.min,CollisionUtils._tempV30),Vector3.min(CollisionUtils._tempV30,box.max,out)},CollisionUtils.closestPointSpherePoint=function(sphere,point,out){var sphereC=sphere.center;Vector3.subtract(point,sphereC,out),Vector3.normalize(out,out),Vector3.scale(out,sphere.radius,out),Vector3.add(out,sphereC,out)},CollisionUtils.closestPointSphereSphere=function(sphere1,sphere2,out){var sphere1C=sphere1.center;Vector3.subtract(sphere2.center,sphere1C,out),Vector3.normalize(out,out),Vector3.scale(out,sphere1.radius,out),Vector3.add(out,sphere1C,out)},__static(CollisionUtils,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3}]),CollisionUtils}(),TrailFilter=function(){function TrailFilter(owner){this._minVertexDistance=NaN,this._widthMultiplier=NaN,this._time=NaN,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._trialGeometry=null,this._totalLength=0,this._owner=null,this._curtime=0,this._trailRenderElementIndex=0,this._lastPosition=new Vector3,this.alignment=0,this._owner=owner,this._initDefaultData(),this.addRenderElement()}__class(TrailFilter,"laya.d3.core.trail.TrailFilter");var __proto=TrailFilter.prototype;return __proto.addRenderElement=function(){var render=this._owner._render,elements=render._renderElements,material=render.sharedMaterials[0];material||(material=TrailMaterial.defaultMaterial);var element=new RenderElement;element.setTransform(this._owner._transform),element.render=render,element.material=material,this._trialGeometry=new TrailGeometry(this),element.setGeometry(this._trialGeometry),elements.push(element)},__proto._update=function(state){var render=this._owner._render;this._curtime+=state.scene.timer._delta/1e3,render._shaderValues.setNumber(TrailSprite3D.CURTIME,this._curtime);var curPos=this._owner.transform.position,element=render._renderElements[0]._geometry;element._updateDisappear(),element._updateTrail(state.camera,this._lastPosition,curPos),element._updateVertexBufferUV(),curPos.cloneTo(this._lastPosition)},__proto._initDefaultData=function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=0;var widthKeyFrames=[],widthKeyFrame1=new FloatKeyframe;widthKeyFrame1.time=0,widthKeyFrame1.inTangent=0,widthKeyFrame1.outTangent=0,widthKeyFrame1.value=1,widthKeyFrames.push(widthKeyFrame1);var widthKeyFrame2=new FloatKeyframe;widthKeyFrame2.time=1,widthKeyFrame2.inTangent=0,widthKeyFrame2.outTangent=0,widthKeyFrame2.value=1,widthKeyFrames.push(widthKeyFrame2),this.widthCurve=widthKeyFrames;var gradient=new Gradient(2,2);gradient.mode=0,gradient.addColorRGB(0,Color.WHITE),gradient.addColorRGB(1,Color.WHITE),gradient.addColorAlpha(0,1),gradient.addColorAlpha(1,1),this.colorGradient=gradient},__proto.destroy=function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null},__getset(0,__proto,"widthMultiplier",function(){return this._widthMultiplier},function(value){this._widthMultiplier=value}),__getset(0,__proto,"time",function(){return this._time},function(value){this._time=value,this._owner._render._shaderValues.setNumber(TrailSprite3D.LIFETIME,value)}),__getset(0,__proto,"widthCurve",function(){return this._widthCurve},function(value){this._widthCurve=value;var j,widthCurveFloatArray=new Float32Array(4*value.length),i=0,index=0;for(i=0,j=value.length;i<j;i++)widthCurveFloatArray[index++]=value[i].time,widthCurveFloatArray[index++]=value[i].inTangent,widthCurveFloatArray[index++]=value[i].outTangent,widthCurveFloatArray[index++]=value[i].value;this._owner._render._shaderValues.setBuffer(TrailSprite3D.WIDTHCURVE,widthCurveFloatArray),this._owner._render._shaderValues.setInt(TrailSprite3D.WIDTHCURVEKEYLENGTH,value.length)}),__getset(0,__proto,"minVertexDistance",function(){return this._minVertexDistance},function(value){this._minVertexDistance=value}),__getset(0,__proto,"colorGradient",function(){return this._colorGradient},function(value){this._colorGradient=value,this._owner._render._shaderValues.setBuffer(TrailSprite3D.GRADIENTCOLORKEY,value._rgbElements),this._owner._render._shaderValues.setBuffer(TrailSprite3D.GRADIENTALPHAKEY,value._alphaElements),0==value.mode?this._owner._render._defineDatas.add(TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._defineDatas.remove(TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND)}),__getset(0,__proto,"textureMode",function(){return this._textureMode},function(value){this._textureMode=value}),TrailFilter.ALIGNMENT_VIEW=0,TrailFilter.ALIGNMENT_TRANSFORM_Z=1,TrailFilter}(),StaticBatchManager=function(){function StaticBatchManager(){this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[]}__class(StaticBatchManager,"laya.d3.graphics.StaticBatchManager");var __proto=StaticBatchManager.prototype;return __proto._partition=function(items,left,right){for(var pivot=items[Math.floor((right+left)/2)];left<=right;){for(;this._compare(items[left],pivot)<0;)left++;for(;this._compare(items[right],pivot)>0;)right--;if(left<right){var temp=items[left];items[left]=items[right],items[right]=temp,left++,right--}else if(left===right){left++;break}}return left},__proto._quickSort=function(items,left,right){if(items.length>1){var index=this._partition(items,left,right),leftIndex=index-1;left<leftIndex&&this._quickSort(items,left,leftIndex),index<right&&this._quickSort(items,index,right)}},__proto._compare=function(left,right){throw"StaticBatch:must override this function."},__proto._initStaticBatchs=function(rootSprite){throw"StaticBatch:must override this function."},__proto._getBatchRenderElementFromPool=function(){throw"StaticBatch:must override this function."},__proto._addBatchSprite=function(renderableSprite3D){this._initBatchSprites.push(renderableSprite3D)},__proto._clear=function(){this._batchRenderElementPoolIndex=0},__proto._garbageCollection=function(){throw"StaticBatchManager: must override it."},__proto.dispose=function(){this._staticBatches=null},StaticBatchManager._registerManager=function(manager){StaticBatchManager._managers.push(manager)},StaticBatchManager._addToStaticBatchQueue=function(sprite3D){sprite3D instanceof laya.d3.core.RenderableSprite3D&&sprite3D.isStatic&&sprite3D._addToInitStaticBatchManager();for(var i=0,n=sprite3D.numChildren;i<n;i++)StaticBatchManager._addToStaticBatchQueue(sprite3D._children[i])},StaticBatchManager.combine=function(staticBatchRoot,renderableSprite3Ds){var i=0,n=0;if(renderableSprite3Ds)for(i=0,n=renderableSprite3Ds.length;i<n;i++){var renderableSprite3D=renderableSprite3Ds[i];renderableSprite3D.isStatic&&renderableSprite3D._addToInitStaticBatchManager()}else staticBatchRoot&&StaticBatchManager._addToStaticBatchQueue(staticBatchRoot);for(i=0,n=StaticBatchManager._managers.length;i<n;i++){StaticBatchManager._managers[i]._initStaticBatchs(staticBatchRoot)}},StaticBatchManager._managers=[],StaticBatchManager}(),RenderContext3D=function(){function RenderContext3D(){}return __class(RenderContext3D,"laya.d3.core.render.RenderContext3D"),RenderContext3D.clientWidth=0,RenderContext3D.clientHeight=0,__static(RenderContext3D,["_instance",function(){return this._instance=new RenderContext3D}]),RenderContext3D}(),VertexTrail=function(){function VertexTrail(){}__class(VertexTrail,"laya.d3.core.trail.VertexTrail");var __proto=VertexTrail.prototype;return Laya.imps(__proto,{"laya.d3.graphics.IVertex":!0}),__getset(0,__proto,"vertexDeclaration",function(){return VertexTrail._vertexDeclaration1}),__getset(1,VertexTrail,"vertexDeclaration1",function(){return VertexTrail._vertexDeclaration1}),__getset(1,VertexTrail,"vertexDeclaration2",function(){return VertexTrail._vertexDeclaration2}),VertexTrail.TRAIL_POSITION0=0,VertexTrail.TRAIL_OFFSETVECTOR=1,VertexTrail.TRAIL_TIME0=2,VertexTrail.TRAIL_TEXTURECOORDINATE0Y=3,VertexTrail.TRAIL_TEXTURECOORDINATE0X=4,__static(VertexTrail,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new VertexDeclaration(32,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",1),new VertexElement(24,"single",2),new VertexElement(28,"single",3)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new VertexDeclaration(4,[new VertexElement(0,"single",4)])}]),VertexTrail}(),GradientSize=function(){function GradientSize(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(GradientSize,"laya.d3.core.particleShuriKen.module.GradientSize");var __proto=GradientSize.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.getMaxSizeInGradient=function(){var i=0,n=0,maxSize=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(i=0,n=this._gradientX.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientX.getValueByIndex(i));for(i=0,n=this._gradientY.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientY.getValueByIndex(i))}else for(i=0,n=this._gradient.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradient.getValueByIndex(i));break;case 1:this._separateAxes?(maxSize=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),maxSize=Math.max(maxSize,this._constantMinSeparate.y),maxSize=Math.max(maxSize,this._constantMaxSeparate.y)):maxSize=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(i=0,n=this._gradientXMin.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientXMin.getValueByIndex(i));for(i=0,n=this._gradientXMax.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientXMax.getValueByIndex(i));for(i=0,n=this._gradientYMin.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientYMin.getValueByIndex(i));for(i=0,n=this._gradientZMax.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientZMax.getValueByIndex(i))}else{for(i=0,n=this._gradientMin.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientMin.getValueByIndex(i));for(i=0,n=this._gradientMax.gradientCount;i<n;i++)maxSize=Math.max(maxSize,this._gradientMax.getValueByIndex(i))}}return maxSize},__proto.cloneTo=function(destObject){var destGradientSize=destObject;destGradientSize._type=this._type,destGradientSize._separateAxes=this._separateAxes,this._gradient.cloneTo(destGradientSize._gradient),this._gradientX.cloneTo(destGradientSize._gradientX),this._gradientY.cloneTo(destGradientSize._gradientY),this._gradientZ.cloneTo(destGradientSize._gradientZ),destGradientSize._constantMin=this._constantMin,destGradientSize._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(destGradientSize._constantMinSeparate),this._constantMaxSeparate.cloneTo(destGradientSize._constantMaxSeparate),this._gradientMin.cloneTo(destGradientSize._gradientMin),this._gradientMax.cloneTo(destGradientSize._gradientMax),this._gradientXMin.cloneTo(destGradientSize._gradientXMin),this._gradientXMax.cloneTo(destGradientSize._gradientXMax),this._gradientYMin.cloneTo(destGradientSize._gradientYMin),this._gradientYMax.cloneTo(destGradientSize._gradientYMax),this._gradientZMin.cloneTo(destGradientSize._gradientZMin),this._gradientZMax.cloneTo(destGradientSize._gradientZMax)},__proto.clone=function(){var destGradientSize=new this.constructor;return this.cloneTo(destGradientSize),destGradientSize},__getset(0,__proto,"gradientZ",function(){return this._gradientZ}),__getset(0,__proto,"gradient",function(){return this._gradient}),__getset(0,__proto,"separateAxes",function(){return this._separateAxes}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"gradientMin",function(){return this._gradientMin}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"gradientX",function(){return this._gradientX}),__getset(0,__proto,"gradientY",function(){return this._gradientY}),__getset(0,__proto,"gradientMax",function(){return this._gradientMax}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),__getset(0,__proto,"constantMinSeparate",function(){return this._constantMinSeparate}),__getset(0,__proto,"constantMaxSeparate",function(){return this._constantMaxSeparate}),__getset(0,__proto,"gradientXMin",function(){return this._gradientXMin}),__getset(0,__proto,"gradientXMax",function(){return this._gradientXMax}),__getset(0,__proto,"gradientYMin",function(){return this._gradientYMin}),__getset(0,__proto,"gradientYMax",function(){return this._gradientYMax}),__getset(0,__proto,"gradientZMin",function(){return this._gradientZMin}),__getset(0,__proto,"gradientZMax",function(){return this._gradientZMax}),GradientSize.createByGradient=function(gradient){var gradientSize=new GradientSize;return gradientSize._type=0,gradientSize._separateAxes=!1,gradientSize._gradient=gradient,gradientSize},GradientSize.createByGradientSeparate=function(gradientX,gradientY,gradientZ){var gradientSize=new GradientSize;return gradientSize._type=0,gradientSize._separateAxes=!0,gradientSize._gradientX=gradientX,gradientSize._gradientY=gradientY,gradientSize._gradientZ=gradientZ,gradientSize},GradientSize.createByRandomTwoConstant=function(constantMin,constantMax){var gradientSize=new GradientSize;return gradientSize._type=1,gradientSize._separateAxes=!1,gradientSize._constantMin=constantMin,gradientSize._constantMax=constantMax,gradientSize},GradientSize.createByRandomTwoConstantSeparate=function(constantMinSeparate,constantMaxSeparate){var gradientSize=new GradientSize;return gradientSize._type=1,gradientSize._separateAxes=!0,gradientSize._constantMinSeparate=constantMinSeparate,gradientSize._constantMaxSeparate=constantMaxSeparate,gradientSize},GradientSize.createByRandomTwoGradient=function(gradientMin,gradientMax){var gradientSize=new GradientSize;return gradientSize._type=2,gradientSize._separateAxes=!1,gradientSize._gradientMin=gradientMin,gradientSize._gradientMax=gradientMax,gradientSize},GradientSize.createByRandomTwoGradientSeparate=function(gradientXMin,gradientXMax,gradientYMin,gradientYMax,gradientZMin,gradientZMax){var gradientSize=new GradientSize;return gradientSize._type=2,gradientSize._separateAxes=!0,gradientSize._gradientXMin=gradientXMin,gradientSize._gradientXMax=gradientXMax,gradientSize._gradientYMin=gradientYMin,gradientSize._gradientYMax=gradientYMax,gradientSize._gradientZMin=gradientZMin,gradientSize._gradientZMax=gradientZMax,gradientSize},GradientSize}(),ShaderDefines=function(){function ShaderDefines(superDefines){this._counter=0,this.defines=null,superDefines?(this._counter=superDefines._counter,this.defines=superDefines.defines.slice()):(this._counter=0,this.defines=[])}return __class(ShaderDefines,"laya.d3.shader.ShaderDefines"),ShaderDefines.prototype.registerDefine=function(name){var value=Math.pow(2,this._counter++);return this.defines[value]=name,value},ShaderDefines}(),BoundFrustum=(function(){function TextureMode(){}__class(TextureMode,"laya.d3.core.TextureMode"),TextureMode.Stretch=0,TextureMode.Tile=1}(),function(){function BoundFrustum(matrix){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=matrix,this._near=new Plane(new Vector3),this._far=new Plane(new Vector3),this._left=new Plane(new Vector3),this._right=new Plane(new Vector3),this._top=new Plane(new Vector3),this._bottom=new Plane(new Vector3),BoundFrustum._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}__class(BoundFrustum,"laya.d3.math.BoundFrustum");var __proto=BoundFrustum.prototype;return __proto.equalsBoundFrustum=function(other){return this._matrix.equalsOtherMatrix(other.matrix)},__proto.equalsObj=function(obj){if(obj instanceof laya.d3.math.BoundFrustum){var bf=obj;return this.equalsBoundFrustum(bf)}return!1},__proto.getPlane=function(index){switch(index){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},__proto.getCorners=function(corners){BoundFrustum._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(corners[0]),BoundFrustum._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(corners[1]),BoundFrustum._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(corners[2]),BoundFrustum._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(corners[3]),BoundFrustum._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(corners[4]),BoundFrustum._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(corners[5]),BoundFrustum._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(corners[6]),BoundFrustum._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(corners[7])},__proto.containsPoint=function(point){for(var result=Plane.PlaneIntersectionType_Front,planeResult=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._near,point);break;case 1:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._far,point);break;case 2:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._left,point);break;case 3:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._right,point);break;case 4:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._top,point);break;case 5:planeResult=CollisionUtils.intersectsPlaneAndPoint(this._bottom,point)}switch(planeResult){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:result=Plane.PlaneIntersectionType_Intersecting}}switch(result){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},__proto.containsBoundBox=function(box){for(var plane,p=BoundFrustum._tempV30,n=BoundFrustum._tempV31,result=1,i=0;i<6;i++){if(plane=this.getPlane(i),this._getBoxToPlanePVertexNVertex(box,plane.normal,p,n),CollisionUtils.intersectsPlaneAndPoint(plane,p)===Plane.PlaneIntersectionType_Back)return 0;CollisionUtils.intersectsPlaneAndPoint(plane,n)===Plane.PlaneIntersectionType_Back&&(result=2)}return result},__proto.containsBoundSphere=function(sphere){for(var result=Plane.PlaneIntersectionType_Front,planeResult=Plane.PlaneIntersectionType_Front,i=0;i<6;i++){switch(i){case 0:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._near,sphere);break;case 1:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._far,sphere);break;case 2:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._left,sphere);break;case 3:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._right,sphere);break;case 4:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._top,sphere);break;case 5:planeResult=CollisionUtils.intersectsPlaneAndSphere(this._bottom,sphere)}switch(planeResult){case Plane.PlaneIntersectionType_Back:return 0;case Plane.PlaneIntersectionType_Intersecting:result=Plane.PlaneIntersectionType_Intersecting}}switch(result){case Plane.PlaneIntersectionType_Intersecting:return 2;default:return 1}},__proto._getBoxToPlanePVertexNVertex=function(box,planeNormal,outP,outN){var boxMin=box.min,boxMinE=boxMin.elements,boxMax=box.max,boxMaxE=boxMax.elements,planeNorE=planeNormal.elements,planeNorEX=planeNorE[0],planeNorEY=planeNorE[1],planeNorEZ=planeNorE[2];boxMin.cloneTo(outP);var outPE=outP.elements;planeNorEX>=0&&(outPE[0]=boxMaxE[0]),planeNorEY>=0&&(outPE[1]=boxMaxE[1]),planeNorEZ>=0&&(outPE[2]=boxMaxE[2]),boxMax.cloneTo(outN);var outNE=outN.elements;planeNorEX>=0&&(outNE[0]=boxMinE[0]),planeNorEY>=0&&(outNE[1]=boxMinE[1]),planeNorEZ>=0&&(outNE[2]=boxMinE[2])},__getset(0,__proto,"top",function(){return this._top}),__getset(0,__proto,"matrix",function(){return this._matrix},function(matrix){this._matrix=matrix,BoundFrustum._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),__getset(0,__proto,"near",function(){return this._near}),__getset(0,__proto,"far",function(){return this._far}),__getset(0,__proto,"left",function(){return this._left}),__getset(0,__proto,"right",function(){return this._right}),__getset(0,__proto,"bottom",function(){return this._bottom}),BoundFrustum._getPlanesFromMatrix=function(m,np,fp,lp,rp,tp,bp){var matrixE=m.elements,m11=matrixE[0],m12=matrixE[1],m13=matrixE[2],m14=matrixE[3],m21=matrixE[4],m22=matrixE[5],m23=matrixE[6],m24=matrixE[7],m31=matrixE[8],m32=matrixE[9],m33=matrixE[10],m34=matrixE[11],m41=matrixE[12],m42=matrixE[13],m43=matrixE[14],m44=matrixE[15],nearNorE=np.normal.elements;nearNorE[0]=m14+m13,nearNorE[1]=m24+m23,nearNorE[2]=m34+m33,np.distance=m44+m43,np.normalize();var farNorE=fp.normal.elements;farNorE[0]=m14-m13,farNorE[1]=m24-m23,farNorE[2]=m34-m33,fp.distance=m44-m43,fp.normalize();var leftNorE=lp.normal.elements;leftNorE[0]=m14+m11,leftNorE[1]=m24+m21,leftNorE[2]=m34+m31,lp.distance=m44+m41,lp.normalize();var rightNorE=rp.normal.elements;rightNorE[0]=m14-m11,rightNorE[1]=m24-m21,rightNorE[2]=m34-m31,rp.distance=m44-m41,rp.normalize();var topNorE=tp.normal.elements;topNorE[0]=m14-m12,topNorE[1]=m24-m22,topNorE[2]=m34-m32,tp.distance=m44-m42,tp.normalize();var bottomNorE=bp.normal.elements;bottomNorE[0]=m14+m12,bottomNorE[1]=m24+m22,bottomNorE[2]=m34+m32,bp.distance=m44+m42,bp.normalize()},BoundFrustum._get3PlaneInterPoint=function(p1,p2,p3){var p1Nor=p1.normal,p2Nor=p2.normal,p3Nor=p3.normal;Vector3.cross(p2Nor,p3Nor,BoundFrustum._tempV30),Vector3.cross(p3Nor,p1Nor,BoundFrustum._tempV31),Vector3.cross(p1Nor,p2Nor,BoundFrustum._tempV32);var a=Vector3.dot(p1Nor,BoundFrustum._tempV30),b=Vector3.dot(p2Nor,BoundFrustum._tempV31),c=Vector3.dot(p3Nor,BoundFrustum._tempV32);return Vector3.scale(BoundFrustum._tempV30,-p1.distance/a,BoundFrustum._tempV33),Vector3.scale(BoundFrustum._tempV31,-p2.distance/b,BoundFrustum._tempV34),Vector3.scale(BoundFrustum._tempV32,-p3.distance/c,BoundFrustum._tempV35),Vector3.add(BoundFrustum._tempV33,BoundFrustum._tempV34,BoundFrustum._tempV36),Vector3.add(BoundFrustum._tempV35,BoundFrustum._tempV36,BoundFrustum._tempV37),BoundFrustum._tempV37},__static(BoundFrustum,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3},"_tempV33",function(){return this._tempV33=new Vector3},"_tempV34",function(){return this._tempV34=new Vector3},"_tempV35",function(){return this._tempV35=new Vector3},"_tempV36",function(){return this._tempV36=new Vector3},"_tempV37",function(){return this._tempV37=new Vector3}]),BoundFrustum}()),Color=function(){function Color(r,g,b,a){this.elements=null,void 0===r&&(r=1),void 0===g&&(g=1),void 0===b&&(b=1),void 0===a&&(a=1);var v=this.elements=new Float32Array(4);v[0]=r,v[1]=g,v[2]=b,v[3]=a}__class(Color,"laya.d3.math.Color");var __proto=Color.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destE=destObject.elements,s=this.elements;destE[0]=s[0],destE[1]=s[1],destE[2]=s[2],destE[3]=s[3]},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__getset(0,__proto,"b",function(){return this.elements[2]},function(value){this.elements[2]=value}),__getset(0,__proto,"r",function(){return this.elements[0]},function(value){this.elements[0]=value}),__getset(0,__proto,"g",function(){return this.elements[1]},function(value){this.elements[1]=value}),__getset(0,__proto,"a",function(){return this.elements[3]},function(value){this.elements[3]=value}),__static(Color,["RED",function(){return this.RED=new Color(1,0,0,1)},"GREEN",function(){return this.GREEN=new Color(0,1,0,1)},"BLUE",function(){return this.BLUE=new Color(0,0,1,1)},"CYAN",function(){return this.CYAN=new Color(0,1,1,1)},"YELLOW",function(){return this.YELLOW=new Color(1,.92,.016,1)},"MAGENTA",function(){return this.MAGENTA=new Color(1,0,1,1)},"GRAY",function(){return this.GRAY=new Color(.5,.5,.5,1)},"WHITE",function(){return this.WHITE=new Color(1,1,1,1)},"BLACK",function(){return this.BLACK=new Color(0,0,0,1)}]),Color}(),Burst=function(){function Burst(time,minCount,maxCount){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=time,this._minCount=minCount,this._maxCount=maxCount}__class(Burst,"laya.d3.core.particleShuriKen.module.Burst");var __proto=Burst.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destBurst=destObject;destBurst._time=this._time,destBurst._minCount=this._minCount,destBurst._maxCount=this._maxCount},__proto.clone=function(){var destBurst=new this.constructor;return this.cloneTo(destBurst),destBurst},__getset(0,__proto,"time",function(){return this._time}),__getset(0,__proto,"minCount",function(){return this._minCount}),__getset(0,__proto,"maxCount",function(){return this._maxCount}),Burst}(),DetailTextureInfo=function(){function DetailTextureInfo(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return __class(DetailTextureInfo,"laya.d3.terrain.unit.DetailTextureInfo"),DetailTextureInfo}(),Utils3D=function(){function Utils3D(){}return __class(Utils3D,"laya.d3.utils.Utils3D"),Utils3D._convertToLayaVec3=function(bVector,out,inverseX){var outE=out.elements;outE[0]=inverseX?-bVector.x():bVector.x(),outE[1]=bVector.y(),outE[2]=bVector.z()},Utils3D._convertToBulletVec3=function(lVector,out,inverseX){var lVectorE=lVector.elements;out.setValue(inverseX?-lVectorE[0]:lVectorE[0],lVectorE[1],lVectorE[2])},Utils3D._rotationTransformScaleSkinAnimation=function(tx,ty,tz,qx,qy,qz,qw,sx,sy,sz,outArray,outOffset){var i,ai0,ai1,ai2,ai3,re=Utils3D._tempArray16_0,se=Utils3D._tempArray16_1,tse=Utils3D._tempArray16_2,x2=qx+qx,y2=qy+qy,z2=qz+qz,xx=qx*x2,yx=qy*x2,yy=qy*y2,zx=qz*x2,zy=qz*y2,zz=qz*z2,wx=qw*x2,wy=qw*y2,wz=qw*z2;for(re[15]=1,re[0]=1-yy-zz,re[1]=yx+wz,re[2]=zx-wy,re[4]=yx-wz,re[5]=1-xx-zz,re[6]=zy+wx,re[8]=zx+wy,re[9]=zy-wx,re[10]=1-xx-yy,se[15]=1,se[0]=sx,se[5]=sy,se[10]=sz,i=0;i<4;i++)ai0=re[i],ai1=re[i+4],ai2=re[i+8],ai3=re[i+12],tse[i]=ai0,tse[i+4]=ai1,tse[i+8]=ai2,tse[i+12]=ai0*tx+ai1*ty+ai2*tz+ai3;for(i=0;i<4;i++)ai0=tse[i],ai1=tse[i+4],ai2=tse[i+8],ai3=tse[i+12],outArray[i+outOffset]=ai0*se[0]+ai1*se[1]+ai2*se[2]+ai3*se[3],outArray[i+outOffset+4]=ai0*se[4]+ai1*se[5]+ai2*se[6]+ai3*se[7],outArray[i+outOffset+8]=ai0*se[8]+ai1*se[9]+ai2*se[10]+ai3*se[11],outArray[i+outOffset+12]=ai0*se[12]+ai1*se[13]+ai2*se[14]+ai3*se[15]},Utils3D._createSceneByJsonForMaker=function(nodeData,outBatchSprites,initTool){var scene3d=Utils3D._createNodeByJsonForMaker(nodeData,outBatchSprites,initTool);return Utils3D._addComponentByJsonForMaker(nodeData,outBatchSprites,initTool),scene3d},Utils3D._createNodeByJsonForMaker=function(nodeData,outBatchSprites,initTool){var node;switch(nodeData.type){case"Scene3D":node=new Scene3D;break;case"Sprite3D":node=new Sprite3D;break;case"MeshSprite3D":node=new MeshSprite3D,outBatchSprites&&outBatchSprites.push(node);break;case"SkinnedMeshSprite3D":node=new SkinnedMeshSprite3D;break;case"ShuriKenParticle3D":node=new ShuriKenParticle3D;break;case"Terrain":node=new Terrain;break;case"Camera":node=new Camera;break;case"DirectionLight":node=new DirectionLight;break;case"PointLight":node=new PointLight;break;case"SpotLight":node=new SpotLight;break;case"TrailSprite3D":node=new TrailSprite3D;break;default:var clas=ClassUtils.getClass(nodeData.props.runtime);node=new clas}var childData=nodeData.child;if(childData)for(var i=0,n=childData.length;i<n;i++){var child=Utils3D._createNodeByJsonForMaker(childData[i],outBatchSprites,initTool);node.addChild(child)}var compId=nodeData.compId;node.compId=compId,node._parse(nodeData.props),initTool&&(initTool._idMap[compId]=node),Utils3D._compIdToNode[compId]=node;var componentsData=nodeData.components;if(componentsData)for(var j=0,m=componentsData.length;j<m;j++){var data=componentsData[j];if(!(clas=Browser.window.Laya[data.type]))clas=Browser.window,data.type.split(".").forEach(function(cls){clas=clas[cls]});if("function"==typeof clas){var comp=new clas;initTool&&(initTool._idMap[data.compId]=comp,console.log(data.compId))}else console.warn("Utils3D:Unkown component type.")}return node},Utils3D._addComponentByJsonForMaker=function(nodeData,outBatchSprites,initTool){var compId=nodeData.compId,node=Utils3D._compIdToNode[compId],childData=nodeData.child;if(childData)for(var i=0,n=childData.length;i<n;i++)Utils3D._addComponentByJsonForMaker(childData[i],outBatchSprites,initTool);var componentsData=nodeData.components;if(componentsData)for(var j=0,m=componentsData.length;j<m;j++){var data=componentsData[j];if(!(clas=Browser.window.Laya[data.type])){var clasPaths=data.type.split("."),clas=Browser.window;clasPaths.forEach(function(cls){clas=clas[cls]})}if("function"==typeof clas){var component=initTool._idMap[data.compId];node.addComponentIntance(component),component._parse(data)}else console.warn("Utils3D:Unkown component type.")}},Utils3D._createNodeByJson=function(nodeData,outBatchSprites){var node;switch(nodeData.type){case"Scene3D":node=new Scene3D;break;case"Sprite3D":node=new Sprite3D;break;case"MeshSprite3D":node=new MeshSprite3D,outBatchSprites&&outBatchSprites.push(node);break;case"SkinnedMeshSprite3D":node=new SkinnedMeshSprite3D;break;case"ShuriKenParticle3D":node=new ShuriKenParticle3D;break;case"Terrain":node=new Terrain;break;case"Camera":node=new Camera;break;case"DirectionLight":node=new DirectionLight;break;case"PointLight":node=new PointLight;break;case"SpotLight":node=new SpotLight;break;case"TrailSprite3D":node=new TrailSprite3D;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var childData=nodeData.child;if(childData)for(var i=0,n=childData.length;i<n;i++){var child=Utils3D._createNodeByJson(childData[i],outBatchSprites);node.addChild(child)}var componentsData=nodeData.components;if(componentsData)for(var j=0,m=componentsData.length;j<m;j++){var data=componentsData[j];if(!(clas=Browser.window.Laya[data.type])){var clasPaths=data.type.split("."),clas=Browser.window;clasPaths.forEach(function(cls){clas=clas[cls]})}if("function"==typeof clas)node.addComponent(clas)._parse(data);else console.warn("Unkown component type.")}return node._parse(nodeData.props),node},Utils3D._computeBoneAndAnimationDatasByBindPoseMatrxix=function(bones,curData,inverGlobalBindPose,outBonesDatas,outAnimationDatas,boneIndexToMesh){var i,parentOffset,offset=0,matOffset=0,boneLength=bones.length;for(i=0;i<boneLength;offset+=bones[i].keyframeWidth,matOffset+=16,i++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(curData[offset+0],curData[offset+1],curData[offset+2],curData[offset+3],curData[offset+4],curData[offset+5],curData[offset+6],curData[offset+7],curData[offset+8],curData[offset+9],outBonesDatas,matOffset),0!=i&&(parentOffset=16*bones[i].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(outBonesDatas,parentOffset,outBonesDatas,matOffset,outBonesDatas,matOffset));var n=inverGlobalBindPose.length;for(i=0;i<n;i++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(outBonesDatas,16*boneIndexToMesh[i],inverGlobalBindPose[i],outAnimationDatas,16*i)},Utils3D._computeAnimationDatasByArrayAndMatrixFast=function(inverGlobalBindPose,bonesDatas,outAnimationDatas,boneIndexToMesh){for(var i=0,n=inverGlobalBindPose.length;i<n;i++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(bonesDatas,16*boneIndexToMesh[i],inverGlobalBindPose[i],outAnimationDatas,16*i)},Utils3D._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(bones,curData,inverGlobalBindPose,outBonesDatas,outAnimationDatas){var i,parentOffset,offset=0,matOffset=0,boneLength=bones.length;for(i=0;i<boneLength;offset+=bones[i].keyframeWidth,matOffset+=16,i++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(curData[offset+7],curData[offset+8],curData[offset+9],curData[offset+3],curData[offset+4],curData[offset+5],curData[offset+6],curData[offset+0],curData[offset+1],curData[offset+2],outBonesDatas,matOffset),0!=i&&(parentOffset=16*bones[i].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(outBonesDatas,parentOffset,outBonesDatas,matOffset,outBonesDatas,matOffset));var n=inverGlobalBindPose.length;for(i=0;i<n;i++){var arrayOffset=16*i;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(outBonesDatas,arrayOffset,inverGlobalBindPose[i],outAnimationDatas,arrayOffset)}},Utils3D._computeAnimationDatasByArrayAndMatrixFastOld=function(inverGlobalBindPose,bonesDatas,outAnimationDatas){for(var n=inverGlobalBindPose.length,i=0;i<n;i++){var arrayOffset=16*i;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(bonesDatas,arrayOffset,inverGlobalBindPose[i],outAnimationDatas,arrayOffset)}},Utils3D._computeRootAnimationData=function(bones,curData,animationDatas){for(var i=0,offset=0,matOffset=0,boneLength=bones.length;i<boneLength;offset+=bones[i].keyframeWidth,matOffset+=16,i++)laya.d3.utils.Utils3D.createAffineTransformationArray(curData[offset+0],curData[offset+1],curData[offset+2],curData[offset+3],curData[offset+4],curData[offset+5],curData[offset+6],curData[offset+7],curData[offset+8],curData[offset+9],animationDatas,matOffset)},Utils3D.transformVector3ArrayByQuat=function(sourceArray,sourceOffset,rotation,outArray,outOffset){var re=rotation.elements,x=sourceArray[sourceOffset],y=sourceArray[sourceOffset+1],z=sourceArray[sourceOffset+2],qx=re[0],qy=re[1],qz=re[2],qw=re[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;outArray[outOffset]=ix*qw+iw*-qx+iy*-qz-iz*-qy,outArray[outOffset+1]=iy*qw+iw*-qy+iz*-qx-ix*-qz,outArray[outOffset+2]=iz*qw+iw*-qz+ix*-qy-iy*-qx},Utils3D.mulMatrixByArray=function(leftArray,leftOffset,rightArray,rightOffset,outArray,outOffset){var i,ai0,ai1,ai2,ai3;if(outArray===rightArray){for(rightArray=Utils3D._tempArray16_3,i=0;i<16;++i)rightArray[i]=outArray[outOffset+i];rightOffset=0}for(i=0;i<4;i++)ai0=leftArray[leftOffset+i],ai1=leftArray[leftOffset+i+4],ai2=leftArray[leftOffset+i+8],ai3=leftArray[leftOffset+i+12],outArray[outOffset+i]=ai0*rightArray[rightOffset+0]+ai1*rightArray[rightOffset+1]+ai2*rightArray[rightOffset+2]+ai3*rightArray[rightOffset+3],outArray[outOffset+i+4]=ai0*rightArray[rightOffset+4]+ai1*rightArray[rightOffset+5]+ai2*rightArray[rightOffset+6]+ai3*rightArray[rightOffset+7],outArray[outOffset+i+8]=ai0*rightArray[rightOffset+8]+ai1*rightArray[rightOffset+9]+ai2*rightArray[rightOffset+10]+ai3*rightArray[rightOffset+11],outArray[outOffset+i+12]=ai0*rightArray[rightOffset+12]+ai1*rightArray[rightOffset+13]+ai2*rightArray[rightOffset+14]+ai3*rightArray[rightOffset+15]},Utils3D.mulMatrixByArrayFast=function(leftArray,leftOffset,rightArray,rightOffset,outArray,outOffset){var i,ai0,ai1,ai2,ai3;for(i=0;i<4;i++)ai0=leftArray[leftOffset+i],ai1=leftArray[leftOffset+i+4],ai2=leftArray[leftOffset+i+8],ai3=leftArray[leftOffset+i+12],outArray[outOffset+i]=ai0*rightArray[rightOffset+0]+ai1*rightArray[rightOffset+1]+ai2*rightArray[rightOffset+2]+ai3*rightArray[rightOffset+3],outArray[outOffset+i+4]=ai0*rightArray[rightOffset+4]+ai1*rightArray[rightOffset+5]+ai2*rightArray[rightOffset+6]+ai3*rightArray[rightOffset+7],outArray[outOffset+i+8]=ai0*rightArray[rightOffset+8]+ai1*rightArray[rightOffset+9]+ai2*rightArray[rightOffset+10]+ai3*rightArray[rightOffset+11],outArray[outOffset+i+12]=ai0*rightArray[rightOffset+12]+ai1*rightArray[rightOffset+13]+ai2*rightArray[rightOffset+14]+ai3*rightArray[rightOffset+15]},Utils3D.mulMatrixByArrayAndMatrixFast=function(leftArray,leftOffset,rightMatrix,outArray,outOffset){var i,ai0,ai1,ai2,ai3,rightMatrixE=rightMatrix.elements,m11=rightMatrixE[0],m12=rightMatrixE[1],m13=rightMatrixE[2],m14=rightMatrixE[3],m21=rightMatrixE[4],m22=rightMatrixE[5],m23=rightMatrixE[6],m24=rightMatrixE[7],m31=rightMatrixE[8],m32=rightMatrixE[9],m33=rightMatrixE[10],m34=rightMatrixE[11],m41=rightMatrixE[12],m42=rightMatrixE[13],m43=rightMatrixE[14],m44=rightMatrixE[15],ai0LeftOffset=leftOffset,ai1LeftOffset=leftOffset+4,ai2LeftOffset=leftOffset+8,ai3LeftOffset=leftOffset+12,ai0OutOffset=outOffset,ai1OutOffset=outOffset+4,ai2OutOffset=outOffset+8,ai3OutOffset=outOffset+12;for(i=0;i<4;i++)ai0=leftArray[ai0LeftOffset+i],ai1=leftArray[ai1LeftOffset+i],ai2=leftArray[ai2LeftOffset+i],ai3=leftArray[ai3LeftOffset+i],outArray[ai0OutOffset+i]=ai0*m11+ai1*m12+ai2*m13+ai3*m14,outArray[ai1OutOffset+i]=ai0*m21+ai1*m22+ai2*m23+ai3*m24,outArray[ai2OutOffset+i]=ai0*m31+ai1*m32+ai2*m33+ai3*m34,outArray[ai3OutOffset+i]=ai0*m41+ai1*m42+ai2*m43+ai3*m44},Utils3D.createAffineTransformationArray=function(tX,tY,tZ,rX,rY,rZ,rW,sX,sY,sZ,outArray,outOffset){var x2=rX+rX,y2=rY+rY,z2=rZ+rZ,xx=rX*x2,xy=rX*y2,xz=rX*z2,yy=rY*y2,yz=rY*z2,zz=rZ*z2,wx=rW*x2,wy=rW*y2,wz=rW*z2;outArray[outOffset+0]=(1-(yy+zz))*sX,outArray[outOffset+1]=(xy+wz)*sX,outArray[outOffset+2]=(xz-wy)*sX,outArray[outOffset+3]=0,outArray[outOffset+4]=(xy-wz)*sY,outArray[outOffset+5]=(1-(xx+zz))*sY,outArray[outOffset+6]=(yz+wx)*sY,outArray[outOffset+7]=0,outArray[outOffset+8]=(xz+wy)*sZ,outArray[outOffset+9]=(yz-wx)*sZ,outArray[outOffset+10]=(1-(xx+yy))*sZ,outArray[outOffset+11]=0,outArray[outOffset+12]=tX,outArray[outOffset+13]=tY,outArray[outOffset+14]=tZ,outArray[outOffset+15]=1},Utils3D.transformVector3ArrayToVector3ArrayCoordinate=function(source,sourceOffset,transform,result,resultOffset){var coordinateX=source[sourceOffset+0],coordinateY=source[sourceOffset+1],coordinateZ=source[sourceOffset+2],transformElem=transform.elements,w=coordinateX*transformElem[3]+coordinateY*transformElem[7]+coordinateZ*transformElem[11]+transformElem[15];result[resultOffset]=coordinateX*transformElem[0]+coordinateY*transformElem[4]+coordinateZ*transformElem[8]+transformElem[12]/w,result[resultOffset+1]=coordinateX*transformElem[1]+coordinateY*transformElem[5]+coordinateZ*transformElem[9]+transformElem[13]/w,result[resultOffset+2]=coordinateX*transformElem[2]+coordinateY*transformElem[6]+coordinateZ*transformElem[10]+transformElem[14]/w},Utils3D.transformLightingMapTexcoordArray=function(source,sourceOffset,lightingMapScaleOffset,result,resultOffset){var lightingMapScaleOffsetE=lightingMapScaleOffset.elements;result[resultOffset+0]=source[sourceOffset+0]*lightingMapScaleOffsetE[0]+lightingMapScaleOffsetE[2],result[resultOffset+1]=1-((1-source[sourceOffset+1])*lightingMapScaleOffsetE[1]+lightingMapScaleOffsetE[3])},Utils3D.getURLVerion=function(url){var index=url.indexOf("?");return index>=0?url.substr(index):null},Utils3D._quaternionCreateFromYawPitchRollArray=function(yaw,pitch,roll,out){var halfRoll=.5*roll,halfPitch=.5*pitch,halfYaw=.5*yaw,sinRoll=Math.sin(halfRoll),cosRoll=Math.cos(halfRoll),sinPitch=Math.sin(halfPitch),cosPitch=Math.cos(halfPitch),sinYaw=Math.sin(halfYaw),cosYaw=Math.cos(halfYaw);out[0]=cosYaw*sinPitch*cosRoll+sinYaw*cosPitch*sinRoll,out[1]=sinYaw*cosPitch*cosRoll-cosYaw*sinPitch*sinRoll,out[2]=cosYaw*cosPitch*sinRoll-sinYaw*sinPitch*cosRoll,out[3]=cosYaw*cosPitch*cosRoll+sinYaw*sinPitch*sinRoll},Utils3D._createAffineTransformationArray=function(trans,rot,scale,outE){var x=rot[0],y=rot[1],z=rot[2],w=rot[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,sx=scale[0],sy=scale[1],sz=scale[2];outE[0]=(1-(yy+zz))*sx,outE[1]=(xy+wz)*sx,outE[2]=(xz-wy)*sx,outE[3]=0,outE[4]=(xy-wz)*sy,outE[5]=(1-(xx+zz))*sy,outE[6]=(yz+wx)*sy,outE[7]=0,outE[8]=(xz+wy)*sz,outE[9]=(yz-wx)*sz,outE[10]=(1-(xx+yy))*sz,outE[11]=0,outE[12]=trans[0],outE[13]=trans[1],outE[14]=trans[2],outE[15]=1},Utils3D._mulMatrixArray=function(leftMatrixE,rightMatrix,outArray,outOffset){var i,ai0,ai1,ai2,ai3,rightMatrixE=rightMatrix.elements,m11=rightMatrixE[0],m12=rightMatrixE[1],m13=rightMatrixE[2],m14=rightMatrixE[3],m21=rightMatrixE[4],m22=rightMatrixE[5],m23=rightMatrixE[6],m24=rightMatrixE[7],m31=rightMatrixE[8],m32=rightMatrixE[9],m33=rightMatrixE[10],m34=rightMatrixE[11],m41=rightMatrixE[12],m42=rightMatrixE[13],m43=rightMatrixE[14],m44=rightMatrixE[15],ai0OutOffset=outOffset,ai1OutOffset=outOffset+4,ai2OutOffset=outOffset+8,ai3OutOffset=outOffset+12;for(i=0;i<4;i++)ai0=leftMatrixE[i],ai1=leftMatrixE[i+4],ai2=leftMatrixE[i+8],ai3=leftMatrixE[i+12],outArray[ai0OutOffset+i]=ai0*m11+ai1*m12+ai2*m13+ai3*m14,outArray[ai1OutOffset+i]=ai0*m21+ai1*m22+ai2*m23+ai3*m24,outArray[ai2OutOffset+i]=ai0*m31+ai1*m32+ai2*m33+ai3*m34,outArray[ai3OutOffset+i]=ai0*m41+ai1*m42+ai2*m43+ai3*m44},Utils3D.getYawPitchRoll=function(quaternion,out){Utils3D.transformQuat(Vector3.ForwardRH,quaternion,Quaternion.TEMPVector31),Utils3D.transformQuat(Vector3.Up,quaternion,Quaternion.TEMPVector32);var upe=Quaternion.TEMPVector32.elements;Utils3D.angleTo(Vector3.ZERO,Quaternion.TEMPVector31,Quaternion.TEMPVector33);var anglee=Quaternion.TEMPVector33.elements;anglee[0]==Math.PI/2?(anglee[1]=Utils3D.arcTanAngle(upe[2],upe[0]),anglee[2]=0):anglee[0]==-Math.PI/2?(anglee[1]=Utils3D.arcTanAngle(-upe[2],-upe[0]),anglee[2]=0):(Matrix4x4.createRotationY(-anglee[1],Quaternion.TEMPMatrix0),Matrix4x4.createRotationX(-anglee[0],Quaternion.TEMPMatrix1),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix0,Quaternion.TEMPVector32),Vector3.transformCoordinate(Quaternion.TEMPVector32,Quaternion.TEMPMatrix1,Quaternion.TEMPVector32),anglee[2]=Utils3D.arcTanAngle(upe[1],-upe[0])),anglee[1]<=-Math.PI&&(anglee[1]=Math.PI),anglee[2]<=-Math.PI&&(anglee[2]=Math.PI),anglee[1]>=Math.PI&&anglee[2]>=Math.PI&&(anglee[1]=0,anglee[2]=0,anglee[0]=Math.PI-anglee[0]),out[0]=anglee[1],out[1]=anglee[0],out[2]=anglee[2]},Utils3D.arcTanAngle=function(x,y){return 0==x?1==y?Math.PI/2:-Math.PI/2:x>0?Math.atan(y/x):x<0?y>0?Math.atan(y/x)+Math.PI:Math.atan(y/x)-Math.PI:0},Utils3D.angleTo=function(from,location,angle){Vector3.subtract(location,from,Quaternion.TEMPVector30),Vector3.normalize(Quaternion.TEMPVector30,Quaternion.TEMPVector30),angle.elements[0]=Math.asin(Quaternion.TEMPVector30.y),angle.elements[1]=Utils3D.arcTanAngle(-Quaternion.TEMPVector30.z,-Quaternion.TEMPVector30.x)},Utils3D.transformQuat=function(source,rotation,out){var destination=out.elements,se=source.elements,re=rotation,x=se[0],y=se[1],z=se[2],qx=re[0],qy=re[1],qz=re[2],qw=re[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;destination[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy,destination[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz,destination[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx},Utils3D.quaterionNormalize=function(f,e){var x=f[0],y=f[1],z=f[2],w=f[3],len=x*x+y*y+z*z+w*w;len>0&&(len=1/Math.sqrt(len),e[0]=x*len,e[1]=y*len,e[2]=z*len,e[3]=w*len)},Utils3D.quaterionSlerp=function(left,right,t,out){var omega,cosom,sinom,scale0,scale1,ax=left[0],ay=left[1],az=left[2],aw=left[3],bx=right[0],by=right[1],bz=right[2],bw=right[3];(cosom=ax*bx+ay*by+az*bz+aw*bw)<0&&(cosom=-cosom,bx=-bx,by=-by,bz=-bz,bw=-bw),1-cosom>1e-6?(omega=Math.acos(cosom),sinom=Math.sin(omega),scale0=Math.sin((1-t)*omega)/sinom,scale1=Math.sin(t*omega)/sinom):(scale0=1-t,scale1=t),out[0]=scale0*ax+scale1*bx,out[1]=scale0*ay+scale1*by,out[2]=scale0*az+scale1*bz,out[3]=scale0*aw+scale1*bw},Utils3D.quaternionMultiply=function(le,re,oe){var lx=le[0],ly=le[1],lz=le[2],lw=le[3],rx=re[0],ry=re[1],rz=re[2],rw=re[3],a=ly*rz-lz*ry,b=lz*rx-lx*rz,c=lx*ry-ly*rx,d=lx*rx+ly*ry+lz*rz;oe[0]=lx*rw+rx*lw+a,oe[1]=ly*rw+ry*lw+b,oe[2]=lz*rw+rz*lw+c,oe[3]=lw*rw-d},Utils3D.quaternionWeight=function(f,weight,e){e[0]=f[0]*weight,e[1]=f[1]*weight,e[2]=f[2]*weight,e[3]=f[3]},Utils3D.quaternionInvert=function(f,e){var a0=f[0],a1=f[1],a2=f[2],a3=f[3],dot=a0*a0+a1*a1+a2*a2+a3*a3,invDot=dot?1/dot:0;e[0]=-a0*invDot,e[1]=-a1*invDot,e[2]=-a2*invDot,e[3]=a3*invDot},Utils3D.quaternionConjugate=function(value,offset,result){result[0]=-value[offset],result[1]=-value[offset+1],result[2]=-value[offset+2],result[3]=value[offset+3]},Utils3D.scaleWeight=function(s,w,out){var sX=s[0],sY=s[1],sZ=s[2];out[0]=sX>0?Math.pow(Math.abs(sX),w):-Math.pow(Math.abs(sX),w),out[1]=sY>0?Math.pow(Math.abs(sY),w):-Math.pow(Math.abs(sY),w),out[2]=sZ>0?Math.pow(Math.abs(sZ),w):-Math.pow(Math.abs(sZ),w)},Utils3D.scaleBlend=function(sa,sb,w,out){var saw=Utils3D._tempVector3Array0,sbw=Utils3D._tempVector3Array1;Utils3D.scaleWeight(sa,1-w,saw),Utils3D.scaleWeight(sb,w,sbw);var sng=w>.5?sb:sa;out[0]=sng[0]>0?Math.abs(saw[0]*sbw[0]):-Math.abs(saw[0]*sbw[0]),out[1]=sng[1]>0?Math.abs(saw[1]*sbw[1]):-Math.abs(saw[1]*sbw[1]),out[2]=sng[2]>0?Math.abs(saw[2]*sbw[2]):-Math.abs(saw[2]*sbw[2])},Utils3D.matrix4x4MultiplyFFF=function(a,b,e){var i,ai0,ai1,ai2,ai3;if(e===b)for(b=new Float32Array(16),i=0;i<16;++i)b[i]=e[i];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5],b6=b[6],b7=b[7],b8=b[8],b9=b[9],b10=b[10],b11=b[11],b12=b[12],b13=b[13],b14=b[14],b15=b[15];for(i=0;i<4;i++)ai0=a[i],ai1=a[i+4],ai2=a[i+8],ai3=a[i+12],e[i]=ai0*b0+ai1*b1+ai2*b2+ai3*b3,e[i+4]=ai0*b4+ai1*b5+ai2*b6+ai3*b7,e[i+8]=ai0*b8+ai1*b9+ai2*b10+ai3*b11,e[i+12]=ai0*b12+ai1*b13+ai2*b14+ai3*b15},Utils3D.matrix4x4MultiplyFFFForNative=function(a,b,e){LayaGL.instance.matrix4x4Multiply(a,b,e)},Utils3D.matrix4x4MultiplyMFM=function(left,right,out){Utils3D.matrix4x4MultiplyFFF(left.elements,right,out.elements)},Utils3D._buildTexture2D=function(width,height,format,colorFunc,mipmaps){void 0===mipmaps&&(mipmaps=!1);var texture=new Texture2D(width,height,format,mipmaps,!0);return texture.anisoLevel=1,texture.filterMode=0,TextureGenerator._generateTexture2D(texture,width,height,colorFunc),texture},Utils3D._tempVector3Array0=new Float32Array(3),Utils3D._tempVector3Array1=new Float32Array(3),Utils3D._tempArray4_0=new Float32Array(4),Utils3D._tempArray16_0=new Float32Array(16),Utils3D._tempArray16_1=new Float32Array(16),Utils3D._tempArray16_2=new Float32Array(16),Utils3D._tempArray16_3=new Float32Array(16),__static(Utils3D,["_tempVector3_0",function(){return this._tempVector3_0=new Vector3},"_tempVector3_1",function(){return this._tempVector3_1=new Vector3},"_tempVector3_2",function(){return this._tempVector3_2=new Vector3},"_tempVector3_3",function(){return this._tempVector3_3=new Vector3},"_tempVector3_4",function(){return this._tempVector3_4=new Vector3},"_tempVector3_5",function(){return this._tempVector3_5=new Vector3},"_tempVector3_6",function(){return this._tempVector3_6=new Vector3},"_compIdToNode",function(){return this._compIdToNode=new Object}]),Utils3D}(),LoadModelV05=(function(){function ContainmentType(){}__class(ContainmentType,"laya.d3.math.ContainmentType"),ContainmentType.Disjoint=0,ContainmentType.Contains=1,ContainmentType.Intersects=2}(),function(){function LoadModelV05(){}return __class(LoadModelV05,"laya.d3.loaders.LoadModelV05"),LoadModelV05.parse=function(readData,version,mesh,subMeshes){LoadModelV05._mesh=mesh,LoadModelV05._subMeshes=subMeshes,LoadModelV05._version=version,LoadModelV05._readData=readData,LoadModelV05.READ_DATA(),LoadModelV05.READ_BLOCK(),LoadModelV05.READ_STRINGS();for(var i=0,n=LoadModelV05._BLOCK.count;i<n;i++){LoadModelV05._readData.pos=LoadModelV05._BLOCK.blockStarts[i];var index=LoadModelV05._readData.getUint16(),blockName=LoadModelV05._strings[index],fn=LoadModelV05["READ_"+blockName];if(null==fn)throw new Error("model file err,no this function:"+index+" "+blockName);fn.call()}LoadModelV05._mesh._bindPoseIndices=new Uint16Array(LoadModelV05._bindPoseIndices),LoadModelV05._bindPoseIndices.length=0,LoadModelV05._strings.length=0,LoadModelV05._readData=null,LoadModelV05._version=null,LoadModelV05._mesh=null,LoadModelV05._subMeshes=null},LoadModelV05._readString=function(){return LoadModelV05._strings[LoadModelV05._readData.getUint16()]},LoadModelV05.READ_DATA=function(){LoadModelV05._DATA.offset=LoadModelV05._readData.getUint32(),LoadModelV05._DATA.size=LoadModelV05._readData.getUint32()},LoadModelV05.READ_BLOCK=function(){for(var count=LoadModelV05._BLOCK.count=LoadModelV05._readData.getUint16(),blockStarts=LoadModelV05._BLOCK.blockStarts=[],blockLengths=LoadModelV05._BLOCK.blockLengths=[],i=0;i<count;i++)blockStarts.push(LoadModelV05._readData.getUint32()),blockLengths.push(LoadModelV05._readData.getUint32())},LoadModelV05.READ_STRINGS=function(){var offset=LoadModelV05._readData.getUint32(),count=LoadModelV05._readData.getUint16(),prePos=LoadModelV05._readData.pos;LoadModelV05._readData.pos=offset+LoadModelV05._DATA.offset;for(var i=0;i<count;i++)LoadModelV05._strings[i]=LoadModelV05._readData.readUTFString();LoadModelV05._readData.pos=prePos},LoadModelV05.READ_MESH=function(){var i=0,memorySize=0,arrayBuffer=(LoadModelV05._readString(),LoadModelV05._readData.__getBuffer()),vertexBufferCount=LoadModelV05._readData.getInt16(),offset=LoadModelV05._DATA.offset;for(i=0;i<vertexBufferCount;i++){var vbStart=offset+LoadModelV05._readData.getUint32(),vertexCount=LoadModelV05._readData.getUint32(),vertexFlag=LoadModelV05._readString(),vertexDeclaration=VertexMesh.getVertexDeclaration(vertexFlag,!1),vertexStride=vertexDeclaration.vertexStride,vertexData=new ArrayBuffer(vertexStride*vertexCount),floatData=new Float32Array(vertexData),subVertexFlags=vertexFlag.split(","),subVertexCount=subVertexFlags.length;switch(LoadModelV05._version){case"LAYAMODEL:05":floatData=new Float32Array(arrayBuffer.slice(vbStart,vbStart+vertexCount*vertexStride));break;case"LAYAMODEL:COMPRESSION_05":var lastPosition=LoadModelV05._readData.pos;floatData=new Float32Array(vertexData);var uint8Data=new Uint8Array(vertexData);LoadModelV05._readData.pos=vbStart;for(var j=0;j<vertexCount;j++)for(var subOffset=0,verOffset=j*vertexStride,k=0;k<subVertexCount;k++)switch(subVertexFlags[k]){case"POSITION":floatData[subOffset=verOffset/4]=HalfFloatUtils.convertToNumber(LoadModelV05._readData.getUint16()),floatData[subOffset+1]=HalfFloatUtils.convertToNumber(LoadModelV05._readData.getUint16()),floatData[subOffset+2]=HalfFloatUtils.convertToNumber(LoadModelV05._readData.getUint16()),verOffset+=12;break;case"NORMAL":floatData[subOffset=verOffset/4]=LoadModelV05._readData.getUint8()/127.5-1,floatData[subOffset+1]=LoadModelV05._readData.getUint8()/127.5-1,floatData[subOffset+2]=LoadModelV05._readData.getUint8()/127.5-1,verOffset+=12;break;case"COLOR":floatData[subOffset=verOffset/4]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+1]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+2]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+3]=LoadModelV05._readData.getUint8()/255,verOffset+=16;break;case"UV":case"UV1":floatData[subOffset=verOffset/4]=HalfFloatUtils.convertToNumber(LoadModelV05._readData.getUint16()),floatData[subOffset+1]=HalfFloatUtils.convertToNumber(LoadModelV05._readData.getUint16()),verOffset+=8;break;case"BLENDWEIGHT":floatData[subOffset=verOffset/4]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+1]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+2]=LoadModelV05._readData.getUint8()/255,floatData[subOffset+3]=LoadModelV05._readData.getUint8()/255,verOffset+=16;break;case"BLENDINDICES":uint8Data[verOffset]=LoadModelV05._readData.getUint8(),uint8Data[verOffset+1]=LoadModelV05._readData.getUint8(),uint8Data[verOffset+2]=LoadModelV05._readData.getUint8(),uint8Data[verOffset+3]=LoadModelV05._readData.getUint8(),verOffset+=4;break;case"TANGENT":floatData[subOffset=verOffset/4]=LoadModelV05._readData.getUint8()/127.5-1,floatData[subOffset+1]=LoadModelV05._readData.getUint8()/127.5-1,floatData[subOffset+2]=LoadModelV05._readData.getUint8()/127.5-1,floatData[subOffset+3]=LoadModelV05._readData.getUint8()/127.5-1,verOffset+=16}LoadModelV05._readData.pos=lastPosition}var vertexBuffer=new VertexBuffer3D(vertexData.byteLength,35044,!0);vertexBuffer.vertexDeclaration=vertexDeclaration,vertexBuffer.setData(floatData),LoadModelV05._mesh._vertexBuffers.push(vertexBuffer),LoadModelV05._mesh._vertexCount+=vertexBuffer.vertexCount,memorySize+=4*floatData.length}var ibStart=offset+LoadModelV05._readData.getUint32(),ibLength=LoadModelV05._readData.getUint32(),ibDatas=new Uint16Array(arrayBuffer.slice(ibStart,ibStart+ibLength)),indexBuffer=new IndexBuffer3D("ushort",ibLength/2,35044,!0);indexBuffer.setData(ibDatas),LoadModelV05._mesh._indexBuffer=indexBuffer,memorySize+=2*indexBuffer.indexCount,LoadModelV05._mesh._setCPUMemory(memorySize),LoadModelV05._mesh._setGPUMemory(memorySize);var boneNames=LoadModelV05._mesh._boneNames=[],boneCount=LoadModelV05._readData.getUint16();for(boneNames.length=boneCount,i=0;i<boneCount;i++)boneNames[i]=LoadModelV05._strings[LoadModelV05._readData.getUint16()];var bindPoseDataStart=LoadModelV05._readData.getUint32(),bindPoseDataLength=LoadModelV05._readData.getUint32(),bindPoseDatas=new Float32Array(arrayBuffer.slice(offset+bindPoseDataStart,offset+bindPoseDataStart+bindPoseDataLength)),bindPoseFloatCount=bindPoseDatas.length,bindPoseCount=bindPoseFloatCount/16,bindPoseBuffer=LoadModelV05._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*bindPoseFloatCount);for(LoadModelV05._mesh._inverseBindPoses=__newvec(bindPoseCount),i=0;i<bindPoseFloatCount;i+=16){var inverseGlobalBindPose=new Matrix4x4(bindPoseDatas[i+0],bindPoseDatas[i+1],bindPoseDatas[i+2],bindPoseDatas[i+3],bindPoseDatas[i+4],bindPoseDatas[i+5],bindPoseDatas[i+6],bindPoseDatas[i+7],bindPoseDatas[i+8],bindPoseDatas[i+9],bindPoseDatas[i+10],bindPoseDatas[i+11],bindPoseDatas[i+12],bindPoseDatas[i+13],bindPoseDatas[i+14],bindPoseDatas[i+15],new Float32Array(bindPoseBuffer,4*i,16));LoadModelV05._mesh._inverseBindPoses[i/16]=inverseGlobalBindPose}return!0},LoadModelV05.READ_SUBMESH=function(){var arrayBuffer=LoadModelV05._readData.__getBuffer(),submesh=new SubMesh(LoadModelV05._mesh),vbIndex=LoadModelV05._readData.getInt16(),ibStart=LoadModelV05._readData.getUint32(),ibCount=LoadModelV05._readData.getUint32(),indexBuffer=LoadModelV05._mesh._indexBuffer;submesh._indexBuffer=indexBuffer,submesh._indexStart=ibStart,submesh._indexCount=ibCount,submesh._indices=new Uint16Array(indexBuffer.getData().buffer,2*ibStart,ibCount);var vertexBuffer=LoadModelV05._mesh._vertexBuffers[vbIndex];submesh._vertexBuffer=vertexBuffer;var bufferState=submesh._bufferState;bufferState.bind(),bufferState.applyVertexBuffer(vertexBuffer),bufferState.applyIndexBuffer(indexBuffer),bufferState.unBind();var offset=LoadModelV05._DATA.offset,subIndexBufferStart=submesh._subIndexBufferStart,subIndexBufferCount=submesh._subIndexBufferCount,boneIndicesList=submesh._boneIndicesList,drawCount=LoadModelV05._readData.getUint16();subIndexBufferStart.length=drawCount,subIndexBufferCount.length=drawCount,boneIndicesList.length=drawCount;for(var pathMarks=LoadModelV05._mesh._skinDataPathMarks,bindPoseIndices=LoadModelV05._bindPoseIndices,subMeshIndex=LoadModelV05._subMeshes.length,i=0;i<drawCount;i++){subIndexBufferStart[i]=LoadModelV05._readData.getUint32(),subIndexBufferCount[i]=LoadModelV05._readData.getUint32();for(var boneDicofs=LoadModelV05._readData.getUint32(),boneDicCount=LoadModelV05._readData.getUint32(),boneIndices=boneIndicesList[i]=new Uint16Array(arrayBuffer.slice(offset+boneDicofs,offset+boneDicofs+boneDicCount)),j=0,m=boneIndices.length;j<m;j++){var index=boneIndices[j],combineIndex=bindPoseIndices.indexOf(index);-1===combineIndex?(boneIndices[j]=bindPoseIndices.length,bindPoseIndices.push(index),pathMarks.push([subMeshIndex,i,j])):boneIndices[j]=combineIndex}}return LoadModelV05._subMeshes.push(submesh),!0},LoadModelV05._strings=[],LoadModelV05._readData=null,LoadModelV05._version=null,LoadModelV05._mesh=null,LoadModelV05._subMeshes=null,LoadModelV05._bindPoseIndices=[],__static(LoadModelV05,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),LoadModelV05}()),StartFrame=function(){function StartFrame(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}__class(StartFrame,"laya.d3.core.particleShuriKen.module.StartFrame");var __proto=StartFrame.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destStartFrame=destObject;destStartFrame._type=this._type,destStartFrame._constant=this._constant,destStartFrame._constantMin=this._constantMin,destStartFrame._constantMax=this._constantMax},__proto.clone=function(){var destStartFrame=new this.constructor;return this.cloneTo(destStartFrame),destStartFrame},__getset(0,__proto,"constant",function(){return this._constant}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),StartFrame.createByConstant=function(constant){var rotationOverLifetime=new StartFrame;return rotationOverLifetime._type=0,rotationOverLifetime._constant=constant,rotationOverLifetime},StartFrame.createByRandomTwoConstant=function(constantMin,constantMax){var rotationOverLifetime=new StartFrame;return rotationOverLifetime._type=1,rotationOverLifetime._constantMin=constantMin,rotationOverLifetime._constantMax=constantMax,rotationOverLifetime},StartFrame}(),LoadModelV04=function(){function LoadModelV04(){}return __class(LoadModelV04,"laya.d3.loaders.LoadModelV04"),LoadModelV04.parse=function(readData,version,mesh,subMeshes){LoadModelV04._mesh=mesh,LoadModelV04._subMeshes=subMeshes,LoadModelV04._version=version,LoadModelV04._readData=readData,LoadModelV04.READ_DATA(),LoadModelV04.READ_BLOCK(),LoadModelV04.READ_STRINGS();for(var i=0,n=LoadModelV04._BLOCK.count;i<n;i++){LoadModelV04._readData.pos=LoadModelV04._BLOCK.blockStarts[i];var index=LoadModelV04._readData.getUint16(),blockName=LoadModelV04._strings[index],fn=LoadModelV04["READ_"+blockName];if(null==fn)throw new Error("model file err,no this function:"+index+" "+blockName);fn.call()}LoadModelV04._mesh._bindPoseIndices=new Uint16Array(LoadModelV04._bindPoseIndices),LoadModelV04._bindPoseIndices.length=0,LoadModelV04._strings.length=0,LoadModelV04._readData=null,LoadModelV04._version=null,LoadModelV04._mesh=null,LoadModelV04._subMeshes=null},LoadModelV04._readString=function(){return LoadModelV04._strings[LoadModelV04._readData.getUint16()]},LoadModelV04.READ_DATA=function(){LoadModelV04._DATA.offset=LoadModelV04._readData.getUint32(),LoadModelV04._DATA.size=LoadModelV04._readData.getUint32()},LoadModelV04.READ_BLOCK=function(){for(var count=LoadModelV04._BLOCK.count=LoadModelV04._readData.getUint16(),blockStarts=LoadModelV04._BLOCK.blockStarts=[],blockLengths=LoadModelV04._BLOCK.blockLengths=[],i=0;i<count;i++)blockStarts.push(LoadModelV04._readData.getUint32()),blockLengths.push(LoadModelV04._readData.getUint32())},LoadModelV04.READ_STRINGS=function(){var offset=LoadModelV04._readData.getUint32(),count=LoadModelV04._readData.getUint16(),prePos=LoadModelV04._readData.pos;LoadModelV04._readData.pos=offset+LoadModelV04._DATA.offset;for(var i=0;i<count;i++)LoadModelV04._strings[i]=LoadModelV04._readData.readUTFString();LoadModelV04._readData.pos=prePos},LoadModelV04.READ_MESH=function(){LoadModelV04._readString();var arrayBuffer=LoadModelV04._readData.__getBuffer(),i=0,memorySize=0,vertexBufferCount=LoadModelV04._readData.getInt16(),offset=LoadModelV04._DATA.offset;for(i=0;i<vertexBufferCount;i++){var vertexDeclaration,vbStart=offset+LoadModelV04._readData.getUint32(),vbLength=LoadModelV04._readData.getUint32(),vbDatas=new Float32Array(arrayBuffer.slice(vbStart,vbStart+vbLength)),bufferAttribute=LoadModelV04._readString();switch(LoadModelV04._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":vertexDeclaration=VertexMesh.getVertexDeclaration(bufferAttribute);break;case"LAYAMODEL:0401":vertexDeclaration=VertexMesh.getVertexDeclaration(bufferAttribute,!1);break;default:throw new Error("LoadModelV03: unknown version.")}if(!vertexDeclaration)throw new Error("LoadModelV03: unknown vertexDeclaration.");var vertexBuffer=new VertexBuffer3D(4*vbDatas.length,35044,!0);vertexBuffer.vertexDeclaration=vertexDeclaration,vertexBuffer.setData(vbDatas),LoadModelV04._mesh._vertexBuffers.push(vertexBuffer),LoadModelV04._mesh._vertexCount+=vertexBuffer.vertexCount,memorySize+=4*vbDatas.length}var ibStart=offset+LoadModelV04._readData.getUint32(),ibLength=LoadModelV04._readData.getUint32(),ibDatas=new Uint16Array(arrayBuffer.slice(ibStart,ibStart+ibLength)),indexBuffer=new IndexBuffer3D("ushort",ibLength/2,35044,!0);indexBuffer.setData(ibDatas),LoadModelV04._mesh._indexBuffer=indexBuffer,memorySize+=2*indexBuffer.indexCount,LoadModelV04._mesh._setCPUMemory(memorySize),LoadModelV04._mesh._setGPUMemory(memorySize);var boneNames=LoadModelV04._mesh._boneNames=[],boneCount=LoadModelV04._readData.getUint16();for(boneNames.length=boneCount,i=0;i<boneCount;i++)boneNames[i]=LoadModelV04._strings[LoadModelV04._readData.getUint16()];LoadModelV04._readData.pos+=8;var bindPoseDataStart=LoadModelV04._readData.getUint32(),bindPoseDataLength=LoadModelV04._readData.getUint32(),bindPoseDatas=new Float32Array(arrayBuffer.slice(offset+bindPoseDataStart,offset+bindPoseDataStart+bindPoseDataLength)),bindPoseFloatCount=bindPoseDatas.length,bindPoseCount=bindPoseFloatCount/16,bindPoseBuffer=LoadModelV04._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*bindPoseFloatCount);for(LoadModelV04._mesh._inverseBindPoses=__newvec(bindPoseCount),i=0;i<bindPoseFloatCount;i+=16){var inverseGlobalBindPose=new Matrix4x4(bindPoseDatas[i+0],bindPoseDatas[i+1],bindPoseDatas[i+2],bindPoseDatas[i+3],bindPoseDatas[i+4],bindPoseDatas[i+5],bindPoseDatas[i+6],bindPoseDatas[i+7],bindPoseDatas[i+8],bindPoseDatas[i+9],bindPoseDatas[i+10],bindPoseDatas[i+11],bindPoseDatas[i+12],bindPoseDatas[i+13],bindPoseDatas[i+14],bindPoseDatas[i+15],new Float32Array(bindPoseBuffer,4*i,16));LoadModelV04._mesh._inverseBindPoses[i/16]=inverseGlobalBindPose}return!0},LoadModelV04.READ_SUBMESH=function(){var arrayBuffer=LoadModelV04._readData.__getBuffer(),submesh=new SubMesh(LoadModelV04._mesh),vbIndex=LoadModelV04._readData.getInt16();LoadModelV04._readData.getUint32(),LoadModelV04._readData.getUint32();var ibStart=LoadModelV04._readData.getUint32(),ibCount=LoadModelV04._readData.getUint32(),indexBuffer=LoadModelV04._mesh._indexBuffer;submesh._indexBuffer=indexBuffer,submesh._indexStart=ibStart,submesh._indexCount=ibCount,submesh._indices=new Uint16Array(indexBuffer.getData().buffer,2*ibStart,ibCount);var vertexBuffer=LoadModelV04._mesh._vertexBuffers[vbIndex];submesh._vertexBuffer=vertexBuffer;var bufferState=submesh._bufferState;bufferState.bind(),bufferState.applyVertexBuffer(vertexBuffer),bufferState.applyIndexBuffer(indexBuffer),bufferState.unBind();var offset=LoadModelV04._DATA.offset,subIndexBufferStart=submesh._subIndexBufferStart,subIndexBufferCount=submesh._subIndexBufferCount,boneIndicesList=submesh._boneIndicesList,drawCount=LoadModelV04._readData.getUint16();subIndexBufferStart.length=drawCount,subIndexBufferCount.length=drawCount,boneIndicesList.length=drawCount;for(var pathMarks=LoadModelV04._mesh._skinDataPathMarks,bindPoseIndices=LoadModelV04._bindPoseIndices,subMeshIndex=LoadModelV04._subMeshes.length,i=0;i<drawCount;i++){subIndexBufferStart[i]=LoadModelV04._readData.getUint32(),subIndexBufferCount[i]=LoadModelV04._readData.getUint32();for(var boneDicofs=LoadModelV04._readData.getUint32(),boneDicCount=LoadModelV04._readData.getUint32(),boneIndices=boneIndicesList[i]=new Uint16Array(arrayBuffer.slice(offset+boneDicofs,offset+boneDicofs+boneDicCount)),j=0,m=boneIndices.length;j<m;j++){var index=boneIndices[j],combineIndex=bindPoseIndices.indexOf(index);-1===combineIndex?(boneIndices[j]=bindPoseIndices.length,bindPoseIndices.push(index),pathMarks.push([subMeshIndex,i,j])):boneIndices[j]=combineIndex}}return LoadModelV04._subMeshes.push(submesh),!0},LoadModelV04._strings=[],LoadModelV04._readData=null,LoadModelV04._version=null,LoadModelV04._mesh=null,LoadModelV04._subMeshes=null,LoadModelV04._bindPoseIndices=[],__static(LoadModelV04,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),LoadModelV04}(),Touch=function(){function Touch(){this._indexInList=-1,this._identifier=-1,this._position=new Vector2}__class(Touch,"laya.d3.Touch");var __proto=Touch.prototype;return Laya.imps(__proto,{"laya.resource.ISingletonElement":!0}),__proto._getIndexInList=function(){return this._indexInList},__proto._setIndexInList=function(index){this._indexInList=index},__getset(0,__proto,"identifier",function(){return this._identifier}),__getset(0,__proto,"position",function(){return this._position}),Touch}(),FrameOverTime=function(){function FrameOverTime(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}__class(FrameOverTime,"laya.d3.core.particleShuriKen.module.FrameOverTime");var __proto=FrameOverTime.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destFrameOverTime=destObject;destFrameOverTime._type=this._type,destFrameOverTime._constant=this._constant,this._overTime.cloneTo(destFrameOverTime._overTime),destFrameOverTime._constantMin=this._constantMin,destFrameOverTime._constantMax=this._constantMax,this._overTimeMin.cloneTo(destFrameOverTime._overTimeMin),this._overTimeMax.cloneTo(destFrameOverTime._overTimeMax)},__proto.clone=function(){var destFrameOverTime=new this.constructor;return this.cloneTo(destFrameOverTime),destFrameOverTime},__getset(0,__proto,"frameOverTimeData",function(){return this._overTime}),__getset(0,__proto,"constant",function(){return this._constant}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"frameOverTimeDataMin",function(){return this._overTimeMin}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"frameOverTimeDataMax",function(){return this._overTimeMax}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),FrameOverTime.createByConstant=function(constant){var rotationOverLifetime=new FrameOverTime;return rotationOverLifetime._type=0,rotationOverLifetime._constant=constant,rotationOverLifetime},FrameOverTime.createByOverTime=function(overTime){var rotationOverLifetime=new FrameOverTime;return rotationOverLifetime._type=1,rotationOverLifetime._overTime=overTime,rotationOverLifetime},FrameOverTime.createByRandomTwoConstant=function(constantMin,constantMax){var rotationOverLifetime=new FrameOverTime;return rotationOverLifetime._type=2,rotationOverLifetime._constantMin=constantMin,rotationOverLifetime._constantMax=constantMax,rotationOverLifetime},FrameOverTime.createByRandomTwoOverTime=function(gradientFrameMin,gradientFrameMax){var rotationOverLifetime=new FrameOverTime;return rotationOverLifetime._type=3,rotationOverLifetime._overTimeMin=gradientFrameMin,rotationOverLifetime._overTimeMax=gradientFrameMax,rotationOverLifetime},FrameOverTime}(),VertexMesh=function(){function VertexMesh(){}return __class(VertexMesh,"laya.d3.graphics.Vertex.VertexMesh"),VertexMesh.getVertexDeclaration=function(vertexFlag,compatible){void 0===compatible&&(compatible=!0);var verDec=VertexMesh._vertexDeclarationMap[vertexFlag];if(!verDec){for(var subFlags=vertexFlag.split(","),offset=0,elements=[],i=0,n=subFlags.length;i<n;i++){var element;switch(subFlags[i]){case"POSITION":element=new VertexElement(offset,"vector3",0),offset+=12;break;case"NORMAL":element=new VertexElement(offset,"vector3",3),offset+=12;break;case"COLOR":element=new VertexElement(offset,"vector4",1),offset+=16;break;case"UV":element=new VertexElement(offset,"vector2",2),offset+=8;break;case"UV1":element=new VertexElement(offset,"vector2",8),offset+=8;break;case"BLENDWEIGHT":element=new VertexElement(offset,"vector4",7),offset+=16;break;case"BLENDINDICES":compatible?(element=new VertexElement(offset,"vector4",6),offset+=16):(element=new VertexElement(offset,"byte4",6),offset+=4);break;case"TANGENT":element=new VertexElement(offset,"vector4",5),offset+=16;break;default:throw"VertexMesh: unknown vertex flag."}elements.push(element)}verDec=new VertexDeclaration(offset,elements),VertexMesh._vertexDeclarationMap[vertexFlag]=verDec}return verDec},VertexMesh.MESH_POSITION0=0,VertexMesh.MESH_COLOR0=1,VertexMesh.MESH_TEXTURECOORDINATE0=2,VertexMesh.MESH_NORMAL0=3,VertexMesh.MESH_TANGENT0=5,VertexMesh.MESH_BLENDINDICES0=6,VertexMesh.MESH_BLENDWEIGHT0=7,VertexMesh.MESH_TEXTURECOORDINATE1=8,VertexMesh._vertexDeclarationMap={},VertexMesh}(),RotationOverLifetime=function(){function RotationOverLifetime(angularVelocity){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=angularVelocity}__class(RotationOverLifetime,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var __proto=RotationOverLifetime.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destRotationOverLifetime=destObject;this._angularVelocity.cloneTo(destRotationOverLifetime._angularVelocity),destRotationOverLifetime.enbale=this.enbale},__proto.clone=function(){var destAngularVelocity;switch(this._angularVelocity.type){case 0:destAngularVelocity=this._angularVelocity.separateAxes?GradientAngularVelocity.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):GradientAngularVelocity.createByConstant(this._angularVelocity.constant);break;case 1:destAngularVelocity=this._angularVelocity.separateAxes?GradientAngularVelocity.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):GradientAngularVelocity.createByGradient(this._angularVelocity.gradient.clone());break;case 2:destAngularVelocity=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):GradientAngularVelocity.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:destAngularVelocity=this._angularVelocity.separateAxes?GradientAngularVelocity.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):GradientAngularVelocity.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var destRotationOverLifetime=new this.constructor(destAngularVelocity);return destRotationOverLifetime.enbale=this.enbale,destRotationOverLifetime},__getset(0,__proto,"angularVelocity",function(){return this._angularVelocity}),RotationOverLifetime}(),VertexPositionTerrain=function(){function VertexPositionTerrain(position,normal,textureCoord0,textureCoord1){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=position,this._normal=normal,this._textureCoord0=textureCoord0,this._textureCoord1=textureCoord1}__class(VertexPositionTerrain,"laya.d3.graphics.Vertex.VertexPositionTerrain");var __proto=VertexPositionTerrain.prototype;return Laya.imps(__proto,{"laya.d3.graphics.IVertex":!0}),__getset(0,__proto,"normal",function(){return this._normal}),__getset(0,__proto,"position",function(){return this._position}),__getset(0,__proto,"textureCoord0",function(){return this._textureCoord0}),__getset(0,__proto,"textureCoord1",function(){return this._textureCoord1}),__getset(0,__proto,"vertexDeclaration",function(){return VertexPositionTerrain._vertexDeclaration}),__getset(1,VertexPositionTerrain,"vertexDeclaration",function(){return VertexPositionTerrain._vertexDeclaration}),VertexPositionTerrain.TERRAIN_POSITION0=0,VertexPositionTerrain.TERRAIN_NORMAL0=1,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE0=2,VertexPositionTerrain.TERRAIN_TEXTURECOORDINATE1=3,__static(VertexPositionTerrain,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(40,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector3",1),new VertexElement(24,"vector2",2),new VertexElement(32,"vector2",3)])}]),VertexPositionTerrain}(),AnimatorPlayState=function(){function AnimatorPlayState(){}__class(AnimatorPlayState,"laya.d3.component.AnimatorPlayState");var __proto=AnimatorPlayState.prototype;return __proto._resetPlayState=function(startTime){this._finish=!1,this._startPlayTime=startTime,this._elapsedTime=startTime,this._playEventIndex=0},__proto._cloneTo=function(dest){dest._finish=this._finish,dest._startPlayTime=this._startPlayTime,dest._elapsedTime=this._elapsedTime,dest._playEventIndex=this._playEventIndex},__getset(0,__proto,"normalizedTime",function(){return this._normalizedTime}),__getset(0,__proto,"duration",function(){return this._duration}),AnimatorPlayState}(),Shader3D=function(){function Shader3D(name){this._subShaders=[],this._name=name}__class(Shader3D,"laya.d3.shader.Shader3D");var __proto=Shader3D.prototype;return __proto.addSubShader=function(subShader){this._subShaders.push(subShader),subShader._owner=this},__proto.getSubShaderAt=function(index){return this._subShaders[index]},Shader3D.propertyNameToID=function(name){if(null!=Shader3D._propertyNameMap[name])return Shader3D._propertyNameMap[name];var id=Shader3D._propertyNameCounter++;return Shader3D._propertyNameMap[name]=id,id},Shader3D.addInclude=function(fileName,txt){ShaderCompile.addInclude(fileName,txt)},Shader3D.registerPublicDefine=function(name){var value=Math.pow(2,Shader3D._publicCounter++);return Shader3D._globleDefines[value]=name,value},Shader3D.compileShader=function(name,subShaderIndex,passIndex,publicDefine,spriteDefine,materialDefine){var shader=laya.d3.shader.Shader3D.find(name);if(shader){var subShader=shader.getSubShaderAt(subShaderIndex);if(subShader){var pass=subShader._passes[passIndex];pass?WebGL.shaderHighPrecision?pass.withCompile(publicDefine,spriteDefine,materialDefine):pass.withCompile(publicDefine-laya.d3.shader.Shader3D.SHADERDEFINE_HIGHPRECISION,spriteDefine,materialDefine):console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")},Shader3D.add=function(name){return laya.d3.shader.Shader3D._preCompileShader[name]=new Shader3D(name)},Shader3D.find=function(name){return laya.d3.shader.Shader3D._preCompileShader[name]},Shader3D.PERIOD_CUSTOM=0,Shader3D.PERIOD_MATERIAL=1,Shader3D.PERIOD_SPRITE=2,Shader3D.PERIOD_CAMERA=3,Shader3D.PERIOD_SCENE=4,Shader3D.SHADERDEFINE_HIGHPRECISION=0,Shader3D._propertyNameCounter=0,Shader3D._propertyNameMap={},Shader3D._publicCounter=0,Shader3D._globleDefines=[],Shader3D._preCompileShader={},Shader3D.debugMode=!1,Shader3D}(),SingletonList=function(){function SingletonList(){this.length=0,this.elements=[]}return __class(SingletonList,"laya.d3.component.SingletonList"),SingletonList.prototype._add=function(element){this.length===this.elements.length?this.elements.push(element):this.elements[this.length]=element},SingletonList}(),ChunkInfo=function(){function ChunkInfo(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return __class(ChunkInfo,"laya.d3.terrain.unit.ChunkInfo"),ChunkInfo}(),GradientColor=function(){function GradientColor(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}__class(GradientColor,"laya.d3.core.particleShuriKen.module.GradientColor");var __proto=GradientColor.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destGradientColor=destObject;destGradientColor._type=this._type,this._constant.cloneTo(destGradientColor._constant),this._constantMin.cloneTo(destGradientColor._constantMin),this._constantMax.cloneTo(destGradientColor._constantMax),this._gradient.cloneTo(destGradientColor._gradient),this._gradientMin.cloneTo(destGradientColor._gradientMin),this._gradientMax.cloneTo(destGradientColor._gradientMax)},__proto.clone=function(){var destGradientColor=new this.constructor;return this.cloneTo(destGradientColor),destGradientColor},__getset(0,__proto,"gradient",function(){return this._gradient}),__getset(0,__proto,"constant",function(){return this._constant}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"gradientMin",function(){return this._gradientMin}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"gradientMax",function(){return this._gradientMax}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),GradientColor.createByConstant=function(constant){var gradientColor=new GradientColor;return gradientColor._type=0,gradientColor._constant=constant,gradientColor},GradientColor.createByGradient=function(gradient){var gradientColor=new GradientColor;return gradientColor._type=1,gradientColor._gradient=gradient,gradientColor},GradientColor.createByRandomTwoConstant=function(minConstant,maxConstant){var gradientColor=new GradientColor;return gradientColor._type=2,gradientColor._constantMin=minConstant,gradientColor._constantMax=maxConstant,gradientColor},GradientColor.createByRandomTwoGradient=function(minGradient,maxGradient){var gradientColor=new GradientColor;return gradientColor._type=3,gradientColor._gradientMin=minGradient,gradientColor._gradientMax=maxGradient,gradientColor},GradientColor}(),PhysicsSimulation=function(){function PhysicsSimulation(configuration,flags){this._nativeDiscreteDynamicsWorld=null,this._nativeCollisionWorld=null,this._nativeDispatcher=null,this._nativeCollisionConfiguration=null,this._nativeBroadphase=null,this._nativeSolverInfo=null,this._nativeDispatchInfo=null,this._nativeClosestRayResultCallback=null,this._nativeAllHitsRayResultCallback=null,this._nativeClosestConvexResultCallback=null,this._nativeAllConvexResultCallback=null,this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this._gravity=new Vector3(0,-10,0),this._nativeVector3Zero=new Laya3D._physics3D.btVector3(0,0,0),this._nativeDefaultQuaternion=new Laya3D._physics3D.btQuaternion(0,0,0,-1),this._collisionsUtils=new CollisionTool,this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._physicsUpdateList=new PhysicsUpdateList,this._characters=[],void 0===flags&&(flags=0),this.maxSubSteps=configuration.maxSubSteps,this.fixedTimeStep=configuration.fixedTimeStep;var physics3D=Laya3D._physics3D;this._nativeCollisionConfiguration=new physics3D.btDefaultCollisionConfiguration,this._nativeDispatcher=new physics3D.btCollisionDispatcher(this._nativeCollisionConfiguration),this._nativeBroadphase=new physics3D.btDbvtBroadphase,this._nativeBroadphase.getOverlappingPairCache().setInternalGhostPairCallback(new physics3D.btGhostPairCallback);var conFlags=configuration.flags;if(1&conFlags)this._nativeCollisionWorld=new physics3D.btCollisionWorld(this._nativeDispatcher,this._nativeBroadphase,this._nativeCollisionConfiguration);else{if(2&conFlags)throw"PhysicsSimulation:SoftBody processing is not yet available";var solver=new physics3D.btSequentialImpulseConstraintSolver;this._nativeDiscreteDynamicsWorld=new physics3D.btDiscreteDynamicsWorld(this._nativeDispatcher,this._nativeBroadphase,solver,this._nativeCollisionConfiguration),this._nativeCollisionWorld=this._nativeDiscreteDynamicsWorld}this._nativeDiscreteDynamicsWorld&&(this._nativeSolverInfo=this._nativeDiscreteDynamicsWorld.getSolverInfo(),this._nativeDispatchInfo=this._nativeDiscreteDynamicsWorld.getDispatchInfo()),this._nativeClosestRayResultCallback=new physics3D.ClosestRayResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeAllHitsRayResultCallback=new physics3D.AllHitsRayResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeClosestConvexResultCallback=new physics3D.ClosestConvexResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeAllConvexResultCallback=new physics3D.AllConvexResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),physics3D._btGImpactCollisionAlgorithm_RegisterAlgorithm(this._nativeDispatcher.a)}__class(PhysicsSimulation,"laya.d3.physics.PhysicsSimulation");var __proto=PhysicsSimulation.prototype;return __proto._simulate=function(deltaTime){this._updatedRigidbodies=0,this._nativeDiscreteDynamicsWorld?this._nativeDiscreteDynamicsWorld.stepSimulation(deltaTime,this.maxSubSteps,this.fixedTimeStep):this._nativeCollisionWorld.PerformDiscreteCollisionDetection()},__proto._destroy=function(){var physics3D=Laya3D._physics3D;this._nativeDiscreteDynamicsWorld?(physics3D.destroy(this._nativeDiscreteDynamicsWorld),this._nativeDiscreteDynamicsWorld=null):(physics3D.destroy(this._nativeCollisionWorld),this._nativeCollisionWorld=null),physics3D.destroy(this._nativeBroadphase),this._nativeBroadphase=null,physics3D.destroy(this._nativeDispatcher),this._nativeDispatcher=null,physics3D.destroy(this._nativeCollisionConfiguration),this._nativeCollisionConfiguration=null},__proto._addPhysicsCollider=function(component,group,mask){this._nativeCollisionWorld.addCollisionObject(component._nativeColliderObject,group,mask)},__proto._removePhysicsCollider=function(component){this._nativeCollisionWorld.removeCollisionObject(component._nativeColliderObject)},__proto._addRigidBody=function(rigidBody,group,mask){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.addRigidBody(rigidBody._nativeColliderObject,group,mask)},__proto._removeRigidBody=function(rigidBody){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.removeRigidBody(rigidBody._nativeColliderObject)},__proto._addCharacter=function(character,group,mask){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.addCollisionObject(character._nativeColliderObject,group,mask),this._nativeCollisionWorld.addAction(character._nativeKinematicCharacter)},__proto._removeCharacter=function(character){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.removeCollisionObject(character._nativeColliderObject),this._nativeCollisionWorld.removeAction(character._nativeKinematicCharacter)},__proto.raycastFromTo=function(from,to,out,collisonGroup,collisionMask){void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER);var rayResultCall=this._nativeClosestRayResultCallback,rayFrom=PhysicsSimulation._nativeTempVector30,rayTo=PhysicsSimulation._nativeTempVector31,fromE=from.elements,toE=to.elements;if(rayFrom.setValue(-fromE[0],fromE[1],fromE[2]),rayTo.setValue(-toE[0],toE[1],toE[2]),rayResultCall.set_m_rayFromWorld(rayFrom),rayResultCall.set_m_rayToWorld(rayTo),rayResultCall.set_m_collisionFilterGroup(collisonGroup),rayResultCall.set_m_collisionFilterMask(collisionMask),rayResultCall.set_m_collisionObject(null),rayResultCall.set_m_closestHitFraction(1),this._nativeCollisionWorld.rayTest(rayFrom,rayTo,rayResultCall),rayResultCall.hasHit()){if(out){out.succeeded=!0,out.collider=PhysicsComponent._physicObjectsMap[rayResultCall.get_m_collisionObject().getUserIndex()],out.hitFraction=rayResultCall.get_m_closestHitFraction();var nativePoint=rayResultCall.get_m_hitPointWorld(),pointE=out.point.elements;pointE[0]=-nativePoint.x(),pointE[1]=nativePoint.y(),pointE[2]=nativePoint.z();var nativeNormal=rayResultCall.get_m_hitNormalWorld(),normalE=out.normal.elements;normalE[0]=-nativeNormal.x(),normalE[1]=nativeNormal.y(),normalE[2]=nativeNormal.z()}return!0}return out&&(out.succeeded=!1),!1},__proto.raycastAllFromTo=function(from,to,out,collisonGroup,collisionMask){void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER);var rayResultCall=this._nativeAllHitsRayResultCallback,rayFrom=PhysicsSimulation._nativeTempVector30,rayTo=PhysicsSimulation._nativeTempVector31;out.length=0;var fromE=from.elements,toE=to.elements;rayFrom.setValue(-fromE[0],fromE[1],fromE[2]),rayTo.setValue(-toE[0],toE[1],toE[2]),rayResultCall.set_m_rayFromWorld(rayFrom),rayResultCall.set_m_rayToWorld(rayTo),rayResultCall.set_m_collisionFilterGroup(collisonGroup),rayResultCall.set_m_collisionFilterMask(collisionMask);var collisionObjects=rayResultCall.get_m_collisionObjects(),nativePoints=rayResultCall.get_m_hitPointWorld(),nativeNormals=rayResultCall.get_m_hitNormalWorld(),nativeFractions=rayResultCall.get_m_hitFractions();collisionObjects.clear(),nativePoints.clear(),nativeNormals.clear(),nativeFractions.clear(),this._nativeCollisionWorld.rayTest(rayFrom,rayTo,rayResultCall);var count=collisionObjects.size();if(count>0){this._collisionsUtils.recoverAllHitResultsPool();for(var i=0;i<count;i++){var hitResult=this._collisionsUtils.getHitResult();out.push(hitResult),hitResult.succeeded=!0,hitResult.collider=PhysicsComponent._physicObjectsMap[collisionObjects.at(i).getUserIndex()],hitResult.hitFraction=nativeFractions.at(i);var nativePoint=nativePoints.at(i),pointE=hitResult.point.elements;pointE[0]=-nativePoint.x(),pointE[1]=nativePoint.y(),pointE[2]=nativePoint.z();var nativeNormal=nativeNormals.at(i),normalE=hitResult.normal.elements;normalE[0]=-nativeNormal.x(),normalE[1]=nativeNormal.y(),normalE[2]=nativeNormal.z()}return!0}return!1},__proto.rayCast=function(ray,outHitResult,distance,collisonGroup,collisionMask){void 0===distance&&(distance=2147483647),void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER);var from=ray.origin,to=PhysicsSimulation._tempVector30;return Vector3.normalize(ray.direction,to),Vector3.scale(to,distance,to),Vector3.add(from,to,to),this.raycastFromTo(from,to,outHitResult,collisonGroup,collisionMask)},__proto.rayCastAll=function(ray,out,distance,collisonGroup,collisionMask){void 0===distance&&(distance=2147483647),void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER);var from=ray.origin,to=PhysicsSimulation._tempVector30;return Vector3.normalize(ray.direction,to),Vector3.scale(to,distance,to),Vector3.add(from,to,to),this.raycastAllFromTo(from,to,out,collisonGroup,collisionMask)},__proto.shapeCast=function(shape,fromPosition,toPosition,out,fromRotation,toRotation,collisonGroup,collisionMask,allowedCcdPenetration){void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===allowedCcdPenetration&&(allowedCcdPenetration=0);var convexResultCall=this._nativeClosestConvexResultCallback,convexPosFrom=PhysicsSimulation._nativeTempVector30,convexPosTo=PhysicsSimulation._nativeTempVector31,convexRotFrom=PhysicsSimulation._nativeTempVector30,convexRotTo=PhysicsSimulation._nativeTempVector31,convexTransform=PhysicsSimulation._nativeTempTransform0,convexTransTo=PhysicsSimulation._nativeTempTransform1,sweepShape=shape._nativeShape,fromPositionE=fromPosition.elements,toPositionE=toPosition.elements;if(convexPosFrom.setValue(-fromPositionE[0],fromPositionE[1],fromPositionE[2]),convexPosTo.setValue(-toPositionE[0],toPositionE[1],toPositionE[2]),convexResultCall.set_m_collisionFilterGroup(collisonGroup),convexResultCall.set_m_collisionFilterMask(collisionMask),convexTransform.setOrigin(convexPosFrom),convexTransTo.setOrigin(convexPosTo),fromRotation){var fromRotationE=fromRotation.elements;convexRotFrom.setValue(-fromRotationE[0],fromRotationE[1],fromRotationE[2],-fromRotationE[3]),convexTransform.setRotation(convexRotFrom)}else convexTransform.setRotation(this._nativeDefaultQuaternion);if(toRotation){var toRotationE=toRotation.elements;convexRotTo.setValue(-toRotationE[0],toRotationE[1],toRotationE[2],-toRotationE[2]),convexTransTo.setRotation(convexRotTo)}else convexTransTo.setRotation(this._nativeDefaultQuaternion);if(convexResultCall.set_m_hitCollisionObject(null),convexResultCall.set_m_closestHitFraction(1),this._nativeCollisionWorld.convexSweepTest(sweepShape,convexTransform,convexTransTo,convexResultCall,allowedCcdPenetration),convexResultCall.hasHit()){if(out){out.succeeded=!0,out.collider=PhysicsComponent._physicObjectsMap[convexResultCall.get_m_hitCollisionObject().getUserIndex()],out.hitFraction=convexResultCall.get_m_closestHitFraction();var nativePoint=convexResultCall.get_m_hitPointWorld(),nativeNormal=convexResultCall.get_m_hitNormalWorld(),pointE=out.point.elements,normalE=out.normal.elements;pointE[0]=-nativePoint.x(),pointE[1]=nativePoint.y(),pointE[2]=nativePoint.z(),normalE[0]=-nativeNormal.x(),normalE[1]=nativeNormal.y(),normalE[2]=nativeNormal.z()}return!0}return out&&(out.succeeded=!1),!1},__proto.shapeCastAll=function(shape,fromPosition,toPosition,out,fromRotation,toRotation,collisonGroup,collisionMask,allowedCcdPenetration){void 0===collisonGroup&&(collisonGroup=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===collisionMask&&(collisionMask=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),void 0===allowedCcdPenetration&&(allowedCcdPenetration=0);var convexResultCall=this._nativeAllConvexResultCallback,convexPosFrom=PhysicsSimulation._nativeTempVector30,convexPosTo=PhysicsSimulation._nativeTempVector31,convexRotFrom=PhysicsSimulation._nativeTempVector30,convexRotTo=PhysicsSimulation._nativeTempVector31,convexTransform=PhysicsSimulation._nativeTempTransform0,convexTransTo=PhysicsSimulation._nativeTempTransform1,sweepShape=shape._nativeShape;out.length=0;var fromPositionE=fromPosition.elements,toPositionE=toPosition.elements;if(convexPosFrom.setValue(-fromPositionE[0],fromPositionE[1],fromPositionE[2]),convexPosTo.setValue(-toPositionE[0],toPositionE[1],toPositionE[2]),convexResultCall.set_m_collisionFilterGroup(collisonGroup),convexResultCall.set_m_collisionFilterMask(collisionMask),convexTransform.setOrigin(convexPosFrom),convexTransTo.setOrigin(convexPosTo),fromRotation){var fromRotationE=fromRotation.elements;convexRotFrom.setValue(-fromRotationE[0],fromRotationE[1],fromRotationE[2],-fromRotationE[3]),convexTransform.setRotation(convexRotFrom)}else convexTransform.setRotation(this._nativeDefaultQuaternion);if(toRotation){var toRotationE=toRotation.elements;convexRotTo.setValue(-toRotationE[0],toRotationE[1],toRotationE[2],-toRotationE[2]),convexTransTo.setRotation(convexRotTo)}else convexTransTo.setRotation(this._nativeDefaultQuaternion);var collisionObjects=convexResultCall.get_m_collisionObjects();collisionObjects.clear(),this._nativeCollisionWorld.convexSweepTest(sweepShape,convexTransform,convexTransTo,convexResultCall,allowedCcdPenetration);var count=collisionObjects.size();if(count>0){for(var nativePoints=convexResultCall.get_m_hitPointWorld(),nativeNormals=convexResultCall.get_m_hitNormalWorld(),nativeFractions=convexResultCall.get_m_hitFractions(),i=0;i<count;i++){var hitResult=this._collisionsUtils.getHitResult();out.push(hitResult),hitResult.succeeded=!0,hitResult.collider=PhysicsComponent._physicObjectsMap[collisionObjects.at(i).getUserIndex()],hitResult.hitFraction=nativeFractions.at(i);var nativePoint=nativePoints.at(i),pointE=hitResult.point.elements;pointE[0]=-nativePoint.x(),pointE[1]=nativePoint.y(),pointE[2]=nativePoint.z();var nativeNormal=nativeNormals.at(i),normalE=hitResult.normal.elements;normalE[0]=-nativeNormal.x(),normalE[1]=nativeNormal.y(),normalE[2]=nativeNormal.z()}return!0}return!1},__proto.addConstraint=function(constraint,disableCollisionsBetweenLinkedBodies){if(void 0===disableCollisionsBetweenLinkedBodies&&(disableCollisionsBetweenLinkedBodies=!1),!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.addConstraint(constraint._nativeConstraint,disableCollisionsBetweenLinkedBodies),constraint._simulation=this},__proto.removeConstraint=function(constraint){if(!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.removeConstraint(constraint._nativeConstraint)},__proto._updatePhysicsTransformFromRender=function(){for(var elements=this._physicsUpdateList.elements,i=0,n=this._physicsUpdateList.length;i<n;i++){var physicCollider=elements[i];physicCollider._derivePhysicsTransformation(!1),physicCollider._inPhysicUpdateListIndex=-1}this._physicsUpdateList.length=0},__proto._updateCharacters=function(){for(var i=0,n=this._characters.length;i<n;i++){var character=this._characters[i];character._updateTransformComponent(character._nativeColliderObject.getWorldTransform())}},__proto._updateCollisions=function(){this._collisionsUtils.recoverAllContactPointsPool();var previous=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=previous;for(var loopCount=Stat.loopCount,numManifolds=this._nativeDispatcher.getNumManifolds(),i=0;i<numManifolds;i++){var contactManifold=this._nativeDispatcher.getManifoldByIndexInternal(i),componentA=PhysicsComponent._physicObjectsMap[contactManifold.getBody0().getUserIndex()],componentB=PhysicsComponent._physicObjectsMap[contactManifold.getBody1().getUserIndex()],collision=null,isFirstCollision=!1,contacts=null;if((componentA.isTrigger||componentB.isTrigger)&&(componentA.owner._needProcessTriggers||componentB.owner._needProcessTriggers))for(var numContacts=contactManifold.getNumContacts(),j=0;j<numContacts;j++){var pt=contactManifold.getContactPoint(j),distance=pt.getDistance();if(distance<=0){contacts=(collision=this._collisionsUtils.getCollision(componentA,componentB)).contacts,(isFirstCollision=collision._updateFrame!==loopCount)&&(collision._isTrigger=!0,contacts.length=0);break}}else if((componentA.owner._needProcessCollisions||componentB.owner._needProcessCollisions)&&(componentA._enableProcessCollisions||componentB._enableProcessCollisions))for(numContacts=contactManifold.getNumContacts(),j=0;j<numContacts;j++)if((distance=(pt=contactManifold.getContactPoint(j)).getDistance())<=0){var contactPoint=this._collisionsUtils.getContactPoints();contactPoint.colliderA=componentA,contactPoint.colliderB=componentB,contactPoint.distance=distance;var nativeNormal=pt.get_m_normalWorldOnB(),normalE=contactPoint.normal.elements;normalE[0]=-nativeNormal.x(),normalE[1]=nativeNormal.y(),normalE[2]=nativeNormal.z();var nativePostionA=pt.get_m_positionWorldOnA(),positionOnAE=contactPoint.positionOnA.elements;positionOnAE[0]=-nativePostionA.x(),positionOnAE[1]=nativePostionA.y(),positionOnAE[2]=nativePostionA.z();var nativePostionB=pt.get_m_positionWorldOnB(),positionOnBE=contactPoint.positionOnB.elements;positionOnBE[0]=-nativePostionB.x(),positionOnBE[1]=nativePostionB.y(),positionOnBE[2]=nativePostionB.z(),collision||(contacts=(collision=this._collisionsUtils.getCollision(componentA,componentB)).contacts,(isFirstCollision=collision._updateFrame!==loopCount)&&(collision._isTrigger=!1,contacts.length=0)),contacts.push(contactPoint)}collision&&isFirstCollision&&(this._currentFrameCollisions.push(collision),collision._setUpdateFrame(loopCount))}},__proto._eventScripts=function(){for(var loopCount=Stat.loopCount,i=0,n=this._currentFrameCollisions.length;i<n;i++){var curFrameCol=this._currentFrameCollisions[i],colliderA=curFrameCol._colliderA,colliderB=curFrameCol._colliderB;if(!colliderA.destroyed&&!colliderB.destroyed)if(loopCount-curFrameCol._lastUpdateFrame==1){var ownerA=colliderA.owner,scriptsA=ownerA._scripts;if(scriptsA)if(curFrameCol._isTrigger){if(ownerA._needProcessTriggers)for(var j=0,m=scriptsA.length;j<m;j++)scriptsA[j].onTriggerStay(colliderB)}else if(ownerA._needProcessCollisions)for(j=0,m=scriptsA.length;j<m;j++)curFrameCol.other=colliderB,scriptsA[j].onCollisionStay(curFrameCol);var ownerB=colliderB.owner,scriptsB=ownerB._scripts;if(scriptsB)if(curFrameCol._isTrigger){if(ownerB._needProcessTriggers)for(j=0,m=scriptsB.length;j<m;j++)scriptsB[j].onTriggerStay(colliderA)}else if(ownerB._needProcessCollisions)for(j=0,m=scriptsB.length;j<m;j++)curFrameCol.other=colliderA,scriptsB[j].onCollisionStay(curFrameCol)}else{if(scriptsA=(ownerA=colliderA.owner)._scripts)if(curFrameCol._isTrigger){if(ownerA._needProcessTriggers)for(j=0,m=scriptsA.length;j<m;j++)scriptsA[j].onTriggerEnter(colliderB)}else if(ownerA._needProcessCollisions)for(j=0,m=scriptsA.length;j<m;j++)curFrameCol.other=colliderB,scriptsA[j].onCollisionEnter(curFrameCol);if(scriptsB=(ownerB=colliderB.owner)._scripts)if(curFrameCol._isTrigger){if(ownerB._needProcessTriggers)for(j=0,m=scriptsB.length;j<m;j++)scriptsB[j].onTriggerEnter(colliderA)}else if(ownerB._needProcessCollisions)for(j=0,m=scriptsB.length;j<m;j++)curFrameCol.other=colliderA,scriptsB[j].onCollisionEnter(curFrameCol)}}for(i=0,n=this._previousFrameCollisions.length;i<n;i++){var preFrameCol=this._previousFrameCollisions[i],preColliderA=preFrameCol._colliderA,preColliderB=preFrameCol._colliderB;if(!preColliderA.destroyed&&!preColliderB.destroyed&&loopCount-preFrameCol._updateFrame==1){if(this._collisionsUtils.recoverCollision(preFrameCol),scriptsA=(ownerA=preColliderA.owner)._scripts)if(preFrameCol._isTrigger){if(ownerA._needProcessTriggers)for(j=0,m=scriptsA.length;j<m;j++)scriptsA[j].onTriggerExit(preColliderB)}else if(ownerA._needProcessCollisions)for(j=0,m=scriptsA.length;j<m;j++)preFrameCol.other=preColliderB,scriptsA[j].onCollisionExit(preFrameCol);if(scriptsB=(ownerB=preColliderB.owner)._scripts)if(preFrameCol._isTrigger){if(ownerB._needProcessTriggers)for(j=0,m=scriptsB.length;j<m;j++)scriptsB[j].onTriggerExit(preColliderA)}else if(ownerB._needProcessCollisions)for(j=0,m=scriptsB.length;j<m;j++)preFrameCol.other=preColliderA,scriptsB[j].onCollisionExit(preFrameCol)}}},__proto.clearForces=function(){if(!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.clearForces()},__getset(0,__proto,"gravity",function(){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity},function(value){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=value;var gravityE=value.elements,nativeGravity=PhysicsSimulation._nativeTempVector30;nativeGravity.setValue(-gravityE[0],gravityE[1],gravityE[2]),this._nativeDiscreteDynamicsWorld.setGravity(nativeGravity)}),__getset(0,__proto,"continuousCollisionDetection",function(){return this._nativeDispatchInfo.get_m_useContinuous()},function(value){this._nativeDispatchInfo.set_m_useContinuous(value)}),__getset(0,__proto,"speculativeContactRestitution",function(){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return this._nativeDiscreteDynamicsWorld.getApplySpeculativeContactRestitution()},function(value){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.setApplySpeculativeContactRestitution(value)}),PhysicsSimulation.createConstraint=function(){},PhysicsSimulation.PHYSICSENGINEFLAGS_NONE=0,PhysicsSimulation.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,PhysicsSimulation.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,PhysicsSimulation.PHYSICSENGINEFLAGS_MULTITHREADED=4,PhysicsSimulation.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,PhysicsSimulation.SOLVERMODE_RANDMIZE_ORDER=1,PhysicsSimulation.SOLVERMODE_FRICTION_SEPARATE=2,PhysicsSimulation.SOLVERMODE_USE_WARMSTARTING=4,PhysicsSimulation.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,PhysicsSimulation.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,PhysicsSimulation.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,PhysicsSimulation.SOLVERMODE_CACHE_FRIENDLY=128,PhysicsSimulation.SOLVERMODE_SIMD=256,PhysicsSimulation.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,PhysicsSimulation.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,PhysicsSimulation.disableSimulation=!1,__static(PhysicsSimulation,["_nativeTempVector30",function(){return this._nativeTempVector30=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeTempVector31",function(){return this._nativeTempVector31=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeTempQuaternion0",function(){return this._nativeTempQuaternion0=new Laya3D._physics3D.btQuaternion(0,0,0,1)},"_nativeTempQuaternion1",function(){return this._nativeTempQuaternion1=new Laya3D._physics3D.btQuaternion(0,0,0,1)},"_nativeTempTransform0",function(){return this._nativeTempTransform0=new Laya3D._physics3D.btTransform},"_nativeTempTransform1",function(){return this._nativeTempTransform1=new Laya3D._physics3D.btTransform},"_tempVector30",function(){return this._tempVector30=new Vector3}]),PhysicsSimulation}(),ParallelSplitShadowMap=function(){function ParallelSplitShadowMap(){this._currentPSSM=-1,this._shadowMapCount=3,this._maxDistance=200,this._ratioOfDistance=1/this._shadowMapCount,this._statesDirty=!0,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new Vector3(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new Vector3,this._tempLookAt4=new Vector4,this._tempValue=new Vector4,this._tempPos=new Vector3,this._tempLightUp=new Vector3,this._tempMin=new Vector4,this._tempMax=new Vector4,this._tempMatrix44=new Matrix4x4,this._splitFrustumCulling=new BoundFrustum(Matrix4x4.DEFAULT),this._tempScaleMatrix44=new Matrix4x4,this._shadowPCFOffset=new Vector2(1/1024,1/1024),this._shaderValueDistance=new Vector4,this.cameras=[],this._shaderValueVPs=[];var i=0;for(i=0;i<this._spiltDistance.length;i++)this._spiltDistance[i]=0;for(i=0;i<this._dimension.length;i++)this._dimension[i]=new Vector2;for(i=0;i<this._frustumPos.length;i++)this._frustumPos[i]=new Vector3;for(i=0;i<this._boundingBox.length;i++)this._boundingBox[i]=new BoundBox(new Vector3,new Vector3);for(i=0;i<this._boundingSphere.length;i++)this._boundingSphere[i]=new BoundSphere(new Vector3,0);Matrix4x4.createScaling(new Vector3(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}__class(ParallelSplitShadowMap,"laya.d3.shadowMap.ParallelSplitShadowMap");var __proto=ParallelSplitShadowMap.prototype;return __proto.setInfo=function(scene,maxDistance,globalParallelDir,shadowMapTextureSize,numberOfPSSM,PCFType){numberOfPSSM>3&&(this._shadowMapCount=3),this._scene=scene,this._maxDistance=maxDistance,this.shadowMapCount=numberOfPSSM,this._globalParallelLightDir=globalParallelDir,this._ratioOfDistance=1/this._shadowMapCount;for(var i=0;i<this._spiltDistance.length;i++)this._spiltDistance[i]=0;this._shadowMapTextureSize=shadowMapTextureSize,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(PCFType),this._statesDirty=!0},__proto.setPCFType=function(PCFtype){this._PCFType=PCFtype;var defineData=this._scene._defineDatas;switch(this._PCFType){case 0:defineData.add(Scene3D.SHADERDEFINE_SHADOW_PCF_NO),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF1),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF2),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF3);break;case 1:defineData.add(Scene3D.SHADERDEFINE_SHADOW_PCF1),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF_NO),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF2),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF3);break;case 2:defineData.add(Scene3D.SHADERDEFINE_SHADOW_PCF2),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF_NO),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF1),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF3);break;case 3:defineData.add(Scene3D.SHADERDEFINE_SHADOW_PCF3),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF_NO),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF1),defineData.remove(Scene3D.SHADERDEFINE_SHADOW_PCF2)}},__proto.getPCFType=function(){return this._PCFType},__proto.setFarDistance=function(value){this._maxDistance!=value&&(this._maxDistance=value,this._statesDirty=!0)},__proto.getFarDistance=function(){return this._maxDistance},__proto._beginSampler=function(index,sceneCamera){if(index<0||index>this._shadowMapCount)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=index,this._update(sceneCamera)},__proto.endSampler=function(sceneCamera){this._currentPSSM=-1},__proto._calcAllLightCameraInfo=function(sceneCamera){if(1===this._shadowMapCount)this._beginSampler(0,sceneCamera),this.endSampler(sceneCamera);else for(var i=0,n=this._shadowMapCount+1;i<n;i++)this._beginSampler(i,sceneCamera),this.endSampler(sceneCamera)},__proto._recalculate=function(nearPlane,fieldOfView,aspectRatio){this._calcSplitDistance(nearPlane),this._calcBoundingBox(fieldOfView,aspectRatio),this._rebuildRenderInfo()},__proto._update=function(sceneCamera){var nearPlane=sceneCamera.nearPlane,fieldOfView=sceneCamera.fieldOfView,aspectRatio=sceneCamera.aspectRatio;(this._statesDirty||this.lastNearPlane!==nearPlane||this.lastFieldOfView!==fieldOfView||this.lastAspectRatio!==aspectRatio)&&(this._recalculate(nearPlane,fieldOfView,aspectRatio),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=nearPlane,this.lastFieldOfView=fieldOfView,this.lastAspectRatio=aspectRatio),this._calcLightViewProject(sceneCamera)},__proto._uploadShaderValue=function(){var defDatas=this._scene._defineDatas;switch(this._shadowMapCount){case 1:defDatas.add(Scene3D.SHADERDEFINE_SHADOW_PSSM1),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM2),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM3);break;case 2:defDatas.add(Scene3D.SHADERDEFINE_SHADOW_PSSM2),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM1),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM3);break;case 3:defDatas.add(Scene3D.SHADERDEFINE_SHADOW_PSSM3),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM1),defDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM2)}var sceneSV=this._scene._shaderValues;switch(sceneSV.setVector(Scene3D.SHADOWDISTANCE,this._shaderValueDistance),sceneSV.setBuffer(Scene3D.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP),sceneSV.setVector(Scene3D.SHADOWMAPPCFOFFSET,this._shadowPCFOffset),this._shadowMapCount){case 3:sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget),sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE3,this.cameras[3].renderTarget);break;case 2:sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget);break;case 1:sceneSV.setTexture(Scene3D.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget)}},__proto._calcSplitDistance=function(nearPlane){var far=this._maxDistance,invNumberOfPSSM=1/this._shadowMapCount,i=0;for(i=0;i<=this._shadowMapCount;i++)this._uniformDistance[i]=nearPlane+(far-nearPlane)*i*invNumberOfPSSM;var farDivNear=far/nearPlane;for(i=0;i<=this._shadowMapCount;i++){var n=Math.pow(farDivNear,i*invNumberOfPSSM);this._logDistance[i]=nearPlane*n}for(i=0;i<=this._shadowMapCount;i++)this._spiltDistance[i]=this._uniformDistance[i]*this._ratioOfDistance+this._logDistance[i]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},__proto._calcBoundingBox=function(fieldOfView,aspectRatio){var d,min,max,center,fov=3.1415926*fieldOfView/180,halfTanValue=Math.tan(fov/2),height=NaN,width=NaN,distance=NaN,i=0;for(i=0;i<=this._shadowMapCount;i++){width=(height=(distance=this._spiltDistance[i])*halfTanValue)*aspectRatio;var temp=this._frustumPos[4*i+0].elements;temp[0]=-width,temp[1]=-height,temp[2]=-distance,(temp=this._frustumPos[4*i+1].elements)[0]=width,temp[1]=-height,temp[2]=-distance,(temp=this._frustumPos[4*i+2].elements)[0]=-width,temp[1]=height,temp[2]=-distance,(temp=this._frustumPos[4*i+3].elements)[0]=width,temp[1]=height,temp[2]=-distance,(temp=this._dimension[i].elements)[0]=width,temp[1]=height}for(i=1;i<=this._shadowMapCount;i++)d=this._dimension[i].elements,(min=this._boundingBox[i].min.elements)[0]=-d[0],min[1]=-d[1],min[2]=-this._spiltDistance[i],(max=this._boundingBox[i].max.elements)[0]=d[0],max[1]=d[1],max[2]=-this._spiltDistance[i-1],(center=this._boundingSphere[i].center.elements)[0]=.5*(min[0]+max[0]),center[1]=.5*(min[1]+max[1]),center[2]=.5*(min[2]+max[2]),this._boundingSphere[i].radius=.5*Math.sqrt(Math.pow(max[0]-min[0],2)+Math.pow(max[1]-min[1],2)+Math.pow(max[2]-min[2],2));min=this._boundingBox[0].min.elements,d=this._dimension[this._shadowMapCount].elements,min[0]=-d[0],min[1]=-d[1],min[2]=-this._spiltDistance[this._shadowMapCount],(max=this._boundingBox[0].max.elements)[0]=d[0],max[1]=d[1],max[2]=-this._spiltDistance[0],(center=this._boundingSphere[0].center.elements)[0]=.5*(min[0]+max[0]),center[1]=.5*(min[1]+max[1]),center[2]=.5*(min[2]+max[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(max[0]-min[0],2)+Math.pow(max[1]-min[1],2)+Math.pow(max[2]-min[2],2))},__proto.calcSplitFrustum=function(sceneCamera){this._currentPSSM>0?Matrix4x4.createPerspective(3.1416*sceneCamera.fieldOfView/180,sceneCamera.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):Matrix4x4.createPerspective(3.1416*sceneCamera.fieldOfView/180,sceneCamera.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._shadowMapCount],this._tempMatrix44),Matrix4x4.multiply(this._tempMatrix44,sceneCamera.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},__proto._rebuildRenderInfo=function(){var nNum=this._shadowMapCount+1,i=0;for(this.cameras.length=nNum,i=0;i<nNum;i++){if(!this.cameras[i]){var camera=new Camera;camera.name="lightCamera"+i,camera.clearColor=new Vector4(1,1,1,1),this.cameras[i]=camera}var shadowMap=this.cameras[i].renderTarget;null!=shadowMap&&shadowMap.width==this._shadowMapTextureSize&&shadowMap.height==this._shadowMapTextureSize||(shadowMap&&shadowMap.destroy(),(shadowMap=new RenderTexture(this._shadowMapTextureSize,this._shadowMapTextureSize,1,0)).filterMode=0,this.cameras[i].renderTarget=shadowMap)}},__proto._calcLightViewProject=function(sceneCamera){var boundSphere=this._boundingSphere[this._currentPSSM],cameraMatViewInv=sceneCamera.transform.worldMatrix;boundSphere.radius;boundSphere.center.cloneTo(this._tempLookAt3),Vector3.transformV3ToV4(this._tempLookAt3,cameraMatViewInv,this._tempLookAt4);var lookAt3Element=this._tempLookAt3.elements,lookAt4Element=this._tempLookAt4.elements;lookAt3Element[0]=lookAt4Element[0],lookAt3Element[1]=lookAt4Element[1],lookAt3Element[2]=lookAt4Element[2];var lightUpElement=this._tempLightUp.elements;sceneCamera.transform.worldMatrix.getForward(ParallelSplitShadowMap._tempVector30);var sceneCameraDir=ParallelSplitShadowMap._tempVector30.elements;lightUpElement[0]=sceneCameraDir[0],lightUpElement[1]=1,lightUpElement[2]=sceneCameraDir[2],Vector3.normalize(this._tempLightUp,this._tempLightUp),Vector3.scale(this._globalParallelLightDir,4*boundSphere.radius,this._tempPos),Vector3.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var curLightCamera=this.cameras[this._currentPSSM];curLightCamera.transform.position=this._tempPos,curLightCamera.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var tempMaxElements=this._tempMax.elements,tempMinElements=this._tempMin.elements;tempMaxElements[0]=tempMaxElements[1]=tempMaxElements[2]=-1e5,tempMaxElements[3]=1,tempMinElements[0]=tempMinElements[1]=tempMinElements[2]=1e5,tempMinElements[3]=1,Matrix4x4.multiply(curLightCamera.viewMatrix,cameraMatViewInv,this._tempMatrix44);var tempValueElement=this._tempValue.elements,corners=[];corners.length=8,this._boundingBox[this._currentPSSM].getCorners(corners);for(var i=0;i<8;i++){var frustumPosElements=corners[i].elements;tempValueElement[0]=frustumPosElements[0],tempValueElement[1]=frustumPosElements[1],tempValueElement[2]=frustumPosElements[2],tempValueElement[3]=1,Vector4.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),tempMinElements[0]=tempValueElement[0]<tempMinElements[0]?tempValueElement[0]:tempMinElements[0],tempMinElements[1]=tempValueElement[1]<tempMinElements[1]?tempValueElement[1]:tempMinElements[1],tempMinElements[2]=tempValueElement[2]<tempMinElements[2]?tempValueElement[2]:tempMinElements[2],tempMaxElements[0]=tempValueElement[0]>tempMaxElements[0]?tempValueElement[0]:tempMaxElements[0],tempMaxElements[1]=tempValueElement[1]>tempMaxElements[1]?tempValueElement[1]:tempMaxElements[1],tempMaxElements[2]=tempValueElement[2]>tempMaxElements[2]?tempValueElement[2]:tempMaxElements[2]}Vector4.add(this._tempMax,this._tempMin,this._tempValue),tempValueElement[0]*=.5,tempValueElement[1]*=.5,tempValueElement[2]*=.5,tempValueElement[3]=1,Vector4.transformByM4x4(this._tempValue,curLightCamera.transform.worldMatrix,this._tempValue);var distance=Math.abs(-this._tempMax.z),farPlane=distance>this._maxDistance?distance:this._maxDistance;Vector3.scale(this._globalParallelLightDir,farPlane,this._tempPos);var tempPosElement=this._tempPos.elements;tempPosElement[0]=tempValueElement[0]-tempPosElement[0],tempPosElement[1]=tempValueElement[1]-tempPosElement[1],tempPosElement[2]=tempValueElement[2]-tempPosElement[2],curLightCamera.transform.position=this._tempPos,curLightCamera.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),Matrix4x4.createOrthoOffCenterRH(tempMinElements[0],tempMaxElements[0],tempMinElements[1],tempMaxElements[1],1,farPlane+.5*(tempMaxElements[2]-tempMinElements[2]),curLightCamera.projectionMatrix);var projectView=curLightCamera.projectionViewMatrix;ParallelSplitShadowMap.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,projectView,this._shaderValueVPs[this._currentPSSM]),this._scene._shaderValues.setBuffer(Scene3D.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP)},__proto.setShadowMapTextureSize=function(size){size!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=size,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},__proto.disposeAllRenderTarget=function(){for(var i=0,n=this._shadowMapCount+1;i<n;i++)this.cameras[i].renderTarget&&(this.cameras[i].renderTarget.destroy(),this.cameras[i].renderTarget=null)},__getset(0,__proto,"shadowMapCount",function(){return this._shadowMapCount},function(value){if(value=(value=value>0?value:1)<=3?value:3,this._shadowMapCount!=value){this._shadowMapCount=value,this._ratioOfDistance=1/this._shadowMapCount,this._statesDirty=!0,this._shaderValueLightVP=new Float32Array(16*value),this._shaderValueVPs.length=value;for(var i=0;i<value;i++)this._shaderValueVPs[i]=new Float32Array(this._shaderValueLightVP.buffer,64*i)}}),ParallelSplitShadowMap.multiplyMatrixOutFloat32Array=function(left,right,out){var i,a,b,ai0,ai1,ai2,ai3;for(a=left.elements,b=right.elements,i=0;i<4;i++)ai0=a[i],ai1=a[i+4],ai2=a[i+8],ai3=a[i+12],out[i]=ai0*b[0]+ai1*b[1]+ai2*b[2]+ai3*b[3],out[i+4]=ai0*b[4]+ai1*b[5]+ai2*b[6]+ai3*b[7],out[i+8]=ai0*b[8]+ai1*b[9]+ai2*b[10]+ai3*b[11],out[i+12]=ai0*b[12]+ai1*b[13]+ai2*b[14]+ai3*b[15]},ParallelSplitShadowMap.MAX_PSSM_COUNT=3,__static(ParallelSplitShadowMap,["_tempVector30",function(){return this._tempVector30=new Vector3}]),ParallelSplitShadowMap}(),ColorOverLifetime=function(){function ColorOverLifetime(color){this._color=null,this.enbale=!1,this._color=color}__class(ColorOverLifetime,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var __proto=ColorOverLifetime.prototype;return __proto.cloneTo=function(destObject){var destColorOverLifetime=destObject;this._color.cloneTo(destColorOverLifetime._color),destColorOverLifetime.enbale=this.enbale},__proto.clone=function(){var destColor;switch(this._color.type){case 0:destColor=GradientColor.createByConstant(this._color.constant.clone());break;case 1:destColor=GradientColor.createByGradient(this._color.gradient.clone());break;case 2:destColor=GradientColor.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:destColor=GradientColor.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var destColorOverLifetime=new this.constructor(destColor);return destColorOverLifetime.enbale=this.enbale,destColorOverLifetime},__getset(0,__proto,"color",function(){return this._color}),ColorOverLifetime}(),KeyframeNode=function(){function KeyframeNode(){this._indexInList=0,this.type=0,this.fullPath=null,this.propertyOwner=null,this.data=null,this._ownerPath=[],this._propertys=[],this._keyFrames=[]}__class(KeyframeNode,"laya.d3.animation.KeyframeNode");var __proto=KeyframeNode.prototype;return __proto._setOwnerPathCount=function(value){this._ownerPath.length=value},__proto._setOwnerPathByIndex=function(index,value){this._ownerPath[index]=value},__proto._joinOwnerPath=function(sep){return this._ownerPath.join(sep)},__proto._setPropertyCount=function(value){this._propertys.length=value},__proto._setPropertyByIndex=function(index,value){this._propertys[index]=value},__proto._joinProperty=function(sep){return this._propertys.join(sep)},__proto._setKeyframeCount=function(value){this._keyFrames.length=value},__proto._setKeyframeByIndex=function(index,value){this._keyFrames[index]=value},__proto.getOwnerPathByIndex=function(index){return this._ownerPath[index]},__proto.getPropertyByIndex=function(index){return this._propertys[index]},__proto.getKeyframeByIndex=function(index){return this._keyFrames[index]},__getset(0,__proto,"ownerPathCount",function(){return this._ownerPath.length}),__getset(0,__proto,"propertyCount",function(){return this._propertys.length}),__getset(0,__proto,"keyFramesCount",function(){return this._keyFrames.length}),KeyframeNode}(),Matrix3x3=function(){function Matrix3x3(){var e=this.elements=new Float32Array(9);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1}__class(Matrix3x3,"laya.d3.math.Matrix3x3");var __proto=Matrix3x3.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.determinant=function(){var f=this.elements,a00=f[0],a01=f[1],a02=f[2],a10=f[3],a11=f[4],a12=f[5],a20=f[6],a21=f[7],a22=f[8];return a00*(a22*a11-a12*a21)+a01*(-a22*a10+a12*a20)+a02*(a21*a10-a11*a20)},__proto.translate=function(trans,out){var e=out.elements,f=this.elements,g=trans.elements,a00=f[0],a01=f[1],a02=f[2],a10=f[3],a11=f[4],a12=f[5],a20=f[6],a21=f[7],a22=f[8],x=g[0],y=g[1];e[0]=a00,e[1]=a01,e[2]=a02,e[3]=a10,e[4]=a11,e[5]=a12,e[6]=x*a00+y*a10+a20,e[7]=x*a01+y*a11+a21,e[8]=x*a02+y*a12+a22},__proto.rotate=function(rad,out){var e=out.elements,f=this.elements,a00=f[0],a01=f[1],a02=f[2],a10=f[3],a11=f[4],a12=f[5],a20=f[6],a21=f[7],a22=f[8],s=Math.sin(rad),c=Math.cos(rad);e[0]=c*a00+s*a10,e[1]=c*a01+s*a11,e[2]=c*a02+s*a12,e[3]=c*a10-s*a00,e[4]=c*a11-s*a01,e[5]=c*a12-s*a02,e[6]=a20,e[7]=a21,e[8]=a22},__proto.scale=function(scale,out){var e=out.elements,f=this.elements,g=scale.elements,x=g[0],y=g[1];e[0]=x*f[0],e[1]=x*f[1],e[2]=x*f[2],e[3]=y*f[3],e[4]=y*f[4],e[5]=y*f[5],e[6]=f[6],e[7]=f[7],e[8]=f[8]},__proto.invert=function(out){var e=out.elements,f=this.elements,a00=f[0],a01=f[1],a02=f[2],a10=f[3],a11=f[4],a12=f[5],a20=f[6],a21=f[7],a22=f[8],b01=a22*a11-a12*a21,b11=-a22*a10+a12*a20,b21=a21*a10-a11*a20,det=a00*b01+a01*b11+a02*b21;det||(out=null),det=1/det,e[0]=b01*det,e[1]=(-a22*a01+a02*a21)*det,e[2]=(a12*a01-a02*a11)*det,e[3]=b11*det,e[4]=(a22*a00-a02*a20)*det,e[5]=(-a12*a00+a02*a10)*det,e[6]=b21*det,e[7]=(-a21*a00+a01*a20)*det,e[8]=(a11*a00-a01*a10)*det},__proto.transpose=function(out){var e=out.elements,f=this.elements;if(out===this){var a01=f[1],a02=f[2],a12=f[5];e[1]=f[3],e[2]=f[6],e[3]=a01,e[5]=f[7],e[6]=a02,e[7]=a12}else e[0]=f[0],e[1]=f[3],e[2]=f[6],e[3]=f[1],e[4]=f[4],e[5]=f[7],e[6]=f[2],e[7]=f[5],e[8]=f[8]},__proto.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},__proto.cloneTo=function(destObject){var i,s,d;if((s=this.elements)!==(d=destObject.elements))for(i=0;i<9;++i)d[i]=s[i]},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},Matrix3x3.createFromTranslation=function(trans,out){out.elements;var g=trans.elements;out[0]=1,out[1]=0,out[2]=0,out[3]=0,out[4]=1,out[5]=0,out[6]=g[0],out[7]=g[1],out[8]=1},Matrix3x3.createFromRotation=function(rad,out){var e=out.elements,s=Math.sin(rad),c=Math.cos(rad);e[0]=c,e[1]=s,e[2]=0,e[3]=-s,e[4]=c,e[5]=0,e[6]=0,e[7]=0,e[8]=1},Matrix3x3.createFromScaling=function(scale,out){var e=out.elements,g=scale.elements;e[0]=g[0],e[1]=0,e[2]=0,e[3]=0,e[4]=g[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1},Matrix3x3.createFromMatrix4x4=function(sou,out){out[0]=sou[0],out[1]=sou[1],out[2]=sou[2],out[3]=sou[4],out[4]=sou[5],out[5]=sou[6],out[6]=sou[8],out[7]=sou[9],out[8]=sou[10]},Matrix3x3.multiply=function(left,right,out){var e=out.elements,f=left.elements,g=right.elements,a00=f[0],a01=f[1],a02=f[2],a10=f[3],a11=f[4],a12=f[5],a20=f[6],a21=f[7],a22=f[8],b00=g[0],b01=g[1],b02=g[2],b10=g[3],b11=g[4],b12=g[5],b20=g[6],b21=g[7],b22=g[8];e[0]=b00*a00+b01*a10+b02*a20,e[1]=b00*a01+b01*a11+b02*a21,e[2]=b00*a02+b01*a12+b02*a22,e[3]=b10*a00+b11*a10+b12*a20,e[4]=b10*a01+b11*a11+b12*a21,e[5]=b10*a02+b11*a12+b12*a22,e[6]=b20*a00+b21*a10+b22*a20,e[7]=b20*a01+b21*a11+b22*a21,e[8]=b20*a02+b21*a12+b22*a22},Matrix3x3.lookAt=function(eye,target,up,out){Vector3.subtract(eye,target,Matrix3x3._tempV30),Vector3.normalize(Matrix3x3._tempV30,Matrix3x3._tempV30),Vector3.cross(up,Matrix3x3._tempV30,Matrix3x3._tempV31),Vector3.normalize(Matrix3x3._tempV31,Matrix3x3._tempV31),Vector3.cross(Matrix3x3._tempV30,Matrix3x3._tempV31,Matrix3x3._tempV32);var v0e=Matrix3x3._tempV30.elements,v1e=Matrix3x3._tempV31.elements,v2e=Matrix3x3._tempV32.elements,me=out.elements;me[0]=v1e[0],me[3]=v1e[1],me[6]=v1e[2],me[1]=v2e[0],me[4]=v2e[1],me[7]=v2e[2],me[2]=v0e[0],me[5]=v0e[1],me[8]=v0e[2]},Matrix3x3.DEFAULT=new Matrix3x3,__static(Matrix3x3,["_tempV30",function(){return this._tempV30=new Vector3},"_tempV31",function(){return this._tempV31=new Vector3},"_tempV32",function(){return this._tempV32=new Vector3}]),Matrix3x3}(),VertexPositionTexture0=function(){function VertexPositionTexture0(position,textureCoordinate0){this._position=null,this._textureCoordinate0=null,this._position=position,this._textureCoordinate0=textureCoordinate0}__class(VertexPositionTexture0,"laya.d3.graphics.Vertex.VertexPositionTexture0");var __proto=VertexPositionTexture0.prototype;return Laya.imps(__proto,{"laya.d3.graphics.IVertex":!0}),__getset(0,__proto,"position",function(){return this._position}),__getset(0,__proto,"textureCoordinate0",function(){return this._textureCoordinate0}),__getset(0,__proto,"vertexDeclaration",function(){return VertexPositionTexture0._vertexDeclaration}),__getset(1,VertexPositionTexture0,"vertexDeclaration",function(){return VertexPositionTexture0._vertexDeclaration}),__static(VertexPositionTexture0,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(20,[new VertexElement(0,"vector3",0),new VertexElement(12,"vector2",2)])}]),VertexPositionTexture0}(),AnimationClipParser03=function(){function AnimationClipParser03(){}return __class(AnimationClipParser03,"laya.d3.animation.AnimationClipParser03"),AnimationClipParser03.READ_DATA=function(){AnimationClipParser03._DATA.offset=AnimationClipParser03._reader.getUint32(),AnimationClipParser03._DATA.size=AnimationClipParser03._reader.getUint32()},AnimationClipParser03.READ_BLOCK=function(){for(var count=AnimationClipParser03._BLOCK.count=AnimationClipParser03._reader.getUint16(),blockStarts=AnimationClipParser03._BLOCK.blockStarts=[],blockLengths=AnimationClipParser03._BLOCK.blockLengths=[],i=0;i<count;i++)blockStarts.push(AnimationClipParser03._reader.getUint32()),blockLengths.push(AnimationClipParser03._reader.getUint32())},AnimationClipParser03.READ_STRINGS=function(){var offset=AnimationClipParser03._reader.getUint32(),count=AnimationClipParser03._reader.getUint16(),prePos=AnimationClipParser03._reader.pos;AnimationClipParser03._reader.pos=offset+AnimationClipParser03._DATA.offset;for(var i=0;i<count;i++)AnimationClipParser03._strings[i]=AnimationClipParser03._reader.readUTFString();AnimationClipParser03._reader.pos=prePos},AnimationClipParser03.parse=function(clip,reader){AnimationClipParser03._animationClip=clip,AnimationClipParser03._reader=reader;reader.__getBuffer();AnimationClipParser03.READ_DATA(),AnimationClipParser03.READ_BLOCK(),AnimationClipParser03.READ_STRINGS();for(var i=0,n=AnimationClipParser03._BLOCK.count;i<n;i++){var index=reader.getUint16(),blockName=AnimationClipParser03._strings[index],fn=AnimationClipParser03["READ_"+blockName];if(null==fn)throw new Error("model file err,no this function:"+index+" "+blockName);fn.call()}},AnimationClipParser03.READ_ANIMATIONS=function(){var node,i=0,j=0,reader=AnimationClipParser03._reader,startTimeTypes=(reader.__getBuffer(),[]),startTimeTypeCount=reader.getUint16();for(startTimeTypes.length=startTimeTypeCount,i=0;i<startTimeTypeCount;i++)startTimeTypes[i]=reader.getFloat32();var clip=AnimationClipParser03._animationClip;clip.name=AnimationClipParser03._strings[reader.getUint16()];clip._duration=reader.getFloat32();clip.islooping=!!reader.getByte(),clip._frameRate=reader.getInt16();var nodeCount=reader.getInt16(),nodes=clip._nodes;nodes.count=nodeCount;var nodesMap=clip._nodesMap={},nodesDic=clip._nodesDic={};for(i=0;i<nodeCount;i++){node=new KeyframeNode,nodes.setNodeByIndex(i,node),node._indexInList=i;var type=node.type=reader.getUint8(),pathLength=reader.getUint16();for(node._setOwnerPathCount(pathLength),j=0;j<pathLength;j++)node._setOwnerPathByIndex(j,AnimationClipParser03._strings[reader.getUint16()]);var nodePath=node._joinOwnerPath("/"),mapArray=nodesMap[nodePath];mapArray||(nodesMap[nodePath]=mapArray=[]),mapArray.push(node),node.propertyOwner=AnimationClipParser03._strings[reader.getUint16()];var propertyLength=reader.getUint16();for(node._setPropertyCount(propertyLength),j=0;j<propertyLength;j++)node._setPropertyByIndex(j,AnimationClipParser03._strings[reader.getUint16()]);var fullPath=nodePath+"."+node.propertyOwner+"."+node._joinProperty(".");nodesDic[fullPath]=node,node.fullPath=fullPath;var keyframeCount=reader.getUint16();node._setKeyframeCount(keyframeCount);switch(type){case 0:break;case 1:case 3:case 4:node.data=new Float32Array(3);break;case 2:node.data=new Float32Array(4);break;default:throw"AnimationClipParser03:unknown type."}for(j=0;j<keyframeCount;j++)switch(type){case 0:var floatKeyframe=new FloatKeyframe;node._setKeyframeByIndex(j,floatKeyframe),floatKeyframe.time=startTimeTypes[reader.getUint16()],floatKeyframe.inTangent=reader.getFloat32(),floatKeyframe.outTangent=reader.getFloat32(),floatKeyframe.value=reader.getFloat32();break;case 1:case 3:case 4:var floatArrayKeyframe=new FloatArrayKeyframe;node._setKeyframeByIndex(j,floatArrayKeyframe),floatArrayKeyframe.time=startTimeTypes[reader.getUint16()];for(var data=floatArrayKeyframe.data=new Float32Array(9),k=0;k<3;k++)data[k]=reader.getFloat32();for(k=0;k<3;k++)data[3+k]=reader.getFloat32();for(k=0;k<3;k++)data[6+k]=reader.getFloat32();break;case 2:for(floatArrayKeyframe=new FloatArrayKeyframe,node._setKeyframeByIndex(j,floatArrayKeyframe),floatArrayKeyframe.time=startTimeTypes[reader.getUint16()],data=floatArrayKeyframe.data=new Float32Array(12),k=0;k<4;k++)data[k]=reader.getFloat32();for(k=0;k<4;k++)data[4+k]=reader.getFloat32();for(k=0;k<4;k++)data[8+k]=reader.getFloat32();break;default:throw"AnimationClipParser03:unknown type."}}var eventCount=reader.getUint16();for(i=0;i<eventCount;i++){var params,event=new AnimationEvent;event.time=reader.getFloat32(),event.eventName=AnimationClipParser03._strings[reader.getUint16()];var paramCount=reader.getUint16();for(paramCount>0&&(event.params=params=[]),j=0;j<paramCount;j++){switch(reader.getByte()){case 0:params.push(!!reader.getByte());break;case 1:params.push(reader.getInt32());break;case 2:params.push(reader.getFloat32());break;case 3:params.push(AnimationClipParser03._strings[reader.getUint16()]);break;default:throw new Error("unknown type.")}}clip.addEvent(event)}},AnimationClipParser03._animationClip=null,AnimationClipParser03._reader=null,AnimationClipParser03._strings=[],__static(AnimationClipParser03,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),AnimationClipParser03}(),TerrainLeaf=function(){function TerrainLeaf(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,TerrainLeaf.__init__(),this._currentLODLevel=0}__class(TerrainLeaf,"laya.d3.terrain.TerrainLeaf");var __proto=TerrainLeaf.prototype;return __proto.calcVertextNorml=function(x,z,terrainHeightData,heighDataWidth,heightDataHeight,normal){var dZ=0,dX=0;dX=-1*TerrainLeaf.getHeightFromTerrainHeightData(x-1,z-1,terrainHeightData,heighDataWidth,heightDataHeight),dX+=-1*TerrainLeaf.getHeightFromTerrainHeightData(x-1,z,terrainHeightData,heighDataWidth,heightDataHeight),dX+=-1*TerrainLeaf.getHeightFromTerrainHeightData(x-1,z+1,terrainHeightData,heighDataWidth,heightDataHeight),dX+=1*TerrainLeaf.getHeightFromTerrainHeightData(x+1,z-1,terrainHeightData,heighDataWidth,heightDataHeight),dX+=1*TerrainLeaf.getHeightFromTerrainHeightData(x+1,z,terrainHeightData,heighDataWidth,heightDataHeight),dX+=1*TerrainLeaf.getHeightFromTerrainHeightData(x+1,z+1,terrainHeightData,heighDataWidth,heightDataHeight),dZ=-1*TerrainLeaf.getHeightFromTerrainHeightData(x-1,z-1,terrainHeightData,heighDataWidth,heightDataHeight),dZ+=-1*TerrainLeaf.getHeightFromTerrainHeightData(x,z-1,terrainHeightData,heighDataWidth,heightDataHeight),dZ+=-1*TerrainLeaf.getHeightFromTerrainHeightData(x+1,z-1,terrainHeightData,heighDataWidth,heightDataHeight),dZ+=1*TerrainLeaf.getHeightFromTerrainHeightData(x-1,z+1,terrainHeightData,heighDataWidth,heightDataHeight),dZ+=1*TerrainLeaf.getHeightFromTerrainHeightData(x,z+1,terrainHeightData,heighDataWidth,heightDataHeight),dZ+=1*TerrainLeaf.getHeightFromTerrainHeightData(x+1,z+1,terrainHeightData,heighDataWidth,heightDataHeight),normal.x=-dX,normal.y=6,normal.z=-dZ,Vector3.normalize(normal,normal)},__proto.calcVertextNormlUV=function(x,z,terrainWidth,terrainHeight,normal){normal.x=x/terrainWidth,normal.y=z/terrainHeight,normal.z=z/terrainHeight},__proto.calcVertextBuffer=function(offsetChunkX,offsetChunkZ,beginX,beginZ,girdSize,vertextBuffer,offset,strideSize,terrainHeightData,heighDataWidth,heightDataHeight,cameraCoordinateInverse){if(1==cameraCoordinateInverse&&!TerrainLeaf.__ADAPT_MATRIX__){TerrainLeaf.__ADAPT_MATRIX__=new Matrix4x4;var mat=new Matrix4x4;Matrix4x4.createRotationY(Math.PI,TerrainLeaf.__ADAPT_MATRIX__),Matrix4x4.createTranslate(new Vector3(0,0,(heightDataHeight-1)*girdSize),mat),Matrix4x4.multiply(mat,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__ADAPT_MATRIX__),TerrainLeaf.__ADAPT_MATRIX_INV__=new Matrix4x4,TerrainLeaf.__ADAPT_MATRIX__.invert(TerrainLeaf.__ADAPT_MATRIX_INV__)}this._gridSize=girdSize,this._beginGridX=offsetChunkX*TerrainLeaf.CHUNK_GRID_NUM+beginX,this._beginGridZ=offsetChunkZ*TerrainLeaf.CHUNK_GRID_NUM+beginZ;for(var nNum=offset*strideSize,minY=2147483647,maxY=-2147483648,normal=new Vector3,i=0,s=TerrainLeaf.LEAF_GRID_NUM+1;i<s;i++)for(var j=0,s1=TerrainLeaf.LEAF_GRID_NUM+1;j<s1;j++)TerrainLeaf.__VECTOR3__.x=(this._beginGridX+j)*this._gridSize,TerrainLeaf.__VECTOR3__.z=(this._beginGridZ+i)*this._gridSize,TerrainLeaf.__VECTOR3__.y=terrainHeightData[(this._beginGridZ+i)*heighDataWidth+(this._beginGridX+j)],minY=TerrainLeaf.__VECTOR3__.y<minY?TerrainLeaf.__VECTOR3__.y:minY,maxY=TerrainLeaf.__VECTOR3__.y>maxY?TerrainLeaf.__VECTOR3__.y:maxY,TerrainLeaf.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(TerrainLeaf.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__VECTOR3__),vertextBuffer[nNum]=TerrainLeaf.__VECTOR3__.x,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.y,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.z,nNum++,this.calcVertextNormlUV(this._beginGridX+j,this._beginGridZ+i,heighDataWidth,heightDataHeight,normal),vertextBuffer[nNum]=normal.x,vertextBuffer[++nNum]=normal.y,vertextBuffer[++nNum]=normal.z,vertextBuffer[++nNum]=(beginX+j)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=(beginZ+i)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=this._beginGridX+j,vertextBuffer[++nNum]=this._beginGridZ+i,nNum++;this._sizeOfY=new Vector2(minY-1,maxY+1),this.calcLODErrors(terrainHeightData,heighDataWidth,heightDataHeight),this.calcOriginalBoudingBoxAndSphere()},__proto.calcSkirtVertextBuffer=function(offsetChunkX,offsetChunkZ,beginX,beginZ,girdSize,vertextBuffer,offset,strideSize,terrainHeightData,heighDataWidth,heightDataHeight){this._gridSize=girdSize,this._beginGridX=offsetChunkX*TerrainLeaf.CHUNK_GRID_NUM+beginX,this._beginGridZ=offsetChunkZ*TerrainLeaf.CHUNK_GRID_NUM+beginZ;var nNum=offset*strideSize,i=0,j=0,s=TerrainLeaf.LEAF_GRID_NUM+1,normal=new Vector3,hZIndex=0,hXIndex=0;for(i=0;i<2;i++)for(j=0;j<s;j++)TerrainLeaf.__VECTOR3__.x=(this._beginGridX+j)*this._gridSize,TerrainLeaf.__VECTOR3__.y=1==i?terrainHeightData[this._beginGridZ*heighDataWidth+(this._beginGridX+j)]:-this._gridSize,TerrainLeaf.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,TerrainLeaf.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(TerrainLeaf.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__VECTOR3__),vertextBuffer[nNum]=TerrainLeaf.__VECTOR3__.x,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.y,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.z,nNum++,hZIndex=0==i?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+j,hZIndex,heighDataWidth,heightDataHeight,normal),vertextBuffer[nNum]=normal.x,vertextBuffer[++nNum]=normal.y,vertextBuffer[++nNum]=normal.z,vertextBuffer[++nNum]=(beginX+j)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=(beginZ+0)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=this._beginGridX+j,vertextBuffer[++nNum]=hZIndex,nNum++;for(i=0;i<2;i++)for(j=0;j<s;j++)TerrainLeaf.__VECTOR3__.x=(this._beginGridX+j)*this._gridSize,TerrainLeaf.__VECTOR3__.y=0==i?terrainHeightData[(this._beginGridZ+TerrainLeaf.LEAF_GRID_NUM)*heighDataWidth+(this._beginGridX+j)]:-this._gridSize,TerrainLeaf.__VECTOR3__.z=(this._beginGridZ+TerrainLeaf.LEAF_GRID_NUM)*this._gridSize,TerrainLeaf.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(TerrainLeaf.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__VECTOR3__),vertextBuffer[nNum]=TerrainLeaf.__VECTOR3__.x,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.y,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.z,nNum++,hZIndex=0==i?this._beginGridZ+TerrainLeaf.LEAF_GRID_NUM:this._beginGridZ+TerrainLeaf.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+j,hZIndex,heighDataWidth,heightDataHeight,normal),vertextBuffer[nNum]=normal.x,vertextBuffer[++nNum]=normal.y,vertextBuffer[++nNum]=normal.z,vertextBuffer[++nNum]=(beginX+j)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=(beginZ+TerrainLeaf.LEAF_GRID_NUM)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=this._beginGridX+j,vertextBuffer[++nNum]=hZIndex,nNum++;for(i=0;i<2;i++)for(j=0;j<s;j++)TerrainLeaf.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,TerrainLeaf.__VECTOR3__.y=0==i?terrainHeightData[(this._beginGridZ+j)*heighDataWidth+(this._beginGridX+0)]:-this._gridSize,TerrainLeaf.__VECTOR3__.z=(this._beginGridZ+j)*this._gridSize,TerrainLeaf.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(TerrainLeaf.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__VECTOR3__),vertextBuffer[nNum]=TerrainLeaf.__VECTOR3__.x,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.y,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.z,nNum++,hXIndex=0==i?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(hXIndex,this._beginGridZ+j,heighDataWidth,heightDataHeight,normal),vertextBuffer[nNum]=normal.x,vertextBuffer[++nNum]=normal.y,vertextBuffer[++nNum]=normal.z,vertextBuffer[++nNum]=(beginX+0)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=(beginZ+j)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=hXIndex,vertextBuffer[++nNum]=this._beginGridZ+j,nNum++;for(i=0;i<2;i++)for(j=0;j<s;j++)TerrainLeaf.__VECTOR3__.x=(this._beginGridX+TerrainLeaf.LEAF_GRID_NUM)*this._gridSize,TerrainLeaf.__VECTOR3__.y=1==i?terrainHeightData[(this._beginGridZ+j)*heighDataWidth+(this._beginGridX+TerrainLeaf.LEAF_GRID_NUM)]:-this._gridSize,TerrainLeaf.__VECTOR3__.z=(this._beginGridZ+j)*this._gridSize,TerrainLeaf.__ADAPT_MATRIX__&&Vector3.transformV3ToV3(TerrainLeaf.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX__,TerrainLeaf.__VECTOR3__),vertextBuffer[nNum]=TerrainLeaf.__VECTOR3__.x,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.y,vertextBuffer[++nNum]=TerrainLeaf.__VECTOR3__.z,nNum++,hXIndex=0==i?this._beginGridX+TerrainLeaf.LEAF_GRID_NUM+1:this._beginGridX+TerrainLeaf.LEAF_GRID_NUM,this.calcVertextNormlUV(hXIndex,this._beginGridZ+j,heighDataWidth,heightDataHeight,normal),vertextBuffer[nNum]=normal.x,vertextBuffer[++nNum]=normal.y,vertextBuffer[++nNum]=normal.z,vertextBuffer[++nNum]=(beginX+TerrainLeaf.LEAF_GRID_NUM)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=(beginZ+j)/TerrainLeaf.CHUNK_GRID_NUM,vertextBuffer[++nNum]=hXIndex,vertextBuffer[++nNum]=this._beginGridZ+j,nNum++},__proto.calcOriginalBoudingBoxAndSphere=function(){var min=new Vector3(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),max=new Vector3((this._beginGridX+TerrainLeaf.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+TerrainLeaf.LEAF_GRID_NUM)*this._gridSize);TerrainLeaf.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(min,TerrainLeaf.__ADAPT_MATRIX__,min),Vector3.transformV3ToV3(max,TerrainLeaf.__ADAPT_MATRIX__,max)),this._originalBoundingBox=new BoundBox(min,max);var size=new Vector3;Vector3.subtract(max,min,size),Vector3.scale(size,.5,size);var center=new Vector3;Vector3.add(min,size,center),this._originalBoundingSphere=new BoundSphere(center,Vector3.scalarLength(size)),this._originalBoundingBoxCorners=__newvec(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new BoundBox(new Vector3(-.5,-.5,-.5),new Vector3(.5,.5,.5)),this._boundingSphere=new BoundSphere(new Vector3(0,0,0),1)},__proto.calcLeafBoudingBox=function(worldMatrix){for(var i=0;i<8;i++)Vector3.transformCoordinate(this._originalBoundingBoxCorners[i],worldMatrix,BaseRender._tempBoundBoxCorners[i]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox)},__proto.calcLeafBoudingSphere=function(worldMatrix,maxScale){Vector3.transformCoordinate(this._originalBoundingSphere.center,worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*maxScale},__proto.calcLODErrors=function(terrainHeightData,heighDataWidth,heightDataHeight){this._LODError=new Float32Array(TerrainLeaf._maxLODLevel+1);for(var step=1,i=0,n=TerrainLeaf._maxLODLevel+1;i<n;i++){for(var maxError=0,y=0,n1=TerrainLeaf.LEAF_GRID_NUM;y<n1;y+=step)for(var x=0,n2=TerrainLeaf.LEAF_GRID_NUM;x<n2;x+=step)for(var z00=terrainHeightData[(this._beginGridZ+y)*heighDataWidth+(this._beginGridX+x)],z10=terrainHeightData[(this._beginGridZ+y)*heighDataWidth+(this._beginGridX+x)+step],z01=terrainHeightData[(this._beginGridZ+y+step)*heighDataWidth+(this._beginGridX+x)],z11=terrainHeightData[(this._beginGridZ+y+step)*heighDataWidth+(this._beginGridX+x)+step],j=0;j<step;j++)for(var ys=j/step,k=0;k<step;k++){var xs=k/step,z=terrainHeightData[(this._beginGridZ+y+j)*heighDataWidth+(this._beginGridX+x)+k],iz=xs+ys<=1?z00+(z10-z00)*xs+(z01-z00)*ys:z11+(z01-z11)*(1-xs)+(z10-z11)*(1-ys),error=Math.abs(iz-z);maxError=Math.max(maxError,error)}step*=2,this._LODError[i]=maxError}},__proto.determineLod=function(eyePos,perspectiveFactor,tolerance,tolerAndPerspectiveChanged){var nDistanceToEye=Vector3.distance(eyePos,this._boundingSphere.center),n=TerrainLeaf._maxLODLevel;if(!tolerAndPerspectiveChanged){if(this._lastDistanceToEye==nDistanceToEye)return this._currentLODLevel;this._lastDistanceToEye>nDistanceToEye&&(n=this._currentLODLevel)}for(var i=n;i>=1;i--)if(Terrain.LOD_DISTANCE_FACTOR*this._LODError[i]/nDistanceToEye*perspectiveFactor<tolerance){this._currentLODLevel=i;break}return this._lastDistanceToEye=nDistanceToEye,this._currentLODLevel},TerrainLeaf.__init__=function(){if(!TerrainLeaf._bInit){var nLeafNum=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM);TerrainLeaf._planeLODIndex=__newvec(nLeafNum);var i=0,j=0,k=0,n=0,n1=0,nOffset=0,nOriginIndexArray=null,nTempIndex=null;for(i=0;i<nLeafNum;i++)TerrainLeaf._planeLODIndex[i]=new Array(TerrainLeaf._maxLODLevel+1);for(i=0,n=TerrainLeaf._maxLODLevel+1;i<n;i++)TerrainLeaf._planeLODIndex[0][i]=TerrainLeaf.calcPlaneLODIndex(i);for(i=1;i<nLeafNum;i++)for(nOffset=i*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT,j=0,n1=TerrainLeaf._maxLODLevel+1;j<n1;j++){for(nOriginIndexArray=TerrainLeaf._planeLODIndex[0][j],nTempIndex=new Uint16Array(nOriginIndexArray.length),k=0;k<nOriginIndexArray.length;k++)nTempIndex[k]=nOriginIndexArray[k]+nOffset;TerrainLeaf._planeLODIndex[i][j]=nTempIndex}for(TerrainLeaf._skirtLODIndex=__newvec(nLeafNum),i=0;i<nLeafNum;i++)TerrainLeaf._skirtLODIndex[i]=new Array(TerrainLeaf._maxLODLevel+1);for(i=0,n=TerrainLeaf._maxLODLevel+1;i<n;i++)TerrainLeaf._skirtLODIndex[0][i]=TerrainLeaf.calcSkirtLODIndex(i);for(i=1;i<nLeafNum;i++)for(nOffset=i*TerrainLeaf.LEAF_SKIRT_VERTEXT_COUNT,j=0,n1=TerrainLeaf._maxLODLevel+1;j<n1;j++){for(nOriginIndexArray=TerrainLeaf._skirtLODIndex[0][j],nTempIndex=new Uint16Array(nOriginIndexArray.length),k=0;k<nOriginIndexArray.length;k++)nTempIndex[k]=nOriginIndexArray[k]+nOffset;TerrainLeaf._skirtLODIndex[i][j]=nTempIndex}TerrainLeaf._bInit=!0}},TerrainLeaf.getPlaneLODIndex=function(leafIndex,LODLevel){return TerrainLeaf._planeLODIndex[leafIndex][LODLevel]},TerrainLeaf.getSkirtLODIndex=function(leafIndex,LODLevel){return TerrainLeaf._skirtLODIndex[leafIndex][LODLevel]},TerrainLeaf.calcPlaneLODIndex=function(level){level>TerrainLeaf._maxLODLevel&&(level=TerrainLeaf._maxLODLevel);var nGridNumAddOne=TerrainLeaf.LEAF_GRID_NUM+1,nNum=0,indexBuffer=null,nLODGridNum=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,level);indexBuffer=new Uint16Array(nLODGridNum*nLODGridNum*6);for(var nGridSpace=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/nLODGridNum,i=0;i<TerrainLeaf.LEAF_GRID_NUM;i+=nGridSpace)for(var j=0;j<TerrainLeaf.LEAF_GRID_NUM;j+=nGridSpace)indexBuffer[nNum]=(i+nGridSpace)*nGridNumAddOne+j,indexBuffer[++nNum]=i*nGridNumAddOne+j,indexBuffer[++nNum]=i*nGridNumAddOne+j+nGridSpace,indexBuffer[++nNum]=i*nGridNumAddOne+j+nGridSpace,indexBuffer[++nNum]=(i+nGridSpace)*nGridNumAddOne+j+nGridSpace,indexBuffer[++nNum]=(i+nGridSpace)*nGridNumAddOne+j,nNum++;return indexBuffer},TerrainLeaf.calcSkirtLODIndex=function(level){level>TerrainLeaf._maxLODLevel&&(level=TerrainLeaf._maxLODLevel);var nSkirtIndexOffset=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM)*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT,nGridNumAddOne=TerrainLeaf.LEAF_GRID_NUM+1,nNum=0,indexBuffer=null,nLODGridNum=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,level);indexBuffer=new Uint16Array(4*nLODGridNum*6);for(var nGridSpace=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/nLODGridNum,j=0;j<4;j++){for(var i=0;i<TerrainLeaf.LEAF_GRID_NUM;i+=nGridSpace)indexBuffer[nNum]=nSkirtIndexOffset+nGridNumAddOne+i,indexBuffer[++nNum]=nSkirtIndexOffset+i,indexBuffer[++nNum]=nSkirtIndexOffset+i+nGridSpace,indexBuffer[++nNum]=nSkirtIndexOffset+i+nGridSpace,indexBuffer[++nNum]=nSkirtIndexOffset+nGridNumAddOne+i+nGridSpace,indexBuffer[++nNum]=nSkirtIndexOffset+nGridNumAddOne+i,nNum++;nSkirtIndexOffset+=2*nGridNumAddOne}return indexBuffer},TerrainLeaf.getHeightFromTerrainHeightData=function(x,z,terrainHeightData,heighDataWidth,heightDataHeight){return terrainHeightData[(z=(z=z<0?0:z)>=heightDataHeight?heightDataHeight-1:z)*heighDataWidth+(x=(x=x<0?0:x)>=heighDataWidth?heighDataWidth-1:x)]},TerrainLeaf.CHUNK_GRID_NUM=64,TerrainLeaf.LEAF_GRID_NUM=32,TerrainLeaf.__ADAPT_MATRIX__=null,TerrainLeaf.__ADAPT_MATRIX_INV__=null,TerrainLeaf._planeLODIndex=null,TerrainLeaf._skirtLODIndex=null,TerrainLeaf._bInit=!1,__static(TerrainLeaf,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(TerrainLeaf.LEAF_GRID_NUM+1)*(TerrainLeaf.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(TerrainLeaf.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT+TerrainLeaf.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=TerrainLeaf.LEAF_GRID_NUM*TerrainLeaf.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*TerrainLeaf.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=TerrainLeaf.LEAF_PLANE_MAX_INDEX_COUNT+TerrainLeaf.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new Vector3},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(TerrainLeaf.LEAF_GRID_NUM)}]),TerrainLeaf}(),Matrix4x4=(function(){function PixelLineData(){this.startPosition=new Vector3,this.endPosition=new Vector3,this.startColor=new Color,this.endColor=new Color}__class(PixelLineData,"laya.d3.core.pixelLine.PixelLineData"),PixelLineData.prototype.cloneTo=function(destObject){this.startPosition.cloneTo(destObject.startPosition),this.endPosition.cloneTo(destObject.endPosition),this.startColor.cloneTo(destObject.startColor),this.endColor.cloneTo(destObject.endColor)}}(),function(){function Matrix4x4(m11,m12,m13,m14,m21,m22,m23,m24,m31,m32,m33,m34,m41,m42,m43,m44,elements){void 0===m11&&(m11=1),void 0===m12&&(m12=0),void 0===m13&&(m13=0),void 0===m14&&(m14=0),void 0===m21&&(m21=0),void 0===m22&&(m22=1),void 0===m23&&(m23=0),void 0===m24&&(m24=0),void 0===m31&&(m31=0),void 0===m32&&(m32=0),void 0===m33&&(m33=1),void 0===m34&&(m34=0),void 0===m41&&(m41=0),void 0===m42&&(m42=0),void 0===m43&&(m43=0),void 0===m44&&(m44=1);var e=this.elements=elements||new Float32Array(16);e[0]=m11,e[1]=m12,e[2]=m13,e[3]=m14,e[4]=m21,e[5]=m22,e[6]=m23,e[7]=m24,e[8]=m31,e[9]=m32,e[10]=m33,e[11]=m34,e[12]=m41,e[13]=m42,e[14]=m43,e[15]=m44}__class(Matrix4x4,"laya.d3.math.Matrix4x4");var __proto=Matrix4x4.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.setRotation=function(rotation){var rotationE=rotation.elements,rotationX=rotationE[0],rotationY=rotationE[1],rotationZ=rotationE[2],rotationW=rotationE[3],xx=rotationX*rotationX,yy=rotationY*rotationY,zz=rotationZ*rotationZ,xy=rotationX*rotationY,zw=rotationZ*rotationW,zx=rotationZ*rotationX,yw=rotationY*rotationW,yz=rotationY*rotationZ,xw=rotationX*rotationW,e=this.elements;e[0]=1-2*(yy+zz),e[1]=2*(xy+zw),e[2]=2*(zx-yw),e[4]=2*(xy-zw),e[5]=1-2*(zz+xx),e[6]=2*(yz+xw),e[8]=2*(zx+yw),e[9]=2*(yz-xw),e[10]=1-2*(yy+xx)},__proto.setPosition=function(position){var positione=position.elements,e=this.elements;e[12]=positione[0],e[13]=positione[1],e[14]=positione[2]},__proto.getElementByRowColumn=function(row,column){if(row<0||row>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(column<0||column>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*row+column]},__proto.setElementByRowColumn=function(row,column,value){if(row<0||row>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(column<0||column>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*row+column]=value},__proto.equalsOtherMatrix=function(other){var e=this.elements,oe=other.elements;return MathUtils3D.nearEqual(e[0],oe[0])&&MathUtils3D.nearEqual(e[1],oe[1])&&MathUtils3D.nearEqual(e[2],oe[2])&&MathUtils3D.nearEqual(e[3],oe[3])&&MathUtils3D.nearEqual(e[4],oe[4])&&MathUtils3D.nearEqual(e[5],oe[5])&&MathUtils3D.nearEqual(e[6],oe[6])&&MathUtils3D.nearEqual(e[7],oe[7])&&MathUtils3D.nearEqual(e[8],oe[8])&&MathUtils3D.nearEqual(e[9],oe[9])&&MathUtils3D.nearEqual(e[10],oe[10])&&MathUtils3D.nearEqual(e[11],oe[11])&&MathUtils3D.nearEqual(e[12],oe[12])&&MathUtils3D.nearEqual(e[13],oe[13])&&MathUtils3D.nearEqual(e[14],oe[14])&&MathUtils3D.nearEqual(e[15],oe[15])},__proto.decomposeTransRotScale=function(translation,rotation,scale){var rotationMatrix=Matrix4x4._tempMatrix4x4;return this.decomposeTransRotMatScale(translation,rotationMatrix,scale)?(Quaternion.createFromMatrix4x4(rotationMatrix,rotation),!0):(rotation.identity(),!1)},__proto.decomposeTransRotMatScale=function(translation,rotationMatrix,scale){var e=this.elements,te=translation.elements,re=rotationMatrix.elements,se=scale.elements;te[0]=e[12],te[1]=e[13],te[2]=e[14];var m11=e[0],m12=e[1],m13=e[2],m21=e[4],m22=e[5],m23=e[6],m31=e[8],m32=e[9],m33=e[10],sX=se[0]=Math.sqrt(m11*m11+m12*m12+m13*m13),sY=se[1]=Math.sqrt(m21*m21+m22*m22+m23*m23),sZ=se[2]=Math.sqrt(m31*m31+m32*m32+m33*m33);if(MathUtils3D.isZero(sX)||MathUtils3D.isZero(sY)||MathUtils3D.isZero(sZ))return re[1]=re[2]=re[3]=re[4]=re[6]=re[7]=re[8]=re[9]=re[11]=re[12]=re[13]=re[14]=0,re[0]=re[5]=re[10]=re[15]=1,!1;var at=Matrix4x4._tempVector0,atE=at.elements;atE[0]=m31/sZ,atE[1]=m32/sZ,atE[2]=m33/sZ;var tempRight=Matrix4x4._tempVector1,tempRightE=tempRight.elements;tempRightE[0]=m11/sX,tempRightE[1]=m12/sX,tempRightE[2]=m13/sX;var up=Matrix4x4._tempVector2;Vector3.cross(at,tempRight,up);var right=Matrix4x4._tempVector1;return Vector3.cross(up,at,right),re[3]=re[7]=re[11]=re[12]=re[13]=re[14]=0,re[15]=1,re[0]=right.x,re[1]=right.y,re[2]=right.z,re[4]=up.x,re[5]=up.y,re[6]=up.z,re[8]=at.x,re[9]=at.y,re[10]=at.z,re[0]*m11+re[1]*m12+re[2]*m13<0&&(se[0]=-sX),re[4]*m21+re[5]*m22+re[6]*m23<0&&(se[1]=-sY),re[8]*m31+re[9]*m32+re[10]*m33<0&&(se[2]=-sZ),!0},__proto.decomposeYawPitchRoll=function(yawPitchRoll){var yawPitchRollE=yawPitchRoll.elements,pitch=Math.asin(-this.elements[9]);yawPitchRollE[1]=pitch,Math.cos(pitch)>MathUtils3D.zeroTolerance?(yawPitchRollE[2]=Math.atan2(this.elements[1],this.elements[5]),yawPitchRollE[0]=Math.atan2(this.elements[8],this.elements[10])):(yawPitchRollE[2]=Math.atan2(-this.elements[4],this.elements[0]),yawPitchRollE[0]=0)},__proto.normalize=function(){var v=this.elements,c=v[0],d=v[1],e=v[2],g=Math.sqrt(c*c+d*d+e*e);if(!g)return v[0]=0,v[1]=0,void(v[2]=0);1!=g&&(g=1/g,v[0]=c*g,v[1]=d*g,v[2]=e*g)},__proto.transpose=function(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},__proto.invert=function(out){var ae=this.elements,oe=out.elements,a00=ae[0],a01=ae[1],a02=ae[2],a03=ae[3],a10=ae[4],a11=ae[5],a12=ae[6],a13=ae[7],a20=ae[8],a21=ae[9],a22=ae[10],a23=ae[11],a30=ae[12],a31=ae[13],a32=ae[14],a33=ae[15],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;0!==Math.abs(det)&&(det=1/det,oe[0]=(a11*b11-a12*b10+a13*b09)*det,oe[1]=(a02*b10-a01*b11-a03*b09)*det,oe[2]=(a31*b05-a32*b04+a33*b03)*det,oe[3]=(a22*b04-a21*b05-a23*b03)*det,oe[4]=(a12*b08-a10*b11-a13*b07)*det,oe[5]=(a00*b11-a02*b08+a03*b07)*det,oe[6]=(a32*b02-a30*b05-a33*b01)*det,oe[7]=(a20*b05-a22*b02+a23*b01)*det,oe[8]=(a10*b10-a11*b08+a13*b06)*det,oe[9]=(a01*b08-a00*b10-a03*b06)*det,oe[10]=(a30*b04-a31*b02+a33*b00)*det,oe[11]=(a21*b02-a20*b04-a23*b00)*det,oe[12]=(a11*b07-a10*b09-a12*b06)*det,oe[13]=(a00*b09-a01*b07+a02*b06)*det,oe[14]=(a31*b01-a30*b03-a32*b00)*det,oe[15]=(a20*b03-a21*b01+a22*b00)*det)},__proto.identity=function(){var e=this.elements;e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1},__proto.cloneTo=function(destObject){var i,s,d;if((s=this.elements)!==(d=destObject.elements))for(i=0;i<16;++i)d[i]=s[i]},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__proto.getTranslationVector=function(out){var me=this.elements,te=out.elements;te[0]=me[12],te[1]=me[13],te[2]=me[14]},__proto.setTranslationVector=function(translate){var me=this.elements,ve=translate.elements;me[12]=ve[0],me[13]=ve[1],me[14]=ve[2]},__proto.getForward=function(out){var me=this.elements,te=out.elements;te[0]=-me[8],te[1]=-me[9],te[2]=-me[10]},__proto.setForward=function(forward){var me=this.elements,ve=forward.elements;me[8]=-ve[0],me[9]=-ve[1],me[10]=-ve[2]},Matrix4x4.createRotationX=function(rad,out){var oe=out.elements,s=Math.sin(rad),c=Math.cos(rad);oe[1]=oe[2]=oe[3]=oe[4]=oe[7]=oe[8]=oe[11]=oe[12]=oe[13]=oe[14]=0,oe[0]=oe[15]=1,oe[5]=oe[10]=c,oe[6]=s,oe[9]=-s},Matrix4x4.createRotationY=function(rad,out){var oe=out.elements,s=Math.sin(rad),c=Math.cos(rad);oe[1]=oe[3]=oe[4]=oe[6]=oe[7]=oe[9]=oe[11]=oe[12]=oe[13]=oe[14]=0,oe[5]=oe[15]=1,oe[0]=oe[10]=c,oe[2]=-s,oe[8]=s},Matrix4x4.createRotationZ=function(rad,out){var oe=out.elements,s=Math.sin(rad),c=Math.cos(rad);oe[2]=oe[3]=oe[6]=oe[7]=oe[8]=oe[9]=oe[11]=oe[12]=oe[13]=oe[14]=0,oe[10]=oe[15]=1,oe[0]=oe[5]=c,oe[1]=s,oe[4]=-s},Matrix4x4.createRotationYawPitchRoll=function(yaw,pitch,roll,result){Quaternion.createFromYawPitchRoll(yaw,pitch,roll,Matrix4x4._tempQuaternion),Matrix4x4.createRotationQuaternion(Matrix4x4._tempQuaternion,result)},Matrix4x4.createRotationAxis=function(axis,angle,result){var axisE=axis.elements,x=axisE[0],y=axisE[1],z=axisE[2],cos=Math.cos(angle),sin=Math.sin(angle),xx=x*x,yy=y*y,zz=z*z,xy=x*y,xz=x*z,yz=y*z,resultE=result.elements;resultE[3]=resultE[7]=resultE[11]=resultE[12]=resultE[13]=resultE[14]=0,resultE[15]=1,resultE[0]=xx+cos*(1-xx),resultE[1]=xy-cos*xy+sin*z,resultE[2]=xz-cos*xz-sin*y,resultE[4]=xy-cos*xy-sin*z,resultE[5]=yy+cos*(1-yy),resultE[6]=yz-cos*yz+sin*x,resultE[8]=xz-cos*xz+sin*y,resultE[9]=yz-cos*yz-sin*x,resultE[10]=zz+cos*(1-zz)},Matrix4x4.createRotationQuaternion=function(rotation,result){var rotationE=rotation.elements,resultE=result.elements,rotationX=rotationE[0],rotationY=rotationE[1],rotationZ=rotationE[2],rotationW=rotationE[3],xx=rotationX*rotationX,yy=rotationY*rotationY,zz=rotationZ*rotationZ,xy=rotationX*rotationY,zw=rotationZ*rotationW,zx=rotationZ*rotationX,yw=rotationY*rotationW,yz=rotationY*rotationZ,xw=rotationX*rotationW;resultE[3]=resultE[7]=resultE[11]=resultE[12]=resultE[13]=resultE[14]=0,resultE[15]=1,resultE[0]=1-2*(yy+zz),resultE[1]=2*(xy+zw),resultE[2]=2*(zx-yw),resultE[4]=2*(xy-zw),resultE[5]=1-2*(zz+xx),resultE[6]=2*(yz+xw),resultE[8]=2*(zx+yw),resultE[9]=2*(yz-xw),resultE[10]=1-2*(yy+xx)},Matrix4x4.createTranslate=function(trans,out){var te=trans.elements,oe=out.elements;oe[4]=oe[8]=oe[1]=oe[9]=oe[2]=oe[6]=oe[3]=oe[7]=oe[11]=0,oe[0]=oe[5]=oe[10]=oe[15]=1,oe[12]=te[0],oe[13]=te[1],oe[14]=te[2]},Matrix4x4.createScaling=function(scale,out){var se=scale.elements,oe=out.elements;oe[0]=se[0],oe[5]=se[1],oe[10]=se[2],oe[1]=oe[4]=oe[8]=oe[12]=oe[9]=oe[13]=oe[2]=oe[6]=oe[14]=oe[3]=oe[7]=oe[11]=0,oe[15]=1},Matrix4x4.multiply=function(left,right,out){var i,e,a,b,ai0,ai1,ai2,ai3;if(e=out.elements,a=left.elements,e===(b=right.elements))for(b=new Float32Array(16),i=0;i<16;++i)b[i]=e[i];var b0=b[0],b1=b[1],b2=b[2],b3=b[3],b4=b[4],b5=b[5],b6=b[6],b7=b[7],b8=b[8],b9=b[9],b10=b[10],b11=b[11],b12=b[12],b13=b[13],b14=b[14],b15=b[15];for(i=0;i<4;i++)ai0=a[i],ai1=a[i+4],ai2=a[i+8],ai3=a[i+12],e[i]=ai0*b0+ai1*b1+ai2*b2+ai3*b3,e[i+4]=ai0*b4+ai1*b5+ai2*b6+ai3*b7,e[i+8]=ai0*b8+ai1*b9+ai2*b10+ai3*b11,e[i+12]=ai0*b12+ai1*b13+ai2*b14+ai3*b15},Matrix4x4.multiplyForNative=function(left,right,out){LayaGL.instance.matrix4x4Multiply(left.elements,right.elements,out.elements)},Matrix4x4.createFromQuaternion=function(rotation,out){var e=out.elements,q=rotation.elements,x=q[0],y=q[1],z=q[2],w=q[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,yx=y*x2,yy=y*y2,zx=z*x2,zy=z*y2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;e[0]=1-yy-zz,e[1]=yx+wz,e[2]=zx-wy,e[3]=0,e[4]=yx-wz,e[5]=1-xx-zz,e[6]=zy+wx,e[7]=0,e[8]=zx+wy,e[9]=zy-wx,e[10]=1-xx-yy,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1},Matrix4x4.createAffineTransformation=function(trans,rot,scale,out){var te=trans.elements,re=rot.elements,se=scale.elements,oe=out.elements,x=re[0],y=re[1],z=re[2],w=re[3],x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2,sx=se[0],sy=se[1],sz=se[2];oe[0]=(1-(yy+zz))*sx,oe[1]=(xy+wz)*sx,oe[2]=(xz-wy)*sx,oe[3]=0,oe[4]=(xy-wz)*sy,oe[5]=(1-(xx+zz))*sy,oe[6]=(yz+wx)*sy,oe[7]=0,oe[8]=(xz+wy)*sz,oe[9]=(yz-wx)*sz,oe[10]=(1-(xx+yy))*sz,oe[11]=0,oe[12]=te[0],oe[13]=te[1],oe[14]=te[2],oe[15]=1},Matrix4x4.createLookAt=function(eye,target,up,out){var oE=out.elements,xaxis=Matrix4x4._tempVector0,yaxis=Matrix4x4._tempVector1,zaxis=Matrix4x4._tempVector2;Vector3.subtract(eye,target,zaxis),Vector3.normalize(zaxis,zaxis),Vector3.cross(up,zaxis,xaxis),Vector3.normalize(xaxis,xaxis),Vector3.cross(zaxis,xaxis,yaxis),out.identity(),oE[0]=xaxis.x,oE[4]=xaxis.y,oE[8]=xaxis.z,oE[1]=yaxis.x,oE[5]=yaxis.y,oE[9]=yaxis.z,oE[2]=zaxis.x,oE[6]=zaxis.y,oE[10]=zaxis.z,oE[12]=-Vector3.dot(xaxis,eye),oE[13]=-Vector3.dot(yaxis,eye),oE[14]=-Vector3.dot(zaxis,eye)},Matrix4x4.createPerspective=function(fov,aspect,near,far,out){var oe=out.elements,f=1/Math.tan(fov/2),nf=1/(near-far);oe[0]=f/aspect,oe[5]=f,oe[10]=(far+near)*nf,oe[11]=-1,oe[14]=2*far*near*nf,oe[1]=oe[2]=oe[3]=oe[4]=oe[6]=oe[7]=oe[8]=oe[9]=oe[12]=oe[13]=oe[15]=0},Matrix4x4.createOrthoOffCenterRH=function(left,right,bottom,top,near,far,out){var oe=out.elements,lr=1/(left-right),bt=1/(bottom-top),nf=1/(near-far);oe[1]=oe[2]=oe[3]=oe[4]=oe[6]=oe[7]=oe[8]=oe[9]=oe[11]=0,oe[15]=1,oe[0]=-2*lr,oe[5]=-2*bt,oe[10]=2*nf,oe[12]=(left+right)*lr,oe[13]=(top+bottom)*bt,oe[14]=(far+near)*nf},Matrix4x4.billboard=function(objectPosition,cameraPosition,cameraRight,cameraUp,cameraForward,mat){Vector3.subtract(objectPosition,cameraPosition,Matrix4x4._tempVector0);var lengthSq=Vector3.scalarLengthSquared(Matrix4x4._tempVector0);MathUtils3D.isZero(lengthSq)?(Vector3.scale(cameraForward,-1,Matrix4x4._tempVector1),Matrix4x4._tempVector1.cloneTo(Matrix4x4._tempVector0)):Vector3.scale(Matrix4x4._tempVector0,1/Math.sqrt(lengthSq),Matrix4x4._tempVector0),Vector3.cross(cameraUp,Matrix4x4._tempVector0,Matrix4x4._tempVector2),Vector3.normalize(Matrix4x4._tempVector2,Matrix4x4._tempVector2),Vector3.cross(Matrix4x4._tempVector0,Matrix4x4._tempVector2,Matrix4x4._tempVector3);var crosse=Matrix4x4._tempVector2.elements,finale=Matrix4x4._tempVector3.elements,diffee=Matrix4x4._tempVector0.elements,obpose=objectPosition.elements,mate=mat.elements;mate[0]=crosse[0],mate[1]=crosse[1],mate[2]=crosse[2],mate[3]=0,mate[4]=finale[0],mate[5]=finale[1],mate[6]=finale[2],mate[7]=0,mate[8]=diffee[0],mate[9]=diffee[1],mate[10]=diffee[2],mate[11]=0,mate[12]=obpose[0],mate[13]=obpose[1],mate[14]=obpose[2],mate[15]=1},Matrix4x4.translation=function(v3,out){var ve=v3.elements,oe=out.elements;oe[0]=oe[5]=oe[10]=oe[15]=1,oe[12]=ve[0],oe[13]=ve[1],oe[14]=ve[2]},__static(Matrix4x4,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4},"_tempVector0",function(){return this._tempVector0=new Vector3},"_tempVector1",function(){return this._tempVector1=new Vector3},"_tempVector2",function(){return this._tempVector2=new Vector3},"_tempVector3",function(){return this._tempVector3=new Vector3},"_tempQuaternion",function(){return this._tempQuaternion=new Quaternion},"DEFAULT",function(){return this.DEFAULT=new Matrix4x4},"ZERO",function(){return this.ZERO=new Matrix4x4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]),Matrix4x4}()),TextureSheetAnimation=(function(){function GradientMode(){}__class(GradientMode,"laya.d3.core.GradientMode"),GradientMode.Blend=0,GradientMode.Fixed=1}(),function(){function TextureSheetAnimation(frame,startFrame){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Vector2(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=frame,this._startFrame=startFrame}__class(TextureSheetAnimation,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var __proto=TextureSheetAnimation.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destTextureSheetAnimation=destObject;this.tiles.cloneTo(destTextureSheetAnimation.tiles),destTextureSheetAnimation.type=this.type,destTextureSheetAnimation.randomRow=this.randomRow,this._frame.cloneTo(destTextureSheetAnimation._frame),this._startFrame.cloneTo(destTextureSheetAnimation._startFrame),destTextureSheetAnimation.cycles=this.cycles,destTextureSheetAnimation.enableUVChannels=this.enableUVChannels,destTextureSheetAnimation.enable=this.enable},__proto.clone=function(){var destFrame,destStartFrame;switch(this._frame.type){case 0:destFrame=FrameOverTime.createByConstant(this._frame.constant);break;case 1:destFrame=FrameOverTime.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:destFrame=FrameOverTime.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:destFrame=FrameOverTime.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}switch(this._startFrame.type){case 0:destStartFrame=StartFrame.createByConstant(this._startFrame.constant);break;case 1:destStartFrame=StartFrame.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var destTextureSheetAnimation=new this.constructor(destFrame,destStartFrame);return this.tiles.cloneTo(destTextureSheetAnimation.tiles),destTextureSheetAnimation.type=this.type,destTextureSheetAnimation.randomRow=this.randomRow,destTextureSheetAnimation.cycles=this.cycles,destTextureSheetAnimation.enableUVChannels=this.enableUVChannels,destTextureSheetAnimation.enable=this.enable,destTextureSheetAnimation},__getset(0,__proto,"frame",function(){return this._frame}),__getset(0,__proto,"startFrame",function(){return this._startFrame}),TextureSheetAnimation}()),Rand=function(){function Rand(seed){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=seed,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}__class(Rand,"laya.d3.math.Rand");var __proto=Rand.prototype;return __proto.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},__proto.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},__proto.getSignedFloat=function(){return 2*this.getFloat()-1},__getset(0,__proto,"seed",function(){return this.seeds[0]},function(seed){this.seeds[0]=seed,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),Rand.getFloatFromInt=function(v){return 1/8388607*(8388607&v)},Rand.getByteFromInt=function(v){return(8388607&v)>>>15},Rand}(),RenderState=function(){function RenderState(){this.cull=0,this.blend=0,this.srcBlend=0,this.dstBlend=0,this.srcBlendRGB=0,this.dstBlendRGB=0,this.srcBlendAlpha=0,this.dstBlendAlpha=0,this.blendConstColor=null,this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=0,this.depthWrite=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new Vector4(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=515,this.depthWrite=!0}__class(RenderState,"laya.d3.core.material.RenderState");var __proto=RenderState.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._setRenderStateBlendDepth=function(){var gl=LayaGL.instance;switch(WebGLContext.setDepthMask(gl,this.depthWrite),0===this.depthTest?WebGLContext.setDepthTest(gl,!1):(WebGLContext.setDepthTest(gl,!0),WebGLContext.setDepthFunc(gl,this.depthTest)),this.blend){case 0:WebGLContext.setBlend(gl,!1);break;case 1:WebGLContext.setBlend(gl,!0),WebGLContext.setBlendFunc(gl,this.srcBlend,this.dstBlend);break;case 2:WebGLContext.setBlend(gl,!0)}},__proto._setRenderStateFrontFace=function(isTarget,transform){var gl=LayaGL.instance,forntFace=0;switch(this.cull){case 0:WebGLContext.setCullFace(gl,!1);break;case 1:WebGLContext.setCullFace(gl,!0),forntFace=isTarget?transform&&transform._isFrontFaceInvert?2305:2304:transform&&transform._isFrontFaceInvert?2304:2305,WebGLContext.setFrontFace(gl,forntFace);break;case 2:WebGLContext.setCullFace(gl,!0),forntFace=isTarget?transform&&transform._isFrontFaceInvert?2304:2305:transform&&transform._isFrontFaceInvert?2305:2304,WebGLContext.setFrontFace(gl,forntFace)}},__proto.cloneTo=function(dest){var destState=dest;destState.cull=this.cull,destState.blend=this.blend,destState.srcBlend=this.srcBlend,destState.dstBlend=this.dstBlend,destState.srcBlendRGB=this.srcBlendRGB,destState.dstBlendRGB=this.dstBlendRGB,destState.srcBlendAlpha=this.srcBlendAlpha,destState.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(destState.blendConstColor),destState.blendEquation=this.blendEquation,destState.blendEquationRGB=this.blendEquationRGB,destState.blendEquationAlpha=this.blendEquationAlpha,destState.depthTest=this.depthTest,destState.depthWrite=this.depthWrite},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},RenderState.CULL_NONE=0,RenderState.CULL_FRONT=1,RenderState.CULL_BACK=2,RenderState.BLEND_DISABLE=0,RenderState.BLEND_ENABLE_ALL=1,RenderState.BLEND_ENABLE_SEPERATE=2,RenderState.BLENDPARAM_ZERO=0,RenderState.BLENDPARAM_ONE=1,RenderState.BLENDPARAM_SRC_COLOR=768,RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,RenderState.BLENDPARAM_DST_COLOR=774,RenderState.BLENDPARAM_ONE_MINUS_DST_COLOR=775,RenderState.BLENDPARAM_SRC_ALPHA=770,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,RenderState.BLENDPARAM_DST_ALPHA=772,RenderState.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,RenderState.BLENDPARAM_SRC_ALPHA_SATURATE=776,RenderState.BLENDEQUATION_ADD=0,RenderState.BLENDEQUATION_SUBTRACT=1,RenderState.BLENDEQUATION_REVERSE_SUBTRACT=2,RenderState.DEPTHTEST_OFF=0,RenderState.DEPTHTEST_NEVER=512,RenderState.DEPTHTEST_LESS=513,RenderState.DEPTHTEST_EQUAL=514,RenderState.DEPTHTEST_LEQUAL=515,RenderState.DEPTHTEST_GREATER=516,RenderState.DEPTHTEST_NOTEQUAL=517,RenderState.DEPTHTEST_GEQUAL=518,RenderState.DEPTHTEST_ALWAYS=519,RenderState}(),GradientVelocity=function(){function GradientVelocity(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}__class(GradientVelocity,"laya.d3.core.particleShuriKen.module.GradientVelocity");var __proto=GradientVelocity.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destGradientVelocity=destObject;destGradientVelocity._type=this._type,this._constant.cloneTo(destGradientVelocity._constant),this._gradientX.cloneTo(destGradientVelocity._gradientX),this._gradientY.cloneTo(destGradientVelocity._gradientY),this._gradientZ.cloneTo(destGradientVelocity._gradientZ),this._constantMin.cloneTo(destGradientVelocity._constantMin),this._constantMax.cloneTo(destGradientVelocity._constantMax),this._gradientXMin.cloneTo(destGradientVelocity._gradientXMin),this._gradientXMax.cloneTo(destGradientVelocity._gradientXMax),this._gradientYMin.cloneTo(destGradientVelocity._gradientYMin),this._gradientYMax.cloneTo(destGradientVelocity._gradientYMax),this._gradientZMin.cloneTo(destGradientVelocity._gradientZMin),this._gradientZMax.cloneTo(destGradientVelocity._gradientZMax)},__proto.clone=function(){var destGradientVelocity=new this.constructor;return this.cloneTo(destGradientVelocity),destGradientVelocity},__getset(0,__proto,"gradientZ",function(){return this._gradientZ}),__getset(0,__proto,"constant",function(){return this._constant}),__getset(0,__proto,"type",function(){return this._type}),__getset(0,__proto,"gradientXMax",function(){return this._gradientXMax}),__getset(0,__proto,"constantMin",function(){return this._constantMin}),__getset(0,__proto,"gradientX",function(){return this._gradientX}),__getset(0,__proto,"gradientY",function(){return this._gradientY}),__getset(0,__proto,"gradientXMin",function(){return this._gradientXMin}),__getset(0,__proto,"constantMax",function(){return this._constantMax}),__getset(0,__proto,"gradientYMin",function(){return this._gradientYMin}),__getset(0,__proto,"gradientYMax",function(){return this._gradientYMax}),__getset(0,__proto,"gradientZMin",function(){return this._gradientZMin}),__getset(0,__proto,"gradientZMax",function(){return this._gradientZMax}),GradientVelocity.createByConstant=function(constant){var gradientVelocity=new GradientVelocity;return gradientVelocity._type=0,gradientVelocity._constant=constant,gradientVelocity},GradientVelocity.createByGradient=function(gradientX,gradientY,gradientZ){var gradientVelocity=new GradientVelocity;return gradientVelocity._type=1,gradientVelocity._gradientX=gradientX,gradientVelocity._gradientY=gradientY,gradientVelocity._gradientZ=gradientZ,gradientVelocity},GradientVelocity.createByRandomTwoConstant=function(constantMin,constantMax){var gradientVelocity=new GradientVelocity;return gradientVelocity._type=2,gradientVelocity._constantMin=constantMin,gradientVelocity._constantMax=constantMax,gradientVelocity},GradientVelocity.createByRandomTwoGradient=function(gradientXMin,gradientXMax,gradientYMin,gradientYMax,gradientZMin,gradientZMax){var gradientVelocity=new GradientVelocity;return gradientVelocity._type=3,gradientVelocity._gradientXMin=gradientXMin,gradientVelocity._gradientXMax=gradientXMax,gradientVelocity._gradientYMin=gradientYMin,gradientVelocity._gradientYMax=gradientYMax,gradientVelocity._gradientZMin=gradientZMin,gradientVelocity._gradientZMax=gradientZMax,gradientVelocity},GradientVelocity}(),MeshFilter=function(){function MeshFilter(owner){this._owner=null,this._sharedMesh=null,this._owner=owner}__class(MeshFilter,"laya.d3.core.MeshFilter");var __proto=MeshFilter.prototype;return __proto._getMeshDefine=function(mesh){for(var define=0,i=0,n=mesh._subMeshCount;i<n;i++)for(var vertexElements=mesh._getSubMesh(i)._vertexBuffer._vertexDeclaration.vertexElements,j=0,m=vertexElements.length;j<m;j++){switch(vertexElements[j].elementUsage){case 1:define|=MeshSprite3D.SHADERDEFINE_COLOR;break;case 2:define|=MeshSprite3D.SHADERDEFINE_UV0;break;case 8:define|=MeshSprite3D.SHADERDEFINE_UV1}}return define},__proto._changeRenderObjectsByMesh=function(){var renderElementsCount=this._sharedMesh.subMeshCount;this._owner._render._renderElements.length=renderElementsCount;for(var i=0;i<renderElementsCount;i++){var render=this._owner._render,elements=render._renderElements,renderElement=elements[i];if(renderElement)renderElement.setGeometry(this._sharedMesh._getSubMesh(i));else{var material=render.sharedMaterials[i];material||(material=BlinnPhongMaterial.defaultMaterial),(renderElement=elements[i]=new SubMeshRenderElement).setTransform(this._owner._transform),renderElement.render=render,renderElement.material=material,renderElement.setGeometry(this._sharedMesh._getSubMesh(i))}}},__proto.destroy=function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)},__getset(0,__proto,"sharedMesh",function(){return this._sharedMesh},function(value){if(this._sharedMesh!==value){var defineDatas=this._owner._render._defineDatas,lastValue=this._sharedMesh;lastValue&&(lastValue._removeReference(),defineDatas.remove(this._getMeshDefine(lastValue))),value._addReference(),this._sharedMesh=value,defineDatas.add(this._getMeshDefine(value)),this._changeRenderObjectsByMesh()}this._owner._render._onMeshChange(value)}),MeshFilter}(),MathUtils3D=function(){function MathUtils3D(){}return __class(MathUtils3D,"laya.d3.math.MathUtils3D"),MathUtils3D.isZero=function(v){return Math.abs(v)<MathUtils3D.zeroTolerance},MathUtils3D.nearEqual=function(n1,n2){return!!MathUtils3D.isZero(n1-n2)},MathUtils3D.fastInvSqrt=function(value){return MathUtils3D.isZero(value)?value:1/Math.sqrt(value)},__static(MathUtils3D,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),MathUtils3D}(),MaterialInfo=function(){function MaterialInfo(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return __class(MaterialInfo,"laya.d3.terrain.unit.MaterialInfo"),MaterialInfo}(),ShaderData=function(){function ShaderData(ownerResource){this._runtimeCopyValues=[],this._ownerResource=ownerResource,this._initData()}__class(ShaderData,"laya.d3.shader.ShaderData");var __proto=ShaderData.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._initData=function(){this._data=new Object},__proto.getBool=function(index){return this._data[index]},__proto.setBool=function(index,value){this._data[index]=value},__proto.getInt=function(index){return this._data[index]},__proto.setInt=function(index,value){this._data[index]=value},__proto.getNumber=function(index){return this._data[index]},__proto.setNumber=function(index,value){this._data[index]=value},__proto.getVector=function(index){return this._data[index]},__proto.setVector=function(index,value){this._data[index]=value},__proto.getQuaternion=function(index){return this._data[index]},__proto.setQuaternion=function(index,value){this._data[index]=value},__proto.getMatrix4x4=function(index){return this._data[index]},__proto.setMatrix4x4=function(index,value){this._data[index]=value},__proto.getBuffer=function(shaderIndex){return this._data[shaderIndex]},__proto.setBuffer=function(index,value){this._data[index]=value},__proto.setTexture=function(index,value){var lastValue=this._data[index];this._data[index]=value,this._ownerResource&&this._ownerResource.referenceCount>0&&(lastValue&&lastValue._removeReference(),value&&value._addReference())},__proto.getTexture=function(index){return this._data[index]},__proto.setAttribute=function(index,value){this._data[index]=value},__proto.getAttribute=function(index){return this._data[index]},__proto.getLength=function(){return this._data.length},__proto.setLength=function(value){this._data.length=value},__proto.cloneTo=function(destObject){var destData=destObject._data;for(var k in this._data){var value=this._data[k];if(value)if("number"==typeof value)destData[k]=value;else if("number"==typeof value&&Math.floor(value)==value)destData[k]=value;else if("boolean"==typeof value)destData[k]=value;else if(value instanceof laya.d3.math.Vector2){var v2=destData[k]||(destData[k]=new Vector2);value.cloneTo(v2),destData[k]=v2}else if(value instanceof laya.d3.math.Vector3){var v3=destData[k]||(destData[k]=new Vector3);value.cloneTo(v3),destData[k]=v3}else if(value instanceof laya.d3.math.Vector4){var v4=destData[k]||(destData[k]=new Vector4);value.cloneTo(v4),destData[k]=v4}else if(value instanceof laya.d3.math.Matrix4x4){var mat=destData[k]||(destData[k]=new Matrix4x4);value.cloneTo(mat),destData[k]=mat}else value instanceof laya.webgl.resource.BaseTexture&&(destData[k]=value)}},__proto.cloneToForNative=function(destObject){var dest=destObject;this._int32Data.length-dest._int32Data.length>0&&dest.needRenewArrayBufferForNative(this._int32Data.length),dest._int32Data.set(this._int32Data,0);var destData=dest._nativeArray,dataCount=this._nativeArray.length;destData.length=dataCount;for(var i=0;i<dataCount;i++){var value=this._nativeArray[i];if(value)if("number"==typeof value)destData[i]=value,dest.setNumber(i,value);else if("number"==typeof value&&Math.floor(value)==value)destData[i]=value,dest.setInt(i,value);else if("boolean"==typeof value)destData[i]=value,dest.setBool(i,value);else if(value instanceof laya.d3.math.Vector2){var v2=destData[i]||(destData[i]=new Vector2);value.cloneTo(v2),destData[i]=v2,dest.setVector(i,v2)}else if(value instanceof laya.d3.math.Vector3){var v3=destData[i]||(destData[i]=new Vector3);value.cloneTo(v3),destData[i]=v3,dest.setVector(i,v3)}else if(value instanceof laya.d3.math.Vector4){var v4=destData[i]||(destData[i]=new Vector4);value.cloneTo(v4),destData[i]=v4,dest.setVector(i,v4)}else if(value instanceof laya.d3.math.Matrix4x4){var mat=destData[i]||(destData[i]=new Matrix4x4);value.cloneTo(mat),destData[i]=mat,dest.setMatrix4x4(i,mat)}else value instanceof laya.webgl.resource.BaseTexture&&(destData[i]=value,dest.setTexture(i,value))}},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__proto._initDataForNative=function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),LayaGL.createArrayBufferRef(this._data,0,!0)},__proto.needRenewArrayBufferForNative=function(index){if(index>=this._int32Data.length){var nByteLen=4*(index+1),pre=this._int32Data,preConchRef=this._data.conchRef,prePtrID=this._data._ptrID;this._data=new ArrayBuffer(nByteLen),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=preConchRef,this._data._ptrID=prePtrID,pre&&this._int32Data.set(pre,0),conch.updateArrayBufferRef(this._data._ptrID,preConchRef.isSyncToRender(),this._data)}},__proto.getIntForNative=function(index){return this._int32Data[index]},__proto.setIntForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._int32Data[index]=value},__proto.getBoolForNative=function(index){return 1==this._int32Data[index]},__proto.setBoolForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._int32Data[index]=value},__proto.getNumberForNative=function(index){return this._float32Data[index]},__proto.setNumberForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._float32Data[index]=value},__proto.getMatrix4x4ForNative=function(index){return alert("ShaderData getMatrix4x4 can't support"),null},__proto.setMatrix4x4ForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._nativeArray[index]=value;var nPtrID=this.setReferenceForNative(value.elements);this._int32Data[index]=nPtrID},__proto.getVectorForNative=function(index){return this._nativeArray[index]},__proto.setVectorForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._nativeArray[index]=value;var nPtrID=this.setReferenceForNative(value.elements);this._int32Data[index]=nPtrID},__proto.getQuaternionForNative=function(index){return alert("ShaderData getQuaternion can't support"),null},__proto.setQuaternionForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._nativeArray[index]=value;var nPtrID=this.setReferenceForNative(value.elements);this._int32Data[index]=nPtrID},__proto.getBufferForNative=function(shaderIndex){return alert("ShaderData getBuffer can't support"),null},__proto.setBufferForNative=function(index,value){this.needRenewArrayBufferForNative(index),this._nativeArray[index]=value;var nPtrID=this.setReferenceForNative(value);this._int32Data[index]=nPtrID},__proto.getAttributeForNative=function(index){return alert("ShaderData  getAttribute can't support"),null},__proto.setAttributeForNative=function(index,value){this._nativeArray[index]=value,value._ptrID||LayaGL.createArrayBufferRef(value,0,!0),LayaGL.syncBufferToRenderThread(value),this._int32Data[index]=value._ptrID},__proto.getTextureForNative=function(index){return alert("ShaderData getTexture can't support"),null},__proto.setTextureForNative=function(index,value){if(value){this.needRenewArrayBufferForNative(index),this._nativeArray[index]=value;var lastValue=this._nativeArray[index];this._int32Data[index]=value._getSource().id,this._ownerResource&&this._ownerResource.referenceCount>0&&(lastValue&&lastValue._removeReference(),value&&value._addReference())}},__proto.setReferenceForNative=function(value){this.clearRuntimeCopyArray();var nRefID=0,nPtrID=0;return ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_?(LayaGL.createArrayBufferRefs(value,0,!0,0),nRefID=0,nPtrID=value.getPtrID(nRefID)):(LayaGL.createArrayBufferRefs(value,0,!0,1),nRefID=value.getRefNum()-1,nPtrID=value.getPtrID(nRefID),this._runtimeCopyValues.push({obj:value,refID:nRefID,ptrID:nPtrID})),LayaGL.syncBufferToRenderThread(value,nRefID),nPtrID},__proto.clearRuntimeCopyArray=function(){var currentFrame=LayaGL.getFrameCount();if(this._frameCount!=currentFrame){this._frameCount=currentFrame;for(var i=0,n=this._runtimeCopyValues.length;i<n;i++){this._runtimeCopyValues[i].obj.clearRefNum()}this._runtimeCopyValues.length=0}},ShaderData.setRuntimeValueMode=function(bReference){ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_=bReference},ShaderData._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0,ShaderData}(),KeyframeNodeList=function(){function KeyframeNodeList(){this._nodes=[]}__class(KeyframeNodeList,"laya.d3.animation.KeyframeNodeList");var __proto=KeyframeNodeList.prototype;return __proto.getNodeByIndex=function(index){return this._nodes[index]},__proto.setNodeByIndex=function(index,node){this._nodes[index]=node},__getset(0,__proto,"count",function(){return this._nodes.length},function(value){this._nodes.length=value}),KeyframeNodeList}(),HalfFloatUtils=function(){function HalfFloatUtils(){}return __class(HalfFloatUtils,"laya.d3.math.HalfFloatUtils"),HalfFloatUtils.__init__=function(){for(var i=0;i<256;++i){var e=i-127;e<-27?(HalfFloatUtils._baseTable[0|i]=0,HalfFloatUtils._baseTable[256|i]=32768,HalfFloatUtils._shiftTable[0|i]=24,HalfFloatUtils._shiftTable[256|i]=24):e<-14?(HalfFloatUtils._baseTable[0|i]=1024>>-e-14,HalfFloatUtils._baseTable[256|i]=1024>>-e-14|32768,HalfFloatUtils._shiftTable[0|i]=-e-1,HalfFloatUtils._shiftTable[256|i]=-e-1):e<=15?(HalfFloatUtils._baseTable[0|i]=e+15<<10,HalfFloatUtils._baseTable[256|i]=e+15<<10|32768,HalfFloatUtils._shiftTable[0|i]=13,HalfFloatUtils._shiftTable[256|i]=13):e<128?(HalfFloatUtils._baseTable[0|i]=31744,HalfFloatUtils._baseTable[256|i]=64512,HalfFloatUtils._shiftTable[0|i]=24,HalfFloatUtils._shiftTable[256|i]=24):(HalfFloatUtils._baseTable[0|i]=31744,HalfFloatUtils._baseTable[256|i]=64512,HalfFloatUtils._shiftTable[0|i]=13,HalfFloatUtils._shiftTable[256|i]=13)}for(HalfFloatUtils._mantissaTable[0]=0,i=1;i<1024;++i){var m=i<<13;for(e=0;0==(8388608&m);)e-=8388608,m<<=1;m&=-8388609,e+=947912704,HalfFloatUtils._mantissaTable[i]=m|e}for(i=1024;i<2048;++i)HalfFloatUtils._mantissaTable[i]=939524096+(i-1024<<13);for(HalfFloatUtils._exponentTable[0]=0,i=1;i<31;++i)HalfFloatUtils._exponentTable[i]=i<<23;for(HalfFloatUtils._exponentTable[31]=1199570944,HalfFloatUtils._exponentTable[32]=2147483648,i=33;i<63;++i)HalfFloatUtils._exponentTable[i]=2147483648+(i-32<<23);for(HalfFloatUtils._exponentTable[63]=3347054592,HalfFloatUtils._offsetTable[0]=0,i=1;i<64;++i)HalfFloatUtils._offsetTable[i]=32===i?0:1024},HalfFloatUtils.roundToFloat16Bits=function(num){HalfFloatUtils._floatView[0]=num;var f=HalfFloatUtils._uint32View[0],e=f>>23&511;return HalfFloatUtils._baseTable[e]+((8388607&f)>>HalfFloatUtils._shiftTable[e])},HalfFloatUtils.convertToNumber=function(float16bits){var m=float16bits>>10;return HalfFloatUtils._uint32View[0]=HalfFloatUtils._mantissaTable[HalfFloatUtils._offsetTable[m]+(1023&float16bits)]+HalfFloatUtils._exponentTable[m],HalfFloatUtils._floatView[0]},__static(HalfFloatUtils,["_buffer",function(){return this._buffer=new ArrayBuffer(4)},"_floatView",function(){return this._floatView=new Float32Array(HalfFloatUtils._buffer)},"_uint32View",function(){return this._uint32View=new Uint32Array(HalfFloatUtils._buffer)},"_baseTable",function(){return this._baseTable=new Uint32Array(512)},"_shiftTable",function(){return this._shiftTable=new Uint32Array(512)},"_mantissaTable",function(){return this._mantissaTable=new Uint32Array(2048)},"_exponentTable",function(){return this._exponentTable=new Uint32Array(64)},"_offsetTable",function(){return this._offsetTable=new Uint32Array(64)}]),HalfFloatUtils}(),MouseTouch=(function(){function Constraint3D(){this._nativeConstraint=null,this._simulation=null,this.rigidbodyA=null,this.rigidbodyB=null}__class(Constraint3D,"laya.d3.physics.Constraint3D")}(),function(){function MouseTouch(){this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0}return __class(MouseTouch,"laya.d3.MouseTouch"),MouseTouch}()),CollisionTool=function(){function CollisionTool(){this._hitResultsPoolIndex=0,this._contactPonintsPoolIndex=0,this._collisions={},this._hitResultsPool=[],this._contactPointsPool=[],this._collisionsPool=[]}__class(CollisionTool,"laya.d3.physics.CollisionTool");var __proto=CollisionTool.prototype;return __proto.getHitResult=function(){var hitResult=this._hitResultsPool[this._hitResultsPoolIndex++];return hitResult||(hitResult=new HitResult,this._hitResultsPool.push(hitResult)),hitResult},__proto.recoverAllHitResultsPool=function(){this._hitResultsPoolIndex=0},__proto.getContactPoints=function(){var contactPoint=this._contactPointsPool[this._contactPonintsPoolIndex++];return contactPoint||(contactPoint=new ContactPoint,this._contactPointsPool.push(contactPoint)),contactPoint},__proto.recoverAllContactPointsPool=function(){this._contactPonintsPoolIndex=0},__proto.getCollision=function(physicComponentA,physicComponentB){var collision,idA=physicComponentA.id,idB=physicComponentB.id,subCollisionFirst=this._collisions[idA];return subCollisionFirst&&(collision=subCollisionFirst[idB]),collision||(subCollisionFirst||(subCollisionFirst={},this._collisions[idA]=subCollisionFirst),(collision=0===this._collisionsPool.length?new Collision:this._collisionsPool.pop())._colliderA=physicComponentA,collision._colliderB=physicComponentB,subCollisionFirst[idB]=collision),collision},__proto.recoverCollision=function(collision){var idA=collision._colliderA.id,idB=collision._colliderB.id;this._collisions[idA][idB]=null,this._collisionsPool.push(collision)},__proto.garbageCollection=function(){for(var subCollisionsKey in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var subCollisions=this._collisionsPool[subCollisionsKey],wholeDelete=!0;for(var collisionKey in subCollisions)subCollisions[collisionKey]?wholeDelete=!1:delete subCollisions[collisionKey];wholeDelete&&delete this._collisionsPool[subCollisionsKey]}},CollisionTool}(),AnimationNode=function(){function AnimationNode(localPosition,localRotation,localScale,worldMatrix){this._children=[],this.transform=new AnimationTransform3D(this,localPosition,localRotation,localScale,worldMatrix)}__class(AnimationNode,"laya.d3.animation.AnimationNode");var __proto=AnimationNode.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.addChild=function(child){child._parent=this,child.transform.setParent(this.transform),this._children.push(child)},__proto.removeChild=function(child){var index=this._children.indexOf(child);-1!==index&&this._children.splice(index,1)},__proto.getChildByName=function(name){for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i];if(child.name===name)return child}return null},__proto.getChildByIndex=function(index){return this._children[index]},__proto.getChildCount=function(){return this._children.length},__proto.cloneTo=function(destObject){var destNode=destObject;destNode.name=this.name;for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i],destChild=child.clone();destNode.addChild(destChild);var transform=child.transform,destTransform=destChild.transform,destLocalPosition=destTransform.localPosition,destLocalRotation=destTransform.localRotation,destLocalScale=destTransform.localScale;transform.localPosition.cloneTo(destLocalPosition),transform.localRotation.cloneTo(destLocalRotation),transform.localScale.cloneTo(destLocalScale),destTransform.localPosition=destLocalPosition,destTransform.localRotation=destLocalRotation,destTransform.localScale=destLocalScale}},__proto.clone=function(){var dest=new AnimationNode;return this.cloneTo(dest),dest},__proto._cloneNative=function(localPositions,localRotations,localScales,animationNodeWorldMatrixs,animationNodeParentIndices,parentIndex,avatar){var curID=avatar._nativeCurCloneCount;animationNodeParentIndices[curID]=parentIndex;var dest=new AnimationNode(new Float32Array(localPositions.buffer,3*curID*4,3),new Float32Array(localRotations.buffer,4*curID*4,4),new Float32Array(localScales.buffer,3*curID*4,3),new Float32Array(animationNodeWorldMatrixs.buffer,16*curID*4,16));return dest._worldMatrixIndex=curID,this._cloneToNative(dest,localPositions,localRotations,localScales,animationNodeWorldMatrixs,animationNodeParentIndices,curID,avatar),dest},__proto._cloneToNative=function(destObject,localPositions,localRotations,localScales,animationNodeWorldMatrixs,animationNodeParentIndices,parentIndex,avatar){var destNode=destObject;destNode.name=this.name;for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i];avatar._nativeCurCloneCount++;var destChild=child._cloneNative(localPositions,localRotations,localScales,animationNodeWorldMatrixs,animationNodeParentIndices,parentIndex,avatar);destNode.addChild(destChild);var transform=child.transform,destTransform=destChild.transform,destLocalPosition=destTransform.localPosition,destLocalRotation=destTransform.localRotation,destLocalScale=destTransform.localScale;transform.localPosition.cloneTo(destLocalPosition),transform.localRotation.cloneTo(destLocalRotation),transform.localScale.cloneTo(destLocalScale),destTransform.localPosition=destLocalPosition,destTransform.localRotation=destLocalRotation,destTransform.localScale=destLocalScale}},AnimationNode}(),Laya3D=function(){function Laya3D(){}return __class(Laya3D,"Laya3D"),__getset(1,Laya3D,"enbalePhysics",function(){return Laya3D._enbalePhysics}),Laya3D._cancelLoadByUrl=function(url){Laya.loader.cancelLoadByUrl(url),Laya3D._innerFirstLevelLoaderManager.cancelLoadByUrl(url),Laya3D._innerSecondLevelLoaderManager.cancelLoadByUrl(url),Laya3D._innerThirdLevelLoaderManager.cancelLoadByUrl(url),Laya3D._innerFourthLevelLoaderManager.cancelLoadByUrl(url)},Laya3D._changeWebGLSize=function(width,height){WebGL.onStageResize(width,height),RenderContext3D.clientWidth=width,RenderContext3D.clientHeight=height},Laya3D.__init__=function(width,height,config){if(Config.isAntialias=config.isAntialias,Config.isAlpha=config.isAlpha,Config.premultipliedAlpha=config.premultipliedAlpha,Config.isStencil=config.isStencil,WebGL.enable()){RunDriver.changeWebGLSize=Laya3D._changeWebGLSize,Render.is3DMode=!0,Laya.init(width,height),Render.isConchApp||(LayaGL.instance=WebGL.mainContext,LayaGL.instance.createCommandEncoder=function(reserveSize,adjustSize,isSyncToRenderThread){return void 0===reserveSize&&(reserveSize=128),void 0===adjustSize&&(adjustSize=64),void 0===isSyncToRenderThread&&(isSyncToRenderThread=!1),new CommandEncoder(this,reserveSize,adjustSize,isSyncToRenderThread)}),Render.isConchApp&&Laya3D.enableNative3D(),Sprite3D.__init__(),RenderableSprite3D.__init__(),MeshSprite3D.__init__(),SkinnedMeshSprite3D.__init__(),ShuriKenParticle3D.__init__(),BaseMaterial.__init__(),BlinnPhongMaterial.__init__(),PBRStandardMaterial.__init__(),PBRSpecularMaterial.__init__(),SkyProceduralMaterial.__init__(),UnlitMaterial.__init__(),TrailSprite3D.__init__(),TrailMaterial.__init__(),EffectMaterial.__init__(),WaterPrimaryMaterial.__init__(),ShurikenParticleMaterial.__init__(),TerrainMaterial.__init__(),ExtendTerrainMaterial.__init__(),ShaderInit3D.__init__(),Texture2D.__init__(),TextureCube.__init__(),SkyBox.__init__(),SkyDome.__init__(),FrustumCulling.__init__(),HalfFloatUtils.__init__();var createMap=LoaderManager.createMap;createMap.lh=["HIERARCHY",Sprite3D._parse],createMap.ls=["HIERARCHY",Scene3D._parse],createMap.lm=["MESH",Mesh._parse],createMap.lmat=["MATERIAL",BaseMaterial._parse],createMap.ltc=["TEXTURECUBE",TextureCube._parse],createMap.jpg=["TEXTURE2D",Texture2D._parse],createMap.jpeg=["TEXTURE2D",Texture2D._parse],createMap.bmp=["TEXTURE2D",Texture2D._parse],createMap.gif=["TEXTURE2D",Texture2D._parse],createMap.png=["TEXTURE2D",Texture2D._parse],createMap.dds=["TEXTURE2D",Texture2D._parse],createMap.ktx=["TEXTURE2D",Texture2D._parse],createMap.pvr=["TEXTURE2D",Texture2D._parse],createMap.lani=["ANIMATIONCLIP",AnimationClip._parse],createMap.lav=["AVATAR",Avatar._parse],createMap.thdata=["TERRAINHEIGHTDATA",TerrainHeightData._pharse];var parserMap=Loader.parserMap;parserMap.HIERARCHY=Laya3D._loadHierarchy,parserMap.MESH=Laya3D._loadMesh,parserMap.MATERIAL=Laya3D._loadMaterial,parserMap.TEXTURECUBE=Laya3D._loadTextureCube,parserMap.TEXTURE2D=Laya3D._loadTexture2D,parserMap.ANIMATIONCLIP=Laya3D._loadAnimationClip,parserMap.AVATAR=Laya3D._loadAvatar,Laya3D._innerFirstLevelLoaderManager.on("error",null,Laya3D._eventLoadManagerError),Laya3D._innerSecondLevelLoaderManager.on("error",null,Laya3D._eventLoadManagerError),Laya3D._innerThirdLevelLoaderManager.on("error",null,Laya3D._eventLoadManagerError),Laya3D._innerFourthLevelLoaderManager.on("error",null,Laya3D._eventLoadManagerError)}else alert("Laya3D init error,must support webGL!")},Laya3D.enableNative3D=function(){if(Render.isConchApp){LayaGL=window.LayaGLContext;var shaderData=ShaderData,shader3D=ShaderInstance,avatar=Avatar,frustumCulling=FrustumCulling;shaderData.prototype._initData=shaderData.prototype._initDataForNative,shaderData.prototype.setBool=shaderData.prototype.setBoolForNative,shaderData.prototype.getBool=shaderData.prototype.getBoolForNative,shaderData.prototype.setInt=shaderData.prototype.setIntForNative,shaderData.prototype.getInt=shaderData.prototype.getIntForNative,shaderData.prototype.setNumber=shaderData.prototype.setNumberForNative,shaderData.prototype.getNumber=shaderData.prototype.getNumberForNative,shaderData.prototype.setVector=shaderData.prototype.setVectorForNative,shaderData.prototype.getVector=shaderData.prototype.getVectorForNative,shaderData.prototype.setQuaternion=shaderData.prototype.setQuaternionForNative,shaderData.prototype.getQuaternion=shaderData.prototype.getQuaternionForNative,shaderData.prototype.setMatrix4x4=shaderData.prototype.setMatrix4x4ForNative,shaderData.prototype.getMatrix4x4=shaderData.prototype.getMatrix4x4ForNative,shaderData.prototype.setBuffer=shaderData.prototype.setBufferForNative,shaderData.prototype.getBuffer=shaderData.prototype.getBufferForNative,shaderData.prototype.setTexture=shaderData.prototype.setTextureForNative,shaderData.prototype.getTexture=shaderData.prototype.getTextureForNative,shaderData.prototype.setAttribute=shaderData.prototype.setAttributeForNative,shaderData.prototype.getAttribute=shaderData.prototype.getAttributeForNative,shaderData.prototype.cloneTo=shaderData.prototype.cloneToForNative,shader3D.prototype._uniformMatrix2fv=shader3D.prototype._uniformMatrix2fvForNative,shader3D.prototype._uniformMatrix3fv=shader3D.prototype._uniformMatrix3fvForNative,shader3D.prototype._uniformMatrix4fv=shader3D.prototype._uniformMatrix4fvForNative,avatar.prototype._cloneDatasToAnimator=avatar.prototype._cloneDatasToAnimatorNative,frustumCulling.renderObjectCulling=FrustumCulling.renderObjectCullingNative,FloatKeyframe=window.conchFloatKeyframe,FloatArrayKeyframe=window.conchFloatArrayKeyframe,KeyframeNode=window.conchKeyframeNode,KeyframeNodeList=window.conchKeyframeNodeList;var animationClip=AnimationClip;animationClip.prototype._evaluateClipDatasRealTime=animationClip.prototype._evaluateClipDatasRealTimeForNative}WebGL.shaderHighPrecision=!1,LayaGL.instance.getShaderPrecisionFormat(35632,36338).precision?WebGL.shaderHighPrecision=!0:WebGL.shaderHighPrecision=!1},Laya3D.formatRelativePath=function(base,value){var path;if(path=base+value,"."===value.charAt(0)){for(var parts=path.split("/"),i=0,len=parts.length;i<len;i++)if(".."==parts[i]){var index=i-1;index>0&&".."!==parts[index]&&(parts.splice(index,2),i-=2)}path=parts.join("/")}return null!=URL.customFormat&&(path=URL.customFormat(path,null)),path},Laya3D._endLoad=function(loader,content,subResous){if(subResous)for(var i=0,n=subResous.length;i<n;i++){var resou=Loader.getRes(subResous[i]);resou&&resou._removeReference()}loader.endLoad(content)},Laya3D._eventLoadManagerError=function(msg){Laya.loader.event("error",msg)},Laya3D._addHierarchyInnerUrls=function(urls,urlMap,urlVersion,hierarchyBasePath,path,type,constructParams,propertyParams){var formatUrl=Laya3D.formatRelativePath(hierarchyBasePath,path);return urlVersion&&(formatUrl+=urlVersion),urls.push({url:formatUrl,type:type,constructParams:constructParams,propertyParams:propertyParams}),urlMap.push(formatUrl),formatUrl},Laya3D._getSprite3DHierarchyInnerUrls=function(node,firstLevelUrls,secondLevelUrls,thirdLevelUrls,fourthLelUrls,subUrls,urlVersion,hierarchyBasePath){var i=0,n=0,props=node.props;switch(node.type){case"Scene3D":var lightmaps=props.lightmaps;for(i=0,n=lightmaps.length;i<n;i++){var lightMap=lightmaps[i];lightMap.path=Laya3D._addHierarchyInnerUrls(fourthLelUrls,subUrls,urlVersion,hierarchyBasePath,lightMap.path,"TEXTURE2D",lightMap.constructParams,lightMap.propertyParams)}var reflectionTextureData=props.reflectionTexture;if(reflectionTextureData&&(props.reflectionTexture=Laya3D._addHierarchyInnerUrls(thirdLevelUrls,subUrls,urlVersion,hierarchyBasePath,reflectionTextureData,"TEXTURECUBE")),props.sky){var skyboxMaterial=props.sky.material;skyboxMaterial&&(skyboxMaterial.path=Laya3D._addHierarchyInnerUrls(secondLevelUrls,subUrls,urlVersion,hierarchyBasePath,skyboxMaterial.path,"MATERIAL"))}break;case"Camera":var skyboxMatData=props.skyboxMaterial;skyboxMatData&&(skyboxMatData.path=Laya3D._addHierarchyInnerUrls(secondLevelUrls,subUrls,urlVersion,hierarchyBasePath,skyboxMatData.path,"MATERIAL"));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":var meshPath=props.meshPath;meshPath&&(props.meshPath=Laya3D._addHierarchyInnerUrls(firstLevelUrls,subUrls,urlVersion,hierarchyBasePath,meshPath,"MESH"));var materials=props.materials;if(materials)for(i=0,n=materials.length;i<n;i++)materials[i].path=Laya3D._addHierarchyInnerUrls(secondLevelUrls,subUrls,urlVersion,hierarchyBasePath,materials[i].path,"MATERIAL");break;case"ShuriKenParticle3D":var parMeshPath=props.meshPath;parMeshPath&&(props.meshPath=Laya3D._addHierarchyInnerUrls(firstLevelUrls,subUrls,urlVersion,hierarchyBasePath,parMeshPath,"MESH")),props.material.path=Laya3D._addHierarchyInnerUrls(secondLevelUrls,subUrls,urlVersion,hierarchyBasePath,props.material.path,"MATERIAL");break;case"Terrain":Laya3D._addHierarchyInnerUrls(fourthLelUrls,subUrls,urlVersion,hierarchyBasePath,props.dataPath,"TERRAIN")}var components=node.components;if(components)for(var k=0,p=components.length;k<p;k++){var component=components[k];switch(component.type){case"Animator":component.avatarPath;var avatarData=component.avatar;avatarData&&(avatarData.path=Laya3D._addHierarchyInnerUrls(fourthLelUrls,subUrls,urlVersion,hierarchyBasePath,avatarData.path,"AVATAR"));var clipPaths=component.clipPaths;if(clipPaths)for(i=0,n=clipPaths.length;i<n;i++)clipPaths[i]=Laya3D._addHierarchyInnerUrls(fourthLelUrls,subUrls,urlVersion,hierarchyBasePath,clipPaths[i],"ANIMATIONCLIP");else{var layersData=component.layers;for(i=0;i<layersData.length;i++)for(var states=layersData[i].states,j=0,m=states.length;j<m;j++){var clipPath=states[j].clipPath;clipPath&&(states[j].clipPath=Laya3D._addHierarchyInnerUrls(fourthLelUrls,subUrls,urlVersion,hierarchyBasePath,clipPath,"ANIMATIONCLIP"))}}break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var shapes=component.shapes;for(i=0;i<shapes.length;i++){var shape=shapes[i];if("MeshColliderShape"===shape.type){var mesh=shape.mesh;mesh&&(shape.mesh=Laya3D._addHierarchyInnerUrls(firstLevelUrls,subUrls,urlVersion,hierarchyBasePath,mesh,"MESH"))}}}}var children=node.child;for(i=0,n=children.length;i<n;i++)Laya3D._getSprite3DHierarchyInnerUrls(children[i],firstLevelUrls,secondLevelUrls,thirdLevelUrls,fourthLelUrls,subUrls,urlVersion,hierarchyBasePath)},Laya3D._loadHierarchy=function(loader){loader.on("loaded",null,Laya3D._onHierarchylhLoaded,[loader]),loader.load(loader.url,"json",!1,null,!0)},Laya3D._onHierarchylhLoaded=function(loader,lhData){var url=loader.url,urlVersion=Utils3D.getURLVerion(url),hierarchyBasePath=URL.getPath(url),firstLevUrls=[],secondLevUrls=[],thirdLevUrls=[],forthLevUrls=[],subUrls=[];Laya3D._getSprite3DHierarchyInnerUrls(lhData.data,firstLevUrls,secondLevUrls,thirdLevUrls,forthLevUrls,subUrls,urlVersion,hierarchyBasePath);var urlCount=firstLevUrls.length+secondLevUrls.length+forthLevUrls.length,totalProcessCount=urlCount+1,weight=1/totalProcessCount;if(Laya3D._onProcessChange(loader,0,weight,1),forthLevUrls.length>0){var processCeil=urlCount/totalProcessCount,processHandler=Handler.create(null,Laya3D._onProcessChange,[loader,weight,processCeil],!1);Laya3D._innerFourthLevelLoaderManager._create(forthLevUrls,!1,Handler.create(null,Laya3D._onHierarchyInnerForthLevResouLoaded,[loader,processHandler,lhData,subUrls,firstLevUrls,secondLevUrls,thirdLevUrls,weight+processCeil*forthLevUrls.length,processCeil]),processHandler,null,null,null,1,!0)}else Laya3D._onHierarchyInnerForthLevResouLoaded(loader,null,lhData,subUrls,firstLevUrls,secondLevUrls,thirdLevUrls,weight,processCeil)},Laya3D._onHierarchyInnerForthLevResouLoaded=function(loader,processHandler,lhData,subUrls,firstLevUrls,secondLevUrls,thirdLevUrls,processOffset,processCeil){if(processHandler&&processHandler.recover(),thirdLevUrls.length>0){var process=Handler.create(null,Laya3D._onProcessChange,[loader,processOffset,processCeil],!1);Laya3D._innerThirdLevelLoaderManager._create(thirdLevUrls,!1,Handler.create(null,Laya3D._onHierarchyInnerThirdLevResouLoaded,[loader,process,lhData,subUrls,firstLevUrls,secondLevUrls,processOffset+processCeil*secondLevUrls.length,processCeil]),processHandler,null,null,null,1,!0)}else Laya3D._onHierarchyInnerThirdLevResouLoaded(loader,null,lhData,subUrls,firstLevUrls,secondLevUrls,processOffset,processCeil)},Laya3D._onHierarchyInnerThirdLevResouLoaded=function(loader,processHandler,lhData,subUrls,firstLevUrls,secondLevUrls,processOffset,processCeil){if(processHandler&&processHandler.recover(),secondLevUrls.length>0){var process=Handler.create(null,Laya3D._onProcessChange,[loader,processOffset,processCeil],!1);Laya3D._innerSecondLevelLoaderManager._create(secondLevUrls,!1,Handler.create(null,Laya3D._onHierarchyInnerSecondLevResouLoaded,[loader,process,lhData,subUrls,firstLevUrls,processOffset+processCeil*secondLevUrls.length,processCeil]),processHandler,null,null,null,1,!0)}else Laya3D._onHierarchyInnerSecondLevResouLoaded(loader,null,lhData,subUrls,firstLevUrls,processOffset,processCeil)},Laya3D._onHierarchyInnerSecondLevResouLoaded=function(loader,processHandler,lhData,subUrls,firstLevUrls,processOffset,processCeil){if(processHandler&&processHandler.recover(),firstLevUrls.length>0){var process=Handler.create(null,Laya3D._onProcessChange,[loader,processOffset,processCeil],!1);Laya3D._innerFirstLevelLoaderManager._create(firstLevUrls,!1,Handler.create(null,Laya3D._onHierarchyInnerFirstLevResouLoaded,[loader,process,lhData,subUrls]),processHandler,null,null,null,1,!0)}else Laya3D._onHierarchyInnerFirstLevResouLoaded(loader,null,lhData,subUrls)},Laya3D._onHierarchyInnerFirstLevResouLoaded=function(loader,processHandler,lhData,subUrls){processHandler&&processHandler.recover(),loader._cache=loader._createCache;var item="Scene3D"===lhData.data.type?Scene3D._parse(lhData,loader._propertyParams,loader._constructParams):Sprite3D._parse(lhData,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,item,subUrls)},Laya3D._loadMesh=function(loader){loader.on("loaded",null,Laya3D._onMeshLmLoaded,[loader]),loader.load(loader.url,"arraybuffer",!1,null,!0)},Laya3D._onMeshLmLoaded=function(loader,lmData){loader._cache=loader._createCache;var mesh=Mesh._parse(lmData,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,mesh)},Laya3D._loadMaterial=function(loader){loader.on("loaded",null,Laya3D._onMaterilLmatLoaded,[loader]),loader.load(loader.url,"json",!1,null,!0)},Laya3D._onMaterilLmatLoaded=function(loader,lmatData){var formatSubUrl,url=loader.url,urlVersion=Utils3D.getURLVerion(url),materialBasePath=URL.getPath(url),urls=[],subUrls=[];lmatData.customProps;switch(lmatData.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var i=0,n=0,textures=lmatData.props.textures;if(textures)for(i=0,n=textures.length;i<n;i++){var tex2D=textures[i],tex2DPath=tex2D.path;tex2DPath&&(formatSubUrl=Laya3D.formatRelativePath(materialBasePath,tex2DPath),urlVersion&&(formatSubUrl+=urlVersion),urls.push({url:formatSubUrl,constructParams:tex2D.constructParams,propertyParams:tex2D.propertyParams}),subUrls.push(formatSubUrl),tex2D.path=formatSubUrl)}break;default:throw new Error("Laya3D:unkonwn version.")}var urlCount=urls.length,totalProcessCount=urlCount+1,lmatWeight=1/totalProcessCount;if(Laya3D._onProcessChange(loader,0,lmatWeight,1),urlCount>0){var processHandler=Handler.create(null,Laya3D._onProcessChange,[loader,lmatWeight,urlCount/totalProcessCount],!1);Laya3D._innerFourthLevelLoaderManager._create(urls,!1,Handler.create(null,Laya3D._onMateialTexturesLoaded,[loader,processHandler,lmatData,subUrls]),processHandler,null,null,null,1,!0)}else Laya3D._onMateialTexturesLoaded(loader,null,lmatData,null)},Laya3D._onMateialTexturesLoaded=function(loader,processHandler,lmatData,subUrls){loader._cache=loader._createCache;var mat=BaseMaterial._parse(lmatData,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,mat,subUrls),processHandler&&processHandler.recover()},Laya3D._loadAvatar=function(loader){loader.load(loader.url,"json",!1,null,!0),loader.on("loaded",null,function(data){loader._cache=loader._createCache;var avatar=Avatar._parse(data,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,avatar)})},Laya3D._loadAnimationClip=function(loader){loader.load(loader.url,"arraybuffer",!1,null,!0),loader.on("loaded",null,function(data){loader._cache=loader._createCache;var clip=AnimationClip._parse(data,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,clip)})},Laya3D._loadTexture2D=function(loader){var type,url=loader.url,index=url.lastIndexOf(".")+1,verIndex=url.indexOf("?"),endIndex=-1==verIndex?url.length:verIndex;switch(url.substr(index,endIndex-index)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":type="nativeimage";break;case"dds":case"ktx":case"pvr":type="arraybuffer"}loader.load(loader.url,type,!1,null,!0),loader.on("loaded",null,function(image){loader._cache=loader._createCache;var tex=Texture2D._parse(image,loader._propertyParams,loader._constructParams);Laya3D._endLoad(loader,tex)})},Laya3D._loadTextureCube=function(loader){loader.load(loader.url,"json",!1,null,!0),loader.on("loaded",null,Laya3D._onTextureCubeLtcLoaded,[loader])},Laya3D._onTextureCubeLtcLoaded=function(loader,ltcData){var ltcBasePath=URL.getPath(loader.url),urls=[Laya3D.formatRelativePath(ltcBasePath,ltcData.front),Laya3D.formatRelativePath(ltcBasePath,ltcData.back),Laya3D.formatRelativePath(ltcBasePath,ltcData.left),Laya3D.formatRelativePath(ltcBasePath,ltcData.right),Laya3D.formatRelativePath(ltcBasePath,ltcData.up),Laya3D.formatRelativePath(ltcBasePath,ltcData.down)];Laya3D._onProcessChange(loader,0,1/7,1);var processHandler=Handler.create(null,Laya3D._onProcessChange,[loader,1/7,6/7],!1);Laya3D._innerFourthLevelLoaderManager.load(urls,Handler.create(null,Laya3D._onTextureCubeImagesLoaded,[loader,urls,processHandler]),processHandler,"nativeimage")},Laya3D._onTextureCubeImagesLoaded=function(loader,urls,processHandler){for(var images=new Array(6),i=0;i<6;i++)images[i]=Loader.getRes(urls[i]);loader._cache=loader._createCache;var tex=TextureCube._parse(images,loader._propertyParams,loader._constructParams);for(processHandler.recover(),i=0;i<6;i++)Loader.clearRes(urls[i]);Laya3D._endLoad(loader,tex)},Laya3D._onProcessChange=function(loader,offset,weight,process){(process=offset+process*weight)<1&&loader.event("progress",process)},Laya3D.init=function(width,height,config,compolete){if(!Laya3D._isInit){Laya3D._isInit=!0,config=config||Config3D._defaultConfig,Laya3D._editerEnvironment=config._editerEnvironment;var physics3D=window.Physics3D;null==physics3D?(Laya3D._enbalePhysics=!1,Laya3D.__init__(width,height,config),compolete&&compolete.run()):(Laya3D._enbalePhysics=!0,physics3D(1024*config.defaultPhysicsMemory*1024).then(function(){Laya3D.__init__(width,height,config),compolete&&compolete.run()}))}},Laya3D.HIERARCHY="HIERARCHY",Laya3D.MESH="MESH",Laya3D.MATERIAL="MATERIAL",Laya3D.TEXTURE2D="TEXTURE2D",Laya3D.TEXTURECUBE="TEXTURECUBE",Laya3D.ANIMATIONCLIP="ANIMATIONCLIP",Laya3D.AVATAR="AVATAR",Laya3D.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Laya3D.TERRAINRES="TERRAIN",Laya3D._isInit=!1,Laya3D._enbalePhysics=!1,Laya3D._editerEnvironment=!1,Laya3D.debugMode=!1,__static(Laya3D,["_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new LoaderManager},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new LoaderManager},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new LoaderManager},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new LoaderManager},"_physics3D",function(){return this._physics3D=window.Physics3D},"physicsSettings",function(){return this.physicsSettings=new PhysicsSettings}]),Laya3D}(),ShapeUtils=function(){function ShapeUtils(){}return __class(ShapeUtils,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),ShapeUtils._randomPointUnitArcCircle=function(arc,out,rand){var outE=out.elements,angle=NaN;angle=rand?rand.getFloat()*arc:Math.random()*arc,outE[0]=Math.cos(angle),outE[1]=Math.sin(angle)},ShapeUtils._randomPointInsideUnitArcCircle=function(arc,out,rand){var outE=out.elements;ShapeUtils._randomPointUnitArcCircle(arc,out,rand);var range=NaN;range=rand?Math.pow(rand.getFloat(),.5):Math.pow(Math.random(),.5),outE[0]=outE[0]*range,outE[1]=outE[1]*range},ShapeUtils._randomPointUnitCircle=function(out,rand){var outE=out.elements,angle=NaN;angle=rand?rand.getFloat()*Math.PI*2:Math.random()*Math.PI*2,outE[0]=Math.cos(angle),outE[1]=Math.sin(angle)},ShapeUtils._randomPointInsideUnitCircle=function(out,rand){var outE=out.elements;ShapeUtils._randomPointUnitCircle(out);var range=NaN;range=rand?Math.pow(rand.getFloat(),.5):Math.pow(Math.random(),.5),outE[0]=outE[0]*range,outE[1]=outE[1]*range},ShapeUtils._randomPointUnitSphere=function(out,rand){var outE=out.elements,z=NaN,a=NaN;rand?(z=outE[2]=2*rand.getFloat()-1,a=rand.getFloat()*Math.PI*2):(z=outE[2]=2*Math.random()-1,a=Math.random()*Math.PI*2);var r=Math.sqrt(1-z*z);outE[0]=r*Math.cos(a),outE[1]=r*Math.sin(a)},ShapeUtils._randomPointInsideUnitSphere=function(out,rand){var outE=out.elements;ShapeUtils._randomPointUnitSphere(out);var range=NaN;range=rand?Math.pow(rand.getFloat(),1/3):Math.pow(Math.random(),1/3),outE[0]=outE[0]*range,outE[1]=outE[1]*range,outE[2]=outE[2]*range},ShapeUtils._randomPointInsideHalfUnitBox=function(out,rand){var outE=out.elements;rand?(outE[0]=rand.getFloat()-.5,outE[1]=rand.getFloat()-.5,outE[2]=rand.getFloat()-.5):(outE[0]=Math.random()-.5,outE[1]=Math.random()-.5,outE[2]=Math.random()-.5)},ShapeUtils}(),VelocityOverLifetime=function(){function VelocityOverLifetime(velocity){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=velocity}__class(VelocityOverLifetime,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var __proto=VelocityOverLifetime.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.cloneTo=function(destObject){var destVelocityOverLifetime=destObject;this._velocity.cloneTo(destVelocityOverLifetime._velocity),destVelocityOverLifetime.enbale=this.enbale,destVelocityOverLifetime.space=this.space},__proto.clone=function(){var destVelocity;switch(this._velocity.type){case 0:destVelocity=GradientVelocity.createByConstant(this._velocity.constant.clone());break;case 1:destVelocity=GradientVelocity.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:destVelocity=GradientVelocity.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:destVelocity=GradientVelocity.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var destVelocityOverLifetime=new this.constructor(destVelocity);return destVelocityOverLifetime.enbale=this.enbale,destVelocityOverLifetime.space=this.space,destVelocityOverLifetime},__getset(0,__proto,"velocity",function(){return this._velocity}),VelocityOverLifetime}(),Viewport=(function(){function GradientDataVector2(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}__class(GradientDataVector2,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var __proto=GradientDataVector2.prototype;Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.add=function(key,value){this._currentLength<8?(6===this._currentLength&&1!==key&&(key=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=key,this._elements[this._currentLength++]=value.x,this._elements[this._currentLength++]=value.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},__proto.cloneTo=function(destObject){var destGradientDataVector2=destObject;destGradientDataVector2._currentLength=this._currentLength;var destElements=destGradientDataVector2._elements;destElements.length=this._elements.length;for(var i=0,n=this._elements.length;i<n;i++)destElements[i]=this._elements[i]},__proto.clone=function(){var destGradientDataVector2=new this.constructor;return this.cloneTo(destGradientDataVector2),destGradientDataVector2},__getset(0,__proto,"gradientCount",function(){return this._currentLength/3})}(),function(){function Point2PointConstraint(){this._damping=NaN,this._impulseClamp=NaN,this._tau=NaN,this._pivotInA=new Vector3,this._pivotInB=new Vector3}__class(Point2PointConstraint,"laya.d3.physics.constraints.Point2PointConstraint");var __proto=Point2PointConstraint.prototype;__getset(0,__proto,"pivotInA",function(){return this._pivotInA},function(value){this._pivotInA=value}),__getset(0,__proto,"pivotInB",function(){return this._pivotInB},function(value){this._pivotInB=value}),__getset(0,__proto,"damping",function(){return this._damping},function(value){this._damping=value}),__getset(0,__proto,"impulseClamp",function(){return this._impulseClamp},function(value){this._impulseClamp=value}),__getset(0,__proto,"tau",function(){return this._tau},function(value){this._tau=value})}(),function(){function Viewport(x,y,width,height){this.minDepth=0,this.maxDepth=1,this.x=x,this.y=y,this.width=width,this.height=height}__class(Viewport,"laya.d3.math.Viewport");var __proto=Viewport.prototype;return __proto.project=function(source,matrix,out){Vector3.transformV3ToV3(source,matrix,out);var sourceEleme=source.elements,matrixEleme=matrix.elements,outEleme=out.elements,a=sourceEleme[0]*matrixEleme[3]+sourceEleme[1]*matrixEleme[7]+sourceEleme[2]*matrixEleme[11]+matrixEleme[15];1!==a&&(outEleme[0]=outEleme[0]/a,outEleme[1]=outEleme[1]/a,outEleme[2]=outEleme[2]/a),outEleme[0]=.5*(outEleme[0]+1)*this.width+this.x,outEleme[1]=.5*(1-outEleme[1])*this.height+this.y,outEleme[2]=outEleme[2]*(this.maxDepth-this.minDepth)+this.minDepth},__proto.project1=function(source,matrix,out){var v4=Vector3._tempVector4;Vector3.transformV3ToV4(source,matrix,v4);var v4e=v4.elements,dist=v4e[3];dist<.1&&dist>-1e-6&&(dist=1e-6),v4e[0]/=dist,v4e[1]/=dist,v4e[2]/=dist;var outEleme=out.elements;outEleme[0]=(v4e[0]+1)*this.width/2+this.x,outEleme[1]=(1-v4e[1])*this.height/2+this.y,outEleme[2]=v4e[3]},__proto.unprojectFromMat=function(source,matrix,out){var sourceEleme=source.elements,matrixEleme=matrix.elements,outEleme=out.elements;outEleme[0]=(sourceEleme[0]-this.x)/this.width*2-1,outEleme[1]=-((sourceEleme[1]-this.y)/this.height*2-1);var halfDepth=(this.maxDepth-this.minDepth)/2;outEleme[2]=(sourceEleme[2]-this.minDepth-halfDepth)/halfDepth;var a=outEleme[0]*matrixEleme[3]+outEleme[1]*matrixEleme[7]+outEleme[2]*matrixEleme[11]+matrixEleme[15];Vector3.transformV3ToV3(out,matrix,out),1!==a&&(outEleme[0]=outEleme[0]/a,outEleme[1]=outEleme[1]/a,outEleme[2]=outEleme[2]/a)},__proto.unprojectFromWVP=function(source,projection,view,world,out){Matrix4x4.multiply(projection,view,Viewport._tempMatrix4x4),world&&Matrix4x4.multiply(Viewport._tempMatrix4x4,world,Viewport._tempMatrix4x4),Viewport._tempMatrix4x4.invert(Viewport._tempMatrix4x4),this.unprojectFromMat(source,Viewport._tempMatrix4x4,out)},__proto.cloneTo=function(out){out.x=this.x,out.y=this.y,out.width=this.width,out.height=this.height,out.minDepth=this.minDepth,out.maxDepth=this.maxDepth},__static(Viewport,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4}]),Viewport}()),VertexElementFormat=(function(){function RandX(seed){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(seed instanceof Array)||4!==seed.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|seed[0],this._state0L=0|seed[1],this._state1U=0|seed[2],this._state1L=0|seed[3]}__class(RandX,"laya.d3.math.RandX");var __proto=RandX.prototype;__proto.randomint=function(){var s1U=this._state0U,s1L=this._state0L,s0U=this._state1U,s0L=this._state1L,sumL=(s0L>>>0)+(s1L>>>0),resU=s0U+s1U+(sumL/2>>>31)>>>0,resL=sumL>>>0;this._state0U=s0U,this._state0L=s0L;var t1U=0,t1L=0;t1U=(s1U^=t1U=s1U<<23|(-512&s1L)>>>9)^s0U,t1L=(s1L^=t1L=s1L<<23)^s0L;t1U^=s1U>>>18,t1L^=s1L>>>18|(262143&s1U)<<14;return t1U^=s0U>>>5,t1L^=s0L>>>5|(31&s0U)<<27,this._state1U=t1U,this._state1L=t1L,[resU,resL]},__proto.random=function(){var t2=this.randomint(),t2U=t2[0],xU=1023<<20|t2U>>>12,xL=0|(t2[1]>>>12|(4095&t2U)<<20);return RandX._CONVERTION_BUFFER.setUint32(0,xU,!1),RandX._CONVERTION_BUFFER.setUint32(4,xL,!1),Rand._CONVERTION_BUFFER.getFloat64(0,!1)-1},__static(RandX,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new Rand([0,Date.now()/65536,0,Date.now()%65536])}])}(),function(){function VertexElementFormat(){}return __class(VertexElementFormat,"laya.d3.graphics.VertexElementFormat"),VertexElementFormat.getElementInfos=function(element){var info=VertexElementFormat._elementInfos[element];if(info)return info;throw"VertexElementFormat: this vertexElementFormat is not implement."},VertexElementFormat.Single="single",VertexElementFormat.Vector2="vector2",VertexElementFormat.Vector3="vector3",VertexElementFormat.Vector4="vector4",VertexElementFormat.Color="color",VertexElementFormat.Byte4="byte4",VertexElementFormat.Short2="short2",VertexElementFormat.Short4="short4",VertexElementFormat.NormalizedShort2="normalizedshort2",VertexElementFormat.NormalizedShort4="normalizedshort4",VertexElementFormat.HalfVector2="halfvector2",VertexElementFormat.HalfVector4="halfvector4",__static(VertexElementFormat,["_elementInfos",function(){return this._elementInfos={single:[1,5126,0],vector2:[2,5126,0],vector3:[3,5126,0],vector4:[4,5126,0],color:[4,5126,0],byte4:[4,5121,0],short2:[2,5126,0],short4:[4,5126,0],normalizedshort2:[2,5126,0],normalizedshort4:[4,5126,0],halfvector2:[2,5126,0],halfvector4:[4,5126,0]}}]),VertexElementFormat}()),ShaderInit3D=function(){function ShaderInit3D(){}return __class(ShaderInit3D,"laya.d3.shader.ShaderInit3D"),ShaderInit3D.__init__=function(){var vs,ps;ShaderInit3D._rangeAttenTex=Utils3D._buildTexture2D(1024,1,2,TextureGenerator.lightAttenTexture),ShaderInit3D._rangeAttenTex.wrapModeU=1,ShaderInit3D._rangeAttenTex.wrapModeV=1,ShaderInit3D._rangeAttenTex.lock=!0,Shader3D.SHADERDEFINE_HIGHPRECISION=Shader3D.registerPublicDefine("HIGHPRECISION"),Scene3D.SHADERDEFINE_FOG=Shader3D.registerPublicDefine("FOG"),Scene3D.SHADERDEFINE_DIRECTIONLIGHT=Shader3D.registerPublicDefine("DIRECTIONLIGHT"),Scene3D.SHADERDEFINE_POINTLIGHT=Shader3D.registerPublicDefine("POINTLIGHT"),Scene3D.SHADERDEFINE_SPOTLIGHT=Shader3D.registerPublicDefine("SPOTLIGHT"),Scene3D.SHADERDEFINE_CAST_SHADOW=Shader3D.registerPublicDefine("CASTSHADOW"),Scene3D.SHADERDEFINE_SHADOW_PSSM1=Shader3D.registerPublicDefine("SHADOWMAP_PSSM1"),Scene3D.SHADERDEFINE_SHADOW_PSSM2=Shader3D.registerPublicDefine("SHADOWMAP_PSSM2"),Scene3D.SHADERDEFINE_SHADOW_PSSM3=Shader3D.registerPublicDefine("SHADOWMAP_PSSM3"),Scene3D.SHADERDEFINE_SHADOW_PCF_NO=Shader3D.registerPublicDefine("SHADOWMAP_PCF_NO"),Scene3D.SHADERDEFINE_SHADOW_PCF1=Shader3D.registerPublicDefine("SHADOWMAP_PCF1"),Scene3D.SHADERDEFINE_SHADOW_PCF2=Shader3D.registerPublicDefine("SHADOWMAP_PCF2"),Scene3D.SHADERDEFINE_SHADOW_PCF3=Shader3D.registerPublicDefine("SHADOWMAP_PCF3"),Scene3D.SHADERDEFINE_REFLECTMAP=Shader3D.registerPublicDefine("REFLECTMAP"),Shader3D.addInclude("Lighting.glsl","\nstruct DirectionLight {\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight {\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight {\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// Laya中使用衰减纹理\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n}\n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\n\treturn attenuation * attenuation;\n}\n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n}\n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\n\tmediump vec3 h = normalize(viewDir-lightVec);\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\n\tfloat nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range)\n\t//\treturn;\n\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.Spot,light.Spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.Direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tvec3 N = normalize(unitNormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN * normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\nvec3 DecodeLightmap(vec4 color) {\n\treturn color.rgb*color.a*5.0;\n}\n\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\n"),Shader3D.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\n\t\tif(value < 0.8)\n\n\t\t{ \n\n\t\tvalue = 0.8;\n\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\n\t\tif(value < 0.8)\n\n\t\t{\n\n\t\tvalue = 0.8;\n\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\n\t\t\t\tif(value < 0.8)\n\n\t\t{\n\n\t\tvalue = 0.8;\n\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Shader3D.addInclude("BRDF.glsl","struct LayaGI\n{\n\tvec3 diffuse;\n\tvec3 specular;\n};\n\nvec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tfloat surfaceReduction = 1.0 - 0.28 * roughness * perceptualRoughness;\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity), 0.0, 1.0);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi.diffuse + lightColor * diffuseTerm) \n\t\t\t  + specularTerm * lightColor * FresnelTerm (specularColor, lh)\n\t\t\t  + surfaceReduction * gi.specular * FresnelLerp(specularColor, vec3(grazingTerm), nv);\n\t\n\treturn color;\n}"),Shader3D.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat SpotAngle;\n\tfloat Range;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nvec3 FresnelLerp (in vec3 F0, in vec3 F90, float cosA)\n{\n    float t = pow(1.0 - cosA, 5.0);\n    return mix(F0, F90, t);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\nvec3 ReflectCubeMap(in vec3 viewDir, in vec3 normal){\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident, normal);\n\t\tvec3 reflectionColor = textureCube(u_ReflectTexture, vec3(-reflectionVector.x, reflectionVector.yz)).rgb;\n\t\treturn reflectionColor * u_ReflectIntensity;\n\t#else\n\t\treturn vec3(0.0);\n\t#endif\n}\n\nfloat LayaAttenuation(in vec3 L, in float invLightRadius)\n{\n\tfloat fRatio = clamp(length(L) * invLightRadius, 0.0, 1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio) * clamp(4.0*(1.0 - fRatio), 0.0, 1.0); //fade to black as if 4 pixel texture\n}\n\nvec3 LayaPreMultiplyAlpha(vec3 diffColor, float alpha, float oneMinusReflectivity, out float outModifiedAlpha)\n{\n\t#ifdef ALPHAPREMULTIPLY\n\t\tdiffColor *= alpha;\n\t\toutModifiedAlpha = 1.0 - oneMinusReflectivity + alpha * oneMinusReflectivity;\n\t#else\n\t\toutModifiedAlpha = alpha;\n\t#endif\n\treturn diffColor;\n}\n\n"),Shader3D.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat alpha;\n\t\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (albedoColor.rgb, metallic, specularColor, oneMinusReflectivity);\n\t\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\tcolor.a = alpha;\n\treturn color;\n}\n\nvec4 PBRStandardDiectionLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 PBRStandardPointLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightCoord = (u_PointLightMatrix * vec4(pos, 1.0)).xyz;\n\tfloat distance = dot(lightCoord, lightCoord);\n\tfloat attenuate = texture2D(u_RangeTexture, vec2(distance)).w;\n\tvec3 lightVec = normalize(pos - light.Position);\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\nvec4 PBRStandardSpotLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightVec =  pos - light.Position;\n\tvec3 normalLightVec = normalize(lightVec);\n\tvec2 cosAngles = cos(vec2(light.SpotAngle, light.SpotAngle*0.5) * 0.5);//ConeAttenuation\n\tfloat dl = dot(normalize(light.Direction), normalLightVec);\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range) * dl;\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n//{\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\n//\t\n//\tfloat distance = dot(lightCoord, lightCoord);\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\n//\tvec3 lightVec = normalize(pos - light.Position);\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n//}\n\nvec2 MetallicGloss(in float albedoTextureAlpha, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = albedoTextureAlpha;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tmg.g = albedoTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\n'),Shader3D.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 diffuseColor;\n\tfloat alpha;\n\t\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (albedoColor.rgb, specularColor, oneMinusReflectivity);\n\t\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\tcolor.a = alpha;\n\treturn color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 PBRSpecularPointLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightCoord = (u_PointLightMatrix * vec4(pos, 1.0)).xyz;\n\tfloat distance = dot(lightCoord, lightCoord);\n\tfloat attenuate = texture2D(u_RangeTexture, vec2(distance)).w;\n\tvec3 lightVec = normalize(pos - light.Position);\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\nvec4 PBRSpecularSpotLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightVec =  pos - light.Position;\n\tvec3 normalLightVec = normalize(lightVec);\n\tvec2 cosAngles = cos(vec2(light.SpotAngle, light.SpotAngle*0.5) * 0.5);//ConeAttenuation\n\tfloat dl = dot(normalize(light.Direction), normalLightVec);\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range) * dl;\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n//{\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\n//\t\n//\tfloat distance = dot(lightCoord, lightCoord);\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\n//\tvec3 lightVec = normalize(pos - light.Position);\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n//}\n\nvec4 SpecularGloss(float albedoTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n\t\n\t#ifdef SPECULARTEXTURE\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.rgb = specularTextureColor.rgb;\n\t\t\tsg.a = albedoTextureAlpha;\n\t\t#else\n\t\t\tsg = specularTextureColor;\n\t\t#endif\n\t\tsg.a *= u_smoothnessScale;\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.a = albedoTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tsg.a = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n    return sg;\n}\n\n');var attributeMap={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:8,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},uniformMap={u_Bones:0,u_DiffuseTexture:1,u_SpecularTexture:1,u_NormalTexture:1,u_AlphaTestValue:1,u_DiffuseColor:1,u_MaterialSpecular:1,u_Shininess:1,u_TilingOffset:1,u_WorldMat:2,u_MvpMatrix:2,u_LightmapScaleOffset:2,u_LightMap:2,u_CameraPos:3,u_ReflectTexture:4,u_ReflectIntensity:4,u_FogStart:4,u_FogRange:4,u_FogColor:4,"u_DirectionLight.Color":4,"u_DirectionLight.Direction":4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.Spot":4,"u_SpotLight.Color":4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4};vs='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\nvoid main_normal()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tmat3 worldInvMat;\n\t\t#ifdef BONE\n\t\t\tworldInvMat=inverse(mat3(u_WorldMat*skinTransform));\n\t\t#else\n\t\t\tworldInvMat=inverse(mat3(u_WorldMat));\n\t\t#endif  \n\t\tv_Normal=a_Normal*worldInvMat;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t\t#ifdef BONE\n\t\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t\t#else\n\t\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=a_Texcoord0;\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=TransformUV(v_Texcoord0,u_TilingOffset);\n\t\t#endif\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#endif \n\t\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\n\t\t#else\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t\t#endif \n\t\t#endif \n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',ps='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec3 globalDiffuse=u_AmbientColor;\n\t#ifdef LIGHTMAP\t\n\t\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t#endif\n\t\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse)*shadowValue,mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n';var shader=Shader3D.add("BLINNPHONG"),subShader=new SubShader(attributeMap,uniformMap,SkinnedMeshSprite3D.shaderDefines,BlinnPhongMaterial.shaderDefines);shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Color:1},uniformMap={u_MvpMatrix:2,u_Color:1},vs="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}",ps="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nuniform vec4 u_Color;\n\nvoid main()\n{\n  gl_FragColor = v_Color * u_Color; \n}\n\n",shader=Shader3D.add("LineShader"),subShader=new SubShader(attributeMap,uniformMap),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},uniformMap={u_Bones:0,u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_AlphaTestValue:1,u_AlbedoColor:1,u_EmissionColor:1,u_AlbedoTexture:1,u_NormalTexture:1,u_ParallaxTexture:1,u_MetallicGlossTexture:1,u_OcclusionTexture:1,u_EmissionTexture:1,u_metallic:1,u_smoothness:1,u_smoothnessScale:1,u_occlusionStrength:1,u_normalScale:1,u_parallaxScale:1,u_TilingOffset:1,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,u_PointLightMatrix:4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.SpotAngle":4,"u_SpotLight.Color":4,u_RangeTexture:4,u_ReflectTexture:4,u_ReflectIntensity:4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4,u_FogStart:4,u_FogRange:4,u_FogColor:4},vs='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(v_Texcoord0,u_TilingOffset);\n\t#endif\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',ps='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform float u_ReflectIntensity;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\nuniform sampler2D u_RangeTexture;\n//uniform sampler2D u_AngleTexture;\nuniform mat4 u_PointLightMatrix;\n//uniform mat4 u_SpotLightMatrix;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec2 mg;\n\tvec4 albedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tvec4 abledoTextureColor = texture2D(u_AlbedoTexture, uv0);\n\t\talbedoColor = abledoTextureColor * u_AlbedoColor;\n\t\tmg = MetallicGloss(abledoTextureColor.a, uv0);\n\t#else\n\t\talbedoColor = u_AlbedoColor;\n\t\tmg = MetallicGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(albedoColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tLayaGI gi;\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\n\tgi.specular = ReflectCubeMap(viewDir, normal);\n  \n\tvec4 color = vec4(0.0);\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tcolor += PBRStandardDiectionLight(albedoColor, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRStandardPointLight(albedoColor, mg.r, mg.g, normal, viewDir, u_PointLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef SPOTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRStandardSpotLight(albedoColor, mg.r, mg.g, normal, viewDir, u_SpotLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}',shader=Shader3D.add("PBRStandard"),subShader=new SubShader(attributeMap,uniformMap,SkinnedMeshSprite3D.shaderDefines,PBRStandardMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},uniformMap={u_Bones:0,u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_AlphaTestValue:1,u_AlbedoColor:1,u_SpecularColor:1,u_EmissionColor:1,u_AlbedoTexture:1,u_NormalTexture:1,u_ParallaxTexture:1,u_SpecularTexture:1,u_OcclusionTexture:1,u_EmissionTexture:1,u_smoothness:1,u_smoothnessScale:1,u_occlusionStrength:1,u_normalScale:1,u_parallaxScale:1,u_TilingOffset:1,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,u_PointLightMatrix:4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.SpotAngle":4,"u_SpotLight.Color":4,u_RangeTexture:4,u_ReflectTexture:4,u_ReflectIntensity:4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4,u_FogStart:4,u_FogRange:4,u_FogColor:4},vs='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(v_Texcoord0,u_TilingOffset);\n\t#endif\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',ps='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_AlbedoColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform float u_ReflectIntensity;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\nuniform sampler2D u_RangeTexture;\n//uniform sampler2D u_AngleTexture;\nuniform mat4 u_PointLightMatrix;\n//uniform mat4 u_SpotLightMatrix;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec4 sg;\n\tvec4 albedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tvec4 albedoTextureColor = texture2D(u_AlbedoTexture, uv0);\n\t\talbedoColor = albedoTextureColor * u_AlbedoColor;\n\t\tsg = SpecularGloss(albedoTextureColor.a, uv0);\n\t#else\n\t\talbedoColor = u_AlbedoColor;\n\t\tsg = SpecularGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(albedoColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n\t\n\tLayaGI gi;\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\n\tgi.specular = ReflectCubeMap(viewDir, normal);\n\t\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n\tvec4 color = vec4(0.0);\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tcolor += PBRSpecularDiectionLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_DirectionLight, gi);\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRSpecularPointLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_PointLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef SPOTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRSpecularSpotLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_SpotLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',shader=Shader3D.add("PBRSpecular"),subShader=new SubShader(attributeMap,uniformMap,SkinnedMeshSprite3D.shaderDefines,PBRSpecularMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Color:1,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},uniformMap={u_Bones:0,u_AlbedoTexture:1,u_AlbedoColor:1,u_TilingOffset:1,u_AlphaTestValue:1,u_MvpMatrix:2,u_FogStart:4,u_FogRange:4,u_FogColor:4},vs='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\n\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nattribute vec4 a_Color;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main() {\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(v_Texcoord0,u_TilingOffset);\n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color = a_Color;\n\t#endif\n}',ps="#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n\tvarying vec2 v_Texcoord0;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  u_AlbedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tcolor *= v_Color;\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(color.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n\t\n}\n\n",shader=Shader3D.add("Unlit"),subShader=new SubShader(attributeMap,uniformMap,SkinnedMeshSprite3D.shaderDefines,UnlitMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},uniformMap={u_Bones:0,u_AlbedoTexture:1,u_AlbedoColor:1,u_TilingOffset:1,u_AlphaTestValue:1,u_MvpMatrix:2,u_FogStart:4,u_FogRange:4,u_FogColor:4},vs='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec4 a_Color;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t\n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(v_Texcoord0,u_TilingOffset);\n\t#endif\n\t\t\n\tv_Color = a_Color;\n}',ps="#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  2.0 * u_AlbedoColor;\n\t#ifdef COLOR\n\t\tcolor *= v_Color;\n\t#endif\n\t#ifdef MAINTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n}\n\n",shader=Shader3D.add("Effect"),subShader=new SubShader(attributeMap,uniformMap,SkinnedMeshSprite3D.shaderDefines,EffectMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_CornerTextureCoordinate:0,a_MeshPosition:1,a_MeshColor:2,a_MeshTextureCoordinate:3,a_ShapePositionStartLifeTime:4,a_DirectionTime:5,a_StartColor:6,a_EndColor:7,a_StartSize:8,a_StartRotation0:9,a_StartSpeed:10,a_Random0:11,a_Random1:12,a_SimulationWorldPostion:13,a_SimulationWorldRotation:14},uniformMap={u_Tintcolor:1,u_TilingOffset:1,u_texture:1,u_WorldPosition:2,u_WorldRotation:2,u_PositionScale:2,u_SizeScale:2,u_ScalingMode:2,u_Gravity:2,u_ThreeDStartRotation:2,u_StretchedBillboardLengthScale:2,u_StretchedBillboardSpeedScale:2,u_SimulationSpace:2,u_CurrentTime:2,u_ColorOverLifeGradientAlphas:2,u_ColorOverLifeGradientColors:2,u_MaxColorOverLifeGradientAlphas:2,u_MaxColorOverLifeGradientColors:2,u_VOLVelocityConst:2,u_VOLVelocityGradientX:2,u_VOLVelocityGradientY:2,u_VOLVelocityGradientZ:2,u_VOLVelocityConstMax:2,u_VOLVelocityGradientMaxX:2,u_VOLVelocityGradientMaxY:2,u_VOLVelocityGradientMaxZ:2,u_VOLSpaceType:2,u_SOLSizeGradient:2,u_SOLSizeGradientX:2,u_SOLSizeGradientY:2,u_SOLSizeGradientZ:2,u_SOLSizeGradientMax:2,u_SOLSizeGradientMaxX:2,u_SOLSizeGradientMaxY:2,u_SOLSizeGradientMaxZ:2,u_ROLAngularVelocityConst:2,u_ROLAngularVelocityConstSeprarate:2,u_ROLAngularVelocityGradient:2,u_ROLAngularVelocityGradientX:2,u_ROLAngularVelocityGradientY:2,u_ROLAngularVelocityGradientZ:2,u_ROLAngularVelocityConstMax:2,u_ROLAngularVelocityConstMaxSeprarate:2,u_ROLAngularVelocityGradientMax:2,u_ROLAngularVelocityGradientMaxX:2,u_ROLAngularVelocityGradientMaxY:2,u_ROLAngularVelocityGradientMaxZ:2,u_ROLAngularVelocityGradientMaxW:2,u_TSACycles:2,u_TSASubUVLength:2,u_TSAGradientUVs:2,u_TSAMaxGradientUVs:2,u_CameraPosition:3,u_CameraDirection:3,u_CameraUp:3,u_View:3,u_Projection:3,u_FogStart:4,u_FogRange:4,u_FogColor:4},vs="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n",ps="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",shader=Shader3D.add("PARTICLESHURIKEN"),subShader=new SubShader(attributeMap,uniformMap,ShuriKenParticle3D.shaderDefines,ShurikenParticleMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0},uniformMap={u_TintColor:1,u_Exposure:1,u_Rotation:1,u_CubeTexture:1,u_MvpMatrix:3},vs="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform float u_Rotation;\nvarying vec3 v_Texcoord;\n\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * 3.141593 / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\t\t\nvoid main()\n{\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\n\tgl_Position = (u_MvpMatrix*position).xyww;\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//转换坐标系\n}\n",ps="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec3 v_Texcoord;\n\nuniform samplerCube u_CubeTexture;\nuniform float u_Exposure;\nuniform vec4 u_TintColor;\n\n\nvoid main()\n{\t\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\n\tgl_FragColor=vec4(color,1.0);\n}\n\n",shader=Shader3D.add("SkyBox"),subShader=new SubShader(attributeMap,uniformMap),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0},uniformMap={u_SunSize:1,u_SunSizeConvergence:1,u_AtmosphereThickness:1,u_SkyTint:1,u_GroundTint:1,u_Exposure:1,u_MvpMatrix:3,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4},vs="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include \"Lighting.glsl\";\n\n#define OUTER_RADIUS 1.025\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh为夜空光和极光亮度单位\n#define MIE 0.0010             // Mie constant 米氏散射\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\n\nconst float SKY_GROUND_THRESHOLD = 0.02;\nconst float outerRadius = OUTER_RADIUS;\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\nconst float innerRadius = 1.0;\nconst float innerRadius2 = 1.0;\nconst float cameraHeight = 0.0001;\n\nconst float HDSundiskIntensityFactor = 15.0;\nconst float simpleSundiskIntensityFactor = 27.0;\n\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\nconst float kmESun = MIE * SUN_BRIGHTNESS;\nconst float km4PI = MIE * 4.0 * 3.14159265;\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\nconst float scaleDepth = 0.25;\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\n\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//默认散射波长\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//散射播放的可变范围\n\nattribute vec4 a_Position;\n\nuniform mat4 u_MvpMatrix;\nuniform vec3 u_SkyTint;\nuniform vec3 u_GroundTint;\nuniform float u_Exposure;\nuniform float u_AtmosphereThickness;\nuniform DirectionLight u_DirectionLight;\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Rayleigh phase function\nfloat getRayleighPhase(vec3 light, vec3 ray) \n{\n\tfloat eyeCos = dot(light, ray);\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\n}\n\nfloat scaleAngle(float inCos)\n{\n\tfloat x = 1.0 - inCos;\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\n\nvoid main () {\n\tgl_Position = (u_MvpMatrix*a_Position).xyww;\n\n\tvec3 skyTintInGammaSpace = u_SkyTint;//支持非GAMMA空间后要调整\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\n\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\n\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\n\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n\tvec3 eyeRay = normalize(a_Position.xyz);\n\n\tfloat far = 0.0;\n\tvec3 cIn, cOut;\n\tif (eyeRay.y >= 0.0) {// Sky\n\t\t// Calculate the length of the \"atmosphere\"\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat height = innerRadius + cameraHeight;\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\tvec3 frontColor = vec3(0.0);\n\t\t//unrolling this manually to avoid some platform for loop slow\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\n\t\tcIn = frontColor * (invWavelength * krESun);\n\t\tcOut = frontColor * kmESun;\n\t} else {// Ground\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\n\t\tvec3 pos = cameraPos + far * eyeRay;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\n\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, pos);\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\n\t\tfloat lightScale = scaleAngle(lightAngle);\n\t\tfloat cameraOffset = depth*cameraScale;\n\t\tfloat temp = lightScale + cameraScale;\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\t// Now loop through the sample rays\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\n\t\tvec3 attenuate;\n\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat scatter = depth*temp - cameraOffset;\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\n\t}\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tv_Vertex = -a_Position.xyz;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_RayDir = -eyeRay;\n\t#else\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\n\t#endif\n\n\t// if we want to calculate color in vprog:\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_DirectionLight.Direction, -eyeRay));\n\n\t\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\n\tfloat lightColorIntensity = clamp(length(u_DirectionLight.Color), 0.25, 1.0);\n\n\t#ifdef SUN_HIGH_QUALITY \n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_DirectionLight.Color / lightColorIntensity;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_DirectionLight.Color / lightColorIntensity;\n\t#endif\n}\n",ps='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nconst float MIE_G = -0.990;\nconst float MIE_G2 = 0.9801;\nconst float SKY_GROUND_THRESHOLD = 0.02;\n\nuniform float u_SunSize;\nuniform float u_SunSizeConvergence;\nuniform DirectionLight u_DirectionLight;\n\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Mie phase function\nfloat getMiePhase(float eyeCos, float eyeCos2) {\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\n\treturn temp;\n}\n\n// Calculates the sun shape\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\n\t#ifdef SUN_HIGH_QUALITY\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\n\t#else //SUN_SIMPLE\n\t\tvec3 delta = lightPos - ray;\n\t\tfloat dist = length(delta);\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\n\t\treturn spot * spot;\n\t#endif\n}\n\nvoid main() {\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\n\t// if y < 0 [eyeRay.y > 0] - sky\n\tvec3 col = vec3(0.0, 0.0, 0.0);\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tvec3 ray = normalize(v_Vertex);\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\n\t#elif defined(SUN_SIMPLE) \n\t\tvec3 ray = v_RayDir;\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\n\t#else\n\t\tfloat y = v_SkyGroundFactor;\n\t#endif\n\n\t// if we did precalculate color in vprog: just do lerp between them\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\n\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\t\tif (y < 0.0)\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_DirectionLight.Direction, -ray);\n\t#endif\n\n\tcol = sqrt(col);//linear space convert to gamma space\n\tgl_FragColor=vec4(col,1.0);\n}\n\n',shader=Shader3D.add("SkyBoxProcedural"),subShader=new SubShader(attributeMap,uniformMap,null,SkyProceduralMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Normal:3,a_Texcoord0:2},uniformMap={u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_LightmapScaleOffset:2,u_LightMap:2,u_SplatAlphaTexture:1,u_DiffuseTexture1:1,u_DiffuseTexture2:1,u_DiffuseTexture3:1,u_DiffuseTexture4:1,u_DiffuseTexture5:1,u_DiffuseScaleOffset1:1,u_DiffuseScaleOffset2:1,u_DiffuseScaleOffset3:1,u_DiffuseScaleOffset4:1,u_DiffuseScaleOffset5:1,u_FogStart:4,u_FogRange:4,u_FogColor:4,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Attenuation":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.Spot":4,"u_SpotLight.Color":4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4},vs="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",ps='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\nuniform vec3 u_AmbientColor;\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\tvec4 splatAlpha = vec4(1.0);\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 dif, spe;\n#endif\n\nvec3 diffuse = vec3(0.0);\nvec3 specular= vec3(0.0);\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tLayaAirBlinnPhongDiectionLight(vec3(0.0), 1.0, normal, vec3(1.0), toEye,u_DirectionLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tLayaAirBlinnPhongPointLight(v_PositionWorld, vec3(0.0), 1.0, normal, vec3(1.0), toEye, u_PointLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tLayaAirBlinnPhongSpotLight(v_PositionWorld, vec3(0.0), 1.0, normal, vec3(1.0), toEye, u_SpotLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n\nvec3 globalDiffuse = u_AmbientColor;\n#ifdef LIGHTMAP\n\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\n#else\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor.rgb += specular * shadowValue;\n\t#else\n\t\tgl_FragColor.rgb += specular;\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n',shader=Shader3D.add("ExtendTerrain"),subShader=new SubShader(attributeMap,uniformMap,RenderableSprite3D.shaderDefines,ExtendTerrainMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_OffsetVector:1,a_Texcoord0X:4,a_Texcoord0Y:3,a_BirthTime:2},uniformMap={u_MvpMatrix:2,u_View:3,u_Projection:3,u_TilingOffset:1,u_MainTexture:1,u_MainColor:1,u_CurTime:2,u_LifeTime:2,u_WidthCurve:2,u_WidthCurveKeyLength:2,u_GradientColorkey:2,u_GradientAlphakey:2},vs="attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tfloat width;\n\tif(normalizeTime == 0.0){\n\t\twidth=u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\n\t\t\t\twidth=u_WidthCurve[i].w;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn width;\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.x;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.x;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].yzw, gradientColor.yzw, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.x;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.x;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.y, gradientAlpha.y, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\n\t#else\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t#endif\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#endif\n\t\n\tgl_Position = u_Projection * u_View * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n}\n",ps="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\t\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef MAINTEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n",shader=Shader3D.add("Trail"),subShader=new SubShader(attributeMap,uniformMap,TrailSprite3D.shaderDefines,TrailMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps),attributeMap={a_Position:0,a_Normal:3,a_Tangent0:5},uniformMap={u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_Time:4,u_MainTexture:1,u_NormalTexture:1,u_HorizonColor:1,u_WaveScale:1,u_WaveSpeed:1},vs="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\nuniform float u_WaveScale;\nuniform vec4 u_WaveSpeed;\nuniform float u_Time;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nvoid main()\n{\n\tvec4 positionWorld = u_WorldMat * a_Position;\n\tvec4 position = u_MvpMatrix * a_Position;\n\t\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\n\t\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\n\tv_Texcoord1 = temp.wz;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n\t\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\n\tgl_Position = position;\n}",ps='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n#endif\n\nuniform vec4 u_HorizonColor;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#include "Lighting.glsl"\n\nvoid main()\n{\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\n\t\n\tvec3 normal1 = NormalSampleToWorldSpace1(bumpColor1, v_Tangent, v_Binormal, v_Normal);\n\tvec3 normal2 = NormalSampleToWorldSpace1(bumpColor2, v_Tangent, v_Binormal, v_Normal);\n\t\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\n\tvec3 viewDir = normalize(v_ViewDir);\n\tfloat fresnel = dot(viewDir, normal);\n\t\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\n\t\n\tvec4 color;\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\n\tcolor.a = u_HorizonColor.a;\n\t\n\tgl_FragColor = color;\n}\n\n',shader=Shader3D.add("WaterPrimary"),subShader=new SubShader(attributeMap,uniformMap,null,WaterPrimaryMaterial.shaderDefines),shader.addSubShader(subShader),subShader.addShaderPass(vs,ps)},ShaderInit3D._rangeAttenTex=null,ShaderInit3D}(),BaseRender=function(_super){function BaseRender(owner){if(this._indexInList=-1,this._indexInCastShadowList=-1,this._visible=!0,this._isPartOfStaticBatch=!1,this._staticBatch=null,BaseRender.__super.call(this),this._id=++BaseRender._uniqueIDCounter,this._indexInCastShadowList=-1,this._boundingBox=new BoundBox(new Vector3,new Vector3),this._boundingBoxCenter=new Vector3,this._boundingSphere=new BoundSphere(new Vector3,0),Render.isConchApp){var length=FrustumCulling._cullingBufferLength;this._cullingBufferIndex=length;var cullingBuffer=FrustumCulling._cullingBuffer,resizeLength=length+5;if(resizeLength>=cullingBuffer.length){var temp=cullingBuffer;(cullingBuffer=FrustumCulling._cullingBuffer=new Float32Array(cullingBuffer.length+4096)).set(temp,0)}cullingBuffer[length]=1,FrustumCulling._cullingBufferLength=resizeLength}this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._owner=owner,this._enable=!0,this._materialsInstance=[],this._shaderValues=new ShaderData(null),this._defineDatas=new DefineDatas,this.lightmapIndex=-1,this._castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,owner&&this._owner.transform.on("transformchanged",this,this._onWorldMatNeedChange)}__class(BaseRender,"laya.d3.core.render.BaseRender",EventDispatcher);var __proto=BaseRender.prototype;return Laya.imps(__proto,{"laya.resource.ISingletonElement":!0}),__proto._changeMaterialReference=function(lastValue,value){lastValue&&lastValue._removeReference(),value._addReference()},__proto._getInstanceMaterial=function(material,index){var insMat=new material.constructor;return material.cloneTo(insMat),insMat.name=insMat.name+"(Instance)",this._materialsInstance[index]=!0,this._changeMaterialReference(this._materials[index],insMat),this._materials[index]=insMat,insMat},__proto._applyLightMapParams=function(){if(this._scene&&this._lightmapIndex>=0){var lightMaps=this._scene.getlightmaps();this._lightmapIndex<lightMaps.length?(this._defineDatas.add(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),this._shaderValues.setTexture(RenderableSprite3D.LIGHTMAP,lightMaps[this._lightmapIndex])):this._defineDatas.remove(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)}else this._defineDatas.remove(RenderableSprite3D.SAHDERDEFINE_LIGHTMAP)},__proto._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},__proto._renderRenderableBoundBox=function(){},__proto._calculateBoundingSphere=function(){throw"BaseRender: must override it."},__proto._calculateBoundingBox=function(){throw"BaseRender: must override it."},__proto._getIndexInList=function(){return this._indexInList},__proto._setIndexInList=function(index){this._indexInList=index},__proto._setBelongScene=function(scene){this._scene!==scene&&(this._scene=scene,this._applyLightMapParams())},__proto._needRender=function(boundFrustum){return!0},__proto._renderUpdate=function(context,transform){},__proto._renderUpdateWithCamera=function(context,transform){},__proto._updateOctreeNode=function(){var treeNode=this._treeNode;treeNode&&this._octreeNodeNeedChange&&(treeNode.updateObject(this),this._octreeNodeNeedChange=!1)},__proto._destroy=function(){this.offAll();var i=0,n=0;for(i=0,n=this._renderElements.length;i<n;i++)this._renderElements[i].destroy();for(i=0,n=this._materials.length;i<n;i++)this._materials[i].destroyed||this._materials[i]._removeReference();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null},__getset(0,__proto,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),__getset(0,__proto,"id",function(){return this._id}),__getset(0,__proto,"material",function(){var material=this._materials[0];if(material&&!this._materialsInstance[0]){var insMat=this._getInstanceMaterial(material,0),renderElement=this._renderElements[0];renderElement&&(renderElement.material=insMat)}return this._materials[0]},function(value){this.sharedMaterial=value}),__getset(0,__proto,"isPartOfStaticBatch",function(){return this._isPartOfStaticBatch}),__getset(0,__proto,"sharedMaterial",function(){return this._materials[0]},function(value){var lastValue=this._materials[0];if(lastValue!==value){this._materials[0]=value,this._materialsInstance[0]=!1,this._changeMaterialReference(lastValue,value);var renderElement=this._renderElements[0];renderElement&&(renderElement.material=value)}}),__getset(0,__proto,"lightmapIndex",function(){return this._lightmapIndex},function(value){this._lightmapIndex!==value&&(this._lightmapIndex=value,this._applyLightMapParams())}),__getset(0,__proto,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(value){this._lightmapScaleOffset=value,this._shaderValues.setVector(RenderableSprite3D.LIGHTMAPSCALEOFFSET,value),this._defineDatas.add(RenderableSprite3D.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),__getset(0,__proto,"castShadow",function(){return this._castShadow},function(value){this._castShadow!==value&&(this._owner.activeInHierarchy&&(value?this._scene._addShadowCastRenderObject(this):this._scene._removeShadowCastRenderObject(this)),this._castShadow=value)}),__getset(0,__proto,"enable",function(){return this._enable},function(value){this._enable=!!value}),__getset(0,__proto,"materials",function(){for(var i=0,n=this._materials.length;i<n;i++)if(!this._materialsInstance[i]){var insMat=this._getInstanceMaterial(this._materials[i],i),renderElement=this._renderElements[i];renderElement&&(renderElement.material=insMat)}return this._materials.slice()},function(value){this.sharedMaterials=value}),__getset(0,__proto,"sharedMaterials",function(){return this._materials.slice()},function(value){if(!value)throw new Error("BaseRender: shadredMaterials value can't be null.");var len=value.length;this._materialsInstance.length=len;for(var i=0;i<len;i++){var lastValue=this._materials[i];if(lastValue!==value[i]){this._materialsInstance[i]=!1,this._changeMaterialReference(lastValue,value[i]);var renderElement=this._renderElements[i];renderElement&&(renderElement.material=value[i])}}this._materials=value}),__getset(0,__proto,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),__getset(0,__proto,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var boundBox=this.boundingBox;Vector3.add(boundBox.min,boundBox.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),__getset(0,__proto,"receiveShadow",function(){return this._receiveShadow},function(value){this._receiveShadow!==value&&(this._receiveShadow=value,value?this._defineDatas.add(RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW):this._defineDatas.remove(RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW))}),BaseRender._uniqueIDCounter=0,__static(BaseRender,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3,new Vector3]},"_greenColor",function(){return this._greenColor=new Vector4(0,1,0,1)}]),BaseRender}(),Transform3D=function(_super){function Transform3D(owner){this._owner=null,this._children=null,this._parent=null,this._dummy=null,this._transformFlag=0,this.pivot=null,Transform3D.__super.call(this),this._localPosition=new Vector3(0,0,0),this._localRotation=new Quaternion(0,0,0,1),this._localScale=new Vector3(1,1,1),this._localRotationEuler=new Vector3(0,0,0),this._localMatrix=new Matrix4x4,this._position=new Vector3(0,0,0),this._rotation=new Quaternion(0,0,0,1),this._scale=new Vector3(1,1,1),this._rotationEuler=new Vector3(0,0,0),this._worldMatrix=new Matrix4x4,this._forward=new Vector3,this._up=new Vector3,this._right=new Vector3,this._owner=owner,this._children=[],this._setTransformFlag(7,!1),this._setTransformFlag(248,!0)}__class(Transform3D,"laya.d3.core.Transform3D",EventDispatcher);var __proto=Transform3D.prototype;return __proto._setTransformFlag=function(type,value){value?this._transformFlag|=type:this._transformFlag&=~type},__proto._getTransformFlag=function(type){return 0!=(this._transformFlag&type)},__proto._setParent=function(value){if(this._parent!==value){if(this._parent){var parentChilds=this._parent._children,index=parentChilds.indexOf(this);parentChilds.splice(index,1)}value&&(value._children.push(this),value&&this._onWorldTransform()),this._parent=value}},__proto._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)Matrix4x4.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var scalePivot=Transform3D._tempVector30;Vector3.multiply(this.pivot,this._localScale,scalePivot);var scaleOffsetPosition=Transform3D._tempVector31;Vector3.subtract(scalePivot,this.pivot,scaleOffsetPosition);var rotationOffsetPosition=Transform3D._tempVector32,localRot=this.localRotation;Vector3.transformQuat(scalePivot,localRot,rotationOffsetPosition),Vector3.subtract(rotationOffsetPosition,scalePivot,rotationOffsetPosition);var resultLocalPosition=Transform3D._tempVector33;Vector3.subtract(this._localPosition,scaleOffsetPosition,resultLocalPosition),Vector3.subtract(resultLocalPosition,rotationOffsetPosition,resultLocalPosition),Matrix4x4.createAffineTransformation(resultLocalPosition,localRot,this._localScale,this._localMatrix)}},__proto._onWorldPositionRotationTransform=function(){if(!(this._getTransformFlag(64)&&this._getTransformFlag(8)&&this._getTransformFlag(16)&&this._getTransformFlag(128))){this._setTransformFlag(216,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldPositionRotationTransform()}},__proto._onWorldPositionScaleTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(8)||!this._getTransformFlag(32)){this._setTransformFlag(104,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldPositionScaleTransform()}},__proto._onWorldPositionTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(8)){this._setTransformFlag(72,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldPositionTransform()}},__proto._onWorldRotationTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(16)||!this._getTransformFlag(128)){this._setTransformFlag(208,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldPositionRotationTransform()}},__proto._onWorldScaleTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(32)){this._setTransformFlag(96,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldPositionScaleTransform()}},__proto._onWorldTransform=function(){if(!(this._getTransformFlag(64)&&this._getTransformFlag(8)&&this._getTransformFlag(16)&&this._getTransformFlag(128)&&this._getTransformFlag(32))){this._setTransformFlag(248,!0),this.event("transformchanged",this._transformFlag);for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldTransform()}},__proto.translate=function(translation,isLocal){void 0===isLocal&&(isLocal=!0),isLocal?(Matrix4x4.createFromQuaternion(this.localRotation,Transform3D._tempMatrix0),Vector3.transformCoordinate(translation,Transform3D._tempMatrix0,Transform3D._tempVector30),Vector3.add(this.localPosition,Transform3D._tempVector30,this._localPosition),this.localPosition=this._localPosition):(Vector3.add(this.position,translation,this._position),this.position=this._position)},__proto.rotate=function(rotation,isLocal,isRadian){var rot;void 0===isLocal&&(isLocal=!0),void 0===isRadian&&(isRadian=!0),isRadian?rot=rotation:(Vector3.scale(rotation,Math.PI/180,Transform3D._tempVector30),rot=Transform3D._tempVector30),Quaternion.createFromYawPitchRoll(rot.y,rot.x,rot.z,Transform3D._tempQuaternion0),isLocal?(Quaternion.multiply(this._localRotation,Transform3D._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Quaternion.multiply(Transform3D._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},__proto.lookAt=function(target,up,isLocal){void 0===isLocal&&(isLocal=!1);var eyeE,targetE=target.elements;if(isLocal){if(eyeE=this._localPosition.elements,Math.abs(eyeE[0]-targetE[0])<MathUtils3D.zeroTolerance&&Math.abs(eyeE[1]-targetE[1])<MathUtils3D.zeroTolerance&&Math.abs(eyeE[2]-targetE[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(this._localPosition,target,up,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var worldPosition=this.position;if(eyeE=worldPosition.elements,Math.abs(eyeE[0]-targetE[0])<MathUtils3D.zeroTolerance&&Math.abs(eyeE[1]-targetE[1])<MathUtils3D.zeroTolerance&&Math.abs(eyeE[2]-targetE[2])<MathUtils3D.zeroTolerance)return;Quaternion.lookAt(worldPosition,target,up,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},__getset(0,__proto,"_isFrontFaceInvert",function(){var scale=this.scale,isInvert=scale.x<0;return scale.y<0&&(isInvert=!isInvert),scale.z<0&&(isInvert=!isInvert),isInvert}),__getset(0,__proto,"owner",function(){return this._owner}),__getset(0,__proto,"localPositionY",function(){return this._localPosition.elements[1]},function(y){this._localPosition.elements[1]=y,this.localPosition=this._localPosition}),__getset(0,__proto,"localScaleX",function(){return this._localScale.elements[0]},function(value){this._localScale.elements[0]=value,this.localScale=this._localScale}),__getset(0,__proto,"worldNeedUpdate",function(){return this._getTransformFlag(64)}),__getset(0,__proto,"localPositionX",function(){return this._localPosition.elements[0]},function(x){this._localPosition.elements[0]=x,this.localPosition=this._localPosition}),__getset(0,__proto,"localPosition",function(){return this._localPosition},function(value){this._localPosition!==value&&value.cloneTo(this._localPosition),this._setTransformFlag(4,!0),this._onWorldPositionTransform()}),__getset(0,__proto,"localPositionZ",function(){return this._localPosition.elements[2]},function(z){this._localPosition.elements[2]=z,this.localPosition=this._localPosition}),__getset(0,__proto,"localRotationX",function(){return this.localRotation.elements[0]},function(x){this._localRotation.elements[0]=x,this.localRotation=this._localRotation}),__getset(0,__proto,"localRotationY",function(){return this.localRotation.elements[1]},function(y){this._localRotation.elements[1]=y,this.localRotation=this._localRotation}),__getset(0,__proto,"localRotationZ",function(){return this.localRotation.elements[2]},function(z){this._localRotation.elements[2]=z,this.localRotation=this._localRotation}),__getset(0,__proto,"localRotationW",function(){return this.localRotation.elements[3]},function(w){this._localRotation.elements[3]=w,this.localRotation=this._localRotation}),__getset(0,__proto,"localRotation",function(){if(this._getTransformFlag(1)){var eulerE=this._localRotationEuler.elements;Quaternion.createFromYawPitchRoll(eulerE[1]/Transform3D._angleToRandin,eulerE[0]/Transform3D._angleToRandin,eulerE[2]/Transform3D._angleToRandin,this._localRotation),this._setTransformFlag(1,!1)}return this._localRotation},function(value){this._localRotation!==value&&value.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(6,!0),this._setTransformFlag(1,!1),!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,__proto,"localScaleY",function(){return this._localScale.elements[1]},function(value){this._localScale.elements[1]=value,this.localScale=this._localScale}),__getset(0,__proto,"localScaleZ",function(){return this._localScale.elements[2]},function(value){this._localScale.elements[2]=value,this.localScale=this._localScale}),__getset(0,__proto,"position",function(){if(this._getTransformFlag(8)){if(null!=this._parent){var parentPosition=this._parent.position;Vector3.multiply(this._localPosition,this._parent.scale,Transform3D._tempVector30),Vector3.transformQuat(Transform3D._tempVector30,this._parent.rotation,Transform3D._tempVector30),Vector3.add(parentPosition,Transform3D._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._setTransformFlag(8,!1)}return this._position},function(value){if(null!=this._parent){Vector3.subtract(value,this._parent.position,this._localPosition);var parentScaleE=this._parent.scale.elements,psX=parentScaleE[0],psY=parentScaleE[1],psZ=parentScaleE[2];if(1!==psX||1!==psY||1!==psZ){var invertScale=Transform3D._tempVector30,invertScaleE=invertScale.elements;invertScaleE[0]=1/psX,invertScaleE[1]=1/psY,invertScaleE[2]=1/psZ,Vector3.multiply(this._localPosition,invertScale,this._localPosition)}this._parent.rotation.invert(Transform3D._tempQuaternion0),Vector3.transformQuat(this._localPosition,Transform3D._tempQuaternion0,this._localPosition)}else value.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==value&&value.cloneTo(this._position),this._setTransformFlag(8,!1)}),__getset(0,__proto,"localRotationEulerY",function(){return this.localRotationEuler.elements[1]},function(value){this._localRotationEuler.elements[1]=value,this.localRotationEuler=this._localRotationEuler}),__getset(0,__proto,"localScale",function(){return this._localScale},function(value){this._localScale!==value&&value.cloneTo(this._localScale),this._setTransformFlag(4,!0),!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),__getset(0,__proto,"localRotationEulerX",function(){return this.localRotationEuler.elements[0]},function(value){this._localRotationEuler.elements[0]=value,this.localRotationEuler=this._localRotationEuler}),__getset(0,__proto,"localRotationEulerZ",function(){return this.localRotationEuler.elements[2]},function(value){this._localRotationEuler.elements[2]=value,this.localRotationEuler=this._localRotationEuler}),__getset(0,__proto,"localRotationEuler",function(){if(this._getTransformFlag(2)){this._localRotation.getYawPitchRoll(Transform3D._tempVector30);var eulerE=Transform3D._tempVector30.elements,localRotationEulerE=this._localRotationEuler.elements;localRotationEulerE[0]=eulerE[1]*Transform3D._angleToRandin,localRotationEulerE[1]=eulerE[0]*Transform3D._angleToRandin,localRotationEulerE[2]=eulerE[2]*Transform3D._angleToRandin,this._setTransformFlag(2,!1)}return this._localRotationEuler},function(value){this._localRotationEuler!==value&&value.cloneTo(this._localRotationEuler),this._setTransformFlag(2,!1),this._setTransformFlag(5,!0),!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),__getset(0,__proto,"localMatrix",function(){return this._getTransformFlag(4)&&(this._updateLocalMatrix(),this._setTransformFlag(4,!1)),this._localMatrix},function(value){this._localMatrix!==value&&value.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(4,!1),this._onWorldTransform()}),__getset(0,__proto,"rotation",function(){return this._getTransformFlag(16)&&(null!=this._parent?Quaternion.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(16,!1)),this._rotation},function(value){null!=this._parent?(this._parent.rotation.invert(Transform3D._tempQuaternion0),Quaternion.multiply(Transform3D._tempQuaternion0,value,this._localRotation)):value.cloneTo(this._localRotation),this.localRotation=this._localRotation,value!==this._rotation&&value.cloneTo(this._rotation),this._setTransformFlag(16,!1)}),__getset(0,__proto,"scale",function(){return this._getTransformFlag(32)?(null!==this._parent?Vector3.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._setTransformFlag(32,!1),this._scale):this._scale},function(value){if(null!==this._parent){var pScaleE=this._parent.scale.elements,invPScaleE=Transform3D._tempVector30.elements;invPScaleE[0]=1/pScaleE[0],invPScaleE[1]=1/pScaleE[1],invPScaleE[2]=1/pScaleE[2],Vector3.multiply(value,Transform3D._tempVector30,this._localScale)}else value.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==value&&value.cloneTo(this._scale),this._setTransformFlag(32,!1)}),__getset(0,__proto,"rotationEuler",function(){if(this._getTransformFlag(128)){this.rotation.getYawPitchRoll(Transform3D._tempVector30);var eulerE=Transform3D._tempVector30.elements,rotationEulerE=this._rotationEuler.elements;rotationEulerE[0]=eulerE[1]*Transform3D._angleToRandin,rotationEulerE[1]=eulerE[0]*Transform3D._angleToRandin,rotationEulerE[2]=eulerE[2]*Transform3D._angleToRandin,this._setTransformFlag(128,!1)}return this._rotationEuler},function(value){Quaternion.createFromYawPitchRoll(value.y/Transform3D._angleToRandin,value.x/Transform3D._angleToRandin,value.z/Transform3D._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==value&&value.cloneTo(this._rotationEuler),this._setTransformFlag(128,!1)}),__getset(0,__proto,"worldMatrix",function(){return this._getTransformFlag(64)&&(null!=this._parent?Matrix4x4.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(64,!1)),this._worldMatrix},function(value){null===this._parent?value.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),Matrix4x4.multiply(this._localMatrix,value,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==value&&value.cloneTo(this._worldMatrix),this._setTransformFlag(64,!1)}),__getset(0,__proto,"forward",function(){var worldMatElem=this.worldMatrix.elements;return this._forward.elements[0]=-worldMatElem[8],this._forward.elements[1]=-worldMatElem[9],this._forward.elements[2]=-worldMatElem[10],this._forward}),__getset(0,__proto,"up",function(){var worldMatElem=this.worldMatrix.elements;return this._up.elements[0]=worldMatElem[4],this._up.elements[1]=worldMatElem[5],this._up.elements[2]=worldMatElem[6],this._up}),__getset(0,__proto,"right",function(){var worldMatElem=this.worldMatrix.elements;return this._right.elements[0]=worldMatElem[0],this._right.elements[1]=worldMatElem[1],this._right.elements[2]=worldMatElem[2],this._right}),Transform3D.TRANSFORM_LOCALQUATERNION=1,Transform3D.TRANSFORM_LOCALEULER=2,Transform3D.TRANSFORM_LOCALMATRIX=4,Transform3D.TRANSFORM_WORLDPOSITION=8,Transform3D.TRANSFORM_WORLDQUATERNION=16,Transform3D.TRANSFORM_WORLDSCALE=32,Transform3D.TRANSFORM_WORLDMATRIX=64,Transform3D.TRANSFORM_WORLDEULER=128,__static(Transform3D,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),Transform3D}(),AnimationTransform3D=function(_super){function AnimationTransform3D(owner,localPosition,localRotation,localScale,worldMatrix){AnimationTransform3D.__super.call(this),this._owner=owner,this._children=[],this._localMatrix=new Float32Array(16),Render.isConchApp?(this._localPosition=new Vector3(0,0,0,localPosition),this._localRotation=new Quaternion(0,0,0,1,localRotation),this._localScale=new Vector3(0,0,0,localScale),this._worldMatrix=worldMatrix):(this._localPosition=new Vector3,this._localRotation=new Quaternion,this._localScale=new Vector3,this._worldMatrix=new Float32Array(16)),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}__class(AnimationTransform3D,"laya.d3.animation.AnimationTransform3D",EventDispatcher);var __proto=AnimationTransform3D.prototype;return __proto._getlocalMatrix=function(){return this._localUpdate&&(Utils3D._createAffineTransformationArray(this._localPosition.elements,this._localRotation.elements,this._localScale.elements,this._localMatrix),this._localUpdate=!1),this._localMatrix},__proto._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0;for(var i=0,n=this._children.length;i<n;i++)this._children[i]._onWorldTransform()}},__proto.getWorldMatrix=function(){if(!Render.isConchApp&&this._worldUpdate){if(null!=this._parent)Utils3D.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else for(var locMat=this._getlocalMatrix(),i=0;i<16;++i)this._worldMatrix[i]=locMat[i];this._worldUpdate=!1}return this._worldMatrix},__proto.setParent=function(value){if(this._parent!==value){if(this._parent){var parentChilds=this._parent._children,index=parentChilds.indexOf(this);parentChilds.splice(index,1)}value&&(value._children.push(this),value&&this._onWorldTransform()),this._parent=value}},__getset(0,__proto,"localPosition",function(){return this._localPosition},function(value){this._localPosition=value,this._localUpdate=!0,this._onWorldTransform()}),__getset(0,__proto,"localRotation",function(){if(this._localQuaternionUpdate){var eulerE=this._localRotationEuler.elements;Quaternion.createFromYawPitchRoll(eulerE[1]/AnimationTransform3D._angleToRandin,eulerE[0]/AnimationTransform3D._angleToRandin,eulerE[2]/AnimationTransform3D._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},function(value){this._localRotation=value,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform()}),__getset(0,__proto,"localScale",function(){return this._localScale},function(value){this._localScale=value,this._localUpdate=!0,this._onWorldTransform()}),__getset(0,__proto,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(AnimationTransform3D._tempVector3);var eulerE=AnimationTransform3D._tempVector3.elements,localRotationEulerE=this._localRotationEuler.elements;localRotationEulerE[0]=eulerE[1]*AnimationTransform3D._angleToRandin,localRotationEulerE[1]=eulerE[0]*AnimationTransform3D._angleToRandin,localRotationEulerE[2]=eulerE[2]*AnimationTransform3D._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},function(value){this._localRotationEuler=value,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform()}),__static(AnimationTransform3D,["_tempVector3",function(){return this._tempVector3=new Vector3},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),AnimationTransform3D}(),PhysicsComponent=(function(_super){function Script3D(){Script3D.__super.call(this)}__class(Script3D,"laya.d3.component.Script3D",Component);var __proto=Script3D.prototype;__proto._checkProcessTriggers=function(){var prototype=laya.d3.component.Script3D.prototype;return this.onTriggerEnter!==prototype.onTriggerEnter||(this.onTriggerStay!==prototype.onTriggerStay||this.onTriggerExit!==prototype.onTriggerExit)},__proto._checkProcessCollisions=function(){var prototype=laya.d3.component.Script3D.prototype;return this.onCollisionEnter!==prototype.onCollisionEnter||(this.onCollisionStay!==prototype.onCollisionStay||this.onCollisionExit!==prototype.onCollisionExit)},__proto._onAwake=function(){this.onAwake(),this.onStart!==laya.d3.component.Script3D.prototype.onStart&&Laya.startTimer.callLater(this,this.onStart)},__proto._onEnable=function(){this.owner._scene._scriptPool.add(this);var proto=laya.d3.component.Script3D.prototype;this.onKeyDown!==proto.onKeyDown&&Laya.stage.on("keydown",this,this.onKeyDown),this.onKeyPress!==proto.onKeyPress&&Laya.stage.on("keypress",this,this.onKeyUp),this.onKeyUp!==proto.onKeyUp&&Laya.stage.on("keyup",this,this.onKeyUp)},__proto._onDisable=function(){this.owner._scene._scriptPool.remove(this),this.owner.offAllCaller(this),Laya.stage.offAllCaller(this)},__proto._isScript=function(){return!0},__proto._onAdded=function(){var sprite=this.owner,scripts=sprite._scripts;scripts||(sprite._scripts=scripts=[]),scripts.push(this),sprite._needProcessCollisions||(sprite._needProcessCollisions=this._checkProcessCollisions()),sprite._needProcessTriggers||(sprite._needProcessTriggers=this._checkProcessTriggers())},__proto._onDestroy=function(){var scripts=this.owner._scripts;scripts.splice(scripts.indexOf(this),1);var sprite=this.owner;sprite._needProcessTriggers=!1;for(var i=0,n=scripts.length;i<n;i++)if(scripts[i]._checkProcessTriggers()){sprite._needProcessTriggers=!0;break}for(sprite._needProcessCollisions=!1,i=0,n=scripts.length;i<n;i++)if(scripts[i]._checkProcessCollisions()){sprite._needProcessCollisions=!0;break}this.onDestroy()},__proto.onAwake=function(){},__proto.onEnable=function(){},__proto.onStart=function(){},__proto.onTriggerEnter=function(other){},__proto.onTriggerStay=function(other){},__proto.onTriggerExit=function(other){},__proto.onCollisionEnter=function(collision){},__proto.onCollisionStay=function(collision){},__proto.onCollisionExit=function(collision){},__proto.onMouseDown=function(){},__proto.onMouseDrag=function(){},__proto.onMouseClick=function(){},__proto.onMouseUp=function(){},__proto.onMouseEnter=function(){},__proto.onMouseOver=function(){},__proto.onMouseOut=function(){},__proto.onKeyDown=function(e){},__proto.onKeyPress=function(e){},__proto.onKeyUp=function(e){},__proto.onUpdate=function(){},__proto.onLateUpdate=function(){},__proto.onPreRender=function(){},__proto.onPostRender=function(){},__proto.onDisable=function(){},__proto.onDestroy=function(){},__getset(0,__proto,"isSingleton",function(){return!1})}(),function(_super){function PhysicsComponent(collisionGroup,canCollideWith){this._restitution=0,this._friction=.5,this._rollingFriction=0,this._ccdMotionThreshold=0,this._ccdSweptSphereRadius=0,this._colliderShape=null,this._transformFlag=2147483647,this._enableProcessCollisions=!0,this._inPhysicUpdateListIndex=-1,this.canScaleShape=!0,PhysicsComponent.__super.call(this),this._collisionGroup=1,this._canCollideWith=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER,this._collisionGroup=collisionGroup,this._canCollideWith=canCollideWith,PhysicsComponent._physicObjectsMap[this.id]=this}__class(PhysicsComponent,"laya.d3.physics.PhysicsComponent",_super);var __proto=PhysicsComponent.prototype;return __proto._isValid=function(){return this._simulation&&this._colliderShape&&this._enabled},__proto._parse=function(data){null!=data.collisionGroup&&(this.collisionGroup=data.collisionGroup),null!=data.canCollideWith&&(this.canCollideWith=data.canCollideWith),null!=data.ccdMotionThreshold&&(this.ccdMotionThreshold=data.ccdMotionThreshold),null!=data.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=data.ccdSweptSphereRadius)},__proto._parseShape=function(shapesData){var shapeCount=shapesData.length;if(1===shapeCount){var shape=ColliderShape._creatShape(shapesData[0]);this.colliderShape=shape}else{for(var compoundShape=new CompoundColliderShape,i=0;i<shapeCount;i++)shape=ColliderShape._creatShape(shapesData[i]),compoundShape.addChildShape(shape);this.colliderShape=compoundShape}},__proto._onScaleChange=function(scale){this._colliderShape._setScale(scale)},__proto._setTransformFlag=function(type,value){value?this._transformFlag|=type:this._transformFlag&=~type},__proto._getTransformFlag=function(type){return 0!=(this._transformFlag&type)},__proto._addToSimulation=function(){},__proto._removeFromSimulation=function(){},__proto._derivePhysicsTransformation=function(force){null!=this._nativeColliderObject?this._innerDerivePhysicsTransformation(this._nativeColliderObject.getWorldTransform(),force):console.warn("_derivePhysicsTransformation#_nativeColliderObject is null")},__proto._innerDerivePhysicsTransformation=function(physicTransformOut,force){var transform=this.owner._transform,rotationE=transform.rotation.elements;if(force||this._getTransformFlag(8)){var shapeOffset=this._colliderShape.localOffset,shapeOffsetE=shapeOffset.elements,position=transform.position,positionE=position.elements,nativePosition=PhysicsComponent._nativeVector30;if(0!==shapeOffsetE[0]||0!==shapeOffsetE[1]||0!==shapeOffsetE[2]){var physicPosition=PhysicsComponent._tempVector30,physicPositionE=physicPosition.elements;PhysicsComponent.physicVector3TransformQuat(shapeOffset,rotationE[0],rotationE[1],rotationE[2],rotationE[3],physicPosition),Vector3.add(position,physicPosition,physicPosition),nativePosition.setValue(-physicPositionE[0],physicPositionE[1],physicPositionE[2])}else nativePosition.setValue(-positionE[0],positionE[1],positionE[2]);physicTransformOut.setOrigin(nativePosition),this._setTransformFlag(8,!1)}if(force||this._getTransformFlag(16)){var shapeRotation=this._colliderShape.localRotation,shapeRotationE=shapeRotation.elements,nativeRotation=PhysicsComponent._nativeQuaternion0;if(0!==shapeRotationE[0]||0!==shapeRotationE[1]||0!==shapeRotationE[2]||1!==shapeRotationE[3]){var physicRotation=PhysicsComponent._tempQuaternion0;PhysicsComponent.physicQuaternionMultiply(rotationE[0],rotationE[1],rotationE[2],rotationE[3],shapeRotation,physicRotation);var physicRotationE=physicRotation.elements;nativeRotation.setValue(-physicRotationE[0],physicRotationE[1],physicRotationE[2],-physicRotationE[3])}else nativeRotation.setValue(-rotationE[0],rotationE[1],rotationE[2],-rotationE[3]);physicTransformOut.setRotation(nativeRotation),this._setTransformFlag(16,!1)}(force||this._getTransformFlag(32))&&(this._onScaleChange(transform.scale),this._setTransformFlag(32,!1))},__proto._updateTransformComponent=function(physicsTransform){var localOffset=this._colliderShape.localOffset,localRotation=this._colliderShape.localRotation,shapeOffsetE=localOffset.elements,shapeRotationE=localRotation.elements,transform=this.owner._transform,position=transform.position,rotation=transform.rotation,positionE=position.elements,nativePosition=physicsTransform.getOrigin(),nativeRotation=physicsTransform.getRotation(),nativeRotX=-nativeRotation.x(),nativeRotY=nativeRotation.y(),nativeRotZ=nativeRotation.z(),nativeRotW=-nativeRotation.w();if(0!==shapeOffsetE[0]||0!==shapeOffsetE[1]||0!==shapeOffsetE[2]){var rotShapePosition=PhysicsComponent._tempVector30;PhysicsComponent.physicVector3TransformQuat(localOffset,nativeRotX,nativeRotY,nativeRotZ,nativeRotW,rotShapePosition);var rotShapePositionE=rotShapePosition.elements;positionE[0]=-nativePosition.x()-rotShapePositionE[0],positionE[1]=nativePosition.y()-rotShapePositionE[1],positionE[2]=nativePosition.z()-rotShapePositionE[2]}else positionE[0]=-nativePosition.x(),positionE[1]=nativePosition.y(),positionE[2]=nativePosition.z();if(transform.position=position,0!==shapeRotationE[0]||0!==shapeRotationE[1]||0!==shapeRotationE[2]||1!==shapeRotationE[3]){var invertShapeRotaion=PhysicsComponent._tempQuaternion0;localRotation.invert(invertShapeRotaion),PhysicsComponent.physicQuaternionMultiply(nativeRotX,nativeRotY,nativeRotZ,nativeRotW,invertShapeRotaion,rotation)}else{var rotationE=rotation.elements;rotationE[0]=nativeRotX,rotationE[1]=nativeRotY,rotationE[2]=nativeRotZ,rotationE[3]=nativeRotW}transform.rotation=rotation},__proto._onEnable=function(){this._simulation=this.owner._scene.physicsSimulation,this._nativeColliderObject.setContactProcessingThreshold(1e30),this._colliderShape&&this._enabled&&(this._derivePhysicsTransformation(!0),this._addToSimulation())},__proto._onDisable=function(){this._colliderShape&&this._enabled&&this._removeFromSimulation(),this._simulation=null},__proto._onShapeChange=function(colShape){var btColObj=this._nativeColliderObject,flags=btColObj.getCollisionFlags();colShape.needsCustomCollisionCallback?0==(8&flags)&&btColObj.setCollisionFlags(8|flags):(8&flags)>0&&btColObj.setCollisionFlags(8^flags)},__proto._onAdded=function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on("transformchanged",this,this._onTransformChanged)},__proto._onDestroy=function(){var physics3D=Laya3D._physics3D;delete PhysicsComponent._physicObjectsMap[this.id],physics3D.destroy(this._nativeColliderObject),this._colliderShape.destroy(),_super.prototype._onDestroy.call(this),this._nativeColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off("transformchanged",this,this._onTransformChanged)},__proto._onTransformChanged=function(flag){PhysicsComponent._addUpdateList&&(flag&=56)&&(this._transformFlag|=flag,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this))},__proto._cloneTo=function(dest){var destPhysicsComponent=dest;destPhysicsComponent.restitution=this._restitution,destPhysicsComponent.friction=this._friction,destPhysicsComponent.rollingFriction=this._rollingFriction,destPhysicsComponent.ccdMotionThreshold=this._ccdMotionThreshold,destPhysicsComponent.ccdSweptSphereRadius=this._ccdSweptSphereRadius,destPhysicsComponent.collisionGroup=this._collisionGroup,destPhysicsComponent.canCollideWith=this._canCollideWith,destPhysicsComponent.canScaleShape=this.canScaleShape,this._colliderShape&&(destPhysicsComponent.colliderShape=this._colliderShape.clone())},__getset(0,__proto,"isActive",function(){return!!this._nativeColliderObject&&this._nativeColliderObject.isActive()}),__getset(0,__proto,"restitution",function(){return this._restitution},function(value){this._restitution=value,this._nativeColliderObject&&this._nativeColliderObject.setRestitution(value)}),__getset(0,__proto,"friction",function(){return this._friction},function(value){this._friction=value,this._nativeColliderObject&&this._nativeColliderObject.setFriction(value)}),__getset(0,__proto,"rollingFriction",function(){return this._nativeColliderObject.getRollingFriction()},function(value){this._rollingFriction=value,this._nativeColliderObject&&this._nativeColliderObject.setRollingFriction(value)}),__getset(0,__proto,"ccdMotionThreshold",function(){return this._ccdMotionThreshold},function(value){this._ccdMotionThreshold=value,this._nativeColliderObject&&this._nativeColliderObject.setCcdMotionThreshold(value)}),__getset(0,__proto,"ccdSweptSphereRadius",function(){return this._ccdSweptSphereRadius},function(value){this._ccdSweptSphereRadius=value,this._nativeColliderObject&&this._nativeColliderObject.setCcdSweptSphereRadius(value)}),__getset(0,__proto,"collisionGroup",function(){return this._collisionGroup},function(value){this._collisionGroup!==value&&(this._collisionGroup=value,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}),__getset(0,__proto,"simulation",function(){return this._simulation}),__getset(0,__proto,"colliderShape",function(){return this._colliderShape},function(value){var lastColliderShape=this._colliderShape;if(lastColliderShape&&(lastColliderShape._attatched=!1,lastColliderShape._attatchedCollisionObject=null),this._colliderShape=value,value){if(value._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(value._attatched=!0,value._attatchedCollisionObject=this,this._nativeColliderObject){this._nativeColliderObject.setCollisionShape(value._nativeShape);var canInSimulation=this._simulation&&this._enabled;canInSimulation&&lastColliderShape&&this._removeFromSimulation(),this._onShapeChange(value),canInSimulation&&(this._derivePhysicsTransformation(!0),this._addToSimulation())}}else this._simulation&&this._enabled&&lastColliderShape&&this._removeFromSimulation()}),__getset(0,__proto,"enabled",_super.prototype._$get_enabled,function(value){this._simulation&&this._colliderShape&&(value?(this._derivePhysicsTransformation(!0),this._addToSimulation()):this._removeFromSimulation()),Laya.superSet(Component,this,"enabled",value)}),__getset(0,__proto,"canCollideWith",function(){return this._canCollideWith},function(value){this._canCollideWith!==value&&(this._canCollideWith=value,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()))}),PhysicsComponent._createAffineTransformationArray=function(tranX,tranY,tranZ,rotX,rotY,rotZ,rotW,scale,outE){var x2=rotX+rotX,y2=rotY+rotY,z2=rotZ+rotZ,xx=rotX*x2,xy=rotX*y2,xz=rotX*z2,yy=rotY*y2,yz=rotY*z2,zz=rotZ*z2,wx=rotW*x2,wy=rotW*y2,wz=rotW*z2,sx=scale[0],sy=scale[1],sz=scale[2];outE[0]=(1-(yy+zz))*sx,outE[1]=(xy+wz)*sx,outE[2]=(xz-wy)*sx,outE[3]=0,outE[4]=(xy-wz)*sy,outE[5]=(1-(xx+zz))*sy,outE[6]=(yz+wx)*sy,outE[7]=0,outE[8]=(xz+wy)*sz,outE[9]=(yz-wx)*sz,outE[10]=(1-(xx+yy))*sz,outE[11]=0,outE[12]=tranX,outE[13]=tranY,outE[14]=tranZ,outE[15]=1},PhysicsComponent.physicVector3TransformQuat=function(source,qx,qy,qz,qw,out){var destination=out.elements,se=source.elements,x=se[0],y=se[1],z=se[2],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;destination[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy,destination[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz,destination[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx},PhysicsComponent.physicQuaternionMultiply=function(lx,ly,lz,lw,right,out){var re=right.elements,oe=out.elements,rx=re[0],ry=re[1],rz=re[2],rw=re[3],a=ly*rz-lz*ry,b=lz*rx-lx*rz,c=lx*ry-ly*rx,d=lx*rx+ly*ry+lz*rz;oe[0]=lx*rw+rx*lw+a,oe[1]=ly*rw+ry*lw+b,oe[2]=lz*rw+rz*lw+c,oe[3]=lw*rw-d},PhysicsComponent.ACTIVATIONSTATE_ACTIVE_TAG=1,PhysicsComponent.ACTIVATIONSTATE_ISLAND_SLEEPING=2,PhysicsComponent.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,PhysicsComponent.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,PhysicsComponent.ACTIVATIONSTATE_DISABLE_SIMULATION=5,PhysicsComponent.COLLISIONFLAGS_STATIC_OBJECT=1,PhysicsComponent.COLLISIONFLAGS_KINEMATIC_OBJECT=2,PhysicsComponent.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,PhysicsComponent.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,PhysicsComponent.COLLISIONFLAGS_CHARACTER_OBJECT=16,PhysicsComponent.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,PhysicsComponent.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,PhysicsComponent._physicObjectsMap={},PhysicsComponent._addUpdateList=!0,__static(PhysicsComponent,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempQuaternion1",function(){return this._tempQuaternion1=new Quaternion},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_nativeVector30",function(){return this._nativeVector30=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeQuaternion0",function(){return this._nativeQuaternion0=new Laya3D._physics3D.btQuaternion(0,0,0,1)}]),PhysicsComponent}(Component)),Animator=function(_super){function Animator(){this._linkAvatarSpritesData={},this._keyframeNodeOwners=[],this._linkAvatarSprites=[],this._renderableSprites=[],this.cullingMode=2,Animator.__super.call(this),this._controllerLayers=[],this._linkSprites={},this._speed=1,this._keyframeNodeOwnerMap={},this._updateMark=0}__class(Animator,"laya.d3.component.Animator",_super);var __proto=Animator.prototype;return __proto._linkToSprites=function(linkSprites){for(var k in linkSprites){for(var nodeOwner=this.owner,path=linkSprites[k],j=0,m=path.length;j<m;j++){var p=path[j];if(""===p)break;if(!(nodeOwner=nodeOwner.getChildByName(p)))break}nodeOwner&&this.linkSprite3DToAvatarNode(k,nodeOwner)}},__proto._addKeyframeNodeOwner=function(clipOwners,node,propertyOwner){var nodeIndex=node._indexInList,fullPath=node.fullPath,keyframeNodeOwner=this._keyframeNodeOwnerMap[fullPath];if(keyframeNodeOwner)keyframeNodeOwner.referenceCount++,clipOwners[nodeIndex]=keyframeNodeOwner;else{for(var property=propertyOwner,i=0,n=node.propertyCount;i<n&&(property=property[node.getPropertyByIndex(i)]);i++);(keyframeNodeOwner=this._keyframeNodeOwnerMap[fullPath]=new KeyframeNodeOwner).fullPath=fullPath,keyframeNodeOwner.indexInList=this._keyframeNodeOwners.length,keyframeNodeOwner.referenceCount=1,keyframeNodeOwner.propertyOwner=propertyOwner;var propertyCount=node.propertyCount,propertys=__newvec(propertyCount);for(i=0;i<propertyCount;i++)propertys[i]=node.getPropertyByIndex(i);keyframeNodeOwner.property=propertys,keyframeNodeOwner.type=node.type,property&&(0===node.type?keyframeNodeOwner.defaultValue=property:keyframeNodeOwner.defaultValue=property.elements.slice()),this._keyframeNodeOwners.push(keyframeNodeOwner),clipOwners[nodeIndex]=keyframeNodeOwner}},__proto._removeKeyframeNodeOwner=function(nodeOwners,node){var fullPath=node.fullPath,keyframeNodeOwner=this._keyframeNodeOwnerMap[fullPath];keyframeNodeOwner&&(keyframeNodeOwner.referenceCount--,0===keyframeNodeOwner.referenceCount&&(delete this._keyframeNodeOwnerMap[fullPath],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(keyframeNodeOwner),1)),nodeOwners[node._indexInList]=null)},__proto._getOwnersByClip=function(clipStateInfo){var frameNodes=clipStateInfo._clip._nodes,frameNodesCount=frameNodes.count,nodeOwners=clipStateInfo._nodeOwners;nodeOwners.length=frameNodesCount;for(var i=0;i<frameNodesCount;i++){for(var node=frameNodes.getNodeByIndex(i),property=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,j=0,m=node.ownerPathCount;j<m;j++){var ownPat=node.getOwnerPathByIndex(j);if(""===ownPat)break;if(!(property=property.getChildByName(ownPat)))break}if(property){var propertyOwner=node.propertyOwner;propertyOwner&&(property=property[propertyOwner]),property&&this._addKeyframeNodeOwner(nodeOwners,node,property)}}},__proto._getOwnersByClipAsync=function(clipStateInfo){clipStateInfo._clip;this._getOwnersByClip(clipStateInfo)},__proto._getAvatarOwnersAndInitDatasAsync=function(){for(var i=0,n=this._controllerLayers.length;i<n;i++)for(var clipStateInfos=this._controllerLayers[i]._states,j=0,m=clipStateInfos.length;j<m;j++)this._getOwnersByClipAsync(clipStateInfos[j]);for(var k in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var sprites=this._linkAvatarSpritesData[k];if(sprites)for(var c=0,p=sprites.length;c<p;c++)this._isLinkSpriteToAnimationNode(sprites[c],k,!0)}},__proto._eventScript=function(scripts,clipState,playState,from,to){for(var events=clipState._clip._events,eventIndex=playState._playEventIndex,n=events.length;eventIndex<n;eventIndex++){var eve=events[eventIndex],eventTime=eve.time;if(!(from<=eventTime&&eventTime<to))break;for(var j=0,m=scripts.length;j<m;j++){var script=scripts[j],fun=script[eve.eventName];fun&&fun.apply(script,eve.params)}}playState._playEventIndex=eventIndex},__proto._updatePlayer=function(animatorState,playState,elapsedTime,islooping){if(animatorState.cycleOffset>0&&(isNaN(playState.cycleOffset)&&(playState.cycleOffset=0),playState.cycleOffset<2*animatorState.cycleOffset))playState.cycleOffset+=elapsedTime;else{var clipDuration=animatorState._clip._duration*(animatorState.clipEnd-animatorState.clipStart),lastElapsedTime=playState._elapsedTime,elapsedPlaybackTime=lastElapsedTime+elapsedTime;playState._lastElapsedTime=lastElapsedTime,playState._elapsedTime=elapsedPlaybackTime;var normalizedTime=elapsedPlaybackTime/clipDuration;playState._normalizedTime=normalizedTime;var playTime=normalizedTime%1;playState._normalizedPlayTime=playTime<0?playTime+1:playTime,playState._duration=clipDuration;var scripts=animatorState._scripts;if(!islooping&&elapsedPlaybackTime>=clipDuration){if(playState._finish=!0,playState._elapsedTime=clipDuration,playState._normalizedPlayTime=1,scripts)for(var i=0,n=scripts.length;i<n;i++)scripts[i].onStateExit()}else{if(clipDuration>0){if(elapsedPlaybackTime>=clipDuration)do{elapsedPlaybackTime-=clipDuration,playState._playEventIndex=0}while(elapsedPlaybackTime>=clipDuration)}else playState._resetPlayState(0);if(scripts)for(i=0,n=scripts.length;i<n;i++)scripts[i].onStateUpdate()}}},__proto._updateEventScript=function(stateInfo,playStateInfo,islooping){var scripts=this.owner._scripts;if(scripts){var clipDuration=stateInfo._clip._duration,lastElapsedTime=playStateInfo._lastElapsedTime,elapsedTime=playStateInfo._elapsedTime,lastLoop=Math.floor(lastElapsedTime/clipDuration),lastTime=lastElapsedTime%clipDuration,time=elapsedTime%clipDuration,loopCount=Math.floor(elapsedTime/clipDuration)-lastLoop;if(islooping)if(loopCount>0){this._eventScript(scripts,stateInfo,playStateInfo,lastTime,clipDuration);for(var i=0,n=loopCount-1;i<n;i++)this._eventScript(scripts,stateInfo,playStateInfo,0,clipDuration);this._eventScript(scripts,stateInfo,playStateInfo,0,time)}else this._eventScript(scripts,stateInfo,playStateInfo,lastTime,time);else loopCount>0?this._eventScript(scripts,stateInfo,playStateInfo,lastTime,clipDuration):this._eventScript(scripts,stateInfo,playStateInfo,lastTime,time)}},__proto._updateClipDatas=function(animatorState,addtive,playStateInfo,scale){var clip=animatorState._clip,clipDuration=clip._duration,curPlayTime=animatorState.clipStart*clipDuration+playStateInfo._normalizedPlayTime*playStateInfo._duration,currentFrameIndices=animatorState._currentFrameIndices,frontPlay=playStateInfo._elapsedTime>playStateInfo._lastElapsedTime;clip._evaluateClipDatasRealTime(clip._nodes,curPlayTime,currentFrameIndices,addtive,frontPlay)},__proto._applyFloat=function(pro,proName,nodeOwner,additive,weight,isFirstLayer,data){if(nodeOwner.updateMark===this._updateMark)if(additive)pro[proName]+=weight*data;else{var oriValue=pro[proName];pro[proName]=oriValue+weight*(data-oriValue)}else if(isFirstLayer)pro[proName]=additive?nodeOwner.defaultValue+data:data;else if(additive)pro[proName]=nodeOwner.defaultValue+weight*data;else{var defValue=nodeOwner.defaultValue;pro[proName]=defValue+weight*(data-defValue)}},__proto._applyPositionAndRotationEuler=function(nodeOwner,additive,weight,isFirstLayer,data,out){if(nodeOwner.updateMark===this._updateMark)if(additive)out[0]+=weight*data[0],out[1]+=weight*data[1],out[2]+=weight*data[2];else{var oriX=out[0],oriY=out[1],oriZ=out[2];out[0]=oriX+weight*(data[0]-oriX),out[1]=oriY+weight*(data[1]-oriY),out[2]=oriZ+weight*(data[2]-oriZ)}else if(isFirstLayer)if(additive){var defValue=nodeOwner.defaultValue;out[0]=defValue[0]+data[0],out[1]=defValue[1]+data[1],out[2]=defValue[2]+data[2]}else out[0]=data[0],out[1]=data[1],out[2]=data[2];else if(defValue=nodeOwner.defaultValue,additive)out[0]=defValue[0]+weight*data[0],out[1]=defValue[1]+weight*data[1],out[2]=defValue[2]+weight*data[2];else{var defX=defValue[0],defY=defValue[1],defZ=defValue[2];out[0]=defX+weight*(data[0]-defX),out[1]=defY+weight*(data[1]-defY),out[2]=defZ+weight*(data[2]-defZ)}},__proto._applyRotation=function(nodeOwner,additive,weight,isFirstLayer,clipRot,localRotationE){if(nodeOwner.updateMark===this._updateMark)if(additive){var tempQuat=Animator._tempQuaternionArray1;Utils3D.quaternionWeight(clipRot,weight,tempQuat),Utils3D.quaterionNormalize(tempQuat,tempQuat),Utils3D.quaternionMultiply(localRotationE,tempQuat,localRotationE)}else Quaternion._lerpArray(localRotationE,clipRot,weight,localRotationE);else if(isFirstLayer)if(additive){var defaultRot=nodeOwner.defaultValue;Utils3D.quaternionMultiply(defaultRot,clipRot,localRotationE)}else localRotationE[0]=clipRot[0],localRotationE[1]=clipRot[1],localRotationE[2]=clipRot[2],localRotationE[3]=clipRot[3];else defaultRot=nodeOwner.defaultValue,additive?(tempQuat=Animator._tempQuaternionArray1,Utils3D.quaternionWeight(clipRot,weight,tempQuat),Utils3D.quaterionNormalize(tempQuat,tempQuat),Utils3D.quaternionMultiply(defaultRot,tempQuat,localRotationE)):Quaternion._lerpArray(defaultRot,clipRot,weight,localRotationE)},__proto._applyScale=function(nodeOwner,additive,weight,isFirstLayer,clipSca,localScaleE){if(nodeOwner.updateMark===this._updateMark)if(additive){var scale=Animator._tempVector3Array1;Utils3D.scaleWeight(clipSca,weight,scale),localScaleE[0]=localScaleE[0]*scale[0],localScaleE[1]=localScaleE[1]*scale[1],localScaleE[2]=localScaleE[2]*scale[2]}else Utils3D.scaleBlend(localScaleE,clipSca,weight,localScaleE);else if(isFirstLayer)if(additive){var defaultSca=nodeOwner.defaultValue;localScaleE[0]=defaultSca[0]*clipSca[0],localScaleE[1]=defaultSca[1]*clipSca[1],localScaleE[2]=defaultSca[2]*clipSca[2]}else localScaleE[0]=clipSca[0],localScaleE[1]=clipSca[1],localScaleE[2]=clipSca[2];else defaultSca=nodeOwner.defaultValue,additive?(scale=Animator._tempVector3Array1,Utils3D.scaleWeight(clipSca,weight,scale),localScaleE[0]=defaultSca[0]*scale[0],localScaleE[1]=defaultSca[1]*scale[1],localScaleE[2]=defaultSca[2]*scale[2]):Utils3D.scaleBlend(defaultSca,clipSca,weight,localScaleE)},__proto._applyCrossData=function(nodeOwner,additive,weight,isFirstLayer,srcValue,desValue,crossWeight){var pro=nodeOwner.propertyOwner;if(pro){switch(nodeOwner.type){case 0:for(var proPat=nodeOwner.property,m=proPat.length-1,j=0;j<m&&(pro=pro[proPat[j]]);j++);var crossValue=srcValue+crossWeight*(desValue-srcValue);this._applyFloat(pro,proPat[m],nodeOwner,additive,weight,isFirstLayer,crossValue);break;case 1:var localPos=pro.localPosition,position=Animator._tempVector3Array0,srcX=srcValue[0],srcY=srcValue[1],srcZ=srcValue[2];position[0]=srcX+crossWeight*(desValue[0]-srcX),position[1]=srcY+crossWeight*(desValue[1]-srcY),position[2]=srcZ+crossWeight*(desValue[2]-srcZ),this._applyPositionAndRotationEuler(nodeOwner,additive,weight,isFirstLayer,position,localPos.elements),pro.localPosition=localPos;break;case 2:var localRot=pro.localRotation,rotation=Animator._tempQuaternionArray0;Quaternion._lerpArray(srcValue,desValue,crossWeight,rotation),this._applyRotation(nodeOwner,additive,weight,isFirstLayer,rotation,localRot.elements),pro.localRotation=localRot;break;case 3:var localSca=pro.localScale,scale=Animator._tempVector3Array0;Utils3D.scaleBlend(srcValue,desValue,crossWeight,scale),this._applyScale(nodeOwner,additive,weight,isFirstLayer,scale,localSca.elements),pro.localScale=localSca;break;case 4:var localEuler=pro.localRotationEuler,rotationEuler=Animator._tempVector3Array0;srcX=srcValue[0],srcY=srcValue[1],srcZ=srcValue[2],rotationEuler[0]=srcX+crossWeight*(desValue[0]-srcX),rotationEuler[1]=srcY+crossWeight*(desValue[1]-srcY),rotationEuler[2]=srcZ+crossWeight*(desValue[2]-srcZ),this._applyPositionAndRotationEuler(nodeOwner,additive,weight,isFirstLayer,rotationEuler,localEuler.elements),pro.localRotationEuler=localEuler}nodeOwner.updateMark=this._updateMark}},__proto._setClipDatasToNode=function(stateInfo,additive,weight,isFirstLayer){for(var nodes=stateInfo._clip._nodes,nodeOwners=stateInfo._nodeOwners,i=0,n=nodes.count;i<n;i++){var nodeOwner=nodeOwners[i];if(nodeOwner){var pro=nodeOwner.propertyOwner;if(pro){switch(nodeOwner.type){case 0:for(var proPat=nodeOwner.property,m=proPat.length-1,j=0;j<m&&(pro=pro[proPat[j]]);j++);this._applyFloat(pro,proPat[m],nodeOwner,additive,weight,isFirstLayer,nodes.getNodeByIndex(i).data);break;case 1:var localPos=pro.localPosition;this._applyPositionAndRotationEuler(nodeOwner,additive,weight,isFirstLayer,nodes.getNodeByIndex(i).data,localPos.elements),pro.localPosition=localPos;break;case 2:var localRot=pro.localRotation;this._applyRotation(nodeOwner,additive,weight,isFirstLayer,nodes.getNodeByIndex(i).data,localRot.elements),pro.localRotation=localRot;break;case 3:var localSca=pro.localScale;this._applyScale(nodeOwner,additive,weight,isFirstLayer,nodes.getNodeByIndex(i).data,localSca.elements),pro.localScale=localSca;break;case 4:var localEuler=pro.localRotationEuler;this._applyPositionAndRotationEuler(nodeOwner,additive,weight,isFirstLayer,nodes.getNodeByIndex(i).data,localEuler.elements),pro.localRotationEuler=localEuler}nodeOwner.updateMark=this._updateMark}}}},__proto._setCrossClipDatasToNode=function(controllerLayer,srcState,destState,crossWeight,isFirstLayer){for(var nodeOwners=controllerLayer._crossNodesOwners,ownerCount=controllerLayer._crossNodesOwnersCount,additive=controllerLayer.blendingMode!==AnimatorControllerLayer.BLENDINGMODE_OVERRIDE,weight=controllerLayer.defaultWeight,destDataIndices=controllerLayer._destCrossClipNodeIndices,destNodes=destState._clip._nodes,destNodeOwners=destState._nodeOwners,srcDataIndices=controllerLayer._srcCrossClipNodeIndices,srcNodeOwners=srcState._nodeOwners,srcNodes=srcState._clip._nodes,i=0;i<ownerCount;i++){var nodeOwner=nodeOwners[i];if(nodeOwner){var srcIndex=srcDataIndices[i],destIndex=destDataIndices[i],srcValue=-1!==srcIndex?srcNodes.getNodeByIndex(srcIndex).data:destNodeOwners[destIndex].defaultValue,desValue=-1!==destIndex?destNodes.getNodeByIndex(destIndex).data:srcNodeOwners[srcIndex].defaultValue;this._applyCrossData(nodeOwner,additive,weight,isFirstLayer,srcValue,desValue,crossWeight)}}},__proto._setFixedCrossClipDatasToNode=function(controllerLayer,destState,crossWeight,isFirstLayer){for(var nodeOwners=controllerLayer._crossNodesOwners,ownerCount=controllerLayer._crossNodesOwnersCount,additive=controllerLayer.blendingMode!==AnimatorControllerLayer.BLENDINGMODE_OVERRIDE,weight=controllerLayer.defaultWeight,destDataIndices=controllerLayer._destCrossClipNodeIndices,destNodes=destState._clip._nodes,i=0;i<ownerCount;i++){var nodeOwner=nodeOwners[i];if(nodeOwner){var destIndex=destDataIndices[i],srcValue=nodeOwner.crossFixedValue,desValue=-1!==destIndex?destNodes.getNodeByIndex(destIndex).data:nodeOwner.defaultValue;this._applyCrossData(nodeOwner,additive,weight,isFirstLayer,srcValue,desValue,crossWeight)}}},__proto._revertDefaultKeyframeNodes=function(clipStateInfo){for(var nodeOwners=clipStateInfo._nodeOwners,i=0,n=nodeOwners.length;i<n;i++){var nodeOwner=nodeOwners[i];if(nodeOwner){var pro=nodeOwner.propertyOwner;if(pro)switch(nodeOwner.type){case 0:for(var proPat=nodeOwner.property,m=proPat.length-1,j=0;j<m&&(pro=pro[proPat[j]]);j++);pro[proPat[m]]=nodeOwner.defaultValue;break;case 1:var locPos=pro.localPosition,locPosE=locPos.elements,def=nodeOwner.defaultValue;locPosE[0]=def[0],locPosE[1]=def[1],locPosE[2]=def[2],pro.localPosition=locPos;break;case 2:var locRot=pro.localRotation,locRotE=locRot.elements;def=nodeOwner.defaultValue,locRotE[0]=def[0],locRotE[1]=def[1],locRotE[2]=def[2],locRotE[3]=def[3],pro.localRotation=locRot;break;case 3:var locSca=pro.localScale,locScaE=locSca.elements;def=nodeOwner.defaultValue,locScaE[0]=def[0],locScaE[1]=def[1],locScaE[2]=def[2],pro.localScale=locSca;break;case 4:var locEul=pro.localRotationEuler,locEulE=locEul.elements;def=nodeOwner.defaultValue,locEulE[0]=def[0],locEulE[1]=def[1],locEulE[2]=def[2],pro.localRotationEuler=locEul;break;default:throw"Animator:unknown type."}}}},__proto._removeClip=function(clipStateInfos,statesMap,index,state){var clip=state._clip;clip._removeReference(),clipStateInfos.splice(index,1),delete statesMap[state.name];for(var clipStateInfo=clipStateInfos[index],frameNodes=clip._nodes,nodeOwners=clipStateInfo._nodeOwners,i=0,n=frameNodes.count;i<n;i++)this._removeKeyframeNodeOwner(nodeOwners,frameNodes.getNodeByIndex(i))},__proto._isLinkSpriteToAnimationNodeData=function(sprite,nodeName,isLink){var linkSprites=this._linkAvatarSpritesData[nodeName];isLink?(linkSprites||(this._linkAvatarSpritesData[nodeName]=linkSprites=[]),linkSprites.push(sprite)):linkSprites.splice(sprite,1)},__proto._isLinkSpriteToAnimationNode=function(sprite,nodeName,isLink){if(this._avatar){var node=this._avatarNodeMap[nodeName];if(node)if(isLink){sprite._transform._dummy=node.transform,this._linkAvatarSprites.push(sprite);var nodeTransform=node.transform,spriteTransform=sprite.transform;if(!spriteTransform.owner.isStatic&&nodeTransform){var spriteWorldMatrix=spriteTransform.worldMatrix,ownParTra=this.owner._transform._parent;if(ownParTra)Utils3D.matrix4x4MultiplyMFM(ownParTra.worldMatrix,nodeTransform.getWorldMatrix(),spriteWorldMatrix);else for(var sprWorE=spriteWorldMatrix.elements,nodWorE=nodeTransform.getWorldMatrix(),i=0;i<16;i++)sprWorE[i]=nodWorE[i];spriteTransform.worldMatrix=spriteWorldMatrix}}else sprite._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(sprite),1)}},__proto._onAdded=function(){var parent=this.owner._parent;this.owner._setHierarchyAnimator(this,parent?parent._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[])},__proto._onDestroy=function(){var parent=this.owner._parent;this.owner._clearHierarchyAnimator(this,parent?parent._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!1,[])},__proto._onEnableInScene=function(){this.owner._scene._animatorPool.add(this)},__proto._onDisableInScene=function(){this.owner._scene._animatorPool.remove(this)},__proto._onEnable=function(){for(var i=0,n=this._controllerLayers.length;i<n;i++){if(this._controllerLayers[i].playOnWake)this.getDefaultState(i)&&this.play(null,i,0)}},__proto._handleSpriteOwnersBySprite=function(isLink,path,sprite){for(var i=0,n=this._controllerLayers.length;i<n;i++)for(var clipStateInfos=this._controllerLayers[i]._states,j=0,m=clipStateInfos.length;j<m;j++){var clipStateInfo=clipStateInfos[j],clip=clipStateInfo._clip,nodePath=path.join("/"),ownersNodes=clip._nodesMap[nodePath];if(ownersNodes)for(var nodeOwners=clipStateInfo._nodeOwners,k=0,p=ownersNodes.length;k<p;k++)isLink?this._addKeyframeNodeOwner(nodeOwners,ownersNodes[k],sprite):this._removeKeyframeNodeOwner(nodeOwners,ownersNodes[k])}},__proto._updateAvatarNodesToSprite=function(){for(var i=0,n=this._linkAvatarSprites.length;i<n;i++){var sprite=this._linkAvatarSprites[i],nodeTransform=sprite.transform._dummy,spriteTransform=sprite.transform;if(!spriteTransform.owner.isStatic&&nodeTransform){var spriteWorldMatrix=spriteTransform.worldMatrix,ownParTra=this.owner._transform._parent;if(ownParTra)Utils3D.matrix4x4MultiplyMFM(ownParTra.worldMatrix,nodeTransform.getWorldMatrix(),spriteWorldMatrix);else for(var sprWorE=spriteWorldMatrix.elements,nodWorE=nodeTransform.getWorldMatrix(),j=0;j<16;j++)sprWorE[j]=nodWorE[j];spriteTransform.worldMatrix=spriteWorldMatrix}}},__proto._parse=function(data){var avatarData=data.avatar;if(avatarData){this.avatar=Loader.getRes(avatarData.path);var linkSprites=avatarData.linkSprites;this._linkSprites=linkSprites,this._linkToSprites(linkSprites)}data.clipPaths;for(var play=data.playOnWake,layersData=data.layers,i=0;i<layersData.length;i++){var layerData=layersData[i],animatorLayer=new AnimatorControllerLayer(layerData.name);animatorLayer.defaultWeight=0===i?1:layerData.weight;var blendingModeData=layerData.blendingMode;blendingModeData&&(animatorLayer.blendingMode=blendingModeData),this.addControllerLayer(animatorLayer);for(var states=layerData.states,j=0,m=states.length;j<m;j++){var state=states[j],clipPath=state.clipPath;if(clipPath){var motion,name=state.name,cycleOffset=state.cycleOffset;if(motion=Loader.getRes(clipPath)){var animatorState=new AnimatorState;animatorState.name=name,animatorState.cycleOffset=cycleOffset,animatorState.clip=motion,motion._addReference(),this.addState(animatorState,i),0===j&&this.setDefaultClip(name,i)}}}void 0!==play&&(animatorLayer.playOnWake=play)}var cullingModeData=data.cullingMode;void 0!==cullingModeData&&(this.cullingMode=cullingModeData)},__proto._update=function(){if(0!==this._speed){var needRender=!1;if(2===this.cullingMode){needRender=!1;for(var i=0,n=this._renderableSprites.length;i<n;i++)if(this._renderableSprites[i]._render._visible){needRender=!0;break}}else needRender=!0;this._updateMark++;var timer=this.owner._scene.timer,delta=timer._delta/1e3,timerScale=timer.scale;for(i=0,n=this._controllerLayers.length;i<n;i++){var controllerLayer=this._controllerLayers[i],playStateInfo=controllerLayer._playStateInfo,crossPlayStateInfo=controllerLayer._crossPlayStateInfo;switch(addtive=controllerLayer.blendingMode!==AnimatorControllerLayer.BLENDINGMODE_OVERRIDE,controllerLayer._playType){case 0:var animatorState=controllerLayer._currentPlayState,clip=animatorState._clip,speed=this._speed*animatorState.speed,finish=playStateInfo._finish;if(finish||this._updatePlayer(animatorState,playStateInfo,delta*speed,clip.islooping),needRender){var addtive=controllerLayer.blendingMode!==AnimatorControllerLayer.BLENDINGMODE_OVERRIDE;this._updateClipDatas(animatorState,addtive,playStateInfo,timerScale*speed),this._setClipDatasToNode(animatorState,addtive,controllerLayer.defaultWeight,0===i),finish||this._updateEventScript(animatorState,playStateInfo,clip.islooping)}break;case 1:clip=(animatorState=controllerLayer._currentPlayState)._clip;var crossClipState=controllerLayer._crossPlayState,crossClip=crossClipState._clip,crossDuratuion=controllerLayer._crossDuration,startPlayTime=crossPlayStateInfo._startPlayTime,crossClipDuration=crossClip._duration-startPlayTime,crossScale=crossDuratuion>crossClipDuration?crossClipDuration/crossDuratuion:1,crossSpeed=this._speed*crossClipState.speed;this._updatePlayer(crossClipState,crossPlayStateInfo,delta*crossScale*crossSpeed,crossClip.islooping);var crossWeight=(crossPlayStateInfo._elapsedTime-startPlayTime)/crossScale/crossDuratuion;crossWeight>=1?needRender&&(this._updateClipDatas(crossClipState,addtive,crossPlayStateInfo,timerScale*crossSpeed),this._setClipDatasToNode(crossClipState,addtive,controllerLayer.defaultWeight,0===i),controllerLayer._playType=0,controllerLayer._currentPlayState=crossClipState,crossPlayStateInfo._cloneTo(playStateInfo)):(playStateInfo._finish||(speed=this._speed*animatorState.speed,this._updatePlayer(animatorState,playStateInfo,delta*speed,clip.islooping),needRender&&this._updateClipDatas(animatorState,addtive,playStateInfo,timerScale*speed)),needRender&&(this._updateClipDatas(crossClipState,addtive,crossPlayStateInfo,timerScale*crossScale*crossSpeed),this._setCrossClipDatasToNode(controllerLayer,animatorState,crossClipState,crossWeight,0===i))),needRender&&(this._updateEventScript(animatorState,playStateInfo,!1),this._updateEventScript(crossClipState,crossPlayStateInfo,crossClip.islooping));break;case 2:crossClip=(crossClipState=controllerLayer._crossPlayState)._clip,crossDuratuion=controllerLayer._crossDuration,startPlayTime=crossPlayStateInfo._startPlayTime,crossScale=crossDuratuion>(crossClipDuration=crossClip._duration-startPlayTime)?crossClipDuration/crossDuratuion:1,crossSpeed=this._speed*crossClipState.speed,this._updatePlayer(crossClipState,crossPlayStateInfo,delta*crossScale*crossSpeed,crossClip.islooping),needRender&&((crossWeight=(crossPlayStateInfo._elapsedTime-startPlayTime)/crossScale/crossDuratuion)>=1?(this._updateClipDatas(crossClipState,addtive,crossPlayStateInfo,timerScale*crossSpeed),this._setClipDatasToNode(crossClipState,addtive,1,0===i),controllerLayer._playType=0,controllerLayer._currentPlayState=crossClipState,crossPlayStateInfo._cloneTo(playStateInfo)):(this._updateClipDatas(crossClipState,addtive,crossPlayStateInfo,timerScale*crossScale*crossSpeed),this._setFixedCrossClipDatasToNode(controllerLayer,crossClipState,crossWeight,0===i)),this._updateEventScript(crossClipState,crossPlayStateInfo,crossClip.islooping))}}needRender&&this._avatar&&(Render.isConchApp&&this._updateAnimationNodeWorldMatix(this._animationNodeLocalPositions,this._animationNodeLocalRotations,this._animationNodeLocalScales,this._animationNodeWorldMatrixs,this._animationNodeParentIndices),this._updateAvatarNodesToSprite())}},__proto._cloneTo=function(dest){var animator=dest;animator.avatar=this.avatar;for(var i=0,n=this._controllerLayers.length;i<n;i++){var controllLayer=this._controllerLayers[i];animator.addControllerLayer(controllLayer.clone());for(var animatorStates=controllLayer._states,j=0,m=animatorStates.length;j<m;j++){var state=animatorStates[j];animator.addState(state.clone(),i),0==j&&animator.setDefaultClip(state.name,i)}}animator._linkSprites=this._linkSprites,animator._linkToSprites(this._linkSprites)},__proto.getDefaultState=function(layerIndex){return void 0===layerIndex&&(layerIndex=0),this._controllerLayers[layerIndex]._defaultState},__proto.setDefaultClip=function(playName,layerIndex){void 0===layerIndex&&(layerIndex=0);var controllerLayer=this._controllerLayers[layerIndex];controllerLayer._defaultState=controllerLayer._statesMap[playName]},__proto.addState=function(state,layerIndex){void 0===layerIndex&&(layerIndex=0);var stateName=state.name,controllerLayer=this._controllerLayers[layerIndex],statesMap=controllerLayer._statesMap,states=controllerLayer._states;if(statesMap[stateName])throw"Animator:this stat's name has exist.";statesMap[stateName]=state,states.push(state),state._clip._addReference(),this._avatar,this._getOwnersByClipAsync(state)},__proto.removeState=function(state,layerIndex){void 0===layerIndex&&(layerIndex=0);for(var controllerLayer=this._controllerLayers[layerIndex],clipStateInfos=controllerLayer._states,statesMap=controllerLayer._statesMap,index=-1,i=0,n=clipStateInfos.length;i<n;i++)if(clipStateInfos[i]===state){index=i;break}-1!==index&&this._removeClip(clipStateInfos,statesMap,index,state)},__proto.addControllerLayer=function(controllderLayer){this._controllerLayers.push(controllderLayer)},__proto.getControllerLayer=function(layerInex){return void 0===layerInex&&(layerInex=0),this._controllerLayers[layerInex]},__proto.getCurrentAnimatorPlayState=function(layerInex){return void 0===layerInex&&(layerInex=0),this._controllerLayers[layerInex]._playStateInfo},__proto.play=function(name,layerIndex,normalizedTime){void 0===layerIndex&&(layerIndex=0),void 0===normalizedTime&&(normalizedTime=Number.NEGATIVE_INFINITY);var controllerLayer=this._controllerLayers[layerIndex],defaultState=controllerLayer._defaultState;if(!name&&!defaultState)throw new Error("Animator:must have  default clip value,please set clip property.");var curPlayState=controllerLayer._currentPlayState,playStateInfo=controllerLayer._playStateInfo,animatorState=name?controllerLayer._statesMap[name]:defaultState,clipDuration=animatorState._clip._duration;curPlayState!==animatorState?(normalizedTime!==Number.NEGATIVE_INFINITY?playStateInfo._resetPlayState(clipDuration*normalizedTime):playStateInfo._resetPlayState(0),null!==curPlayState&&curPlayState!==animatorState&&this._revertDefaultKeyframeNodes(curPlayState),controllerLayer._playType=0,controllerLayer._currentPlayState=animatorState):normalizedTime!==Number.NEGATIVE_INFINITY&&(playStateInfo._resetPlayState(clipDuration*normalizedTime),controllerLayer._playType=0);var scripts=animatorState._scripts;if(scripts)for(var i=0,n=scripts.length;i<n;i++)scripts[i].onStateEnter()},__proto.crossFade=function(name,transitionDuration,layerIndex,normalizedTime){void 0===layerIndex&&(layerIndex=0),void 0===normalizedTime&&(normalizedTime=Number.NEGATIVE_INFINITY);var controllerLayer=this._controllerLayers[layerIndex],destAnimatorState=controllerLayer._statesMap[name];if(destAnimatorState){var playType=controllerLayer._playType;if(-1===playType)return void this.play(name,layerIndex,normalizedTime);var crossPlayStateInfo=controllerLayer._crossPlayStateInfo,crossNodeOwners=controllerLayer._crossNodesOwners,crossNodeOwnerIndicesMap=controllerLayer._crossNodesOwnersIndicesMap,srcAnimatorState=controllerLayer._currentPlayState,destNodeOwners=destAnimatorState._nodeOwners,destCrossClipNodeIndices=controllerLayer._destCrossClipNodeIndices,destClip=destAnimatorState._clip,destNodes=destClip._nodes,destNodesMap=destClip._nodesDic;switch(playType){case 0:var srcNodeOwners=srcAnimatorState._nodeOwners,scrCrossClipNodeIndices=controllerLayer._srcCrossClipNodeIndices,srcClip=srcAnimatorState._clip,srcNodes=srcClip._nodes,srcNodesMap=srcClip._nodesDic;controllerLayer._playType=1;for(var crossMark=++controllerLayer._crossMark,crossCount=controllerLayer._crossNodesOwnersCount=0,i=0,n=srcNodes.count;i<n;i++){var srcNode=srcNodes.getNodeByIndex(i),srcIndex=srcNode._indexInList,srcNodeOwner=srcNodeOwners[srcIndex];if(srcNodeOwner){var srcFullPath=srcNode.fullPath;scrCrossClipNodeIndices[crossCount]=srcIndex;var destNode=destNodesMap[srcFullPath];destCrossClipNodeIndices[crossCount]=destNode?destNode._indexInList:-1,crossNodeOwnerIndicesMap[srcFullPath]=crossMark,crossNodeOwners[crossCount]=srcNodeOwner,crossCount++}}for(i=0,n=destNodes.count;i<n;i++){var destIndex=(destNode=destNodes.getNodeByIndex(i))._indexInList,destNodeOwner=destNodeOwners[destIndex];if(destNodeOwner){var destFullPath=destNode.fullPath;srcNodesMap[destFullPath]||(scrCrossClipNodeIndices[crossCount]=-1,destCrossClipNodeIndices[crossCount]=destIndex,crossNodeOwnerIndicesMap[destFullPath]=crossMark,crossNodeOwners[crossCount]=destNodeOwner,crossCount++)}}break;case 1:case 2:for(controllerLayer._playType=2,i=0,n=crossNodeOwners.length;i<n;i++){var nodeOwner=crossNodeOwners[i];nodeOwner.saveCrossFixedValue(),destNode=destNodesMap[nodeOwner.fullPath],destCrossClipNodeIndices[i]=destNode?destNode._indexInList:-1}for(crossCount=controllerLayer._crossNodesOwnersCount,crossMark=controllerLayer._crossMark,i=0,n=destNodes.count;i<n;i++)(destNodeOwner=destNodeOwners[destIndex=(destNode=destNodes.getNodeByIndex(i))._indexInList])&&crossNodeOwnerIndicesMap[destFullPath=destNode.fullPath]!==crossMark&&(destCrossClipNodeIndices[crossCount]=destIndex,crossNodeOwnerIndicesMap[destFullPath]=crossMark,nodeOwner=destNodeOwners[destIndex],crossNodeOwners[crossCount]=nodeOwner,nodeOwner.saveCrossFixedValue(),crossCount++)}controllerLayer._crossNodesOwnersCount=crossCount,controllerLayer._crossPlayState=destAnimatorState,controllerLayer._crossDuration=srcAnimatorState._clip._duration*transitionDuration,normalizedTime!==Number.NEGATIVE_INFINITY?crossPlayStateInfo._resetPlayState(destClip._duration*normalizedTime):crossPlayStateInfo._resetPlayState(0)}var scripts=destAnimatorState._scripts;if(scripts)for(i=0,n=scripts.length;i<n;i++)scripts[i].onStateEnter()},__proto.linkSprite3DToAvatarNode=function(nodeName,sprite3D){if(sprite3D._hierarchyAnimator===this)return this._isLinkSpriteToAnimationNodeData(sprite3D,nodeName,!0),this._isLinkSpriteToAnimationNode(sprite3D,nodeName,!0),!0;throw"Animator:sprite3D must belong to this Animator"},__proto.unLinkSprite3DToAvatarNode=function(sprite3D){if(sprite3D._hierarchyAnimator===this){var dummy=sprite3D.transform._dummy;if(dummy){var nodeName=dummy._owner.name;return this._isLinkSpriteToAnimationNodeData(sprite3D,nodeName,!1),this._isLinkSpriteToAnimationNode(sprite3D,nodeName,!1),!0}return!1}throw"Animator:sprite3D must belong to this Animator"},__proto.destroy=function(){_super.prototype.destroy.call(this);for(var i=0,n=this._controllerLayers.length;i<n;i++)for(var clipStateInfos=this._controllerLayers[i]._states,j=0,m=clipStateInfos.length;j<m;j++)clipStateInfos[j]._clip._removeReference()},__proto._updateAnimationNodeWorldMatix=function(localPositions,localRotations,localScales,worldMatrixs,parentIndices){LayaGL.instance.updateAnimationNodeWorldMatix(localPositions,localRotations,localScales,parentIndices,worldMatrixs)},__getset(0,__proto,"avatar",function(){return this._avatar},function(value){if(this._avatar!==value)if(this._avatar=value,value)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,value);else{var parent=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,parent?parent._hierarchyAnimator._avatar:null)}}),__getset(0,__proto,"speed",function(){return this._speed},function(value){this._speed=value}),Animator._update=function(scene){for(var pool=scene._animatorPool,elements=pool.elements,i=0,n=pool.length;i<n;i++){var animator=elements[i];animator&&animator.enabled&&animator._update()}},Animator._tempVector3Array0=new Float32Array(3),Animator._tempVector3Array1=new Float32Array(3),Animator._tempQuaternionArray0=new Float32Array(4),Animator._tempQuaternionArray1=new Float32Array(4),Animator.CULLINGMODE_ALWAYSANIMATE=0,Animator.CULLINGMODE_CULLCOMPLETELY=2,Animator}(Component),ShaderPass=(function(_super){function ConstraintComponent(){this._nativeConstraint=null,this._breakingImpulseThreshold=NaN,this._connectedBody=null,this._feedbackEnabled=!1,ConstraintComponent.__super.call(this)}__class(ConstraintComponent,"laya.d3.physics.constraints.ConstraintComponent",Component);var __proto=ConstraintComponent.prototype;__proto._onDestroy=function(){Laya3D._physics3D.destroy(this._nativeConstraint),this._nativeConstraint=null},__getset(0,__proto,"breakingImpulseThreshold",function(){return this._breakingImpulseThreshold},function(value){this._nativeConstraint.BreakingImpulseThreshold=value,this._breakingImpulseThreshold=value}),__getset(0,__proto,"enabled",function(){return Laya.superGet(Component,this,"enabled")},function(value){this._nativeConstraint.IsEnabled=value,Laya.superSet(Component,this,"enabled",value)}),__getset(0,__proto,"appliedImpulse",function(){return this._feedbackEnabled||(this._nativeConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._nativeConstraint.AppliedImpulse}),__getset(0,__proto,"connectedBody",function(){return this._connectedBody},function(value){this._connectedBody=value})}(),function(_super){function ShaderPass(owner,vs,ps){this._renderState=new RenderState,this._owner=owner,this._cacheSharders=[],this._publicValidDefine=0,this._spriteValidDefine=0,this._materialValidDefine=0,this._validDefineMap={},ShaderPass.__super.call(this,vs,ps,null,this._validDefineMap);var publicDefineMap=this._owner._publicDefinesMap,spriteDefineMap=this._owner._spriteDefinesMap,materialDefineMap=this._owner._materialDefinesMap;for(var k in this._validDefineMap)null!=publicDefineMap[k]?this._publicValidDefine|=publicDefineMap[k]:null!=spriteDefineMap[k]?this._spriteValidDefine|=spriteDefineMap[k]:null!=materialDefineMap[k]&&(this._materialValidDefine|=materialDefineMap[k])}__class(ShaderPass,"laya.d3.shader.ShaderPass",ShaderCompile);var __proto=ShaderPass.prototype;return __proto._definesToNameDic=function(value,int2Name){for(var o={},d=1,i=0;i<32&&!((d=1<<i)>value);i++){value&d&&(o[int2Name[d]]="")}return o},__proto._compileToTree=function(parent,lines,start,includefiles,defs){var node,preNode,text,name,fname,words,noUseNode,ofs=0,i=0,n=0,j=0;for(i=start;i<lines.length;i++)if(!((text=lines[i]).length<1)&&0!==(ofs=text.indexOf("//"))){if(ofs>=0&&(text=text.substr(0,ofs)),node=noUseNode||new ShaderNode(includefiles),noUseNode=null,node.text=text,(ofs=text.indexOf("#"))>=0){for(name="#",j=ofs+1,n=text.length;j<n;j++){var c=text.charAt(j);if(" "===c||"\t"===c||"?"===c)break;name+=c}switch(node.name=name,name){case"#ifdef":case"#ifndef":if(node.setParent(parent),parent=node,defs)for(words=text.substr(j).split(ShaderCompile._splitToWordExps3),j=0;j<words.length;j++)(text=words[j]).length&&(defs[text]=!0);continue;case"#if":case"#elif":if(node.setParent(parent),parent=node,defs)for(words=text.substr(j).split(ShaderCompile._splitToWordExps3),j=0;j<words.length;j++)(text=words[j]).length&&"defined"!=text&&(defs[text]=!0);continue;case"#else":preNode=(parent=parent.parent).childs[parent.childs.length-1],node.setParent(parent),parent=node;continue;case"#endif":preNode=(parent=parent.parent).childs[parent.childs.length-1],node.setParent(parent);continue;case"#include":words=ShaderCompile.splitToWords(text,null);var inlcudeFile=ShaderCompile.includes[words[1]];if(!inlcudeFile)throw"ShaderCompile error no this include file:"+words[1];if((ofs=words[0].indexOf("?"))<0){node.setParent(parent),text=inlcudeFile.getWith("with"==words[2]?words[3]:null),this._compileToTree(node,text.split("\n"),0,includefiles,defs),node.text="";continue}node.setCondition(words[0].substr(ofs+1),1),node.text=inlcudeFile.getWith("with"==words[2]?words[3]:null);break;case"#import":fname=(words=ShaderCompile.splitToWords(text,null))[1],includefiles.push({node:node,file:ShaderCompile.includes[fname],ofs:node.text.length});continue}}else{if((preNode=parent.childs[parent.childs.length-1])&&!preNode.name){includefiles.length>0&&ShaderCompile.splitToWords(text,preNode),noUseNode=node,preNode.text+="\n"+text;continue}includefiles.length>0&&ShaderCompile.splitToWords(text,node)}node.setParent(parent)}},__proto.withCompile=function(publicDefine,spriteDefine,materialDefine){var shader,spriteDefShaders,materialDefShaders;if(publicDefine&=this._publicValidDefine,spriteDefine&=this._spriteValidDefine,materialDefine&=this._materialValidDefine,spriteDefShaders=this._cacheSharders[publicDefine])if(materialDefShaders=spriteDefShaders[spriteDefine]){if(shader=materialDefShaders[materialDefine])return shader}else materialDefShaders=spriteDefShaders[spriteDefine]=[];else materialDefShaders=(spriteDefShaders=this._cacheSharders[publicDefine]=[])[spriteDefine]=[];var key,publicDefGroup=this._definesToNameDic(publicDefine,this._owner._publicDefines),spriteDefGroup=this._definesToNameDic(spriteDefine,this._owner._spriteDefines),materialDefGroup=this._definesToNameDic(materialDefine,this._owner._materialDefines);if(Shader3D.debugMode){var publicDefGroupStr="";for(key in publicDefGroup)publicDefGroupStr+=key+" ";var spriteDefGroupStr="";for(key in spriteDefGroup)spriteDefGroupStr+=key+" ";var materialDefGroupStr="";for(key in materialDefGroup)materialDefGroupStr+=key+" ";WebGL.shaderHighPrecision||(publicDefine+=Shader3D.SHADERDEFINE_HIGHPRECISION),console.log("%cShader3DDebugMode---(Name:"+this._owner._owner._name+" PassIndex:"+this._owner._passes.indexOf(this)+" PublicDefine:"+publicDefine+" SpriteDefine:"+spriteDefine+" MaterialDefine:"+materialDefine+" PublicDefineGroup:"+publicDefGroupStr+" SpriteDefineGroup:"+spriteDefGroupStr+"MaterialDefineGroup: "+materialDefGroupStr+")---ShaderCompile3DDebugMode","color:green")}var defMap={},defineStr="";if(publicDefGroup)for(key in publicDefGroup)defineStr+="#define "+key+"\n",defMap[key]=!0;if(spriteDefGroup)for(key in spriteDefGroup)defineStr+="#define "+key+"\n",defMap[key]=!0;if(materialDefGroup)for(key in materialDefGroup)defineStr+="#define "+key+"\n",defMap[key]=!0;var vs=this._VS.toscript(defMap,[]),vsVersion="";0==vs[0].indexOf("#version")&&(vsVersion=vs[0]+"\n",vs.shift());var ps=this._PS.toscript(defMap,[]),psVersion="";return 0==ps[0].indexOf("#version")&&(psVersion=ps[0]+"\n",ps.shift()),shader=new ShaderInstance(vsVersion+defineStr+vs.join("\n"),psVersion+defineStr+ps.join("\n"),this._owner._attributeMap,this._owner._uniformMap),materialDefShaders[materialDefine]=shader,shader},__getset(0,__proto,"renderState",function(){return this._renderState}),ShaderPass}()),SubMeshRenderElement=function(_super){function SubMeshRenderElement(){SubMeshRenderElement.__super.call(this),this._dynamicWorldPositionNormalNeedUpdate=!0}__class(SubMeshRenderElement,"laya.d3.core.render.SubMeshRenderElement",_super);var __proto=SubMeshRenderElement.prototype;return __proto._onWorldMatrixChanged=function(){this._dynamicWorldPositionNormalNeedUpdate=!0},__proto._computeWorldPositionsAndNormals=function(positionOffset,normalOffset,multiSubMesh,vertexCount){if(this._dynamicWorldPositionNormalNeedUpdate){for(var subMesh=this._geometry,vertexBuffer=subMesh._vertexBuffer,vertexFloatCount=vertexBuffer.vertexDeclaration.vertexStride/4,oriVertexes=vertexBuffer.getData(),worldMat=this._transform.worldMatrix,rotation=this._transform.rotation,indices=subMesh._indices,i=0;i<vertexCount;i++){var oriOffset=(multiSubMesh?indices[i]:i)*vertexFloatCount,bakeOffset=3*i;Utils3D.transformVector3ArrayToVector3ArrayCoordinate(oriVertexes,oriOffset+positionOffset,worldMat,this._dynamicWorldPositions,bakeOffset),-1!==normalOffset&&Utils3D.transformVector3ArrayByQuat(oriVertexes,oriOffset+normalOffset,rotation,this._dynamicWorldNormals,bakeOffset)}this._dynamicWorldPositionNormalNeedUpdate=!1}},__proto.setTransform=function(transform){this._transform!==transform&&(this._transform&&this._transform.off("transformchanged",this,this._onWorldMatrixChanged),transform&&transform.on("transformchanged",this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=transform)},__proto.setGeometry=function(geometry){if(this._geometry!==geometry){var subMesh=geometry,mesh=subMesh._mesh;if(mesh){var multiSubMesh=mesh._subMeshCount>1,dynBatVerCount=multiSubMesh?subMesh._indexCount:mesh._vertexCount;if(dynBatVerCount<=10){var length=3*dynBatVerCount;this._dynamicBatch=!0,this._dynamicWorldPositions=new Float32Array(length),this._dynamicWorldNormals=new Float32Array(length),this._dynamicVertexCount=dynBatVerCount,this._dynamicMultiSubMesh=multiSubMesh}else this._dynamicBatch=!1}this._geometry=geometry}},__proto.addToOpaqueRenderQueue=function(context,queue){var subMeshStaticBatch=this.staticBatch,elements=queue.elements;if(subMeshStaticBatch){var staManager=MeshRenderStaticBatchManager.instance,staLightIndex=this.render.lightmapIndex+1,staLightMapMarks=staManager._opaqueBatchMarks[staLightIndex]||(staManager._opaqueBatchMarks[staLightIndex]=[]),staReceiveShadowMarks=staLightMapMarks[this.render.receiveShadow?0:1]||(staLightMapMarks[this.render.receiveShadow?0:1]=[]),staMaterialMarks=staReceiveShadowMarks[this.material.id]||(staReceiveShadowMarks[this.material.id]=[]),staBatchMarks=staMaterialMarks[subMeshStaticBatch._batchID]||(staMaterialMarks[subMeshStaticBatch._batchID]=new Array(3));if(staManager._updateCountMark===staBatchMarks[0]){var staBatchIndex=staBatchMarks[1];if(staBatchMarks[2])elements[staBatchIndex].staticBatchElementList.push(this);else{var staOriElement=elements[staBatchIndex],staOriRender=staOriElement.render,staBatchElement=staManager._getBatchRenderElementFromPool();staBatchElement.setGeometry(subMeshStaticBatch),staBatchElement.material=staOriElement.material;var staRootOwner=subMeshStaticBatch.batchOwner._owner,staBatchTransform=staRootOwner?staRootOwner._transform:null;staBatchElement.setTransform(staBatchTransform);var staBatchRender=subMeshStaticBatch.batchOwner._getBatchRender(context,staOriRender.lightmapIndex,staOriRender.receiveShadow);staBatchRender._setBelongScene(context.scene),staBatchRender._distanceForSort=staOriRender._distanceForSort,staBatchElement.render=staBatchRender;var staBatchList=staBatchElement.staticBatchElementList;staBatchList.length=0,staBatchList.push(staOriElement),staBatchList.push(this),elements[staBatchIndex]=staBatchElement,staBatchMarks[2]=!0}}else staBatchMarks[0]=staManager._updateCountMark,staBatchMarks[1]=elements.length,staBatchMarks[2]=!1,elements.push(this)}else if(this._dynamicBatch){var verDec=this._geometry._vertexBuffer.vertexDeclaration,dynManager=MeshRenderDynamicBatchManager.instance,dynLightIndex=this.render.lightmapIndex+1,dynLightMapMarks=dynManager._opaqueBatchMarks[dynLightIndex]||(dynManager._opaqueBatchMarks[dynLightIndex]=[]),dynReceiveShadowMarks=dynLightMapMarks[this.render.receiveShadow?0:1]||(dynLightMapMarks[this.render.receiveShadow?0:1]=[]),dynMaterialMarks=dynReceiveShadowMarks[this.material.id]||(dynReceiveShadowMarks[this.material.id]=[]),dynBatchMarks=dynMaterialMarks[verDec.id]||(dynMaterialMarks[verDec.id]=new Array(3));if(dynManager._updateCountMark===dynBatchMarks[0]){var dynBatchIndex=dynBatchMarks[1];if(dynBatchMarks[2])elements[dynBatchIndex].dynamicBatchElementList.push(this);else{var dynOriElement=elements[dynBatchIndex],dynOriRender=dynOriElement.render,dynBatchElement=dynManager._getBatchRenderElementFromPool();dynBatchElement.setGeometry(SubMeshDynamicBatch.instance),dynBatchElement.material=dynOriElement.material,dynBatchElement.setTransform(null);var dynBatchRender=dynManager._getBatchRender(dynOriRender.lightmapIndex,dynOriRender.receiveShadow);dynBatchRender._setBelongScene(context.scene),dynBatchRender._distanceForSort=dynOriRender._distanceForSort,dynBatchElement.render=dynBatchRender,dynBatchElement.dynamicVertexDeclaration=verDec;var dynBatchList=dynBatchElement.dynamicBatchElementList;dynBatchList.length=0,dynBatchList.push(dynOriElement),dynBatchList.push(this),elements[dynBatchIndex]=dynBatchElement,dynBatchMarks[2]=!0}}else dynBatchMarks[0]=dynManager._updateCountMark,dynBatchMarks[1]=elements.length,dynBatchMarks[2]=!1,elements.push(this)}else elements.push(this)},__proto.addToTransparentRenderQueue=function(context,queue){var subMeshStaticBatch=this.staticBatch,elements=queue.elements;if(subMeshStaticBatch){var staManager=MeshRenderStaticBatchManager.instance,staLastElement=queue.lastTransparentRenderElement;if(staLastElement){var staLastRender=staLastElement.render;if(staLastElement._geometry._getType()!==this._geometry._getType()||staLastElement.staticBatch!==subMeshStaticBatch||staLastElement.material!==this.material||staLastRender.receiveShadow!==this.render.receiveShadow||staLastRender.lightmapIndex!==this.render.lightmapIndex)elements.push(this),queue.lastTransparentBatched=!1;else{if(queue.lastTransparentBatched)elements[elements.length-1].staticBatchElementList.push(this);else{var staBatchElement=staManager._getBatchRenderElementFromPool();staBatchElement.setGeometry(subMeshStaticBatch),staBatchElement.material=staLastElement.material;var staRootOwner=subMeshStaticBatch.batchOwner._owner,staBatchTransform=staRootOwner?staRootOwner._transform:null;staBatchElement.setTransform(staBatchTransform);var staBatchRender=subMeshStaticBatch.batchOwner._getBatchRender(context,staLastRender.lightmapIndex,staLastRender.receiveShadow);staBatchRender._setBelongScene(context.scene),staBatchRender._distanceForSort=staLastRender._distanceForSort,staBatchElement.render=staBatchRender;var staBatchList=staBatchElement.staticBatchElementList;staBatchList.length=0,staBatchList.push(staLastElement),staBatchList.push(this),elements[elements.length-1]=staBatchElement}queue.lastTransparentBatched=!0}}else elements.push(this),queue.lastTransparentBatched=!1}else if(this._dynamicBatch){var verDec=this._geometry._vertexBuffer.vertexDeclaration,dynManager=MeshRenderDynamicBatchManager.instance,dynLastElement=queue.lastTransparentRenderElement;if(dynLastElement){var dynLastRender=dynLastElement.render;if(dynLastElement._geometry._getType()!==this._geometry._getType()||dynLastElement._geometry._vertexBuffer._vertexDeclaration!==verDec||dynLastElement.material!==this.material||dynLastRender.receiveShadow!==this.render.receiveShadow||dynLastRender.lightmapIndex!==this.render.lightmapIndex)elements.push(this),queue.lastTransparentBatched=!1;else{if(queue.lastTransparentBatched)elements[elements.length-1].dynamicBatchElementList.push(this);else{var dynBatchElement=dynManager._getBatchRenderElementFromPool();dynBatchElement.setGeometry(SubMeshDynamicBatch.instance),dynBatchElement.material=dynLastElement.material,dynBatchElement.setTransform(null);var dynBatchRender=dynManager._getBatchRender(dynLastRender.lightmapIndex,dynLastRender.receiveShadow);dynBatchRender._setBelongScene(context.scene),dynBatchRender._distanceForSort=dynLastRender._distanceForSort,dynBatchElement.render=dynBatchRender,dynBatchElement.dynamicVertexDeclaration=verDec;var dynBatchList=dynBatchElement.dynamicBatchElementList;dynBatchList.length=0,dynBatchList.push(dynLastElement),dynBatchList.push(this),elements[elements.length-1]=dynBatchElement}queue.lastTransparentBatched=!0}}else elements.push(this),queue.lastTransparentBatched=!1}else elements.push(this);queue.lastTransparentRenderElement=this},__proto.destroy=function(){_super.prototype.destroy.call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.skinnedDatas=null,this.staticBatch=null,this.staticBatchElementList=null,this.dynamicBatchElementList=null,this.dynamicVertexDeclaration=null},SubMeshRenderElement}(RenderElement),BufferState=function(_super){function BufferState(){BufferState.__super.call(this)}__class(BufferState,"laya.d3.core.BufferState",BufferStateBase);var __proto=BufferState.prototype;return __proto.applyVertexBuffer=function(vertexBuffer){if(BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var gl=LayaGL.instance,verDec=vertexBuffer.vertexDeclaration,valueData=null;for(var k in valueData=Render.isConchApp?verDec._shaderValues._nativeArray:verDec._shaderValues._data,vertexBuffer.bind(),valueData){var loc=parseInt(k),attribute=valueData[k];gl.enableVertexAttribArray(loc),gl.vertexAttribPointer(loc,attribute[0],attribute[1],!!attribute[2],attribute[3],attribute[4])}},__proto.applyVertexBuffers=function(vertexBuffers){if(BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var gl=LayaGL.instance,i=0,n=vertexBuffers.length;i<n;i++){var verBuf=vertexBuffers[i],verDec=verBuf.vertexDeclaration,valueData=null;for(var k in valueData=Render.isConchApp?verDec._shaderValues._nativeArray:verDec._shaderValues._data,verBuf.bind(),valueData){var loc=parseInt(k),attribute=valueData[k];gl.enableVertexAttribArray(loc),gl.vertexAttribPointer(loc,attribute[0],attribute[1],!!attribute[2],attribute[3],attribute[4])}}},__proto.applyIndexBuffer=function(indexBuffer){if(BufferStateBase._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==indexBuffer&&(indexBuffer._bindForVAO(),this._bindedIndexBuffer=indexBuffer)},BufferState}(),BoxColliderShape=function(_super){function BoxColliderShape(sizeX,sizeY,sizeZ){BoxColliderShape.__super.call(this),void 0===sizeX&&(sizeX=1),void 0===sizeY&&(sizeY=1),void 0===sizeZ&&(sizeZ=1),this._sizeX=sizeX,this._sizeY=sizeY,this._sizeZ=sizeZ,this._type=0,BoxColliderShape._nativeSize.setValue(sizeX/2,sizeY/2,sizeZ/2),this._nativeShape=new Laya3D._physics3D.btBoxShape(BoxColliderShape._nativeSize)}__class(BoxColliderShape,"laya.d3.physics.shape.BoxColliderShape",ColliderShape);var __proto=BoxColliderShape.prototype;return __proto.clone=function(){var dest=new BoxColliderShape(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(dest),dest},__getset(0,__proto,"sizeX",function(){return this._sizeX}),__getset(0,__proto,"sizeY",function(){return this._sizeY}),__getset(0,__proto,"sizeZ",function(){return this._sizeZ}),__static(BoxColliderShape,["_nativeSize",function(){return this._nativeSize=new Laya3D._physics3D.btVector3(0,0,0)}]),BoxColliderShape}(),MeshColliderShape=function(_super){function MeshColliderShape(){this._mesh=null,this._convex=!1,MeshColliderShape.__super.call(this)}__class(MeshColliderShape,"laya.d3.physics.shape.MeshColliderShape",_super);var __proto=MeshColliderShape.prototype;return __proto._setScale=function(value){if(this._compoundParent)this.updateLocalTransformations();else{var valueE=value.elements;ColliderShape._nativeScale.setValue(valueE[0],valueE[1],valueE[2]),this._nativeShape.setLocalScaling(ColliderShape._nativeScale),this._nativeShape.updateBound()}},__proto.cloneTo=function(destObject){var destMeshCollider=destObject;destMeshCollider.convex=this._convex,destMeshCollider.mesh=this._mesh,_super.prototype.cloneTo.call(this,destObject)},__proto.clone=function(){var dest=new MeshColliderShape;return this.cloneTo(dest),dest},__proto.destroy=function(){this._nativeShape&&(Laya3D._physics3D.destroy(this._nativeShape),this._nativeShape=null)},__getset(0,__proto,"mesh",function(){return this._mesh},function(value){if(this._mesh!==value){var physics3D=Laya3D._physics3D;this._mesh&&physics3D.destroy(this._nativeShape),value&&(this._nativeShape=new physics3D.btGImpactMeshShape(value._getPhysicMesh()),this._nativeShape.updateBound()),this._mesh=value}}),__getset(0,__proto,"convex",function(){return this._convex},function(value){this._convex=value}),MeshColliderShape}(ColliderShape),FloatKeyframe=function(_super){function FloatKeyframe(){FloatKeyframe.__super.call(this)}return __class(FloatKeyframe,"laya.d3.core.FloatKeyframe",_super),FloatKeyframe.prototype.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destKeyFrame=destObject;destKeyFrame.inTangent=this.inTangent,destKeyFrame.outTangent=this.outTangent,destKeyFrame.value=this.value},FloatKeyframe}(Keyframe),TerrainFilter=function(_super){function TerrainFilter(owner,chunkOffsetX,chunkOffsetZ,gridSize,terrainHeightData,heightDataWidth,heightDataHeight,cameraCoordinateInverse){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,this._boundingSphere=null,this._boundingBox=null,TerrainFilter.__super.call(this),this._bufferState=new BufferState,this._owner=owner,this._cameraPos=new Vector3,this._chunkOffsetX=chunkOffsetX,this._chunkOffsetZ=chunkOffsetZ,this._gridSize=gridSize,this._terrainHeightData=terrainHeightData,this._terrainHeightDataWidth=heightDataWidth,this._terrainHeightDataHeight=heightDataHeight,this._leafNum=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM),this._leafs=__newvec(this._leafNum),this._cameraCoordinateInverse=cameraCoordinateInverse;for(var i=0;i<this._leafNum;i++)this._leafs[i]=new TerrainLeaf;this.recreateResource()}__class(TerrainFilter,"laya.d3.terrain.TerrainFilter",GeometryElement);var __proto=TerrainFilter.prototype;return __proto.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var nLeafVertexCount=TerrainLeaf.LEAF_VERTEXT_COUNT,nLeafIndexCount=TerrainLeaf.LEAF_MAX_INDEX_COUNT;this._numberVertices=nLeafVertexCount*this._leafNum,this._maxNumberIndices=nLeafIndexCount*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var vertexDeclaration=VertexPositionTerrain.vertexDeclaration,vertexFloatStride=vertexDeclaration.vertexStride/4,vertices=new Float32Array(this._numberVertices*vertexFloatStride),nNum=TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM,i=0,x=0,z=0;for(i=0;i<this._leafNum;i++)x=i%nNum,z=Math.floor(i/nNum),this._leafs[i].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,x*TerrainLeaf.LEAF_GRID_NUM,z*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,vertices,i*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT,vertexFloatStride,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(i=0;i<this._leafNum;i++)x=i%nNum,z=Math.floor(i/nNum),this._leafs[i].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,x*TerrainLeaf.LEAF_GRID_NUM,z*TerrainLeaf.LEAF_GRID_NUM,this._gridSize,vertices,this._leafNum*TerrainLeaf.LEAF_PLANE_VERTEXT_COUNT+i*TerrainLeaf.LEAF_SKIRT_VERTEXT_COUNT,vertexFloatStride,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new VertexBuffer3D(vertexDeclaration.vertexStride*this._numberVertices,35044,!1),this._vertexBuffer.vertexDeclaration=vertexDeclaration,this._indexBuffer=new IndexBuffer3D("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(vertices),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere(),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()},__proto.setLODLevel=function(leafsLODLevel){if(4!=leafsLODLevel.length)return!0;var nLOD=(leafsLODLevel[0]+1<<24)+(leafsLODLevel[1]+1<<16)+(leafsLODLevel[2]+1<<8)+(leafsLODLevel[3]+1);return this._currentLOD!=nLOD&&(this._currentLOD=nLOD,!0)},__proto.assembleIndexInit=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var nOffsetIndex=0,i=0;i<this._leafNum;i++){var planeLODIndex=TerrainLeaf.getPlaneLODIndex(i,0);this._indexArrayBuffer.set(planeLODIndex,nOffsetIndex),nOffsetIndex+=planeLODIndex.length;var skirtLODIndex=TerrainLeaf.getSkirtLODIndex(i,0);this._indexArrayBuffer.set(skirtLODIndex,nOffsetIndex),nOffsetIndex+=skirtLODIndex.length,this._currentNumberIndices+=planeLODIndex.length+skirtLODIndex.length}this._numberTriangle=this._currentNumberIndices/3},__proto.isNeedAssemble=function(camera,cameraPostion){var perspectiveFactor=Math.min(camera.viewport.width,camera.viewport.height)/(2*Math.tan(Math.PI*camera.fieldOfView/180));return this._perspectiveFactor!=perspectiveFactor?(this._perspectiveFactor=perspectiveFactor,1):this._LODTolerance!=Terrain.LOD_TOLERANCE_VALUE?(this._LODTolerance=Terrain.LOD_TOLERANCE_VALUE,1):0==Vector3.equals(cameraPostion,this._cameraPos)?(this._cameraPos.x=cameraPostion.x,this._cameraPos.y=cameraPostion.y,this._cameraPos.z=cameraPostion.z,2):0},__proto.assembleIndex=function(camera,cameraPostion){var nNeedType=this.isNeedAssemble(camera,cameraPostion);if(nNeedType>0){for(var i=0;i<this._leafNum;i++)TerrainFilter._TEMP_ARRAY_BUFFER[i]=this._leafs[i].determineLod(cameraPostion,this._perspectiveFactor,Terrain.LOD_TOLERANCE_VALUE,1==nNeedType);if(this.setLODLevel(TerrainFilter._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0,this._numberTriangle=0;var nOffsetIndex=0;for(i=0;i<this._leafNum;i++){var nLODLevel=TerrainFilter._TEMP_ARRAY_BUFFER[i],planeLODIndex=TerrainLeaf.getPlaneLODIndex(i,nLODLevel);this._indexArrayBuffer.set(planeLODIndex,nOffsetIndex),nOffsetIndex+=planeLODIndex.length;var skirtLODIndex=TerrainLeaf.getSkirtLODIndex(i,nLODLevel);this._indexArrayBuffer.set(skirtLODIndex,nOffsetIndex),nOffsetIndex+=skirtLODIndex.length,this._currentNumberIndices+=planeLODIndex.length+skirtLODIndex.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},__proto.calcOriginalBoudingBoxAndSphere=function(){for(var sizeOfY=new Vector2(2147483647,-2147483647),i=0;i<this._leafNum;i++)sizeOfY.x=this._leafs[i]._sizeOfY.x<sizeOfY.x?this._leafs[i]._sizeOfY.x:sizeOfY.x,sizeOfY.y=this._leafs[i]._sizeOfY.y>sizeOfY.y?this._leafs[i]._sizeOfY.y:sizeOfY.y;var min=new Vector3(this._chunkOffsetX*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,sizeOfY.x,this._chunkOffsetZ*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize),max=new Vector3((this._chunkOffsetX+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize,sizeOfY.y,(this._chunkOffsetZ+1)*TerrainLeaf.CHUNK_GRID_NUM*this._gridSize);TerrainLeaf.__ADAPT_MATRIX__&&(Vector3.transformV3ToV3(min,TerrainLeaf.__ADAPT_MATRIX__,min),Vector3.transformV3ToV3(max,TerrainLeaf.__ADAPT_MATRIX__,max)),this._boundingBox=new BoundBox(min,max);var size=new Vector3;Vector3.subtract(max,min,size),Vector3.scale(size,.5,size);var center=new Vector3;Vector3.add(min,size,center),this._boundingSphere=new BoundSphere(center,Vector3.scalarLength(size)),this._boundingBoxCorners=__newvec(8,null),this._boundingBox.getCorners(this._boundingBoxCorners)},__proto.calcLeafBoudingBox=function(worldMatrix){for(var i=0;i<this._leafNum;i++)this._leafs[i].calcLeafBoudingBox(worldMatrix)},__proto.calcLeafBoudingSphere=function(worldMatrix,maxScale){for(var i=0;i<this._leafNum;i++)this._leafs[i].calcLeafBoudingSphere(worldMatrix,maxScale)},__proto._getVertexBuffer=function(index){return void 0===index&&(index=0),0==index?this._vertexBuffer:null},__proto._getIndexBuffer=function(){return this._indexBuffer},__proto._getType=function(){return TerrainFilter._type},__proto._prepareRender=function(state){if(0==state.renderElement.material.getRenderState(0).blend){var camera=state.camera;this.assembleIndex(camera,camera.transform.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},__proto._render=function(state){this._bufferState.bind(),LayaGL.instance.drawElements(Terrain.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),Stat.trianglesFaces+=this._numberTriangle,Stat.renderBatch++},__proto.destroy=function(){this._owner=null,this._bufferState.destroy(),this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy()},__static(TerrainFilter,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM*TerrainLeaf.CHUNK_GRID_NUM/TerrainLeaf.LEAF_GRID_NUM)},"_type",function(){return this._type=GeometryElement._typeCounter++}]),TerrainFilter}(),PixelLineFilter=function(_super){function PixelLineFilter(owner,maxLineCount){this._floatCountPerVertices=7,this._owner=null,this._vertexBuffer=null,this._vertices=null,this._maxLineCount=0,this._lineCount=0,PixelLineFilter.__super.call(this),this._bufferState=new BufferState;var pointCount=2*maxLineCount;this._owner=owner,this._maxLineCount=maxLineCount,this._vertices=new Float32Array(pointCount*this._floatCountPerVertices),this._vertexBuffer=new VertexBuffer3D(PixelLineVertex.vertexDeclaration.vertexStride*pointCount,35044,!1),this._vertexBuffer.vertexDeclaration=PixelLineVertex.vertexDeclaration,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()}__class(PixelLineFilter,"laya.d3.core.pixelLine.PixelLineFilter",_super);var __proto=PixelLineFilter.prototype;return __proto._resizeLineData=function(maxCount){var pointCount=2*maxCount,lastVertices=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=maxCount;var vertexCount=pointCount*this._floatCountPerVertices;this._vertices=new Float32Array(vertexCount),this._vertexBuffer=new VertexBuffer3D(PixelLineVertex.vertexDeclaration.vertexStride*pointCount,35044,!1),this._vertexBuffer.vertexDeclaration=PixelLineVertex.vertexDeclaration,vertexCount<lastVertices.length?(this._vertices.set(new Float32Array(lastVertices.buffer,0,vertexCount)),this._vertexBuffer.setData(this._vertices,0,0,vertexCount)):(this._vertices.set(lastVertices),this._vertexBuffer.setData(this._vertices,0,0,lastVertices.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind()},__proto._updateLineVertices=function(offset,startPosition,endPosition,startColor,endColor){var startPositione=startPosition.elements,endPositione=endPosition.elements,startColore=startColor.elements,endColore=endColor.elements;this._vertices[offset+0]=startPositione[0],this._vertices[offset+1]=startPositione[1],this._vertices[offset+2]=startPositione[2],this._vertices[offset+3]=startColore[0],this._vertices[offset+4]=startColore[1],this._vertices[offset+5]=startColore[2],this._vertices[offset+6]=startColore[3],this._vertices[offset+7]=endPositione[0],this._vertices[offset+8]=endPositione[1],this._vertices[offset+9]=endPositione[2],this._vertices[offset+10]=endColore[0],this._vertices[offset+11]=endColore[1],this._vertices[offset+12]=endColore[2],this._vertices[offset+13]=endColore[3]},__proto._removeLineData=function(index){var floatCount=2*this._floatCountPerVertices,nextIndex=index+1,offset=index*floatCount,rightPartVertices=new Float32Array(this._vertices.buffer,nextIndex*floatCount*4,(this._lineCount-nextIndex)*floatCount);this._vertexBuffer.setData(rightPartVertices,offset),this._vertices.set(rightPartVertices,offset),this._lineCount--},__proto._updateLineData=function(index,startPosition,endPosition,startColor,endColor){var floatCount=2*this._floatCountPerVertices,offset=index*floatCount;this._updateLineVertices(offset,startPosition,endPosition,startColor,endColor),this._vertexBuffer.setData(this._vertices,offset,offset,floatCount)},__proto._updateLineDatas=function(index,data){for(var floatCount=2*this._floatCountPerVertices,offset=index*floatCount,count=data.length,i=0;i<count;i++){var line=data[i];this._updateLineVertices((index+i)*floatCount,line.startPosition,line.endPosition,line.startColor,line.endColor)}this._vertexBuffer.setData(this._vertices,offset,offset,floatCount*count)},__proto._getLineData=function(index,out){var startPosition=out.startPosition.elements,startColor=out.startColor.elements,endPosition=out.endPosition.elements,endColor=out.endColor.elements,vertices=this._vertices,offset=index*this._floatCountPerVertices*2;startPosition[0]=vertices[offset+0],startPosition[1]=vertices[offset+1],startPosition[2]=vertices[offset+2],startColor[0]=vertices[offset+0],startColor[1]=vertices[offset+1],startColor[2]=vertices[offset+2],startColor[3]=vertices[offset+3],endPosition[0]=vertices[offset+0],endPosition[1]=vertices[offset+1],endPosition[2]=vertices[offset+2],endColor[0]=vertices[offset+0],endColor[1]=vertices[offset+1],endColor[2]=vertices[offset+2],endColor[3]=vertices[offset+3]},__proto._prepareRender=function(state){return!0},__proto._render=function(state){this._lineCount>0&&(this._bufferState.bind(),LayaGL.instance.drawArrays(1,0,2*this._lineCount),Stat.renderBatch++)},__proto.destroy=function(){this._destroyed||(_super.prototype.destroy.call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null)},PixelLineFilter}(GeometryElement),HemisphereShape=function(_super){function HemisphereShape(){this.radius=NaN,this.emitFromShell=!1,HemisphereShape.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(HemisphereShape,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",_super);var __proto=HemisphereShape.prototype;return __proto._getShapeBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[1]=minE[2]=-this.radius;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=this.radius,maxE[2]=0},__proto._getSpeedBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[1]=-1,minE[2]=0;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=maxE[2]=1},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){var rpE=position.elements;rand?(rand.seed=randomSeeds[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(position,rand):ShapeUtils._randomPointInsideUnitSphere(position,rand),randomSeeds[16]=rand.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(position):ShapeUtils._randomPointInsideUnitSphere(position),Vector3.scale(position,this.radius,position);var z=rpE[2];z<0&&(rpE[2]=-1*z),this.randomDirection?rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction):position.cloneTo(direction)},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destShape=destObject;destShape.radius=this.radius,destShape.emitFromShell=this.emitFromShell,destShape.randomDirection=this.randomDirection},HemisphereShape}(BaseShape),CapsuleColliderShape=function(_super){function CapsuleColliderShape(radius,length,orientation){switch(CapsuleColliderShape.__super.call(this),void 0===radius&&(radius=.5),void 0===length&&(length=1.25),void 0===orientation&&(orientation=1),this._radius=radius,this._length=length,this._orientation=orientation,this._type=3,orientation){case 0:this._nativeShape=new Laya3D._physics3D.btCapsuleShapeX(radius,length-2*radius);break;case 1:this._nativeShape=new Laya3D._physics3D.btCapsuleShape(radius,length-2*radius);break;case 2:this._nativeShape=new Laya3D._physics3D.btCapsuleShapeZ(radius,length-2*radius);break;default:throw"CapsuleColliderShape:unknown orientation."}}__class(CapsuleColliderShape,"laya.d3.physics.shape.CapsuleColliderShape",_super);var __proto=CapsuleColliderShape.prototype;return __proto._setScale=function(value){var fixScale=CapsuleColliderShape._tempVector30,valueE=value.elements,fixScaleE=fixScale.elements;switch(this.orientation){case 0:fixScaleE[0]=valueE[0],fixScaleE[1]=fixScaleE[2]=Math.max(valueE[1],valueE[2]);break;case 1:fixScaleE[1]=valueE[1],fixScaleE[0]=fixScaleE[2]=Math.max(valueE[0],valueE[2]);break;case 2:fixScaleE[2]=valueE[2],fixScaleE[0]=fixScaleE[1]=Math.max(valueE[0],valueE[1]);break;default:throw"CapsuleColliderShape:unknown orientation."}_super.prototype._setScale.call(this,fixScale)},__proto.clone=function(){var dest=new CapsuleColliderShape(this._radius,this._length,this._orientation);return this.cloneTo(dest),dest},__getset(0,__proto,"radius",function(){return this._radius}),__getset(0,__proto,"length",function(){return this._length}),__getset(0,__proto,"orientation",function(){return this._orientation}),__static(CapsuleColliderShape,["_tempVector30",function(){return this._tempVector30=new Vector3}]),CapsuleColliderShape}(ColliderShape),ConeColliderShape=function(_super){function ConeColliderShape(radius,height,orientation){switch(this._radius=1,this._height=.5,ConeColliderShape.__super.call(this),void 0===radius&&(radius=.5),void 0===height&&(height=1),void 0===orientation&&(orientation=1),this._radius=radius,this._height=height,this._orientation=orientation,this._type=2,orientation){case 0:this._nativeShape=new Laya3D._physics3D.btConeShapeX(radius,height);break;case 1:this._nativeShape=new Laya3D._physics3D.btConeShape(radius,height);break;case 2:this._nativeShape=new Laya3D._physics3D.btConeShapeZ(radius,height);break;default:throw"ConeColliderShape:unknown orientation."}}__class(ConeColliderShape,"laya.d3.physics.shape.ConeColliderShape",ColliderShape);var __proto=ConeColliderShape.prototype;return __proto.clone=function(){var dest=new ConeColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(dest),dest},__getset(0,__proto,"radius",function(){return this._radius}),__getset(0,__proto,"height",function(){return this._height}),__getset(0,__proto,"orientation",function(){return this._orientation}),ConeColliderShape}(),SubMesh=function(_super){function SubMesh(mesh){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._indexInMesh=0,this._vertexStart=0,this._indexStart=0,this._indexCount=0,this._indices=null,this._vertexBuffer=null,this._indexBuffer=null,SubMesh.__super.call(this),this._bufferState=new BufferState,this._mesh=mesh,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}__class(SubMesh,"laya.d3.resource.models.SubMesh",_super);var __proto=SubMesh.prototype;return __proto._getType=function(){return SubMesh._type},__proto._render=function(state){this._bufferState.bind();for(var skinAnimationDatas=state.renderElement.skinnedDatas,boneIndicesListCount=this._boneIndicesList.length,shader=state.shader,i=0;i<boneIndicesListCount;i++)skinAnimationDatas&&shader.uploadCustomUniform(SkinnedMeshSprite3D.BONES,skinAnimationDatas[i]),LayaGL.instance.drawElements(4,this._subIndexBufferCount[i],5123,2*this._subIndexBufferStart[i]);Stat.renderBatch++,Stat.trianglesFaces+=this._indexCount/3},__proto.getIndices=function(){return this._indices},__proto.destroy=function(){this._destroyed||(_super.prototype.destroy.call(this),this._bufferState.destroy(),this._indexBuffer.destroy(),this._bufferState=null,this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null)},__static(SubMesh,["_type",function(){return this._type=GeometryElement._typeCounter++}]),SubMesh}(GeometryElement),VertexBuffer3D=function(_super){function VertexBuffer3D(byteLength,bufferUsage,canRead,dateType){if(this._vertexCount=0,this._canRead=!1,this._dataType=0,this._vertexDeclaration=null,void 0===canRead&&(canRead=!1),void 0===dateType&&(dateType=0),VertexBuffer3D.__super.call(this),this._vertexCount=-1,this._bufferUsage=bufferUsage,this._bufferType=34962,this._canRead=canRead,this._dataType=dateType,this._byteLength=byteLength,this.bind(),LayaGL.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage),canRead)switch(dateType){case 0:this._buffer=new Float32Array(byteLength/4);break;case 1:this._buffer=new Uint8Array(byteLength)}}__class(VertexBuffer3D,"laya.d3.graphics.VertexBuffer3D",_super);var __proto=VertexBuffer3D.prototype;return __proto.bind=function(){return Buffer._bindedVertexBuffer!==this._glBuffer&&(LayaGL.instance.bindBuffer(34962,this._glBuffer),Buffer._bindedVertexBuffer=this._glBuffer,!0)},__proto.setData=function(data,bufferOffset,dataStartIndex,dataCount){if(void 0===bufferOffset&&(bufferOffset=0),void 0===dataStartIndex&&(dataStartIndex=0),void 0===dataCount&&(dataCount=4294967295),this.bind(),0!==dataStartIndex||4294967295!==dataCount)switch(this._dataType){case 0:data=new Float32Array(data.buffer,4*dataStartIndex,dataCount);break;case 1:data=new Uint8Array(data.buffer,dataStartIndex,dataCount)}switch(this._dataType){case 0:LayaGL.instance.bufferSubData(this._bufferType,4*bufferOffset,data);break;case 1:LayaGL.instance.bufferSubData(this._bufferType,bufferOffset,data)}this._canRead&&this._buffer.set(data,bufferOffset)},__proto.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},__proto.destroy=function(){_super.prototype.destroy.call(this),this._buffer=null,this._vertexDeclaration=null},__getset(0,__proto,"vertexDeclaration",function(){return this._vertexDeclaration},function(value){this._vertexDeclaration!==value&&(this._vertexDeclaration=value,this._vertexCount=value?this._byteLength/value.vertexStride:-1)}),__getset(0,__proto,"vertexCount",function(){return this._vertexCount}),__getset(0,__proto,"canRead",function(){return this._canRead}),VertexBuffer3D.DATATYPE_FLOAT32ARRAY=0,VertexBuffer3D.DATATYPE_UINT8ARRAY=1,VertexBuffer3D}(Buffer),CompoundColliderShape=function(_super){function CompoundColliderShape(){CompoundColliderShape.__super.call(this),this._childColliderShapes=[],this._type=5,this._nativeShape=new Laya3D._physics3D.btCompoundShape}__class(CompoundColliderShape,"laya.d3.physics.shape.CompoundColliderShape",_super);var __proto=CompoundColliderShape.prototype;return __proto._clearChildShape=function(shape){shape._attatched=!1,shape._compoundParent=null,shape._indexInCompound=-1},__proto._addReference=function(){},__proto._removeReference=function(){},__proto._updateChildTransform=function(shape){var offsetE=shape.localOffset.elements,rotationE=shape.localRotation.elements,nativeOffset=ColliderShape._nativeVector30,nativeQuaternion=ColliderShape._nativQuaternion0,nativeTransform=ColliderShape._nativeTransform0;nativeOffset.setValue(-offsetE[0],offsetE[1],offsetE[2]),nativeQuaternion.setValue(-rotationE[0],rotationE[1],rotationE[2],-rotationE[3]),nativeTransform.setOrigin(nativeOffset),nativeTransform.setRotation(nativeQuaternion),this._nativeShape.updateChildTransform(shape._indexInCompound,nativeTransform,!0)},__proto.addChildShape=function(shape){if(shape._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";shape._attatched=!0,shape._compoundParent=this,shape._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(shape);var offsetE=shape.localOffset.elements,rotationE=shape.localRotation.elements;CompoundColliderShape._nativeOffset.setValue(-offsetE[0],offsetE[1],offsetE[2]),CompoundColliderShape._nativRotation.setValue(-rotationE[0],rotationE[1],rotationE[2],-rotationE[3]),CompoundColliderShape._nativeTransform.setOrigin(CompoundColliderShape._nativeOffset),CompoundColliderShape._nativeTransform.setRotation(CompoundColliderShape._nativRotation);var nativeScale=this._nativeShape.getLocalScaling();this._nativeShape.setLocalScaling(CompoundColliderShape._nativeVector3One),this._nativeShape.addChildShape(CompoundColliderShape._nativeTransform,shape._nativeShape),this._nativeShape.setLocalScaling(nativeScale),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this)},__proto.removeChildShape=function(shape){if(shape._compoundParent===this){var index=shape._indexInCompound;this._clearChildShape(shape);var endShape=this._childColliderShapes[this._childColliderShapes.length-1];endShape._indexInCompound=index,this._childColliderShapes[index]=endShape,this._childColliderShapes.pop(),this._nativeShape.removeChildShapeByIndex(index)}},__proto.clearChildShape=function(){for(var i=0,n=this._childColliderShapes.length;i<n;i++)this._clearChildShape(this._childColliderShapes[i]),this._nativeShape.removeChildShapeByIndex(0);this._childColliderShapes.length=0},__proto.getChildShapeCount=function(){return this._childColliderShapes.length},__proto.cloneTo=function(destObject){var destCompoundColliderShape=destObject;destCompoundColliderShape.clearChildShape();for(var i=0,n=this._childColliderShapes.length;i<n;i++)destCompoundColliderShape.addChildShape(this._childColliderShapes[i].clone())},__proto.clone=function(){var dest=new CompoundColliderShape;return this.cloneTo(dest),dest},__proto.destroy=function(){_super.prototype.destroy.call(this);for(var i=0,n=this._childColliderShapes.length;i<n;i++){var childShape=this._childColliderShapes[i];0===childShape._referenceCount&&childShape.destroy()}},__static(CompoundColliderShape,["_nativeVector3One",function(){return this._nativeVector3One=new Laya3D._physics3D.btVector3(1,1,1)},"_nativeTransform",function(){return this._nativeTransform=new Laya3D._physics3D.btTransform},"_nativeOffset",function(){return this._nativeOffset=new Laya3D._physics3D.btVector3(0,0,0)},"_nativRotation",function(){return this._nativRotation=new Laya3D._physics3D.btQuaternion(0,0,0,1)}]),CompoundColliderShape}(ColliderShape),IndexBuffer3D=function(_super){function IndexBuffer3D(indexType,indexCount,bufferUsage,canRead){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===bufferUsage&&(bufferUsage=35044),void 0===canRead&&(canRead=!1),IndexBuffer3D.__super.call(this),this._indexType=indexType,this._indexCount=indexCount,this._bufferUsage=bufferUsage,this._bufferType=34963,this._canRead=canRead;var byteLength;if("ushort"==indexType)this._indexTypeByteCount=2;else{if("ubyte"!=indexType)throw new Error("unidentification index type.");this._indexTypeByteCount=1}byteLength=this._indexTypeByteCount*indexCount,this._byteLength=byteLength;var curBufSta=BufferStateBase._curBindedBufferState;curBufSta?curBufSta._bindedIndexBuffer===this?LayaGL.instance.bufferData(this._bufferType,byteLength,this._bufferUsage):(curBufSta.unBind(),this.bind(),LayaGL.instance.bufferData(this._bufferType,byteLength,this._bufferUsage),curBufSta.bind()):(this.bind(),LayaGL.instance.bufferData(this._bufferType,byteLength,this._bufferUsage)),canRead&&("ushort"==indexType?this._buffer=new Uint16Array(indexCount):"ubyte"==indexType&&(this._buffer=new Uint8Array(indexCount)))}__class(IndexBuffer3D,"laya.d3.graphics.IndexBuffer3D",_super);var __proto=IndexBuffer3D.prototype;return __proto._bindForVAO=function(){if(!BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";LayaGL.instance.bindBuffer(34963,this._glBuffer)},__proto.bind=function(){if(BufferStateBase._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";return Buffer._bindedIndexBuffer!==this._glBuffer&&(LayaGL.instance.bindBuffer(34963,this._glBuffer),Buffer._bindedIndexBuffer=this._glBuffer,!0)},__proto.setData=function(data,bufferOffset,dataStartIndex,dataCount){void 0===bufferOffset&&(bufferOffset=0),void 0===dataStartIndex&&(dataStartIndex=0),void 0===dataCount&&(dataCount=4294967295);var byteCount=0;"ushort"==this._indexType?(byteCount=2,0===dataStartIndex&&4294967295===dataCount||(data=new Uint16Array(data.buffer,dataStartIndex*byteCount,dataCount))):"ubyte"==this._indexType&&(byteCount=1,0===dataStartIndex&&4294967295===dataCount||(data=new Uint8Array(data.buffer,dataStartIndex*byteCount,dataCount)));var curBufSta=BufferStateBase._curBindedBufferState;if(curBufSta?curBufSta._bindedIndexBuffer===this?LayaGL.instance.bufferSubData(this._bufferType,bufferOffset*byteCount,data):(curBufSta.unBind(),this.bind(),LayaGL.instance.bufferSubData(this._bufferType,bufferOffset*byteCount,data),curBufSta.bind()):(this.bind(),LayaGL.instance.bufferSubData(this._bufferType,bufferOffset*byteCount,data)),this._canRead)if(0!==bufferOffset||0!==dataStartIndex||4294967295!==dataCount){var maxLength=this._buffer.length-bufferOffset;dataCount>maxLength&&(dataCount=maxLength);for(var i=0;i<dataCount;i++)this._buffer[bufferOffset+i]=data[i]}else this._buffer=data},__proto.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},__proto.destroy=function(){_super.prototype.destroy.call(this),this._buffer=null},__getset(0,__proto,"indexType",function(){return this._indexType}),__getset(0,__proto,"indexTypeByteCount",function(){return this._indexTypeByteCount}),__getset(0,__proto,"indexCount",function(){return this._indexCount}),__getset(0,__proto,"canRead",function(){return this._canRead}),IndexBuffer3D.INDEXTYPE_UBYTE="ubyte",IndexBuffer3D.INDEXTYPE_USHORT="ushort",IndexBuffer3D}(Buffer),CylinderColliderShape=function(_super){function CylinderColliderShape(radius,height,orientation){switch(this._radius=1,this._height=.5,CylinderColliderShape.__super.call(this),void 0===radius&&(radius=.5),void 0===height&&(height=1),void 0===orientation&&(orientation=1),this._radius=radius,this._height=height,this._orientation=orientation,this._type=2,orientation){case 0:CylinderColliderShape._nativeSize.setValue(height/2,radius,radius),this._nativeShape=new Laya3D._physics3D.btCylinderShapeX(CylinderColliderShape._nativeSize);break;case 1:CylinderColliderShape._nativeSize.setValue(radius,height/2,radius),this._nativeShape=new Laya3D._physics3D.btCylinderShape(CylinderColliderShape._nativeSize);break;case 2:CylinderColliderShape._nativeSize.setValue(radius,radius,height/2),this._nativeShape=new Laya3D._physics3D.btCylinderShapeZ(CylinderColliderShape._nativeSize);break;default:throw"CapsuleColliderShape:unknown orientation."}}__class(CylinderColliderShape,"laya.d3.physics.shape.CylinderColliderShape",ColliderShape);var __proto=CylinderColliderShape.prototype;return __proto.clone=function(){var dest=new CylinderColliderShape(this._radius,this._height,this._orientation);return this.cloneTo(dest),dest},__getset(0,__proto,"radius",function(){return this._radius}),__getset(0,__proto,"height",function(){return this._height}),__getset(0,__proto,"orientation",function(){return this._orientation}),__static(CylinderColliderShape,["_nativeSize",function(){return this._nativeSize=new Laya3D._physics3D.btVector3(0,0,0)}]),CylinderColliderShape}(),SphereColliderShape=function(_super){function SphereColliderShape(radius){SphereColliderShape.__super.call(this),void 0===radius&&(radius=.5),this._radius=radius,this._type=1,this._nativeShape=new Laya3D._physics3D.btSphereShape(radius)}__class(SphereColliderShape,"laya.d3.physics.shape.SphereColliderShape",ColliderShape);var __proto=SphereColliderShape.prototype;return __proto.clone=function(){var dest=new SphereColliderShape(this._radius);return this.cloneTo(dest),dest},__getset(0,__proto,"radius",function(){return this._radius}),SphereColliderShape}(),SphereShape=function(_super){function SphereShape(){this.radius=NaN,this.emitFromShell=!1,SphereShape.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}__class(SphereShape,"laya.d3.core.particleShuriKen.module.shape.SphereShape",_super);var __proto=SphereShape.prototype;return __proto._getShapeBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[1]=minE[2]=-this.radius;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=maxE[2]=this.radius},__proto._getSpeedBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[1]=minE[2]=-1;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=maxE[2]=1},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){rand?(rand.seed=randomSeeds[16],this.emitFromShell?ShapeUtils._randomPointUnitSphere(position,rand):ShapeUtils._randomPointInsideUnitSphere(position,rand),randomSeeds[16]=rand.seed):this.emitFromShell?ShapeUtils._randomPointUnitSphere(position):ShapeUtils._randomPointInsideUnitSphere(position),Vector3.scale(position,this.radius,position),this.randomDirection?rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction):position.cloneTo(direction)},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destShape=destObject;destShape.radius=this.radius,destShape.emitFromShell=this.emitFromShell,destShape.randomDirection=this.randomDirection},SphereShape}(BaseShape),SubMeshDynamicBatch=function(_super){function SubMeshDynamicBatch(){this._vertices=null,this._indices=null,this._positionOffset=0,this._normalOffset=0,this._colorOffset=0,this._uv0Offset=0,this._uv1Offset=0,this._sTangentOffset=0,this._vertexBuffer=null,this._indexBuffer=null,SubMeshDynamicBatch.__super.call(this),this._bufferState=new BufferState;var maxByteCount=32e3*VertexMesh.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride;this._vertices=new Float32Array(maxByteCount/4),this._vertexBuffer=new VertexBuffer3D(maxByteCount,35048),this._indices=new Int16Array(32e3),this._indexBuffer=new IndexBuffer3D("ushort",this._indices.length,35048);var memorySize=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;Resource._addMemory(memorySize,memorySize)}__class(SubMeshDynamicBatch,"laya.d3.graphics.SubMeshDynamicBatch",GeometryElement);var __proto=SubMeshDynamicBatch.prototype;return __proto._getBatchVertices=function(vertexDeclaration,batchVertices,batchOffset,transform,element,subMesh){var vertexFloatCount=vertexDeclaration.vertexStride/4,oriVertexes=subMesh._vertexBuffer.getData(),multiSubMesh=(element.render.lightmapScaleOffset,element._dynamicMultiSubMesh),vertexCount=element._dynamicVertexCount;element._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,multiSubMesh,vertexCount);for(var worldPositions=element._dynamicWorldPositions,worldNormals=element._dynamicWorldNormals,indices=subMesh._indices,i=0;i<vertexCount;i++){var oriOffset=(multiSubMesh?indices[i]:i)*vertexFloatCount,bakeOffset=(i+batchOffset)*vertexFloatCount,oriOff=3*i,bakOff=bakeOffset+this._positionOffset;batchVertices[bakOff]=worldPositions[oriOff],batchVertices[bakOff+1]=worldPositions[oriOff+1],batchVertices[bakOff+2]=worldPositions[oriOff+2],-1!==this._normalOffset&&(batchVertices[bakOff=bakeOffset+this._normalOffset]=worldNormals[oriOff],batchVertices[bakOff+1]=worldNormals[oriOff+1],batchVertices[bakOff+2]=worldNormals[oriOff+2]),-1!==this._colorOffset&&(bakOff=bakeOffset+this._colorOffset,oriOff=oriOffset+this._colorOffset,batchVertices[bakOff]=oriVertexes[oriOff],batchVertices[bakOff+1]=oriVertexes[oriOff+1],batchVertices[bakOff+2]=oriVertexes[oriOff+2],batchVertices[bakOff+3]=oriVertexes[oriOff+3]),-1!==this._uv0Offset&&(bakOff=bakeOffset+this._uv0Offset,oriOff=oriOffset+this._uv0Offset,batchVertices[bakOff]=oriVertexes[oriOff],batchVertices[bakOff+1]=oriVertexes[oriOff+1]),-1!==this._sTangentOffset&&(bakOff=bakeOffset+this._sTangentOffset,oriOff=oriOffset+this._sTangentOffset,batchVertices[bakOff]=oriVertexes[oriOff],batchVertices[bakOff+1]=oriVertexes[oriOff+1],batchVertices[bakOff+2]=oriVertexes[oriOff+2],batchVertices[bakOff+3]=oriVertexes[oriOff+3],bakOff=bakeOffset+this._sTangentOffset,oriOff=oriOffset+this._sTangentOffset,batchVertices[bakOff]=oriVertexes[oriOff],batchVertices[bakOff+1]=oriVertexes[oriOff+1],batchVertices[bakOff+2]=oriVertexes[oriOff+2],batchVertices[bakOff+3]=oriVertexes[oriOff+3])}},__proto._getBatchIndices=function(batchIndices,batchIndexCount,batchVertexCount,transform,subMesh,multiSubMesh){var subIndices=subMesh._indices,k=0,m=0,batchOffset=0,isInvert=transform._isFrontFaceInvert;if(multiSubMesh)if(isInvert)for(k=0,m=subIndices.length;k<m;k+=3){var index=batchVertexCount+k;batchIndices[batchOffset=batchIndexCount+k]=index,batchIndices[batchOffset+1]=index+2,batchIndices[batchOffset+2]=index+1}else for(k=m,m=subIndices.length;k<m;k+=3)index=batchVertexCount+k,batchIndices[batchOffset=batchIndexCount+k]=index,batchIndices[batchOffset+1]=index+1,batchIndices[batchOffset+2]=index+2;else if(isInvert)for(k=0,m=subIndices.length;k<m;k+=3)batchIndices[batchOffset=batchIndexCount+k]=batchVertexCount+subIndices[k],batchIndices[batchOffset+1]=batchVertexCount+subIndices[k+2],batchIndices[batchOffset+2]=batchVertexCount+subIndices[k+1];else for(k=m,m=subIndices.length;k<m;k+=3)batchIndices[batchOffset=batchIndexCount+k]=batchVertexCount+subIndices[k],batchIndices[batchOffset+1]=batchVertexCount+subIndices[k+1],batchIndices[batchOffset+2]=batchVertexCount+subIndices[k+2]},__proto._flush=function(vertexCount,indexCount){this._vertexBuffer.setData(this._vertices,0,0,vertexCount*(this._vertexBuffer.vertexDeclaration.vertexStride/4)),this._indexBuffer.setData(this._indices,0,0,indexCount),LayaGL.instance.drawElements(4,indexCount,5123,0),Stat.renderBatch++,Stat.trianglesFaces+=indexCount/3},__proto._prepareRender=function(state){var vertexDeclaration=state.renderElement.dynamicVertexDeclaration;this._bufferState=MeshRenderDynamicBatchManager.instance._getBufferState(vertexDeclaration),this._positionOffset=vertexDeclaration.getVertexElementByUsage(0).offset/4;var normalElement=vertexDeclaration.getVertexElementByUsage(3);this._normalOffset=normalElement?normalElement.offset/4:-1;var colorElement=vertexDeclaration.getVertexElementByUsage(1);this._colorOffset=colorElement?colorElement.offset/4:-1;var uv0Element=vertexDeclaration.getVertexElementByUsage(2);this._uv0Offset=uv0Element?uv0Element.offset/4:-1;var uv1Element=vertexDeclaration.getVertexElementByUsage(8);this._uv1Offset=uv1Element?uv1Element.offset/4:-1;var tangentElement=vertexDeclaration.getVertexElementByUsage(5);return this._sTangentOffset=tangentElement?tangentElement.offset/4:-1,!0},__proto._render=function(context){this._bufferState.bind();for(var element=context.renderElement,vertexDeclaration=element.dynamicVertexDeclaration,batchElements=element.dynamicBatchElementList,batchVertexCount=0,batchIndexCount=0,i=(vertexDeclaration.vertexStride,0),n=batchElements.length;i<n;i++){var subElement=batchElements[i],subMesh=subElement._geometry,indexCount=subMesh._indexCount;batchIndexCount+indexCount>32e3&&(this._flush(batchVertexCount,batchIndexCount),batchVertexCount=batchIndexCount=0);var transform=subElement._transform;this._getBatchVertices(vertexDeclaration,this._vertices,batchVertexCount,transform,subElement,subMesh),this._getBatchIndices(this._indices,batchIndexCount,batchVertexCount,transform,subMesh,subElement._dynamicMultiSubMesh),batchVertexCount+=subElement._dynamicVertexCount,batchIndexCount+=indexCount}this._flush(batchVertexCount,batchIndexCount)},SubMeshDynamicBatch.maxAllowVertexCount=10,SubMeshDynamicBatch.maxAllowAttribueCount=900,SubMeshDynamicBatch.maxIndicesCount=32e3,SubMeshDynamicBatch.instance=null,SubMeshDynamicBatch}(),SkyBox=function(_super){function SkyBox(){SkyBox.__super.call(this);var vertices=new Float32Array([-.5,.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5]),indices=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),verDec=VertexMesh.getVertexDeclaration("POSITION");this._vertexBuffer=new VertexBuffer3D(8*verDec.vertexStride,35044,!1),this._vertexBuffer.vertexDeclaration=verDec,this._indexBuffer=new IndexBuffer3D("ubyte",36,35044,!1),this._vertexBuffer.setData(vertices),this._indexBuffer.setData(indices);var bufferState=new BufferState;bufferState.bind(),bufferState.applyVertexBuffer(this._vertexBuffer),bufferState.applyIndexBuffer(this._indexBuffer),bufferState.unBind(),this._bufferState=bufferState}return __class(SkyBox,"laya.d3.resource.models.SkyBox",SkyMesh),SkyBox.prototype._render=function(state){LayaGL.instance.drawElements(4,36,5121,0),Stat.trianglesFaces+=12,Stat.renderBatch++},SkyBox.__init__=function(){SkyBox.instance=new SkyBox},SkyBox.instance=null,SkyBox}(),CircleShape=function(_super){function CircleShape(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,CircleShape.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}__class(CircleShape,"laya.d3.core.particleShuriKen.module.shape.CircleShape",_super);var __proto=CircleShape.prototype;return __proto._getShapeBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[2]=-this.radius,minE[1]=0;var maxE=boundBox.max.elements;maxE[0]=maxE[2]=this.radius,maxE[1]=0},__proto._getSpeedBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=minE[1]=-1,minE[2]=0;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=1,maxE[2]=0},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){var rpE=position.elements,positionPointE=CircleShape._tempPositionPoint.elements;rand?(rand.seed=randomSeeds[16],this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint,rand):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint,rand),randomSeeds[16]=rand.seed):this.emitFromEdge?ShapeUtils._randomPointUnitArcCircle(this.arc,CircleShape._tempPositionPoint):ShapeUtils._randomPointInsideUnitArcCircle(this.arc,CircleShape._tempPositionPoint),rpE[0]=-positionPointE[0],rpE[1]=positionPointE[1],rpE[2]=0,Vector3.scale(position,this.radius,position),this.randomDirection?rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction):position.cloneTo(direction)},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destShape=destObject;destShape.radius=this.radius,destShape.arc=this.arc,destShape.emitFromEdge=this.emitFromEdge,destShape.randomDirection=this.randomDirection},__static(CircleShape,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2}]),CircleShape}(BaseShape),SubMeshStaticBatch=function(_super){function SubMeshStaticBatch(batchOwner,number,vertexDeclaration){SubMeshStaticBatch.__super.call(this),this._bufferState=new BufferState,this._batchID=SubMeshStaticBatch._batchIDCounter++,this._batchElements=[],this._currentBatchVertexCount=0,this._currentBatchIndexCount=0,this._vertexDeclaration=vertexDeclaration,this.batchOwner=batchOwner,this.number=number}__class(SubMeshStaticBatch,"laya.d3.graphics.SubMeshStaticBatch",GeometryElement);var __proto=SubMeshStaticBatch.prototype;return Laya.imps(__proto,{"laya.resource.IDispose":!0}),__proto._getStaticBatchBakedVertexs=function(batchVertices,batchOffset,batchOwnerTransform,transform,render,mesh){var worldMat,vertexBuffer=mesh._vertexBuffers[0],vertexDeclaration=vertexBuffer.vertexDeclaration,positionOffset=vertexDeclaration.getVertexElementByUsage(0).offset/4,normalElement=vertexDeclaration.getVertexElementByUsage(3),normalOffset=normalElement?normalElement.offset/4:-1,colorElement=vertexDeclaration.getVertexElementByUsage(1),colorOffset=colorElement?colorElement.offset/4:-1,uv0Element=vertexDeclaration.getVertexElementByUsage(2),uv0Offset=uv0Element?uv0Element.offset/4:-1,uv1Element=vertexDeclaration.getVertexElementByUsage(8),uv1Offset=uv1Element?uv1Element.offset/4:-1,tangentElement=vertexDeclaration.getVertexElementByUsage(5),sTangentOffset=tangentElement?tangentElement.offset/4:-1,oriVertexFloatCount=vertexDeclaration.vertexStride/4,oriVertexes=vertexBuffer.getData();batchOwnerTransform?(batchOwnerTransform.worldMatrix.invert(SubMeshStaticBatch._tempMatrix4x40),worldMat=SubMeshStaticBatch._tempMatrix4x41,Matrix4x4.multiply(SubMeshStaticBatch._tempMatrix4x40,transform.worldMatrix,worldMat)):worldMat=transform.worldMatrix;var rotation=SubMeshStaticBatch._tempQuaternion0;worldMat.decomposeTransRotScale(SubMeshStaticBatch._tempVector30,rotation,SubMeshStaticBatch._tempVector31);for(var lightmapScaleOffset=render.lightmapScaleOffset,vertexCount=mesh.vertexCount,i=0;i<vertexCount;i++){var oriOffset=i*oriVertexFloatCount,bakeOffset=18*(i+batchOffset);Utils3D.transformVector3ArrayToVector3ArrayCoordinate(oriVertexes,oriOffset+positionOffset,worldMat,batchVertices,bakeOffset+0),-1!==normalOffset&&Utils3D.transformVector3ArrayByQuat(oriVertexes,oriOffset+normalOffset,rotation,batchVertices,bakeOffset+3);var j=0,m=0,bakOff=bakeOffset+6;if(-1!==colorOffset){var oriOff=oriOffset+colorOffset;for(j=0,m=4;j<m;j++)batchVertices[bakOff+j]=oriVertexes[oriOff+j]}else for(j=0,m=4;j<m;j++)batchVertices[bakOff+j]=1;if(-1!==uv0Offset){var absUv0Offset=oriOffset+uv0Offset;batchVertices[bakeOffset+10]=oriVertexes[absUv0Offset],batchVertices[bakeOffset+11]=oriVertexes[absUv0Offset+1]}if(lightmapScaleOffset&&(-1!==uv1Offset?Utils3D.transformLightingMapTexcoordArray(oriVertexes,oriOffset+uv1Offset,lightmapScaleOffset,batchVertices,bakeOffset+12):Utils3D.transformLightingMapTexcoordArray(oriVertexes,oriOffset+uv0Offset,lightmapScaleOffset,batchVertices,bakeOffset+12)),-1!==sTangentOffset){var absSTanegntOffset=oriOffset+sTangentOffset;batchVertices[bakeOffset+14]=oriVertexes[absSTanegntOffset],batchVertices[bakeOffset+15]=oriVertexes[absSTanegntOffset+1],batchVertices[bakeOffset+16]=oriVertexes[absSTanegntOffset+2],batchVertices[bakeOffset+17]=oriVertexes[absSTanegntOffset+3]}}return vertexCount},__proto.addTest=function(sprite){var subMeshVertexCount=sprite.meshFilter.sharedMesh.vertexCount;return!(this._currentBatchVertexCount+subMeshVertexCount>65535)},__proto.add=function(sprite){var oldStaticBatch=sprite._render._staticBatch;oldStaticBatch&&oldStaticBatch.remove(sprite);var mesh=sprite.meshFilter.sharedMesh,subMeshVertexCount=mesh.vertexCount;this._batchElements.push(sprite);var render=sprite._render;render._isPartOfStaticBatch=!0,render._staticBatch=this;for(var renderElements=render._renderElements,i=0,n=renderElements.length;i<n;i++)renderElements[i].staticBatch=this;this._currentBatchIndexCount+=mesh._indexBuffer.indexCount,this._currentBatchVertexCount+=subMeshVertexCount},__proto.remove=function(sprite){var mesh=sprite.meshFilter.sharedMesh,index=this._batchElements.indexOf(sprite);if(-1!==index){this._batchElements.splice(index,1);sprite._render;for(var renderElements=sprite._render._renderElements,i=0,n=renderElements.length;i<n;i++)renderElements[i].staticBatch=null;var meshVertexCount=mesh.vertexCount;this._currentBatchIndexCount=this._currentBatchIndexCount-mesh._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-meshVertexCount,sprite._render._isPartOfStaticBatch=!1}},__proto.finishInit=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var batchVertexCount=0,batchIndexCount=0,rootOwner=this.batchOwner._owner,floatStride=this._vertexDeclaration.vertexStride/4,vertexDatas=new Float32Array(floatStride*this._currentBatchVertexCount),indexDatas=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new VertexBuffer3D(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,35044),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new IndexBuffer3D("ushort",this._currentBatchIndexCount,35044);for(var i=0,n=this._batchElements.length;i<n;i++){for(var sprite=this._batchElements[i],mesh=sprite.meshFilter.sharedMesh,meshVerCount=this._getStaticBatchBakedVertexs(vertexDatas,batchVertexCount,rootOwner?rootOwner._transform:null,sprite._transform,sprite._render,mesh),indices=mesh._indexBuffer.getData(),indexOffset=batchVertexCount,indexEnd=batchIndexCount+indices.length,elements=sprite._render._renderElements,j=0,m=mesh.subMeshCount;j<m;j++){var subMesh=mesh._subMeshes[j],start=batchIndexCount+subMesh._indexStart,element=elements[j];element.staticBatchIndexStart=start,element.staticBatchIndexEnd=start+subMesh._indexCount}indexDatas.set(indices,batchIndexCount);var k=0;if(rootOwner?sprite._transform._isFrontFaceInvert!==rootOwner.transform._isFrontFaceInvert:sprite._transform._isFrontFaceInvert)for(k=batchIndexCount;k<indexEnd;k+=3){indexDatas[k]=indexOffset+indexDatas[k];var index1=indexDatas[k+1],index2=indexDatas[k+2];indexDatas[k+1]=indexOffset+index2,indexDatas[k+2]=indexOffset+index1}else for(k=batchIndexCount;k<indexEnd;k+=3)indexDatas[k]=indexOffset+indexDatas[k],indexDatas[k+1]=indexOffset+indexDatas[k+1],indexDatas[k+2]=indexOffset+indexDatas[k+2];batchIndexCount+=indices.length,batchVertexCount+=meshVerCount}this._vertexBuffer.setData(vertexDatas),this._indexBuffer.setData(indexDatas);var memorySize=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;Resource._addGPUMemory(memorySize),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()},__proto._render=function(state){this._bufferState.bind();for(var batchElementList=state.renderElement.staticBatchElementList,from=0,end=0,i=1,n=batchElementList.length;i<n;i++){if(batchElementList[i-1].staticBatchIndexEnd!==batchElementList[i].staticBatchIndexStart){var start=batchElementList[from].staticBatchIndexStart,indexCount=batchElementList[end].staticBatchIndexEnd-start;LayaGL.instance.drawElements(4,indexCount,5123,2*start),from=++end,Stat.renderBatch++,Stat.trianglesFaces+=indexCount/3}else end++}start=batchElementList[from].staticBatchIndexStart,indexCount=batchElementList[end].staticBatchIndexEnd-start,LayaGL.instance.drawElements(4,indexCount,5123,2*start),Stat.renderBatch++,Stat.trianglesFaces+=indexCount/3},__proto.dispose=function(){var memorySize=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;Resource._addGPUMemory(-memorySize),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null},SubMeshStaticBatch.maxBatchVertexCount=65535,SubMeshStaticBatch._batchIDCounter=0,__static(SubMeshStaticBatch,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempQuaternion0",function(){return this._tempQuaternion0=new Quaternion},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Matrix4x4}]),SubMeshStaticBatch}(),TrailGeometry=function(_super){function TrailGeometry(owner){this._floatCountPerVertices1=8,this._floatCountPerVertices2=1,this._increaseSegementCount=128,this._activeIndex=0,this._endIndex=0,this._needAddFirstVertex=!1,this._isTempEndVertex=!1,this._subBirthTime=null,this._subDistance=null,this._segementCount=0,this._vertices1=null,this._vertices2=null,this._vertexBuffer1=null,this._vertexBuffer2=null,this._owner=null,TrailGeometry.__super.call(this),this._lastFixedVertexPosition=new Vector3,this._bufferState=new BufferState,this._owner=owner,this._resizeData(this._increaseSegementCount,this._bufferState)}__class(TrailGeometry,"laya.d3.core.trail.TrailGeometry",GeometryElement);var __proto=TrailGeometry.prototype;return __proto._resizeData=function(segementCount,bufferState){this._segementCount=this._increaseSegementCount,this._subBirthTime=new Float32Array(segementCount),this._subDistance=new Float32Array(segementCount);var vertexCount=2*segementCount,vertexDeclaration1=VertexTrail.vertexDeclaration1,vertexDeclaration2=VertexTrail.vertexDeclaration2,vertexBuffers=[],vertexbuffer1Size=vertexCount*vertexDeclaration1.vertexStride,vertexbuffer2Size=vertexCount*vertexDeclaration2.vertexStride,memorySize=vertexbuffer1Size+vertexbuffer2Size;this._vertices1=new Float32Array(vertexCount*this._floatCountPerVertices1),this._vertexBuffer1=new VertexBuffer3D(vertexbuffer1Size,35044,!1),this._vertexBuffer1.vertexDeclaration=vertexDeclaration1,this._vertices2=new Float32Array(vertexCount*this._floatCountPerVertices2),this._vertexBuffer2=new VertexBuffer3D(vertexbuffer2Size,35048,!1),this._vertexBuffer2.vertexDeclaration=vertexDeclaration2,vertexBuffers.push(this._vertexBuffer1),vertexBuffers.push(this._vertexBuffer2),bufferState.bind(),bufferState.applyVertexBuffers(vertexBuffers),bufferState.unBind(),Resource._addMemory(memorySize,memorySize)},__proto._resetData=function(){var count=this._endIndex-this._activeIndex;count==this._segementCount&&(this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)),this._vertexBuffer1.setData(this._vertices1,0,2*this._floatCountPerVertices1*this._activeIndex,2*this._floatCountPerVertices1*count),this._vertexBuffer2.setData(this._vertices2,0,2*this._floatCountPerVertices2*this._activeIndex,2*this._floatCountPerVertices2*count);var offset=4*this._activeIndex,rightSubDistance=new Float32Array(this._subDistance.buffer,offset,count),rightSubBirthTime=new Float32Array(this._subBirthTime.buffer,offset,count);this._subDistance.set(rightSubDistance,0),this._subBirthTime.set(rightSubBirthTime,0),this._endIndex=count,this._activeIndex=0},__proto._updateTrail=function(camera,lastPosition,position){Vector3.equals(lastPosition,position)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(camera,position):this._addTrailByNextPosition(camera,position))},__proto._addTrailByFirstPosition=function(camera,position){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,position.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0},__proto._addTrailByNextPosition=function(camera,position){var delVector3=TrailGeometry._tempVector30,pointAtoBVector3=TrailGeometry._tempVector31;switch(Vector3.subtract(position,this._lastFixedVertexPosition,delVector3),this._owner.alignment){case 0:Vector3.cross(delVector3,camera.transform.forward,pointAtoBVector3);break;case 1:Vector3.cross(delVector3,this._owner._owner.transform.forward,pointAtoBVector3)}Vector3.normalize(pointAtoBVector3,pointAtoBVector3),Vector3.scale(pointAtoBVector3,this._owner.widthMultiplier/2,pointAtoBVector3);var delLength=Vector3.scalarLength(delVector3),tempEndIndex=0,offset=NaN;this._needAddFirstVertex&&(this._updateVerticesByPositionData(position,pointAtoBVector3,this._endIndex-1),this._needAddFirstVertex=!1),delLength-this._owner.minVertexDistance>=MathUtils3D.zeroTolerance?(this._isTempEndVertex?(tempEndIndex=this._endIndex-1,offset=delLength-this._subDistance[tempEndIndex],this._updateVerticesByPosition(position,pointAtoBVector3,delLength,tempEndIndex),this._owner._totalLength+=offset):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(position,pointAtoBVector3,delLength,this._endIndex),this._owner._totalLength+=delLength,this._endIndex++),position.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(tempEndIndex=this._endIndex-1,offset=delLength-this._subDistance[tempEndIndex],this._updateVerticesByPosition(position,pointAtoBVector3,delLength,tempEndIndex),this._owner._totalLength+=offset):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(position,pointAtoBVector3,delLength,this._endIndex),this._owner._totalLength+=delLength,this._endIndex++),this._isTempEndVertex=!0)},__proto._updateVerticesByPositionData=function(position,pointAtoBVector3,index){var vertexOffset=2*this._floatCountPerVertices1*index,pointE=position.elements,pointAtoBVector3E=pointAtoBVector3.elements,curtime=this._owner._curtime;this._vertices1[vertexOffset]=pointE[0],this._vertices1[vertexOffset+1]=pointE[1],this._vertices1[vertexOffset+2]=pointE[2],this._vertices1[vertexOffset+3]=-pointAtoBVector3E[0],this._vertices1[vertexOffset+4]=-pointAtoBVector3E[1],this._vertices1[vertexOffset+5]=-pointAtoBVector3E[2],this._vertices1[vertexOffset+6]=curtime,this._vertices1[vertexOffset+7]=1,this._vertices1[vertexOffset+8]=pointE[0],this._vertices1[vertexOffset+9]=pointE[1],this._vertices1[vertexOffset+10]=pointE[2],this._vertices1[vertexOffset+11]=pointAtoBVector3E[0],this._vertices1[vertexOffset+12]=pointAtoBVector3E[1],this._vertices1[vertexOffset+13]=pointAtoBVector3E[2],this._vertices1[vertexOffset+14]=curtime,this._vertices1[vertexOffset+15]=0;var floatCount=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1,vertexOffset,vertexOffset,floatCount)},__proto._updateVerticesByPosition=function(position,pointAtoBVector3,delDistance,index){this._updateVerticesByPositionData(position,pointAtoBVector3,index),this._subDistance[index]=delDistance,this._subBirthTime[index]=this._owner._curtime},__proto._updateVertexBufferUV=function(){for(var vertexCount=this._endIndex,curLength=0,i=this._activeIndex,j=vertexCount;i<j;i++){i!==this._activeIndex&&(curLength+=this._subDistance[i]);var uvX=NaN;uvX=0==this._owner.textureMode?1-curLength/this._owner._totalLength:1-(this._owner._totalLength-curLength),this._vertices2[2*i]=uvX,this._vertices2[2*i+1]=uvX}var offset=2*this._activeIndex;this._vertexBuffer2.setData(this._vertices2,offset,offset,2*vertexCount-offset)},__proto._updateDisappear=function(){for(var count=this._endIndex,i=this._activeIndex;i<count&&this._owner._curtime-this._subBirthTime[i]>=this._owner.time+MathUtils3D.zeroTolerance;i++){var nextIndex=i+1;if(nextIndex!==count&&(this._owner._totalLength-=this._subDistance[nextIndex]),this._isTempEndVertex&&nextIndex===count-1){this._floatCountPerVertices1;var fixedPosE=this._lastFixedVertexPosition.elements;fixedPosE[0]=this._vertices1[0],fixedPosE[1]=this._vertices1[1],fixedPosE[2]=this._vertices1[2],this._isTempEndVertex=!1}this._activeIndex++}},__proto._getType=function(){return TrailGeometry._type},__proto._prepareRender=function(state){return this._endIndex-this._activeIndex>1},__proto._render=function(state){this._bufferState.bind();var start=2*this._activeIndex,count=2*this._endIndex-start;LayaGL.instance.drawArrays(5,start,count),Stat.renderBatch++,Stat.trianglesFaces+=count-2},__proto._destroy=function(){var memorySize=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;Resource._addMemory(-memorySize,-memorySize),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null},__static(TrailGeometry,["_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_type",function(){return this._type=GeometryElement._typeCounter++}]),TrailGeometry}(),ConeShape=function(_super){function ConeShape(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,ConeShape.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}__class(ConeShape,"laya.d3.core.particleShuriKen.module.shape.ConeShape",_super);var __proto=ConeShape.prototype;return __proto._getShapeBoundBox=function(boundBox){var coneRadius2=this.radius+this.length*Math.sin(this.angle),coneLength=this.length*Math.cos(this.angle),minE=boundBox.min.elements;minE[0]=minE[1]=-coneRadius2,minE[2]=0;var maxE=boundBox.max.elements;maxE[0]=maxE[1]=coneRadius2,maxE[2]=coneLength},__proto._getSpeedBoundBox=function(boundBox){var sinA=Math.sin(this.angle),minE=boundBox.min.elements;minE[0]=minE[1]=-sinA,minE[2]=0;var maxE=boundBox.max.elements;maxE[0]=minE[1]=sinA,maxE[2]=1},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){var directionPointE,rpE=position.elements,rdE=direction.elements,positionPointE=ConeShape._tempPositionPoint.elements,positionX=NaN,positionY=NaN,dirCosA=Math.cos(this.angle),dirSinA=Math.sin(this.angle);switch(this.emitType){case 0:rand?(rand.seed=randomSeeds[16],ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,rand),randomSeeds[16]=rand.seed):ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),positionX=positionPointE[0],positionY=positionPointE[1],rpE[0]=positionX*this.radius,rpE[1]=positionY*this.radius,rpE[2]=0,this.randomDirection?(rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),directionPointE=ConeShape._tempDirectionPoint.elements,rdE[0]=directionPointE[0]*dirSinA,rdE[1]=directionPointE[1]*dirSinA):(rdE[0]=positionX*dirSinA,rdE[1]=positionY*dirSinA),rdE[2]=dirCosA;break;case 1:rand?(rand.seed=randomSeeds[16],ShapeUtils._randomPointUnitCircle(ConeShape._tempPositionPoint,rand),randomSeeds[16]=rand.seed):ShapeUtils._randomPointUnitCircle(ConeShape._tempPositionPoint),positionX=positionPointE[0],positionY=positionPointE[1],rpE[0]=positionX*this.radius,rpE[1]=positionY*this.radius,rpE[2]=0,this.randomDirection?(rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempDirectionPoint),directionPointE=ConeShape._tempDirectionPoint.elements,rdE[0]=directionPointE[0]*dirSinA,rdE[1]=directionPointE[1]*dirSinA):(rdE[0]=positionX*dirSinA,rdE[1]=positionY*dirSinA),rdE[2]=dirCosA;break;case 2:rand?(rand.seed=randomSeeds[16],ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempPositionPoint,rand)):ShapeUtils._randomPointInsideUnitCircle(ConeShape._tempPositionPoint),positionX=positionPointE[0],positionY=positionPointE[1],rpE[0]=positionX*this.radius,rpE[1]=positionY*this.radius,rpE[2]=0,rdE[0]=positionX*dirSinA,rdE[1]=positionY*dirSinA,rdE[2]=dirCosA,Vector3.normalize(direction,direction),rand?(Vector3.scale(direction,this.length*rand.getFloat(),direction),randomSeeds[16]=rand.seed):Vector3.scale(direction,this.length*Math.random(),direction),Vector3.add(position,direction,position),this.randomDirection&&(rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction));break;case 3:rand?(rand.seed=randomSeeds[16],ShapeUtils._randomPointUnitCircle(ConeShape._tempPositionPoint,rand)):ShapeUtils._randomPointUnitCircle(ConeShape._tempPositionPoint),positionX=positionPointE[0],positionY=positionPointE[1],rpE[0]=positionX*this.radius,rpE[1]=positionY*this.radius,rpE[2]=0,rdE[0]=positionX*dirSinA,rdE[1]=positionY*dirSinA,rdE[2]=dirCosA,Vector3.normalize(direction,direction),rand?(Vector3.scale(direction,this.length*rand.getFloat(),direction),randomSeeds[16]=rand.seed):Vector3.scale(direction,this.length*Math.random(),direction),Vector3.add(position,direction,position),this.randomDirection&&(rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction));break;default:throw new Error("ConeShape:emitType is invalid.")}},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destShape=destObject;destShape.angle=this.angle,destShape.radius=this.radius,destShape.length=this.length,destShape.emitType=this.emitType,destShape.randomDirection=this.randomDirection},__static(ConeShape,["_tempPositionPoint",function(){return this._tempPositionPoint=new Vector2},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Vector2}]),ConeShape}(BaseShape),BoxShape=function(_super){function BoxShape(){this.x=NaN,this.y=NaN,this.z=NaN,BoxShape.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}__class(BoxShape,"laya.d3.core.particleShuriKen.module.shape.BoxShape",_super);var __proto=BoxShape.prototype;return __proto._getShapeBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=.5*-this.x,minE[1]=.5*-this.y,minE[2]=.5*-this.z;var maxE=boundBox.max.elements;maxE[0]=.5*this.x,maxE[1]=.5*this.y,maxE[2]=.5*this.z},__proto._getSpeedBoundBox=function(boundBox){var minE=boundBox.min.elements;minE[0]=0,minE[1]=0,minE[2]=0;var maxE=boundBox.max.elements;maxE[0]=0,maxE[1]=1,maxE[2]=0},__proto.generatePositionAndDirection=function(position,direction,rand,randomSeeds){var rpE=position.elements,rdE=direction.elements;rand?(rand.seed=randomSeeds[16],ShapeUtils._randomPointInsideHalfUnitBox(position,rand),randomSeeds[16]=rand.seed):ShapeUtils._randomPointInsideHalfUnitBox(position),rpE[0]=this.x*rpE[0],rpE[1]=this.y*rpE[1],rpE[2]=this.z*rpE[2],this.randomDirection?rand?(rand.seed=randomSeeds[17],ShapeUtils._randomPointUnitSphere(direction,rand),randomSeeds[17]=rand.seed):ShapeUtils._randomPointUnitSphere(direction):(rdE[0]=0,rdE[1]=0,rdE[2]=1)},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destShape=destObject;destShape.x=this.x,destShape.y=this.y,destShape.z=this.z,destShape.randomDirection=this.randomDirection},BoxShape}(BaseShape),VertexShurikenParticleMesh=(function(_super){function StaticPlaneColliderShape(normal,offset){StaticPlaneColliderShape.__super.call(this),this._normal=normal,this._offset=offset,this._type=6,StaticPlaneColliderShape._nativeNormal.setValue(-normal.x,normal.y,normal.z),this._nativeShape=new Laya3D._physics3D.btStaticPlaneShape(StaticPlaneColliderShape._nativeNormal,offset)}__class(StaticPlaneColliderShape,"laya.d3.physics.shape.StaticPlaneColliderShape",ColliderShape),StaticPlaneColliderShape.prototype.clone=function(){var dest=new StaticPlaneColliderShape(this._normal,this._offset);return this.cloneTo(dest),dest},__static(StaticPlaneColliderShape,["_nativeNormal",function(){return this._nativeNormal=new Laya3D._physics3D.btVector3(0,0,0)}])}(),function(_super){function VertexShurikenParticleMesh(cornerTextureCoordinate,positionStartLifeTime,velocity,startColor,startSize,startRotation0,startRotation1,startRotation2,ageAddScale,time,startSpeed,randoms0,randoms1,simulationWorldPostion){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,VertexShurikenParticleMesh.__super.call(this),this._cornerTextureCoordinate=cornerTextureCoordinate,this._positionStartLifeTime=positionStartLifeTime,this._velocity=velocity,this._startColor=startColor,this._startSize=startSize,this._startRotation0=startRotation0,this._startRotation1=startRotation1,this._startRotation2=startRotation2,this._startLifeTime=ageAddScale,this._time=time,this._startSpeed=startSpeed,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=simulationWorldPostion}__class(VertexShurikenParticleMesh,"laya.d3.graphics.Vertex.VertexShurikenParticleMesh",VertexShuriKenParticle);var __proto=VertexShurikenParticleMesh.prototype;return __getset(0,__proto,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(0,__proto,"velocity",function(){return this._velocity}),__getset(0,__proto,"position",function(){return this._positionStartLifeTime}),__getset(0,__proto,"random0",function(){return this._randoms0}),__getset(0,__proto,"startSize",function(){return this._startSize}),__getset(0,__proto,"startColor",function(){return this._startColor}),__getset(0,__proto,"startRotation0",function(){return this._startRotation0}),__getset(0,__proto,"startRotation1",function(){return this._startRotation1}),__getset(0,__proto,"random1",function(){return this._randoms1}),__getset(0,__proto,"startRotation2",function(){return this._startRotation2}),__getset(0,__proto,"startLifeTime",function(){return this._startLifeTime}),__getset(0,__proto,"time",function(){return this._time}),__getset(0,__proto,"startSpeed",function(){return this._startSpeed}),__getset(0,__proto,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(1,VertexShurikenParticleMesh,"vertexDeclaration",function(){return VertexShurikenParticleMesh._vertexDeclaration},laya.d3.graphics.Vertex.VertexShuriKenParticle._$SET_vertexDeclaration),__static(VertexShurikenParticleMesh,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(172,[new VertexElement(0,"vector3",1),new VertexElement(12,"vector4",2),new VertexElement(28,"vector2",3),new VertexElement(36,"vector4",4),new VertexElement(52,"vector4",5),new VertexElement(68,"vector4",6),new VertexElement(84,"vector3",8),new VertexElement(96,"vector3",9),new VertexElement(108,"single",10),new VertexElement(112,"vector4",11),new VertexElement(128,"vector4",12),new VertexElement(144,"vector3",13),new VertexElement(156,"vector4",14)])}]),VertexShurikenParticleMesh}()),SkyDome=function(_super){function SkyDome(stacks,slices){this._stacks=0,this._slices=0,SkyDome.__super.call(this),void 0===stacks&&(stacks=48),void 0===slices&&(slices=48),this._stacks=stacks,this._slices=slices;for(var vertexDeclaration=VertexPositionTexture0.vertexDeclaration,vertexFloatCount=vertexDeclaration.vertexStride/4,numberVertices=(this._stacks+1)*(this._slices+1),numberIndices=3*this._stacks*(this._slices+1)*2,vertices=new Float32Array(numberVertices*vertexFloatCount),indices=new Uint16Array(numberIndices),stackAngle=Math.PI/this._stacks,sliceAngle=2*Math.PI/this._slices,vertexIndex=0,vertexCount=0,indexCount=0,stack=0;stack<this._stacks+1;stack++)for(var r=Math.sin(stack*stackAngle),y=Math.cos(stack*stackAngle),slice=0;slice<this._slices+1;slice++){var x=r*Math.sin(slice*sliceAngle),z=r*Math.cos(slice*sliceAngle);vertices[vertexCount+0]=x*SkyDome._radius,vertices[vertexCount+1]=y*SkyDome._radius,vertices[vertexCount+2]=z*SkyDome._radius,vertices[vertexCount+3]=-slice/this._slices+.75,vertices[vertexCount+4]=stack/this._stacks,vertexCount+=vertexFloatCount,stack!=this._stacks-1&&(indices[indexCount++]=vertexIndex+1,indices[indexCount++]=vertexIndex,indices[indexCount++]=vertexIndex+(this._slices+1),indices[indexCount++]=vertexIndex+(this._slices+1),indices[indexCount++]=vertexIndex,indices[indexCount++]=vertexIndex+this._slices,vertexIndex++)}this._vertexBuffer=new VertexBuffer3D(4*vertices.length,35044,!1),this._vertexBuffer.vertexDeclaration=vertexDeclaration,this._indexBuffer=new IndexBuffer3D("ushort",indices.length,35044,!1),this._vertexBuffer.setData(vertices),this._indexBuffer.setData(indices);var bufferState=new BufferState;bufferState.bind(),bufferState.applyVertexBuffer(this._vertexBuffer),bufferState.applyIndexBuffer(this._indexBuffer),bufferState.unBind(),this._bufferState=bufferState}__class(SkyDome,"laya.d3.resource.models.SkyDome",SkyMesh);var __proto=SkyDome.prototype;return __proto._render=function(state){var indexCount=this._indexBuffer.indexCount;LayaGL.instance.drawElements(4,indexCount,5123,0),Stat.trianglesFaces+=indexCount/3,Stat.renderBatch++},__getset(0,__proto,"stacks",function(){return this._stacks}),__getset(0,__proto,"slices",function(){return this._slices}),SkyDome.__init__=function(){SkyDome.instance=new SkyDome},SkyDome._radius=1,SkyDome.instance=null,SkyDome}(),FloatArrayKeyframe=function(_super){function FloatArrayKeyframe(){FloatArrayKeyframe.__super.call(this)}return __class(FloatArrayKeyframe,"laya.d3.core.FloatArrayKeyframe",_super),FloatArrayKeyframe.prototype.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject),destObject.data=this.data.slice()},FloatArrayKeyframe}(Keyframe),MeshRenderDynamicBatchManager=function(_super){function MeshRenderDynamicBatchManager(){this._cacheBatchRender=[],this._cacheBufferStates=[],this._opaqueBatchMarks=[],MeshRenderDynamicBatchManager.__super.call(this),SubMeshDynamicBatch.instance=new SubMeshDynamicBatch,this._updateCountMark=0}__class(MeshRenderDynamicBatchManager,"laya.d3.graphics.MeshRenderDynamicBatchManager",_super);var __proto=MeshRenderDynamicBatchManager.prototype;return __proto._getBufferState=function(vertexDeclaration){var bufferState=this._cacheBufferStates[vertexDeclaration.id];if(!bufferState){var instance=SubMeshDynamicBatch.instance;(bufferState=new BufferState).bind();var vertexBuffer=instance._vertexBuffer;vertexBuffer.vertexDeclaration=vertexDeclaration,bufferState.applyVertexBuffer(vertexBuffer),bufferState.applyIndexBuffer(instance._indexBuffer),bufferState.unBind(),this._cacheBufferStates[vertexDeclaration.id]=bufferState}return bufferState},__proto._getBatchRender=function(lightMapIndex,receiveShadow){var lightRenders=this._cacheBatchRender[lightMapIndex];lightRenders||(lightRenders=this._cacheBatchRender[lightMapIndex]=__newvec(2,null));var render=lightRenders[receiveShadow?1:0];return render||((render=new MeshRenderer(null)).lightmapIndex=lightMapIndex,render.receiveShadow=receiveShadow,lightRenders[receiveShadow?1:0]=render),render},__proto._getBatchRenderElementFromPool=function(){var renderElement=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return renderElement||(renderElement=new SubMeshRenderElement,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=renderElement,renderElement.dynamicBatchElementList=[]),renderElement},__proto._clear=function(){_super.prototype._clear.call(this),this._updateCountMark++},__static(MeshRenderDynamicBatchManager,["instance",function(){return this.instance=new MeshRenderDynamicBatchManager}]),MeshRenderDynamicBatchManager}(DynamicBatchManager),Vector4=function(_super){function Vector4(x,y,z,w){Vector4.__super.call(this),void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),void 0===w&&(w=0);var v=this.elements=new Float32Array(4);v[0]=x,v[1]=y,v[2]=z,v[3]=w}__class(Vector4,"laya.d3.math.Vector4",BaseVector);var __proto=Vector4.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.fromArray=function(array,offset){void 0===offset&&(offset=0),this.elements[0]=array[offset+0],this.elements[1]=array[offset+1],this.elements[2]=array[offset+2],this.elements[3]=array[offset+3]},__proto.cloneTo=function(destObject){var destE=destObject.elements,s=this.elements;destE[0]=s[0],destE[1]=s[1],destE[2]=s[2],destE[3]=s[3]},__proto.clone=function(){var destVector4=new this.constructor;return this.cloneTo(destVector4),destVector4},__proto.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},__proto.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},__getset(0,__proto,"x",function(){return this.elements[0]},function(value){this.elements[0]=value}),__getset(0,__proto,"y",function(){return this.elements[1]},function(value){this.elements[1]=value}),__getset(0,__proto,"z",function(){return this.elements[2]},function(value){this.elements[2]=value}),__getset(0,__proto,"w",function(){return this.elements[3]},function(value){this.elements[3]=value}),Vector4.lerp=function(a,b,t,out){var e=out.elements,f=a.elements,g=b.elements,ax=f[0],ay=f[1],az=f[2],aw=f[3];e[0]=ax+t*(g[0]-ax),e[1]=ay+t*(g[1]-ay),e[2]=az+t*(g[2]-az),e[3]=aw+t*(g[3]-aw)},Vector4.transformByM4x4=function(vector4,m4x4,out){var ve=vector4.elements,vx=ve[0],vy=ve[1],vz=ve[2],vw=ve[3],me=m4x4.elements,oe=out.elements;oe[0]=vx*me[0]+vy*me[4]+vz*me[8]+vw*me[12],oe[1]=vx*me[1]+vy*me[5]+vz*me[9]+vw*me[13],oe[2]=vx*me[2]+vy*me[6]+vz*me[10]+vw*me[14],oe[3]=vx*me[3]+vy*me[7]+vz*me[11]+vw*me[15]},Vector4.equals=function(a,b){var ae=a.elements,be=b.elements;return MathUtils3D.nearEqual(Math.abs(ae[0]),Math.abs(be[0]))&&MathUtils3D.nearEqual(Math.abs(ae[1]),Math.abs(be[1]))&&MathUtils3D.nearEqual(Math.abs(ae[2]),Math.abs(be[2]))&&MathUtils3D.nearEqual(Math.abs(ae[3]),Math.abs(be[3]))},Vector4.normalize=function(s,out){var se=s.elements,oe=out.elements,len=s.length();len>0&&(oe[0]=se[0]*len,oe[1]=se[1]*len,oe[2]=se[2]*len,oe[3]=se[3]*len)},Vector4.add=function(a,b,out){var oe=out.elements,ae=a.elements,be=b.elements;oe[0]=ae[0]+be[0],oe[1]=ae[1]+be[1],oe[2]=ae[2]+be[2],oe[3]=ae[3]+be[3]},Vector4.subtract=function(a,b,out){var oe=out.elements,ae=a.elements,be=b.elements;oe[0]=ae[0]-be[0],oe[1]=ae[1]-be[1],oe[2]=ae[2]-be[2],oe[3]=ae[3]-be[3]},Vector4.multiply=function(a,b,out){var oe=out.elements,ae=a.elements,be=b.elements;oe[0]=ae[0]*be[0],oe[1]=ae[1]*be[1],oe[2]=ae[2]*be[2],oe[3]=ae[3]*be[3]},Vector4.scale=function(a,b,out){var oe=out.elements,ae=a.elements;oe[0]=ae[0]*b,oe[1]=ae[1]*b,oe[2]=ae[2]*b,oe[3]=ae[3]*b},Vector4.Clamp=function(value,min,max,out){var valuee=value.elements,x=valuee[0],y=valuee[1],z=valuee[2],w=valuee[3],mine=min.elements,mineX=mine[0],mineY=mine[1],mineZ=mine[2],mineW=mine[3],maxe=max.elements,maxeX=maxe[0],maxeY=maxe[1],maxeZ=maxe[2],maxeW=maxe[3],oute=out.elements;x=(x=x>maxeX?maxeX:x)<mineX?mineX:x,y=(y=y>maxeY?maxeY:y)<mineY?mineY:y,z=(z=z>maxeZ?maxeZ:z)<mineZ?mineZ:z,w=(w=w>maxeW?maxeW:w)<mineW?mineW:w,oute[0]=x,oute[1]=y,oute[2]=z,oute[3]=w},Vector4.distanceSquared=function(value1,value2){var value1e=value1.elements,value2e=value2.elements,x=value1e[0]-value2e[0],y=value1e[1]-value2e[1],z=value1e[2]-value2e[2],w=value1e[3]-value2e[3];return x*x+y*y+z*z+w*w},Vector4.distance=function(value1,value2){var value1e=value1.elements,value2e=value2.elements,x=value1e[0]-value2e[0],y=value1e[1]-value2e[1],z=value1e[2]-value2e[2],w=value1e[3]-value2e[3];return Math.sqrt(x*x+y*y+z*z+w*w)},Vector4.dot=function(a,b){var ae=a.elements,be=b.elements;return ae[0]*be[0]+ae[1]*be[1]+ae[2]*be[2]+ae[3]*be[3]},Vector4.min=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=Math.min(f[0],g[0]),e[1]=Math.min(f[1],g[1]),e[2]=Math.min(f[2],g[2]),e[3]=Math.min(f[3],g[3])},Vector4.max=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=Math.max(f[0],g[0]),e[1]=Math.max(f[1],g[1]),e[2]=Math.max(f[2],g[2]),e[3]=Math.max(f[3],g[3])},__static(Vector4,["ZERO",function(){return this.ZERO=new Vector4},"ONE",function(){return this.ONE=new Vector4(1,1,1,1)},"UnitX",function(){return this.UnitX=new Vector4(1,0,0,0)},"UnitY",function(){return this.UnitY=new Vector4(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new Vector4(0,0,1,0)},"UnitW",function(){return this.UnitW=new Vector4(0,0,0,1)}]),Vector4}(),Vector3=function(_super){function Vector3(x,y,z,nativeElements){var v;Vector3.__super.call(this),void 0===x&&(x=0),void 0===y&&(y=0),void 0===z&&(z=0),v=nativeElements||new Float32Array(3),this.elements=v,v[0]=x,v[1]=y,v[2]=z}__class(Vector3,"laya.d3.math.Vector3",BaseVector);var __proto=Vector3.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.setValue=function(x,y,z){this.elements[0]=x,this.elements[1]=y,this.elements[2]=z},__proto.fromArray=function(array,offset){void 0===offset&&(offset=0),this.elements[0]=array[offset+0],this.elements[1]=array[offset+1],this.elements[2]=array[offset+2]},__proto.cloneTo=function(destObject){var destE=destObject.elements,s=this.elements;destE[0]=s[0],destE[1]=s[1],destE[2]=s[2]},__proto.clone=function(){var destVector3=new this.constructor;return this.cloneTo(destVector3),destVector3},__proto.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},__getset(0,__proto,"x",function(){return this.elements[0]},function(value){this.elements[0]=value}),__getset(0,__proto,"y",function(){return this.elements[1]},function(value){this.elements[1]=value}),__getset(0,__proto,"z",function(){return this.elements[2]},function(value){this.elements[2]=value}),Vector3.distanceSquared=function(value1,value2){var value1e=value1.elements,value2e=value2.elements,x=value1e[0]-value2e[0],y=value1e[1]-value2e[1],z=value1e[2]-value2e[2];return x*x+y*y+z*z},Vector3.distance=function(value1,value2){var value1e=value1.elements,value2e=value2.elements,x=value1e[0]-value2e[0],y=value1e[1]-value2e[1],z=value1e[2]-value2e[2];return Math.sqrt(x*x+y*y+z*z)},Vector3.min=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=Math.min(f[0],g[0]),e[1]=Math.min(f[1],g[1]),e[2]=Math.min(f[2],g[2])},Vector3.max=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=Math.max(f[0],g[0]),e[1]=Math.max(f[1],g[1]),e[2]=Math.max(f[2],g[2])},Vector3.transformQuat=function(source,rotation,out){var destination=out.elements,se=source.elements,re=rotation.elements,x=se[0],y=se[1],z=se[2],qx=re[0],qy=re[1],qz=re[2],qw=re[3],ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;destination[0]=ix*qw+iw*-qx+iy*-qz-iz*-qy,destination[1]=iy*qw+iw*-qy+iz*-qx-ix*-qz,destination[2]=iz*qw+iw*-qz+ix*-qy-iy*-qx},Vector3.scalarLength=function(a){var f=a.elements,x=f[0],y=f[1],z=f[2];return Math.sqrt(x*x+y*y+z*z)},Vector3.scalarLengthSquared=function(a){var f=a.elements,x=f[0],y=f[1],z=f[2];return x*x+y*y+z*z},Vector3.normalize=function(s,out){var se=s.elements,oe=out.elements,x=se[0],y=se[1],z=se[2],len=x*x+y*y+z*z;len>0&&(len=1/Math.sqrt(len),oe[0]=se[0]*len,oe[1]=se[1]*len,oe[2]=se[2]*len)},Vector3.multiply=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=f[0]*g[0],e[1]=f[1]*g[1],e[2]=f[2]*g[2]},Vector3.scale=function(a,b,out){var e=out.elements,f=a.elements;e[0]=f[0]*b,e[1]=f[1]*b,e[2]=f[2]*b},Vector3.lerp=function(a,b,t,out){var e=out.elements,f=a.elements,g=b.elements,ax=f[0],ay=f[1],az=f[2];e[0]=ax+t*(g[0]-ax),e[1]=ay+t*(g[1]-ay),e[2]=az+t*(g[2]-az)},Vector3.transformV3ToV3=function(vector,transform,result){var intermediate=Vector3._tempVector4;Vector3.transformV3ToV4(vector,transform,intermediate);var intermediateElem=intermediate.elements,resultElem=result.elements;resultElem[0]=intermediateElem[0],resultElem[1]=intermediateElem[1],resultElem[2]=intermediateElem[2]},Vector3.transformV3ToV4=function(vector,transform,result){var vectorElem=vector.elements,vectorX=vectorElem[0],vectorY=vectorElem[1],vectorZ=vectorElem[2],transformElem=transform.elements,resultElem=result.elements;resultElem[0]=vectorX*transformElem[0]+vectorY*transformElem[4]+vectorZ*transformElem[8]+transformElem[12],resultElem[1]=vectorX*transformElem[1]+vectorY*transformElem[5]+vectorZ*transformElem[9]+transformElem[13],resultElem[2]=vectorX*transformElem[2]+vectorY*transformElem[6]+vectorZ*transformElem[10]+transformElem[14],resultElem[3]=vectorX*transformElem[3]+vectorY*transformElem[7]+vectorZ*transformElem[11]+transformElem[15]},Vector3.TransformNormal=function(normal,transform,result){var normalElem=normal.elements,normalX=normalElem[0],normalY=normalElem[1],normalZ=normalElem[2],transformElem=transform.elements,resultElem=result.elements;resultElem[0]=normalX*transformElem[0]+normalY*transformElem[4]+normalZ*transformElem[8],resultElem[1]=normalX*transformElem[1]+normalY*transformElem[5]+normalZ*transformElem[9],resultElem[2]=normalX*transformElem[2]+normalY*transformElem[6]+normalZ*transformElem[10]},Vector3.transformCoordinate=function(coordinate,transform,result){var coordinateElem=coordinate.elements,coordinateX=coordinateElem[0],coordinateY=coordinateElem[1],coordinateZ=coordinateElem[2],transformElem=transform.elements,w=coordinateX*transformElem[3]+coordinateY*transformElem[7]+coordinateZ*transformElem[11]+transformElem[15],resultElem=result.elements;resultElem[0]=coordinateX*transformElem[0]+coordinateY*transformElem[4]+coordinateZ*transformElem[8]+transformElem[12]/w,resultElem[1]=coordinateX*transformElem[1]+coordinateY*transformElem[5]+coordinateZ*transformElem[9]+transformElem[13]/w,resultElem[2]=coordinateX*transformElem[2]+coordinateY*transformElem[6]+coordinateZ*transformElem[10]+transformElem[14]/w},Vector3.Clamp=function(value,min,max,out){var valuee=value.elements,x=valuee[0],y=valuee[1],z=valuee[2],mine=min.elements,mineX=mine[0],mineY=mine[1],mineZ=mine[2],maxe=max.elements,maxeX=maxe[0],maxeY=maxe[1],maxeZ=maxe[2],oute=out.elements;x=(x=x>maxeX?maxeX:x)<mineX?mineX:x,y=(y=y>maxeY?maxeY:y)<mineY?mineY:y,z=(z=z>maxeZ?maxeZ:z)<mineZ?mineZ:z,oute[0]=x,oute[1]=y,oute[2]=z},Vector3.add=function(a,b,out){var e=out.elements,f=a.elements,g=b.elements;e[0]=f[0]+g[0],e[1]=f[1]+g[1],e[2]=f[2]+g[2]},Vector3.subtract=function(a,b,o){var oe=o.elements,ae=a.elements,be=b.elements;oe[0]=ae[0]-be[0],oe[1]=ae[1]-be[1],oe[2]=ae[2]-be[2]},Vector3.cross=function(a,b,o){var ae=a.elements,be=b.elements,oe=o.elements,ax=ae[0],ay=ae[1],az=ae[2],bx=be[0],by=be[1],bz=be[2];oe[0]=ay*bz-az*by,oe[1]=az*bx-ax*bz,oe[2]=ax*by-ay*bx},Vector3.dot=function(a,b){var ae=a.elements,be=b.elements;return ae[0]*be[0]+ae[1]*be[1]+ae[2]*be[2]},Vector3.equals=function(a,b){var ae=a.elements,be=b.elements;return MathUtils3D.nearEqual(ae[0],be[0])&&MathUtils3D.nearEqual(ae[1],be[1])&&MathUtils3D.nearEqual(ae[2],be[2])},Vector3.ZERO=new Vector3(0,0,0),Vector3.ONE=new Vector3(1,1,1),Vector3.NegativeUnitX=new Vector3(-1,0,0),Vector3.UnitX=new Vector3(1,0,0),Vector3.UnitY=new Vector3(0,1,0),Vector3.UnitZ=new Vector3(0,0,1),Vector3.ForwardRH=new Vector3(0,0,-1),Vector3.ForwardLH=new Vector3(0,0,1),Vector3.Up=new Vector3(0,1,0),Vector3.NAN=new Vector3(NaN,NaN,NaN),__static(Vector3,["_tempVector4",function(){return this._tempVector4=new Vector4}]),Vector3}(),Vector2=function(_super){function Vector2(x,y){Vector2.__super.call(this),void 0===x&&(x=0),void 0===y&&(y=0);var v=this.elements=new Float32Array(2);v[0]=x,v[1]=y}__class(Vector2,"laya.d3.math.Vector2",BaseVector);var __proto=Vector2.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto.fromArray=function(array,offset){void 0===offset&&(offset=0),this.elements[0]=array[offset+0],this.elements[1]=array[offset+1]},__proto.cloneTo=function(destObject){var destE=destObject.elements,s=this.elements;destE[0]=s[0],destE[1]=s[1]},__proto.clone=function(){var destVector2=new this.constructor;return this.cloneTo(destVector2),destVector2},__getset(0,__proto,"x",function(){return this.elements[0]},function(value){this.elements[0]=value}),__getset(0,__proto,"y",function(){return this.elements[1]},function(value){this.elements[1]=value}),Vector2.scale=function(a,b,out){var e=out.elements,f=a.elements;e[0]=f[0]*b,e[1]=f[1]*b},Vector2.dot=function(a,b){var ae=a.elements,be=b.elements;return ae[0]*be[0]+ae[1]*be[1]},Vector2.normalize=function(s,out){var se=s.elements,oe=out.elements,x=se[0],y=se[1],len=x*x+y*y;len>0&&(len=1/Math.sqrt(len),oe[0]=se[0]*len,oe[1]=se[1]*len)},Vector2.scalarLength=function(a){var f=a.elements,x=f[0],y=f[1];return Math.sqrt(x*x+y*y)},__static(Vector2,["ZERO",function(){return this.ZERO=new Vector2(0,0)},"ONE",function(){return this.ONE=new Vector2(1,1)}]),Vector2}(),MeshRenderStaticBatchManager=function(_super){function MeshRenderStaticBatchManager(){this._opaqueBatchMarks=[],MeshRenderStaticBatchManager.__super.call(this),this._updateCountMark=0}__class(MeshRenderStaticBatchManager,"laya.d3.graphics.MeshRenderStaticBatchManager",_super);var __proto=MeshRenderStaticBatchManager.prototype;return __proto._compare=function(left,right){var lRender=left._render,rRender=right._render,leftGeo=left.meshFilter.sharedMesh,rightGeo=right.meshFilter.sharedMesh,lightOffset=lRender.lightmapIndex-rRender.lightmapIndex;if(0===lightOffset){var receiveShadowOffset=(lRender.receiveShadow?1:0)-(rRender.receiveShadow?1:0);if(0===receiveShadowOffset){var materialOffset=lRender.sharedMaterial.id-rRender.sharedMaterial.id;if(0===materialOffset){var verDec=leftGeo._vertexBuffers[0].vertexDeclaration.id-rightGeo._vertexBuffers[0].vertexDeclaration.id;return 0===verDec?rightGeo._indexBuffer.indexCount-leftGeo._indexBuffer.indexCount:verDec}return materialOffset}return receiveShadowOffset}return lightOffset},__proto._getBatchRenderElementFromPool=function(){var renderElement=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return renderElement||(renderElement=new SubMeshRenderElement,this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=renderElement,renderElement.staticBatchElementList=[]),renderElement},__proto._getStaticBatch=function(rootOwner,number){var key=rootOwner?rootOwner.id:0,batchOwner=this._staticBatches[key];batchOwner||(batchOwner=this._staticBatches[key]=new MeshRenderStaticBatchOwner(rootOwner));var batches=batchOwner._batches;return batches[number]||(batches[number]=new SubMeshStaticBatch(batchOwner,number,MeshRenderStaticBatchManager._verDec))},__proto._initStaticBatchs=function(rootOwner){this._quickSort(this._initBatchSprites,0,this._initBatchSprites.length-1);for(var curStaticBatch,lastCanMerage=!1,batchNumber=0,i=0,n=this._initBatchSprites.length;i<n;i++){var sprite=this._initBatchSprites[i];if(lastCanMerage)curStaticBatch.addTest(sprite)?curStaticBatch.add(sprite):(lastCanMerage=!1,batchNumber++);else i!==n-1&&((curStaticBatch=this._getStaticBatch(rootOwner,batchNumber)).add(sprite),lastCanMerage=!0)}for(var key in this._staticBatches){var batches=this._staticBatches[key]._batches;for(i=0,n=batches.length;i<n;i++)batches[i].finishInit()}this._initBatchSprites.length=0},__proto._destroyRenderSprite=function(sprite){var staticBatch=sprite._render._staticBatch;if(staticBatch.remove(sprite),0===staticBatch._batchElements.length){var owner=staticBatch.batchOwner._owner,ownerID=owner?owner.id:0,batches=this._staticBatches[ownerID]._batches;batches.splice(staticBatch.number,1),0===batches.length&&delete this._staticBatches[ownerID],staticBatch.dispose()}},__proto._clear=function(){_super.prototype._clear.call(this),this._updateCountMark++},__proto._garbageCollection=function(){for(var key in this._staticBatches)for(var batches=this._staticBatches[key]._batches,i=0,n=batches.length;i<n;i++){var staticBatch=batches[i];0===staticBatch._batchElements.length&&(staticBatch.dispose(),batches.splice(i,1),i--,0===--n&&delete this._staticBatches[key])}},__static(MeshRenderStaticBatchManager,["_verDec",function(){return this._verDec=VertexMesh.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT")},"instance",function(){return this.instance=new MeshRenderStaticBatchManager}]),MeshRenderStaticBatchManager}(StaticBatchManager),ShurikenParticleSystem=function(_super){function ShurikenParticleSystem(owner){ShurikenParticleSystem.__super.call(this),this._tempRotationMatrix=new Matrix4x4,this._uvLength=new Vector2,this._bufferState=new BufferState,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=owner,this._ownerRender=owner.particleRenderer,this._boundingBoxCorners=__newvec(8,null),this._boundingSphere=new BoundSphere(new Vector3,Number.MAX_VALUE),this._boundingBox=new BoundBox(new Vector3(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new Vector3(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new GradientDataNumber,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new GradientDataNumber,this._startLifeTimeGradientMax=new GradientDataNumber,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new Vector3(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new Vector3(0,0,0),this.startSizeConstantMaxSeparate=new Vector3(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new Vector3(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new Vector3(0,0,0),this.startRotationConstantMaxSeparate=new Vector3(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new Vector4(1,1,1,1),this.startColorConstantMin=new Vector4(1,1,1,1),this.startColorConstantMax=new Vector4(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new Rand(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(ShurikenParticleSystem._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Emission,this._emission.enbale=!0}__class(ShurikenParticleSystem,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",_super);var __proto=ShurikenParticleSystem.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._getVertexBuffer=function(index){return void 0===index&&(index=0),0===index?this._vertexBuffer:null},__proto._getIndexBuffer=function(){return this._indexBuffer},__proto._generateBoundingSphere=function(){var centerE=this._boundingSphere.center.elements;centerE[0]=0,centerE[1]=0,centerE[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},__proto._generateBoundingBox=function(){var particleRender=this._owner.particleRenderer,boundMin=this._boundingBox.min,boundMax=this._boundingBox.max,i=0,n=0,maxStartLifeTime=NaN;switch(this.startLifetimeType){case 0:maxStartLifeTime=this.startLifetimeConstant;break;case 1:maxStartLifeTime=-Number.MAX_VALUE;var startLifeTimeGradient=startLifeTimeGradient;for(i=0,n=startLifeTimeGradient.gradientCount;i<n;i++)maxStartLifeTime=Math.max(maxStartLifeTime,startLifeTimeGradient.getValueByIndex(i));break;case 2:maxStartLifeTime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:maxStartLifeTime=-Number.MAX_VALUE;var startLifeTimeGradientMin=startLifeTimeGradientMin;for(i=0,n=startLifeTimeGradientMin.gradientCount;i<n;i++)maxStartLifeTime=Math.max(maxStartLifeTime,startLifeTimeGradientMin.getValueByIndex(i));var startLifeTimeGradientMax=startLifeTimeGradientMax;for(i=0,n=startLifeTimeGradientMax.gradientCount;i<n;i++)maxStartLifeTime=Math.max(maxStartLifeTime,startLifeTimeGradientMax.getValueByIndex(i))}var minPosition,maxPosition,minDirection,maxDirection,minStartSpeed=NaN,maxStartSpeed=NaN;switch(this.startSpeedType){case 0:minStartSpeed=maxStartSpeed=this.startSpeedConstant;break;case 1:break;case 2:minStartSpeed=this.startLifetimeConstantMin,maxStartSpeed=this.startLifetimeConstantMax}this._shape&&this._shape.enable||(minPosition=maxPosition=Vector3.ZERO,minDirection=Vector3.ZERO,maxDirection=Vector3.UnitZ);var positionScale,velocityScale,startMinVelocity=new Vector3(minDirection.x*minStartSpeed,minDirection.y*minStartSpeed,minDirection.z*minStartSpeed),startMaxVelocity=new Vector3(maxDirection.x*maxStartSpeed,maxDirection.y*maxStartSpeed,maxDirection.z*maxStartSpeed);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var velocity=this._velocityOverLifetime.velocity;switch(velocity.type){case 0:velocity.constant;break;case 1:new Vector3(velocity.gradientX.getAverageValue(),velocity.gradientY.getAverageValue(),velocity.gradientZ.getAverageValue());break;case 2:velocity.constantMin,velocity.constantMax;break;case 3:new Vector3(velocity.gradientXMin.getAverageValue(),velocity.gradientYMin.getAverageValue(),velocity.gradientZMin.getAverageValue()),new Vector3(velocity.gradientXMax.getAverageValue(),velocity.gradientYMax.getAverageValue(),velocity.gradientZMax.getAverageValue())}}var minStratPosition,maxStratPosition,transform=this._owner.transform,worldPosition=transform.position,sizeScale=ShurikenParticleSystem._tempVector39,sizeScaleE=sizeScale.elements,renderMode=particleRender.renderMode;switch(this.scaleMode){case 0:var scale=transform.scale;positionScale=scale,sizeScaleE[0]=scale.x,sizeScaleE[1]=scale.z,sizeScaleE[2]=scale.y,1===renderMode&&(velocityScale=scale);break;case 1:var localScale=transform.localScale;positionScale=localScale,sizeScaleE[0]=localScale.x,sizeScaleE[1]=localScale.z,sizeScaleE[2]=localScale.y,1===renderMode&&(velocityScale=localScale);break;case 2:positionScale=transform.scale,sizeScaleE[0]=sizeScaleE[1]=sizeScaleE[2]=1,1===renderMode&&(velocityScale=Vector3.ONE)}switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(minStratPosition=new Vector3(startMinVelocity.x*maxStartLifeTime,startMinVelocity.y*maxStartLifeTime,startMinVelocity.z*maxStartLifeTime),maxStratPosition=new Vector3(startMaxVelocity.x*maxStartLifeTime,startMaxVelocity.y*maxStartLifeTime,startMaxVelocity.z*maxStartLifeTime),2!=this.scaleMode?(Vector3.add(minPosition,minStratPosition,boundMin),Vector3.multiply(positionScale,boundMin,boundMin),Vector3.add(maxPosition,maxStratPosition,boundMax),Vector3.multiply(positionScale,boundMax,boundMax)):(Vector3.multiply(positionScale,minPosition,boundMin),Vector3.add(boundMin,minStratPosition,boundMin),Vector3.multiply(positionScale,maxPosition,boundMax),Vector3.add(boundMax,maxStratPosition,boundMax))),this.simulationSpace){case 0:break;case 1:Vector3.add(boundMin,worldPosition,boundMin),Vector3.add(boundMax,worldPosition,boundMax)}var maxSize=NaN,maxSizeY=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var startSizeConstantSeparate=startSizeConstantSeparate;maxSize=Math.max(startSizeConstantSeparate.x,startSizeConstantSeparate.y),1===renderMode&&(maxSizeY=startSizeConstantSeparate.y)}else maxSize=this.startSizeConstant,1===renderMode&&(maxSizeY=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var startSizeConstantMaxSeparate=startSizeConstantMaxSeparate;maxSize=Math.max(startSizeConstantMaxSeparate.x,startSizeConstantMaxSeparate.y),1===renderMode&&(maxSizeY=startSizeConstantMaxSeparate.y)}else maxSize=this.startSizeConstantMax,1===renderMode&&(maxSizeY=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;maxSize*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var threeDMaxSize=ShurikenParticleSystem._tempVector30,threeDMaxSizeE=threeDMaxSize.elements,rotSize=NaN,nonRotSize=NaN;switch(renderMode){case 0:rotSize=maxSize*ShurikenParticleSystem.halfKSqrtOf2,Vector3.scale(sizeScale,maxSize,threeDMaxSize),Vector3.subtract(boundMin,threeDMaxSize,boundMin),Vector3.add(boundMax,threeDMaxSize,boundMax);break;case 1:var maxStretchPosition=ShurikenParticleSystem._tempVector31,maxStretchVelocity=ShurikenParticleSystem._tempVector32,minStretchVelocity=ShurikenParticleSystem._tempVector33,minStretchPosition=ShurikenParticleSystem._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(Vector3.multiply(velocityScale,startMaxVelocity,maxStretchVelocity),Vector3.multiply(velocityScale,startMinVelocity,minStretchVelocity));var sizeStretch=maxSizeY*particleRender.stretchedBillboardLengthScale,maxStretchLength=Vector3.scalarLength(maxStretchVelocity)*particleRender.stretchedBillboardSpeedScale+sizeStretch,minStretchLength=Vector3.scalarLength(minStretchVelocity)*particleRender.stretchedBillboardSpeedScale+sizeStretch,norMaxStretchVelocity=ShurikenParticleSystem._tempVector35,norMinStretchVelocity=ShurikenParticleSystem._tempVector36;Vector3.normalize(maxStretchVelocity,norMaxStretchVelocity),Vector3.scale(norMaxStretchVelocity,maxStretchLength,minStretchPosition),Vector3.subtract(maxStratPosition,minStretchPosition,minStretchPosition),Vector3.normalize(minStretchVelocity,norMinStretchVelocity),Vector3.scale(norMinStretchVelocity,minStretchLength,maxStretchPosition),Vector3.add(minStratPosition,maxStretchPosition,maxStretchPosition),rotSize=maxSize*ShurikenParticleSystem.halfKSqrtOf2,Vector3.scale(sizeScale,rotSize,threeDMaxSize);var halfNorMaxStretchVelocity=ShurikenParticleSystem._tempVector37,halfNorMinStretchVelocity=ShurikenParticleSystem._tempVector38;Vector3.scale(norMaxStretchVelocity,.5,halfNorMaxStretchVelocity),Vector3.scale(norMinStretchVelocity,.5,halfNorMinStretchVelocity),Vector3.multiply(halfNorMaxStretchVelocity,sizeScale,halfNorMaxStretchVelocity),Vector3.multiply(halfNorMinStretchVelocity,sizeScale,halfNorMinStretchVelocity),Vector3.add(boundMin,halfNorMinStretchVelocity,boundMin),Vector3.min(boundMin,minStretchPosition,boundMin),Vector3.subtract(boundMin,threeDMaxSize,boundMin),Vector3.subtract(boundMax,halfNorMaxStretchVelocity,boundMax),Vector3.max(boundMax,maxStretchPosition,boundMax),Vector3.add(boundMax,threeDMaxSize,boundMax);break;case 2:nonRotSize=.5*(maxSize*=Math.cos(.7853981633974483)),threeDMaxSizeE[0]=sizeScale.x*nonRotSize,threeDMaxSizeE[1]=sizeScale.z*nonRotSize,Vector3.subtract(boundMin,threeDMaxSize,boundMin),Vector3.add(boundMax,threeDMaxSize,boundMax);break;case 3:nonRotSize=.5*(maxSize*=Math.cos(.7853981633974483)),Vector3.scale(sizeScale,nonRotSize,threeDMaxSize),Vector3.subtract(boundMin,threeDMaxSize,boundMin),Vector3.add(boundMax,threeDMaxSize,boundMax)}this._boundingBox.getCorners(this._boundingBoxCorners)},__proto._updateEmission=function(){if(this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var elapsedTime=this._startUpdateLoopCount===Stat.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;elapsedTime=Math.min(ShurikenParticleSystem._maxElapsedTime,elapsedTime),this._updateParticles(elapsedTime)}},__proto._updateParticles=function(elapsedTime){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=elapsedTime,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=elapsedTime,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(elapsedTime,this._currentTime))},__proto._updateParticlesSimulationRestart=function(time){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=time,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=time;var delayTime=time;delayTime<this._playStartDelay?this._totalDelayTime=delayTime:this._emission.enbale&&this._advanceTime(time,time)},__proto._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var index=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,timeIndex=index+this._timeIndex;if(this._currentTime-this._vertices[timeIndex]+1e-4<this._vertices[index+this._startLifeTimeIndex])break;this._vertices[timeIndex]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},__proto._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var age=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&age<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},__proto._burst=function(fromTime,toTime){for(var totalEmitCount=0,bursts=this._emission._bursts,n=bursts.length;this._burstsIndex<n;this._burstsIndex++){var burst=bursts[this._burstsIndex],burstTime=burst.time;if(!(fromTime<=burstTime&&burstTime<toTime))break;var emitCount=0;this.autoRandomSeed?emitCount=MathUtil.lerp(burst.minCount,burst.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],emitCount=MathUtil.lerp(burst.minCount,burst.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),totalEmitCount+=emitCount}return totalEmitCount},__proto._advanceTime=function(elapsedTime,emitTime){var i=0,lastEmissionTime=this._emissionTime;this._emissionTime+=elapsedTime;var totalEmitCount=0;if(this._emissionTime>this.duration){if(!this.looping){for(totalEmitCount=Math.min(this.maxParticles-this.aliveParticleCount,totalEmitCount),i=0;i<totalEmitCount;i++)this.emit(emitTime);return this._isPlaying=!1,void this.stop()}totalEmitCount+=this._burst(lastEmissionTime,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,totalEmitCount+=this._burst(0,this._emissionTime)}else totalEmitCount+=this._burst(lastEmissionTime,this._emissionTime);for(totalEmitCount=Math.min(this.maxParticles-this.aliveParticleCount,totalEmitCount),i=0;i<totalEmitCount;i++)this.emit(emitTime);var emissionRate=this.emission.emissionRate;if(emissionRate>0){var minEmissionTime=1/emissionRate;for(this._frameRateTime+=minEmissionTime,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=emitTime&&this.emit(this._frameRateTime);)this._frameRateTime+=minEmissionTime;this._frameRateTime=Math.floor(emitTime/minEmissionTime)*minEmissionTime}},__proto._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var render=this._ownerRender,renderMode=render.renderMode;if(-1!==renderMode&&this.maxParticles>0){var indices,vertexDeclaration,i=0,j=0,m=0,indexOffset=0,perPartOffset=0,vbMemorySize=0,memorySize=0,mesh=render.mesh;if(4===renderMode){if(mesh){if(mesh._vertexBuffers.length>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");vertexDeclaration=VertexShurikenParticleMesh.vertexDeclaration,this._floatCountPerVertex=vertexDeclaration.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=mesh._vertexBuffers[0].vertexCount;var totalVertexCount=this._bufferMaxParticles*this._vertexStride,lastVBVertexCount=totalVertexCount%65535;if(Math.floor(totalVertexCount/65535)+1>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");vbMemorySize=vertexDeclaration.vertexStride*lastVBVertexCount,this._vertexBuffer=new VertexBuffer3D(vbMemorySize,35048),this._vertexBuffer.vertexDeclaration=vertexDeclaration,this._vertices=new Float32Array(this._floatCountPerVertex*lastVBVertexCount),this._indexStride=mesh._indexBuffer.indexCount;var indexDatas=mesh._indexBuffer.getData(),indexCount=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new IndexBuffer3D("ushort",indexCount,35044),indices=new Uint16Array(indexCount),memorySize=vbMemorySize+2*indexCount,indexOffset=0,i=0;i<this._bufferMaxParticles;i++){var indexValueOffset=i*this._vertexStride;for(j=0,m=indexDatas.length;j<m;j++)indices[indexOffset++]=indexValueOffset+indexDatas[j]}this._indexBuffer.setData(indices),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}}else{for(vertexDeclaration=VertexShurikenParticleBillboard.vertexDeclaration,this._floatCountPerVertex=vertexDeclaration.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,vbMemorySize=vertexDeclaration.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new VertexBuffer3D(vbMemorySize,35048),this._vertexBuffer.vertexDeclaration=vertexDeclaration,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),i=0;i<this._bufferMaxParticles;i++)perPartOffset=i*this._floatCountPerVertex*this._vertexStride,this._vertices[perPartOffset]=-.5,this._vertices[perPartOffset+1]=-.5,this._vertices[perPartOffset+2]=0,this._vertices[perPartOffset+3]=1,perPartOffset+=this._floatCountPerVertex,this._vertices[perPartOffset]=.5,this._vertices[perPartOffset+1]=-.5,this._vertices[perPartOffset+2]=1,this._vertices[perPartOffset+3]=1,perPartOffset+=this._floatCountPerVertex,this._vertices[perPartOffset]=.5,this._vertices[perPartOffset+1]=.5,this._vertices[perPartOffset+2]=1,this._vertices[perPartOffset+3]=0,perPartOffset+=this._floatCountPerVertex,this._vertices[perPartOffset]=-.5,this._vertices[perPartOffset+1]=.5,this._vertices[perPartOffset+2]=0,this._vertices[perPartOffset+3]=0;for(this._indexStride=6,this._indexBuffer=new IndexBuffer3D("ushort",6*this._bufferMaxParticles,35044),indices=new Uint16Array(6*this._bufferMaxParticles),i=0;i<this._bufferMaxParticles;i++){indexOffset=6*i;var firstVertex=i*this._vertexStride,secondVertex=firstVertex+2;indices[indexOffset++]=firstVertex,indices[indexOffset++]=secondVertex,indices[indexOffset++]=firstVertex+1,indices[indexOffset++]=firstVertex,indices[indexOffset++]=firstVertex+3,indices[indexOffset++]=secondVertex}this._indexBuffer.setData(indices),memorySize=vbMemorySize+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind()}Resource._addMemory(memorySize,memorySize)}},__proto.destroy=function(){_super.prototype.destroy.call(this);var memorySize=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;Resource._addMemory(-memorySize,-memorySize),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},__proto.emit=function(time){var position=ShurikenParticleSystem._tempPosition,direction=ShurikenParticleSystem._tempDirection;if(this._shape&&this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(position,direction):this._shape.generatePositionAndDirection(position,direction,this._rand,this._randomSeeds);else{var positionE=position.elements,directionE=direction.elements;positionE[0]=positionE[1]=positionE[2]=0,directionE[0]=directionE[1]=0,directionE[2]=1}return this.addParticle(position,direction,time)},__proto.addParticle=function(position,direction,time){Vector3.normalize(direction,direction);var nextFreeParticle=this._firstFreeElement+1;if(nextFreeParticle>=this._bufferMaxParticles&&(nextFreeParticle=0),nextFreeParticle===this._firstRetiredElement)return!1;if(ShurikenParticleData.create(this,this._ownerRender,this._owner.transform),this._currentTime-time>=ShurikenParticleData.startLifeTime)return!0;var randomVelocityX=NaN,randomVelocityY=NaN,randomVelocityZ=NaN,randomColor=NaN,randomSize=NaN,randomRotation=NaN,randomTextureAnimation=NaN,needRandomVelocity=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(needRandomVelocity){var velocityType=this._velocityOverLifetime.velocity.type;2===velocityType||3===velocityType?this.autoRandomSeed?(randomVelocityX=Math.random(),randomVelocityY=Math.random(),randomVelocityZ=Math.random()):(this._rand.seed=this._randomSeeds[9],randomVelocityX=this._rand.getFloat(),randomVelocityY=this._rand.getFloat(),randomVelocityZ=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):needRandomVelocity=!1}else needRandomVelocity=!1;var needRandomColor=this._colorOverLifetime&&this._colorOverLifetime.enbale;needRandomColor?3===this._colorOverLifetime.color.type?this.autoRandomSeed?randomColor=Math.random():(this._rand.seed=this._randomSeeds[10],randomColor=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):needRandomColor=!1:needRandomColor=!1;var needRandomSize=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;needRandomSize?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?randomSize=Math.random():(this._rand.seed=this._randomSeeds[11],randomSize=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):needRandomSize=!1:needRandomSize=!1;var needRandomRotation=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(needRandomRotation){var rotationType=this._rotationOverLifetime.angularVelocity.type;2===rotationType||3===rotationType?this.autoRandomSeed?randomRotation=Math.random():(this._rand.seed=this._randomSeeds[12],randomRotation=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):needRandomRotation=!1}else needRandomRotation=!1;var needRandomTextureAnimation=this._textureSheetAnimation&&this._textureSheetAnimation.enable;needRandomTextureAnimation?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?randomTextureAnimation=Math.random():(this._rand.seed=this._randomSeeds[15],randomTextureAnimation=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):needRandomTextureAnimation=!1:needRandomTextureAnimation=!1;var meshVertices,startIndex=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,subU=ShurikenParticleData.startUVInfo[0],subV=ShurikenParticleData.startUVInfo[1],startU=ShurikenParticleData.startUVInfo[2],startV=ShurikenParticleData.startUVInfo[3],positionE=position.elements,directionE=direction.elements,meshVertexStride=0,meshPosOffset=0,meshCorOffset=0,meshUVOffset=0,meshVertexIndex=0,render=this._ownerRender;if(4===render.renderMode){var meshVB=render.mesh._vertexBuffers[0];meshVertices=meshVB.getData();var meshVertexDeclaration=meshVB.vertexDeclaration;meshPosOffset=meshVertexDeclaration.getVertexElementByUsage(0).offset/4;var colorElement=meshVertexDeclaration.getVertexElementByUsage(1);meshCorOffset=colorElement?colorElement.offset/4:-1;var uvElement=meshVertexDeclaration.getVertexElementByUsage(2);meshUVOffset=uvElement?uvElement.offset/4:-1,meshVertexStride=meshVertexDeclaration.vertexStride/4,meshVertexIndex=0}else{this._vertices[startIndex+2]=startU,this._vertices[startIndex+3]=startV+subV;var secondOffset=startIndex+this._floatCountPerVertex;this._vertices[secondOffset+2]=startU+subU,this._vertices[secondOffset+3]=startV+subV;var thirdOffset=secondOffset+this._floatCountPerVertex;this._vertices[thirdOffset+2]=startU+subU,this._vertices[thirdOffset+3]=startV;var fourthOffset=thirdOffset+this._floatCountPerVertex;this._vertices[fourthOffset+2]=startU,this._vertices[fourthOffset+3]=startV}for(var i=startIndex,n=startIndex+this._floatCountPerVertex*this._vertexStride;i<n;i+=this._floatCountPerVertex){var offset=0;if(4===render.renderMode){offset=i;var vertexOffset=meshVertexStride*meshVertexIndex++,meshOffset=vertexOffset+meshPosOffset;this._vertices[offset++]=meshVertices[meshOffset++],this._vertices[offset++]=meshVertices[meshOffset++],this._vertices[offset++]=meshVertices[meshOffset],-1===meshCorOffset?(this._vertices[offset++]=1,this._vertices[offset++]=1,this._vertices[offset++]=1,this._vertices[offset++]=1):(meshOffset=vertexOffset+meshCorOffset,this._vertices[offset++]=meshVertices[meshOffset++],this._vertices[offset++]=meshVertices[meshOffset++],this._vertices[offset++]=meshVertices[meshOffset++],this._vertices[offset++]=meshVertices[meshOffset]),-1===meshUVOffset?(this._vertices[offset++]=0,this._vertices[offset++]=0):(meshOffset=vertexOffset+meshUVOffset,this._vertices[offset++]=startU+meshVertices[meshOffset++]*subU,this._vertices[offset++]=startV+meshVertices[meshOffset]*subV)}else offset=i+4;switch(this._vertices[offset++]=positionE[0],this._vertices[offset++]=positionE[1],this._vertices[offset++]=positionE[2],this._vertices[offset++]=ShurikenParticleData.startLifeTime,this._vertices[offset++]=directionE[0],this._vertices[offset++]=directionE[1],this._vertices[offset++]=directionE[2],this._vertices[offset++]=time,this._vertices[offset++]=ShurikenParticleData.startColor[0],this._vertices[offset++]=ShurikenParticleData.startColor[1],this._vertices[offset++]=ShurikenParticleData.startColor[2],this._vertices[offset++]=ShurikenParticleData.startColor[3],this._vertices[offset++]=ShurikenParticleData.startSize[0],this._vertices[offset++]=ShurikenParticleData.startSize[1],this._vertices[offset++]=ShurikenParticleData.startSize[2],this._vertices[offset++]=ShurikenParticleData.startRotation[0],this._vertices[offset++]=ShurikenParticleData.startRotation[1],this._vertices[offset++]=ShurikenParticleData.startRotation[2],this._vertices[offset++]=ShurikenParticleData.startSpeed,needRandomColor&&(this._vertices[offset+1]=randomColor),needRandomSize&&(this._vertices[offset+2]=randomSize),needRandomRotation&&(this._vertices[offset+3]=randomRotation),needRandomTextureAnimation&&(this._vertices[offset+4]=randomTextureAnimation),needRandomVelocity&&(this._vertices[offset+5]=randomVelocityX,this._vertices[offset+6]=randomVelocityY,this._vertices[offset+7]=randomVelocityZ),this.simulationSpace){case 0:offset+=8,this._vertices[offset++]=ShurikenParticleData.simulationWorldPostion[0],this._vertices[offset++]=ShurikenParticleData.simulationWorldPostion[1],this._vertices[offset++]=ShurikenParticleData.simulationWorldPostion[2],this._vertices[offset++]=ShurikenParticleData.simulationWorldRotation[0],this._vertices[offset++]=ShurikenParticleData.simulationWorldRotation[1],this._vertices[offset++]=ShurikenParticleData.simulationWorldRotation[2],this._vertices[offset++]=ShurikenParticleData.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=nextFreeParticle,!0},__proto.addNewParticlesToVertexBuffer=function(){var start=0;this._firstNewElement<this._firstFreeElement?(start=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,start,start,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(start=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,start,start,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},__proto._getType=function(){return ShurikenParticleSystem._type},__proto._prepareRender=function(state){return this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement},__proto._render=function(state){this._bufferState.bind();var indexCount=0,gl=LayaGL.instance;this._firstActiveElement<this._firstFreeElement?(indexCount=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,gl.drawElements(4,indexCount,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=indexCount/3,Stat.renderBatch++):(indexCount=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,gl.drawElements(4,indexCount,5123,2*this._firstActiveElement*this._indexStride),Stat.trianglesFaces+=indexCount/3,Stat.renderBatch++,this._firstFreeElement>0&&(indexCount=this._firstFreeElement*this._indexStride,gl.drawElements(4,indexCount,5123,0),Stat.trianglesFaces+=indexCount/3,Stat.renderBatch++))},__proto.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var i=0,n=this._randomSeeds.length;i<n;i++)this._randomSeeds[i]=this.randomSeed[0]+ShurikenParticleSystem._RANDOMOFFSET[i];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=MathUtil.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=Stat.loopCount},__proto.pause=function(){this._isPaused=!0},__proto.simulate=function(time,restart){void 0===restart&&(restart=!0),this._simulateUpdate=!0,restart?this._updateParticlesSimulationRestart(time):(this._isPaused=!1,this._updateParticles(time)),this.pause()},__proto.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0},__proto.cloneTo=function(destObject){var dest=destObject;dest.duration=this.duration,dest.looping=this.looping,dest.prewarm=this.prewarm,dest.startDelayType=this.startDelayType,dest.startDelay=this.startDelay,dest.startDelayMin=this.startDelayMin,dest.startDelayMax=this.startDelayMax,dest._maxStartLifetime=this._maxStartLifetime,dest.startLifetimeType=this.startLifetimeType,dest.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(dest.startLifeTimeGradient),dest.startLifetimeConstantMin=this.startLifetimeConstantMin,dest.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(dest.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(dest.startLifeTimeGradientMax),dest.startSpeedType=this.startSpeedType,dest.startSpeedConstant=this.startSpeedConstant,dest.startSpeedConstantMin=this.startSpeedConstantMin,dest.startSpeedConstantMax=this.startSpeedConstantMax,dest.threeDStartSize=this.threeDStartSize,dest.startSizeType=this.startSizeType,dest.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(dest.startSizeConstantSeparate),dest.startSizeConstantMin=this.startSizeConstantMin,dest.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(dest.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(dest.startSizeConstantMaxSeparate),dest.threeDStartRotation=this.threeDStartRotation,dest.startRotationType=this.startRotationType,dest.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(dest.startRotationConstantSeparate),dest.startRotationConstantMin=this.startRotationConstantMin,dest.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(dest.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(dest.startRotationConstantMaxSeparate),dest.randomizeRotationDirection=this.randomizeRotationDirection,dest.startColorType=this.startColorType,this.startColorConstant.cloneTo(dest.startColorConstant),this.startColorConstantMin.cloneTo(dest.startColorConstantMin),this.startColorConstantMax.cloneTo(dest.startColorConstantMax),dest.gravityModifier=this.gravityModifier,dest.simulationSpace=this.simulationSpace,dest.scaleMode=this.scaleMode,dest.playOnAwake=this.playOnAwake,dest.maxParticles=this.maxParticles,this._emission&&(dest._emission=this._emission.clone()),this.shape&&(dest.shape=this.shape.clone()),this.velocityOverLifetime&&(dest.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(dest.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(dest.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(dest.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(dest.textureSheetAnimation=this.textureSheetAnimation.clone()),dest.isPerformanceMode=this.isPerformanceMode,dest._isEmitting=this._isEmitting,dest._isPlaying=this._isPlaying,dest._isPaused=this._isPaused,dest._playStartDelay=this._playStartDelay,dest._frameRateTime=this._frameRateTime,dest._emissionTime=this._emissionTime,dest._totalDelayTime=this._totalDelayTime,dest._burstsIndex=this._burstsIndex},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__getset(0,__proto,"maxParticles",function(){return this._bufferMaxParticles-1},function(value){var newMaxParticles=value+1;newMaxParticles!==this._bufferMaxParticles&&(this._bufferMaxParticles=newMaxParticles,this._initBufferDatas())}),__getset(0,__proto,"isEmitting",function(){return this._isEmitting}),__getset(0,__proto,"isAlive",function(){return!!(this._isPlaying||this.aliveParticleCount>0)}),__getset(0,__proto,"shape",function(){return this._shape},function(value){this._shape!==value&&(value&&value.enable?this._owner._render._defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_SHAPE):this._owner._render._defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_SHAPE),this._shape=value)}),__getset(0,__proto,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(value){var defDat=this._owner._render._defineDatas,shaDat=this._owner._render._shaderValues;if(value){var rotation=value.angularVelocity;if(!rotation)return;var rotationSeparate=rotation.separateAxes,rotationType=rotation.type;if(value.enbale)switch(rotationSeparate?defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),rotationType){case 0:defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:defDat.add(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(rotationType){case 0:rotationSeparate?shaDat.setVector(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTSEPRARATE,rotation.constantSeparate):shaDat.setNumber(ShuriKenParticle3D.ROLANGULARVELOCITYCONST,rotation.constant);break;case 1:rotationSeparate?(shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTX,rotation.gradientX._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTY,rotation.gradientY._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTZ,rotation.gradientZ._elements)):shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENT,rotation.gradient._elements);break;case 2:rotationSeparate?(shaDat.setVector(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTSEPRARATE,rotation.constantMinSeparate),shaDat.setVector(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTMAXSEPRARATE,rotation.constantMaxSeparate)):(shaDat.setNumber(ShuriKenParticle3D.ROLANGULARVELOCITYCONST,rotation.constantMin),shaDat.setNumber(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTMAX,rotation.constantMax));break;case 3:rotationSeparate?(shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTX,rotation.gradientXMin._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTXMAX,rotation.gradientXMax._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTY,rotation.gradientYMin._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTYMAX,rotation.gradientYMax._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTZ,rotation.gradientZMin._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTZMAX,rotation.gradientZMax._elements)):(shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENT,rotation.gradientMin._elements),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTMAX,rotation.gradientMax._elements))}}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),shaDat.setVector(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTSEPRARATE,null),shaDat.setVector(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTMAXSEPRARATE,null),shaDat.setNumber(ShuriKenParticle3D.ROLANGULARVELOCITYCONST,void 0),shaDat.setNumber(ShuriKenParticle3D.ROLANGULARVELOCITYCONSTMAX,void 0),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTX,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTXMAX,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTY,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTYMAX,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTZ,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTZMAX,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTWMAX,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENT,null),shaDat.setBuffer(ShuriKenParticle3D.ROLANGULARVELOCITYGRADIENTMAX,null);this._rotationOverLifetime=value}),__getset(0,__proto,"emission",function(){return this._emission}),__getset(0,__proto,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),__getset(0,__proto,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),__getset(0,__proto,"isPlaying",function(){return this._isPlaying}),__getset(0,__proto,"isPaused",function(){return this._isPaused}),__getset(0,__proto,"startLifetimeType",function(){return this._startLifetimeType},function(value){var i=0,n=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var startLifeTimeGradient=startLifeTimeGradient;for(i=0,n=startLifeTimeGradient.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,startLifeTimeGradient.getValueByIndex(i));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var startLifeTimeGradientMin=startLifeTimeGradientMin;for(i=0,n=startLifeTimeGradientMin.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,startLifeTimeGradientMin.getValueByIndex(i));var startLifeTimeGradientMax=startLifeTimeGradientMax;for(i=0,n=startLifeTimeGradientMax.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,startLifeTimeGradientMax.getValueByIndex(i))}this._startLifetimeType=value}),__getset(0,__proto,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(value){0===this._startLifetimeType&&(this._maxStartLifetime=value),this._startLifetimeConstant=value}),__getset(0,__proto,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(value){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(value,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=value}),__getset(0,__proto,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(value){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var i=0,n=value.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,value.getValueByIndex(i))}this._startLifeTimeGradient=value}),__getset(0,__proto,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(value){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,value)),this._startLifetimeConstantMax=value}),__getset(0,__proto,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(value){if(3===this._startLifetimeType){var i=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,i=0,n=value.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,value.getValueByIndex(i));for(i=0,n=this._startLifeTimeGradientMax.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(i))}this._startLifeTimeGradientMin=value}),__getset(0,__proto,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(value){if(3===this._startLifetimeType){var i=0,n=0;for(this._maxStartLifetime=-Number.MAX_VALUE,i=0,n=this._startLifeTimeGradientMin.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(i));for(i=0,n=value.gradientCount;i<n;i++)this._maxStartLifetime=Math.max(this._maxStartLifetime,value.getValueByIndex(i))}this._startLifeTimeGradientMax=value}),__getset(0,__proto,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(value){var defDat=this._owner._render._defineDatas,shaDat=this._owner._render._shaderValues;if(value){var velocity=value.velocity,velocityType=velocity.type;if(value.enbale)switch(velocityType){case 0:defDat.add(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:defDat.add(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:defDat.add(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:defDat.add(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(velocityType){case 0:shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONST,velocity.constant);break;case 1:shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTX,velocity.gradientX._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTY,velocity.gradientY._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZ,velocity.gradientZ._elements);break;case 2:shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONST,velocity.constantMin),shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONSTMAX,velocity.constantMax);break;case 3:shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTX,velocity.gradientXMin._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTXMAX,velocity.gradientXMax._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTY,velocity.gradientYMin._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTYMAX,velocity.gradientYMax._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZ,velocity.gradientZMin._elements),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZMAX,velocity.gradientZMax._elements)}shaDat.setInt(ShuriKenParticle3D.VOLSPACETYPE,value.space)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONST,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTX,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTY,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZ,null),shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONST,null),shaDat.setVector(ShuriKenParticle3D.VOLVELOCITYCONSTMAX,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTX,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTXMAX,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTY,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTYMAX,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZ,null),shaDat.setBuffer(ShuriKenParticle3D.VOLVELOCITYGRADIENTZMAX,null),shaDat.setInt(ShuriKenParticle3D.VOLSPACETYPE,void 0);this._velocityOverLifetime=value}),__getset(0,__proto,"colorOverLifetime",function(){return this._colorOverLifetime},function(value){var defDat=this._owner._render._defineDatas,shaDat=this._owner._render._shaderValues;if(value){var color=value.color;if(value.enbale)switch(color.type){case 1:defDat.add(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:defDat.add(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(color.type){case 1:var gradientColor=color.gradient;shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTALPHAS,gradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTCOLORS,gradientColor._rgbElements);break;case 3:var minGradientColor=color.gradientMin,maxGradientColor=color.gradientMax;shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTALPHAS,minGradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTCOLORS,minGradientColor._rgbElements),shaDat.setBuffer(ShuriKenParticle3D.MAXCOLOROVERLIFEGRADIENTALPHAS,maxGradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.MAXCOLOROVERLIFEGRADIENTCOLORS,maxGradientColor._rgbElements)}}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTALPHAS,gradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTCOLORS,gradientColor._rgbElements),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTALPHAS,minGradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.COLOROVERLIFEGRADIENTCOLORS,minGradientColor._rgbElements),shaDat.setBuffer(ShuriKenParticle3D.MAXCOLOROVERLIFEGRADIENTALPHAS,maxGradientColor._alphaElements),shaDat.setBuffer(ShuriKenParticle3D.MAXCOLOROVERLIFEGRADIENTCOLORS,maxGradientColor._rgbElements);this._colorOverLifetime=value}),__getset(0,__proto,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(value){var defDat=this._owner._render._defineDatas,shaDat=this._owner._render._shaderValues;if(value){var size=value.size,sizeSeparate=size.separateAxes,sizeType=size.type;if(value.enbale)switch(sizeType){case 0:sizeSeparate?defDat.add(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):defDat.add(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:sizeSeparate?defDat.add(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):defDat.add(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(sizeType){case 0:sizeSeparate?(shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTX,size.gradientX._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTY,size.gradientY._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientZ,size.gradientZ._elements)):shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENT,size.gradient._elements);break;case 2:sizeSeparate?(shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTX,size.gradientXMin._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTXMAX,size.gradientXMax._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTY,size.gradientYMin._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTYMAX,size.gradientYMax._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientZ,size.gradientZMin._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientZMAX,size.gradientZMax._elements)):(shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENT,size.gradientMin._elements),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientMax,size.gradientMax._elements))}}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTX,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTXMAX,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTY,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENTYMAX,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientZ,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientZMAX,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSIZEGRADIENT,null),shaDat.setBuffer(ShuriKenParticle3D.SOLSizeGradientMax,null);this._sizeOverLifetime=value}),__getset(0,__proto,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(value){var defDat=this._owner._render._defineDatas,shaDat=this._owner._render._shaderValues;if(value){var frameOverTime=value.frame,textureAniType=frameOverTime.type;if(value.enable)switch(textureAniType){case 1:defDat.add(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:defDat.add(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===textureAniType||3===textureAniType){shaDat.setNumber(ShuriKenParticle3D.TEXTURESHEETANIMATIONCYCLES,value.cycles);var title=value.tiles,_uvLengthE=this._uvLength.elements;_uvLengthE[0]=1/title.x,_uvLengthE[1]=1/title.y,shaDat.setVector(ShuriKenParticle3D.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength)}switch(textureAniType){case 1:shaDat.setBuffer(ShuriKenParticle3D.TEXTURESHEETANIMATIONGRADIENTUVS,frameOverTime.frameOverTimeData._elements);break;case 3:shaDat.setBuffer(ShuriKenParticle3D.TEXTURESHEETANIMATIONGRADIENTUVS,frameOverTime.frameOverTimeDataMin._elements),shaDat.setBuffer(ShuriKenParticle3D.TEXTURESHEETANIMATIONGRADIENTMAXUVS,frameOverTime.frameOverTimeDataMax._elements)}}else defDat.remove(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),defDat.remove(ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),shaDat.setNumber(ShuriKenParticle3D.TEXTURESHEETANIMATIONCYCLES,void 0),shaDat.setVector(ShuriKenParticle3D.TEXTURESHEETANIMATIONSUBUVLENGTH,null),shaDat.setBuffer(ShuriKenParticle3D.TEXTURESHEETANIMATIONGRADIENTUVS,null),shaDat.setBuffer(ShuriKenParticle3D.TEXTURESHEETANIMATIONGRADIENTMAXUVS,null);this._textureSheetAnimation=value}),ShurikenParticleSystem.halfKSqrtOf2=.71,__static(ShurikenParticleSystem,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new Vector3},"_tempVector31",function(){return this._tempVector31=new Vector3},"_tempVector32",function(){return this._tempVector32=new Vector3},"_tempVector33",function(){return this._tempVector33=new Vector3},"_tempVector34",function(){return this._tempVector34=new Vector3},"_tempVector35",function(){return this._tempVector35=new Vector3},"_tempVector36",function(){return this._tempVector36=new Vector3},"_tempVector37",function(){return this._tempVector37=new Vector3},"_tempVector38",function(){return this._tempVector38=new Vector3},"_tempVector39",function(){return this._tempVector39=new Vector3},"_tempPosition",function(){return this._tempPosition=new Vector3},"_tempDirection",function(){return this._tempDirection=new Vector3},"_type",function(){return this._type=GeometryElement._typeCounter++}]),ShurikenParticleSystem}(GeometryElement),VertexShurikenParticleBillboard=function(_super){function VertexShurikenParticleBillboard(cornerTextureCoordinate,positionStartLifeTime,velocity,startColor,startSize,startRotation0,startRotation1,startRotation2,ageAddScale,time,startSpeed,randoms0,randoms1,simulationWorldPostion){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,VertexShurikenParticleBillboard.__super.call(this),this._cornerTextureCoordinate=cornerTextureCoordinate,this._positionStartLifeTime=positionStartLifeTime,this._velocity=velocity,this._startColor=startColor,this._startSize=startSize,this._startRotation0=startRotation0,this._startRotation1=startRotation1,this._startRotation2=startRotation2,this._startLifeTime=ageAddScale,this._time=time,this._startSpeed=startSpeed,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=simulationWorldPostion}__class(VertexShurikenParticleBillboard,"laya.d3.graphics.Vertex.VertexShurikenParticleBillboard",VertexShuriKenParticle);var __proto=VertexShurikenParticleBillboard.prototype;return __getset(0,__proto,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),__getset(0,__proto,"random1",function(){return this._randoms1}),__getset(0,__proto,"startRotation2",function(){return this._startRotation2}),__getset(0,__proto,"positionStartLifeTime",function(){return this._positionStartLifeTime}),__getset(0,__proto,"velocity",function(){return this._velocity}),__getset(0,__proto,"random0",function(){return this._randoms0}),__getset(0,__proto,"startSize",function(){return this._startSize}),__getset(0,__proto,"startColor",function(){return this._startColor}),__getset(0,__proto,"startRotation0",function(){return this._startRotation0}),__getset(0,__proto,"startRotation1",function(){return this._startRotation1}),__getset(0,__proto,"startLifeTime",function(){return this._startLifeTime}),__getset(0,__proto,"time",function(){return this._time}),__getset(0,__proto,"startSpeed",function(){return this._startSpeed}),__getset(0,__proto,"simulationWorldPostion",function(){return this._simulationWorldPostion}),__getset(1,VertexShurikenParticleBillboard,"vertexDeclaration",function(){return VertexShurikenParticleBillboard._vertexDeclaration},laya.d3.graphics.Vertex.VertexShuriKenParticle._$SET_vertexDeclaration),__static(VertexShurikenParticleBillboard,["_vertexDeclaration",function(){return this._vertexDeclaration=new VertexDeclaration(152,[new VertexElement(0,"vector4",0),new VertexElement(16,"vector4",4),new VertexElement(32,"vector4",5),new VertexElement(48,"vector4",6),new VertexElement(64,"vector3",8),new VertexElement(76,"vector3",9),new VertexElement(88,"single",10),new VertexElement(92,"vector4",11),new VertexElement(108,"vector4",12),new VertexElement(124,"vector3",13),new VertexElement(136,"vector4",14)])}]),VertexShurikenParticleBillboard}(),CastShadowList=function(_super){function CastShadowList(){CastShadowList.__super.call(this)}__class(CastShadowList,"laya.d3.CastShadowList",SingletonList);var __proto=CastShadowList.prototype;return __proto.add=function(element){if(-1!==element._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(element),element._indexInCastShadowList=this.length++},__proto.remove=function(element){var index=element._indexInCastShadowList;if(this.length--,index!==this.length){var end=this.elements[this.length];this.elements[index]=end,end._indexInCastShadowList=index}element._indexInCastShadowList=-1},CastShadowList}(),PhysicsUpdateList=function(_super){function PhysicsUpdateList(){PhysicsUpdateList.__super.call(this)}return __class(PhysicsUpdateList,"laya.d3.physics.PhysicsUpdateList",SingletonList),PhysicsUpdateList.prototype.add=function(element){if(-1!==element._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(element),element._inPhysicUpdateListIndex=this.length++},PhysicsUpdateList}(),SimpleSingletonList=function(_super){function SimpleSingletonList(){SimpleSingletonList.__super.call(this)}__class(SimpleSingletonList,"laya.d3.component.SimpleSingletonList",SingletonList);var __proto=SimpleSingletonList.prototype;return __proto.add=function(element){this._add(element),element._setIndexInList(this.length++)},__proto.remove=function(element){var index=element._getIndexInList();if(this.length--,index!==this.length){var end=this.elements[this.length];this.elements[index]=end,end&&end._setIndexInList(index)}element._setIndexInList(-1)},SimpleSingletonList}(),Sprite3D=function(_super){function Sprite3D(name,isStatic){this._needProcessCollisions=!1,this._needProcessTriggers=!1,Sprite3D.__super.call(this),void 0===isStatic&&(isStatic=!1),this._id=++Sprite3D._uniqueIDCounter,this._transform=new Transform3D(this),this._isStatic=isStatic,this.layer=0,this.name=name||"New Sprite3D"}__class(Sprite3D,"laya.d3.core.Sprite3D",_super);var __proto=Sprite3D.prototype;return Laya.imps(__proto,{"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),__proto._setCreateURL=function(url){this._url=url},__proto._changeAnimatorsToLinkSprite3D=function(sprite3D,isLink,path){var animator=this.getComponent(Animator);if(animator&&(animator.avatar||sprite3D._changeAnimatorToLinkSprite3DNoAvatar(animator,isLink,path)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){path.unshift(this._parent.name);var p=this._parent;p._hierarchyAnimator&&p._changeAnimatorsToLinkSprite3D(sprite3D,isLink,path)}},__proto._setHierarchyAnimator=function(animator,parentAnimator){this._changeHierarchyAnimator(animator),this._changeAnimatorAvatar(animator.avatar);for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i];child._hierarchyAnimator==parentAnimator&&child._setHierarchyAnimator(animator,parentAnimator)}},__proto._clearHierarchyAnimator=function(animator,parentAnimator){this._changeHierarchyAnimator(parentAnimator),this._changeAnimatorAvatar(parentAnimator?parentAnimator.avatar:null);for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i];child._hierarchyAnimator==animator&&child._clearHierarchyAnimator(animator,parentAnimator)}},__proto._changeHierarchyAnimatorAvatar=function(animator,avatar){this._changeAnimatorAvatar(avatar);for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i];child._hierarchyAnimator==animator&&child._changeHierarchyAnimatorAvatar(animator,avatar)}},__proto._changeAnimatorToLinkSprite3DNoAvatar=function(animator,isLink,path){animator._handleSpriteOwnersBySprite(isLink,path,this);for(var i=0,n=this._children.length;i<n;i++){var child=this._children[i],index=path.length;path.push(child.name),child._changeAnimatorToLinkSprite3DNoAvatar(animator,isLink,path),path.splice(index,1)}},__proto._changeHierarchyAnimator=function(animator){this._hierarchyAnimator=animator},__proto._changeAnimatorAvatar=function(avatar){},__proto._onAdded=function(){if(this._parent instanceof laya.d3.core.Sprite3D){var parent3D=this._parent;this.transform._setParent(parent3D.transform),parent3D._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(parent3D._hierarchyAnimator,null),parent3D._changeAnimatorsToLinkSprite3D(this,!0,[this.name]))}_super.prototype._onAdded.call(this)},__proto._onRemoved=function(){if(_super.prototype._onRemoved.call(this),this._parent instanceof laya.d3.core.Sprite3D){var parent3D=this._parent;this.transform._setParent(null),parent3D._hierarchyAnimator&&(this._hierarchyAnimator==parent3D._hierarchyAnimator&&this._clearHierarchyAnimator(parent3D._hierarchyAnimator,null),parent3D._changeAnimatorsToLinkSprite3D(this,!1,[this.name]))}},__proto._parse=function(data){if(void 0!==data.isStatic&&(this._isStatic=data.isStatic),void 0!==data.active&&(this.active=data.active),null!=data.name&&(this.name=data.name),void 0!==data.position){var loccalPosition=this.transform.localPosition;loccalPosition.fromArray(data.position),this.transform.localPosition=loccalPosition}if(void 0!==data.rotationEuler){var localRotationEuler=this.transform.localRotationEuler;localRotationEuler.fromArray(data.rotationEuler),this.transform.localRotationEuler=localRotationEuler}if(void 0!==data.rotation){var localRotation=this.transform.localRotation;localRotation.fromArray(data.rotation),this.transform.localRotation=localRotation}if(void 0!==data.scale){var localScale=this.transform.localScale;localScale.fromArray(data.scale),this.transform.localScale=localScale}null!=data.layer&&(this.layer=data.layer)},__proto.cloneTo=function(destObject){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");for(var destSprite3D=destObject,i=0,n=this._children.length;i<n;i++)destSprite3D.addChild(this._children[i].clone());destSprite3D.name=this.name,destSprite3D.destroyed=this.destroyed,destSprite3D.active=this.active;var destLocalPosition=destSprite3D.transform.localPosition;this.transform.localPosition.cloneTo(destLocalPosition),destSprite3D.transform.localPosition=destLocalPosition;var destLocalRotation=destSprite3D.transform.localRotation;this.transform.localRotation.cloneTo(destLocalRotation),destSprite3D.transform.localRotation=destLocalRotation;var destLocalScale=destSprite3D.transform.localScale;this.transform.localScale.cloneTo(destLocalScale),destSprite3D.transform.localScale=destLocalScale,destSprite3D._isStatic=this._isStatic,destSprite3D.layer=this.layer,this._cloneTo(destSprite3D)},__proto.clone=function(){var destSprite3D=new this.constructor;return this.cloneTo(destSprite3D),destSprite3D},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._transform=null,this._scripts=null,this._url&&Loader.clearRes(this._url))},__proto._getBoundPointsM=function(){var rst=[],pos=this.transform.position,scale=this.transform.scale;return rst.push(pos.x,pos.z,pos.x+scale.x,pos.z,pos.x,pos.z+scale.z,pos.x+scale.x,pos.z+scale.z),rst},__proto.localToGlobal=function(point,createNewPoint,globalNode){return point},__getset(0,__proto,"id",function(){return this._id}),__getset(0,__proto,"url",function(){return this._url}),__getset(0,__proto,"layer",function(){return this._layer},function(value){if(this._layer!==value){if(!(value>=0&&value<=30))throw new Error("Layer value must be 0-30.");this._layer=value}}),__getset(0,__proto,"transform",function(){return this._transform}),__getset(0,__proto,"isStatic",function(){return this._isStatic}),Sprite3D._parse=function(data,propertyParams,constructParams){var json=data.data,outBatchSprits=[],sprite=Utils3D._createNodeByJson(json,outBatchSprits);return StaticBatchManager.combine(sprite,outBatchSprits),sprite},Sprite3D.__init__=function(){},Sprite3D.instantiate=function(original,parent,worldPositionStays,position,rotation){void 0===worldPositionStays&&(worldPositionStays=!0);var destSprite3D=original.clone();parent&&parent.addChild(destSprite3D);var transform=destSprite3D.transform;if(worldPositionStays){var worldMatrix=transform.worldMatrix;original.transform.worldMatrix.cloneTo(worldMatrix),transform.worldMatrix=worldMatrix}else position&&(transform.position=position),rotation&&(transform.rotation=rotation);return destSprite3D},Sprite3D.load=function(url,complete){Laya.loader.create(url,complete,null,"HIERARCHY")},Sprite3D._uniqueIDCounter=0,__static(Sprite3D,["WORLDMATRIX",function(){return this.WORLDMATRIX=Shader3D.propertyNameToID("u_WorldMat")},"MVPMATRIX",function(){return this.MVPMATRIX=Shader3D.propertyNameToID("u_MvpMatrix")}]),Sprite3D}(Node),BaseMaterial=function(_super){function BaseMaterial(){BaseMaterial.__super.call(this),this._defineDatas=new DefineDatas,this._disablePublicDefineDatas=new DefineDatas,this._shaderValues=new ShaderData(this),this.renderQueue=2e3,this._alphaTest=!1,this._renderStates=[]}__class(BaseMaterial,"laya.d3.core.material.BaseMaterial",_super);var __proto=BaseMaterial.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._removeTetxureReference=function(){var data=this._shaderValues._data;for(var k in data){var value=data[k];value&&value instanceof laya.webgl.resource.BaseTexture&&value._removeReference()}},__proto._addReference=function(count){void 0===count&&(count=1),_super.prototype._addReference.call(this,count);var data=this._shaderValues._data;for(var k in data){var value=data[k];value&&value instanceof laya.webgl.resource.BaseTexture&&value._addReference()}},__proto._removeReference=function(count){void 0===count&&(count=1),_super.prototype._removeReference.call(this,count),this._removeTetxureReference()},__proto._disposeResource=function(){this._referenceCount>0&&this._removeTetxureReference(),this._shaderValues=null},__proto.setShaderName=function(name){if(this._shader=Shader3D._preCompileShader[name],!this._shader)throw new Error("BaseMaterial: unknown shader name.");var passCount=this._shader.getSubShaderAt(0)._passes.length;this._renderStates.length=passCount;for(var i=0;i<passCount;i++)this._renderStates[i]||(this._renderStates[i]=new RenderState)},__proto.getRenderState=function(passIndex){return void 0===passIndex&&(passIndex=0),this._renderStates[passIndex]},__proto.cloneTo=function(destObject){var destBaseMaterial=destObject;destBaseMaterial.name=this.name,destBaseMaterial.renderQueue=this.renderQueue,this._disablePublicDefineDatas.cloneTo(destBaseMaterial._disablePublicDefineDatas),this._defineDatas.cloneTo(destBaseMaterial._defineDatas),this._shaderValues.cloneTo(destBaseMaterial._shaderValues);for(var destRenderStates=destObject._renderStates,i=0,n=this._renderStates.length;i<n;i++)this._renderStates[i].cloneTo(destRenderStates[i])},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__getset(0,__proto,"alphaTestValue",function(){return this._shaderValues.getNumber(BaseMaterial.ALPHATESTVALUE)},function(value){this._shaderValues.setNumber(BaseMaterial.ALPHATESTVALUE,value)}),__getset(0,__proto,"alphaTest",function(){return this._alphaTest},function(value){this._alphaTest=value,value?this._defineDatas.add(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._defineDatas.remove(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST)}),BaseMaterial.load=function(url,complete){Laya.loader.create(url,complete,null,"MATERIAL")},BaseMaterial.__init__=function(){BaseMaterial.SHADERDEFINE_ALPHATEST=BaseMaterial.shaderDefines.registerDefine("ALPHATEST")},BaseMaterial._parse=function(data,propertyParams,constructParams){var material,jsonData=data,props=jsonData.props,clasPaths=props.type.split("."),clas=Browser.window;if(clasPaths.forEach(function(cls){clas=clas[cls]}),"function"!=typeof clas)throw"_getSprite3DHierarchyInnerUrls 错误: "+data.type+" 不是类";switch(material=new clas,jsonData.version){case"LAYAMATERIAL:01":for(key in props=jsonData.props)switch(key){case"vectors":for(i=0,n=(vectors=props[key]).length;i<n;i++)switch((vectorValue=(vector=vectors[i]).value).length){case 2:material[vector.name]=new Vector2(vectorValue[0],vectorValue[1]);break;case 3:material[vector.name]=new Vector3(vectorValue[0],vectorValue[1],vectorValue[2]);break;case 4:material[vector.name]=new Vector4(vectorValue[0],vectorValue[1],vectorValue[2],vectorValue[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}break;case"textures":for(i=0,n=(textures=props[key]).length;i<n;i++)(path=(texture=textures[i]).path)&&(material[texture.name]=Loader.getRes(path));break;case"defines":for(i=0,n=(defineNames=props[key]).length;i<n;i++)define=material._shader.getSubShaderAt(0).getMaterialDefineByName(defineNames[i]),material._defineDatas.add(define);break;case"cull":case"blend":case"srcBlend":case"dstBlend":case"depthWrite":var value=props[key];for(i=0,n=material._renderStates.length;i<n;i++)material._renderStates[i][key]=value;break;case"renderQueue":switch(props[key]){case 1:material.renderQueue=2e3;break;case 2:material.renderQueue=3e3;break;default:material[key]=props[key]}break;default:material[key]=props[key]}break;case"LAYAMATERIAL:02":var i=0,n=0;for(var key in props)switch(key){case"vectors":var vectors=props[key];for(i=0,n=vectors.length;i<n;i++){var vector=vectors[i],vectorValue=vector.value;switch(vectorValue.length){case 2:material[vector.name]=new Vector2(vectorValue[0],vectorValue[1]);break;case 3:material[vector.name]=new Vector3(vectorValue[0],vectorValue[1],vectorValue[2]);break;case 4:material[vector.name]=new Vector4(vectorValue[0],vectorValue[1],vectorValue[2],vectorValue[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var textures=props[key];for(i=0,n=textures.length;i<n;i++){var texture=textures[i],path=texture.path;path&&(material[texture.name]=Loader.getRes(path))}break;case"defines":var defineNames=props[key];for(i=0,n=defineNames.length;i<n;i++){var define=material._shader.getSubShaderAt(0).getMaterialDefineByName(defineNames[i]);material._defineDatas.add(define)}break;case"renderStates":var renderStatesData=props[key];for(i=0,n=renderStatesData.length;i<n;i++){var renderStateData=renderStatesData[i],renderState=material._renderStates[i];for(var stateKey in renderStateData)renderState[stateKey]=renderStateData[stateKey]}break;default:material[key]=props[key]}break;default:throw new Error("BaseMaterial:unkonwn version.")}return material},BaseMaterial.RENDERQUEUE_OPAQUE=2e3,BaseMaterial.RENDERQUEUE_ALPHATEST=2450,BaseMaterial.RENDERQUEUE_TRANSPARENT=3e3,BaseMaterial.SHADERDEFINE_ALPHATEST=0,__static(BaseMaterial,["ALPHATESTVALUE",function(){return this.ALPHATESTVALUE=Shader3D.propertyNameToID("u_AlphaTestValue")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines}]),BaseMaterial}(Resource),TerrainHeightData=function(_super){function TerrainHeightData(width,height,bitType,value){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,TerrainHeightData.__super.call(this),this._width=width,this._height=height,this._bitType=bitType,this._value=value}return __class(TerrainHeightData,"laya.d3.terrain.TerrainHeightData",Resource),TerrainHeightData._pharse=function(data,propertyParams,constructParams){var buffer,terrainHeightData=new TerrainHeightData(constructParams[0],constructParams[1],constructParams[2],constructParams[3]),ratio=NaN;8==terrainHeightData._bitType?(buffer=new Uint8Array(data),ratio=1/255):16==terrainHeightData._bitType&&(buffer=new Int16Array(data),ratio=1/32766),terrainHeightData._terrainHeightData=new Float32Array(terrainHeightData._height*terrainHeightData._width);for(var i=0,n=terrainHeightData._height*terrainHeightData._width;i<n;i++)terrainHeightData._terrainHeightData[i]=buffer[i]*ratio*terrainHeightData._value/2},TerrainHeightData.load=function(url,complete,widht,height,bitType,value){Laya.loader.create(url,complete,null,"TERRAINHEIGHTDATA",[widht,height,bitType,value],null,1,!1)},TerrainHeightData}(),Avatar=function(_super){function Avatar(){this._rootNode=null,this._nativeNodeCount=0,this._nativeCurCloneCount=0,Avatar.__super.call(this)}__class(Avatar,"laya.d3.core.Avatar",Resource);var __proto=Avatar.prototype;return Laya.imps(__proto,{"laya.d3.core.IClone":!0}),__proto._initCloneToAnimator=function(destNode,destAnimator){destAnimator._avatarNodeMap[destNode.name]=destNode;for(var i=0,n=destNode.getChildCount();i<n;i++)this._initCloneToAnimator(destNode.getChildByIndex(i),destAnimator)},__proto._parseNode=function(nodaData,node){var name=nodaData.props.name;node.name=name;var props=nodaData.props,transform=node.transform,pos=transform.localPosition,rot=transform.localRotation,sca=transform.localScale;pos.fromArray(props.translate),rot.fromArray(props.rotation),sca.fromArray(props.scale),transform.localPosition=pos,transform.localRotation=rot,transform.localScale=sca;for(var childrenData=nodaData.child,j=0,n=childrenData.length;j<n;j++){var childData=childrenData[j],childBone=new AnimationNode(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16));node.addChild(childBone),Render.isConchApp&&this._nativeNodeCount++,this._parseNode(childData,childBone)}},__proto._cloneDatasToAnimator=function(destAnimator){var destRoot;destRoot=this._rootNode.clone();var transform=this._rootNode.transform,destTransform=destRoot.transform,destPosition=destTransform.localPosition,destRotation=destTransform.localRotation,destScale=destTransform.localScale;transform.localPosition.cloneTo(destPosition),transform.localRotation.cloneTo(destRotation),transform.localScale.cloneTo(destScale),destTransform.localPosition=destPosition,destTransform.localRotation=destRotation,destTransform.localScale=destScale,destAnimator._avatarNodeMap={},this._initCloneToAnimator(destRoot,destAnimator)},__proto.cloneTo=function(destObject){var destAvatar=destObject,destRoot=this._rootNode.clone();destAvatar._rootNode=destRoot},__proto.clone=function(){var dest=new this.constructor;return this.cloneTo(dest),dest},__proto._cloneDatasToAnimatorNative=function(destAnimator){var animationNodeLocalPositions=new Float32Array(3*this._nativeNodeCount),animationNodeLocalRotations=new Float32Array(4*this._nativeNodeCount),animationNodeLocalScales=new Float32Array(3*this._nativeNodeCount),animationNodeWorldMatrixs=new Float32Array(16*this._nativeNodeCount),animationNodeParentIndices=new Int16Array(this._nativeNodeCount);destAnimator._animationNodeLocalPositions=animationNodeLocalPositions,destAnimator._animationNodeLocalRotations=animationNodeLocalRotations,destAnimator._animationNodeLocalScales=animationNodeLocalScales,destAnimator._animationNodeWorldMatrixs=animationNodeWorldMatrixs,destAnimator._animationNodeParentIndices=animationNodeParentIndices,this._nativeCurCloneCount=0;var destRoot=this._rootNode._cloneNative(animationNodeLocalPositions,animationNodeLocalRotations,animationNodeLocalScales,animationNodeWorldMatrixs,animationNodeParentIndices,-1,this),transform=this._rootNode.transform,destTransform=destRoot.transform,destPosition=destTransform.localPosition,destRotation=destTransform.localRotation,destScale=destTransform.localScale;transform.localPosition.cloneTo(destPosition),transform.localRotation.cloneTo(destRotation),transform.localScale.cloneTo(destScale),destTransform.localPosition=destPosition,destTransform.localRotation=destRotation,destTransform.localScale=destScale,destAnimator._avatarNodeMap={},this._initCloneToAnimator(destRoot,destAnimator)},Avatar._parse=function(data,propertyParams,constructParams){var avatar=new Avatar;if(avatar._rootNode=new AnimationNode(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16)),Render.isConchApp&&avatar._nativeNodeCount++,data.version){var rootNode=data.rootNode;rootNode&&avatar._parseNode(rootNode,avatar._rootNode)}return avatar},Avatar.load=function(url,complete){Laya.loader.create(url,complete,null,"AVATAR")},Avatar}(),ShaderInstance=function(_super){function ShaderInstance(vs,ps,attributeMap,uniformMap){ShaderInstance.__super.call(this),this._vs=vs,this._ps=ps,this._attributeMap=attributeMap,this._uniformMap=uniformMap,this._create(),this.lock=!0}__class(ShaderInstance,"laya.d3.shader.ShaderInstance",Resource);var __proto=ShaderInstance.prototype;return __proto._create=function(){var gl=LayaGL.instance;for(var k in this._program=gl.createProgram(),this._vshader=this._createShader(gl,this._vs,35633),this._pshader=this._createShader(gl,this._ps,35632),gl.attachShader(this._program,this._vshader),gl.attachShader(this._program,this._pshader),this._attributeMap)gl.bindAttribLocation(this._program,this._attributeMap[k],k);if(gl.linkProgram(this._program),!Render.isConchApp&&Shader3D.debugMode&&!gl.getProgramParameter(this._program,35714))throw gl.getProgramInfoLog(this._program);var sceneParms=[],cameraParms=[],spriteParms=[],materialParms=[],customParms=[];this._customUniformParamsMap=[];var nUniformNum=0;nUniformNum=Render.isConchApp?gl.getProgramParameterEx(this._vs,this._ps,"",35718):gl.getProgramParameter(this._program,35718),WebGLContext.useProgram(gl,this._program),this._curActTexIndex=0;var one,i=0,n=0;for(i=0;i<nUniformNum;i++){var uniformData=null,uniName=(uniformData=Render.isConchApp?gl.getActiveUniformEx(this._vs,this._ps,"",i):gl.getActiveUniform(this._program,i)).name;(one=new ShaderVariable).location=gl.getUniformLocation(this._program,uniName),uniName.indexOf("[0]")>0?(one.name=uniName=uniName.substr(0,uniName.length-3),one.isArray=!0):(one.name=uniName,one.isArray=!1),one.type=uniformData.type,this._addShaderUnifiormFun(one);var uniformPeriod=this._uniformMap[uniName];if(null!=uniformPeriod)switch(one.dataOffset=Shader3D.propertyNameToID(uniName),uniformPeriod){case 0:customParms.push(one);break;case 1:materialParms.push(one);break;case 2:spriteParms.push(one);break;case 3:cameraParms.push(one);break;case 4:sceneParms.push(one);break;default:throw new Error("Shader3D: period is unkonw.")}}for(this._sceneUniformParamsMap=LayaGL.instance.createCommandEncoder(4*sceneParms.length*5+4,64,!0),i=0,n=sceneParms.length;i<n;i++)this._sceneUniformParamsMap.addShaderUniform(sceneParms[i]);for(this._cameraUniformParamsMap=LayaGL.instance.createCommandEncoder(4*cameraParms.length*5+4,64,!0),i=0,n=cameraParms.length;i<n;i++)this._cameraUniformParamsMap.addShaderUniform(cameraParms[i]);for(this._spriteUniformParamsMap=LayaGL.instance.createCommandEncoder(4*spriteParms.length*5+4,64,!0),i=0,n=spriteParms.length;i<n;i++)this._spriteUniformParamsMap.addShaderUniform(spriteParms[i]);for(this._materialUniformParamsMap=LayaGL.instance.createCommandEncoder(4*materialParms.length*5+4,64,!0),i=0,n=materialParms.length;i<n;i++)this._materialUniformParamsMap.addShaderUniform(materialParms[i]);for(this._customUniformParamsMap.length=customParms.length,i=0,n=customParms.length;i<n;i++){var custom=customParms[i];this._customUniformParamsMap[custom.dataOffset]=custom}},__proto._disposeResource=function(){LayaGL.instance.deleteShader(this._vshader),LayaGL.instance.deleteShader(this._pshader),LayaGL.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0},__proto._addShaderUnifiormFun=function(one){var gl=LayaGL.instance;one.caller=this;var isArray=one.isArray;switch(one.type){case 35670:one.fun=this._uniform1i,one.uploadedValue=new Array(1);break;case 5124:one.fun=isArray?this._uniform1iv:this._uniform1i,one.uploadedValue=new Array(1);break;case 5126:one.fun=isArray?this._uniform1fv:this._uniform1f,one.uploadedValue=new Array(1);break;case 35664:one.fun=isArray?this._uniform_vec2v:this._uniform_vec2,one.uploadedValue=new Array(2);break;case 35665:one.fun=isArray?this._uniform_vec3v:this._uniform_vec3,one.uploadedValue=new Array(3);break;case 35666:one.fun=isArray?this._uniform_vec4v:this._uniform_vec4,one.uploadedValue=new Array(4);break;case 35674:one.fun=this._uniformMatrix2fv;break;case 35675:one.fun=this._uniformMatrix3fv;break;case 35676:one.fun=isArray?this._uniformMatrix4fv:this._uniformMatrix4f;break;case 35678:gl.uniform1i(one.location,this._curActTexIndex),one.textureID=WebGLContext._glTextureIDs[this._curActTexIndex++],one.fun=this._uniform_sampler2D;break;case 35679:gl.uniform1i(one.location,this._curActTexIndex),one.textureID=WebGLContext._glTextureIDs[this._curActTexIndex++],one.fun=this._uniform_sampler3D;break;case 35680:gl.uniform1i(one.location,this._curActTexIndex),one.textureID=WebGLContext._glTextureIDs[this._curActTexIndex++],one.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!")}},__proto._createShader=function(gl,str,type){var shader=gl.createShader(type);if(gl.shaderSource(shader,str),gl.compileShader(shader),Shader3D.debugMode&&!gl.getShaderParameter(shader,35713))throw gl.getShaderInfoLog(shader);return shader},__proto._uniform1f=function(one,value){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value?(LayaGL.instance.uniform1f(one.location,uploadedValue[0]=value),1):0},__proto._uniform1fv=function(one,value){if(value.length<4){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]?(LayaGL.instance.uniform1fv(one.location,value),uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3],1):0}return LayaGL.instance.uniform1fv(one.location,value),1},__proto._uniform_vec2=function(one,v){var value=v.elements,uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]?(LayaGL.instance.uniform2f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1]),1):0},__proto._uniform_vec2v=function(one,value){if(value.length<2){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]?(LayaGL.instance.uniform2fv(one.location,value),uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3],1):0}return LayaGL.instance.uniform2fv(one.location,value),1},__proto._uniform_vec3=function(one,v){var value=v.elements,uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]?(LayaGL.instance.uniform3f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2]),1):0},__proto._uniform_vec3v=function(one,v){return LayaGL.instance.uniform3fv(one.location,v),1},__proto._uniform_vec4=function(one,v){var value=v.elements,uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]?(LayaGL.instance.uniform4f(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3]),1):0},__proto._uniform_vec4v=function(one,v){return LayaGL.instance.uniform4fv(one.location,v),1},__proto._uniformMatrix2fv=function(one,value){return LayaGL.instance.uniformMatrix2fv(one.location,!1,value),1},__proto._uniformMatrix3fv=function(one,value){return LayaGL.instance.uniformMatrix3fv(one.location,!1,value),1},__proto._uniformMatrix4f=function(one,m){var value=m.elements;return LayaGL.instance.uniformMatrix4fv(one.location,!1,value),1},__proto._uniformMatrix4fv=function(one,m){return LayaGL.instance.uniformMatrix4fv(one.location,!1,m),1},__proto._uniform1i=function(one,value){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value?(LayaGL.instance.uniform1i(one.location,uploadedValue[0]=value),1):0},__proto._uniform1iv=function(one,value){return LayaGL.instance.uniform1iv(one.location,value),1},__proto._uniform_ivec2=function(one,value){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]?(LayaGL.instance.uniform2i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1]),1):0},__proto._uniform_ivec2v=function(one,value){return LayaGL.instance.uniform2iv(one.location,value),1},__proto._uniform_vec3i=function(one,value){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]?(LayaGL.instance.uniform3i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2]),1):0},__proto._uniform_vec3vi=function(one,value){return LayaGL.instance.uniform3iv(one.location,value),1},__proto._uniform_vec4i=function(one,value){var uploadedValue=one.uploadedValue;return uploadedValue[0]!==value[0]||uploadedValue[1]!==value[1]||uploadedValue[2]!==value[2]||uploadedValue[3]!==value[3]?(LayaGL.instance.uniform4i(one.location,uploadedValue[0]=value[0],uploadedValue[1]=value[1],uploadedValue[2]=value[2],uploadedValue[3]=value[3]),1):0},__proto._uniform_vec4vi=function(one,value){return LayaGL.instance.uniform4iv(one.location,value),1},__proto._uniform_sampler2D=function(one,texture){var value=texture._getSource()||texture.defaulteTexture._getSource(),gl=LayaGL.instance;return WebGLContext.activeTexture(gl,one.textureID),WebGLContext.bindTexture(gl,3553,value),0},__proto._uniform_sampler3D=function(one,texture){var value=texture._getSource()||texture.defaulteTexture._getSource(),gl=LayaGL.instance;return WebGLContext.activeTexture(gl,one.textureID),WebGLContext.bindTexture(gl,32879,value),0},__proto._uniform_samplerCube=function(one,texture){var value=texture._getSource()||texture.defaulteTexture._getSource(),gl=LayaGL.instance;return WebGLContext.activeTexture(gl,one.textureID),WebGLContext.bindTexture(gl,34067,value),0},__proto.bind=function(){return WebGLContext.useProgram(LayaGL.instance,this._program)},__proto.uploadUniforms=function(shaderUniform,shaderDatas,uploadUnTexture){Stat.shaderCall+=LayaGLRunner.uploadShaderUniforms(LayaGL.instance,shaderUniform,shaderDatas,uploadUnTexture)},__proto.uploadCustomUniform=function(index,data){Stat.shaderCall+=LayaGLRunner.uploadCustomUniform(LayaGL.instance,this._customUniformParamsMap,index,data)},__proto._uniformMatrix2fvForNative=function(one,value){return LayaGL.instance.uniformMatrix2fvEx(one.location,!1,value),1},__proto._uniformMatrix3fvForNative=function(one,value){return LayaGL.instance.uniformMatrix3fvEx(one.location,!1,value),1},__proto._uniformMatrix4fvForNative=function(one,m){return LayaGL.instance.uniformMatrix4fvEx(one.location,!1,m),1},ShaderInstance}(),AnimationClip=function(_super){function AnimationClip(){AnimationClip.__super.call(this),this._nodes=new KeyframeNodeList,this._events=[]}__class(AnimationClip,"laya.d3.animation.AnimationClip",Resource);var __proto=AnimationClip.prototype;return __proto.duration=function(){return this._duration},__proto._hermiteInterpolate=function(frame,nextFrame,t,dur){var t0=frame.outTangent,t1=nextFrame.inTangent;if(Number.isFinite(t0)&&Number.isFinite(t1)){var t2=t*t,t3=t2*t,b=t3-2*t2+t,c=t3-t2,d=-2*t3+3*t2;return(2*t3-3*t2+1)*frame.value+b*t0*dur+c*t1*dur+d*nextFrame.value}return frame.value},__proto._hermiteInterpolateArray=function(frame,nextFrame,t,dur,out){for(var d0=frame.data,d1=nextFrame.data,outTanOffset=out.length,pOffset=2*outTanOffset,a=NaN,b=NaN,c=NaN,d=NaN,i=0,n=out.length;i<n;i++){var t0=d0[outTanOffset+i],t1=d1[i];if(Number.isFinite(t0)&&Number.isFinite(t1)){if(0===i){var t2=t*t,t3=t2*t;a=2*t3-3*t2+1,b=t3-2*t2+t,c=t3-t2,d=-2*t3+3*t2}out[i]=a*d0[pOffset+i]+b*t0*dur+c*t1*dur+d*d1[pOffset+i]}else out[i]=d0[pOffset+i]}},__proto._evaluateClipDatasRealTime=function(nodes,playCurTime,realTimeCurrentFrameIndexes,addtive,frontPlay){for(var i=0,n=nodes.count;i<n;i++){var node=nodes.getNodeByIndex(i),type=node.type,nextFrameIndex=0,keyFrames=node._keyFrames,keyFramesCount=keyFrames.length,frameIndex=realTimeCurrentFrameIndexes[i];if(frontPlay)for(-1!==frameIndex&&playCurTime<keyFrames[frameIndex].time&&(frameIndex=-1,realTimeCurrentFrameIndexes[i]=frameIndex),nextFrameIndex=frameIndex+1;nextFrameIndex<keyFramesCount&&!(keyFrames[nextFrameIndex].time>playCurTime);)frameIndex++,nextFrameIndex++,realTimeCurrentFrameIndexes[i]=frameIndex;else for((nextFrameIndex=frameIndex+1)!==keyFramesCount&&playCurTime>keyFrames[nextFrameIndex].time&&(frameIndex=keyFramesCount-1,realTimeCurrentFrameIndexes[i]=frameIndex),nextFrameIndex=frameIndex+1;frameIndex>-1&&!(keyFrames[frameIndex].time<playCurTime);)frameIndex--,nextFrameIndex--,realTimeCurrentFrameIndexes[i]=frameIndex;var isEnd=nextFrameIndex===keyFramesCount;switch(type){case 0:if(-1!==frameIndex){var frame=keyFrames[frameIndex];if(isEnd)node.data=frame.value;else{var nextFarme=keyFrames[nextFrameIndex],d=nextFarme.time-frame.time,t=NaN;t=0!==d?(playCurTime-frame.time)/d:0,node.data=this._hermiteInterpolate(frame,nextFarme,t,d)}}else node.data=keyFrames[0].value;addtive&&(node.data-=keyFrames[0].value);break;case 1:case 4:var clipData=node.data;if(this._evaluateFrameNodeArrayDatasRealTime(keyFrames,frameIndex,isEnd,playCurTime,3,clipData),addtive){var firstFrameValue=keyFrames[0].data;clipData[0]-=firstFrameValue[6],clipData[1]-=firstFrameValue[7],clipData[2]-=firstFrameValue[8]}break;case 2:if(clipData=node.data,this._evaluateFrameNodeArrayDatasRealTime(keyFrames,frameIndex,isEnd,playCurTime,4,clipData),addtive){var tempQuat=AnimationClip._tempQuaternionArray0;firstFrameValue=keyFrames[0].data,Utils3D.quaternionConjugate(firstFrameValue,8,tempQuat),Utils3D.quaternionMultiply(tempQuat,clipData,clipData)}break;case 3:clipData=node.data,this._evaluateFrameNodeArrayDatasRealTime(keyFrames,frameIndex,isEnd,playCurTime,3,clipData),addtive&&(firstFrameValue=keyFrames[0].data,clipData[0]/=firstFrameValue[6],clipData[1]/=firstFrameValue[7],clipData[2]/=firstFrameValue[8]);break;default:throw"AnimationClip:unknown node type."}}},__proto._evaluateClipDatasRealTimeForNative=function(nodes,playCurTime,realTimeCurrentFrameIndexes,addtive){LayaGL.instance.evaluateClipDatasRealTime(nodes._nativeObj,playCurTime,realTimeCurrentFrameIndexes,addtive)},__proto._evaluateFrameNodeArrayDatasRealTime=function(keyFrames,frameIndex,isEnd,playCurTime,width,outDatas){var dataOffset=2*width;if(-1!==frameIndex){var frame=keyFrames[frameIndex];if(isEnd)for(var frameData=frame.data,j=0;j<width;j++)outDatas[j]=frameData[dataOffset+j];else{var nextKeyFrame=keyFrames[frameIndex+1],t=NaN,startTime=frame.time,d=nextKeyFrame.time-startTime;t=0!==d?(playCurTime-startTime)/d:0,this._hermiteInterpolateArray(frame,nextKeyFrame,t,d,outDatas)}}else{var firstFrameDatas=keyFrames[0].data;for(j=0;j<width;j++)outDatas[j]=firstFrameDatas[dataOffset+j]}},__proto._binarySearchEventIndex=function(time){for(var start=0,end=this._events.length-1,mid=0;start<=end;){mid=Math.floor((start+end)/2);var midValue=this._events[mid].time;if(midValue==time)return mid;midValue>time?end=mid-1:start=mid+1}return start},__proto.addEvent=function(event){var index=this._binarySearchEventIndex(event.time);this._events.splice(index,0,event)},__proto._disposeResource=function(){this._version=null,this._nodes=null,this._nodesMap=null},AnimationClip._parse=function(data,propertyParams,constructParams){var clip=new AnimationClip,reader=new Byte(data);switch(clip._version=reader.readUTFString(),clip._version){case"LAYAANIMATION:03":AnimationClipParser03.parse(clip,reader);break;default:throw"unknown animationClip version."}return clip},AnimationClip.load=function(url,complete){Laya.loader.create(url,complete,null,"ANIMATIONCLIP")},__static(AnimationClip,["_tempQuaternionArray0",function(){return this._tempQuaternionArray0=new Float32Array(4)}]),AnimationClip}(),Mesh=(function(_super){function TerrainRes(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,TerrainRes.__super.call(this)}__class(TerrainRes,"laya.d3.terrain.TerrainRes",Resource);var __proto=TerrainRes.prototype;__proto.parseData=function(data){var json=data[0],resouMap=data[1];if(this._version=json.version,1==this._version){this._cameraCoordinateInverse=json.cameraCoordinateInverse,this._gridSize=json.gridSize,this._chunkNumX=json.chunkNumX,this._chunkNumZ=json.chunkNumZ;var heightData=json.heightData;if(this._heightDataX=heightData.numX,this._heightDataZ=heightData.numZ,this._heightDataBitType=heightData.bitType,this._heightDataValue=heightData.value,this._heightDataUrl=resouMap[heightData.url],this._materialInfo=new MaterialInfo,json.material){var ambient=json.material.ambient,diffuse=json.material.diffuse,specular=json.material.specular;this._materialInfo.ambientColor=new Vector3(ambient[0],ambient[1],ambient[2]),this._materialInfo.diffuseColor=new Vector3(diffuse[0],diffuse[1],diffuse[2]),this._materialInfo.specularColor=new Vector4(specular[0],specular[1],specular[2],specular[3])}var detailTextures=json.detailTexture;this._detailTextureInfos=__newvec(detailTextures.length);for(var i=0;i<detailTextures.length;i++){var detail=detailTextures[i],info=new DetailTextureInfo;info.diffuseTexture=resouMap[detail.diffuse],info.normalTexture=detail.normal?resouMap[detail.normal]:null,detail.scale?info.scale=new Vector2(detail.scale[0],detail.scale[1]):info.scale=new Vector2(1,1),detail.offset?info.offset=new Vector2(detail.offset[0],detail.offset[1]):info.offset=new Vector2(0,0),this._detailTextureInfos[i]=info}var alphaMaps=json.alphaMap;for(this._alphaMaps=__newvec(alphaMaps.length),i=0;i<this._alphaMaps.length;i++)this._alphaMaps[i]=json.alphaMap[i];var normalMaps=json.normalMap;for(this._normalMaps=__newvec(normalMaps.length),i=0;i<this._normalMaps.length;i++)this._normalMaps[i]=json.normalMap[i];var jchunks=json.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=jchunks.length)return alert("terrain data error"),!1;for(this._chunkInfos=__newvec(jchunks.length),i=0;i<jchunks.length;i++){var jchunk=jchunks[i],chunkinfo=new ChunkInfo,nAlphaMapNum=jchunk.alphaMap.length,nDetailIDNum=jchunk.detailID.length;if(nAlphaMapNum!=nDetailIDNum)return alert("terrain chunk data error"),!1;chunkinfo.alphaMap=__newvec(nAlphaMapNum),chunkinfo.detailID=__newvec(nDetailIDNum),chunkinfo.normalMap=resouMap[this._normalMaps[jchunk.normalMap]];for(var j=0;j<nAlphaMapNum;j++){chunkinfo.alphaMap[j]=resouMap[this._alphaMaps[jchunk.alphaMap[j]]];var jid=jchunk.detailID[j],nIDNum=jid.length;chunkinfo.detailID[j]=new Uint8Array(nIDNum);for(var k=0;k<nIDNum;k++)chunkinfo.detailID[j][k]=jid[k]}this._chunkInfos[i]=chunkinfo}this._heightData=Loader.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},__proto.onLoadTerrainComplete=function(heightData){},TerrainRes._parse=function(data,propertyParams,constructParams){var terrainRes=new TerrainRes;return terrainRes.parseData(data),terrainRes},TerrainRes.load=function(url,complete){Laya.loader.create(url,complete,null,"TERRAIN",null,null,1,!1)}}(),function(_super){function Mesh(){this._nativeTriangleMesh=null,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._subMeshCount=0,this._positions=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._inverseBindPosesBuffer=null,this._bindPoseIndices=null,this._skinDataPathMarks=null,this._vertexCount=0,Mesh.__super.call(this),this._subMeshes=[],this._vertexBuffers=[],this._skinDataPathMarks=[],this._boundingBoxCorners=__newvec(8,null)}__class(Mesh,"laya.d3.resource.models.Mesh",Resource);var __proto=Mesh.prototype;return __proto._generateBoundingObject=function(){this._boundingSphere=new BoundSphere(new Vector3,0),BoundSphere.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new BoundBox(new Vector3,new Vector3),BoundBox.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},__proto._getPositions=function(){var vertexBuffer,positionElement,vertexElements,vertexElement,verticesData,vertices=[],i=0,j=0,ofset=0,vertexBufferCount=this._vertexBuffers.length;for(i=0;i<vertexBufferCount;i++){for(vertexElements=(vertexBuffer=this._vertexBuffers[i]).vertexDeclaration.vertexElements,j=0;j<vertexElements.length;j++)if("vector3"===(vertexElement=vertexElements[j]).elementFormat&&0===vertexElement.elementUsage){positionElement=vertexElement;break}for(verticesData=vertexBuffer.getData(),j=0;j<verticesData.length;j+=vertexBuffer.vertexDeclaration.vertexStride/4)ofset=j+positionElement.offset/4,vertices.push(new Vector3(verticesData[ofset+0],verticesData[ofset+1],verticesData[ofset+2]))}return vertices},__proto._setSubMeshes=function(subMeshes){this._subMeshes=subMeshes,this._subMeshCount=subMeshes.length;for(var i=0;i<this._subMeshCount;i++)subMeshes[i]._indexInMesh=i;this._positions=this._getPositions(),this._generateBoundingObject()},__proto._getSubMesh=function(index){return this._subMeshes[index]},__proto._disposeResource=function(){for(var i=0,n=this._subMeshes.length;i<n;i++)this._subMeshes[i].destroy();for(this._nativeTriangleMesh&&Laya3D._physics3D.destroy(this._nativeTriangleMesh),i=0,n=this._vertexBuffers.length;i<n;i++)this._vertexBuffers[i].destroy();this._indexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._nativeTriangleMesh=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},__proto._getPhysicMesh=function(){if(!this._nativeTriangleMesh){for(var triangleMesh=new Laya3D._physics3D.btTriangleMesh,nativePositio0=Mesh._nativeTempVector30,nativePositio1=Mesh._nativeTempVector31,nativePositio2=Mesh._nativeTempVector32,positions=this._getPositions(),indices=this._indexBuffer.getData(),i=0,n=indices.length;i<n;i+=3){var position0=positions[indices[i]],position1=positions[indices[i+1]],position2=positions[indices[i+2]];Utils3D._convertToBulletVec3(position0,nativePositio0,!0),Utils3D._convertToBulletVec3(position1,nativePositio1,!0),Utils3D._convertToBulletVec3(position2,nativePositio2,!0),triangleMesh.addTriangle(nativePositio0,nativePositio1,nativePositio2,!0)}this._nativeTriangleMesh=triangleMesh}return this._nativeTriangleMesh},__getset(0,__proto,"inverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),__getset(0,__proto,"vertexCount",function(){return this._vertexCount}),__getset(0,__proto,"subMeshCount",function(){return this._subMeshCount}),__getset(0,__proto,"boundingBox",function(){return this._boundingBox}),__getset(0,__proto,"boundingBoxCorners",function(){return this._boundingBoxCorners}),__getset(0,__proto,"boundingSphere",function(){return this._boundingSphere}),Mesh._parse=function(data,propertyParams,constructParams){var mesh=new Mesh;return MeshReader.read(data,mesh,mesh._subMeshes),mesh},Mesh.load=function(url,complete){Laya.loader.create(url,complete,null,"MESH")},__static(Mesh,["_nativeTempVector30",function(){return this._nativeTempVector30=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeTempVector31",function(){return this._nativeTempVector31=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeTempVector32",function(){return this._nativeTempVector32=new Laya3D._physics3D.btVector3(0,0,0)}]),Mesh}()),TerrainRender=function(_super){function TerrainRender(owner){this._terrainSprite3DOwner=null,this._projectionViewWorldMatrix=null,TerrainRender.__super.call(this,owner),this._terrainSprite3DOwner=owner,this._projectionViewWorldMatrix=new Matrix4x4}__class(TerrainRender,"laya.d3.terrain.TerrainRender",_super);var __proto=TerrainRender.prototype;return __proto._calculateBoundingSphere=function(){var terrainFilter=this._terrainSprite3DOwner.terrainFilter;if(null==terrainFilter)this._boundingSphere.toDefault();else{var meshBoundingSphere=terrainFilter._boundingSphere,maxScale=NaN,transform=this._terrainSprite3DOwner.transform,scale=transform.scale;if(maxScale=scale.x>=scale.y&&scale.x>=scale.z?scale.x:scale.y>=scale.z?scale.y:scale.z,Vector3.transformCoordinate(meshBoundingSphere.center,transform.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=meshBoundingSphere.radius*maxScale,terrainFilter.calcLeafBoudingSphere(transform.worldMatrix,maxScale),Render.isConchApp){var centerE=this._boundingSphere.center.elements,buffer=FrustumCulling._cullingBuffer;buffer[this._cullingBufferIndex+1]=centerE[0],buffer[this._cullingBufferIndex+2]=centerE[1],buffer[this._cullingBufferIndex+3]=centerE[2],buffer[this._cullingBufferIndex+4]=this._boundingSphere.radius}}},__proto._needRender=function(boundFrustum){return!boundFrustum||0!==boundFrustum.containsBoundSphere(this.boundingSphere)},__proto._calculateBoundingBox=function(){var terrainFilter=this._terrainSprite3DOwner.terrainFilter;if(null==terrainFilter)this._boundingBox.toDefault();else{for(var worldMat=this._terrainSprite3DOwner.transform.worldMatrix,corners=terrainFilter._boundingBoxCorners,i=0;i<8;i++)Vector3.transformCoordinate(corners[i],worldMat,BaseRender._tempBoundBoxCorners[i]);BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox),terrainFilter.calcLeafBoudingBox(worldMat)}},__proto._renderUpdate=function(context,transform){this._shaderValues.setMatrix4x4(Sprite3D.WORLDMATRIX,transform.worldMatrix)},__proto._renderUpdateWithCamera=function(context,transform){var projectionView=context.projectionViewMatrix;Matrix4x4.multiply(projectionView,transform.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,this._projectionViewWorldMatrix)},__proto._destroy=function(){_super.prototype._destroy.call(this),this._terrainSprite3DOwner=null},TerrainRender}(BaseRender),PixelLineRenderer=function(_super){function PixelLineRenderer(owner){this._projectionViewWorldMatrix=null,PixelLineRenderer.__super.call(this,owner),this._projectionViewWorldMatrix=new Matrix4x4}__class(PixelLineRenderer,"laya.d3.core.pixelLine.PixelLineRenderer",BaseRender);var __proto=PixelLineRenderer.prototype;return __proto._calculateBoundingBox=function(){var minE=this._boundingBox.min.elements;minE[0]=-Number.MAX_VALUE,minE[1]=-Number.MAX_VALUE,minE[2]=-Number.MAX_VALUE;var maxE=this._boundingBox.min.elements;maxE[0]=Number.MAX_VALUE,maxE[1]=Number.MAX_VALUE,maxE[2]=Number.MAX_VALUE},__proto._calculateBoundingSphere=function(){var centerE=this._boundingSphere.center.elements;centerE[0]=0,centerE[1]=0,centerE[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},__proto._renderUpdateWithCamera=function(context,transform){var projectionView=context.projectionViewMatrix,sv=this._shaderValues;if(transform){var worldMat=transform.worldMatrix;sv.setMatrix4x4(Sprite3D.WORLDMATRIX,worldMat),Matrix4x4.multiply(projectionView,worldMat,this._projectionViewWorldMatrix),sv.setMatrix4x4(Sprite3D.MVPMATRIX,this._projectionViewWorldMatrix)}else sv.setMatrix4x4(Sprite3D.WORLDMATRIX,Matrix4x4.DEFAULT),sv.setMatrix4x4(Sprite3D.MVPMATRIX,projectionView)},PixelLineRenderer}(),TrailRenderer=function(_super){function TrailRenderer(owner){this._projectionViewWorldMatrix=new Matrix4x4,TrailRenderer.__super.call(this,owner)}__class(TrailRenderer,"laya.d3.core.trail.TrailRenderer",_super);var __proto=TrailRenderer.prototype;return __proto._calculateBoundingBox=function(){var minE=this._boundingBox.min.elements;minE[0]=-Number.MAX_VALUE,minE[1]=-Number.MAX_VALUE,minE[2]=-Number.MAX_VALUE;var maxE=this._boundingBox.min.elements;maxE[0]=Number.MAX_VALUE,maxE[1]=Number.MAX_VALUE,maxE[2]=Number.MAX_VALUE},__proto._calculateBoundingSphere=function(){this._owner.transform.position.cloneTo(this._boundingSphere.center),this._boundingSphere.radius=Number.MAX_VALUE},__proto._needRender=function(boundFrustum){return!0},__proto._renderUpdate=function(state,transform){_super.prototype._renderUpdate.call(this,state,transform),this._owner.trailFilter._update(state)},__proto._renderUpdateWithCamera=function(context,transform){var projectionView=context.projectionViewMatrix;transform?(Matrix4x4.multiply(projectionView,transform.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,projectionView),Laya3D.debugMode&&this._renderRenderableBoundBox()},TrailRenderer}(BaseRender),MeshRenderer=function(_super){function MeshRenderer(owner){MeshRenderer.__super.call(this,owner),this._projectionViewWorldMatrix=new Matrix4x4}__class(MeshRenderer,"laya.d3.core.MeshRenderer",_super);var __proto=MeshRenderer.prototype;return __proto._onMeshChange=function(mesh){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},__proto._calculateBoundingSphereByInitSphere=function(boundSphere){var maxScale=NaN,transform=this._owner.transform,scaleE=transform.scale.elements,scaleX=scaleE[0];scaleX||(scaleX=-scaleX);var scaleY=scaleE[1];scaleY||(scaleY=-scaleY);var scaleZ=scaleE[2];if(scaleZ||(scaleZ=-scaleZ),maxScale=scaleX>=scaleY&&scaleX>=scaleZ?scaleX:scaleY>=scaleZ?scaleY:scaleZ,Vector3.transformCoordinate(boundSphere.center,transform.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=boundSphere.radius*maxScale,Render.isConchApp){var centerE=this._boundingSphere.center.elements,buffer=FrustumCulling._cullingBuffer;buffer[this._cullingBufferIndex+1]=centerE[0],buffer[this._cullingBufferIndex+2]=centerE[1],buffer[this._cullingBufferIndex+3]=centerE[2],buffer[this._cullingBufferIndex+4]=this._boundingSphere.radius}},__proto._calculateBoundBoxByInitCorners=function(corners){for(var worldMat=this._owner.transform.worldMatrix,i=0;i<8;i++)BoundBox.createfromPoints(BaseRender._tempBoundBoxCorners,this._boundingBox),Vector3.transformCoordinate(corners[i],worldMat,BaseRender._tempBoundBoxCorners[i])},__proto._calculateBoundingSphere=function(){var sharedMesh=this._owner.meshFilter.sharedMesh;null==sharedMesh||null==sharedMesh.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(sharedMesh.boundingSphere)},__proto._calculateBoundingBox=function(){var sharedMesh=this._owner.meshFilter.sharedMesh;null==sharedMesh||null==sharedMesh.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(sharedMesh.boundingBoxCorners)},__proto._needRender=function(boundFrustum){return!boundFrustum||0!==boundFrustum.containsBoundSphere(this.boundingSphere)},__proto._renderUpdate=function(context,transform){transform?this._shaderValues.setMatrix4x4(Sprite3D.WORLDMATRIX,transform.worldMatrix):this._shaderValues.setMatrix4x4(Sprite3D.WORLDMATRIX,Matrix4x4.DEFAULT)},__proto._renderUpdateWithCamera=function(context,transform){var projectionView=context.projectionViewMatrix;transform?(Matrix4x4.multiply(projectionView,transform.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,projectionView),Laya3D.debugMode&&this._renderRenderableBoundBox()},__proto._destroy=function(){this._isPartOfStaticBatch&&MeshRenderStaticBatchManager.instance._destroyRenderSprite(this._owner),_super.prototype._destroy.call(this)},MeshRenderer}(BaseRender),PhysicsTriggerComponent=function(_super){function PhysicsTriggerComponent(collisionGroup,canCollideWith){this._isTrigger=!1,PhysicsTriggerComponent.__super.call(this,collisionGroup,canCollideWith)}__class(PhysicsTriggerComponent,"laya.d3.physics.PhysicsTriggerComponent",_super);var __proto=PhysicsTriggerComponent.prototype;return __proto._onAdded=function(){_super.prototype._onAdded.call(this),this.isTrigger=this._isTrigger},__proto._cloneTo=function(dest){_super.prototype._cloneTo.call(this,dest),dest.isTrigger=this._isTrigger},__getset(0,__proto,"isTrigger",function(){return this._isTrigger},function(value){if(this._isTrigger=value,this._nativeColliderObject&&this._enabled&&value){var flags=this._nativeColliderObject.getCollisionFlags();0==(4&flags)&&this._nativeColliderObject.setCollisionFlags(4|flags)}}),PhysicsTriggerComponent}(PhysicsComponent),ShurikenParticleRenderer=function(_super){function ShurikenParticleRenderer(owner){this._finalGravity=new Vector3,this._tempRotationMatrix=new Matrix4x4,ShurikenParticleRenderer.__super.call(this,owner),this._defaultBoundBox=new BoundBox(new Vector3,new Vector3),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}__class(ShurikenParticleRenderer,"laya.d3.core.particleShuriKen.ShurikenParticleRenderer",_super);var __proto=ShurikenParticleRenderer.prototype;return __proto._calculateBoundingBox=function(){var minE=this._boundingBox.min.elements;minE[0]=-Number.MAX_VALUE,minE[1]=-Number.MAX_VALUE,minE[2]=-Number.MAX_VALUE;var maxE=this._boundingBox.min.elements;maxE[0]=Number.MAX_VALUE,maxE[1]=Number.MAX_VALUE,maxE[2]=Number.MAX_VALUE},__proto._calculateBoundingSphere=function(){var oriBoundSphere=this._owner.particleSystem._boundingSphere,maxScale=NaN,transform=this._owner.transform,scaleE=transform.scale.elements,scaleX=Math.abs(scaleE[0]),scaleY=Math.abs(scaleE[1]),scaleZ=Math.abs(scaleE[2]);if(maxScale=scaleX>=scaleY&&scaleX>=scaleZ?scaleX:scaleY>=scaleZ?scaleY:scaleZ,Vector3.transformCoordinate(oriBoundSphere.center,transform.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=oriBoundSphere.radius*maxScale,Render.isConchApp){var centerE=this._boundingSphere.center.elements,buffer=FrustumCulling._cullingBuffer;buffer[this._cullingBufferIndex+1]=centerE[0],buffer[this._cullingBufferIndex+2]=centerE[1],buffer[this._cullingBufferIndex+3]=centerE[2],buffer[this._cullingBufferIndex+4]=this._boundingSphere.radius}},__proto._needRender=function(boundFrustum){return!boundFrustum||0!==boundFrustum.containsBoundSphere(this.boundingSphere)&&!!this._owner.particleSystem.isAlive},__proto._renderUpdate=function(context,transfrom){var particleSystem=this._owner.particleSystem,sv=this._shaderValues,transform=this._owner.transform;switch(particleSystem.simulationSpace){case 0:break;case 1:sv.setVector(ShuriKenParticle3D.WORLDPOSITION,transform.position),sv.setQuaternion(ShuriKenParticle3D.WORLDROTATION,transform.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(particleSystem.scaleMode){case 0:var scale=transform.scale;sv.setVector(ShuriKenParticle3D.POSITIONSCALE,scale),sv.setVector(ShuriKenParticle3D.SIZESCALE,scale);break;case 1:var localScale=transform.localScale;sv.setVector(ShuriKenParticle3D.POSITIONSCALE,localScale),sv.setVector(ShuriKenParticle3D.SIZESCALE,localScale);break;case 2:sv.setVector(ShuriKenParticle3D.POSITIONSCALE,transform.scale),sv.setVector(ShuriKenParticle3D.SIZESCALE,Vector3.ONE)}Vector3.scale(Physics3DUtils.gravity,particleSystem.gravityModifier,this._finalGravity),sv.setVector(ShuriKenParticle3D.GRAVITY,this._finalGravity),sv.setInt(ShuriKenParticle3D.SIMULATIONSPACE,particleSystem.simulationSpace),sv.setBool(ShuriKenParticle3D.THREEDSTARTROTATION,particleSystem.threeDStartRotation),sv.setInt(ShuriKenParticle3D.SCALINGMODE,particleSystem.scaleMode),sv.setNumber(ShuriKenParticle3D.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),sv.setNumber(ShuriKenParticle3D.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),sv.setNumber(ShuriKenParticle3D.CURRENTTIME,particleSystem._currentTime),Laya3D.debugMode&&this._renderRenderableBoundBox()},__proto._destroy=function(){_super.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)},__getset(0,__proto,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),__getset(0,__proto,"renderMode",function(){return this._renderMode},function(value){if(this._renderMode!==value){var defineDatas=this._defineDatas;switch(this._renderMode){case 0:defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:defineDatas.remove(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=value,value){case 0:defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:defineDatas.add(ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),__getset(0,__proto,"mesh",function(){return this._mesh},function(value){this._mesh!==value&&(this._mesh&&this._mesh._removeReference(),this._mesh=value,value&&value._addReference(),this._owner.particleSystem._initBufferDatas())}),ShurikenParticleRenderer}(BaseRender),Scene3D=(function(_super){function CharacterController(stepheight,upAxis,collisionGroup,canCollideWith){this._maxSlope=45,this._jumpSpeed=10,this._fallSpeed=55,this._upAxis=new Vector3(0,1,0),this._gravity=new Vector3(0,3*-9.8,0),void 0===stepheight&&(stepheight=.1),void 0===collisionGroup&&(collisionGroup=1),void 0===canCollideWith&&(canCollideWith=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),this._stepHeight=stepheight,upAxis&&(this._upAxis=upAxis),CharacterController.__super.call(this,collisionGroup,canCollideWith)}__class(CharacterController,"laya.d3.physics.CharacterController",_super);var __proto=CharacterController.prototype;__proto._constructCharacter=function(){var physics3D=Laya3D._physics3D;this._nativeKinematicCharacter&&physics3D.destroy(this._nativeKinematicCharacter);var nativeUpAxis=CharacterController._nativeTempVector30;nativeUpAxis.setValue(this._upAxis.x,this._upAxis.y,this._upAxis.z),this._nativeKinematicCharacter=new physics3D.btKinematicCharacterController(this._nativeColliderObject,this._colliderShape._nativeShape,this._stepHeight,nativeUpAxis),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity},__proto._onShapeChange=function(colShape){_super.prototype._onShapeChange.call(this,colShape),this._constructCharacter()},__proto._onAdded=function(){var ghostObject=new Laya3D._physics3D.btPairCachingGhostObject;ghostObject.setUserIndex(this.id),ghostObject.setCollisionFlags(16),this._nativeColliderObject=ghostObject,this._colliderShape&&this._constructCharacter(),_super.prototype._onAdded.call(this)},__proto._addToSimulation=function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith)},__proto._removeFromSimulation=function(){this._simulation._removeCharacter(this);var characters=this._simulation._characters;characters.splice(characters.indexOf(this),1)},__proto._cloneTo=function(dest){_super.prototype._cloneTo.call(this,dest);var destCharacterController=dest;destCharacterController.stepHeight=this._stepHeight,destCharacterController.upAxis=this._upAxis,destCharacterController.maxSlope=this._maxSlope,destCharacterController.jumpSpeed=this._jumpSpeed,destCharacterController.fallSpeed=this._fallSpeed,destCharacterController.gravity=this._gravity},__proto._onDestroy=function(){Laya3D._physics3D.destroy(this._nativeKinematicCharacter),_super.prototype._onDestroy.call(this),this._nativeKinematicCharacter=null},__proto.move=function(movement){var movementE=movement.elements,nativeMovement=PhysicsComponent._nativeVector30;nativeMovement.setValue(-movementE[0],movementE[1],movementE[2]),this._nativeKinematicCharacter.setWalkDirection(nativeMovement)},__proto.jump=function(velocity){if(velocity){var nativeVelocity=PhysicsComponent._nativeVector30;Utils3D._convertToBulletVec3(velocity,nativeVelocity,!0),this._nativeKinematicCharacter.jump(nativeVelocity)}else this._nativeKinematicCharacter.jump()},__getset(0,__proto,"fallSpeed",function(){return this._fallSpeed},function(value){this._fallSpeed=value,this._nativeKinematicCharacter.setFallSpeed(value)}),__getset(0,__proto,"stepHeight",function(){return this._stepHeight},function(value){this._stepHeight=value,this._constructCharacter()}),__getset(0,__proto,"jumpSpeed",function(){return this._jumpSpeed},function(value){this._jumpSpeed=value,this._nativeKinematicCharacter.setJumpSpeed(value)}),__getset(0,__proto,"gravity",function(){return this._gravity},function(value){this._gravity=value;var nativeGravity=CharacterController._nativeTempVector30;nativeGravity.setValue(-value.x,value.y,value.z),this._nativeKinematicCharacter.setGravity(nativeGravity)}),__getset(0,__proto,"maxSlope",function(){return this._maxSlope},function(value){this._maxSlope=value,this._nativeKinematicCharacter.setMaxSlope(value/180*Math.PI)}),__getset(0,__proto,"isGrounded",function(){return this._nativeKinematicCharacter.onGround()}),__getset(0,__proto,"upAxis",function(){return this._upAxis},function(value){this._upAxis=value,this._constructCharacter()}),CharacterController.UPAXIS_X=0,CharacterController.UPAXIS_Y=1,CharacterController.UPAXIS_Z=2,__static(CharacterController,["_nativeTempVector30",function(){return this._nativeTempVector30=new Laya3D._physics3D.btVector3(0,0,0)}])}(PhysicsComponent),function(_super){function Scene3D(){if(this._reflectionMode=1,this._enableLightCount=3,this.enableLight=!0,this._time=0,Scene3D.__super.call(this),this._lights=[],this._skyRenderer=new SkyRenderer,this._input=new Input3D,this._timer=Laya.timer,this._collsionTestList=[],this._renders=new SimpleSingletonList,this._opaqueQueue=new RenderQueue(!1),this._transparentQueue=new RenderQueue(!0),this._cameraPool=[],this._animatorPool=new SimpleSingletonList,this._scriptPool=new SimpleSingletonList,this._castShadowRenders=new CastShadowList,this.currentCreationLayer=Math.pow(2,0),this._key=new SubmitKey,this._pickIdToSprite=new Object,Render.isConchApp){this._glCommandEncoder=LayaGL.instance.createCommandEncoder(102400,2560,!1),this._conchData._int32Data[26]=this._glCommandEncoder.getPtrID(),this._renderType|=1024,this._setRenderType(this._renderType);var callback=this._callbackFuncObj;callback||(callback=this._callbackFuncObj=new CallbackFuncObj),this._conchData._int32Data[54]=callback.id,callback.addCallbackFunc(3,this.renderCallbackFromNative.bind(this)),this._conchData._int32Data[62]=3}Laya3D._enbalePhysics&&(this._physicsSimulation=new PhysicsSimulation(Laya3D.physicsSettings)),this._lightmaps=[],this._defineDatas=new DefineDatas,this._shaderValues=new ShaderData(null),this.parallelSplitShadowMaps=[],this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new Vector3(.7,.7,.7),this.ambientColor=new Vector3(.212,.227,.259),this.reflectionIntensity=1,WebGL.shaderHighPrecision&&this._defineDatas.add(Shader3D.SHADERDEFINE_HIGHPRECISION),Render.isConchApp&&(this._cullingBufferIndices=new Int32Array(1024),this._cullingBufferResult=new Int32Array(1024)),this._shaderValues.setTexture(laya.d3.core.scene.Scene3D.RANGEATTENUATIONTEXTURE,ShaderInit3D._rangeAttenTex),this._scene=this,Laya3D._enbalePhysics&&!PhysicsSimulation.disableSimulation&&this._input.__init__(Render.canvas,this)}__class(Scene3D,"laya.d3.core.scene.Scene3D",_super);var __proto=Scene3D.prototype;return Laya.imps(__proto,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),__proto._allotPickColorByID=function(id,pickColor){var pickColorR=Math.floor(id/65025);id-=255*pickColorR*255;var pickColorG=Math.floor(id/255),pickColorB=id-=255*pickColorG,pickColore=pickColor.elements;pickColore[0]=pickColorR/255,pickColore[1]=pickColorG/255,pickColore[2]=pickColorB/255,pickColore[3]=1},__proto._searchIDByPickColor=function(pickColor){var pickColore=pickColor.elements;return 255*pickColore[0]*255+255*pickColore[1]+pickColore[2]},__proto._setLightmapToChildNode=function(sprite){sprite instanceof laya.d3.core.RenderableSprite3D&&sprite._render._applyLightMapParams();for(var children=sprite._children,i=0,n=children.length;i<n;i++)this._setLightmapToChildNode(children[i])},__proto._update=function(){var delta=this.timer._delta/1e3;this._time+=delta,this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.TIME,this._time);var simulation=this._physicsSimulation;Laya3D._enbalePhysics&&!PhysicsSimulation.disableSimulation&&(simulation._updatePhysicsTransformFromRender(),PhysicsComponent._addUpdateList=!1,simulation._simulate(delta),simulation._updateCharacters(),PhysicsComponent._addUpdateList=!0,simulation._updateCollisions(),simulation._eventScripts(),this._input._update()),this._updateScript(),Animator._update(this),this._lateUpdateScript()},__proto._binarySearchIndexInCameraPool=function(camera){for(var start=0,end=this._cameraPool.length-1,mid=0;start<=end;){mid=Math.floor((start+end)/2);var midValue=this._cameraPool[mid]._renderingOrder;if(midValue==camera._renderingOrder)return mid;midValue>camera._renderingOrder?end=mid-1:start=mid+1}return start},__proto._setCreateURL=function(url){this._url=url},__proto._getGroup=function(){return this._group},__proto._setGroup=function(value){this._group=value},__proto._updateScript=function(){for(var pool=this._scriptPool,elements=pool.elements,i=0,n=pool.length;i<n;i++){var script=elements[i];script&&script.enabled&&script.onUpdate()}},__proto._lateUpdateScript=function(){for(var pool=this._scriptPool,elements=pool.elements,i=0,n=pool.length;i<n;i++){var script=elements[i];script&&script.enabled&&script.onLateUpdate()}},__proto._preRenderScript=function(){for(var pool=this._scriptPool,elements=pool.elements,i=0,n=pool.length;i<n;i++){var script=elements[i];script&&script.enabled&&script.onPreRender()}},__proto._postRenderScript=function(){for(var pool=this._scriptPool,elements=pool.elements,i=0,n=pool.length;i<n;i++){var script=elements[i];script&&script.enabled&&script.onPostRender()}},__proto.initOctree=function(width,height,depth,center,level){void 0===level&&(level=6),this.treeSize=new Vector3(width,height,depth),this.treeLevel=level,this.treeRoot=new OctreeNode(this,0),this.treeRoot.initRoot(center,this.treeSize)},__proto._prepareSceneToRender=function(){if(this._lights){var lightCount=this._lights.length;if(lightCount>0)for(var renderLightCount=0,i=0;i<lightCount&&!(this._lights[i]._prepareToScene()&&++renderLightCount>=this._enableLightCount);i++);}},__proto._addCamera=function(camera){for(var index=this._binarySearchIndexInCameraPool(camera),order=camera._renderingOrder,count=this._cameraPool.length;index<count&&this._cameraPool[index]._renderingOrder<=order;)index++;this._cameraPool.splice(index,0,camera)},__proto._removeCamera=function(camera){this._cameraPool.splice(this._cameraPool.indexOf(camera),1)},__proto._preCulling=function(context,camera){camera.useOcclusionCulling?FrustumCulling.renderObjectCulling(camera,this,context,this._renders):FrustumCulling.renderObjectCulling(null,this,context,this._renders)},__proto._clear=function(gl,state){var viewport=state.viewport,camera=state.camera,renderTarget=camera.renderTarget,vpW=viewport.width,vpH=viewport.height,vpX=viewport.x,vpY=camera._canvasHeight-viewport.y-vpH;gl.viewport(vpX,vpY,vpW,vpH);var flag=256,clearFlag=camera.clearFlag;switch(1!==clearFlag||camera.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(clearFlag=0),clearFlag){case 0:var clearColor=camera.clearColor;if(clearColor){gl.enable(3089),gl.scissor(vpX,vpY,vpW,vpH);var clearColorE=clearColor.elements;gl.clearColor(clearColorE[0],clearColorE[1],clearColorE[2],clearColorE[3]),flag|=16384}if(renderTarget)switch(clearColor||(flag=16384),renderTarget.depthStencilFormat){case 0:flag|=256;break;case 1:flag|=1024;break;case 2:flag|=256,flag|=1024}gl.clear(flag),clearColor&&gl.disable(3089);break;case 1:case 2:if(renderTarget)switch(flag=16384,renderTarget.depthStencilFormat){case 0:flag|=256;break;case 1:flag|=1024;break;case 2:flag|=256,flag|=1024}gl.clear(flag);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},__proto._renderScene=function(gl,state,customShader,replacementTag){var camera=state.camera;camera.transform.position;camera.renderTarget?this._opaqueQueue._render(state,!0,customShader,replacementTag):this._opaqueQueue._render(state,!1,customShader,replacementTag),1===camera.clearFlag&&(camera.skyRenderer._isAvailable()?camera.skyRenderer._render(state):this._skyRenderer._isAvailable()&&this._skyRenderer._render(state)),camera.renderTarget?this._transparentQueue._render(state,!0,customShader,replacementTag):this._transparentQueue._render(state,!1,customShader,replacementTag)},__proto._parse=function(data){var lightMapsData=data.lightmaps;if(lightMapsData){var lightMapCount=lightMapsData.length,lightmaps=this._lightmaps;lightmaps.length=lightMapCount;for(var i=0;i<lightMapCount;i++)lightmaps[i]=Loader.getRes(lightMapsData[i].path);this.setlightmaps(lightmaps)}var ambientColorData=data.ambientColor;if(ambientColorData){var ambCol=this.ambientColor;ambCol.fromArray(ambientColorData),this.ambientColor=ambCol}var skyData=data.sky;if(skyData)switch(this._skyRenderer.material=Loader.getRes(skyData.material.path),skyData.mesh){case"SkyBox":this._skyRenderer.mesh=SkyBox.instance;break;case"SkyDome":this._skyRenderer.mesh=SkyDome.instance;break;default:this.skyRenderer.mesh=SkyBox.instance}var reflectionTextureData=data.reflectionTexture;reflectionTextureData&&(this.customReflection=Loader.getRes(reflectionTextureData)),this.enableFog=data.enableFog,this.fogStart=data.fogStart,this.fogRange=data.fogRange;var fogColorData=data.fogColor;if(fogColorData){var fogCol=this.fogColor;fogCol.fromArray(fogColorData),this.fogColor=fogCol}},__proto._onActive=function(){Laya.stage._scene3Ds.push(this)},__proto._onInActive=function(){var scenes=Laya.stage._scene3Ds;scenes.splice(scenes.indexOf(this),1)},__proto._addLight=function(light){this._lights.indexOf(light)<0&&this._lights.push(light)},__proto._removeLight=function(light){var index=this._lights.indexOf(light);index>=0&&this._lights.splice(index,1)},__proto.isLayerVisible=function(layer,camera){return 0!=(Math.pow(2,layer)&camera.cullingMask)},__proto.addTreeNode=function(renderObj){this.treeRoot.addTreeNode(renderObj)},__proto.removeTreeNode=function(renderObj){this.treeSize&&renderObj._treeNode&&renderObj._treeNode.removeObject(renderObj)},__proto._addRenderObject=function(render){if(this.treeRoot)this.addTreeNode(render);else if(this._renders.add(render),Render.isConchApp){var indexInList=render._getIndexInList(),length=this._cullingBufferIndices.length;if(indexInList>=length){var tempIndices=this._cullingBufferIndices,tempResult=this._cullingBufferResult;this._cullingBufferIndices=new Int32Array(length+1024),this._cullingBufferResult=new Int32Array(length+1024),this._cullingBufferIndices.set(tempIndices,0),this._cullingBufferResult.set(tempResult,0)}this._cullingBufferIndices[indexInList]=render._cullingBufferIndex}},__proto._removeRenderObject=function(render){var endRender;this.treeRoot?this.removeTreeNode(render):(Render.isConchApp&&(endRender=this._renders.elements[this._renders.length-1]),this._renders.remove(render),Render.isConchApp&&(this._cullingBufferIndices[endRender._getIndexInList()]=endRender._cullingBufferIndex))},__proto._addShadowCastRenderObject=function(render){this.treeRoot?this.addTreeNode(render):this._castShadowRenders.add(render)},__proto._removeShadowCastRenderObject=function(render){this.treeRoot?this.removeTreeNode(render):this._castShadowRenders.remove(render)},__proto._getRenderQueue=function(index){return index<3e3?this._opaqueQueue:this._transparentQueue},__proto.setlightmaps=function(value){this._lightmaps=value;for(var i=0,n=this._children.length;i<n;i++)this._setLightmapToChildNode(this._children[i])},__proto.getlightmaps=function(){return this._lightmaps},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._skyRenderer.destroy(),this._skyRenderer=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._renders=null,this._castShadowRenders=null,this._cameraPool=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._physicsSimulation&&this._physicsSimulation._destroy(),Loader.clearRes(this.url))},__proto.render=function(ctx,x,y){ctx._curSubmit=Submit.RENDERBASE,this._children.length>0&&ctx.addRenderObject(this)},__proto.renderSubmit=function(){if(!this._cameraPool)return 1;var gl=LayaGL.instance;Render.isConchApp&&(this._glCommandEncoder&&this._glCommandEncoder.clearEncoding(),gl.beginCommandEncoding(this._glCommandEncoder)),this._prepareSceneToRender();var n,n1,i=0;for(i=0,n1=(n=this._cameraPool.length)-1;i<n;i++){Render.isConchApp&&ShaderData.setRuntimeValueMode(i==n1);var camera=this._cameraPool[i];camera.enableRender&&camera.render()}return Render.isConchApp&&(gl.endCommandEncoding(),Buffer._bindedVertexBuffer=null,Buffer._bindedIndexBuffer=null),WebGLContext2D.set2DRenderConfig(),1},__proto.getRenderType=function(){return 0},__proto.releaseRender=function(){},__proto.reUse=function(context,pos){return 0},__proto.renderCallbackFromNative=function(){this._update(),this.renderSubmit()},__proto.renderToNative=function(context,x,y){context.gl.block(this._conchData)},__getset(0,__proto,"fogColor",function(){return this._shaderValues.getVector(laya.d3.core.scene.Scene3D.FOGCOLOR)},function(value){this._shaderValues.setVector(laya.d3.core.scene.Scene3D.FOGCOLOR,value)}),__getset(0,__proto,"enableFog",function(){return this._enableFog},function(value){this._enableFog!==value&&(this._enableFog=value,value?this._defineDatas.add(laya.d3.core.scene.Scene3D.SHADERDEFINE_FOG):this._defineDatas.remove(laya.d3.core.scene.Scene3D.SHADERDEFINE_FOG))}),__getset(0,__proto,"url",function(){return this._url}),__getset(0,__proto,"fogStart",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.FOGSTART)},function(value){this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.FOGSTART,value)}),__getset(0,__proto,"reflectionIntensity",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.REFLETIONINTENSITY)},function(value){value=Math.max(Math.min(value,1),0),this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.REFLETIONINTENSITY,value)}),__getset(0,__proto,"skyRenderer",function(){return this._skyRenderer}),__getset(0,__proto,"fogRange",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.FOGRANGE)},function(value){this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.FOGRANGE,value)}),__getset(0,__proto,"ambientColor",function(){return this._shaderValues.getVector(laya.d3.core.scene.Scene3D.AMBIENTCOLOR)},function(value){this._shaderValues.setVector(laya.d3.core.scene.Scene3D.AMBIENTCOLOR,value)}),__getset(0,__proto,"customReflection",function(){return this._shaderValues.getTexture(laya.d3.core.scene.Scene3D.REFLECTIONTEXTURE)},function(value){this._shaderValues.setTexture(laya.d3.core.scene.Scene3D.REFLECTIONTEXTURE,value),value?this._defineDatas.add(laya.d3.core.scene.Scene3D.SHADERDEFINE_REFLECTMAP):this._defineDatas.remove(laya.d3.core.scene.Scene3D.SHADERDEFINE_REFLECTMAP)}),__getset(0,__proto,"physicsSimulation",function(){return this._physicsSimulation}),__getset(0,__proto,"reflectionMode",function(){return this._reflectionMode},function(value){this._reflectionMode=value}),__getset(0,__proto,"timer",function(){return this._timer},function(value){this._timer=value}),__getset(0,__proto,"input",function(){return this._input}),Scene3D._parse=function(data,propertyParams,constructParams){var json=data.data,outBatchSprits=[],scene=Utils3D._createNodeByJson(json,outBatchSprits);return StaticBatchManager.combine(null,outBatchSprits),scene},Scene3D.load=function(url,complete){Laya.loader.create(url,complete,null,"HIERARCHY")},Scene3D.REFLECTIONMODE_SKYBOX=0,Scene3D.REFLECTIONMODE_CUSTOM=1,Scene3D.SHADERDEFINE_FOG=0,Scene3D.SHADERDEFINE_DIRECTIONLIGHT=0,Scene3D.SHADERDEFINE_POINTLIGHT=0,Scene3D.SHADERDEFINE_SPOTLIGHT=0,Scene3D.SHADERDEFINE_CAST_SHADOW=0,Scene3D.SHADERDEFINE_SHADOW_PSSM1=0,Scene3D.SHADERDEFINE_SHADOW_PSSM2=0,Scene3D.SHADERDEFINE_SHADOW_PSSM3=0,Scene3D.SHADERDEFINE_SHADOW_PCF_NO=0,Scene3D.SHADERDEFINE_SHADOW_PCF1=0,Scene3D.SHADERDEFINE_SHADOW_PCF2=0,Scene3D.SHADERDEFINE_SHADOW_PCF3=0,Scene3D.SHADERDEFINE_REFLECTMAP=0,__static(Scene3D,["FOGCOLOR",function(){return this.FOGCOLOR=Shader3D.propertyNameToID("u_FogColor")},"FOGSTART",function(){return this.FOGSTART=Shader3D.propertyNameToID("u_FogStart")},"FOGRANGE",function(){return this.FOGRANGE=Shader3D.propertyNameToID("u_FogRange")},"LIGHTDIRECTION",function(){return this.LIGHTDIRECTION=Shader3D.propertyNameToID("u_DirectionLight.Direction")},"LIGHTDIRCOLOR",function(){return this.LIGHTDIRCOLOR=Shader3D.propertyNameToID("u_DirectionLight.Color")},"POINTLIGHTPOS",function(){return this.POINTLIGHTPOS=Shader3D.propertyNameToID("u_PointLight.Position")},"POINTLIGHTRANGE",function(){return this.POINTLIGHTRANGE=Shader3D.propertyNameToID("u_PointLight.Range")},"POINTLIGHTATTENUATION",function(){return this.POINTLIGHTATTENUATION=Shader3D.propertyNameToID("u_PointLight.Attenuation")},"POINTLIGHTCOLOR",function(){return this.POINTLIGHTCOLOR=Shader3D.propertyNameToID("u_PointLight.Color")},"SPOTLIGHTPOS",function(){return this.SPOTLIGHTPOS=Shader3D.propertyNameToID("u_SpotLight.Position")},"SPOTLIGHTDIRECTION",function(){return this.SPOTLIGHTDIRECTION=Shader3D.propertyNameToID("u_SpotLight.Direction")},"SPOTLIGHTSPOTANGLE",function(){return this.SPOTLIGHTSPOTANGLE=Shader3D.propertyNameToID("u_SpotLight.Spot")},"SPOTLIGHTRANGE",function(){return this.SPOTLIGHTRANGE=Shader3D.propertyNameToID("u_SpotLight.Range")},"SPOTLIGHTCOLOR",function(){return this.SPOTLIGHTCOLOR=Shader3D.propertyNameToID("u_SpotLight.Color")},"SHADOWDISTANCE",function(){return this.SHADOWDISTANCE=Shader3D.propertyNameToID("u_shadowPSSMDistance")},"SHADOWLIGHTVIEWPROJECT",function(){return this.SHADOWLIGHTVIEWPROJECT=Shader3D.propertyNameToID("u_lightShadowVP")},"SHADOWMAPPCFOFFSET",function(){return this.SHADOWMAPPCFOFFSET=Shader3D.propertyNameToID("u_shadowPCFoffset")},"SHADOWMAPTEXTURE1",function(){return this.SHADOWMAPTEXTURE1=Shader3D.propertyNameToID("u_shadowMap1")},"SHADOWMAPTEXTURE2",function(){return this.SHADOWMAPTEXTURE2=Shader3D.propertyNameToID("u_shadowMap2")},"SHADOWMAPTEXTURE3",function(){return this.SHADOWMAPTEXTURE3=Shader3D.propertyNameToID("u_shadowMap3")},"AMBIENTCOLOR",function(){return this.AMBIENTCOLOR=Shader3D.propertyNameToID("u_AmbientColor")},"REFLECTIONTEXTURE",function(){return this.REFLECTIONTEXTURE=Shader3D.propertyNameToID("u_ReflectTexture")},"REFLETIONINTENSITY",function(){return this.REFLETIONINTENSITY=Shader3D.propertyNameToID("u_ReflectIntensity")},"TIME",function(){return this.TIME=Shader3D.propertyNameToID("u_Time")},"ANGLEATTENUATIONTEXTURE",function(){return this.ANGLEATTENUATIONTEXTURE=Shader3D.propertyNameToID("u_AngleTexture")},"RANGEATTENUATIONTEXTURE",function(){return this.RANGEATTENUATIONTEXTURE=Shader3D.propertyNameToID("u_RangeTexture")},"POINTLIGHTMATRIX",function(){return this.POINTLIGHTMATRIX=Shader3D.propertyNameToID("u_PointLightMatrix")},"SPOTLIGHTMATRIX",function(){return this.SPOTLIGHTMATRIX=Shader3D.propertyNameToID("u_SpotLightMatrix")}]),Scene3D}(Sprite)),RenderableSprite3D=function(_super){function RenderableSprite3D(name){this.pickColor=null,this._render=null,RenderableSprite3D.__super.call(this,name)}__class(RenderableSprite3D,"laya.d3.core.RenderableSprite3D",_super);var __proto=RenderableSprite3D.prototype;return __proto._onInActive=function(){var scene3D=this._scene;scene3D._removeRenderObject(this._render),this._render.castShadow&&scene3D._removeShadowCastRenderObject(this._render)},__proto._onActive=function(){laya.display.Node.prototype._onActive.call(this);var scene3D=this._scene;scene3D._addRenderObject(this._render),this._render.castShadow&&scene3D._addShadowCastRenderObject(this._render)},__proto._onActiveInScene=function(){if(laya.display.Node.prototype._onActiveInScene.call(this),Laya3D._editerEnvironment){var scene=this._scene,pickColor=new Vector4;scene._allotPickColorByID(this.id,pickColor),scene._pickIdToSprite[this.id]=this,this._render._shaderValues.setVector(laya.d3.core.RenderableSprite3D.PICKCOLOR,pickColor)}},__proto._addToInitStaticBatchManager=function(){},__proto._setBelongScene=function(scene){laya.display.Node.prototype._setBelongScene.call(this,scene),this._render._setBelongScene(scene)},__proto._setUnBelongScene=function(){this._render._defineDatas.remove(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),laya.display.Node.prototype._setUnBelongScene.call(this)},__proto._changeHierarchyAnimator=function(animator){if(this._hierarchyAnimator){var renderableSprites=this._hierarchyAnimator._renderableSprites;renderableSprites.splice(renderableSprites.indexOf(this),1)}animator&&animator._renderableSprites.push(this),_super.prototype._changeHierarchyAnimator.call(this,animator)},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),_super.prototype.destroy.call(this,destroyChild),this._render._destroy(),this._render=null},RenderableSprite3D.__init__=function(){RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW=RenderableSprite3D.shaderDefines.registerDefine("RECEIVESHADOW"),RenderableSprite3D.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=RenderableSprite3D.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),RenderableSprite3D.SAHDERDEFINE_LIGHTMAP=RenderableSprite3D.shaderDefines.registerDefine("LIGHTMAP")},RenderableSprite3D.SHADERDEFINE_RECEIVE_SHADOW=0,RenderableSprite3D.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=0,RenderableSprite3D.SAHDERDEFINE_LIGHTMAP=0,__static(RenderableSprite3D,["LIGHTMAPSCALEOFFSET",function(){return this.LIGHTMAPSCALEOFFSET=Shader3D.propertyNameToID("u_LightmapScaleOffset")},"LIGHTMAP",function(){return this.LIGHTMAP=Shader3D.propertyNameToID("u_LightMap")},"PICKCOLOR",function(){return this.PICKCOLOR=Shader3D.propertyNameToID("u_PickColor")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines}]),RenderableSprite3D}(Sprite3D),LightSprite=function(_super){function LightSprite(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,LightSprite.__super.call(this),this._intensity=1,this._intensityColor=new Vector3,this.color=new Vector3(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=LightSprite.LIGHTMAPBAKEDTYPE_REALTIME}__class(LightSprite,"laya.d3.core.light.LightSprite",_super);var __proto=LightSprite.prototype;return __proto._parse=function(data){_super.prototype._parse.call(this,data);var colorData=data.color;this.color.fromArray(colorData),this.intensity=data.intensity,this.lightmapBakedType=data.lightmapBakedType},__proto._onActive=function(){this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},__proto._onInActive=function(){this.lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},__proto._prepareToScene=function(){return!1},__getset(0,__proto,"lightmapBakedType",function(){return this._lightmapBakedType},function(value){this._lightmapBakedType!==value&&(this._lightmapBakedType=value,this.activeInHierarchy&&(value!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)))}),__getset(0,__proto,"shadowPCFType",function(){return this._shadowMapPCFType},function(value){this._shadowMapPCFType=value,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(value)}),__getset(0,__proto,"intensity",function(){return this._intensity},function(value){this._intensity=value}),__getset(0,__proto,"shadow",function(){return this._shadow},function(value){throw new Error("LightSprite: must override it.")}),__getset(0,__proto,"shadowDistance",function(){return this._shadowFarPlane},function(value){this._shadowFarPlane=value,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(value)}),__getset(0,__proto,"shadowPSSMCount",function(){return this._shadowMapCount},function(value){this._shadowMapCount=value,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.shadowMapCount=value)}),__getset(0,__proto,"shadowResolution",function(){return this._shadowMapSize},function(value){this._shadowMapSize=value,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(value)}),__getset(0,__proto,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(value){console.log("LightSprite: discard property,please use color property instead."),this.color=value}),LightSprite.LIGHTMAPBAKEDTYPE_REALTIME=0,LightSprite.LIGHTMAPBAKEDTYPE_MIXED=1,LightSprite.LIGHTMAPBAKEDTYPE_BAKED=2,LightSprite}(Sprite3D),ShurikenParticleMaterial=(function(_super){function SkyBoxMaterial(){SkyBoxMaterial.__super.call(this),this.setShaderName("SkyBox")}__class(SkyBoxMaterial,"laya.d3.core.material.SkyBoxMaterial",BaseMaterial);var __proto=SkyBoxMaterial.prototype;__getset(0,__proto,"tintColor",function(){return this._shaderValues.getVector(SkyBoxMaterial.TINTCOLOR)},function(value){this._shaderValues.setVector(SkyBoxMaterial.TINTCOLOR,value)}),__getset(0,__proto,"exposure",function(){return this._shaderValues.getNumber(SkyBoxMaterial.EXPOSURE)},function(value){this._shaderValues.setNumber(SkyBoxMaterial.EXPOSURE,value)}),__getset(0,__proto,"rotation",function(){return this._shaderValues.getNumber(SkyBoxMaterial.ROTATION)},function(value){this._shaderValues.setNumber(SkyBoxMaterial.ROTATION,value)}),__getset(0,__proto,"textureCube",function(){return this._shaderValues.getTexture(SkyBoxMaterial.TEXTURECUBE)},function(value){return this._shaderValues.setTexture(SkyBoxMaterial.TEXTURECUBE,value)}),__static(SkyBoxMaterial,["TINTCOLOR",function(){return this.TINTCOLOR=Shader3D.propertyNameToID("u_TintColor")},"EXPOSURE",function(){return this.EXPOSURE=Shader3D.propertyNameToID("u_Exposure")},"ROTATION",function(){return this.ROTATION=Shader3D.propertyNameToID("u_Rotation")},"TEXTURECUBE",function(){return this.TEXTURECUBE=Shader3D.propertyNameToID("u_CubeTexture")},"defaultMaterial",function(){return this.defaultMaterial=new SkyBoxMaterial}])}(),function(_super){function ShurikenParticleMaterial(){ShurikenParticleMaterial.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this._color=new Vector4(1,1,1,1),this.renderMode=0}__class(ShurikenParticleMaterial,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",BaseMaterial);var __proto=ShurikenParticleMaterial.prototype;return __getset(0,__proto,"_TintColorB",function(){return this._color.elements[2]},function(value){this._color.elements[2]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"texture",function(){return this._shaderValues.getTexture(ShurikenParticleMaterial.DIFFUSETEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(ShurikenParticleMaterial.DIFFUSETEXTURE,value)}),__getset(0,__proto,"_TintColorR",function(){return this._color.elements[0]},function(value){this._color.elements[0]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"_TintColorG",function(){return this._color.elements[1]},function(value){this._color.elements[1]=value,this.color=this._color}),__getset(0,__proto,"_TintColorA",function(){return this._color.elements[3]},function(value){this._color.elements[3]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 1:this.renderQueue=3e3,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,this.alphaTest=!1,this._defineDatas.add(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;case 0:this.renderQueue=3e3,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=1,this.alphaTest=!1,this._defineDatas.remove(ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.")}}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"colorR",function(){return this._TintColorR},function(value){this._TintColorR=value}),__getset(0,__proto,"colorG",function(){return this._TintColorG},function(value){this._TintColorG=value}),__getset(0,__proto,"colorB",function(){return this._TintColorB},function(value){this._TintColorB=value}),__getset(0,__proto,"colorA",function(){return this._TintColorA},function(value){this._TintColorA=value}),__getset(0,__proto,"color",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TINTCOLOR)},function(value){value?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(ShurikenParticleMaterial.TINTCOLOR,value)}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(ShurikenParticleMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(ShurikenParticleMaterial.TILINGOFFSET,value)}),ShurikenParticleMaterial.__init__=function(){ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=ShurikenParticleMaterial.shaderDefines.registerDefine("DIFFUSEMAP"),ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=ShurikenParticleMaterial.shaderDefines.registerDefine("TINTCOLOR"),ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=ShurikenParticleMaterial.shaderDefines.registerDefine("ADDTIVEFOG"),ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET=ShurikenParticleMaterial.shaderDefines.registerDefine("TILINGOFFSET")},ShurikenParticleMaterial.RENDERMODE_ALPHABLENDED=0,ShurikenParticleMaterial.RENDERMODE_ADDTIVE=1,ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP=0,ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR=0,ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET=0,ShurikenParticleMaterial.SHADERDEFINE_ADDTIVEFOG=0,__static(ShurikenParticleMaterial,["DIFFUSETEXTURE",function(){return this.DIFFUSETEXTURE=Shader3D.propertyNameToID("u_texture")},"TINTCOLOR",function(){return this.TINTCOLOR=Shader3D.propertyNameToID("u_Tintcolor")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"defaultMaterial",function(){return this.defaultMaterial=new ShurikenParticleMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),ShurikenParticleMaterial}()),SkyProceduralMaterial=function(_super){function SkyProceduralMaterial(){this._sunDisk=0,SkyProceduralMaterial.__super.call(this),this.setShaderName("SkyBoxProcedural"),this.sunDisk=1,this.sunSize=.04,this.sunSizeConvergence=5,this.atmosphereThickness=1,this.skyTint=new Vector4(.5,.5,.5,1),this.groundTint=new Vector4(.369,.349,.341,1),this.exposure=1.3}__class(SkyProceduralMaterial,"laya.d3.core.material.SkyProceduralMaterial",BaseMaterial);var __proto=SkyProceduralMaterial.prototype;return __getset(0,__proto,"exposure",function(){return this._shaderValues.getNumber(SkyProceduralMaterial.EXPOSURE)},function(value){value=Math.min(Math.max(0,value),8),this._shaderValues.setNumber(SkyProceduralMaterial.EXPOSURE,value)}),__getset(0,__proto,"sunSize",function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZE)},function(value){value=Math.min(Math.max(0,value),1),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZE,value)}),__getset(0,__proto,"sunDisk",function(){return this._sunDisk},function(value){switch(value){case 1:this._defineDatas.remove(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE),this._defineDatas.add(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY);break;case 2:this._defineDatas.remove(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._defineDatas.add(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;case 0:this._defineDatas.remove(SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY),this._defineDatas.remove(SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value."}this._sunDisk=value}),__getset(0,__proto,"sunSizeConvergence",function(){return this._shaderValues.getNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE)},function(value){value=Math.min(Math.max(0,value),20),this._shaderValues.setNumber(SkyProceduralMaterial.SUNSIZECONVERGENCE,value)}),__getset(0,__proto,"atmosphereThickness",function(){return this._shaderValues.getNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS)},function(value){value=Math.min(Math.max(0,value),5),this._shaderValues.setNumber(SkyProceduralMaterial.ATMOSPHERETHICKNESS,value)}),__getset(0,__proto,"groundTint",function(){return this._shaderValues.getVector(SkyProceduralMaterial.GROUNDTINT)},function(value){this._shaderValues.setVector(SkyProceduralMaterial.GROUNDTINT,value)}),__getset(0,__proto,"skyTint",function(){return this._shaderValues.getVector(SkyProceduralMaterial.SKYTINT)},function(value){this._shaderValues.setVector(SkyProceduralMaterial.SKYTINT,value)}),SkyProceduralMaterial.__init__=function(){SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY=SkyProceduralMaterial.shaderDefines.registerDefine("SUN_HIGH_QUALITY"),SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE=SkyProceduralMaterial.shaderDefines.registerDefine("SUN_SIMPLE")},SkyProceduralMaterial.SUN_NODE=0,SkyProceduralMaterial.SUN_HIGH_QUALITY=1,SkyProceduralMaterial.SUN_SIMPLE=2,SkyProceduralMaterial.SHADERDEFINE_SUN_HIGH_QUALITY=0,SkyProceduralMaterial.SHADERDEFINE_SUN_SIMPLE=0,__static(SkyProceduralMaterial,["SUNSIZE",function(){return this.SUNSIZE=Shader3D.propertyNameToID("u_SunSize")},"SUNSIZECONVERGENCE",function(){return this.SUNSIZECONVERGENCE=Shader3D.propertyNameToID("u_SunSizeConvergence")},"ATMOSPHERETHICKNESS",function(){return this.ATMOSPHERETHICKNESS=Shader3D.propertyNameToID("u_AtmosphereThickness")},"SKYTINT",function(){return this.SKYTINT=Shader3D.propertyNameToID("u_SkyTint")},"GROUNDTINT",function(){return this.GROUNDTINT=Shader3D.propertyNameToID("u_GroundTint")},"EXPOSURE",function(){return this.EXPOSURE=Shader3D.propertyNameToID("u_Exposure")},"defaultMaterial",function(){return this.defaultMaterial=new SkyProceduralMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),SkyProceduralMaterial}(),BlinnPhongMaterial=function(_super){function BlinnPhongMaterial(){this._enableVertexColor=!1,BlinnPhongMaterial.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new Vector4(1,1,1,1);var sv=this._shaderValues;sv.setVector(BlinnPhongMaterial.ALBEDOCOLOR,new Vector4(1,1,1,1)),sv.setVector(BlinnPhongMaterial.MATERIALSPECULAR,new Vector4(1,1,1,1)),sv.setNumber(BlinnPhongMaterial.SHININESS,.078125),sv.setNumber(BaseMaterial.ALPHATESTVALUE,.5),sv.setVector(BlinnPhongMaterial.TILINGOFFSET,new Vector4(1,1,0,0)),this._enableLighting=!0,this.renderMode=0}__class(BlinnPhongMaterial,"laya.d3.core.material.BlinnPhongMaterial",_super);var __proto=BlinnPhongMaterial.prototype;return __proto.disableFog=function(){this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_FOG)},__proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destMaterial=destObject;destMaterial._enableLighting=this._enableLighting,destMaterial._albedoIntensity=this._albedoIntensity,this._albedoColor.cloneTo(destMaterial._albedoColor)},__getset(0,__proto,"_SpecColorG",function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[1]},function(value){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[1]=value}),__getset(0,__proto,"_ColorB",function(){return this._albedoColor.elements[2]},function(value){this._albedoColor.elements[2]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorR",function(){return this._albedoColor.elements[0]},function(value){this._albedoColor.elements[0]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"albedoColorA",function(){return this._ColorA},function(value){this._ColorA=value}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"_SpecColorB",function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[2]},function(value){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[2]=value}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 0:this.alphaTest=!1,this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 1:this.renderQueue=2450,this.alphaTest=!0,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 2:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513;break;default:throw new Error("Material:renderMode value error.")}}),__getset(0,__proto,"_SpecColorR",function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[0]},function(value){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[0]=value}),__getset(0,__proto,"_ColorG",function(){return this._albedoColor.elements[1]},function(value){this._albedoColor.elements[1]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorA",function(){return this._albedoColor.elements[3]},function(value){this._albedoColor.elements[3]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"specularColor",function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR)},function(value){this._shaderValues.setVector(BlinnPhongMaterial.MATERIALSPECULAR,value)}),__getset(0,__proto,"albedoColorB",function(){return this._ColorB},function(value){this._ColorB=value}),__getset(0,__proto,"_SpecColorA",function(){return this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[3]},function(value){this._shaderValues.getVector(BlinnPhongMaterial.MATERIALSPECULAR).elements[3]=value}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"_AlbedoIntensity",function(){return this._albedoIntensity},function(value){if(this._albedoIntensity!==value){var finalAlbedo=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);Vector4.scale(this._albedoColor,value,finalAlbedo),this._albedoIntensity=value,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,finalAlbedo)}}),__getset(0,__proto,"specularColorA",function(){return this._SpecColorA},function(value){this._SpecColorA=value}),__getset(0,__proto,"_Shininess",function(){return this._shaderValues.getNumber(BlinnPhongMaterial.SHININESS)},function(value){value=Math.max(0,Math.min(1,value)),this._shaderValues.setNumber(BlinnPhongMaterial.SHININESS,value)}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"_Cutoff",function(){return this.alphaTestValue},function(value){this.alphaTestValue=value}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"albedoTexture",function(){return this._shaderValues.getTexture(BlinnPhongMaterial.ALBEDOTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(BlinnPhongMaterial.ALBEDOTEXTURE,value)}),__getset(0,__proto,"enableVertexColor",function(){return this._enableVertexColor},function(value){this._enableVertexColor=value,value?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}),__getset(0,__proto,"albedoColor",function(){return this._albedoColor},function(value){var finalAlbedo=this._shaderValues.getVector(BlinnPhongMaterial.ALBEDOCOLOR);Vector4.scale(value,this._albedoIntensity,finalAlbedo),this._albedoColor=value,this._shaderValues.setVector(BlinnPhongMaterial.ALBEDOCOLOR,finalAlbedo)}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"enableLighting",function(){return this._enableLighting},function(value){this._enableLighting!==value&&(value?this._disablePublicDefineDatas.remove(Scene3D.SHADERDEFINE_POINTLIGHT|Scene3D.SHADERDEFINE_SPOTLIGHT|Scene3D.SHADERDEFINE_DIRECTIONLIGHT):this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_POINTLIGHT|Scene3D.SHADERDEFINE_SPOTLIGHT|Scene3D.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=value)}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(BlinnPhongMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(BlinnPhongMaterial.TILINGOFFSET,value)}),__getset(0,__proto,"albedoColorR",function(){return this._ColorR},function(value){this._ColorR=value}),__getset(0,__proto,"albedoColorG",function(){return this._ColorG},function(value){this._ColorG=value}),__getset(0,__proto,"albedoIntensity",function(){return this._albedoIntensity},function(value){this._AlbedoIntensity=value}),__getset(0,__proto,"specularColorR",function(){return this._SpecColorR},function(value){this._SpecColorR=value}),__getset(0,__proto,"specularColorG",function(){return this._SpecColorG},function(value){this._SpecColorG=value}),__getset(0,__proto,"specularColorB",function(){return this._SpecColorB},function(value){this._SpecColorB=value}),__getset(0,__proto,"shininess",function(){return this._Shininess},function(value){this._Shininess=value}),__getset(0,__proto,"normalTexture",function(){return this._shaderValues.getTexture(BlinnPhongMaterial.NORMALTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(BlinnPhongMaterial.NORMALTEXTURE,value)}),__getset(0,__proto,"specularTexture",function(){return this._shaderValues.getTexture(BlinnPhongMaterial.SPECULARTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(BlinnPhongMaterial.SPECULARTEXTURE,value)}),BlinnPhongMaterial.__init__=function(){BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=BlinnPhongMaterial.shaderDefines.registerDefine("DIFFUSEMAP"),BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=BlinnPhongMaterial.shaderDefines.registerDefine("NORMALMAP"),BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=BlinnPhongMaterial.shaderDefines.registerDefine("SPECULARMAP"),BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET=BlinnPhongMaterial.shaderDefines.registerDefine("TILINGOFFSET"),BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=BlinnPhongMaterial.shaderDefines.registerDefine("ENABLEVERTEXCOLOR")},BlinnPhongMaterial.SPECULARSOURCE_DIFFUSEMAPALPHA=0,BlinnPhongMaterial.SPECULARSOURCE_SPECULARMAP=0,BlinnPhongMaterial.RENDERMODE_OPAQUE=0,BlinnPhongMaterial.RENDERMODE_CUTOUT=1,BlinnPhongMaterial.RENDERMODE_TRANSPARENT=2,BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP=0,BlinnPhongMaterial.SHADERDEFINE_NORMALMAP=0,BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP=0,BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET=0,BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=0,__static(BlinnPhongMaterial,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Shader3D.propertyNameToID("u_DiffuseTexture")},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Shader3D.propertyNameToID("u_NormalTexture")},"SPECULARTEXTURE",function(){return this.SPECULARTEXTURE=Shader3D.propertyNameToID("u_SpecularTexture")},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Shader3D.propertyNameToID("u_DiffuseColor")},"MATERIALSPECULAR",function(){return this.MATERIALSPECULAR=Shader3D.propertyNameToID("u_MaterialSpecular")},"SHININESS",function(){return this.SHININESS=Shader3D.propertyNameToID("u_Shininess")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"defaultMaterial",function(){return this.defaultMaterial=new BlinnPhongMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),BlinnPhongMaterial}(BaseMaterial),Terrain=function(_super){function Terrain(terrainRes){this._terrainRes=null,this._lightmapScaleOffset=null,Terrain.__super.call(this),this._lightmapScaleOffset=new Vector4(1,1,0,0),terrainRes&&(this._terrainRes=terrainRes,this.buildTerrain(terrainRes))}__class(Terrain,"laya.d3.terrain.Terrain",_super);var __proto=Terrain.prototype;return __proto._parse=function(data){_super.prototype._parse.call(this,data),this.terrainRes=Loader.getRes(data.dataPath);var lightmapIndex=data.lightmapIndex;null!=lightmapIndex&&this.setLightmapIndex(lightmapIndex);var lightmapScaleOffsetArray=data.lightmapScaleOffset;lightmapScaleOffsetArray&&this.setLightmapScaleOffset(new Vector4(lightmapScaleOffsetArray[0],lightmapScaleOffsetArray[1],lightmapScaleOffsetArray[2],lightmapScaleOffsetArray[3]))},__proto.setLightmapIndex=function(value){for(var i=0;i<this._children.length;i++){this._children[i].terrainRender.lightmapIndex=value}},__proto.setLightmapScaleOffset=function(value){if(value){value.cloneTo(this._lightmapScaleOffset);for(var i=0;i<this._children.length;i++){this._children[i].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}}},__proto.disableLight=function(){for(var i=0,n=this._children.length;i<n;i++)for(var terrainChunk=this._children[i],j=0,m=terrainChunk._render.sharedMaterials.length;j<m;j++){terrainChunk._render.sharedMaterials[j].disableLight()}},__proto.buildTerrain=function(terrainRes){for(var chunkNumX=terrainRes._chunkNumX,chunkNumZ=terrainRes._chunkNumZ,heightData=terrainRes._heightData,n=0,i=0;i<chunkNumZ;i++)for(var j=0;j<chunkNumX;j++){for(var terrainChunk=new TerrainChunk(j,i,terrainRes._gridSize,heightData._terrainHeightData,heightData._width,heightData._height,terrainRes._cameraCoordinateInverse),chunkInfo=terrainRes._chunkInfos[n++],k=0;k<chunkInfo.alphaMap.length;k++){var nNum=chunkInfo.detailID[k].length,sDetialTextureUrl1=nNum>0?terrainRes._detailTextureInfos[chunkInfo.detailID[k][0]].diffuseTexture:null,sDetialTextureUrl2=nNum>1?terrainRes._detailTextureInfos[chunkInfo.detailID[k][1]].diffuseTexture:null,sDetialTextureUrl3=nNum>2?terrainRes._detailTextureInfos[chunkInfo.detailID[k][2]].diffuseTexture:null,sDetialTextureUrl4=nNum>3?terrainRes._detailTextureInfos[chunkInfo.detailID[k][3]].diffuseTexture:null,detialScale1=nNum>0?terrainRes._detailTextureInfos[chunkInfo.detailID[k][0]].scale:null,detialScale2=nNum>1?terrainRes._detailTextureInfos[chunkInfo.detailID[k][1]].scale:null,detialScale3=nNum>2?terrainRes._detailTextureInfos[chunkInfo.detailID[k][2]].scale:null,detialScale4=nNum>3?terrainRes._detailTextureInfos[chunkInfo.detailID[k][3]].scale:null;terrainChunk.buildRenderElementAndMaterial(nNum,chunkInfo.normalMap,chunkInfo.alphaMap[k],sDetialTextureUrl1,sDetialTextureUrl2,sDetialTextureUrl3,sDetialTextureUrl4,terrainRes._materialInfo.ambientColor,terrainRes._materialInfo.diffuseColor,terrainRes._materialInfo.specularColor,detialScale1?detialScale1.x:1,detialScale1?detialScale1.y:1,detialScale2?detialScale2.x:1,detialScale2?detialScale2.y:1,detialScale3?detialScale3.x:1,detialScale3?detialScale3.y:1,detialScale4?detialScale4.x:1,detialScale4?detialScale4.y:1)}terrainChunk.terrainRender.receiveShadow=!0,terrainChunk.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(terrainChunk)}},__proto.width=function(){return this._terrainRes._chunkNumX*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},__proto.depth=function(){return this._terrainRes._chunkNumZ*TerrainLeaf.CHUNK_GRID_NUM*this._terrainRes._gridSize},__proto.getHeightXZ=function(x,z){if(!this._terrainRes)return NaN;if(x-=this.transform.position.x,z-=this.transform.position.z,Terrain.__VECTOR3__||(Terrain.__VECTOR3__=new Vector3),Terrain.__VECTOR3__.elements[0]=x,Terrain.__VECTOR3__.elements[1]=0,Terrain.__VECTOR3__.elements[2]=z,Vector3.transformV3ToV3(Terrain.__VECTOR3__,TerrainLeaf.__ADAPT_MATRIX_INV__,Terrain.__VECTOR3__),x=Terrain.__VECTOR3__.elements[0],z=Terrain.__VECTOR3__.elements[2],x<0||x>this.width()||z<0||z>this.depth())return NaN;var gridSize=this._terrainRes._gridSize,nIndexX=parseInt(""+x/gridSize),nIndexZ=parseInt(""+z/gridSize),offsetX=x-nIndexX*gridSize,offsetZ=z-nIndexZ*gridSize,h1=NaN,heightData=this._terrainRes._heightData;return offsetX+offsetZ>gridSize?(h1=heightData._terrainHeightData[(nIndexZ+1-1)*heightData._width+nIndexX+1])+(heightData._terrainHeightData[(nIndexZ+1-1)*heightData._width+nIndexX]-h1)*((gridSize-offsetX)/gridSize)+(heightData._terrainHeightData[(nIndexZ-1)*heightData._width+nIndexX+1]-h1)*((gridSize-offsetZ)/gridSize):(h1=heightData._terrainHeightData[Math.max(0,nIndexZ-1)*heightData._width+nIndexX])+(heightData._terrainHeightData[Math.min(heightData._width*heightData._height-1,(nIndexZ+1-1)*heightData._width+nIndexX)]-h1)*(offsetZ/gridSize)+(heightData._terrainHeightData[Math.min(heightData._width*heightData._height-1,Math.max(0,nIndexZ-1)*heightData._width+nIndexX+1)]-h1)*(offsetX/gridSize)},__getset(0,__proto,"terrainRes",null,function(value){value&&(this._terrainRes=value,this.buildTerrain(value))}),Terrain.load=function(url){Laya.loader.create(url,null,null,"TERRAIN",null,null,1,!1)},Terrain.RENDER_LINE_MODEL=!1,Terrain.LOD_TOLERANCE_VALUE=4,Terrain.LOD_DISTANCE_FACTOR=2,Terrain.__VECTOR3__=null,Terrain}(Sprite3D),PBRSpecularMaterial=function(_super){function PBRSpecularMaterial(){this._albedoColor=null,this._specularColor=null,this._emissionColor=null,PBRSpecularMaterial.__super.call(this),this.setShaderName("PBRSpecular"),this._albedoColor=new Vector4(1,1,1,1),this._shaderValues.setVector(PBRSpecularMaterial.ALBEDOCOLOR,new Vector4(1,1,1,1)),this._emissionColor=new Vector4(0,0,0,0),this._shaderValues.setVector(PBRSpecularMaterial.EMISSIONCOLOR,new Vector4(0,0,0,0)),this._specularColor=new Vector4(.2,.2,.2,.2),this._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,new Vector4(.2,.2,.2,.2)),this._shaderValues.setNumber(PBRSpecularMaterial.SMOOTHNESS,.5),this._shaderValues.setNumber(PBRSpecularMaterial.SMOOTHNESSSCALE,1),this._shaderValues.setNumber(PBRSpecularMaterial.SMOOTHNESSSOURCE,0),this._shaderValues.setNumber(PBRSpecularMaterial.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(PBRSpecularMaterial.NORMALSCALE,1),this._shaderValues.setNumber(PBRSpecularMaterial.PARALLAXSCALE,.001),this._shaderValues.setBool(PBRSpecularMaterial.ENABLEEMISSION,!1),this._shaderValues.setNumber(BaseMaterial.ALPHATESTVALUE,.5)}__class(PBRSpecularMaterial,"laya.d3.core.material.PBRSpecularMaterial",_super);var __proto=PBRSpecularMaterial.prototype;return __proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destMaterial=destObject;this._albedoColor.cloneTo(destMaterial._albedoColor),this._specularColor.cloneTo(destMaterial._specularColor),this._emissionColor.cloneTo(destMaterial._emissionColor)},__getset(0,__proto,"emissionTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.EMISSIONTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.EMISSIONTEXTURE,value)}),__getset(0,__proto,"_SpecColorG",function(){return this._specularColor.elements[1]},function(value){this._specularColor.elements[1]=value,this.specularColor=this._specularColor}),__getset(0,__proto,"_ColorB",function(){return this._albedoColor.elements[2]},function(value){this._albedoColor.elements[2]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorR",function(){return this._albedoColor.elements[0]},function(value){this._albedoColor.elements[0]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"albedoColorA",function(){return this._ColorA},function(value){this._ColorA=value}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"_SpecColorB",function(){return this._specularColor.elements[2]},function(value){this._specularColor.elements[2]=value,this.specularColor=this._specularColor}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 0:this.alphaTest=!1,this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513,this._defineDatas.remove(PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 1:this.renderQueue=2450,this.alphaTest=!0,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513,this._defineDatas.remove(PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 2:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.remove(PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 3:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=1,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.add(PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.")}}),__getset(0,__proto,"_SpecColorR",function(){return this._specularColor.elements[0]},function(value){this._specularColor.elements[0]=value,this.specularColor=this._specularColor}),__getset(0,__proto,"_ColorG",function(){return this._albedoColor.elements[1]},function(value){this._albedoColor.elements[1]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_Glossiness",function(){return this._shaderValues.getNumber(PBRSpecularMaterial.SMOOTHNESS)},function(value){this._shaderValues.setNumber(PBRSpecularMaterial.SMOOTHNESS,value)}),__getset(0,__proto,"_ColorA",function(){return this._albedoColor.elements[3]},function(value){this._albedoColor.elements[3]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"specularColor",function(){return this._shaderValues.getVector(PBRSpecularMaterial.SPECULARCOLOR)},function(value){this._shaderValues.setVector(PBRSpecularMaterial.SPECULARCOLOR,value)}),__getset(0,__proto,"albedoColorB",function(){return this._ColorB},function(value){this._ColorB=value}),__getset(0,__proto,"_SpecColorA",function(){return this._specularColor.elements[3]},function(value){this._specularColor.elements[3]=value,this.specularColor=this._specularColor}),__getset(0,__proto,"_GlossMapScale",function(){return this._shaderValues.getNumber(PBRSpecularMaterial.SMOOTHNESSSCALE)},function(value){this._shaderValues.setNumber(PBRSpecularMaterial.SMOOTHNESSSCALE,value)}),__getset(0,__proto,"_BumpScale",function(){return this._shaderValues.getNumber(PBRSpecularMaterial.NORMALSCALE)},function(value){this._shaderValues.setNumber(PBRSpecularMaterial.NORMALSCALE,value)}),__getset(0,__proto,"_Parallax",function(){return this._shaderValues.getNumber(PBRSpecularMaterial.PARALLAXSCALE)},function(value){this._shaderValues.setNumber(PBRSpecularMaterial.PARALLAXSCALE,value)}),__getset(0,__proto,"_OcclusionStrength",function(){return this._shaderValues.getNumber(PBRSpecularMaterial.OCCLUSIONSTRENGTH)},function(value){this._shaderValues.setNumber(PBRSpecularMaterial.OCCLUSIONSTRENGTH,value)}),__getset(0,__proto,"_EmissionColorR",function(){return this._emissionColor.elements[0]},function(value){this._emissionColor.elements[0]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(PBRSpecularMaterial.TILINGOFFSET,value)}),__getset(0,__proto,"_EmissionColorG",function(){return this._emissionColor.elements[1]},function(value){this._emissionColor.elements[1]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"_EmissionColorB",function(){return this._emissionColor.elements[2]},function(value){this._emissionColor.elements[2]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"_EmissionColorA",function(){return this._emissionColor.elements[3]},function(value){this._emissionColor.elements[3]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"_Cutoff",function(){return this.alphaTestValue},function(value){this.alphaTestValue=value}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(PBRSpecularMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"albedoColorR",function(){return this._ColorR},function(value){this._ColorR=value}),__getset(0,__proto,"albedoColorG",function(){return this._ColorG},function(value){this._ColorG=value}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"albedoColor",function(){return this._albedoColor},function(value){this._albedoColor=value,this._shaderValues.setVector(PBRSpecularMaterial.ALBEDOCOLOR,value)}),__getset(0,__proto,"albedoTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.ALBEDOTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.ALBEDOTEXTURE,value)}),__getset(0,__proto,"parallaxTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.PARALLAXTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.PARALLAXTEXTURE,value)}),__getset(0,__proto,"normalTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.NORMALTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.NORMALTEXTURE,value)}),__getset(0,__proto,"emissionColor",function(){return this._shaderValues.getVector(PBRSpecularMaterial.EMISSIONCOLOR)},function(value){this._shaderValues.setVector(PBRSpecularMaterial.EMISSIONCOLOR,value)}),__getset(0,__proto,"parallaxTextureScale",function(){return this._Parallax},function(value){this._Parallax=Math.max(.005,Math.min(.08,value))}),__getset(0,__proto,"normalTextureScale",function(){return this._BumpScale},function(value){this._BumpScale=value}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"occlusionTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.OCCLUSIONTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.OCCLUSIONTEXTURE,value)}),__getset(0,__proto,"occlusionTextureStrength",function(){return this._OcclusionStrength},function(value){this._OcclusionStrength=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"specularTexture",function(){return this._shaderValues.getTexture(PBRSpecularMaterial.SPECULARTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE),this._shaderValues.setTexture(PBRSpecularMaterial.SPECULARTEXTURE,value)}),__getset(0,__proto,"specularColorR",function(){return this._SpecColorR},function(value){this._SpecColorR=value}),__getset(0,__proto,"smoothness",function(){return this._Glossiness},function(value){this._Glossiness=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"specularColorG",function(){return this._SpecColorG},function(value){this._SpecColorG=value}),__getset(0,__proto,"specularColorB",function(){return this._SpecColorB},function(value){this._SpecColorB=value}),__getset(0,__proto,"specularColorA",function(){return this._SpecColorA},function(value){this._SpecColorA=value}),__getset(0,__proto,"smoothnessTextureScale",function(){return this._GlossMapScale},function(value){this._GlossMapScale=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"smoothnessSource",function(){return this._shaderValues.getInt(PBRSpecularMaterial.SMOOTHNESSSOURCE)},function(value){value?(this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(PBRSpecularMaterial.SMOOTHNESSSOURCE,1)):(this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(PBRSpecularMaterial.SMOOTHNESSSOURCE,0))}),__getset(0,__proto,"enableEmission",function(){return this._shaderValues.getBool(PBRSpecularMaterial.ENABLEEMISSION)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION),this._shaderValues.setBool(PBRSpecularMaterial.ENABLEEMISSION,value)}),__getset(0,__proto,"enableReflection",function(){return this._shaderValues.getBool(PBRSpecularMaterial.ENABLEREFLECT)},function(value){this._shaderValues.setBool(PBRSpecularMaterial.ENABLEREFLECT,!0),value?this._disablePublicDefineDatas.remove(Scene3D.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_REFLECTMAP)}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),PBRSpecularMaterial.__init__=function(){PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("ALBEDOTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("SPECULARTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=PBRSpecularMaterial.shaderDefines.registerDefine("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("NORMALTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("PARALLAXTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_EMISSION=PBRSpecularMaterial.shaderDefines.registerDefine("EMISSION"),PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE=PBRSpecularMaterial.shaderDefines.registerDefine("EMISSIONTEXTURE"),PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET=PBRSpecularMaterial.shaderDefines.registerDefine("TILINGOFFSET"),PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY=PBRSpecularMaterial.shaderDefines.registerDefine("ALPHAPREMULTIPLY")},PBRSpecularMaterial.SmoothnessSource_SpecularTexture_Alpha=0,PBRSpecularMaterial.SmoothnessSource_AlbedoTexture_Alpha=1,PBRSpecularMaterial.RENDERMODE_OPAQUE=0,PBRSpecularMaterial.RENDERMODE_CUTOUT=1,PBRSpecularMaterial.RENDERMODE_FADE=2,PBRSpecularMaterial.RENDERMODE_TRANSPARENT=3,PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=0,PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_EMISSION=0,PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE=0,PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET=0,PBRSpecularMaterial.SHADERDEFINE_ALPHAPREMULTIPLY=0,PBRSpecularMaterial.SMOOTHNESSSOURCE=-1,PBRSpecularMaterial.ENABLEEMISSION=-1,PBRSpecularMaterial.ENABLEREFLECT=-1,__static(PBRSpecularMaterial,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Shader3D.propertyNameToID("u_AlbedoTexture")},"SPECULARTEXTURE",function(){return this.SPECULARTEXTURE=Shader3D.propertyNameToID("u_SpecularTexture")},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Shader3D.propertyNameToID("u_NormalTexture")},"PARALLAXTEXTURE",function(){return this.PARALLAXTEXTURE=Shader3D.propertyNameToID("u_ParallaxTexture")},"OCCLUSIONTEXTURE",function(){return this.OCCLUSIONTEXTURE=Shader3D.propertyNameToID("u_OcclusionTexture")},"EMISSIONTEXTURE",function(){return this.EMISSIONTEXTURE=Shader3D.propertyNameToID("u_EmissionTexture")},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Shader3D.propertyNameToID("u_AlbedoColor")},"SPECULARCOLOR",function(){return this.SPECULARCOLOR=Shader3D.propertyNameToID("u_SpecularColor")},"EMISSIONCOLOR",function(){return this.EMISSIONCOLOR=Shader3D.propertyNameToID("u_EmissionColor")},"SMOOTHNESS",function(){return this.SMOOTHNESS=Shader3D.propertyNameToID("u_smoothness")},"SMOOTHNESSSCALE",function(){return this.SMOOTHNESSSCALE=Shader3D.propertyNameToID("u_smoothnessScale")},"OCCLUSIONSTRENGTH",function(){return this.OCCLUSIONSTRENGTH=Shader3D.propertyNameToID("u_occlusionStrength")},"NORMALSCALE",function(){return this.NORMALSCALE=Shader3D.propertyNameToID("u_normalScale")},"PARALLAXSCALE",function(){return this.PARALLAXSCALE=Shader3D.propertyNameToID("u_parallaxScale")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"defaultMaterial",function(){return this.defaultMaterial=new PBRSpecularMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),PBRSpecularMaterial}(BaseMaterial),UnlitMaterial=function(_super){function UnlitMaterial(){this._albedoIntensity=1,this._enableVertexColor=!1,this._albedoColor=new Vector4(1,1,1,1),UnlitMaterial.__super.call(this),this.setShaderName("Unlit"),this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,new Vector4(1,1,1,1))}__class(UnlitMaterial,"laya.d3.core.material.UnlitMaterial",BaseMaterial);var __proto=UnlitMaterial.prototype;return __getset(0,__proto,"_ColorB",function(){return this._albedoColor.elements[2]},function(value){this._albedoColor.elements[2]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorR",function(){return this._albedoColor.elements[0]},function(value){this._albedoColor.elements[0]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"albedoColorA",function(){return this._ColorA},function(value){this._ColorA=value}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"_ColorG",function(){return this._albedoColor.elements[1]},function(value){this._albedoColor.elements[1]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorA",function(){return this._albedoColor.elements[3]},function(value){this._albedoColor.elements[3]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_AlbedoIntensity",function(){return this._albedoIntensity},function(value){if(this._albedoIntensity!==value){var finalAlbedo=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);Vector4.scale(this._albedoColor,value,finalAlbedo),this._albedoIntensity=value,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,finalAlbedo)}}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"_Cutoff",function(){return this.alphaTestValue},function(value){this.alphaTestValue=value}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"albedoColorR",function(){return this._ColorR},function(value){this._ColorR=value}),__getset(0,__proto,"albedoColorG",function(){return this._ColorG},function(value){this._ColorG=value}),__getset(0,__proto,"albedoColorB",function(){return this._ColorB},function(value){this._ColorB=value}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"albedoColor",function(){return this._albedoColor},function(value){var finalAlbedo=this._shaderValues.getVector(UnlitMaterial.ALBEDOCOLOR);Vector4.scale(value,this._albedoIntensity,finalAlbedo),this._albedoColor=value,this._shaderValues.setVector(UnlitMaterial.ALBEDOCOLOR,finalAlbedo)}),__getset(0,__proto,"albedoIntensity",function(){return this._albedoIntensity},function(value){this._AlbedoIntensity=value}),__getset(0,__proto,"enableVertexColor",function(){return this._enableVertexColor},function(value){this._enableVertexColor=value,value?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR)}),__getset(0,__proto,"albedoTexture",function(){return this._shaderValues.getTexture(UnlitMaterial.ALBEDOTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(UnlitMaterial.ALBEDOTEXTURE,value)}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(UnlitMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(UnlitMaterial.TILINGOFFSET,value)}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 0:this.alphaTest=!1,this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 1:this.renderQueue=2450,this.alphaTest=!0,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 2:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513;break;default:throw new Error("UnlitMaterial : renderMode value error.")}}),UnlitMaterial.__init__=function(){UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE=UnlitMaterial.shaderDefines.registerDefine("ALBEDOTEXTURE"),UnlitMaterial.SHADERDEFINE_TILINGOFFSET=UnlitMaterial.shaderDefines.registerDefine("TILINGOFFSET"),UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=UnlitMaterial.shaderDefines.registerDefine("ENABLEVERTEXCOLOR")},UnlitMaterial.RENDERMODE_OPAQUE=0,UnlitMaterial.RENDERMODE_CUTOUT=1,UnlitMaterial.RENDERMODE_TRANSPARENT=2,UnlitMaterial.RENDERMODE_ADDTIVE=3,UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE=0,UnlitMaterial.SHADERDEFINE_TILINGOFFSET=0,UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR=0,__static(UnlitMaterial,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Shader3D.propertyNameToID("u_AlbedoTexture")},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Shader3D.propertyNameToID("u_AlbedoColor")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"defaultMaterial",function(){return this.defaultMaterial=new UnlitMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),UnlitMaterial}(),PixelLineMaterial=function(_super){function PixelLineMaterial(){PixelLineMaterial.__super.call(this),this.setShaderName("LineShader"),this._shaderValues.setVector(PixelLineMaterial.COLOR,new Vector4(1,1,1,1))}__class(PixelLineMaterial,"laya.d3.core.pixelLine.PixelLineMaterial",BaseMaterial);var __proto=PixelLineMaterial.prototype;return __getset(0,__proto,"color",function(){return this._shaderValues.getVector(PixelLineMaterial.COLOR)},function(value){this._shaderValues.setVector(PixelLineMaterial.COLOR,value)}),PixelLineMaterial.__init__=function(){},__static(PixelLineMaterial,["COLOR",function(){return this.COLOR=Shader3D.propertyNameToID("u_Color")},"defaultMaterial",function(){return this.defaultMaterial=new PixelLineMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),PixelLineMaterial}(),TrailMaterial=function(_super){function TrailMaterial(){this._color=null,TrailMaterial.__super.call(this),this.setShaderName("Trail"),this._color=new Vector4(1,1,1,1),this._shaderValues.setVector(TrailMaterial.TINTCOLOR,new Vector4(1,1,1,1)),this.renderMode=0}__class(TrailMaterial,"laya.d3.core.trail.TrailMaterial",BaseMaterial);var __proto=TrailMaterial.prototype;return __getset(0,__proto,"_TintColorB",function(){return this._color.elements[2]},function(value){this._color.elements[2]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"texture",function(){return this._shaderValues.getTexture(TrailMaterial.MAINTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(TrailMaterial.MAINTEXTURE,value)}),__getset(0,__proto,"_TintColorR",function(){return this._color.elements[0]},function(value){this._color.elements[0]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"_TintColorG",function(){return this._color.elements[1]},function(value){this._color.elements[1]=value,this.color=this._color}),__getset(0,__proto,"_TintColorA",function(){return this._color.elements[3]},function(value){this._color.elements[3]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 1:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=1,renderState.depthTest=513,this._defineDatas.add(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;case 0:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.remove(TrailMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.")}}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(TrailMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"colorR",function(){return this._TintColorR},function(value){this._TintColorR=value}),__getset(0,__proto,"colorG",function(){return this._TintColorG},function(value){this._TintColorG=value}),__getset(0,__proto,"colorB",function(){return this._TintColorB},function(value){this._TintColorB=value}),__getset(0,__proto,"colorA",function(){return this._TintColorA},function(value){this._TintColorA=value}),__getset(0,__proto,"color",function(){return this._shaderValues.getVector(TrailMaterial.TINTCOLOR)},function(value){this._shaderValues.setVector(TrailMaterial.TINTCOLOR,value)}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(TrailMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(TrailMaterial.TILINGOFFSET,value)}),TrailMaterial.__init__=function(){TrailMaterial.SHADERDEFINE_MAINTEXTURE=TrailMaterial.shaderDefines.registerDefine("MAINTEXTURE"),TrailMaterial.SHADERDEFINE_TILINGOFFSET=TrailMaterial.shaderDefines.registerDefine("TILINGOFFSET"),TrailMaterial.SHADERDEFINE_ADDTIVEFOG=TrailMaterial.shaderDefines.registerDefine("ADDTIVEFOG")},TrailMaterial.RENDERMODE_ALPHABLENDED=0,TrailMaterial.RENDERMODE_ADDTIVE=1,TrailMaterial.SHADERDEFINE_MAINTEXTURE=0,TrailMaterial.SHADERDEFINE_TILINGOFFSET=0,TrailMaterial.SHADERDEFINE_ADDTIVEFOG=0,__static(TrailMaterial,["defaultMaterial",function(){return this.defaultMaterial=new TrailMaterial},"MAINTEXTURE",function(){return this.MAINTEXTURE=Shader3D.propertyNameToID("u_MainTexture")},"TINTCOLOR",function(){return this.TINTCOLOR=Shader3D.propertyNameToID("u_MainColor")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),TrailMaterial}(),BaseCamera=function(_super){function BaseCamera(nearPlane,farPlane){BaseCamera.__super.call(this),this._skyRenderer=new SkyRenderer,void 0===nearPlane&&(nearPlane=.3),void 0===farPlane&&(farPlane=1e3),this._shaderValues=new ShaderData(null),this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=nearPlane,this._farPlane=farPlane,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),Laya.stage.on("resize",this,this._onScreenSizeChanged)}__class(BaseCamera,"laya.d3.core.BaseCamera",_super);var __proto=BaseCamera.prototype;return __proto._sortCamerasByRenderingOrder=function(){if(this.displayedInStage)for(var cameraPool=this.scene._cameraPool,n=cameraPool.length-1,i=0;i<n;i++)if(cameraPool[i].renderingOrder>cameraPool[n].renderingOrder){var tempCamera=cameraPool[i];cameraPool[i]=cameraPool[n],cameraPool[n]=tempCamera}},__proto._calculateProjectionMatrix=function(){},__proto._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},__proto._prepareCameraToRender=function(){var cameraSV=this._shaderValues;cameraSV.setVector(laya.d3.core.BaseCamera.CAMERAPOS,this.transform.position),cameraSV.setVector(laya.d3.core.BaseCamera.CAMERADIRECTION,this.transform.forward),cameraSV.setVector(laya.d3.core.BaseCamera.CAMERAUP,this.transform.up)},__proto._prepareCameraViewProject=function(vieMat,proMat,vieProNoTraSca){var cameraSV=this._shaderValues;cameraSV.setMatrix4x4(laya.d3.core.BaseCamera.VIEWMATRIX,vieMat),cameraSV.setMatrix4x4(laya.d3.core.BaseCamera.PROJECTMATRIX,proMat),this.transform.worldMatrix.cloneTo(BaseCamera._tempMatrix4x40),BaseCamera._tempMatrix4x40.transpose(),Matrix4x4.multiply(proMat,BaseCamera._tempMatrix4x40,vieProNoTraSca),cameraSV.setMatrix4x4(laya.d3.core.BaseCamera.VPMATRIX_NO_TRANSLATE,vieProNoTraSca)},__proto.render=function(shader,replacementTag){},__proto.addLayer=function(layer){this.cullingMask|=Math.pow(2,layer)},__proto.removeLayer=function(layer){this.cullingMask&=~Math.pow(2,layer)},__proto.addAllLayers=function(){this.cullingMask=2147483647},__proto.removeAllLayers=function(){this.cullingMask=0},__proto.resetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},__proto._onActive=function(){this._scene._addCamera(this)},__proto._onInActive=function(){this._scene._removeCamera(this)},__proto._parse=function(data){_super.prototype._parse.call(this,data);var clearFlagData=data.clearFlag;void 0!==clearFlagData&&(this.clearFlag=clearFlagData),this.orthographic=data.orthographic,this.fieldOfView=data.fieldOfView,this.nearPlane=data.nearPlane,this.farPlane=data.farPlane;var color=data.clearColor;this.clearColor=new Vector4(color[0],color[1],color[2],color[3]);var skyboxMaterial=data.skyboxMaterial;skyboxMaterial&&(this._skyRenderer.material=Loader.getRes(skyboxMaterial.path))},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.renderTarget=null,this._skyRenderer.destroy(),this._skyRenderer=null,Laya.stage.off("resize",this,this._onScreenSizeChanged),_super.prototype.destroy.call(this,destroyChild)},__getset(0,__proto,"renderingOrder",function(){return this._renderingOrder},function(value){this._renderingOrder=value,this._sortCamerasByRenderingOrder()}),__getset(0,__proto,"skyRenderer",function(){return this._skyRenderer}),__getset(0,__proto,"farPlane",function(){return this._farPlane},function(vaule){this._farPlane=vaule,this._calculateProjectionMatrix()}),__getset(0,__proto,"renderTarget",function(){return this._renderTarget},function(value){this._renderTarget!==value&&(this._renderTarget=value,this._calculateProjectionMatrix())}),__getset(0,__proto,"orthographic",function(){return this._orthographic},function(vaule){this._orthographic=vaule,this._calculateProjectionMatrix()}),__getset(0,__proto,"fieldOfView",function(){return this._fieldOfView},function(value){this._fieldOfView=value,this._calculateProjectionMatrix()}),__getset(0,__proto,"nearPlane",function(){return this._nearPlane},function(value){this._nearPlane=value,this._calculateProjectionMatrix()}),__getset(0,__proto,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(vaule){this._orthographicVerticalSize=vaule,this._calculateProjectionMatrix()}),BaseCamera.VPMATRIX=3,BaseCamera.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",BaseCamera.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",BaseCamera.CLEARFLAG_SOLIDCOLOR=0,BaseCamera.CLEARFLAG_SKY=1,BaseCamera.CLEARFLAG_DEPTHONLY=2,BaseCamera.CLEARFLAG_NONE=3,__static(BaseCamera,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Matrix4x4},"CAMERAPOS",function(){return this.CAMERAPOS=Shader3D.propertyNameToID("u_CameraPos")},"VIEWMATRIX",function(){return this.VIEWMATRIX=Shader3D.propertyNameToID("u_View")},"PROJECTMATRIX",function(){return this.PROJECTMATRIX=Shader3D.propertyNameToID("u_Projection")},"VPMATRIX_NO_TRANSLATE",function(){return this.VPMATRIX_NO_TRANSLATE=Shader3D.propertyNameToID("u_MvpMatrix")},"CAMERADIRECTION",function(){return this.CAMERADIRECTION=Shader3D.propertyNameToID("u_CameraDirection")},"CAMERAUP",function(){return this.CAMERAUP=Shader3D.propertyNameToID("u_CameraUp")},"_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new Matrix4x4(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new Matrix4x4},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new Matrix4x4}]),BaseCamera}(Sprite3D),TerrainMaterial=function(_super){function TerrainMaterial(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,TerrainMaterial.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new Vector2,this._diffuseScale2=new Vector2,this._diffuseScale3=new Vector2,this._diffuseScale4=new Vector2,this.ambientColor=new Vector3(.6,.6,.6),this.diffuseColor=new Vector3(1,1,1),this.specularColor=new Vector4(.2,.2,.2,32)}__class(TerrainMaterial,"laya.d3.core.material.TerrainMaterial",_super);var __proto=TerrainMaterial.prototype;return __proto.setDiffuseScale1=function(x,y){this._diffuseScale1.x=x,this._diffuseScale1.y=y,this._shaderValues.setVector(6,this._diffuseScale1)},__proto.setDiffuseScale2=function(x,y){this._diffuseScale2.x=x,this._diffuseScale2.y=y,this._shaderValues.setVector(7,this._diffuseScale2)},__proto.setDiffuseScale3=function(x,y){this._diffuseScale3.x=x,this._diffuseScale3.y=y,this._shaderValues.setVector(8,this._diffuseScale3)},__proto.setDiffuseScale4=function(x,y){this._diffuseScale4.x=x,this._diffuseScale4.y=y,this._shaderValues.setVector(9,this._diffuseScale4)},__proto.setDetailNum=function(value){switch(value){case 1:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},__proto.disableLight=function(){this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_POINTLIGHT|Scene3D.SHADERDEFINE_SPOTLIGHT|Scene3D.SHADERDEFINE_DIRECTIONLIGHT)},__proto.setShaderName=function(name){_super.prototype.setShaderName.call(this,name)},__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 1:this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 2:this.renderQueue=2e3,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}}),__getset(0,__proto,"diffuseTexture2",function(){return this._shaderValues.getTexture(3)},function(value){this._shaderValues.setTexture(3,value)}),__getset(0,__proto,"ambientColor",function(){return this._shaderValues.getVector(10)},function(value){this._shaderValues.setVector(10,value)}),__getset(0,__proto,"diffuseTexture4",function(){return this._shaderValues.getTexture(5)},function(value){this._shaderValues.setTexture(5,value)}),__getset(0,__proto,"diffuseColor",function(){return this._shaderValues.getVector(11)},function(value){this._shaderValues.setVector(11,value)}),__getset(0,__proto,"diffuseTexture1",function(){return this._shaderValues.getTexture(2)},function(value){this._shaderValues.setTexture(2,value)}),__getset(0,__proto,"specularColor",function(){return this._shaderValues.getVector(12)},function(value){this._shaderValues.setVector(12,value)}),__getset(0,__proto,"diffuseTexture3",function(){return this._shaderValues.getTexture(4)},function(value){this._shaderValues.setTexture(4,value)}),__getset(0,__proto,"splatAlphaTexture",function(){return this._shaderValues.getTexture(0)},function(value){this._shaderValues.setTexture(0,value)}),__getset(0,__proto,"normalTexture",function(){return this._shaderValues.getTexture(1)},function(value){this._shaderValues.setTexture(1,value)}),TerrainMaterial.__init__=function(){TerrainMaterial.SHADERDEFINE_DETAIL_NUM1=TerrainMaterial.shaderDefines.registerDefine("DETAIL_NUM1"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM2=TerrainMaterial.shaderDefines.registerDefine("DETAIL_NUM2"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM4=TerrainMaterial.shaderDefines.registerDefine("DETAIL_NUM4"),TerrainMaterial.SHADERDEFINE_DETAIL_NUM3=TerrainMaterial.shaderDefines.registerDefine("DETAIL_NUM3")},TerrainMaterial.RENDERMODE_OPAQUE=1,TerrainMaterial.RENDERMODE_TRANSPARENT=2,TerrainMaterial.SPLATALPHATEXTURE=0,TerrainMaterial.NORMALTEXTURE=1,TerrainMaterial.DIFFUSETEXTURE1=2,TerrainMaterial.DIFFUSETEXTURE2=3,TerrainMaterial.DIFFUSETEXTURE3=4,TerrainMaterial.DIFFUSETEXTURE4=5,TerrainMaterial.DIFFUSESCALE1=6,TerrainMaterial.DIFFUSESCALE2=7,TerrainMaterial.DIFFUSESCALE3=8,TerrainMaterial.DIFFUSESCALE4=9,TerrainMaterial.MATERIALAMBIENT=10,TerrainMaterial.MATERIALDIFFUSE=11,TerrainMaterial.MATERIALSPECULAR=12,TerrainMaterial.SHADERDEFINE_DETAIL_NUM1=0,TerrainMaterial.SHADERDEFINE_DETAIL_NUM2=0,TerrainMaterial.SHADERDEFINE_DETAIL_NUM3=0,TerrainMaterial.SHADERDEFINE_DETAIL_NUM4=0,__static(TerrainMaterial,["defaultMaterial",function(){return this.defaultMaterial=new TerrainMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),TerrainMaterial}(BaseMaterial),EffectMaterial=function(_super){function EffectMaterial(){this._color=null,EffectMaterial.__super.call(this),this.setShaderName("Effect"),this._color=new Vector4(1,1,1,1),this._shaderValues.setVector(EffectMaterial.TINTCOLOR,new Vector4(1,1,1,1))}__class(EffectMaterial,"laya.d3.core.material.EffectMaterial",BaseMaterial);var __proto=EffectMaterial.prototype;return __getset(0,__proto,"_TintColorB",function(){return this._color.elements[2]},function(value){this._color.elements[2]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"texture",function(){return this._shaderValues.getTexture(EffectMaterial.MAINTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.EffectMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.material.EffectMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(EffectMaterial.MAINTEXTURE,value)}),__getset(0,__proto,"_TintColorR",function(){return this._color.elements[0]},function(value){this._color.elements[0]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"_TintColorG",function(){return this._color.elements[1]},function(value){this._color.elements[1]=value,this.color=this._color}),__getset(0,__proto,"_TintColorA",function(){return this._color.elements[3]},function(value){this._color.elements[3]=value,this.color=this._color}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 0:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=1,renderState.depthTest=513,this._defineDatas.add(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=0,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.remove(EffectMaterial.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.")}}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(EffectMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"colorR",function(){return this._TintColorR},function(value){this._TintColorR=value}),__getset(0,__proto,"colorG",function(){return this._TintColorG},function(value){this._TintColorG=value}),__getset(0,__proto,"colorB",function(){return this._TintColorB},function(value){this._TintColorB=value}),__getset(0,__proto,"colorA",function(){return this._TintColorA},function(value){this._TintColorA=value}),__getset(0,__proto,"color",function(){return this._shaderValues.getVector(EffectMaterial.TINTCOLOR)},function(value){this._shaderValues.setVector(EffectMaterial.TINTCOLOR,value)}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(EffectMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.material.EffectMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.EffectMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.material.EffectMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(EffectMaterial.TILINGOFFSET,value)}),EffectMaterial.__init__=function(){EffectMaterial.SHADERDEFINE_MAINTEXTURE=EffectMaterial.shaderDefines.registerDefine("MAINTEXTURE"),EffectMaterial.SHADERDEFINE_TILINGOFFSET=EffectMaterial.shaderDefines.registerDefine("TILINGOFFSET"),EffectMaterial.SHADERDEFINE_ADDTIVEFOG=EffectMaterial.shaderDefines.registerDefine("ADDTIVEFOG")},EffectMaterial.RENDERMODE_ADDTIVE=0,EffectMaterial.RENDERMODE_ALPHABLENDED=1,EffectMaterial.SHADERDEFINE_MAINTEXTURE=0,EffectMaterial.SHADERDEFINE_TILINGOFFSET=0,EffectMaterial.SHADERDEFINE_ADDTIVEFOG=0,__static(EffectMaterial,["defaultMaterial",function(){return this.defaultMaterial=new EffectMaterial},"MAINTEXTURE",function(){return this.MAINTEXTURE=Shader3D.propertyNameToID("u_AlbedoTexture")},"TINTCOLOR",function(){return this.TINTCOLOR=Shader3D.propertyNameToID("u_AlbedoColor")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),EffectMaterial}(),WaterPrimaryMaterial=function(_super){function WaterPrimaryMaterial(){WaterPrimaryMaterial.__super.call(this),this.setShaderName("WaterPrimary"),this._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,new Vector4(.172,.463,.435,0)),this._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,.15),this._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,new Vector4(19,9,-16,-7))}__class(WaterPrimaryMaterial,"laya.d3.core.material.WaterPrimaryMaterial",BaseMaterial);var __proto=WaterPrimaryMaterial.prototype;return __getset(0,__proto,"waveSpeed",function(){return this._shaderValues.getVector(WaterPrimaryMaterial.WAVESPEED)},function(value){this._shaderValues.setVector(WaterPrimaryMaterial.WAVESPEED,value)}),__getset(0,__proto,"horizonColor",function(){return this._shaderValues.getVector(WaterPrimaryMaterial.HORIZONCOLOR)},function(value){this._shaderValues.setVector(WaterPrimaryMaterial.HORIZONCOLOR,value)}),__getset(0,__proto,"mainTexture",function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.MAINTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.MAINTEXTURE,value)}),__getset(0,__proto,"normalTexture",function(){return this._shaderValues.getTexture(WaterPrimaryMaterial.NORMALTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(WaterPrimaryMaterial.NORMALTEXTURE,value)}),__getset(0,__proto,"waveScale",function(){return this._shaderValues.getNumber(WaterPrimaryMaterial.WAVESCALE)},function(value){this._shaderValues.setNumber(WaterPrimaryMaterial.WAVESCALE,value)}),WaterPrimaryMaterial.__init__=function(){WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE=WaterPrimaryMaterial.shaderDefines.registerDefine("MAINTEXTURE"),WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE=WaterPrimaryMaterial.shaderDefines.registerDefine("NORMALTEXTURE")},WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE=0,WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE=0,__static(WaterPrimaryMaterial,["HORIZONCOLOR",function(){return this.HORIZONCOLOR=Shader3D.propertyNameToID("u_HorizonColor")},"MAINTEXTURE",function(){return this.MAINTEXTURE=Shader3D.propertyNameToID("u_MainTexture")},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Shader3D.propertyNameToID("u_NormalTexture")},"WAVESCALE",function(){return this.WAVESCALE=Shader3D.propertyNameToID("u_WaveScale")},"WAVESPEED",function(){return this.WAVESPEED=Shader3D.propertyNameToID("u_WaveSpeed")},"defaultMaterial",function(){return this.defaultMaterial=new WaterPrimaryMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),WaterPrimaryMaterial}(),ExtendTerrainMaterial=function(_super){function ExtendTerrainMaterial(){this._enableLighting=!0,ExtendTerrainMaterial.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}__class(ExtendTerrainMaterial,"laya.d3.core.material.ExtendTerrainMaterial",BaseMaterial);var __proto=ExtendTerrainMaterial.prototype;return __proto._setDetailNum=function(value){switch(value){case 1:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},__getset(0,__proto,"diffuseScaleOffset2",null,function(scaleOffset2){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET2,scaleOffset2)}),__getset(0,__proto,"splatAlphaTexture",function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE)},function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.SPLATALPHATEXTURE,value)}),__getset(0,__proto,"diffuseScaleOffset3",null,function(scaleOffset3){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET3,scaleOffset3)}),__getset(0,__proto,"diffuseTexture1",null,function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE1,value),this._setDetailNum(1)}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 1:this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513;break;case 2:this.renderQueue=2e3,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}}),__getset(0,__proto,"diffuseTexture2",function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2)},function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE2,value),this._setDetailNum(2)}),__getset(0,__proto,"diffuseScaleOffset1",null,function(scaleOffset1){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET1,scaleOffset1)}),__getset(0,__proto,"diffuseTexture3",function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3)},function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE3,value),this._setDetailNum(3)}),__getset(0,__proto,"diffuseTexture4",function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4)},function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE4,value),this._setDetailNum(4)}),__getset(0,__proto,"diffuseTexture5",function(){return this._shaderValues.getTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5)},function(value){this._shaderValues.setTexture(ExtendTerrainMaterial.DIFFUSETEXTURE5,value),this._setDetailNum(5)}),__getset(0,__proto,"diffuseScaleOffset4",null,function(scaleOffset4){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET4,scaleOffset4)}),__getset(0,__proto,"diffuseScaleOffset5",null,function(scaleOffset5){this._shaderValues.setVector(ExtendTerrainMaterial.DIFFUSESCALEOFFSET5,scaleOffset5)}),__getset(0,__proto,"enableLighting",function(){return this._enableLighting},function(value){this._enableLighting!==value&&(value?this._disablePublicDefineDatas.remove(Scene3D.SHADERDEFINE_POINTLIGHT|Scene3D.SHADERDEFINE_SPOTLIGHT|Scene3D.SHADERDEFINE_DIRECTIONLIGHT):this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_POINTLIGHT|Scene3D.SHADERDEFINE_SPOTLIGHT|Scene3D.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=value)}),ExtendTerrainMaterial.__init__=function(){ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1=ExtendTerrainMaterial.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM1"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2=ExtendTerrainMaterial.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM2"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3=ExtendTerrainMaterial.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM3"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4=ExtendTerrainMaterial.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM4"),ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5=ExtendTerrainMaterial.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM5")},ExtendTerrainMaterial.RENDERMODE_OPAQUE=1,ExtendTerrainMaterial.RENDERMODE_TRANSPARENT=2,ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1=0,ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2=0,ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3=0,ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4=0,ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5=0,__static(ExtendTerrainMaterial,["SPLATALPHATEXTURE",function(){return this.SPLATALPHATEXTURE=Shader3D.propertyNameToID("u_SplatAlphaTexture")},"DIFFUSETEXTURE1",function(){return this.DIFFUSETEXTURE1=Shader3D.propertyNameToID("u_DiffuseTexture1")},"DIFFUSETEXTURE2",function(){return this.DIFFUSETEXTURE2=Shader3D.propertyNameToID("u_DiffuseTexture2")},"DIFFUSETEXTURE3",function(){return this.DIFFUSETEXTURE3=Shader3D.propertyNameToID("u_DiffuseTexture3")},"DIFFUSETEXTURE4",function(){return this.DIFFUSETEXTURE4=Shader3D.propertyNameToID("u_DiffuseTexture4")},"DIFFUSETEXTURE5",function(){return this.DIFFUSETEXTURE5=Shader3D.propertyNameToID("u_DiffuseTexture5")},"DIFFUSESCALEOFFSET1",function(){return this.DIFFUSESCALEOFFSET1=Shader3D.propertyNameToID("u_DiffuseScaleOffset1")},"DIFFUSESCALEOFFSET2",function(){return this.DIFFUSESCALEOFFSET2=Shader3D.propertyNameToID("u_DiffuseScaleOffset2")},"DIFFUSESCALEOFFSET3",function(){return this.DIFFUSESCALEOFFSET3=Shader3D.propertyNameToID("u_DiffuseScaleOffset3")},"DIFFUSESCALEOFFSET4",function(){return this.DIFFUSESCALEOFFSET4=Shader3D.propertyNameToID("u_DiffuseScaleOffset4")},"DIFFUSESCALEOFFSET5",function(){return this.DIFFUSESCALEOFFSET5=Shader3D.propertyNameToID("u_DiffuseScaleOffset5")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),ExtendTerrainMaterial}(),PBRStandardMaterial=function(_super){function PBRStandardMaterial(){this._albedoColor=null,this._emissionColor=null,PBRStandardMaterial.__super.call(this),this.setShaderName("PBRStandard"),this._albedoColor=new Vector4(1,1,1,1),this._shaderValues.setVector(PBRStandardMaterial.ALBEDOCOLOR,new Vector4(1,1,1,1)),this._emissionColor=new Vector4(0,0,0,0),this._shaderValues.setVector(PBRStandardMaterial.EMISSIONCOLOR,new Vector4(0,0,0,0)),this._shaderValues.setNumber(PBRStandardMaterial.METALLIC,0),this._shaderValues.setNumber(PBRStandardMaterial.SMOOTHNESS,.5),this._shaderValues.setNumber(PBRStandardMaterial.SMOOTHNESSSCALE,1),this._shaderValues.setNumber(PBRStandardMaterial.SMOOTHNESSSOURCE,0),this._shaderValues.setNumber(PBRStandardMaterial.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(PBRStandardMaterial.NORMALSCALE,1),this._shaderValues.setNumber(PBRStandardMaterial.PARALLAXSCALE,.001),this._shaderValues.setBool(PBRStandardMaterial.ENABLEEMISSION,!1),this._shaderValues.setBool(PBRStandardMaterial.ENABLEREFLECT,!0),this._shaderValues.setNumber(BaseMaterial.ALPHATESTVALUE,.5),this._disablePublicDefineDatas.remove(Scene3D.SHADERDEFINE_REFLECTMAP)}__class(PBRStandardMaterial,"laya.d3.core.material.PBRStandardMaterial",_super);var __proto=PBRStandardMaterial.prototype;return __proto.cloneTo=function(destObject){_super.prototype.cloneTo.call(this,destObject);var destMaterial=destObject;this._albedoColor.cloneTo(destMaterial._albedoColor),this._emissionColor.cloneTo(destMaterial._emissionColor)},__getset(0,__proto,"_Parallax",function(){return this._shaderValues.getNumber(PBRStandardMaterial.PARALLAXSCALE)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.PARALLAXSCALE,value)}),__getset(0,__proto,"_ColorB",function(){return this._albedoColor.elements[2]},function(value){this._albedoColor.elements[2]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorR",function(){return this._albedoColor.elements[0]},function(value){this._albedoColor.elements[0]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"_ColorG",function(){return this._albedoColor.elements[1]},function(value){this._albedoColor.elements[1]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"metallic",function(){return this._Metallic},function(value){this._Metallic=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"_GlossMapScale",function(){return this._shaderValues.getNumber(PBRStandardMaterial.SMOOTHNESSSCALE)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.SMOOTHNESSSCALE,value)}),__getset(0,__proto,"_Glossiness",function(){return this._shaderValues.getNumber(PBRStandardMaterial.SMOOTHNESS)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.SMOOTHNESS,value)}),__getset(0,__proto,"_ColorA",function(){return this._albedoColor.elements[3]},function(value){this._albedoColor.elements[3]=value,this.albedoColor=this._albedoColor}),__getset(0,__proto,"enableReflection",function(){return this._shaderValues.getBool(PBRStandardMaterial.ENABLEREFLECT)},function(value){this._shaderValues.setBool(PBRStandardMaterial.ENABLEREFLECT,!0),value?this._disablePublicDefineDatas.remove(Scene3D.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(Scene3D.SHADERDEFINE_REFLECTMAP)}),__getset(0,__proto,"_Metallic",function(){return this._shaderValues.getNumber(PBRStandardMaterial.METALLIC)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.METALLIC,value)}),__getset(0,__proto,"_BumpScale",function(){return this._shaderValues.getNumber(PBRStandardMaterial.NORMALSCALE)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.NORMALSCALE,value)}),__getset(0,__proto,"_OcclusionStrength",function(){return this._shaderValues.getNumber(PBRStandardMaterial.OCCLUSIONSTRENGTH)},function(value){this._shaderValues.setNumber(PBRStandardMaterial.OCCLUSIONSTRENGTH,value)}),__getset(0,__proto,"_EmissionColorR",function(){return this._emissionColor.elements[0]},function(value){this._emissionColor.elements[0]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"tilingOffset",function(){return this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET)},function(value){if(value){var valueE=value.elements;1!=valueE[0]||1!=valueE[1]||0!=valueE[2]||0!=valueE[3]?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET);this._shaderValues.setVector(PBRStandardMaterial.TILINGOFFSET,value)}),__getset(0,__proto,"_EmissionColorG",function(){return this._emissionColor.elements[1]},function(value){this._emissionColor.elements[1]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"tilingOffsetW",function(){return this._MainTex_STW},function(w){this._MainTex_STW=w}),__getset(0,__proto,"_EmissionColorB",function(){return this._emissionColor.elements[2]},function(value){this._emissionColor.elements[2]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"_EmissionColorA",function(){return this._emissionColor.elements[3]},function(value){this._emissionColor.elements[3]=value,this.emissionColor=this._emissionColor}),__getset(0,__proto,"albedoColorA",function(){return this._ColorA},function(value){this._ColorA=value}),__getset(0,__proto,"_MainTex_STX",function(){return this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET).elements[0]},function(x){var tilOff=this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET);tilOff.elements[0]=x,this.tilingOffset=tilOff}),__getset(0,__proto,"_MainTex_STY",function(){return this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET).elements[1]},function(y){var tilOff=this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET);tilOff.elements[1]=y,this.tilingOffset=tilOff}),__getset(0,__proto,"_MainTex_STZ",function(){return this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET).elements[2]},function(z){var tilOff=this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET);tilOff.elements[2]=z,this.tilingOffset=tilOff}),__getset(0,__proto,"_Cutoff",function(){return this.alphaTestValue},function(value){this.alphaTestValue=value}),__getset(0,__proto,"_MainTex_STW",function(){return this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET).elements[3]},function(w){var tilOff=this._shaderValues.getVector(PBRStandardMaterial.TILINGOFFSET);tilOff.elements[3]=w,this.tilingOffset=tilOff}),__getset(0,__proto,"albedoColorR",function(){return this._ColorR},function(value){this._ColorR=value}),__getset(0,__proto,"albedoColorG",function(){return this._ColorG},function(value){this._ColorG=value}),__getset(0,__proto,"albedoColorB",function(){return this._ColorB},function(value){this._ColorB=value}),__getset(0,__proto,"tilingOffsetX",function(){return this._MainTex_STX},function(x){this._MainTex_STX=x}),__getset(0,__proto,"albedoColor",function(){return this._albedoColor},function(value){this._albedoColor=value,this._shaderValues.setVector(PBRStandardMaterial.ALBEDOCOLOR,value)}),__getset(0,__proto,"albedoTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.ALBEDOTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.ALBEDOTEXTURE,value)}),__getset(0,__proto,"parallaxTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.PARALLAXTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.PARALLAXTEXTURE,value)}),__getset(0,__proto,"normalTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.NORMALTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.NORMALTEXTURE,value)}),__getset(0,__proto,"emissionColor",function(){return this._shaderValues.getVector(PBRStandardMaterial.EMISSIONCOLOR)},function(value){this._shaderValues.setVector(PBRStandardMaterial.EMISSIONCOLOR,value)}),__getset(0,__proto,"parallaxTextureScale",function(){return this._Parallax},function(value){this._Parallax=Math.max(.005,Math.min(.08,value))}),__getset(0,__proto,"normalTextureScale",function(){return this._BumpScale},function(value){this._BumpScale=value}),__getset(0,__proto,"tilingOffsetZ",function(){return this._MainTex_STZ},function(z){this._MainTex_STZ=z}),__getset(0,__proto,"occlusionTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.OCCLUSIONTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.OCCLUSIONTEXTURE,value)}),__getset(0,__proto,"occlusionTextureStrength",function(){return this._OcclusionStrength},function(value){this._OcclusionStrength=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"enableEmission",function(){return this._shaderValues.getBool(PBRStandardMaterial.ENABLEEMISSION)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._shaderValues.setBool(PBRStandardMaterial.ENABLEEMISSION,value)}),__getset(0,__proto,"metallicGlossTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.METALLICGLOSSTEXTURE,value)}),__getset(0,__proto,"emissionColorA",function(){return this._EmissionColorA},function(value){this._EmissionColorA=value}),__getset(0,__proto,"smoothness",function(){return this._Glossiness},function(value){this._Glossiness=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"smoothnessTextureScale",function(){return this._GlossMapScale},function(value){this._GlossMapScale=Math.max(0,Math.min(1,value))}),__getset(0,__proto,"smoothnessSource",function(){return this._shaderValues.getInt(PBRStandardMaterial.SMOOTHNESSSOURCE)},function(value){value?(this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(PBRStandardMaterial.SMOOTHNESSSOURCE,1)):(this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(PBRStandardMaterial.SMOOTHNESSSOURCE,0))}),__getset(0,__proto,"emissionColorR",function(){return this._EmissionColorR},function(value){this._EmissionColorR=value}),__getset(0,__proto,"emissionColorG",function(){return this._EmissionColorG},function(value){this._EmissionColorG=value}),__getset(0,__proto,"emissionColorB",function(){return this._EmissionColorB},function(value){this._EmissionColorB=value}),__getset(0,__proto,"emissionTexture",function(){return this._shaderValues.getTexture(PBRStandardMaterial.EMISSIONTEXTURE)},function(value){value?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(PBRStandardMaterial.EMISSIONTEXTURE,value)}),__getset(0,__proto,"tilingOffsetY",function(){return this._MainTex_STY},function(y){this._MainTex_STY=y}),__getset(0,__proto,"renderMode",null,function(value){var renderState=this.getRenderState();switch(value){case 0:this.alphaTest=!1,this.renderQueue=2e3,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513,this._defineDatas.remove(PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 1:this.renderQueue=2450,this.alphaTest=!0,renderState.depthWrite=!0,renderState.cull=2,renderState.blend=0,renderState.depthTest=513,this._defineDatas.remove(PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 2:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=770,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.remove(PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 3:this.renderQueue=3e3,this.alphaTest=!1,renderState.depthWrite=!1,renderState.cull=2,renderState.blend=1,renderState.srcBlend=1,renderState.dstBlend=771,renderState.depthTest=513,this._defineDatas.add(PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.")}}),PBRStandardMaterial.__init__=function(){PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("ALBEDOTEXTURE"),PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("METALLICGLOSSTEXTURE"),PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=PBRStandardMaterial.shaderDefines.registerDefine("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("NORMALTEXTURE"),PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("PARALLAXTEXTURE"),PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_EMISSION=PBRStandardMaterial.shaderDefines.registerDefine("EMISSION"),PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE=PBRStandardMaterial.shaderDefines.registerDefine("EMISSIONTEXTURE"),PBRStandardMaterial.SHADERDEFINE_REFLECTMAP=PBRStandardMaterial.shaderDefines.registerDefine("REFLECTMAP"),PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET=PBRStandardMaterial.shaderDefines.registerDefine("TILINGOFFSET"),PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY=PBRStandardMaterial.shaderDefines.registerDefine("ALPHAPREMULTIPLY")},PBRStandardMaterial.SmoothnessSource_MetallicGlossTexture_Alpha=0,PBRStandardMaterial.SmoothnessSource_AlbedoTexture_Alpha=1,PBRStandardMaterial.RENDERMODE_OPAQUE=0,PBRStandardMaterial.RENDERMODE_CUTOUT=1,PBRStandardMaterial.RENDERMODE_FADE=2,PBRStandardMaterial.RENDERMODE_TRANSPARENT=3,PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=0,PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_EMISSION=0,PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE=0,PBRStandardMaterial.SHADERDEFINE_REFLECTMAP=0,PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET=0,PBRStandardMaterial.SHADERDEFINE_ALPHAPREMULTIPLY=0,PBRStandardMaterial.SMOOTHNESSSOURCE=-1,PBRStandardMaterial.ENABLEEMISSION=-1,PBRStandardMaterial.ENABLEREFLECT=-1,__static(PBRStandardMaterial,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Shader3D.propertyNameToID("u_AlbedoTexture")},"METALLICGLOSSTEXTURE",function(){return this.METALLICGLOSSTEXTURE=Shader3D.propertyNameToID("u_MetallicGlossTexture")},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Shader3D.propertyNameToID("u_NormalTexture")},"PARALLAXTEXTURE",function(){return this.PARALLAXTEXTURE=Shader3D.propertyNameToID("u_ParallaxTexture")},"OCCLUSIONTEXTURE",function(){return this.OCCLUSIONTEXTURE=Shader3D.propertyNameToID("u_OcclusionTexture")},"EMISSIONTEXTURE",function(){return this.EMISSIONTEXTURE=Shader3D.propertyNameToID("u_EmissionTexture")},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Shader3D.propertyNameToID("u_AlbedoColor")},"EMISSIONCOLOR",function(){return this.EMISSIONCOLOR=Shader3D.propertyNameToID("u_EmissionColor")},"METALLIC",function(){return this.METALLIC=Shader3D.propertyNameToID("u_metallic")},"SMOOTHNESS",function(){return this.SMOOTHNESS=Shader3D.propertyNameToID("u_smoothness")},"SMOOTHNESSSCALE",function(){return this.SMOOTHNESSSCALE=Shader3D.propertyNameToID("u_smoothnessScale")},"OCCLUSIONSTRENGTH",function(){return this.OCCLUSIONSTRENGTH=Shader3D.propertyNameToID("u_occlusionStrength")},"NORMALSCALE",function(){return this.NORMALSCALE=Shader3D.propertyNameToID("u_normalScale")},"PARALLAXSCALE",function(){return this.PARALLAXSCALE=Shader3D.propertyNameToID("u_parallaxScale")},"TILINGOFFSET",function(){return this.TILINGOFFSET=Shader3D.propertyNameToID("u_TilingOffset")},"defaultMaterial",function(){return this.defaultMaterial=new PBRStandardMaterial},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(BaseMaterial.shaderDefines)}]),PBRStandardMaterial}(BaseMaterial),SkinnedMeshRenderer=function(_super){function SkinnedMeshRenderer(owner){SkinnedMeshRenderer.__super.call(this,owner),this._skinnedDataLoopMarks=[],this._cacheAnimationNode=[],this._localBoundingBoxCorners=__newvec(8,null)}__class(SkinnedMeshRenderer,"laya.d3.core.SkinnedMeshRenderer",_super);var __proto=SkinnedMeshRenderer.prototype;return __proto._getCacheAnimationNodes=function(){var meshBoneNames=this._cacheMesh._boneNames,bindPoseIndices=this._cacheMesh._bindPoseIndices,innerBindPoseCount=bindPoseIndices.length;if(Render.isConchApp){this._cacheAnimationNodeIndices=new Uint16Array(innerBindPoseCount);var nodeMapC=this._cacheAnimator._avatarNodeMap;for(i=0;i<innerBindPoseCount;i++){var nodeC=nodeMapC[meshBoneNames[bindPoseIndices[i]]];this._cacheAnimationNodeIndices[i]=nodeC._worldMatrixIndex}}else{this._cacheAnimationNode.length=innerBindPoseCount;for(var nodeMap=this._cacheAnimator._avatarNodeMap,i=0;i<innerBindPoseCount;i++){var node=nodeMap[meshBoneNames[bindPoseIndices[i]]];this._cacheAnimationNode[i]=node}}},__proto._computeBoneIndexToMeshWithAsyncAvatar=function(){this._computeBoneIndexToMeshWithAsyncMesh()},__proto._computeBoneIndexToMeshWithAsyncMesh=function(){this._getCacheAnimationNodes()},__proto._computeSkinnedData=function(){if(this._cacheMesh&&this._cacheAvatar)for(var bindPoses=this._cacheMesh._inverseBindPoses,bindPoseInices=this._cacheMesh._bindPoseIndices,pathMarks=this._cacheMesh._skinDataPathMarks,i=0,n=this._cacheMesh.subMeshCount;i<n;i++){for(var subBoneIndices=this._cacheMesh._getSubMesh(i)._boneIndicesList,subData=this._skinnedData[i],j=0,m=subBoneIndices.length;j<m;j++){var boneIndices=subBoneIndices[j];Render.isConchApp?this._computeSubSkinnedDataNative(this._cacheAnimator._animationNodeWorldMatrixs,this._cacheAnimationNodeIndices,this._cacheMesh._inverseBindPosesBuffer,boneIndices,bindPoseInices,subData[j]):this._computeSubSkinnedData(bindPoses,boneIndices,bindPoseInices,subData[j],pathMarks)}this._renderElements[i].skinnedDatas=subData}},__proto._computeSubSkinnedData=function(bindPoses,boneIndices,bindPoseInices,data,pathMarks){for(var k=0,q=boneIndices.length;k<q;k++){var index=boneIndices[k];if(this._skinnedDataLoopMarks[index]===Stat.loopCount)for(var p=pathMarks[index],preData=this._skinnedData[p[0]][p[1]],srcIndex=16*p[2],dstIndex=16*k,d=0;d<16;d++)data[dstIndex+d]=preData[srcIndex+d];else Utils3D._mulMatrixArray(this._cacheAnimationNode[index].transform.getWorldMatrix(),bindPoses[bindPoseInices[index]],data,16*k),this._skinnedDataLoopMarks[index]=Stat.loopCount}},__proto._onMeshChange=function(value){_super.prototype._onMeshChange.call(this,value),this._cacheMesh=value;var subMeshCount=value.subMeshCount;this._skinnedData=__newvec(subMeshCount),this._skinnedDataLoopMarks.length=value._bindPoseIndices.length;for(var i=0;i<subMeshCount;i++)for(var subBoneIndices=value._getSubMesh(i)._boneIndicesList,subCount=subBoneIndices.length,subData=this._skinnedData[i]=__newvec(subCount),j=0;j<subCount;j++)subData[j]=new Float32Array(16*subBoneIndices[j].length);this._cacheAvatar&&value&&this._computeBoneIndexToMeshWithAsyncAvatar()},__proto._setCacheAnimator=function(animator){this._cacheAnimator=animator},__proto._setRootBone=function(name){this._rootBone=name},__proto._setCacheAvatar=function(value){this._cacheAvatar!==value&&(this._cacheMesh?(this._cacheAvatar=value,value&&(this._defineDatas.add(SkinnedMeshSprite3D.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=value)},__proto._calculateBoundingBox=function(){this._cacheAnimator?null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners):_super.prototype._calculateBoundingBox.call(this)},__proto._calculateBoundingSphere=function(){this._cacheAnimator?null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere):_super.prototype._calculateBoundingSphere.call(this)},__proto._updateOctreeNode=function(){var treeNode=this._treeNode;treeNode&&treeNode.updateObject(this)},__proto._renderUpdate=function(context,transform){if(this._cacheAnimator){this._computeSkinnedData();var aniOwnerTransParent=this._cacheAnimator.owner._transform._parent,worldMat=aniOwnerTransParent?aniOwnerTransParent.worldMatrix:Matrix4x4.DEFAULT;this._shaderValues.setMatrix4x4(Sprite3D.WORLDMATRIX,worldMat)}else this._shaderValues.setMatrix4x4(Sprite3D.WORLDMATRIX,transform.worldMatrix)},__proto._renderUpdateWithCamera=function(context,transform){var projectionView=context.projectionViewMatrix;if(this._cacheAnimator){var aniOwnerTransParent=this._cacheAnimator.owner._transform._parent,worldMat=aniOwnerTransParent?aniOwnerTransParent.worldMatrix:Matrix4x4.DEFAULT;Matrix4x4.multiply(projectionView,worldMat,this._projectionViewWorldMatrix)}else Matrix4x4.multiply(projectionView,transform.worldMatrix,this._projectionViewWorldMatrix);this._shaderValues.setMatrix4x4(Sprite3D.MVPMATRIX,this._projectionViewWorldMatrix),Laya3D.debugMode&&this._renderRenderableBoundBox()},__proto._computeSubSkinnedDataNative=function(worldMatrixs,cacheAnimationNodeIndices,inverseBindPosesBuffer,boneIndices,bindPoseInices,data){LayaGL.instance.computeSubSkinnedData(worldMatrixs,cacheAnimationNodeIndices,inverseBindPosesBuffer,boneIndices,bindPoseInices,data)},__getset(0,__proto,"localBoundBox",function(){return this._localBoundBox},function(value){this._localBoundBox=value,value.getCorners(this._localBoundingBoxCorners)}),__getset(0,__proto,"boundingBoxCenter",function(){var boundBox=this.boundingBox;return Vector3.add(boundBox.min,boundBox.max,this._boundingBoxCenter),Vector3.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),SkinnedMeshRenderer}(MeshRenderer),RenderTexture=(function(_super){function PhysicsCollider(collisionGroup,canCollideWith){void 0===collisionGroup&&(collisionGroup=1),void 0===canCollideWith&&(canCollideWith=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),PhysicsCollider.__super.call(this,collisionGroup,canCollideWith)}__class(PhysicsCollider,"laya.d3.physics.PhysicsCollider",_super);var __proto=PhysicsCollider.prototype;__proto._addToSimulation=function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith)},__proto._removeFromSimulation=function(){this._simulation._removePhysicsCollider(this)},__proto._parse=function(data){null!=data.friction&&(this.friction=data.friction),null!=data.rollingFriction&&(this.rollingFriction=data.rollingFriction),null!=data.restitution&&(this.restitution=data.restitution),null!=data.isTrigger&&(this.isTrigger=data.isTrigger),laya.d3.physics.PhysicsComponent.prototype._parse.call(this,data),this._parseShape(data.shapes)},__proto._onAdded=function(){var btColObj=new Laya3D._physics3D.btCollisionObject;btColObj.setUserIndex(this.id),btColObj.forceActivationState(5);var flags=btColObj.getCollisionFlags();this.owner.isStatic?((2&flags)>0&&(flags^=2),flags|=1):((1&flags)>0&&(flags^=1),flags|=2),btColObj.setCollisionFlags(flags),this._nativeColliderObject=btColObj,_super.prototype._onAdded.call(this)}}(PhysicsTriggerComponent),function(_super){function Rigidbody3D(collisionGroup,canCollideWith){this._isKinematic=!1,this._mass=1,this._angularDamping=0,this._linearDamping=0,this._overrideGravity=!1,this._detectCollisions=!0,this._gravity=new Vector3(0,-10,0),this._totalTorque=new Vector3(0,0,0),this._linearVelocity=new Vector3,this._angularVelocity=new Vector3,this._linearFactor=new Vector3(1,1,1),this._angularFactor=new Vector3(1,1,1),void 0===collisionGroup&&(collisionGroup=1),void 0===canCollideWith&&(canCollideWith=Physics3DUtils.COLLISIONFILTERGROUP_ALLFILTER),Rigidbody3D.__super.call(this,collisionGroup,canCollideWith)}__class(Rigidbody3D,"laya.d3.physics.Rigidbody3D",_super);var __proto=Rigidbody3D.prototype;__proto._updateMass=function(mass){this._nativeColliderObject&&this._colliderShape&&(this._colliderShape._nativeShape.calculateLocalInertia(mass,Rigidbody3D._nativeInertia),this._nativeColliderObject.setMassProps(mass,Rigidbody3D._nativeInertia),this._nativeColliderObject.updateInertiaTensor())},__proto._delegateMotionStateGetWorldTransform=function(worldTransPointer){},__proto._delegateMotionStateSetWorldTransform=function(worldTransPointer){var rigidBody=this._rigidbody;rigidBody._simulation._updatedRigidbodies++;var physics3D=Laya3D._physics3D,worldTrans=physics3D.wrapPointer(worldTransPointer,physics3D.btTransform);rigidBody._updateTransformComponent(worldTrans)},__proto._delegateMotionStateGetWorldTransformNative=function(ridgidBody3D,worldTransPointer){},__proto._delegateMotionStateSetWorldTransformNative=function(rigidBody3D,worldTransPointer){var rigidBody=rigidBody3D;rigidBody._simulation._updatedRigidbodies++;var physics3D=Laya3D._physics3D,worldTrans=physics3D.wrapPointer(worldTransPointer,physics3D.btTransform);rigidBody._updateTransformComponent(worldTrans)},__proto._onScaleChange=function(scale){laya.d3.physics.PhysicsComponent.prototype._onScaleChange.call(this,scale),this._updateMass(this._isKinematic?0:this._mass)},__proto._delegateMotionStateClear=function(){this._rigidbody=null},__proto._onAdded=function(){var physics3D=Laya3D._physics3D,motionState=new physics3D.LayaMotionState;null!=window.conch&&physics3D.LayaMotionState.prototype.setRigidbody?(motionState.setRigidbody(this),motionState.setNativeGetWorldTransform(this._delegateMotionStateGetWorldTransformNative),motionState.setNativeSetWorldTransform(this._delegateMotionStateSetWorldTransformNative)):(motionState.getWorldTransform=this._delegateMotionStateGetWorldTransform,motionState.setWorldTransform=this._delegateMotionStateSetWorldTransform),motionState.clear=this._delegateMotionStateClear,motionState._rigidbody=this,this._nativeMotionState=motionState;var constructInfo=new physics3D.btRigidBodyConstructionInfo(0,motionState,null,Rigidbody3D._nativeVector3Zero),btRigid=new physics3D.btRigidBody(constructInfo);btRigid.setUserIndex(this.id),this._nativeColliderObject=btRigid,_super.prototype._onAdded.call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,physics3D.destroy(constructInfo)},__proto._onShapeChange=function(colShape){laya.d3.physics.PhysicsComponent.prototype._onShapeChange.call(this,colShape),this._isKinematic?this._updateMass(0):(this._nativeColliderObject.setCenterOfMassTransform(this._nativeColliderObject.getWorldTransform()),this._updateMass(this._mass))},__proto._parse=function(data){null!=data.friction&&(this.friction=data.friction),null!=data.rollingFriction&&(this.rollingFriction=data.rollingFriction),null!=data.restitution&&(this.restitution=data.restitution),null!=data.isTrigger&&(this.isTrigger=data.isTrigger),null!=data.mass&&(this.mass=data.mass),null!=data.isKinematic&&(this.isKinematic=data.isKinematic),null!=data.linearDamping&&(this.linearDamping=data.linearDamping),null!=data.angularDamping&&(this.angularDamping=data.angularDamping),null!=data.overrideGravity&&(this.overrideGravity=data.overrideGravity),data.gravity&&(this.gravity.fromArray(data.gravity),this.gravity=this.gravity),laya.d3.physics.PhysicsComponent.prototype._parse.call(this,data),this._parseShape(data.shapes)},__proto._onDestroy=function(){var physics3D=Laya3D._physics3D;this._nativeMotionState.clear(),physics3D.destroy(this._nativeMotionState),laya.d3.physics.PhysicsComponent.prototype._onDestroy.call(this),this._nativeMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null},__proto._addToSimulation=function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0)},__proto._removeFromSimulation=function(){this._simulation._removeRigidBody(this)},__proto._cloneTo=function(dest){_super.prototype._cloneTo.call(this,dest);var destRigidbody3D=dest;destRigidbody3D.isKinematic=this._isKinematic,destRigidbody3D.mass=this._mass,destRigidbody3D.gravity=this._gravity,destRigidbody3D.angularDamping=this._angularDamping,destRigidbody3D.linearDamping=this._linearDamping,destRigidbody3D.overrideGravity=this._overrideGravity,destRigidbody3D.linearVelocity=this._linearVelocity,destRigidbody3D.angularVelocity=this._angularVelocity,destRigidbody3D.linearFactor=this._linearFactor,destRigidbody3D.angularFactor=this._angularFactor,destRigidbody3D.detectCollisions=this._detectCollisions},__proto.applyForce=function(force,localOffset){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var nativeForce=Rigidbody3D._nativeTempVector30,forceE=force.elements;if(nativeForce.setValue(-forceE[0],forceE[1],forceE[2]),localOffset){var localOffsetE=localOffset.elements,nativeOffset=Rigidbody3D._nativeTempVector31;nativeOffset.setValue(-localOffsetE[0],localOffsetE[1],localOffsetE[2]),this._nativeColliderObject.applyForce(nativeForce,nativeOffset)}else this._nativeColliderObject.applyCentralForce(nativeForce)},__proto.applyTorque=function(torque){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var nativeTorque=Rigidbody3D._nativeTempVector30,torqueE=torque.elements;nativeTorque.setValue(-torqueE[0],torqueE[1],torqueE[2]),this._nativeColliderObject.applyTorque(nativeTorque)},__proto.applyImpulse=function(impulse,localOffset){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var impulseE=impulse.elements;if(Rigidbody3D._nativeImpulse.setValue(-impulseE[0],impulseE[1],impulseE[2]),localOffset){var localOffsetE=localOffset.elements;Rigidbody3D._nativeImpulseOffset.setValue(-localOffsetE[0],localOffsetE[1],localOffsetE[2]),this._nativeColliderObject.applyImpulse(Rigidbody3D._nativeImpulse,Rigidbody3D._nativeImpulseOffset)}else this._nativeColliderObject.applyCentralImpulse(Rigidbody3D._nativeImpulse)},__proto.applyTorqueImpulse=function(torqueImpulse){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var nativeTorqueImpulse=Rigidbody3D._nativeTempVector30,torqueImpulseE=torqueImpulse.elements;nativeTorqueImpulse.setValue(-torqueImpulseE[0],torqueImpulseE[1],torqueImpulseE[2]),this._nativeColliderObject.applyTorqueImpulse(nativeTorqueImpulse)},__proto.wakeUp=function(){this._nativeColliderObject&&this._nativeColliderObject.activate(!1)},__proto.clearForces=function(){var rigidBody=this._nativeColliderObject;if(null==rigidBody)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";rigidBody.clearForces();var nativeZero=Rigidbody3D._nativeVector3Zero;rigidBody.setInterpolationAngularVelocity(nativeZero),rigidBody.setLinearVelocity(nativeZero),rigidBody.setInterpolationAngularVelocity(nativeZero),rigidBody.setAngularVelocity(nativeZero)},__getset(0,__proto,"angularDamping",function(){return this._angularDamping},function(value){this._angularDamping=value,this._nativeColliderObject&&this._nativeColliderObject.setDamping(this._linearDamping,value)}),__getset(0,__proto,"mass",function(){return this._mass},function(value){value=Math.max(value,1e-7),this._mass=value,this._isKinematic||this._updateMass(value)}),__getset(0,__proto,"linearDamping",function(){return this._linearDamping},function(value){this._linearDamping=value,this._nativeColliderObject&&this._nativeColliderObject.setDamping(value,this._angularDamping)}),__getset(0,__proto,"isKinematic",function(){return this._isKinematic},function(value){this._isKinematic=value;var canInSimulation=!!(this._simulation&&this._enabled&&this._colliderShape);canInSimulation&&this._removeFromSimulation();var natColObj=this._nativeColliderObject,flags=natColObj.getCollisionFlags();value?(flags|=2,natColObj.setCollisionFlags(flags),this._nativeColliderObject.forceActivationState(4),this._enableProcessCollisions=!1,this._updateMass(0)):((2&flags)>0&&(flags^=2),natColObj.setCollisionFlags(flags),this._nativeColliderObject.setActivationState(1),this._enableProcessCollisions=!0,this._updateMass(this._mass));var nativeZero=Rigidbody3D._nativeVector3Zero;natColObj.setInterpolationLinearVelocity(nativeZero),natColObj.setLinearVelocity(nativeZero),natColObj.setInterpolationAngularVelocity(nativeZero),natColObj.setAngularVelocity(nativeZero),canInSimulation&&this._addToSimulation()}),__getset(0,__proto,"gravity",function(){return this._gravity},function(value){this._gravity=value,Rigidbody3D._nativeGravity.setValue(-value.x,value.y,value.z),this._nativeColliderObject.setGravity(Rigidbody3D._nativeGravity)}),__getset(0,__proto,"overrideGravity",function(){return this._overrideGravity},function(value){if(this._overrideGravity=value,this._nativeColliderObject){var flag=this._nativeColliderObject.getFlags();value?0==(1&flag)&&this._nativeColliderObject.setFlags(1|flag):(1&flag)>0&&this._nativeColliderObject.setFlags(1^flag)}}),__getset(0,__proto,"totalForce",function(){return this._nativeColliderObject?this._nativeColliderObject.getTotalForce():null}),__getset(0,__proto,"linearVelocity",function(){return this._nativeColliderObject&&Utils3D._convertToLayaVec3(this._nativeColliderObject.getLinearVelocity(),this._linearVelocity,!0),this._linearVelocity},function(value){if(this._linearVelocity=value,this._nativeColliderObject){var nativeValue=Rigidbody3D._nativeTempVector30;Utils3D._convertToBulletVec3(value,nativeValue,!0),this.isSleeping&&this.wakeUp(),this._nativeColliderObject.setLinearVelocity(nativeValue)}}),__getset(0,__proto,"detectCollisions",function(){return this._detectCollisions},function(value){this._detectCollisions!==value&&(this._detectCollisions=value,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,value?this._canCollideWith:0)))}),__getset(0,__proto,"linearFactor",function(){return this._nativeColliderObject?this._linearFactor:null},function(value){if(this._linearFactor=value,this._nativeColliderObject){var nativeValue=Rigidbody3D._nativeTempVector30;Utils3D._convertToBulletVec3(value,nativeValue,!1),this._nativeColliderObject.setLinearFactor(nativeValue)}}),__getset(0,__proto,"angularFactor",function(){return this._nativeColliderObject?this._angularFactor:null},function(value){if(this._angularFactor=value,this._nativeColliderObject){var nativeValue=Rigidbody3D._nativeTempVector30;Utils3D._convertToBulletVec3(value,nativeValue,!1),this._nativeColliderObject.setAngularFactor(nativeValue)}}),__getset(0,__proto,"angularVelocity",function(){return this._nativeColliderObject&&Utils3D._convertToLayaVec3(this._nativeColliderObject.getAngularVelocity(),this._angularVelocity,!0),this._angularVelocity},function(value){if(this._angularVelocity=value,this._nativeColliderObject){var nativeValue=Rigidbody3D._nativeTempVector30;Utils3D._convertToBulletVec3(value,nativeValue,!0),this.isSleeping&&this.wakeUp(),this._nativeColliderObject.setAngularVelocity(nativeValue)}}),__getset(0,__proto,"totalTorque",function(){if(this._nativeColliderObject){var nativeTotalTorque=this._nativeColliderObject.getTotalTorque(),totalTorqueE=this._totalTorque.elements;totalTorqueE[0]=-nativeTotalTorque.x,totalTorqueE[1]=nativeTotalTorque.y,totalTorqueE[2]=nativeTotalTorque.z}return null}),__getset(0,__proto,"isSleeping",function(){return!!this._nativeColliderObject&&2===this._nativeColliderObject.getActivationState()}),__getset(0,__proto,"sleepLinearVelocity",function(){return this._nativeColliderObject.getLinearSleepingThreshold()},function(value){this._nativeColliderObject.setSleepingThresholds(value,this._nativeColliderObject.getAngularSleepingThreshold())}),__getset(0,__proto,"sleepAngularVelocity",function(){return this._nativeColliderObject.getAngularSleepingThreshold()},function(value){this._nativeColliderObject.setSleepingThresholds(this._nativeColliderObject.getLinearSleepingThreshold(),value)}),Rigidbody3D.TYPE_STATIC=0,Rigidbody3D.TYPE_DYNAMIC=1,Rigidbody3D.TYPE_KINEMATIC=2,Rigidbody3D._BT_DISABLE_WORLD_GRAVITY=1,Rigidbody3D._BT_ENABLE_GYROPSCOPIC_FORCE=2,__static(Rigidbody3D,["_nativeTempVector30",function(){return this._nativeTempVector30=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeTempVector31",function(){return this._nativeTempVector31=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeVector3Zero",function(){return this._nativeVector3Zero=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeInertia",function(){return this._nativeInertia=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeImpulse",function(){return this._nativeImpulse=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeImpulseOffset",function(){return this._nativeImpulseOffset=new Laya3D._physics3D.btVector3(0,0,0)},"_nativeGravity",function(){return this._nativeGravity=new Laya3D._physics3D.btVector3(0,0,0)}])}(PhysicsTriggerComponent),function(_super){function RenderTexture(width,height,format,depthStencilFormat){void 0===format&&(format=0),void 0===depthStencilFormat&&(depthStencilFormat=0),RenderTexture.__super.call(this,format,!1),this._glTextureType=3553,this._width=width,this._height=height,this._depthStencilFormat=depthStencilFormat,this._create(width,height)}__class(RenderTexture,"laya.d3.resource.RenderTexture",BaseTexture);var __proto=RenderTexture.prototype;return __proto._create=function(width,height){var gl=LayaGL.instance;this._frameBuffer=gl.createFramebuffer(),WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);var glFormat=this._getGLFormat();if(gl.texImage2D(this._glTextureType,0,glFormat,width,height,0,glFormat,5121,null),this._setGPUMemory(width*height*4),gl.bindFramebuffer(36160,this._frameBuffer),gl.framebufferTexture2D(36160,36064,3553,this._glTexture,0),3!==this._depthStencilFormat)switch(this._depthStencilBuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(36161,this._depthStencilBuffer),this._depthStencilFormat){case 0:gl.renderbufferStorage(36161,33189,width,height),gl.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 1:gl.renderbufferStorage(36161,36168,width,height),gl.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 2:gl.renderbufferStorage(36161,34041,width,height),gl.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format."}gl.bindFramebuffer(36160,null),gl.bindRenderbuffer(36161,null),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource()},__proto.generateMipmap=function(){this._isPot(this.width)&&this._isPot(this.height)?(this._mipmap=!0,LayaGL.instance.generateMipmap(this._glTextureType),this._setFilterMode(this._filterMode),this._setGPUMemory(this.width*this.height*4*(1+1/3))):(this._mipmap=!1,this._setGPUMemory(this.width*this.height*4*(1+1/3)))},__proto.start=function(){LayaGL.instance.bindFramebuffer(36160,this._frameBuffer),RenderTexture._currentActive=this,this._readyed=!1},__proto.end=function(){LayaGL.instance.bindFramebuffer(36160,null),RenderTexture._currentActive=null,this._readyed=!0},__proto.getData=function(x,y,width,height,out){var gl=LayaGL.instance;return gl.bindFramebuffer(36160,this._frameBuffer),36053===gl.checkFramebufferStatus(36160)?(gl.readPixels(x,y,width,height,6408,5121,out),gl.bindFramebuffer(36160,null),out):(gl.bindFramebuffer(36160,null),null)},__proto._disposeResource=function(){if(this._frameBuffer){var gl=LayaGL.instance;gl.deleteTexture(this._glTexture),gl.deleteFramebuffer(this._frameBuffer),gl.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0)}},__getset(0,__proto,"depthStencilFormat",function(){return this._depthStencilFormat}),__getset(0,__proto,"defaulteTexture",function(){return Texture2D.grayTexture}),__getset(1,RenderTexture,"currentActive",function(){return RenderTexture._currentActive},laya.webgl.resource.BaseTexture._$SET_currentActive),RenderTexture._currentActive=null,RenderTexture}()),TextureCube=function(_super){function TextureCube(format,mipmap){void 0===format&&(format=0),void 0===mipmap&&(mipmap=!1),TextureCube.__super.call(this,format,mipmap),this._glTextureType=34067}__class(TextureCube,"laya.d3.resource.TextureCube",BaseTexture);var __proto=TextureCube.prototype;return __proto.setSixSideImageSources=function(source,premultiplyAlpha){void 0===premultiplyAlpha&&(premultiplyAlpha=!1);for(var width=0,height=0,i=0;i<6;i++){var img=source[i];if(!img)return void console.log("TextureCube: image Source can't be null.");var nextWidth=img.width,nextHeight=img.height;if(i>0&&width!==nextWidth)return void console.log("TextureCube: each side image's width and height must same.");if((width=nextWidth)!==(height=nextHeight))return void console.log("TextureCube: each side image's width and height must same.")}this._width=width,this._height=height;var gl=LayaGL.instance;WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);var glFormat=this._getGLFormat();if(Render.isConchApp){if(1==premultiplyAlpha)for(var j=0;j<6;j++)source[j].setPremultiplyAlpha(premultiplyAlpha);gl.texImage2D(34073,0,6408,6408,5121,source[0]),gl.texImage2D(34074,0,6408,6408,5121,source[1]),gl.texImage2D(34069,0,6408,6408,5121,source[2]),gl.texImage2D(34070,0,6408,6408,5121,source[3]),gl.texImage2D(34071,0,6408,6408,5121,source[4]),gl.texImage2D(34072,0,6408,6408,5121,source[5])}else premultiplyAlpha&&gl.pixelStorei(37441,!0),gl.texImage2D(34073,0,glFormat,glFormat,5121,source[0]),gl.texImage2D(34074,0,glFormat,glFormat,5121,source[1]),gl.texImage2D(34069,0,glFormat,glFormat,5121,source[2]),gl.texImage2D(34070,0,glFormat,glFormat,5121,source[3]),gl.texImage2D(34071,0,glFormat,glFormat,5121,source[4]),gl.texImage2D(34072,0,glFormat,glFormat,5121,source[5]),premultiplyAlpha&&gl.pixelStorei(37441,!1);this._mipmap&&this._isPot(width)&&this._isPot(height)?(gl.generateMipmap(this._glTextureType),this._setGPUMemory(width*height*4*(1+1/3)*6)):this._setGPUMemory(width*height*4*6),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()},__proto.setSixSidePixels=function(width,height,pixels){if(width<=0||height<=0)throw new Error("TextureCube:width or height must large than 0.");if(!pixels)throw new Error("TextureCube:pixels can't be null.");this._width=width,this._height=height;var gl=LayaGL.instance;WebGLContext.bindTexture(gl,this._glTextureType,this._glTexture);var glFormat=this._getGLFormat();gl.texImage2D(34073,0,glFormat,width,height,0,glFormat,5121,pixels[0]),gl.texImage2D(34074,0,glFormat,width,height,0,glFormat,5121,pixels[1]),gl.texImage2D(34069,0,glFormat,width,height,0,glFormat,5121,pixels[2]),gl.texImage2D(34070,0,glFormat,width,height,0,glFormat,5121,pixels[3]),gl.texImage2D(34071,0,glFormat,width,height,0,glFormat,5121,pixels[4]),gl.texImage2D(34072,0,glFormat,width,height,0,glFormat,5121,pixels[5]),this._mipmap&&this._isPot(width)&&this._isPot(height)?(gl.generateMipmap(this._glTextureType),this._setGPUMemory(width*height*4*(1+1/3)*6)):this._setGPUMemory(width*height*4*6),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource()},__proto._recoverResource=function(){},__getset(0,__proto,"defaulteTexture",function(){return TextureCube.grayTexture}),TextureCube.__init__=function(){var pixels=new Uint8Array(3);pixels[0]=128,pixels[1]=128,pixels[2]=128,TextureCube.grayTexture=new TextureCube(0,!1),TextureCube.grayTexture.setSixSidePixels(1,1,[pixels,pixels,pixels,pixels,pixels,pixels]),TextureCube.grayTexture.lock=!0},TextureCube._parse=function(data,propertyParams,constructParams){var texture=constructParams?new TextureCube(constructParams[0],constructParams[1]):new TextureCube;return texture.setSixSideImageSources(data),texture},TextureCube.load=function(url,complete){Laya.loader.create(url,complete,null,"TEXTURECUBE")},TextureCube.grayTexture=null,TextureCube}(),TrailSprite3D=function(_super){function TrailSprite3D(){TrailSprite3D.__super.call(this,this.name),this._render=new TrailRenderer(this),this._geometryFilter=new TrailFilter(this)}__class(TrailSprite3D,"laya.d3.core.trail.TrailSprite3D",_super);var __proto=TrailSprite3D.prototype;return __proto._parse=function(data){laya.d3.core.Sprite3D.prototype._parse.call(this,data);var render=this._render,filter=this._geometryFilter,i=0,j=0,materials=data.materials;if(materials){var sharedMaterials=render.sharedMaterials,materialCount=materials.length;for(sharedMaterials.length=materialCount,i=0;i<materialCount;i++)sharedMaterials[i]=Loader.getRes(materials[i].path);render.sharedMaterials=sharedMaterials}filter.time=data.time,filter.minVertexDistance=data.minVertexDistance,filter.widthMultiplier=data.widthMultiplier,filter.textureMode=data.textureMode,null!=data.alignment&&(filter.alignment=data.alignment);var widthCurve=[],widthCurveData=data.widthCurve;for(i=0,j=widthCurveData.length;i<j;i++){var trailkeyframe=new FloatKeyframe;trailkeyframe.time=widthCurveData[i].time,trailkeyframe.inTangent=widthCurveData[i].inTangent,trailkeyframe.outTangent=widthCurveData[i].outTangent,trailkeyframe.value=widthCurveData[i].value,widthCurve.push(trailkeyframe)}filter.widthCurve=widthCurve;var colorGradientData=data.colorGradient,colorKeys=colorGradientData.colorKeys,alphaKeys=colorGradientData.alphaKeys,colorGradient=new Gradient(colorKeys.length,alphaKeys.length);for(colorGradient.mode=colorGradientData.mode,i=0,j=colorKeys.length;i<j;i++){var colorKey=colorKeys[i];colorGradient.addColorRGB(colorKey.time,new Color(colorKey.value[0],colorKey.value[1],colorKey.value[2],1))}for(i=0,j=alphaKeys.length;i<j;i++){var alphaKey=alphaKeys[i];colorGradient.addColorAlpha(alphaKey.time,alphaKey.value)}filter.colorGradient=colorGradient},__proto._onActive=function(){_super.prototype._onActive.call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition)},__proto.cloneTo=function(destObject){laya.d3.core.Sprite3D.prototype.cloneTo.call(this,destObject);var j,i=0,destTrailSprite3D=destObject,destTrailFilter=destTrailSprite3D.trailFilter;destTrailFilter.time=this.trailFilter.time,destTrailFilter.minVertexDistance=this.trailFilter.minVertexDistance,destTrailFilter.widthMultiplier=this.trailFilter.widthMultiplier,destTrailFilter.textureMode=this.trailFilter.textureMode;var widthCurveData=this.trailFilter.widthCurve,widthCurve=[];for(i=0,j=widthCurveData.length;i<j;i++){var keyFrame=new FloatKeyframe;widthCurveData[i].cloneTo(keyFrame),widthCurve.push(keyFrame)}destTrailFilter.widthCurve=widthCurve;var destColorGradient=new Gradient(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(destColorGradient),destTrailFilter.colorGradient=destColorGradient,destTrailSprite3D.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._geometryFilter.destroy(),this._geometryFilter=null)},__getset(0,__proto,"trailFilter",function(){return this._geometryFilter}),__getset(0,__proto,"trailRenderer",function(){return this._render}),TrailSprite3D.__init__=function(){TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND=TrailSprite3D.shaderDefines.registerDefine("GRADIENTMODE_BLEND")},TrailSprite3D.SHADERDEFINE_GRADIENTMODE_BLEND=0,__static(TrailSprite3D,["CURTIME",function(){return this.CURTIME=Shader3D.propertyNameToID("u_CurTime")},"LIFETIME",function(){return this.LIFETIME=Shader3D.propertyNameToID("u_LifeTime")},"WIDTHCURVE",function(){return this.WIDTHCURVE=Shader3D.propertyNameToID("u_WidthCurve")},"WIDTHCURVEKEYLENGTH",function(){return this.WIDTHCURVEKEYLENGTH=Shader3D.propertyNameToID("u_WidthCurveKeyLength")},"GRADIENTCOLORKEY",function(){return this.GRADIENTCOLORKEY=Shader3D.propertyNameToID("u_GradientColorkey")},"GRADIENTALPHAKEY",function(){return this.GRADIENTALPHAKEY=Shader3D.propertyNameToID("u_GradientAlphakey")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(RenderableSprite3D.shaderDefines)}]),TrailSprite3D}(RenderableSprite3D),PointLight=function(_super){function PointLight(){this._range=NaN,this._lightMatrix=new Matrix4x4,PointLight.__super.call(this),this._range=6}__class(PointLight,"laya.d3.core.light.PointLight",_super);var __proto=PointLight.prototype;return __proto._onActive=function(){_super.prototype._onActive.call(this),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.add(Scene3D.SHADERDEFINE_POINTLIGHT)},__proto._onInActive=function(){_super.prototype._onInActive.call(this),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.remove(Scene3D.SHADERDEFINE_POINTLIGHT)},__proto._prepareToScene=function(){var scene=this._scene;if(scene.enableLight&&this.activeInHierarchy){scene._defineDatas;var shaderValue=scene._shaderValues;Vector3.scale(this.color,this._intensity,this._intensityColor),shaderValue.setVector(Scene3D.POINTLIGHTCOLOR,this._intensityColor),shaderValue.setVector(Scene3D.POINTLIGHTPOS,this.transform.position),shaderValue.setNumber(Scene3D.POINTLIGHTRANGE,this.range);var lightMatrix=this._lightMatrix,lightMatrixE=lightMatrix.elements;lightMatrix.identity(),lightMatrixE[0]=lightMatrixE[5]=lightMatrixE[10]=1/this._range;var toLightMatrix=PointLight._tempMatrix0;return this.transform.worldMatrix.invert(toLightMatrix),Matrix4x4.multiply(lightMatrix,toLightMatrix,lightMatrix),shaderValue.setMatrix4x4(Scene3D.POINTLIGHTMATRIX,lightMatrix),!0}return!1},__proto._parse=function(data){_super.prototype._parse.call(this,data),this.range=data.range},__getset(0,__proto,"range",function(){return this._range},function(value){this._range=value}),__static(PointLight,["_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4}]),PointLight}(LightSprite),ShuriKenParticle3D=function(_super){function ShuriKenParticle3D(){ShuriKenParticle3D.__super.call(this,null),this._render=new ShurikenParticleRenderer(this),this._particleSystem=new ShurikenParticleSystem(this);var element=this._render._renderElements[0]=new RenderElement;element.setTransform(this._transform),element.render=this._render,element.setGeometry(this._particleSystem),element.material=ShurikenParticleMaterial.defaultMaterial}__class(ShuriKenParticle3D,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",_super);var __proto=ShuriKenParticle3D.prototype;return __proto._initParticleVelocity=function(gradientData){for(var gradient=new GradientDataNumber,velocitysData=gradientData.velocitys,i=0,n=velocitysData.length;i<n;i++){var valueData=velocitysData[i];gradient.add(valueData.key,valueData.value)}return gradient},__proto._initParticleColor=function(gradientColorData){var gradientColor=new Gradient(4,4),alphasData=gradientColorData.alphas,i=0,n=0;for(i=0,n=alphasData.length;i<n;i++){var alphaData=alphasData[i];3===i&&1!==alphaData.key&&(alphaData.key=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),gradientColor.addColorAlpha(alphaData.key,alphaData.value)}var rgbsData=gradientColorData.rgbs;for(i=0,n=rgbsData.length;i<n;i++){var rgbData=rgbsData[i],rgbValue=rgbData.value;3===i&&1!==rgbData.key&&(rgbData.key=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),gradientColor.addColorRGB(rgbData.key,new Color(rgbValue[0],rgbValue[1],rgbValue[2],1))}return gradientColor},__proto._initParticleSize=function(gradientSizeData){for(var gradientSize=new GradientDataNumber,sizesData=gradientSizeData.sizes,i=0,n=sizesData.length;i<n;i++){var valueData=sizesData[i];gradientSize.add(valueData.key,valueData.value)}return gradientSize},__proto._initParticleRotation=function(gradientData){for(var gradient=new GradientDataNumber,angularVelocitysData=gradientData.angularVelocitys,i=0,n=angularVelocitysData.length;i<n;i++){var valueData=angularVelocitysData[i];gradient.add(valueData.key,valueData.value/180*Math.PI)}return gradient},__proto._initParticleFrame=function(overTimeFramesData){for(var overTimeFrame=new GradientDataInt,framesData=overTimeFramesData.frames,i=0,n=framesData.length;i<n;i++){var frameData=framesData[i];overTimeFrame.add(frameData.key,frameData.value)}return overTimeFrame},__proto._parse=function(data){laya.d3.core.Sprite3D.prototype._parse.call(this,data);var material,anglelToRad=Math.PI/180,i=0,n=0,particleRender=this.particleRenderer,materialData=data.material;materialData&&(material=Loader.getRes(materialData.path)),particleRender.sharedMaterial=material;var meshPath=data.meshPath;meshPath&&(particleRender.mesh=Loader.getRes(meshPath)),particleRender.renderMode=data.renderMode,particleRender.stretchedBillboardCameraSpeedScale=data.stretchedBillboardCameraSpeedScale,particleRender.stretchedBillboardSpeedScale=data.stretchedBillboardSpeedScale,particleRender.stretchedBillboardLengthScale=data.stretchedBillboardLengthScale,particleRender.sortingFudge=data.sortingFudge?data.sortingFudge:0;var particleSystem=this.particleSystem;particleSystem.isPerformanceMode=data.isPerformanceMode,particleSystem.duration=data.duration,particleSystem.looping=data.looping,particleSystem.prewarm=data.prewarm,particleSystem.startDelayType=data.startDelayType,particleSystem.startDelay=data.startDelay,particleSystem.startDelayMin=data.startDelayMin,particleSystem.startDelayMax=data.startDelayMax,particleSystem.startLifetimeType=data.startLifetimeType,particleSystem.startLifetimeConstant=data.startLifetimeConstant,particleSystem.startLifeTimeGradient=ShuriKenParticle3D._initStartLife(data.startLifetimeGradient),particleSystem.startLifetimeConstantMin=data.startLifetimeConstantMin,particleSystem.startLifetimeConstantMax=data.startLifetimeConstantMax,particleSystem.startLifeTimeGradientMin=ShuriKenParticle3D._initStartLife(data.startLifetimeGradientMin),particleSystem.startLifeTimeGradientMax=ShuriKenParticle3D._initStartLife(data.startLifetimeGradientMax),particleSystem.startSpeedType=data.startSpeedType,particleSystem.startSpeedConstant=data.startSpeedConstant,particleSystem.startSpeedConstantMin=data.startSpeedConstantMin,particleSystem.startSpeedConstantMax=data.startSpeedConstantMax,particleSystem.threeDStartSize=data.threeDStartSize,particleSystem.startSizeType=data.startSizeType,particleSystem.startSizeConstant=data.startSizeConstant;var startSizeConstantSeparateArray=data.startSizeConstantSeparate,startSizeConstantSeparateElement=particleSystem.startSizeConstantSeparate.elements;startSizeConstantSeparateElement[0]=startSizeConstantSeparateArray[0],startSizeConstantSeparateElement[1]=startSizeConstantSeparateArray[1],startSizeConstantSeparateElement[2]=startSizeConstantSeparateArray[2],particleSystem.startSizeConstantMin=data.startSizeConstantMin,particleSystem.startSizeConstantMax=data.startSizeConstantMax;var startSizeConstantMinSeparateArray=data.startSizeConstantMinSeparate,startSizeConstantMinSeparateElement=particleSystem.startSizeConstantMinSeparate.elements;startSizeConstantMinSeparateElement[0]=startSizeConstantMinSeparateArray[0],startSizeConstantMinSeparateElement[1]=startSizeConstantMinSeparateArray[1],startSizeConstantMinSeparateElement[2]=startSizeConstantMinSeparateArray[2];var startSizeConstantMaxSeparateArray=data.startSizeConstantMaxSeparate,startSizeConstantMaxSeparateElement=particleSystem.startSizeConstantMaxSeparate.elements;startSizeConstantMaxSeparateElement[0]=startSizeConstantMaxSeparateArray[0],startSizeConstantMaxSeparateElement[1]=startSizeConstantMaxSeparateArray[1],startSizeConstantMaxSeparateElement[2]=startSizeConstantMaxSeparateArray[2],particleSystem.threeDStartRotation=data.threeDStartRotation,particleSystem.startRotationType=data.startRotationType,particleSystem.startRotationConstant=data.startRotationConstant*anglelToRad;var startRotationConstantSeparateArray=data.startRotationConstantSeparate,startRotationConstantSeparateElement=particleSystem.startRotationConstantSeparate.elements;startRotationConstantSeparateElement[0]=startRotationConstantSeparateArray[0]*anglelToRad,startRotationConstantSeparateElement[1]=startRotationConstantSeparateArray[1]*anglelToRad,startRotationConstantSeparateElement[2]=startRotationConstantSeparateArray[2]*anglelToRad,particleSystem.startRotationConstantMin=data.startRotationConstantMin*anglelToRad,particleSystem.startRotationConstantMax=data.startRotationConstantMax*anglelToRad;var startRotationConstantMinSeparateArray=data.startRotationConstantMinSeparate,startRotationConstantMinSeparateElement=particleSystem.startRotationConstantMinSeparate.elements;startRotationConstantMinSeparateElement[0]=startRotationConstantMinSeparateArray[0]*anglelToRad,startRotationConstantMinSeparateElement[1]=startRotationConstantMinSeparateArray[1]*anglelToRad,startRotationConstantMinSeparateElement[2]=startRotationConstantMinSeparateArray[2]*anglelToRad;var startRotationConstantMaxSeparateArray=data.startRotationConstantMaxSeparate,startRotationConstantMaxSeparateElement=particleSystem.startRotationConstantMaxSeparate.elements;startRotationConstantMaxSeparateElement[0]=startRotationConstantMaxSeparateArray[0]*anglelToRad,startRotationConstantMaxSeparateElement[1]=startRotationConstantMaxSeparateArray[1]*anglelToRad,startRotationConstantMaxSeparateElement[2]=startRotationConstantMaxSeparateArray[2]*anglelToRad,particleSystem.randomizeRotationDirection=data.randomizeRotationDirection,particleSystem.startColorType=data.startColorType;var startColorConstantArray=data.startColorConstant,startColorConstantElement=particleSystem.startColorConstant.elements;startColorConstantElement[0]=startColorConstantArray[0],startColorConstantElement[1]=startColorConstantArray[1],startColorConstantElement[2]=startColorConstantArray[2],startColorConstantElement[3]=startColorConstantArray[3];var startColorConstantMinArray=data.startColorConstantMin,startColorConstantMinElement=particleSystem.startColorConstantMin.elements;startColorConstantMinElement[0]=startColorConstantMinArray[0],startColorConstantMinElement[1]=startColorConstantMinArray[1],startColorConstantMinElement[2]=startColorConstantMinArray[2],startColorConstantMinElement[3]=startColorConstantMinArray[3];var startColorConstantMaxArray=data.startColorConstantMax,startColorConstantMaxElement=particleSystem.startColorConstantMax.elements;startColorConstantMaxElement[0]=startColorConstantMaxArray[0],startColorConstantMaxElement[1]=startColorConstantMaxArray[1],startColorConstantMaxElement[2]=startColorConstantMaxArray[2],startColorConstantMaxElement[3]=startColorConstantMaxArray[3],particleSystem.gravityModifier=data.gravityModifier,particleSystem.simulationSpace=data.simulationSpace,particleSystem.scaleMode=data.scaleMode,particleSystem.playOnAwake=data.playOnAwake,particleSystem.maxParticles=data.maxParticles;var autoRandomSeed=data.autoRandomSeed;null!=autoRandomSeed&&(particleSystem.autoRandomSeed=autoRandomSeed);var randomSeed=data.randomSeed;null!=randomSeed&&(particleSystem.randomSeed[0]=randomSeed);var emissionData=data.emission,emission=particleSystem.emission;if(emissionData){emission.emissionRate=emissionData.emissionRate;var burstsData=emissionData.bursts;if(burstsData)for(i=0,n=burstsData.length;i<n;i++){var brust=burstsData[i];emission.addBurst(new Burst(brust.time,brust.min,brust.max))}emission.enbale=emissionData.enable}else emission.enbale=!1;var shapeData=data.shape;if(shapeData){var shape;switch(shapeData.shapeType){case 0:var sphereShape;shape=sphereShape=new SphereShape,sphereShape.radius=shapeData.sphereRadius,sphereShape.emitFromShell=shapeData.sphereEmitFromShell,sphereShape.randomDirection=shapeData.sphereRandomDirection;break;case 1:var hemiSphereShape;shape=hemiSphereShape=new HemisphereShape,hemiSphereShape.radius=shapeData.hemiSphereRadius,hemiSphereShape.emitFromShell=shapeData.hemiSphereEmitFromShell,hemiSphereShape.randomDirection=shapeData.hemiSphereRandomDirection;break;case 2:var coneShape;shape=coneShape=new ConeShape,coneShape.angle=shapeData.coneAngle*anglelToRad,coneShape.radius=shapeData.coneRadius,coneShape.length=shapeData.coneLength,coneShape.emitType=shapeData.coneEmitType,coneShape.randomDirection=shapeData.coneRandomDirection;break;case 3:var boxShape;shape=boxShape=new BoxShape,boxShape.x=shapeData.boxX,boxShape.y=shapeData.boxY,boxShape.z=shapeData.boxZ,boxShape.randomDirection=shapeData.boxRandomDirection;break;case 7:var circleShape;shape=circleShape=new CircleShape,circleShape.radius=shapeData.circleRadius,circleShape.arc=shapeData.circleArc*anglelToRad,circleShape.emitFromEdge=shapeData.circleEmitFromEdge,circleShape.randomDirection=shapeData.circleRandomDirection;break;default:var tempShape;shape=tempShape=new CircleShape,tempShape.radius=shapeData.circleRadius,tempShape.arc=shapeData.circleArc*anglelToRad,tempShape.emitFromEdge=shapeData.circleEmitFromEdge,tempShape.randomDirection=shapeData.circleRandomDirection}shape.enable=shapeData.enable,particleSystem.shape=shape}var velocityOverLifetimeData=data.velocityOverLifetime;if(velocityOverLifetimeData){var velocity,velocityData=velocityOverLifetimeData.velocity;switch(velocityData.type){case 0:var constantData=velocityData.constant;velocity=GradientVelocity.createByConstant(new Vector3(constantData[0],constantData[1],constantData[2]));break;case 1:velocity=GradientVelocity.createByGradient(this._initParticleVelocity(velocityData.gradientX),this._initParticleVelocity(velocityData.gradientY),this._initParticleVelocity(velocityData.gradientZ));break;case 2:var constantMinData=velocityData.constantMin,constantMaxData=velocityData.constantMax;velocity=GradientVelocity.createByRandomTwoConstant(new Vector3(constantMinData[0],constantMinData[1],constantMinData[2]),new Vector3(constantMaxData[0],constantMaxData[1],constantMaxData[2]));break;case 3:velocity=GradientVelocity.createByRandomTwoGradient(this._initParticleVelocity(velocityData.gradientXMin),this._initParticleVelocity(velocityData.gradientXMax),this._initParticleVelocity(velocityData.gradientYMin),this._initParticleVelocity(velocityData.gradientYMax),this._initParticleVelocity(velocityData.gradientZMin),this._initParticleVelocity(velocityData.gradientZMax))}var velocityOverLifetime=new VelocityOverLifetime(velocity);velocityOverLifetime.space=velocityOverLifetimeData.space,velocityOverLifetime.enbale=velocityOverLifetimeData.enable,particleSystem.velocityOverLifetime=velocityOverLifetime}var colorOverLifetimeData=data.colorOverLifetime;if(colorOverLifetimeData){var color,colorData=colorOverLifetimeData.color;switch(colorData.type){case 0:var constColorData=colorData.constant;color=GradientColor.createByConstant(new Vector4(constColorData[0],constColorData[1],constColorData[2],constColorData[3]));break;case 1:color=GradientColor.createByGradient(this._initParticleColor(colorData.gradient));break;case 2:var minConstColorData=colorData.constantMin,maxConstColorData=colorData.constantMax;color=GradientColor.createByRandomTwoConstant(new Vector4(minConstColorData[0],minConstColorData[1],minConstColorData[2],minConstColorData[3]),new Vector4(maxConstColorData[0],maxConstColorData[1],maxConstColorData[2],maxConstColorData[3]));break;case 3:color=GradientColor.createByRandomTwoGradient(this._initParticleColor(colorData.gradientMin),this._initParticleColor(colorData.gradientMax))}var colorOverLifetime=new ColorOverLifetime(color);colorOverLifetime.enbale=colorOverLifetimeData.enable,particleSystem.colorOverLifetime=colorOverLifetime}var sizeOverLifetimeData=data.sizeOverLifetime;if(sizeOverLifetimeData){var size,sizeData=sizeOverLifetimeData.size;switch(sizeData.type){case 0:size=sizeData.separateAxes?GradientSize.createByGradientSeparate(this._initParticleSize(sizeData.gradientX),this._initParticleSize(sizeData.gradientY),this._initParticleSize(sizeData.gradientZ)):GradientSize.createByGradient(this._initParticleSize(sizeData.gradient));break;case 1:if(sizeData.separateAxes){var constantMinSeparateData=sizeData.constantMinSeparate,constantMaxSeparateData=sizeData.constantMaxSeparate;size=GradientSize.createByRandomTwoConstantSeparate(new Vector3(constantMinSeparateData[0],constantMinSeparateData[1],constantMinSeparateData[2]),new Vector3(constantMaxSeparateData[0],constantMaxSeparateData[1],constantMaxSeparateData[2]))}else size=GradientSize.createByRandomTwoConstant(sizeData.constantMin,sizeData.constantMax);break;case 2:size=sizeData.separateAxes?GradientSize.createByRandomTwoGradientSeparate(this._initParticleSize(sizeData.gradientXMin),this._initParticleSize(sizeData.gradientYMin),this._initParticleSize(sizeData.gradientZMin),this._initParticleSize(sizeData.gradientXMax),this._initParticleSize(sizeData.gradientYMax),this._initParticleSize(sizeData.gradientZMax)):GradientSize.createByRandomTwoGradient(this._initParticleSize(sizeData.gradientMin),this._initParticleSize(sizeData.gradientMax))}var sizeOverLifetime=new SizeOverLifetime(size);sizeOverLifetime.enbale=sizeOverLifetimeData.enable,particleSystem.sizeOverLifetime=sizeOverLifetime}var rotationOverLifetimeData=data.rotationOverLifetime;if(rotationOverLifetimeData){var angularVelocity,angularVelocityData=rotationOverLifetimeData.angularVelocity;switch(angularVelocityData.type){case 0:if(angularVelocityData.separateAxes){var conSep=angularVelocityData.constantSeparate;angularVelocity=GradientAngularVelocity.createByConstantSeparate(new Vector3(conSep[0]*anglelToRad,conSep[1]*anglelToRad,conSep[2]*anglelToRad))}else angularVelocity=GradientAngularVelocity.createByConstant(angularVelocityData.constant*anglelToRad);break;case 1:angularVelocity=angularVelocityData.separateAxes?GradientAngularVelocity.createByGradientSeparate(this._initParticleRotation(angularVelocityData.gradientX),this._initParticleRotation(angularVelocityData.gradientY),this._initParticleRotation(angularVelocityData.gradientZ)):GradientAngularVelocity.createByGradient(this._initParticleRotation(angularVelocityData.gradient));break;case 2:if(angularVelocityData.separateAxes){var minSep=angularVelocityData.constantMinSeparate,maxSep=angularVelocityData.constantMaxSeparate;angularVelocity=GradientAngularVelocity.createByRandomTwoConstantSeparate(new Vector3(minSep[0]*anglelToRad,minSep[1]*anglelToRad,minSep[2]*anglelToRad),new Vector3(maxSep[0]*anglelToRad,maxSep[1]*anglelToRad,maxSep[2]*anglelToRad))}else angularVelocity=GradientAngularVelocity.createByRandomTwoConstant(angularVelocityData.constantMin*anglelToRad,angularVelocityData.constantMax*anglelToRad);break;case 3:angularVelocityData.separateAxes||(angularVelocity=GradientAngularVelocity.createByRandomTwoGradient(this._initParticleRotation(angularVelocityData.gradientMin),this._initParticleRotation(angularVelocityData.gradientMax)))}var rotationOverLifetime=new RotationOverLifetime(angularVelocity);rotationOverLifetime.enbale=rotationOverLifetimeData.enable,particleSystem.rotationOverLifetime=rotationOverLifetime}var textureSheetAnimationData=data.textureSheetAnimation;if(textureSheetAnimationData){var frameOverTime,frameData=textureSheetAnimationData.frame;switch(frameData.type){case 0:frameOverTime=FrameOverTime.createByConstant(frameData.constant);break;case 1:frameOverTime=FrameOverTime.createByOverTime(this._initParticleFrame(frameData.overTime));break;case 2:frameOverTime=FrameOverTime.createByRandomTwoConstant(frameData.constantMin,frameData.constantMax);break;case 3:frameOverTime=FrameOverTime.createByRandomTwoOverTime(this._initParticleFrame(frameData.overTimeMin),this._initParticleFrame(frameData.overTimeMax))}var startFrame,startFrameData=textureSheetAnimationData.startFrame;switch(startFrameData.type){case 0:startFrame=StartFrame.createByConstant(startFrameData.constant);break;case 1:startFrame=StartFrame.createByRandomTwoConstant(startFrameData.constantMin,startFrameData.constantMax)}var textureSheetAnimation=new TextureSheetAnimation(frameOverTime,startFrame);textureSheetAnimation.enable=textureSheetAnimationData.enable;var tilesData=textureSheetAnimationData.tiles;textureSheetAnimation.tiles=new Vector2(tilesData[0],tilesData[1]),textureSheetAnimation.type=textureSheetAnimationData.type,textureSheetAnimation.randomRow=textureSheetAnimationData.randomRow;var rowIndex=textureSheetAnimationData.rowIndex;void 0!==rowIndex&&(textureSheetAnimation.rowIndex=rowIndex),textureSheetAnimation.cycles=textureSheetAnimationData.cycles,particleSystem.textureSheetAnimation=textureSheetAnimation}},__proto._activeHierarchy=function(activeChangeComponents){laya.display.Node.prototype._activeHierarchy.call(this,activeChangeComponents),this.particleSystem.playOnAwake&&this.particleSystem.play()},__proto._inActiveHierarchy=function(activeChangeComponents){laya.display.Node.prototype._inActiveHierarchy.call(this,activeChangeComponents),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},__proto.cloneTo=function(destObject){var destShuriKenParticle3D=destObject,destParticleSystem=destShuriKenParticle3D._particleSystem;this._particleSystem.cloneTo(destParticleSystem);var destParticleRender=destShuriKenParticle3D._render,particleRender=this._render;destParticleRender.sharedMaterials=particleRender.sharedMaterials,destParticleRender.enable=particleRender.enable,destParticleRender.renderMode=particleRender.renderMode,destParticleRender.mesh=particleRender.mesh,destParticleRender.stretchedBillboardCameraSpeedScale=particleRender.stretchedBillboardCameraSpeedScale,destParticleRender.stretchedBillboardSpeedScale=particleRender.stretchedBillboardSpeedScale,destParticleRender.stretchedBillboardLengthScale=particleRender.stretchedBillboardLengthScale,destParticleRender.sortingFudge=particleRender.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,destObject)},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._particleSystem.destroy(),this._particleSystem=null)},__getset(0,__proto,"particleSystem",function(){return this._particleSystem}),__getset(0,__proto,"particleRenderer",function(){return this._render}),ShuriKenParticle3D.__init__=function(){ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD=ShuriKenParticle3D.shaderDefines.registerDefine("SPHERHBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=ShuriKenParticle3D.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=ShuriKenParticle3D.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=ShuriKenParticle3D.shaderDefines.registerDefine("VERTICALBILLBOARD"),ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME=ShuriKenParticle3D.shaderDefines.registerDefine("COLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=ShuriKenParticle3D.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=ShuriKenParticle3D.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=ShuriKenParticle3D.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=ShuriKenParticle3D.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=ShuriKenParticle3D.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=ShuriKenParticle3D.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=ShuriKenParticle3D.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=ShuriKenParticle3D.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE=ShuriKenParticle3D.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=ShuriKenParticle3D.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=ShuriKenParticle3D.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=ShuriKenParticle3D.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH=ShuriKenParticle3D.shaderDefines.registerDefine("RENDERMODE_MESH"),ShuriKenParticle3D.SHADERDEFINE_SHAPE=ShuriKenParticle3D.shaderDefines.registerDefine("SHAPE")},ShuriKenParticle3D._initStartLife=function(gradientData){for(var gradient=new GradientDataNumber,startLifetimesData=gradientData.startLifetimes,i=0,n=startLifetimesData.length;i<n;i++){var valueData=startLifetimesData[i];gradient.add(valueData.key,valueData.value)}return gradient},ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_BILLBOARD=0,ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,ShuriKenParticle3D.SHADERDEFINE_COLOROVERLIFETIME=0,ShuriKenParticle3D.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,ShuriKenParticle3D.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,ShuriKenParticle3D.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIME=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,ShuriKenParticle3D.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,ShuriKenParticle3D.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,ShuriKenParticle3D.SHADERDEFINE_RENDERMODE_MESH=0,ShuriKenParticle3D.SHADERDEFINE_SHAPE=0,__static(ShuriKenParticle3D,["WORLDPOSITION",function(){return this.WORLDPOSITION=Shader3D.propertyNameToID("u_WorldPosition")},"WORLDROTATION",function(){return this.WORLDROTATION=Shader3D.propertyNameToID("u_WorldRotation")},"POSITIONSCALE",function(){return this.POSITIONSCALE=Shader3D.propertyNameToID("u_PositionScale")},"SIZESCALE",function(){return this.SIZESCALE=Shader3D.propertyNameToID("u_SizeScale")},"SCALINGMODE",function(){return this.SCALINGMODE=Shader3D.propertyNameToID("u_ScalingMode")},"GRAVITY",function(){return this.GRAVITY=Shader3D.propertyNameToID("u_Gravity")},"THREEDSTARTROTATION",function(){return this.THREEDSTARTROTATION=Shader3D.propertyNameToID("u_ThreeDStartRotation")},"STRETCHEDBILLBOARDLENGTHSCALE",function(){return this.STRETCHEDBILLBOARDLENGTHSCALE=Shader3D.propertyNameToID("u_StretchedBillboardLengthScale")},"STRETCHEDBILLBOARDSPEEDSCALE",function(){return this.STRETCHEDBILLBOARDSPEEDSCALE=Shader3D.propertyNameToID("u_StretchedBillboardSpeedScale")},"SIMULATIONSPACE",function(){return this.SIMULATIONSPACE=Shader3D.propertyNameToID("u_SimulationSpace")},"CURRENTTIME",function(){return this.CURRENTTIME=Shader3D.propertyNameToID("u_CurrentTime")},"VOLVELOCITYCONST",function(){return this.VOLVELOCITYCONST=Shader3D.propertyNameToID("u_VOLVelocityConst")},"VOLVELOCITYGRADIENTX",function(){return this.VOLVELOCITYGRADIENTX=Shader3D.propertyNameToID("u_VOLVelocityGradientX")},"VOLVELOCITYGRADIENTY",function(){return this.VOLVELOCITYGRADIENTY=Shader3D.propertyNameToID("u_VOLVelocityGradientY")},"VOLVELOCITYGRADIENTZ",function(){return this.VOLVELOCITYGRADIENTZ=Shader3D.propertyNameToID("u_VOLVelocityGradientZ")},"VOLVELOCITYCONSTMAX",function(){return this.VOLVELOCITYCONSTMAX=Shader3D.propertyNameToID("u_VOLVelocityConstMax")},"VOLVELOCITYGRADIENTXMAX",function(){return this.VOLVELOCITYGRADIENTXMAX=Shader3D.propertyNameToID("u_VOLVelocityGradientMaxX")},"VOLVELOCITYGRADIENTYMAX",function(){return this.VOLVELOCITYGRADIENTYMAX=Shader3D.propertyNameToID("u_VOLVelocityGradientMaxY")},"VOLVELOCITYGRADIENTZMAX",function(){return this.VOLVELOCITYGRADIENTZMAX=Shader3D.propertyNameToID("u_VOLVelocityGradientMaxZ")},"VOLSPACETYPE",function(){return this.VOLSPACETYPE=Shader3D.propertyNameToID("u_VOLSpaceType")},"COLOROVERLIFEGRADIENTALPHAS",function(){return this.COLOROVERLIFEGRADIENTALPHAS=Shader3D.propertyNameToID("u_ColorOverLifeGradientAlphas")},"COLOROVERLIFEGRADIENTCOLORS",function(){return this.COLOROVERLIFEGRADIENTCOLORS=Shader3D.propertyNameToID("u_ColorOverLifeGradientColors")},"MAXCOLOROVERLIFEGRADIENTALPHAS",function(){return this.MAXCOLOROVERLIFEGRADIENTALPHAS=Shader3D.propertyNameToID("u_MaxColorOverLifeGradientAlphas")},"MAXCOLOROVERLIFEGRADIENTCOLORS",function(){return this.MAXCOLOROVERLIFEGRADIENTCOLORS=Shader3D.propertyNameToID("u_MaxColorOverLifeGradientColors")},"SOLSIZEGRADIENT",function(){return this.SOLSIZEGRADIENT=Shader3D.propertyNameToID("u_SOLSizeGradient")},"SOLSIZEGRADIENTX",function(){return this.SOLSIZEGRADIENTX=Shader3D.propertyNameToID("u_SOLSizeGradientX")},"SOLSIZEGRADIENTY",function(){return this.SOLSIZEGRADIENTY=Shader3D.propertyNameToID("u_SOLSizeGradientY")},"SOLSizeGradientZ",function(){return this.SOLSizeGradientZ=Shader3D.propertyNameToID("u_SOLSizeGradientZ")},"SOLSizeGradientMax",function(){return this.SOLSizeGradientMax=Shader3D.propertyNameToID("u_SOLSizeGradientMax")},"SOLSIZEGRADIENTXMAX",function(){return this.SOLSIZEGRADIENTXMAX=Shader3D.propertyNameToID("u_SOLSizeGradientMaxX")},"SOLSIZEGRADIENTYMAX",function(){return this.SOLSIZEGRADIENTYMAX=Shader3D.propertyNameToID("u_SOLSizeGradientMaxY")},"SOLSizeGradientZMAX",function(){return this.SOLSizeGradientZMAX=Shader3D.propertyNameToID("u_SOLSizeGradientMaxZ")},"ROLANGULARVELOCITYCONST",function(){return this.ROLANGULARVELOCITYCONST=Shader3D.propertyNameToID("u_ROLAngularVelocityConst")},"ROLANGULARVELOCITYCONSTSEPRARATE",function(){return this.ROLANGULARVELOCITYCONSTSEPRARATE=Shader3D.propertyNameToID("u_ROLAngularVelocityConstSeprarate")},"ROLANGULARVELOCITYGRADIENT",function(){return this.ROLANGULARVELOCITYGRADIENT=Shader3D.propertyNameToID("u_ROLAngularVelocityGradient")},"ROLANGULARVELOCITYGRADIENTX",function(){return this.ROLANGULARVELOCITYGRADIENTX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientX")},"ROLANGULARVELOCITYGRADIENTY",function(){return this.ROLANGULARVELOCITYGRADIENTY=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientY")},"ROLANGULARVELOCITYGRADIENTZ",function(){return this.ROLANGULARVELOCITYGRADIENTZ=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientZ")},"ROLANGULARVELOCITYCONSTMAX",function(){return this.ROLANGULARVELOCITYCONSTMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityConstMax")},"ROLANGULARVELOCITYCONSTMAXSEPRARATE",function(){return this.ROLANGULARVELOCITYCONSTMAXSEPRARATE=Shader3D.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate")},"ROLANGULARVELOCITYGRADIENTMAX",function(){return this.ROLANGULARVELOCITYGRADIENTMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientMax")},"ROLANGULARVELOCITYGRADIENTXMAX",function(){return this.ROLANGULARVELOCITYGRADIENTXMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientMaxX")},"ROLANGULARVELOCITYGRADIENTYMAX",function(){return this.ROLANGULARVELOCITYGRADIENTYMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientMaxY")},"ROLANGULARVELOCITYGRADIENTZMAX",function(){return this.ROLANGULARVELOCITYGRADIENTZMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientMaxZ")},"ROLANGULARVELOCITYGRADIENTWMAX",function(){return this.ROLANGULARVELOCITYGRADIENTWMAX=Shader3D.propertyNameToID("u_ROLAngularVelocityGradientMaxW")},"TEXTURESHEETANIMATIONCYCLES",function(){return this.TEXTURESHEETANIMATIONCYCLES=Shader3D.propertyNameToID("u_TSACycles")},"TEXTURESHEETANIMATIONSUBUVLENGTH",function(){return this.TEXTURESHEETANIMATIONSUBUVLENGTH=Shader3D.propertyNameToID("u_TSASubUVLength")},"TEXTURESHEETANIMATIONGRADIENTUVS",function(){return this.TEXTURESHEETANIMATIONGRADIENTUVS=Shader3D.propertyNameToID("u_TSAGradientUVs")},"TEXTURESHEETANIMATIONGRADIENTMAXUVS",function(){return this.TEXTURESHEETANIMATIONGRADIENTMAXUVS=Shader3D.propertyNameToID("u_TSAMaxGradientUVs")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(RenderableSprite3D.shaderDefines)}]),ShuriKenParticle3D}(RenderableSprite3D),MeshSprite3D=function(_super){function MeshSprite3D(mesh,name){MeshSprite3D.__super.call(this,name),this._meshFilter=new MeshFilter(this),this._render=new MeshRenderer(this),mesh&&(this._meshFilter.sharedMesh=mesh)}__class(MeshSprite3D,"laya.d3.core.MeshSprite3D",_super);var __proto=MeshSprite3D.prototype;return __proto._parse=function(data){laya.d3.core.Sprite3D.prototype._parse.call(this,data);var render=this.meshRenderer,lightmapIndex=data.lightmapIndex;null!=lightmapIndex&&(render.lightmapIndex=lightmapIndex);var lightmapScaleOffsetArray=data.lightmapScaleOffset;lightmapScaleOffsetArray&&(render.lightmapScaleOffset=new Vector4(lightmapScaleOffsetArray[0],lightmapScaleOffsetArray[1],lightmapScaleOffsetArray[2],lightmapScaleOffsetArray[3])),null!=data.meshPath&&(this.meshFilter.sharedMesh=Loader.getRes(data.meshPath)),null!=data.enableRender&&(this.meshRenderer.enable=data.enableRender);var materials=data.materials;if(materials){var sharedMaterials=render.sharedMaterials,materialCount=materials.length;sharedMaterials.length=materialCount;for(var i=0;i<materialCount;i++)sharedMaterials[i]=Loader.getRes(materials[i].path);render.sharedMaterials=sharedMaterials}},__proto._addToInitStaticBatchManager=function(){MeshRenderStaticBatchManager.instance._addBatchSprite(this)},__proto.cloneTo=function(destObject){var meshSprite3D=destObject;meshSprite3D._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var meshRender=this._render,destMeshRender=meshSprite3D._render;destMeshRender.enable=meshRender.enable,destMeshRender.sharedMaterials=meshRender.sharedMaterials,destMeshRender.castShadow=meshRender.castShadow;var lightmapScaleOffset=meshRender.lightmapScaleOffset;lightmapScaleOffset&&(destMeshRender.lightmapScaleOffset=lightmapScaleOffset.clone()),destMeshRender.lightmapIndex=meshRender.lightmapIndex,destMeshRender.receiveShadow=meshRender.receiveShadow,destMeshRender.sortingFudge=meshRender.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,destObject)},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._meshFilter.destroy())},__getset(0,__proto,"meshFilter",function(){return this._meshFilter}),__getset(0,__proto,"meshRenderer",function(){return this._render}),MeshSprite3D.__init__=function(){MeshSprite3D.SHADERDEFINE_UV0=MeshSprite3D.shaderDefines.registerDefine("UV"),MeshSprite3D.SHADERDEFINE_COLOR=MeshSprite3D.shaderDefines.registerDefine("COLOR"),MeshSprite3D.SHADERDEFINE_UV1=MeshSprite3D.shaderDefines.registerDefine("UV1"),StaticBatchManager._registerManager(MeshRenderStaticBatchManager.instance),DynamicBatchManager._registerManager(MeshRenderDynamicBatchManager.instance)},MeshSprite3D.SHADERDEFINE_UV0=0,MeshSprite3D.SHADERDEFINE_COLOR=0,MeshSprite3D.SHADERDEFINE_UV1=0,__static(MeshSprite3D,["shaderDefines",function(){return this.shaderDefines=new ShaderDefines(RenderableSprite3D.shaderDefines)}]),MeshSprite3D}(RenderableSprite3D),DirectionLight=function(_super){function DirectionLight(){this._direction=null,DirectionLight.__super.call(this),this._direction=new Vector3}__class(DirectionLight,"laya.d3.core.light.DirectionLight",_super);var __proto=DirectionLight.prototype;return __proto._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new ParallelSplitShadowMap,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var defineDatas=this._scene._defineDatas,parallelSplitShadowMaps=this.scene.parallelSplitShadowMaps;parallelSplitShadowMaps.splice(parallelSplitShadowMaps.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,defineDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM1),defineDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM2),defineDatas.remove(Scene3D.SHADERDEFINE_SHADOW_PSSM3)}},__proto._onActive=function(){_super.prototype._onActive.call(this),this._shadow&&this._initShadow(),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.add(Scene3D.SHADERDEFINE_DIRECTIONLIGHT)},__proto._onInActive=function(){_super.prototype._onInActive.call(this),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.remove(Scene3D.SHADERDEFINE_DIRECTIONLIGHT)},__proto._prepareToScene=function(){var scene=this._scene;if(scene.enableLight&&this.activeInHierarchy){scene._defineDatas;var shaderValue=scene._shaderValues;return Vector3.scale(this.color,this._intensity,this._intensityColor),shaderValue.setVector(Scene3D.LIGHTDIRCOLOR,this._intensityColor),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),shaderValue.setVector(Scene3D.LIGHTDIRECTION,this._direction),!0}return!1},__getset(0,__proto,"shadow",_super.prototype._$get_shadow,function(value){this._shadow!==value&&(this._shadow=value,this.scene&&this._initShadow())}),DirectionLight}(LightSprite),SkinnedMeshSprite3D=function(_super){function SkinnedMeshSprite3D(mesh,name){SkinnedMeshSprite3D.__super.call(this,name),this._meshFilter=new MeshFilter(this),this._render=new SkinnedMeshRenderer(this),mesh&&(this._meshFilter.sharedMesh=mesh)}__class(SkinnedMeshSprite3D,"laya.d3.core.SkinnedMeshSprite3D",_super);var __proto=SkinnedMeshSprite3D.prototype;return __proto._parse=function(data){laya.d3.core.Sprite3D.prototype._parse.call(this,data);var render=this.skinnedMeshRenderer,lightmapIndex=data.lightmapIndex;null!=lightmapIndex&&(render.lightmapIndex=lightmapIndex);var meshPath,lightmapScaleOffsetArray=data.lightmapScaleOffset;if(lightmapScaleOffsetArray&&(render.lightmapScaleOffset=new Vector4(lightmapScaleOffsetArray[0],lightmapScaleOffsetArray[1],lightmapScaleOffsetArray[2],lightmapScaleOffsetArray[3])),meshPath=data.meshPath){var mesh=Loader.getRes(meshPath);mesh&&(this.meshFilter.sharedMesh=mesh)}var materials=data.materials;if(materials){var sharedMaterials=render.sharedMaterials,materialCount=materials.length;sharedMaterials.length=materialCount;for(var i=0;i<materialCount;i++)sharedMaterials[i]=Loader.getRes(materials[i].path);render.sharedMaterials=sharedMaterials}var rootBone=data.rootBone;rootBone&&render._setRootBone(rootBone);var boundBox=data.boundBox,min=boundBox.min,max=boundBox.max,localBoundBox=new BoundBox(new Vector3(min[0],min[1],min[2]),new Vector3(max[0],max[1],max[2]));render.localBoundBox=localBoundBox;var boundSphere=data.boundSphere;if(boundSphere){var center=boundSphere.center,localBoundSphere=new BoundSphere(new Vector3(center[0],center[1],center[2]),boundSphere.radius);render.localBoundSphere=localBoundSphere}},__proto._changeHierarchyAnimator=function(animator){var lastAnimator=this._hierarchyAnimator;lastAnimator&&lastAnimator.unLinkSprite3DToAvatarNode(this),_super.prototype._changeHierarchyAnimator.call(this,animator),animator&&this.skinnedMeshRenderer._rootBone&&animator.linkSprite3DToAvatarNode(this.skinnedMeshRenderer._rootBone,this),this.skinnedMeshRenderer._setCacheAnimator(animator)},__proto._changeAnimatorAvatar=function(avatar){this.skinnedMeshRenderer._setCacheAvatar(avatar)},__proto.cloneTo=function(destObject){var meshSprite3D=destObject;meshSprite3D.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var meshRender=this._render,destMeshRender=meshSprite3D._render;destMeshRender.enable=meshRender.enable,destMeshRender.sharedMaterials=meshRender.sharedMaterials,destMeshRender.castShadow=meshRender.castShadow;var lightmapScaleOffset=meshRender.lightmapScaleOffset;lightmapScaleOffset&&(destMeshRender.lightmapScaleOffset=lightmapScaleOffset.clone()),destMeshRender.receiveShadow=meshRender.receiveShadow,destMeshRender.sortingFudge=meshRender.sortingFudge,destMeshRender._rootBone=meshRender._rootBone;var lbp=meshRender.localBoundSphere;lbp&&(destMeshRender.localBoundSphere=lbp.clone());var lbb=meshRender.localBoundBox;lbb&&(destMeshRender.localBoundBox=lbb.clone()),laya.d3.core.Sprite3D.prototype.cloneTo.call(this,destObject)},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._meshFilter.destroy())},__getset(0,__proto,"meshFilter",function(){return this._meshFilter}),__getset(0,__proto,"skinnedMeshRenderer",function(){return this._render}),SkinnedMeshSprite3D.__init__=function(){SkinnedMeshSprite3D.SHADERDEFINE_BONE=SkinnedMeshSprite3D.shaderDefines.registerDefine("BONE")},SkinnedMeshSprite3D.SHADERDEFINE_BONE=0,__static(SkinnedMeshSprite3D,["BONES",function(){return this.BONES=Shader3D.propertyNameToID("u_Bones")},"shaderDefines",function(){return this.shaderDefines=new ShaderDefines(MeshSprite3D.shaderDefines)}]),SkinnedMeshSprite3D}(RenderableSprite3D),TerrainChunk=function(_super){function TerrainChunk(chunkOffsetX,chunkOffsetZ,girdSize,terrainHeightData,heightDataWidth,heightDataHeight,cameraCoordinateInverse,name){this._terrainFilter=null,TerrainChunk.__super.call(this,name),this._terrainFilter=new TerrainFilter(this,chunkOffsetX,chunkOffsetZ,girdSize,terrainHeightData,heightDataWidth,heightDataHeight,cameraCoordinateInverse),this._render=new TerrainRender(this)}__class(TerrainChunk,"laya.d3.terrain.TerrainChunk",_super);var __proto=TerrainChunk.prototype;return __proto.buildRenderElementAndMaterial=function(detailNum,normalMap,alphaMapUrl,detailUrl1,detailUrl2,detailUrl3,detailUrl4,ambientColor,diffuseColor,specularColor,sx1,sy1,sx2,sy2,sx3,sy3,sx4,sy4){void 0===sx1&&(sx1=1),void 0===sy1&&(sy1=1),void 0===sx2&&(sx2=1),void 0===sy2&&(sy2=1),void 0===sx3&&(sx3=1),void 0===sy3&&(sy3=1),void 0===sx4&&(sx4=1),void 0===sy4&&(sy4=1);var terrainMaterial=new TerrainMaterial;diffuseColor&&(terrainMaterial.diffuseColor=diffuseColor),ambientColor&&(terrainMaterial.ambientColor=ambientColor),specularColor&&(terrainMaterial.specularColor=specularColor),terrainMaterial.splatAlphaTexture=Loader.getRes(alphaMapUrl),terrainMaterial.normalTexture=normalMap?Loader.getRes(normalMap):null,terrainMaterial.diffuseTexture1=detailUrl1?Loader.getRes(detailUrl1):null,terrainMaterial.diffuseTexture2=detailUrl2?Loader.getRes(detailUrl2):null,terrainMaterial.diffuseTexture3=detailUrl3?Loader.getRes(detailUrl3):null,terrainMaterial.diffuseTexture4=detailUrl4?Loader.getRes(detailUrl4):null,terrainMaterial.setDiffuseScale1(sx1,sy1),terrainMaterial.setDiffuseScale2(sx2,sy2),terrainMaterial.setDiffuseScale3(sx3,sy3),terrainMaterial.setDiffuseScale4(sx4,sy4),terrainMaterial.setDetailNum(detailNum),0!=this._render._renderElements.length&&(terrainMaterial.renderMode=2);var renderElement=new RenderElement;renderElement.setTransform(this._transform),renderElement.render=this._render,renderElement.setGeometry(this._terrainFilter),this._render._renderElements.push(renderElement),this._render.sharedMaterial=terrainMaterial},__proto.cloneTo=function(destObject){console.log("Terrain Chunk can't clone")},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.destroyed||(_super.prototype.destroy.call(this,destroyChild),this._terrainFilter.destroy(),this._terrainFilter=null)},__getset(0,__proto,"terrainFilter",function(){return this._terrainFilter}),__getset(0,__proto,"terrainRender",function(){return this._render}),TerrainChunk}(RenderableSprite3D),SpotLight=function(_super){function SpotLight(){this._direction=null,this._spotAngle=NaN,this._range=NaN,SpotLight.__super.call(this),this._spotAngle=30,this._range=10,this._direction=new Vector3}__class(SpotLight,"laya.d3.core.light.SpotLight",_super);var __proto=SpotLight.prototype;return __proto._onActive=function(){_super.prototype._onActive.call(this),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this.scene._defineDatas.add(Scene3D.SHADERDEFINE_SPOTLIGHT)},__proto._onInActive=function(){_super.prototype._onInActive.call(this),this._lightmapBakedType!==LightSprite.LIGHTMAPBAKEDTYPE_BAKED&&this.scene._defineDatas.remove(Scene3D.SHADERDEFINE_SPOTLIGHT)},__proto._prepareToScene=function(){var scene=this._scene;if(scene.enableLight&&this.activeInHierarchy){scene._defineDatas;var shaderValue=scene._shaderValues;return Vector3.scale(this.color,this._intensity,this._intensityColor),shaderValue.setVector(Scene3D.SPOTLIGHTCOLOR,this._intensityColor),shaderValue.setVector(Scene3D.SPOTLIGHTPOS,this.transform.position),this.transform.worldMatrix.getForward(this._direction),Vector3.normalize(this._direction,this._direction),shaderValue.setVector(Scene3D.SPOTLIGHTDIRECTION,this._direction),shaderValue.setNumber(Scene3D.SPOTLIGHTRANGE,this.range),shaderValue.setNumber(Scene3D.SPOTLIGHTSPOTANGLE,this.spotAngle*Math.PI/180),!0}return!1},__proto._parse=function(data){_super.prototype._parse.call(this,data),this.range=data.range,this.spotAngle=data.spotAngle},__getset(0,__proto,"spotAngle",function(){return this._spotAngle},function(value){this._spotAngle=Math.max(Math.min(value,180),0)}),__getset(0,__proto,"range",function(){return this._range},function(value){this._range=value}),__static(SpotLight,["_tempMatrix0",function(){return this._tempMatrix0=new Matrix4x4},"_tempMatrix1",function(){return this._tempMatrix1=new Matrix4x4}]),SpotLight}(LightSprite),Camera=(function(_super){function PixelLineSprite3D(maxCount,name){this._geometryFilter=null,void 0===maxCount&&(maxCount=2),PixelLineSprite3D.__super.call(this,name),this._geometryFilter=new PixelLineFilter(this,maxCount),this._render=new PixelLineRenderer(this),this._changeRenderObjects(this._render,0,PixelLineMaterial.defaultMaterial)}__class(PixelLineSprite3D,"laya.d3.core.pixelLine.PixelLineSprite3D",RenderableSprite3D);var __proto=PixelLineSprite3D.prototype;__proto._changeRenderObjects=function(sender,index,material){var renderObjects=this._render._renderElements;material||(material=PixelLineMaterial.defaultMaterial);var renderElement=renderObjects[index];renderElement||(renderElement=renderObjects[index]=new RenderElement),renderElement.setTransform(this._transform),renderElement.setGeometry(this._geometryFilter),renderElement.render=this._render,renderElement.material=material},__proto.addLine=function(startPosition,endPosition,startColor,endColor){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,startPosition,endPosition,startColor,endColor)},__proto.addLines=function(lines){var lineCount=this._geometryFilter._lineCount,addCount=lines.length;if(lineCount+addCount>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(lineCount,lines),this._geometryFilter._lineCount+=addCount},__proto.removeLine=function(index){if(!(index<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(index)},__proto.setLine=function(index,startPosition,endPosition,startColor,endColor){if(!(index<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(index,startPosition,endPosition,startColor,endColor)},__proto.getLine=function(index,out){if(!(index<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(index,out)},__proto.clear=function(){this._geometryFilter._lineCount=0},__getset(0,__proto,"maxLineCount",function(){return this._geometryFilter._maxLineCount},function(value){this._geometryFilter._resizeLineData(value),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,value)}),__getset(0,__proto,"pixelLineRenderer",function(){return this._render}),__getset(0,__proto,"lineCount",function(){return this._geometryFilter._lineCount},function(value){if(value>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=value})}(),function(_super){function Camera(aspectRatio,nearPlane,farPlane){this._updateViewMatrix=!0,this.enableRender=!0,void 0===aspectRatio&&(aspectRatio=0),void 0===nearPlane&&(nearPlane=.3),void 0===farPlane&&(farPlane=1e3),this._viewMatrix=new Matrix4x4,this._projectionMatrix=new Matrix4x4,this._projectionViewMatrix=new Matrix4x4,this._projectionViewMatrixNoTranslateScale=new Matrix4x4,this._viewport=new Viewport(0,0,0,0),this._normalizedViewport=new Viewport(0,0,1,1),this._aspectRatio=aspectRatio,this._boundFrustum=new BoundFrustum(Matrix4x4.DEFAULT),Render.isConchApp&&(this._boundFrustumBuffer=new Float32Array(24)),Camera.__super.call(this,nearPlane,farPlane),this.transform.on("transformchanged",this,this._onTransformChanged)}__class(Camera,"laya.d3.core.Camera",_super);var __proto=Camera.prototype;return __proto._onTransformChanged=function(flag){(flag&=64)&&(this._updateViewMatrix=!0)},__proto._calculationViewport=function(normalizedViewport,width,height){this._viewport.x=normalizedViewport.x*width,this._viewport.y=normalizedViewport.y*height,this._viewport.width=Math.min(Math.max(normalizedViewport.width*width,0),width),this._viewport.height=Math.min(Math.max(normalizedViewport.height*height,0),height)},__proto._parse=function(data){_super.prototype._parse.call(this,data);var viewport=data.viewport;this.normalizedViewport=new Viewport(viewport[0],viewport[1],viewport[2],viewport[3])},__proto._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var halfWidth=this.orthographicVerticalSize*this.aspectRatio*.5,halfHeight=.5*this.orthographicVerticalSize;Matrix4x4.createOrthoOffCenterRH(-halfWidth,halfWidth,-halfHeight,halfHeight,this.nearPlane,this.farPlane,this._projectionMatrix)}else Matrix4x4.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix)},__proto.render=function(shader,replacementTag){var gl=LayaGL.instance,context=RenderContext3D._instance,scene=context.scene=this._scene;if(scene){if(scene.parallelSplitShadowMaps[0]){ShaderData.setRuntimeValueMode(!1);var parallelSplitShadowMap=scene.parallelSplitShadowMaps[0];parallelSplitShadowMap._calcAllLightCameraInfo(this),scene._defineDatas.add(Scene3D.SHADERDEFINE_CAST_SHADOW);for(var i=0,n=parallelSplitShadowMap.shadowMapCount;i<n;i++){var smCamera=parallelSplitShadowMap.cameras[i];context.camera=smCamera,context.projectionViewMatrix=smCamera.projectionViewMatrix,FrustumCulling.renderObjectCulling(smCamera,scene,context,scene._castShadowRenders);var shadowMap=parallelSplitShadowMap.cameras[i+1].renderTarget;shadowMap.start(),context.camera=smCamera,context.viewport=smCamera.viewport,smCamera._prepareCameraToRender(),smCamera._prepareCameraViewProject(smCamera.viewMatrix,smCamera.projectionMatrix,smCamera._projectionViewMatrixNoTranslateScale),scene._clear(gl,context),scene._opaqueQueue._render(context,!1),shadowMap.end()}scene._defineDatas.remove(Scene3D.SHADERDEFINE_CAST_SHADOW),ShaderData.setRuntimeValueMode(!0)}var viewMat,projectMat;context.camera=this,scene._preRenderScript(),viewMat=context.viewMatrix=this.viewMatrix;var renderTar=this._renderTarget;renderTar?(renderTar.start(),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this._projectionMatrix,BaseCamera._invertYProjectionMatrix),Matrix4x4.multiply(BaseCamera._invertYScaleMatrix,this.projectionViewMatrix,BaseCamera._invertYProjectionViewMatrix),projectMat=context.projectionMatrix=BaseCamera._invertYProjectionMatrix,context.projectionViewMatrix=BaseCamera._invertYProjectionViewMatrix):(projectMat=context.projectionMatrix=this._projectionMatrix,context.projectionViewMatrix=this.projectionViewMatrix),context.viewport=this.viewport,this._prepareCameraToRender(),this._prepareCameraViewProject(viewMat,projectMat,this._projectionViewMatrixNoTranslateScale),scene._preCulling(context,this),scene._clear(gl,context),scene._renderScene(gl,context,shader,replacementTag),scene._postRenderScript(),renderTar&&renderTar.end()}},__proto.viewportPointToRay=function(point,out){Picker.calculateCursorRay(point,this.viewport,this._projectionMatrix,this.viewMatrix,null,out)},__proto.normalizedViewportPointToRay=function(point,out){var finalPoint=Camera._tempVector20,vp=this.viewport,nVpPosE=point.elements,vpPosE=finalPoint.elements;vpPosE[0]=nVpPosE[0]*vp.width,vpPosE[1]=nVpPosE[1]*vp.height,Picker.calculateCursorRay(finalPoint,this.viewport,this._projectionMatrix,this.viewMatrix,null,out)},__proto.worldToViewportPoint=function(position,out){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(position,this._projectionViewMatrix,out);var outE=out.elements;outE[0]=outE[0]/Laya.stage.clientScaleX,outE[1]=outE[1]/Laya.stage.clientScaleY},__proto.worldToNormalizedViewportPoint=function(position,out){Matrix4x4.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(position,this._projectionViewMatrix,out);var outE=out.elements;outE[0]=outE[0]/Laya.stage.clientScaleX,outE[1]=outE[1]/Laya.stage.clientScaleY},__proto.convertScreenCoordToOrthographicCoord=function(source,out){if(this._orthographic){var clientWidth=RenderContext3D.clientWidth,clientHeight=RenderContext3D.clientHeight,ratioX=this.orthographicVerticalSize*this.aspectRatio/clientWidth,ratioY=this.orthographicVerticalSize/clientHeight,sE=source.elements,oE=out.elements;return oE[0]=(-clientWidth/2+sE[0])*ratioX,oE[1]=(clientHeight/2-sE[1])*ratioY,oE[2]=(this.nearPlane-this.farPlane)*(sE[2]+1)/2-this.nearPlane,Vector3.transformCoordinate(out,this.transform.worldMatrix,out),!0}return!1},__proto.destroy=function(destroyChild){void 0===destroyChild&&(destroyChild=!0),this.transform.off("transformchanged",this,this._onTransformChanged),_super.prototype.destroy.call(this,destroyChild)},__getset(0,__proto,"projectionViewMatrix",function(){return Matrix4x4.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),__getset(0,__proto,"aspectRatio",function(){if(0===this._aspectRatio){var vp=this.viewport;return vp.width/vp.height}return this._aspectRatio},function(value){if(value<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=value,this._calculateProjectionMatrix()}),__getset(0,__proto,"boundFrustum",function(){if(this._boundFrustum.matrix=this.projectionViewMatrix,Render.isConchApp){var near=this._boundFrustum.near,far=this._boundFrustum.far,left=this._boundFrustum.left,right=this._boundFrustum.right,top=this._boundFrustum.top,bottom=this._boundFrustum.bottom,nearNE=near.normal.elements,farNE=far.normal.elements,leftNE=left.normal.elements,rightNE=right.normal.elements,topNE=top.normal.elements,bottomNE=bottom.normal.elements,buffer=this._boundFrustumBuffer;buffer[0]=nearNE[0],buffer[1]=nearNE[1],buffer[2]=nearNE[2],buffer[3]=near.distance,buffer[4]=farNE[0],buffer[5]=farNE[1],buffer[6]=farNE[2],buffer[7]=far.distance,buffer[8]=leftNE[0],buffer[9]=leftNE[1],buffer[10]=leftNE[2],buffer[11]=left.distance,buffer[12]=rightNE[0],buffer[13]=rightNE[1],buffer[14]=rightNE[2],buffer[15]=right.distance,buffer[16]=topNE[0],buffer[17]=topNE[1],buffer[18]=topNE[2],buffer[19]=top.distance,buffer[20]=bottomNE[0],buffer[21]=bottomNE[1],buffer[22]=bottomNE[2],buffer[23]=bottom.distance}return this._boundFrustum}),__getset(0,__proto,"viewport",function(){var width=0,height=0;return this._renderTarget?(width=this._renderTarget.width,height=this._renderTarget.height):(width=RenderContext3D.clientWidth,height=RenderContext3D.clientHeight),width===this._canvasWidth&&height===this._canvasHeight||(this._calculationViewport(this._normalizedViewport,width,height),this._canvasWidth=width,this._canvasHeight=height),this._viewport},function(value){var width=0,height=0;this._renderTarget?(width=this._canvasWidth=this._renderTarget.width,height=this._canvasHeight=this._renderTarget.height):(width=this._canvasWidth=RenderContext3D.clientWidth,height=this._canvasHeight=RenderContext3D.clientHeight),this._normalizedViewport.x=value.x/width,this._normalizedViewport.y=value.y/height,this._normalizedViewport.width=value.width/width,this._normalizedViewport.height=value.height/height,this._calculationViewport(this._normalizedViewport,width,height),this._calculateProjectionMatrix()}),__getset(0,__proto,"normalizedViewport",function(){return this._normalizedViewport},function(value){var width=0,height=0;this._renderTarget?(width=this._canvasWidth=this._renderTarget.width,height=this._canvasHeight=this._renderTarget.height):(width=this._canvasWidth=RenderContext3D.clientWidth,height=this._canvasHeight=RenderContext3D.clientHeight),this._normalizedViewport=value,this._calculationViewport(value,width,height),this._calculateProjectionMatrix()}),__getset(0,__proto,"projectionMatrix",function(){return this._projectionMatrix},function(value){this._projectionMatrix=value,this._useUserProjectionMatrix=!0}),__getset(0,__proto,"viewMatrix",function(){if(this._updateViewMatrix){var scale=this.transform.scale,scaleX=scale.x,scaleY=scale.y,scaleZ=scale.z,viewMatE=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),viewMatE[0]/=scaleX,viewMatE[1]/=scaleX,viewMatE[2]/=scaleX,viewMatE[4]/=scaleY,viewMatE[5]/=scaleY,viewMatE[6]/=scaleY,viewMatE[8]/=scaleZ,viewMatE[9]/=scaleZ,viewMatE[10]/=scaleZ,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1}return this._viewMatrix}),__static(Camera,["_tempVector20",function(){return this._tempVector20=new Vector2}]),Camera}(BaseCamera));!function(_super){function MeshTerrainSprite3D(mesh,heightMap,name){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,MeshTerrainSprite3D.__super.call(this,mesh,name),this._heightMap=heightMap,this._cellSize=new Vector2}__class(MeshTerrainSprite3D,"laya.d3.core.MeshTerrainSprite3D",MeshSprite3D);var __proto=MeshTerrainSprite3D.prototype;__proto._disableRotation=function(){var rotation=this.transform.rotation;rotation.elements[0]=0,rotation.elements[1]=0,rotation.elements[2]=0,rotation.elements[3]=1,this.transform.rotation=rotation},__proto._getScaleX=function(){var worldMatE=this.transform.worldMatrix.elements,m11=worldMatE[0],m12=worldMatE[1],m13=worldMatE[2];return Math.sqrt(m11*m11+m12*m12+m13*m13)},__proto._getScaleZ=function(){var worldMatE=this.transform.worldMatrix.elements,m31=worldMatE[8],m32=worldMatE[9],m33=worldMatE[10];return Math.sqrt(m31*m31+m32*m32+m33*m33)},__proto._initCreateFromMesh=function(heightMapWidth,heightMapHeight){this._heightMap=HeightMap.creatFromMesh(this.meshFilter.sharedMesh,heightMapWidth,heightMapHeight,this._cellSize);var boundingBox=this.meshFilter.sharedMesh.boundingBox,min=boundingBox.min;boundingBox.max;this._minX=min.x,this._minZ=min.z},__proto._initCreateFromMeshHeightMap=function(texture,minHeight,maxHeight){var boundingBox=this.meshFilter.sharedMesh.boundingBox;this._heightMap=HeightMap.createFromImage(texture,minHeight,maxHeight),this._computeCellSize(boundingBox);var min=boundingBox.min;boundingBox.max;this._minX=min.x,this._minZ=min.z},__proto._computeCellSize=function(boundingBox){var min=boundingBox.min,max=boundingBox.max,minX=min.x,minZ=min.z,widthSize=max.x-minX,heightSize=max.z-minZ;this._cellSize.elements[0]=widthSize/(this._heightMap.width-1),this._cellSize.elements[1]=heightSize/(this._heightMap.height-1)},__proto._update=function(state){this._disableRotation()},__proto.getHeight=function(x,z){MeshTerrainSprite3D._tempVector3.elements[0]=x,MeshTerrainSprite3D._tempVector3.elements[1]=0,MeshTerrainSprite3D._tempVector3.elements[2]=z,this._disableRotation();var worldMat=this.transform.worldMatrix;worldMat.invert(MeshTerrainSprite3D._tempMatrix4x4),Vector3.transformCoordinate(MeshTerrainSprite3D._tempVector3,MeshTerrainSprite3D._tempMatrix4x4,MeshTerrainSprite3D._tempVector3),x=MeshTerrainSprite3D._tempVector3.elements[0],z=MeshTerrainSprite3D._tempVector3.elements[2];var c=(x-this._minX)/this._cellSize.x,d=(z-this._minZ)/this._cellSize.y,row=Math.floor(d),col=Math.floor(c),s=c-col,t=d-row,worldMatE=worldMat.elements,m21=worldMatE[4],m22=worldMatE[5],m23=worldMatE[6],scaleY=Math.sqrt(m21*m21+m22*m22+m23*m23),translateY=worldMatE[13],h01=this._heightMap.getHeight(row,col+1),h10=this._heightMap.getHeight(row+1,col);if(isNaN(h01)||isNaN(h10))return NaN;if(s+t<=1){var h00=this._heightMap.getHeight(row,col);return isNaN(h00)?NaN:(h00+s*(h01-h00)+t*(h10-h00))*scaleY+translateY}var h11=this._heightMap.getHeight(row+1,col+1);return isNaN(h11)?NaN:(h11+(1-s)*(h10-h11)+(1-t)*(h01-h11))*scaleY+translateY},__getset(0,__proto,"minX",function(){var worldMatE=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+worldMatE[12]}),__getset(0,__proto,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),__getset(0,__proto,"minZ",function(){var worldMatE=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+worldMatE[14]}),__getset(0,__proto,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),MeshTerrainSprite3D.createFromMesh=function(mesh,heightMapWidth,heightMapHeight,name){var meshTerrainSprite3D=new MeshTerrainSprite3D(mesh,null,name);return meshTerrainSprite3D._initCreateFromMesh(heightMapWidth,heightMapHeight),meshTerrainSprite3D},MeshTerrainSprite3D.createFromMeshAndHeightMap=function(mesh,texture,minHeight,maxHeight,name){var meshTerrainSprite3D=new MeshTerrainSprite3D(mesh,null,name);return meshTerrainSprite3D._initCreateFromMeshHeightMap(texture,minHeight,maxHeight),meshTerrainSprite3D},__static(MeshTerrainSprite3D,["_tempVector3",function(){return this._tempVector3=new Vector3},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Matrix4x4}])}()}(window,document,Laya);